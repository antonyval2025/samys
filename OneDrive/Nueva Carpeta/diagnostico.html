<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>DiagnÃ³stico - Debug Completo</title>
    <link rel="stylesheet" href="css/estilos.css">
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4;
        }
        .console {
            background: #2d2d2d;
            border: 2px solid #007acc;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            max-height: 600px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.6;
        }
        .log { color: #d4d4d4; }
        .error { color: #f48771; font-weight: bold; }
        .success { color: #6a9955; font-weight: bold; }
        .warning { color: #dcdcaa; font-weight: bold; }
        .info { color: #569cd6; }
        .title { color: #4ec9b0; font-weight: bold; font-size: 14px; }
        button { 
            padding: 10px 15px; 
            margin: 5px; 
            background: #007acc; 
            color: white; 
            border: none; 
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover { background: #005a9c; }
        .section { margin: 20px 0; }
    </style>
</head>
<body>
    <h1>ğŸ”§ DiagnÃ³stico Completo - Debug de Botones</h1>
    
    <div class="section">
        <button onclick="testAllDependencies()">Test 1: Verificar Dependencias</button>
        <button onclick="testGestorLocalesCall()">Test 2: Llamar GestorLocales.mostrarModalGestiÃ³n()</button>
        <button onclick="testGestorDeptoCall()">Test 3: Llamar GestorDepartamentos.mostrarModalGestiÃ³n()</button>
        <button onclick="inspectDOM()">Test 4: Inspeccionar DOM</button>
        <button onclick="clearConsole()">Limpiar Consola</button>
    </div>

    <div class="console" id="console"></div>

    <!-- Cargar mÃ³dulos -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/modules.js"></script>
    <script src="js/balanceo-y-restricciones.js"></script>
    <script src="js/reportes-y-prediccion.js"></script>
    <script src="js/soporte-multilocal.js"></script>

    <script>
        const consoleDiv = document.getElementById('console');

        function log(text, type = 'log') {
            const time = new Date().toLocaleTimeString();
            const className = type;
            const html = `<div class="${className}">[${time}] ${text}</div>`;
            consoleDiv.innerHTML += html;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function clearConsole() {
            consoleDiv.innerHTML = '';
        }

        // Override console methods
        window.console = {
            log: (...args) => log(args.join(' '), 'log'),
            error: (...args) => log('ERROR: ' + args.join(' '), 'error'),
            warn: (...args) => log('WARN: ' + args.join(' '), 'warning'),
            info: (...args) => log('INFO: ' + args.join(' '), 'info')
        };

        function testAllDependencies() {
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'title');
            log('TEST 1: Verificar Dependencias', 'title');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'title');

            const checks = [
                { name: 'GestorLocales', obj: typeof GestorLocales },
                { name: 'GestorDepartamentos', obj: typeof GestorDepartamentos },
                { name: 'ConsolidadorReportes', obj: typeof ConsolidadorReportes },
                { name: 'AppState', obj: typeof AppState },
                { name: 'NotificationSystem', obj: typeof NotificationSystem },
                { name: 'document.body', obj: document.body ? 'EXISTS' : 'MISSING' }
            ];

            checks.forEach(check => {
                const status = check.obj === 'undefined' ? 'error' : 'success';
                log(`${check.name}: ${check.obj}`, status);
            });

            // MÃ©todo especÃ­ficos
            log('', 'log');
            log('MÃ‰TODOS:', 'title');

            if (typeof GestorLocales !== 'undefined') {
                log(`GestorLocales.mostrarModalGestiÃ³n: ${typeof GestorLocales.mostrarModalGestiÃ³n}`, 
                    typeof GestorLocales.mostrarModalGestiÃ³n === 'function' ? 'success' : 'error');
                log(`GestorLocales.inicializarLocales: ${typeof GestorLocales.inicializarLocales}`,
                    typeof GestorLocales.inicializarLocales === 'function' ? 'success' : 'error');
                log(`GestorLocales.locales: ${Array.isArray(GestorLocales.locales) ? 'Array' : typeof GestorLocales.locales}`,
                    Array.isArray(GestorLocales.locales) ? 'success' : 'error');
                log(`GestorLocales.localActualId: ${GestorLocales.localActualId}`, 
                    GestorLocales.localActualId ? 'success' : 'warning');
            }

            if (typeof GestorDepartamentos !== 'undefined') {
                log(`GestorDepartamentos.mostrarModalGestiÃ³n: ${typeof GestorDepartamentos.mostrarModalGestiÃ³n}`,
                    typeof GestorDepartamentos.mostrarModalGestiÃ³n === 'function' ? 'success' : 'error');
            }

            if (typeof AppState !== 'undefined') {
                log(`AppState.userRole: '${AppState.userRole}'`, 'info');
                log(`AppState.canEditShifts(): ${AppState.canEditShifts()}`,
                    AppState.canEditShifts() ? 'success' : 'error');
            }

            log('', 'log');
            log('TEST 1 COMPLETADO âœ“', 'success');
        }

        function testGestorLocalesCall() {
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'title');
            log('TEST 2: Llamar GestorLocales.mostrarModalGestiÃ³n()', 'title');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'title');

            try {
                log('Verificando prerequisites...', 'info');
                
                if (typeof GestorLocales === 'undefined') {
                    throw new Error('GestorLocales no estÃ¡ definido');
                }

                if (typeof GestorLocales.mostrarModalGestiÃ³n !== 'function') {
                    throw new Error(`mostrarModalGestiÃ³n no es una funciÃ³n: ${typeof GestorLocales.mostrarModalGestiÃ³n}`);
                }

                if (!AppState.canEditShifts()) {
                    throw new Error(`No tienes permisos. userRole='${AppState.userRole}', se requiere 'admin' o 'supervisor'`);
                }

                log('âœ“ Prerequisites OK', 'success');
                log('Llamando GestorLocales.mostrarModalGestiÃ³n()...', 'info');

                GestorLocales.mostrarModalGestiÃ³n();

                log('âœ“ FunciÃ³n ejecutada sin errores', 'success');

                // Verificar si se creÃ³ el modal
                setTimeout(() => {
                    const modal = document.getElementById('modalGestionLocales');
                    if (modal) {
                        log(`âœ“ Modal creado en el DOM (element: ${modal.tagName})`, 'success');
                        log(`  - ID: ${modal.id}`, 'log');
                        log(`  - Classes: ${modal.className}`, 'log');
                        log(`  - Display: ${window.getComputedStyle(modal).display}`, 'log');
                        log(`  - Z-index: ${window.getComputedStyle(modal).zIndex}`, 'log');
                    } else {
                        log('âœ— Modal NO se encuentra en el DOM', 'error');
                    }
                    log('TEST 2 COMPLETADO', 'success');
                }, 500);

            } catch (e) {
                log(`âœ— ERROR: ${e.message}`, 'error');
                log(`Stack: ${e.stack}`, 'error');
                log('TEST 2 FALLÃ“', 'error');
            }
        }

        function testGestorDeptoCall() {
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'title');
            log('TEST 3: Llamar GestorDepartamentos.mostrarModalGestiÃ³n()', 'title');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'title');

            try {
                log('Verificando prerequisites...', 'info');

                if (typeof GestorDepartamentos === 'undefined') {
                    throw new Error('GestorDepartamentos no estÃ¡ definido');
                }

                if (typeof GestorDepartamentos.mostrarModalGestiÃ³n !== 'function') {
                    throw new Error(`mostrarModalGestiÃ³n no es una funciÃ³n: ${typeof GestorDepartamentos.mostrarModalGestiÃ³n}`);
                }

                if (!AppState.canEditShifts()) {
                    throw new Error(`No tienes permisos. userRole='${AppState.userRole}'`);
                }

                log('âœ“ Prerequisites OK', 'success');
                log('Llamando GestorDepartamentos.mostrarModalGestiÃ³n()...', 'info');

                GestorDepartamentos.mostrarModalGestiÃ³n();

                log('âœ“ FunciÃ³n ejecutada sin errores', 'success');

                // Verificar si se creÃ³ el modal
                setTimeout(() => {
                    const modal = document.getElementById('modalGestionDeptos');
                    if (modal) {
                        log(`âœ“ Modal creado en el DOM (element: ${modal.tagName})`, 'success');
                        log(`  - ID: ${modal.id}`, 'log');
                        log(`  - Classes: ${modal.className}`, 'log');
                        log(`  - Display: ${window.getComputedStyle(modal).display}`, 'log');
                    } else {
                        log('âœ— Modal NO se encuentra en el DOM', 'error');
                    }
                    log('TEST 3 COMPLETADO', 'success');
                }, 500);

            } catch (e) {
                log(`âœ— ERROR: ${e.message}`, 'error');
                log(`Stack: ${e.stack}`, 'error');
                log('TEST 3 FALLÃ“', 'error');
            }
        }

        function inspectDOM() {
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'title');
            log('TEST 4: Inspeccionar DOM', 'title');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'title');

            log('Buscando modales en el DOM...', 'info');

            const allModals = document.querySelectorAll('.modal');
            log(`Total de elementos .modal: ${allModals.length}`, allModals.length > 0 ? 'success' : 'warning');

            allModals.forEach((modal, idx) => {
                log(`Modal ${idx + 1}:`, 'info');
                log(`  - ID: ${modal.id || '(sin ID)'}`, 'log');
                log(`  - Classes: ${modal.className}`, 'log');
                log(`  - Display: ${window.getComputedStyle(modal).display}`, 'log');
                log(`  - Visible: ${modal.offsetParent !== null ? 'SÃ­' : 'No'}`, 'log');
            });

            // Buscar elementos especÃ­ficos
            const modalLocales = document.getElementById('modalGestionLocales');
            const modalDeptos = document.getElementById('modalGestionDeptos');

            log('', 'log');
            log('BÃºsqueda especÃ­fica:', 'info');
            log(`#modalGestionLocales: ${modalLocales ? 'ENCONTRADO' : 'NO ENCONTRADO'}`, 
                modalLocales ? 'success' : 'warning');
            log(`#modalGestionDeptos: ${modalDeptos ? 'ENCONTRADO' : 'NO ENCONTRADO'}`,
                modalDeptos ? 'success' : 'warning');

            log('', 'log');
            log('InformaciÃ³n del documento:', 'info');
            log(`document.readyState: ${document.readyState}`, 'log');
            log(`document.body: ${document.body ? 'EXISTE' : 'NO EXISTE'}`, 'log');
            log(`window.innerHeight: ${window.innerHeight}`, 'log');
            log(`window.innerWidth: ${window.innerWidth}`, 'log');

            log('TEST 4 COMPLETADO', 'success');
        }

        // Auto-test al cargar
        window.addEventListener('load', () => {
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
            log('PÃGINA LISTA - Presiona los botones de arriba', 'success');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
        });
    </script>
</body>
</html>
