<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light">
    <meta name="supported-color-schemes" content="light">
    <title>Sistema de Gesti√≥n de Turnos - Cuadrantes Mensuales</title>
    <script>
        // Capturar errores antes que nada
        window.addEventListener('error', function(e) {
            console.error('ERROR UNCAUGHT:', e.message, 'en', e.filename, ':', e.lineno);
            document.body.innerHTML = `
                <div style="padding: 20px; background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; border-radius: 5px;">
                    <h2>‚ùå ERROR CR√çTICO EN JAVASCRIPT</h2>
                    <p><strong>Mensaje:</strong> ${e.message}</p>
                    <p><strong>Archivo:</strong> ${e.filename}</p>
                    <p><strong>L√≠nea:</strong> ${e.lineno}</p>
                    <p><strong>Stack:</strong> <pre>${e.error?.stack || 'No disponible'}</pre></p>
                </div>
            `;
        });
        
        // ‚≠ê CONFIGURAR MES/A√ëO ACTUAL INMEDIATAMENTE (sin parpadeos)
        window.__initialMonth = new Date().getMonth();
        window.__initialYear = new Date().getFullYear();
    </script>
    <!-- Librer√≠as Externas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Estilos -->
    <link rel="stylesheet" href="css/estilos_pastel4.css?v=20251214_corp1">
        <style>
            /* Overrides pastel for cache-safe load y evitar temas oscuros cacheados */
            :root { color-scheme: light; }
            body { background: radial-gradient(circle at 15% 20%, #0f172a 0%, #0b1220 40%, #0a0f1c 80%) !important; color: #e5e7eb !important; }
            .container { background: transparent !important; }
            .monthly-schedule-container { background: linear-gradient(180deg, rgba(18,27,45,0.96) 0%, rgba(12,19,33,0.96) 100%) !important; }
            .main-content { background: linear-gradient(160deg, rgba(15,23,42,0.96), rgba(11,18,32,0.96)) !important; }
            header { background: linear-gradient(135deg, #111827 0%, #0b1220 100%) !important; color: #e5e7eb !important; }
            .monthly-header, .calendario-header { background: linear-gradient(135deg, #111827 0%, #0b1220 100%) !important; color: #e2e8f0 !important; }
            .tabs, .legend, .stat-card { background: #0b1220 !important; }
            .monthly-table { border-collapse: separate !important; border-spacing: 8px !important; background: transparent !important; }
            .monthly-table th, .monthly-table th:first-child { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%) !important; color: white !important; padding: 14px 12px !important; font-weight: 700 !important; text-align: center !important; border-radius: 8px !important; box-shadow: 0 0 20px rgba(249, 115, 22, 0.4) !important; }
            .monthly-table td { background: linear-gradient(135deg, rgba(14, 165, 233, 0.08) 0%, rgba(6, 182, 212, 0.06) 100%) !important; color: #0f172a !important; border: 2px solid rgba(14, 165, 233, 0.2) !important; border-radius: 10px !important; padding: 12px 10px !important; text-align: center !important; font-weight: 500 !important; transition: all 0.3s ease !important; }
            .monthly-table td:hover { background: linear-gradient(135deg, rgba(14, 165, 233, 0.15) 0%, rgba(6, 182, 212, 0.12) 100%) !important; border-color: rgba(14, 165, 233, 0.4) !important; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15) !important; transform: translateY(-2px) !important; }
            .monthly-table .employee-name-cell { background: linear-gradient(135deg, #0f172a 0%, #1a1f35 100%) !important; color: #e5e7eb !important; font-weight: 700 !important; border: 2px solid rgba(14, 165, 233, 0.15) !important; border-radius: 10px !important; }
            .monthly-table .employee-name-cell:hover { background: linear-gradient(135deg, #1a1f35 0%, #252d42 100%) !important; border-color: rgba(14, 165, 233, 0.3) !important; }
            header { transition: all 0.3s ease !important; }
            header:hover { box-shadow: 0 0 40px rgba(168, 85, 247, 1), 0 0 80px rgba(147, 51, 234, 0.8), 0 4px 30px rgba(168, 85, 247, 0.9) !important; }
            .tab-btn { color: white !important; border: 2px solid transparent !important; transition: all 0.3s ease !important; }
            .tab-btn.active { border-bottom: 3px solid #22c55e !important; }
            [data-tab="tab-general"] { background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%) !important; }
            [data-tab="tab-general"]:hover { box-shadow: 0 0 30px rgba(74, 222, 128, 1), 0 0 50px rgba(34, 197, 94, 0.9), 0 4px 20px rgba(74, 222, 128, 0.9) !important; }
            [data-tab="tab-individual"] { background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%) !important; }
            [data-tab="tab-individual"]:hover { box-shadow: 0 0 30px rgba(30, 64, 175, 1), 0 0 50px rgba(30, 58, 138, 0.9), 0 4px 20px rgba(30, 64, 175, 0.9) !important; }
            .nav-btn, .action-btn, .edit-btn, .modal-btn {  }
            .edit-btn.save, .modal-btn.apply { background: #22c55e !important; color: #0b1220 !important; }
            .edit-btn.cancel, .modal-btn.cancel { background: #ef4444 !important; color: #0b1220 !important; }
            .notification { background: #0ea5e9 !important; color: #0b1220 !important; }
            .notification.success { background: #22c55e !important; color: #0b1220 !important; }
            .notification.error { background: #ef4444 !important; color: #0b1220 !important; }
            .notification.warning { background: #f59e0b !important; color: #0b1220 !important; }
            .notification.info { background: #0ea5e9 !important; color: #0b1220 !important; }
            .modal-select, .turno-selector { border-color: #ddd !important; background: white !important; color: #1a1a1a !important; }
            #masiva_empleado, #masiva_desde, #masiva_hasta, #masiva_turno { border-color: #ddd !important; background: white !important; color: #1a1a1a !important; }
            #masiva_empleado option, #masiva_desde option, #masiva_hasta option, #masiva_turno option { background: white !important; color: #1a1a1a !important; }
            .calendario-btn-vista { background: #f1f5f9 !important; color: #475569 !important; border: 2px solid #e2e8f0 !important; transition: all 0.3s ease !important; }
            .calendario-btn-vista:hover { background: #e2e8f0 !important; border-color: #cbd5e1 !important; }
            .calendario-btn-vista.active { background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%) !important; border: none !important; color: white !important; box-shadow: 0 0 20px rgba(139, 92, 246, 0.4) !important; }
            .dia-calendario { background: #0f172a !important; color: #e2e8f0 !important; }
            .dia-calendario.hoy { background: rgba(34,197,94,0.15) !important; border: 2px solid #22c55e !important; }
            .dia-calendario.conflicto { background: rgba(239,68,68,0.12) !important; border: 2px solid rgba(239,68,68,0.5) !important; box-shadow: 0 0 10px rgba(239,68,68,0.3) !important; }
            .carga-baja { background: rgba(34,197,94,0.15) !important; }
            .carga-media { background: rgba(245,158,11,0.18) !important; }
            .carga-alta { background: rgba(239,68,68,0.18) !important; }
            .turno.ma√±ana { background: rgba(34,197,94,0.18) !important; color: #16a34a !important; }
            .turno.tarde { background: rgba(249, 115, 22, 0.18) !important; color: #f97316 !important; }
            .turno.noche { background: rgba(59,130,246,0.2) !important; color: #1d4ed8 !important; }
            .turno.mixto { background: rgba(249, 115, 22, 0.15) !important; color: #f97316 !important; }
            .turno.descanso { background: rgba(148,163,184,0.2) !important; color: #e2e8f0 !important; }
            .turno.vacaciones { background: rgba(249, 115, 22, 0.18) !important; color: #f97316 !important; }
            .turno.baja { background: rgba(239,68,68,0.18) !important; color: #ef4444 !important; }
            .turno.festivo { background: rgba(250,204,21,0.18) !important; color: #ca8a04 !important; }
            .turno.libre { background: rgba(148,163,184,0.15) !important; color: #e2e8f0 !important; }
            .employee-name-cell { background: #0f172a !important; color: #e5e7eb !important; }
            .monthly-header h2, .month-title { color: #e2e8f0 !important; }
        </style>
    
    <!-- Fallback: estilos m√≠nimos si CSS externo no carga -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0e4d9 0%, #e8d9f0 100%);
            min-height: 100vh;
            color: #5a5a5a;
        }
        
        /* Estilos cargados desde css/estilos.css - fallback m√≠nimo aqu√≠ */
    </style>

</head>
<body style="background: radial-gradient(circle at 15% 20%, #0f172a 0%, #0b1220 40%, #0a0f1c 80%);">
    <div class="container">
        <header style="background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); padding: 30px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 0 30px rgba(168, 85, 247, 0.8), 0 0 60px rgba(147, 51, 234, 0.6), 0 4px 20px rgba(168, 85, 247, 0.7);">
            <h1>üìä Sistema de Gesti√≥n de Turnos - Cuadrantes Mensuales</h1>
            <p class="subtitle">Cuadrantes individuales y generales con edici√≥n en tiempo real</p>
            <div style="margin-top: 6px; font-size: 13px; color: #e9d5ff;">Build pastel override v20251214-2</div>
        </header>

        <div class="top-controls">
            <div class="period-selector">
                <select id="selectYear" class="period-select">
                    <option value="2023">2023</option>
                    <option value="2024" selected>2024</option>
                    <option value="2025">2025</option>
                </select>
                <select id="selectMonth" class="period-select">
                    <option value="0">Enero</option>
                    <option value="1">Febrero</option>
                    <option value="2">Marzo</option>
                    <option value="3">Abril</option>
                    <option value="4">Mayo</option>
                    <option value="5">Junio</option>
                    <option value="6">Julio</option>
                    <option value="7">Agosto</option>
                    <option value="8">Septiembre</option>
                    <option value="9">Octubre</option>
                    <option value="10">Noviembre</option>
                    <option value="11">Diciembre</option>
                </select>
                <button class="nav-btn" onclick="DateUtils.cambiarMes(-1)">‚óÄ</button>
                <button class="nav-btn" onclick="DateUtils.cambiarMes(1)">‚ñ∂</button>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="action-btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); color: white; box-shadow: 0 2px 5px rgba(139, 92, 246, 0.2);" onclick="EmployeeManager.abrirModal()">üë• Empleados</button>
                <button class="action-btn" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; box-shadow: 0 2px 5px rgba(6, 182, 212, 0.2);" onclick="DepartmentManager.abrirModal()">üè¢ Departamentos</button>
                <button class="action-btn" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white; box-shadow: 0 2px 5px rgba(236, 72, 153, 0.2);" onclick="LocationManager.abrirModal()">üìç Localidades</button>
                <button class="action-btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; box-shadow: 0 2px 5px rgba(245, 158, 11, 0.2);" onclick="TurnoTypeManager.abrirModal()">‚è∞ Turnos</button>
                <button class="action-btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; box-shadow: 0 2px 5px rgba(16, 185, 129, 0.2);" onclick="TurnoManager.reiniciarDatos()">üìã Generar</button>
            </div>
        </div>

        <div class="tabs" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-bottom: 3px solid #f97316; padding: 0; display: flex; gap: 0; box-shadow: 0 2px 8px rgba(249, 115, 22, 0.15);">
            <button class="tab-btn active" data-tab="tab-general" style="border-radius: 0; margin: 0; flex: 1; background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); color: white; font-weight: bold; padding: 16px; border: none; font-size: 15px; transition: all 0.3s ease; cursor: pointer;">üìä Cuadrante General</button>
            <button class="tab-btn" data-tab="tab-individual" style="border-radius: 0; margin: 0; flex: 1; background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); color: white; padding: 16px; border: none; font-size: 15px; transition: all 0.3s ease; cursor: pointer;">üìà Informe Individual</button>
        </div>

        <!-- TAB 1: CUADRANTE GENERAL -->
        <div id="tab-general" class="tab-content active">
            <div class="monthly-schedule-container">
                <div class="monthly-header" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); padding: 30px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 0 30px rgba(249, 115, 22, 0.8), 0 0 60px rgba(234, 88, 12, 0.6), 0 4px 20px rgba(249, 115, 22, 0.7); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                    <div>
                        <h2 class="month-title" id="mesTituloGeneral" style="color: white; margin: 0; font-size: 28px; font-weight: 700;">üìÖ Cuadrante General</h2>
                        <p style="color: rgba(255,255,255,0.9); margin: 8px 0 0 0; font-size: 14px;">Vista completa de todos los empleados y sus turnos</p>
                    </div>
                    <div class="month-nav" style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="nav-btn" onclick="ExportManager.exportarCuadranteGeneral('pdf')" style="background: white; color: #0f172a; border: 2px solid #0ea5e9; padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(14, 165, 233, 0.2);" onmouseover="this.style.boxShadow='0 0 30px rgba(249, 115, 22, 1), 0 0 60px rgba(234, 88, 12, 0.8), 0 6px 20px rgba(249, 115, 22, 0.8)'" onmouseout="this.style.boxShadow='0 2px 5px rgba(14, 165, 233, 0.2)'">
                            üìÑ PDF General
                        </button>
                        <button class="nav-btn" onclick="ExportManager.exportarCuadranteGeneral('print')" style="background: white; color: #0f172a; border: 2px solid #0ea5e9; padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(14, 165, 233, 0.2);" onmouseover="this.style.boxShadow='0 0 30px rgba(249, 115, 22, 1), 0 0 60px rgba(234, 88, 12, 0.8), 0 6px 20px rgba(249, 115, 22, 0.8)'" onmouseout="this.style.boxShadow='0 2px 5px rgba(14, 165, 233, 0.2)'">
                            üñ®Ô∏è Imprimir General
                        </button>
                        <button class="nav-btn" onclick="TurnoEditor.mostrarModalEdicionMasiva()" style="background: #0ea5e9; color: white; border: none; padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(14, 165, 233, 0.2);" onmouseover="this.style.boxShadow='0 0 30px rgba(249, 115, 22, 1), 0 0 60px rgba(234, 88, 12, 0.8), 0 6px 20px rgba(249, 115, 22, 0.8)'" onmouseout="this.style.boxShadow='0 2px 5px rgba(14, 165, 233, 0.2)'">
                            ‚ö° Edici√≥n Masiva
                        </button>
                    </div>
                </div>
                
                <div class="filtros">
                    <select class="filtro-select" id="filtroDepartamentoGeneral">
                        <option value="">Todos los departamentos</option>
                    </select>
                    
                    <select class="filtro-select" id="filtroEstadoGeneral">
                        <option value="">Todos los estados</option>
                    </select>
                </div>
                
                <div class="edit-controls">
                    <button class="edit-btn bulk" onclick="if(window.EdicionMasiva) EdicionMasiva.abrirModal(); else TurnoEditor.mostrarModalEdicionMasiva();">
                        üìÖ Seleccionar Rango
                    </button>
                    <button class="edit-btn cancel" style="display: none;" onclick="if(window.EdicionMasiva) EdicionMasiva.cerrarModal();">
                        ‚ùå Cancelar
                    </button>
                </div>
                
                <div id="cuadranteGeneral"></div>
                
                <div class="legend">
                    <div class="legend-item"><div class="legend-color" style="background: #d4edda;"></div>Ma√±ana</div>
                    <div class="legend-item"><div class="legend-color" style="background: #fff3cd;"></div>Tarde</div>
                    <div class="legend-item"><div class="legend-color" style="background: #f8d7da;"></div>Noche</div>
                    <div class="legend-item"><div class="legend-color" style="background: #cce5ff;"></div>Mixto</div>
                    <div class="legend-item"><div class="legend-color" style="background: #e2e3e5;"></div>Descanso</div>
                    <div class="legend-item"><div class="legend-color" style="background: #d0ebff;"></div>Vacaciones</div>
                    <div class="legend-item"><div class="legend-color" style="background: #ffe3e3;"></div>Baja</div>
                </div>

                <!-- An√°lisis de Equidad y Carga de Trabajo -->
                <div id="calendarioVisual" style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(236, 72, 153, 0.08) 100%); border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border: 1px solid rgba(139, 92, 246, 0.2);"></div>

                <!-- Botones de Exportaci√≥n del Calendario -->
                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="action-btn" onclick="ExportadorCalendario.exportarAPDF()" title="Exportar calendario a PDF">
                        üìÑ Exportar Calendario PDF
                    </button>
                    <button class="action-btn" onclick="ExportadorCalendario.exportarEstadisticas()" title="Ver estad√≠sticas del mes">
                        üìä Estad√≠sticas del Mes
                    </button>
                    <button class="action-btn" onclick="FiltroCalendario.resetearFiltros()" title="Resetear todos los filtros">
                        üîÑ Resetear Filtros
                    </button>
                </div>
                
                <!-- Panel de Filtros del Calendario -->
                <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #007bff;">
                    <h4 style="margin-top: 0; margin-bottom: 12px; color: #333;">üîç Filtros del Calendario</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <!-- Filtro por Empleado -->
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #555;">Filtrar por Empleado:</label>
                            <select id="filtroEmpleadoCalendario" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" onchange="if(this.value) FiltroCalendario.filtrarPorEmpleado(parseInt(this.value)); else FiltroCalendario.resetearFiltros();">
                                <option value="">üìå Todos los empleados</option>
                            </select>
                        </div>

                        <!-- Filtro por Carga -->
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #555;">Carga de Trabajo:</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <label><input type="radio" name="filtro-carga" value="todos" checked onchange="if(this.checked) FiltroCalendario.resetearFiltros();"> Todos</label>
                                <label><input type="radio" name="filtro-carga" value="baja" onchange="if(this.checked) FiltroCalendario.filtrarPorCarga('baja');"> üü¢ Baja</label>
                                <label><input type="radio" name="filtro-carga" value="media" onchange="if(this.checked) FiltroCalendario.filtrarPorCarga('media');"> üü° Media</label>
                                <label><input type="radio" name="filtro-carga" value="alta" onchange="if(this.checked) FiltroCalendario.filtrarPorCarga('alta');"> üî¥ Alta</label>
                            </div>
                        </div>

                        <!-- Mostrar Conflictos -->
                        <div>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 500; color: #555;">
                                <input type="checkbox" id="mostrarConflictosCalendario" onchange="FiltroCalendario.toggleConflictos();" style="width: 18px; height: 18px;">
                                ‚ö†Ô∏è Mostrar Conflictos
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalEmpleadosGeneral">0</div>
                        <div class="stat-label">Total Empleados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalHorasGeneral">0</div>
                        <div class="stat-label">Horas Totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="turnosMa√±anaGeneral">0</div>
                        <div class="stat-label">Turnos Ma√±ana</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="turnosNocheGeneral">0</div>
                        <div class="stat-label">Turnos Noche</div>
                    </div>
                </div>

                <!-- Vista Previa del Empleado Seleccionado -->
                <div id="vistaPrevia" style="display: none; margin-top: 30px; padding: 20px; background: rgba(17, 24, 39, 0.9); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); border: 2px solid rgba(168, 85, 247, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #f1f5f9; margin: 0; font-size: 24px; background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üìã Cuadrante del Empleado</h3>
                        <button onclick="document.getElementById('vistaPrevia').style.display = 'none'; AppState.selectedEmployee = null;" style="background: linear-gradient(135deg, #f3d4d9 0%, #fce4ec 100%); color: #c2185b; padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(193, 24, 91, 0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">‚úï Cerrar</button>
                    </div>

                    <div class="vista-previa-grid">
                        <div class="empleado-info-card">
                            <div class="empleado-info-label">Empleado</div>
                            <div id="nombreEmpleado" class="empleado-info-value">-</div>
                        </div>
                        <div class="empleado-info-card">
                            <div class="empleado-info-label">Departamento</div>
                            <div id="deptoEmpleado" class="empleado-info-value">-</div>
                        </div>
                        <div class="empleado-info-card">
                            <div class="empleado-info-label">Horas Contrato</div>
                            <div id="horasEmpleado" class="empleado-info-value">-</div>
                        </div>
                        <div class="empleado-info-card">
                            <div class="empleado-info-label">Turno Principal</div>
                            <div id="turnoEmpleado" class="empleado-info-value">-</div>
                        </div>
                        <div class="empleado-info-card">
                            <div class="empleado-info-label">D√≠as Trabajados</div>
                            <div id="diasEmpleado" class="empleado-info-value">-</div>
                        </div>
                    </div>

                    <!-- Cuadrante Individual (Modal) -->
                    <div id="cuadranteIndividual" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: none; z-index: 9999; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;"></div>

                    <!-- Estad√≠sticas Individual -->
                    <div id="estadisticasIndividual" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>

        <!-- TAB 2: INFORME INDIVIDUAL -->
        <div id="tab-individual" class="tab-content">
            <div class="monthly-schedule-container">
                <div class="monthly-header" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); padding: 30px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 0 30px rgba(249, 115, 22, 0.8), 0 0 60px rgba(234, 88, 12, 0.6), 0 4px 20px rgba(249, 115, 22, 0.7);">
                    <h2 class="month-title" style="color: white; margin: 0; font-size: 28px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 32px;">üìä</span>
                        Informe Individual por Centro de Trabajo
                    </h2>
                    <p style="color: rgba(255,255,255,0.9); margin: 12px 0 0 0; font-size: 14px;">An√°lisis detallado de turnos por localidad, departamento y per√≠odo</p>
                </div>
                
                <div style="background: rgba(17, 24, 39, 0.9); padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); margin-bottom: 20px; border: 1px solid rgba(14, 165, 233, 0.3);">
                    <h3 style="color: #e2e8f0; margin-top: 0;">üîç Filtros</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <!-- Localidad -->
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #f1f5f9;">Localidad</label>
                            <select id="selectCentroTrabajo" style="width: 100%; padding: 12px; border: 2px solid #f97316; border-radius: 8px; font-size: 14px; background: #0f172a; color: #f1f5f9; box-shadow: 0 0 10px rgba(249, 115, 22, 0.3);">
                                <option value="">-- Todas las localidades --</option>
                            </select>
                        </div>
                        
                        <!-- Departamento -->
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #f1f5f9;">Departamento</label>
                            <select id="selectDepartamentoIndividual" style="width: 100%; padding: 12px; border: 2px solid #f97316; border-radius: 8px; font-size: 14px; background: #0f172a; color: #f1f5f9; box-shadow: 0 0 10px rgba(249, 115, 22, 0.3);">
                                <option value="">-- Todos los departamentos --</option>
                            </select>
                        </div>
                        
                        <!-- Mes -->
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #f1f5f9;">Mes</label>
                            <select id="selectMesIndividual" style="width: 100%; padding: 12px; border: 2px solid #f97316; border-radius: 8px; font-size: 14px; background: #0f172a; color: #f1f5f9; box-shadow: 0 0 10px rgba(249, 115, 22, 0.3);">
                                <option value="0">Enero</option>
                                <option value="1">Febrero</option>
                                <option value="2">Marzo</option>
                                <option value="3">Abril</option>
                                <option value="4">Mayo</option>
                                <option value="5">Junio</option>
                                <option value="6">Julio</option>
                                <option value="7">Agosto</option>
                                <option value="8">Septiembre</option>
                                <option value="9">Octubre</option>
                                <option value="10">Noviembre</option>
                                <option value="11">Diciembre</option>
                            </select>
                        </div>
                        
                        <!-- A√±o -->
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #f1f5f9;">A√±o</label>
                            <select id="selectAnioIndividual" style="width: 100%; padding: 12px; border: 2px solid #0ea5e9; border-radius: 8px; font-size: 14px; background: #0f172a; color: #f1f5f9;">
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                    </div>
                    
                    <button onclick="aplicarFiltrosInforme()" style="background: #0ea5e9; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; box-shadow: 0 2px 5px rgba(14, 165, 233, 0.2);" onmouseover="this.style.boxShadow='0 0 30px rgba(249, 115, 22, 1), 0 0 60px rgba(234, 88, 12, 0.8), 0 6px 20px rgba(249, 115, 22, 0.8)'" onmouseout="this.style.boxShadow='0 2px 5px rgba(14, 165, 233, 0.2)'">Aplicar Filtros</button>
                        üîé Buscar
                    </button>
                </div>
                
                <div id="resultadosFiltro" style="background: rgba(17, 24, 39, 0.95); padding: 24px; border-radius: 14px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); border: 2px solid rgba(168, 85, 247, 0.3);">
                    <div id="tablaResultados"></div>
                </div>
            </div>
        </div>

        <!-- MODAL DE GESTI√ìN DE EMPLEADOS -->
        <div id="modalGestionEmpleados" class="modal" onclick="if(event.target.id === 'modalGestionEmpleados') EmployeeManager.cerrarModal()">
            <div class="modal-content" style="max-width: 900px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">üë•</span>
                        Gestionar Empleados
                    </h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Agrega, edita y controla a todos tus empleados</p>
                </div>

                <!-- BOTONES DE ACCI√ìN -->
                <div style="padding: 20px 30px; display: flex; gap: 12px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                    <button class="modal-btn apply" onclick="EmployeeManager.mostrarFormularioNuevo()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7);">
                        ‚ûï Nuevo Empleado
                    </button>
                    <button class="modal-btn cancel" onclick="EmployeeManager.cerrarModal()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                        ‚úñÔ∏è Cerrar
                    </button>
                </div>

                <!-- FORMULARIO EMPLEADO -->
                <div id="formularioEmpleado" style="display: none; padding: 30px; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, rgba(249, 115, 22, 0.05) 0%, rgba(234, 88, 12, 0.05) 100%);">
                    <h4 style="color: #1e293b; margin: 0 0 20px 0; font-size: 16px; font-weight: 700;">üìù Formulario de Empleado</h4>
                    
                    <input type="hidden" id="empleadoIdEdicion" value="">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Nombre Completo *</label>
                            <input type="text" id="emple_nombre" class="modal-select" placeholder="Ej: Mar√≠a Rodr√≠guez L√≥pez" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Departamento *</label>
                            <select id="emple_departamento" class="modal-select" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <option value="">Selecciona departamento</option>
                                <option value="Operaciones">Operaciones</option>
                                <option value="Ventas">Ventas</option>
                                <option value="Administraci√≥n">Administraci√≥n</option>
                                <option value="Soporte T√©cnico">Soporte T√©cnico</option>
                                <option value="Recursos Humanos">Recursos Humanos</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Localidad *</label>
                            <select id="emple_localidad" class="modal-select" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <option value="">Selecciona localidad</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Tel√©fono *</label>
                            <input type="tel" id="emple_telefono" class="modal-select" placeholder="Ej: +34 600 123 456" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Email *</label>
                            <input type="email" id="emple_email" class="modal-select" placeholder="Ej: maria@empresa.com" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Horas de Contrato *</label>
                            <input type="number" id="emple_horas" class="modal-select" placeholder="Ej: 160" min="0" max="240" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Turno Principal *</label>
                            <select id="emple_turno" class="modal-select" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <option value="">Selecciona turno</option>
                                <option value="Ma√±ana">Ma√±ana</option>
                                <option value="Tarde">Tarde</option>
                                <option value="Noche">Noche</option>
                                <option value="Mixto">Mixto</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Estado *</label>
                            <select id="emple_estado" class="modal-select" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <option value="activo">Activo</option>
                                <option value="vacaciones">Vacaciones</option>
                                <option value="baja">Baja M√©dica</option>
                                <option value="inactivo">Inactivo</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="modal-btn apply" onclick="EmployeeManager.guardarEmpleado()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 32px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                            üíæ Guardar Empleado
                        </button>
                        <button class="modal-btn cancel" onclick="EmployeeManager.cancelarFormulario()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1;">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>

                <!-- LISTA DE EMPLEADOS -->
                <div style="padding: 30px;">
                    <h4 style="color: #1e293b; margin: 0 0 16px 0; font-size: 16px; font-weight: 700;">üìã Empleados Registrados</h4>
                    <div id="listaEmpleados" style="max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px;">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE GESTI√ìN DE DEPARTAMENTOS -->
        <div id="modalGestionDepartamentos" class="modal" onclick="if(event.target.id === 'modalGestionDepartamentos') DepartmentManager.cerrarModal()">
            <div class="modal-content" style="max-width: 700px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">üè¢</span>
                        Gestionar Departamentos
                    </h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Organiza y administra los departamentos de tu empresa</p>
                </div>

                <!-- BOTONES DE ACCI√ìN -->
                <div style="padding: 20px 30px; display: flex; gap: 12px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                    <button class="modal-btn apply" onclick="DepartmentManager.mostrarFormularioNuevo()" style="background: linear-gradient(135deg, #f97316 0%, #d97706 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(217, 119, 6, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                        ‚ûï Nuevo Departamento
                    </button>
                    <button class="modal-btn cancel" onclick="DepartmentManager.cerrarModal()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                        ‚úñÔ∏è Cerrar
                    </button>
                </div>

                <!-- FORMULARIO DEPARTAMENTO -->
                <div id="formularioDepartamento" style="display: none; padding: 30px; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, rgba(249, 115, 22, 0.05) 0%, rgba(217, 119, 6, 0.05) 100%);">
                    <h4 style="color: #1e293b; margin: 0 0 20px 0; font-size: 16px; font-weight: 700;">üìù Formulario de Departamento</h4>
                    
                    <input type="hidden" id="departamentoIdEdicion" value="">
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Nombre del Departamento *</label>
                        <input type="text" id="depto_nombre" class="modal-select" placeholder="Ej: Operaciones, Ventas, Soporte..." style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Descripci√≥n</label>
                        <textarea id="depto_descripcion" class="modal-select" placeholder="Describe el prop√≥sito de este departamento (opcional)" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; min-height: 100px; resize: vertical; transition: all 0.3s ease;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="modal-btn apply" onclick="DepartmentManager.guardarDepartamento()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 32px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                            üíæ Guardar Departamento
                        </button>
                        <button class="modal-btn cancel" onclick="DepartmentManager.cancelarFormulario()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1;">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>

                <!-- LISTA DE DEPARTAMENTOS -->
                <div style="padding: 30px;">
                    <h4 style="color: #1e293b; margin: 0 0 16px 0; font-size: 16px; font-weight: 700;">üìã Departamentos Registrados</h4>
                    <div id="listaDepartamentos" style="max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px;">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE GESTI√ìN DE LOCALIDADES -->
        <div id="modalGestionLocalidades" class="modal" onclick="if(event.target.id === 'modalGestionLocalidades') LocationManager.cerrarModal()">
            <div class="modal-content" style="max-width: 700px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">üìç</span>
                        Gestionar Localidades
                    </h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Organiza las ubicaciones o sucursales de tu empresa</p>
                </div>

                <!-- BOTONES DE ACCI√ìN -->
                <div style="padding: 20px 30px; display: flex; gap: 12px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                    <button class="modal-btn apply" onclick="LocationManager.mostrarFormularioNuevo()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                        ‚ûï Nueva Localidad
                    </button>
                    <button class="modal-btn cancel" onclick="LocationManager.cerrarModal()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                        ‚úñÔ∏è Cerrar
                    </button>
                </div>

                <!-- FORMULARIO LOCALIDAD -->
                <div id="formularioLocalidad" style="display: none; padding: 30px; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, rgba(236, 72, 153, 0.05) 0%, rgba(219, 39, 119, 0.05) 100%);">
                    <h4 style="color: #1e293b; margin: 0 0 20px 0; font-size: 16px; font-weight: 700;">üìù Formulario de Localidad</h4>
                    
                    <input type="hidden" id="localidadIdEdicion" value="">
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Nombre de la Localidad *</label>
                        <input type="text" id="loc_nombre" class="modal-select" placeholder="Ej: Madrid, Barcelona, Valencia..." style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="modal-btn apply" onclick="LocationManager.guardarLocalidad()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 32px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                            üíæ Guardar Localidad
                        </button>
                        <button class="modal-btn cancel" onclick="LocationManager.cancelarFormulario()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1;">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>

                <!-- LISTA DE LOCALIDADES -->
                <div style="padding: 30px;">
                    <h4 style="color: #1e293b; margin: 0 0 16px 0; font-size: 16px; font-weight: 700;">üìã Localidades Registradas</h4>
                    <div id="listaLocalidades" style="max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px;">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE GESTI√ìN DE TIPOS DE TURNOS -->
        <div id="modalGestionTurnos" class="modal" onclick="if(event.target.id === 'modalGestionTurnos') TurnoTypeManager.cerrarModal()">
            <div class="modal-content" style="max-width: 800px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">‚è∞</span>
                        Gestionar Tipos de Turnos
                    </h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Define y personaliza los tipos de turnos de tu empresa</p>
                </div>

                <!-- BOTONES DE ACCI√ìN -->
                <div style="padding: 20px 30px; display: flex; gap: 12px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                    <button class="modal-btn apply" onclick="TurnoTypeManager.mostrarFormularioNuevo()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                        ‚ûï Nuevo Tipo de Turno
                    </button>
                    <button class="modal-btn cancel" onclick="TurnoTypeManager.cerrarModal()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                        ‚úñÔ∏è Cerrar
                    </button>
                </div>

                <!-- FORMULARIO TURNO -->
                <div id="formularioTurno" style="display: none; padding: 30px; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, rgba(244, 63, 94, 0.05) 0%, rgba(225, 29, 72, 0.05) 100%);">
                    <h4 style="color: #1e293b; margin: 0 0 20px 0; font-size: 16px; font-weight: 700;">üìù Formulario de Tipo de Turno</h4>
                    
                    <input type="hidden" id="turnoIdEdicion" value="">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Nombre del Turno *</label>
                            <input type="text" id="turno_nombre" class="modal-select" placeholder="Ej: Ma√±ana, Tarde, Noche..." style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Inicial *</label>
                            <input type="text" id="turno_inicial" class="modal-select" placeholder="Ej: M, T, N..." maxlength="2" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Horario</label>
                            <input type="text" id="turno_horario" class="modal-select" placeholder="Ej: 08:00-16:00" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Horas *</label>
                            <input type="number" id="turno_horas" class="modal-select" placeholder="Ej: 8" min="0" max="24" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">üé® Color del Turno</label>
                        <div style="display: flex; gap: 12px; align-items: flex-end;">
                            <input type="color" id="turno_color" style="padding: 5px; border: 2px solid #e2e8f0; border-radius: 8px; width: 70px; height: 44px; cursor: pointer; transition: all 0.3s ease;">
                            <input type="text" id="turno_color_hex" class="modal-select" placeholder="#d4edda" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; flex: 1; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="modal-btn apply" onclick="TurnoTypeManager.guardarTurno()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 32px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                            üíæ Guardar Tipo de Turno
                        </button>
                        <button class="modal-btn cancel" onclick="TurnoTypeManager.cancelarFormulario()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1;">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>

                <!-- LISTA DE TURNOS -->
                <div style="padding: 30px;">
                    <h4 style="color: #1e293b; margin: 0 0 16px 0; font-size: 16px; font-weight: 700;">üìã Tipos de Turnos Registrados</h4>
                    <div id="listaTurnos" style="max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px;">
                        <!-- Se llenar√° din√°micamente -->
                    </div
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="modal-btn apply" onclick="TurnoTypeManager.guardarTurno()" style="background: #c5e2c9; color: #2e7d32; flex: 1;">
                            üíæ Guardar
                        </button>
                        <button class="modal-btn cancel" onclick="TurnoTypeManager.cancelarFormulario()" style="background: #f3d4d9; color: #c2185b; flex: 1;">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>
                
                <div id="listaTurnos" style="max-height: 400px; overflow-y: auto;">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>
        </div>

        <!-- Script para sincronizar inputs de color del turno -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const colorPicker = document.getElementById('turno_color');
                const colorHex = document.getElementById('turno_color_hex');
                
                if (colorPicker && colorHex) {
                    // Sincronizar color picker ‚Üí hex
                    colorPicker.addEventListener('change', (e) => {
                        colorHex.value = e.target.value;
                    });
                    
                    // Sincronizar hex ‚Üí color picker
                    colorHex.addEventListener('change', (e) => {
                        if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                            colorPicker.value = e.target.value;
                        }
                    });
                    
                    // Sincronizar en tiempo real para el hex input
                    colorHex.addEventListener('input', (e) => {
                        if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                            colorPicker.value = e.target.value;
                        }
                    });
                }
            });
        </script>

        <!-- MODAL DE DESCRIPCI√ìN Y EDICI√ìN DE TURNO -->
        <div id="modalDescripcionTurno" class="modal" style="z-index: 10001;" onclick="if(event.target.id === 'modalDescripcionTurno') TurnoEditor.cerrarModalDescripcion()">
            <div class="modal-content" style="max-width: 650px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 id="tituloTurnoModal" style="margin: 0; font-size: 24px; font-weight: 700;">üìã Detalles del Turno</h3>
                </div>

                <!-- CONTENIDO -->
                <div style="padding: 30px;">
                    <!-- INFORMACI√ìN GENERAL -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 28px;">
                        <div style="padding: 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(30, 64, 175, 0.08) 100%); border-radius: 10px; border-left: 3px solid #3b82f6;">
                            <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">Tipo de Turno</label>
                            <div id="tipoTurnoDesc" style="font-size: 18px; color: #1e293b; font-weight: bold;">-</div>
                        </div>
                        
                        <div style="padding: 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, rgba(22, 163, 74, 0.08) 100%); border-radius: 10px; border-left: 3px solid #22c55e;">
                            <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">Horario</label>
                            <div id="horarioTurnoDesc" style="font-size: 16px; color: #1e293b; font-weight: 600;">-</div>
                        </div>
                        
                        <div style="padding: 16px; background: linear-gradient(135deg, rgba(244, 63, 94, 0.08) 0%, rgba(225, 29, 72, 0.08) 100%); border-radius: 10px; border-left: 3px solid #f43f5e;">
                            <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">Horas Est√°ndar</label>
                            <div id="horasEstandarDesc" style="font-size: 18px; color: #1e293b; font-weight: bold;">-</div>
                        </div>
                        
                        <div style="padding: 16px; background: linear-gradient(135deg, rgba(251, 146, 60, 0.08) 0%, rgba(234, 88, 12, 0.08) 100%); border-radius: 10px; border-left: 3px solid #f97316;">
                            <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">Empleado</label>
                            <div id="empleadoDesc" style="font-size: 15px; color: #1e293b;">-</div>
                        </div>
                        
                        <div style="padding: 16px; background: linear-gradient(135deg, rgba(168, 85, 247, 0.08) 0%, rgba(126, 34, 206, 0.08) 100%); border-radius: 10px; border-left: 3px solid #a855f7;">
                            <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">D√≠a</label>
                            <div id="diaDesc" style="font-size: 15px; color: #1e293b;">-</div>
                        </div>
                        
                        <div style="padding: 16px; background: linear-gradient(135deg, rgba(236, 72, 153, 0.08) 0%, rgba(190, 24, 93, 0.08) 100%); border-radius: 10px; border-left: 3px solid #ec4899;">
                            <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">Fecha</label>
                            <div id="fechaDesc" style="font-size: 15px; color: #1e293b;">-</div>
                        </div>
                    </div>

                    <!-- EDITAR HORAS -->
                    <div style="padding: 20px; background: linear-gradient(135deg, #eff6ff 0%, #f0f9ff 100%); border: 2px solid #bfdbfe; border-radius: 12px; margin-bottom: 28px;">
                        <label style="display: block; font-weight: 700; color: #1e40af; margin-bottom: 12px; font-size: 15px;">‚è±Ô∏è Editar Horas Trabajadas</label>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <input type="number" id="horasEditarTurno" min="0" max="24" step="0.5" style="padding: 12px 14px; border: 2px solid #bfdbfe; border-radius: 8px; width: 120px; font-size: 15px; font-weight: 600; background: white; color: #1e40af; transition: all 0.3s ease;">
                            <span style="color: #1e40af; font-weight: 600;">horas</span>
                        </div>
                        <div style="font-size: 13px; color: #1e40af; margin-top: 10px; opacity: 0.8;">
                            üí° Ingresa las horas reales trabajadas en este d√≠a (0-24)
                        </div>
                    </div>

                    <!-- BOTONES R√ÅPIDOS -->
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-weight: 700; color: #1e293b; margin-bottom: 12px; font-size: 15px;">üöÄ Turnos R√°pidos</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;" id="opcionesTurnosRapidas"></div>
                    </div>
                </div>

                <!-- BOTONES -->
                <div style="padding: 24px 30px 30px; display: flex; gap: 12px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-top: 1px solid #e2e8f0;">
                    <button class="modal-btn apply" onclick="TurnoEditor.guardarDescripcion()" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3); flex: 1;" title="Guardar el turno actual" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(34, 197, 94, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(34, 197, 94, 0.3)'">
                        ‚úÖ Guardar Cambios
                    </button>
                    <button class="modal-btn whatsapp" onclick="enviarWhatsAppIndividual()" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);" title="Enviar informe por WhatsApp" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(34, 197, 94, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(34, 197, 94, 0.3)'">
                        üì§ WhatsApp
                    </button>
                    <button class="modal-btn cancel" onclick="TurnoEditor.cerrarModalDescripcion()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;" title="Cerrar sin guardar" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                        ‚ùå Cerrar
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL DE EDICI√ìN MASIVA MEJORADO -->
        <div id="modalEdicionMasiva" class="modal">
            <div class="modal-content" style="max-width: 750px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">‚ö°</span>
                        Edici√≥n Masiva de Turnos
                    </h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Asigna turnos a m√∫ltiples empleados en un solo paso</p>
                </div>

                <!-- CONTENIDO -->
                <div style="padding: 30px;">
                    <!-- PASO 1: EMPLEADO -->
                    <div style="margin-bottom: 28px; padding: 20px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%); border-radius: 12px; border-left: 4px solid #6366f1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span style="background: #6366f1; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;">1</span>
                            <label style="font-weight: 700; font-size: 15px; color: #1e293b; margin: 0;">üë§ Seleccionar Empleado</label>
                        </div>
                        <select id="masiva_empleado" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease; cursor: pointer;">
                            <option value="">-- Elige un empleado --</option>
                        </select>
                    </div>

                    <!-- PASO 2: FECHAS -->
                    <div style="margin-bottom: 28px; padding: 20px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, rgba(59, 130, 246, 0.08) 100%); border-radius: 12px; border-left: 4px solid #22c55e;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span style="background: #22c55e; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;">2</span>
                            <label style="font-weight: 700; font-size: 15px; color: #1e293b; margin: 0;">üìÖ Rango de Fechas</label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                            <div>
                                <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px; font-weight: 600;">Desde:</label>
                                <select id="masiva_desde" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                    <option value="">D√≠a inicio</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px; font-weight: 600;">Hasta:</label>
                                <select id="masiva_hasta" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                    <option value="">D√≠a fin</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- PASO 3: TURNO -->
                    <div style="margin-bottom: 28px; padding: 20px; background: linear-gradient(135deg, rgba(244, 63, 94, 0.08) 0%, rgba(249, 115, 22, 0.08) 100%); border-radius: 12px; border-left: 4px solid #f43f5e;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span style="background: #f43f5e; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;">3</span>
                            <label style="font-weight: 700; font-size: 15px; color: #1e293b; margin: 0;">üéØ Nuevo Turno/Estado</label>
                        </div>
                        <select id="masiva_turno" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                            <option value="">-- Selecciona turno --</option>
                            <option value="ma√±ana">‚òÄÔ∏è Ma√±ana (08:00-16:00)</option>
                            <option value="tarde">üå§Ô∏è Tarde (16:00-00:00)</option>
                            <option value="noche">üåô Noche (00:00-08:00)</option>
                            <option value="mixto">‚ö° Mixto</option>
                            <option value="descanso">üò¥ Descanso</option>
                            <option value="vacaciones">üèñÔ∏è Vacaciones</option>
                            <option value="baja">üè• Baja M√©dica</option>
                            <option value="libre">‚ú® Libre</option>
                        </select>
                    </div>

                    <!-- RESUMEN -->
                    <div style="padding: 20px; background: linear-gradient(135deg, #eff6ff 0%, #f0f9ff 100%); border: 2px solid #bfdbfe; border-radius: 12px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <span style="font-size: 20px;">üìä</span>
                            <strong style="color: #1e40af; font-size: 15px;">Resumen de cambios</strong>
                        </div>
                        <div id="masiva_resumen" style="color: #1e40af; font-size: 14px; line-height: 1.6;">
                            Selecciona empleado, rango de fechas y turno para ver el resumen
                        </div>
                    </div>
                </div>

                <!-- BOTONES -->
                <div style="padding: 24px 30px 30px; display: flex; gap: 12px; justify-content: flex-end; border-top: 1px solid #e2e8f0;">
                    <button class="modal-btn cancel" onclick="EdicionMasiva.cerrarModal()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                        ‚úñÔ∏è Cancelar
                    </button>
                    <button class="modal-btn apply" onclick="EdicionMasiva.aplicarCambios()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 32px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7);">
                        ‚úÖ Aplicar Cambios
                    </button>
                </div>
            </div>
        </div>
            </div>
        </div>

        <!-- MODAL DE INFORME INDIVIDUAL -->
        <!-- MODAL DE INFORME INDIVIDUAL - ELIMINADO (Se usa la pesta√±a en su lugar) -->

        <div class="footer">
            <p>Sistema de Gesti√≥n de Turnos v8.0 | Cuadrantes editables en tiempo real</p>
            <p>Haz clic en cualquier turno para editarlo</p>
        </div>
    </div>

    <!-- M√≥dulos JavaScript - Orden de carga cr√≠tico -->
    <script src="js/modules.js"></script>

    <!-- üîó Vincular m√©todos del modal al TurnoManager de modules.js -->
    <script>
        (function() {
            // Esperar a que modules.js cargue completamente
            const waitForTurnoManager = setInterval(() => {
                if (typeof TurnoManager !== 'undefined' && TurnoManager.prototype) {
                    clearInterval(waitForTurnoManager);
                    
                    // Funciones del modal que deben estar disponibles
                    const functionsToAdd = {
                        esCuadranteVacio: function() {
                            const ahora = new Date();
                            const mesActual = AppState.currentMonth;
                            const anioActual = AppState.currentYear;
                            
                            for (let [empId, turnos] of AppState.scheduleData) {
                                const tieneDelMes = turnos.some(t => {
                                    if (!t.fecha) return false;
                                    const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                                    return fecha.getMonth() === mesActual && fecha.getFullYear() === anioActual;
                                });
                                
                                if (tieneDelMes) return false;
                            }
                            return true;
                        },

                        mostrarModalGeneracion: function() {
                            const modal = document.getElementById('modalGenerarTurnos');
                            if (!modal) {
                                console.error('‚ùå modalGenerarTurnos no encontrado');
                                return;
                            }
                            
                            const mesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                            
                            const infoMes = document.getElementById('infoMesGeneracion');
                            const infoAnio = document.getElementById('infoAnioGeneracion');
                            const resumenEmpl = document.getElementById('resumenEmpleados');
                            const resumenTurnos = document.getElementById('resumenTurnos');
                            
                            if (infoMes) infoMes.textContent = mesNombres[AppState.currentMonth];
                            if (infoAnio) infoAnio.textContent = AppState.currentYear;
                            
                            const diasEnMes = new Date(AppState.currentYear, AppState.currentMonth + 1, 0).getDate();
                            const totalEmpleados = empleados.length;
                            const totalTurnos = diasEnMes * totalEmpleados;
                            
                            if (resumenEmpl) resumenEmpl.textContent = totalEmpleados;
                            if (resumenTurnos) resumenTurnos.textContent = '~' + totalTurnos;
                            
                            modal.classList.add('active');
                            console.log('‚úÖ Modal abierto');
                        },

                        cerrarModalGeneracion: function() {
                            const modal = document.getElementById('modalGenerarTurnos');
                            if (modal) {
                                modal.classList.remove('active');
                                console.log('‚úÖ Modal cerrado');
                            }
                        },

                        generarTurnos: async function() {
                            console.log('[generarTurnos] ÔøΩ >>> BOT√ìN CLICKEADO - Iniciando generaci√≥n...');
                            NotificationSystem.show('‚è≥ Generando turnos...', 'info');
                            
                            try {
                                console.log('[generarTurnos] Step 1: Llamando inicializarDatos()');
                                const resultado = this.inicializarDatos();
                                console.log('[generarTurnos] Step 1 ‚úì inicializarDatos() complet√≥:', resultado);
                                
                                console.log('[generarTurnos] Step 2: Guardando a AppState');
                                AppState.saveToStorage();
                                console.log('[generarTurnos] Step 2 ‚úì AppState guardado');
                                
                                console.log('[generarTurnos] Step 3: Verificando protocolo -', window.location.protocol);
                                if (window.location.protocol !== 'file:') {
                                    console.log('[generarTurnos] Step 3.1: Intentando guardar en API');
                                    let apiGuardados = 0;
                                    for (let empleado of empleados) {
                                        const turnos = AppState.scheduleData.get(empleado.id) || [];
                                        const turnosDelMes = turnos.filter(t => {
                                            const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                                            return fecha.getMonth() === AppState.currentMonth && 
                                                   fecha.getFullYear() === AppState.currentYear;
                                        });
                                        
                                        if (turnosDelMes.length > 0) {
                                            try {
                                                const response = await fetch(`/api/turnos/${empleado.id}`, {
                                                    method: 'POST',
                                                    headers: {'Content-Type': 'application/json'},
                                                    body: JSON.stringify({
                                                        mes: AppState.currentMonth,
                                                        anio: AppState.currentYear,
                                                        turnos: turnosDelMes
                                                    })
                                                });
                                                console.log(`‚úÖ API: Turnos guardados para ${empleado.nombre}`);
                                                apiGuardados++;
                                            } catch (e) {
                                                console.warn(`‚ö†Ô∏è API error para ${empleado.nombre}:`, e);
                                            }
                                        }
                                    }
                                    console.log(`[generarTurnos] Step 3.2 ‚úì API: ${apiGuardados} empleados guardados`);
                                } else {
                                    console.log('[generarTurnos] Step 3 SKIP: Protocolo file:// - no hay API');
                                }
                                
                                console.log('[generarTurnos] Step 4: Cerrando modal y actualizando UI');
                                this.cerrarModalGeneracion();
                                UI.generarCuadranteGeneral();
                                console.log('[generarTurnos] Step 4 ‚úì Modal cerrado y UI actualizada');
                                
                                NotificationSystem.show('‚úÖ Turnos generados correctamente', 'success');
                                console.log('[generarTurnos] ‚úÖ COMPLETADO EXITOSAMENTE');
                            } catch (err) {
                                console.error('‚ùå Error CR√çTICO al generar:', err);
                                console.error('Stack:', err.stack);
                                NotificationSystem.show('‚ùå Error al generar turnos', 'error');
                            }
                        },

                        verificarYMostrarBoton: function() {
                            const btn = document.getElementById('btnGenerarTurnos');
                            if (!btn) {
                                console.log('‚ö†Ô∏è btnGenerarTurnos no encontrado');
                                return;
                            }
                            
                            const estaVacio = this.esCuadranteVacio();
                            if (estaVacio) {
                                btn.style.display = 'block';
                                console.log('üü¢ Bot√≥n MOSTRADO (cuadrante vac√≠o)');
                            } else {
                                btn.style.display = 'none';
                                console.log('üî¥ Bot√≥n OCULTADO (cuadrante con datos)');
                            }
                        }
                    };
                    
                    // Agregar funciones como m√©todos est√°ticos
                    for (const [name, func] of Object.entries(functionsToAdd)) {
                        if (!TurnoManager[name]) {
                            TurnoManager[name] = func;
                            console.log(`‚úÖ Agregado TurnoManager.${name}`);
                        }
                    }
                    
                    // Crear alias global para compatibilidad
                    window.TurnoManager = TurnoManager;
                }
            }, 100);
            
            // Timeout de seguridad
            setTimeout(() => clearInterval(waitForTurnoManager), 5000);
        })();
    </script>

    <!-- 2. Sistema de restricciones y balanceo autom√°tico -->
    <script src="js/balanceo-y-restricciones.js"></script>

    <!-- 3. Reportes avanzados y predicci√≥n de conflictos - DESHABILITADO TEMPORALMENTE -->
    <!-- <script src="js/reportes-y-prediccion.js"></script> -->

    <!-- 4. Soporte multi-local y multi-departamento - DESHABILITADO TEMPORALMENTE -->
    <!-- <script src="js/soporte-multilocal.js"></script> -->

    <!-- 5. Calendario visual interactivo -->
    <script src="js/calendario-visual.js"></script>

    <!-- Script para manejar las pesta√±as -->
    <script>
        setTimeout(() => {
            // Manejar el cambio de pesta√±as
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = e.target.dataset.tab;
                    
                    // Remover clase active de todos los botones y contenidos
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                    
                    // Agregar clase active al bot√≥n y contenido seleccionado
                    e.target.classList.add('active');
                    const selectedTab = document.getElementById(tabId);
                    if (selectedTab) {
                        selectedTab.classList.add('active');
                        console.log('‚úì Tab cambiado a:', tabId);
                    }
                });
            });
            console.log('‚úì Event listeners de tabs configurados');
        }, 100);
    </script>

    <!-- Script de inicializaci√≥n principal - REMOVIDO: botones ahora usan onclick inline -->
    
    <!-- Script para inicializar controles del calendario -->
    <script>
        setTimeout(() => {
            // Llenar selector de empleados en filtro del calendario
            const selectEmpleado = document.getElementById('filtroEmpleadoCalendario');
            if (selectEmpleado && Array.isArray(empleados)) {
                empleados.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `üë§ ${emp.nombre}`;
                    selectEmpleado.appendChild(option);
                });
            }

            // Llenar selector de empleados para informe individual
            const selectInforme = document.getElementById('selectEmpleado');
            if (selectInforme && Array.isArray(empleados)) {
                selectInforme.innerHTML = '<option value="">Selecciona un empleado</option>';
                empleados.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = emp.nombre;
                    selectInforme.appendChild(option);
                });

                // Agregar evento de cambio
                selectInforme.addEventListener('change', (e) => {
                    const empleadoId = parseInt(e.target.value);
                    if (empleadoId) {
                        const empleado = empleados.find(emp => emp.id === empleadoId);
                        if (empleado) {
                            AppState.selectedEmployee = empleado;
                            
                            // Mostrar vista previa
                            const vistaPrevia = document.getElementById('vistaPrevia');
                            const turnos = AppState.scheduleData.get(empleado.id) || [];
                            const diasTrabajados = turnos.filter(t => t.turno && t.turno !== 'descanso' && t.turno !== 'vacaciones' && t.turno !== 'baja').length;
                            
                            document.getElementById('nombreEmpleado').textContent = empleado.nombre;
                            document.getElementById('deptoEmpleado').textContent = empleado.departamento;
                            document.getElementById('horasEmpleado').textContent = empleado.horasContrato + 'h';
                            document.getElementById('turnoEmpleado').textContent = empleado.turnoPrincipal;
                            document.getElementById('diasEmpleado').textContent = diasTrabajados;
                            
                            vistaPrevia.style.display = 'block';
                            
                            // Actualizar cuadrante individual
                            mostrarCuadranteEmpleado(empleado.id);
                            actualizarEstadisticasIndividual();
                        }
                    } else {
                        AppState.selectedEmployee = null;
                        document.getElementById('vistaPrevia').style.display = 'none';
                        document.getElementById('cuadranteIndividual').innerHTML = '';
                    }
                });
            }
        }, 100);
    </script>

    <!-- Script de inicializaci√≥n final -->
    <script>
        // Variables para control de navegaci√≥n del informe individual
        let mesIndividual = new Date().getMonth();
        let anioIndividual = new Date().getFullYear();

        // Cambiar mes en la pesta√±a de informe individual
        // Llenar opciones de localidades
        function llenarCentrosDeTrabajo() {
            const selectCentro = document.getElementById('selectCentroTrabajo');
            if (!selectCentro) return;
            
            // Usar localidades del LocationManager si est√° disponible
            const localidades = (typeof LocationManager !== 'undefined' && LocationManager.localidades) 
                ? LocationManager.localidades.map(l => l.nombre).sort()
                : [...new Set(empleados.map(e => e.localidad || 'Sin especificar'))].sort();
            
            localidades.forEach(localidad => {
                const option = document.createElement('option');
                option.value = localidad;
                option.textContent = localidad;
                selectCentro.appendChild(option);
            });
        }

        // Funci√≥n para mostrar el cuadrante de un empleado seleccionado
        function mostrarCuadranteEmpleado(empleadoId) {
            const cuadranteIndividual = document.getElementById('cuadranteIndividual');
            if (!cuadranteIndividual) return;

            // üîß GARANTIZAR QUE USAMOS LOS EMPLEADOS ACTUALES (desde localStorage)
            const empleadosActuales = JSON.parse(localStorage.getItem('empleadosData') || '[]');
            const empleado = empleadosActuales.find(e => e.id === empleadoId) || empleados.find(e => e.id === empleadoId);
            if (!empleado) return;

            const turnos = AppState.scheduleData.get(empleadoId) || [];
            const mes = AppState.currentMonth;
            const anio = AppState.currentYear;

            // Obtener el n√∫mero de d√≠as en el mes
            const diasEnMes = new Date(anio, mes + 1, 0).getDate();
            const primerDia = new Date(anio, mes, 1).getDay();

            // Obtener los tipos de turno disponibles
            const tiposTurnoList = JSON.parse(localStorage.getItem('tiposTurnoData')) || {};
            const tiposTurnoArray = Object.values(tiposTurnoList);

            // Calcular estad√≠sticas
            const ma√±anas = turnos.filter(t => t.turno === 'ma√±ana').length;
            const tardes = turnos.filter(t => t.turno === 'tarde').length;
            const noches = turnos.filter(t => t.turno === 'noche').length;
            const vacaciones = turnos.filter(t => t.turno === 'vacaciones').length;
            const baja = turnos.filter(t => t.turno === 'baja').length;
            const descansos = turnos.filter(t => t.turno === 'descanso' || t.turno === 'libre').length;
            const diasTrabajados = turnos.filter(t => t.turno && !['descanso', 'libre', 'baja', 'vacaciones'].includes(t.turno)).length;
            
            // üîß BUG FIX: Contar guardias correctamente
            // Guardia = Domingo trabajado O festivo trabajado O turno espec√≠ficamente marcado como guardia
            const guardias = turnos.filter(t => {
                if (!t.fecha) return false;
                const diaSemana = t.fecha.getDay ? t.fecha.getDay() : new Date(t.fecha).getDay();
                const esDomingo = diaSemana === 0;
                // üîß MEJORADO: Usar festivos locales del empleado en lugar de globales
                const esFestivoTrabajado = typeof esFestivoLocal === 'function' 
                    ? esFestivoLocal(t.fecha, empleadoId) 
                    : esFestivo(t.fecha);
                const esGuardiaEspec√≠fica = t.turno && (t.turno.includes('guardia') || t.turno.includes('domingo'));
                
                // Contar como guardia si:
                // 1. Es domingo Y tiene un turno trabajado (no descansa)
                // 2. Es festivo (local) Y tiene un turno trabajado
                // 3. El turno est√° espec√≠ficamente marcado como guardia
                const turnoTrabajado = t.turno && !['descanso', 'libre', 'baja', 'vacaciones', 'festivo'].includes(t.turno);
                return (esDomingo && turnoTrabajado) || (esFestivoTrabajado && turnoTrabajado) || esGuardiaEspec√≠fica;
            }).length;

            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            // Calcular total de horas directamente desde los turnos guardados
            const totalHoras = Math.round(turnos.reduce((sum, t) => sum + (t.horas || 0), 0) * 100) / 100;

            // Crear HTML del modal
            let html = `
                <div style="background: #0f172a; border-radius: 16px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.7); padding: 0;">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%); padding: 20px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: white; font-size: 28px; font-weight: 700;">üìÖ Cuadrante del Empleado</h2>
                        <button onclick="document.getElementById('cuadranteIndividual').style.display = 'none'; document.getElementById('cuadranteIndividual').innerHTML = '';" style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 16px;">‚úñ Cerrar</button>
                    </div>

                    <!-- Contenido -->
                    <div style="padding: 18px;">
                        <!-- Informaci√≥n del Empleado -->
                        <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #475569;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px;">
                                <div style="padding: 15px; background: rgba(139, 92, 246, 0.2); border-radius: 8px; border-left: 4px solid #a78bfa;">
                                    <div style="color: #94a3b8; font-size: 14px; font-weight: 600;">üë§ EMPLEADO</div>
                                    <div style="color: #f1f5f9; font-size: 18px; font-weight: 700; margin-top: 6px;">${empleado.nombre}</div>
                                </div>
                                <div style="padding: 15px; background: rgba(59, 130, 246, 0.2); border-radius: 8px; border-left: 4px solid #60a5fa;">
                                    <div style="color: #94a3b8; font-size: 14px; font-weight: 600;">üè¢ DEPARTAMENTO</div>
                                    <div style="color: #f1f5f9; font-size: 18px; font-weight: 700; margin-top: 6px;">${empleado.departamento || 'N/A'}</div>
                                </div>
                                <div style="padding: 15px; background: rgba(16, 185, 129, 0.2); border-radius: 8px; border-left: 4px solid #34d399;">
                                    <div style="color: #94a3b8; font-size: 14px; font-weight: 600;">‚è±Ô∏è HORAS CONTRATO</div>
                                    <div style="color: #f1f5f9; font-size: 18px; font-weight: 700; margin-top: 6px;">${empleado.horasContrato}h</div>
                                </div>
                                <div style="padding: 15px; background: rgba(245, 158, 11, 0.2); border-radius: 8px; border-left: 4px solid #fbbf24;">
                                    <div style="color: #94a3b8; font-size: 14px; font-weight: 600;">üéØ TURNO PRINCIPAL</div>
                                    <div style="color: #f1f5f9; font-size: 18px; font-weight: 700; margin-top: 6px;">${empleado.turnoPrincipal || 'N/A'}</div>
                                </div>
                                <div style="padding: 15px; background: rgba(168, 85, 247, 0.2); border-radius: 8px; border-left: 4px solid #d8b4fe;">
                                    <div style="color: #94a3b8; font-size: 14px; font-weight: 600;">üìä D√çAS TRABAJADOS</div>
                                    <div style="color: #f1f5f9; font-size: 18px; font-weight: 700; margin-top: 6px;">${diasTrabajados}</div>
                                </div>
                                <div style="padding: 15px; background: rgba(239, 68, 68, 0.2); border-radius: 8px; border-left: 4px solid #fca5a5;">
                                    <div style="color: #94a3b8; font-size: 14px; font-weight: 600;">üö® GUARDIAS</div>
                                    <div style="color: #fca5a5; font-size: 18px; font-weight: 700; margin-top: 6px;">${guardias}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Calendario -->
                        <div style="margin-bottom: 12px;">
                            <h3 style="color: #f1f5f9; margin: 0 0 10px 0; font-size: 20px; font-weight: 700;">üìÜ ${meses[mes]} ${anio}</h3>
                            <div style="background: #1e293b; border-radius: 12px; padding: 10px; border: 1px solid #475569;">
                                <!-- D√≠as de la semana -->
                                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px;">
                                    ${['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'].map(dia => 
                                        `<div style="text-align: center; color: #94a3b8; font-weight: 700; font-size: 13px; padding: 8px;">${dia}</div>`
                                    ).join('')}
                                </div>
                                <!-- D√≠as del mes -->
                                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
                                    ${Array(primerDia).fill(0).map(() => 
                                        `<div style="min-height: 45px; background: #0f172a; border-radius: 6px;"></div>`
                                    ).join('')}
                                    ${Array.from({length: diasEnMes}, (_, i) => {
                                        const dia = i + 1;
                                        const turno = turnos.find(t => t.dia === dia);
                                        const tipoTurno = tiposTurnoArray.find(tt => lowerCaseSafe(tt.nombre) === lowerCaseSafe(turno?.turno));
                                        const color = tipoTurno?.color || '#e2e3e5';
                                        const inicial = tipoTurno?.inicial || turno?.turno || '-';
                                        
                                        // üîß MEJORADO: Detectar domingos y festivos locales del empleado
                                        const fecha = new Date(anio, mes, dia);
                                        const diaSemana = fecha.getDay();
                                        const esDomingo = diaSemana === 0;
                                        // üîß NUEVO: Usar festivos locales del empleado en lugar de globales
                                        const esFestivo = typeof window.esFestivoLocal === 'function' 
                                            ? window.esFestivoLocal(fecha, empleadoId)
                                            : (typeof window.esFestivo === 'function' ? window.esFestivo(fecha) : false);
                                        const esGuardiaPotencial = esDomingo || esFestivo;
                                        
                                        // Estilo especial para domingos/festivos
                                        const bordeGuardia = esGuardiaPotencial ? '3px solid #ff6b6b' : '2px solid transparent';
                                        const sombraGuardia = esGuardiaPotencial ? '0 0 12px rgba(255, 107, 107, 0.6), inset 0 0 8px rgba(255, 107, 107, 0.2)' : 'none';
                                        
                                        return `
                                            <div style="min-height: 45px; background: ${color}; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; border: ${bordeGuardia}; position: relative; box-shadow: ${sombraGuardia};" 
                                                 onmouseover="this.style.transform='scale(1.08)'; this.style.boxShadow='0 0 20px rgba(255,255,255,0.4), 0 4px 16px rgba(0,0,0,0.5)'; this.style.borderColor='#fff';" 
                                                 onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='${sombraGuardia}'; this.style.borderColor='${esGuardiaPotencial ? '#ff6b6b' : 'transparent'}';"
                                                 onclick="TurnoEditor.abrirEditorTurno(${empleadoId}, ${dia})"
                                                 title="Clic para editar - ${turno?.turno || 'Sin turno'} - ${turno?.horas || 0}h${esGuardiaPotencial ? ' üö® GUARDIA POTENCIAL' : ''}">
                                                <div style="text-align: center; z-index: 1;">
                                                    <div style="font-size: 13px; color: #fb923c; font-weight: 700;">${dia}</div>
                                                    <div style="font-size: 28px; color: #0f172a; font-weight: 900; margin-top: 1px;">${inicial}</div>
                                                    ${esGuardiaPotencial ? '<div style="font-size: 10px; color: #ff6b6b; font-weight: 700; margin-top: 2px;">üö®</div>' : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Resumen de Turnos (Versi√≥n Inteligente) -->
                        <div id="resumenInteligente_${empleadoId}" data-emp-id="${empleadoId}" data-mes="${mes}" data-anio="${anio}" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 20px; border-radius: 12px; border: 1px solid #475569;">
                            <h3 style="color: #f1f5f9; margin: 0 0 15px 0; font-size: 16px; font-weight: 700;">üìä Resumen de Turnos</h3>
                            <div class="placeholder-summary">Cargando resumen...</div>
                        </div>

                        <!-- Bot√≥n WhatsApp -->
                        <button class="btn-whatsapp-modal" onclick="exportarEmpleado(${empleadoId}, '${meses[mes]}', ${anio}, 'whatsapp')" title="Enviar informe por WhatsApp" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; padding: 14px 28px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3); width: 100%; margin-top: 16px;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(34, 197, 94, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(34, 197, 94, 0.3)'">
                            üì± Enviar por WhatsApp
                        </button>

                    </div>
                </div>
            `;

            cuadranteIndividual.innerHTML = html;
            cuadranteIndividual.style.display = 'flex';
            
            // üîß GUARDAR HTML DEL CUADRANTE PARA LA EXPORTACI√ìN
            window.htmlCuadranteActual = html;
        }

        // Cerrar modal al hacer clic fuera de la tabla
        document.addEventListener('DOMContentLoaded', function() {
            const cuadranteIndividual = document.getElementById('cuadranteIndividual');
            if (cuadranteIndividual) {
                cuadranteIndividual.addEventListener('click', function(e) {
                    if (e.target === this) {
                        cuadranteIndividual.style.display = 'none';
                        cuadranteIndividual.innerHTML = '';
                    }
                });
                // Cerrar con tecla ESC
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && cuadranteIndividual.style.display === 'flex') {
                        cuadranteIndividual.style.display = 'none';
                        cuadranteIndividual.innerHTML = '';
                    }
                });
            }
        });

        // Funci√≥n para actualizar las estad√≠sticas del empleado
        function actualizarEstadisticasIndividual() {
            const empleadoId = AppState.selectedEmployee?.id;
            if (!empleadoId) return;

            const turnos = AppState.scheduleData.get(empleadoId) || [];
            const tiposTurnoList = JSON.parse(localStorage.getItem('tiposTurnoData')) || {};
            const tiposTurnoArray = Object.values(tiposTurnoList);

            // Calcular estad√≠sticas
            let totalHoras = 0;
            let turnosMa√±ana = 0;
            let turnosTarde = 0;
            let turnosNoche = 0;
            let diasVacaciones = 0;
            let diasBaja = 0;
            let diasDescanso = 0;

            turnos.forEach(t => {
                totalHoras += t.horas || 0;
                
                // Comparar por nombre completo del turno, no por inicial
                if (t.turno === 'ma√±ana') turnosMa√±ana++;
                else if (t.turno === 'tarde') turnosTarde++;
                else if (t.turno === 'noche') turnosNoche++;
                else if (t.turno === 'vacaciones') diasVacaciones++;
                else if (t.turno === 'baja') diasBaja++;
                else if (t.turno === 'descanso') diasDescanso++;
            });

            // Crear HTML de estad√≠sticas
            const estadisticasDiv = document.getElementById('estadisticasIndividual');
            if (estadisticasDiv) {
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">';
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Total Horas</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${totalHoras}h</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Ma√±anas</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${turnosMa√±ana}</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Tardes</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${turnosTarde}</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Noches</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${turnosNoche}</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Vacaciones</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${diasVacaciones}</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Baja</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${diasBaja}</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Descansos</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${diasDescanso}</div></div>`;
                html += '</div>';
                estadisticasDiv.innerHTML = html;
            }
        }

        // Aplicar filtros y mostrar resultados
        function aplicarFiltrosInforme() {
            const localidad = document.getElementById('selectCentroTrabajo').value;
            const departamento = document.getElementById('selectDepartamentoIndividual').value;
            const mes = parseInt(document.getElementById('selectMesIndividual').value);
            const anio = parseInt(document.getElementById('selectAnioIndividual').value);
            
            // Filtrar empleados por localidad y departamento
            let empleadosFiltrados = empleados;
            if (localidad) {
                empleadosFiltrados = empleadosFiltrados.filter(e => (e.localidad || 'Sin especificar') === localidad);
            }
            if (departamento) {
                empleadosFiltrados = empleadosFiltrados.filter(e => e.departamento === departamento);
            }
            
            if (empleadosFiltrados.length === 0) {
                let msg = 'No hay empleados con los filtros seleccionados.';
                document.getElementById('tablaResultados').innerHTML = `<p style="text-align: center; color: #cbd5e1;">${msg}</p>`;
                return;
            }
            
            // Construir tabla
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            let titulo = '';
            if (localidad && departamento) {
                titulo = `üìç ${localidad} - üè¢ ${departamento}`;
            } else if (localidad) {
                titulo = `üìç ${localidad}`;
            } else if (departamento) {
                titulo = `üè¢ ${departamento}`;
            } else {
                titulo = 'üìã Todos los empleados';
            }
            
            let html = `
                <h3 style="color: #a855f7; margin-bottom: 20px; font-size: 26px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                    ${titulo} - ${meses[mes]} ${anio}
                </h3>
                <div style="overflow-x: auto; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.3);">
                    <table class="cuadrante-empleado-table">
                        <thead>
                            <tr>
                                <th>Empleado</th>
                                <th>Horas</th>
                                <th>Turnos Noche</th>
                                <th>Vacaciones</th>
                                <th>Balance</th>
                                <th>Cumplimiento</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Agregar filas para cada empleado
            empleadosFiltrados.forEach(empleado => {
                const turnos = AppState.scheduleData.get(empleado.id) || [];
                
                // Calcular total de horas directamente desde los turnos guardados
                const totalHoras = Math.round(turnos.reduce((sum, t) => sum + (t.horas || 0), 0) * 100) / 100;
                
                const turnosNoche = turnos.filter(t => t.turno === 'noche').length;
                const vacaciones = turnos.filter(t => t.turno === 'vacaciones' || t.turno === 'baja').length;
                const balance = totalHoras - empleado.horasContrato;
                const cumplimiento = Math.round((totalHoras / empleado.horasContrato) * 100);
                
                const balanceColor = balance >= 0 ? '#22c55e' : '#ef4444';
                const bgHover = empleadosFiltrados.indexOf(empleado) % 2 === 0 ? 'rgba(168, 85, 247, 0.05)' : 'rgba(236, 72, 153, 0.05)';
                
                html += `
                    <tr style="background: ${bgHover};">
                        <td style="font-weight: 700; color: #a855f7;">${empleado.nombre}</td>
                        <td>${totalHoras}h</td>
                        <td>${turnosNoche}</td>
                        <td>${vacaciones}</td>
                        <td style="background: ${balance >= 0 ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; color: ${balanceColor}; font-weight: 700;">${balance >= 0 ? '+' : ''}${balance}h</td>
                        <td style="font-weight: 700; color: ${cumplimiento >= 100 ? '#22c55e' : cumplimiento >= 80 ? '#f59e0b' : '#ef4444'};">${cumplimiento}%</td>
                        <td>
                            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                                <button onclick="exportarEmpleado(${empleado.id}, '${meses[mes]}', ${anio}, 'pdf')" title="PDF" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.3)'">üìÑ</button>
                                <button onclick="exportarEmpleado(${empleado.id}, '${meses[mes]}', ${anio}, 'whatsapp')" title="WhatsApp" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(34, 197, 94, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(34, 197, 94, 0.3)'">üì§</button>
                                <button onclick="exportarEmpleado(${empleado.id}, '${meses[mes]}', ${anio}, 'csv')" title="Excel" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(14, 165, 233, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(14, 165, 233, 0.3)'">üìä</button>
                                <button onclick="exportarEmpleado(${empleado.id}, '${meses[mes]}', ${anio}, 'copy')" title="Copiar" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%); color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(100, 116, 139, 0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(100, 116, 139, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(100, 116, 139, 0.3)'">üìã</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('tablaResultados').innerHTML = html;
        }

        // Obtener color del turno
        function getTurnoColor(turno) {
            const colores = {
                'ma√±ana': '#d4edda',
                'tarde': '#fff3cd',
                'noche': '#f8d7da',
                'guardia': '#d8b4fe',
                'mixto': '#cce5ff',
                'asuntospropios': '#e0e7ff',
                'descanso': '#e2e3e5',
                'vacaciones': '#d0ebff',
                'baja': '#ffe3e3',
                'libre': '#f9f9f9',
                'festivo': '#fff9e6'
            };
            return colores[turno] || '#ffffff';
        }

        // Funci√≥n para exportar datos de un empleado
        // =====================================================================================
        // üî∂ UTILIDADES DE EXPORTACI√ìN VISUAL (PDF PARA WHATSAPP Y REPORTES INDIVIDUALES)
        // =====================================================================================
        const lowerCaseSafe = (valor) => (valor === undefined || valor === null) ? '' : String(valor).toLowerCase();

        function calcularHorasDelHorario(horario) {
            if (!horario || typeof horario !== 'string') return '';
            const match = horario.match(/(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/);
            if (!match) return '';
            const horaInicio = parseInt(match[1]);
            const minInicio = parseInt(match[2]);
            const horaFin = parseInt(match[3]);
            const minFin = parseInt(match[4]);
            
            let totalMinutos = (horaFin * 60 + minFin) - (horaInicio * 60 + minInicio);
            if (totalMinutos < 0) totalMinutos += 24 * 60; // Para turnos nocturnos que cruzan medianoche
            
            const horas = totalMinutos / 60;
            return horas % 1 === 0 ? `${Math.round(horas)}` : `${horas.toFixed(1)}`;
        }

        function obtenerInfoTurnoVisualPDF(nombre, tiposTurnoData) {
            const paletaFallback = {
                'ma√±ana': '#86efac',
                'tarde': '#fcd34d',
                'noche': '#93c5fd',
                'mixto': '#fde68a',
                'descanso': '#cbd5f5',
                'vacaciones': '#fecdd3',
                'baja': '#fda4af',
                'libre': '#e0e7ff',
                'festivo': '#fef3c7'
            };
            if (!nombre) {
                return { etiqueta: 'Sin turno', inicial: '-', color: 'rgba(148,163,184,0.25)', horario: '', horas: '' };
            }
            const lower = lowerCaseSafe(nombre);
            const lista = Object.values(tiposTurnoData || {});
            const coincidencia = lista.find(t => lowerCaseSafe(t?.nombre) === lower || lowerCaseSafe(t?.id) === lower);
            
            // Prioridad: obtener horas del tipo de turno
            let horas = coincidencia?.horas || '';
            if (!horas && coincidencia?.horario) {
                horas = calcularHorasDelHorario(coincidencia.horario);
            }
            
            // üîß CORRECCI√ìN: Mostrar horario correctamente (no mezclar con horas)
            const horario = coincidencia?.horario || '';
            
            return {
                etiqueta: coincidencia?.nombre || nombre,
                color: coincidencia?.color || paletaFallback[lower] || 'rgba(148,163,184,0.25)',
                horario: horario,
                horas: horas
            };
        }

        function calcularResumenTurnosPDF(turnos, empleadoId) {
            const limpio = Array.isArray(turnos) ? turnos : [];
            const trabajados = limpio.filter(t => t?.turno && !['descanso','libre','baja','vacaciones','festivo'].includes(t.turno)).length;
            const descansos = limpio.filter(t => t?.turno && ['descanso','libre'].includes(t.turno)).length;
            const vacaciones = limpio.filter(t => t?.turno === 'vacaciones').length;
            const noches = limpio.filter(t => t?.turno === 'noche').length;
            const guardias = limpio.filter(t => {
                if (!t?.fecha) return false;
                const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                const esDomingo = fecha.getDay() === 0;
                const esFestivoTrabajado = typeof window.esFestivoLocal === 'function'
                    ? window.esFestivoLocal(fecha, empleadoId)
                    : (typeof window.esFestivo === 'function' ? window.esFestivo(fecha) : false);
                const esGuardiaMarcada = lowerCaseSafe(t?.turno).includes('guardia');
                const turnoTrabajado = t.turno && !['descanso','libre','baja','vacaciones','festivo'].includes(t.turno);
                return (esDomingo && turnoTrabajado) || (esFestivoTrabajado && turnoTrabajado) || esGuardiaMarcada;
            }).length;
            return { trabajados, descansos, vacaciones, noches, guardias };
        }

        function construirCalendarioVisualPDF({ turnos, mesNum, anio, empleadoId, tiposTurnoData }) {
            const diasSemana = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];
            const diasEnMes = new Date(anio, mesNum + 1, 0).getDate();
            const primerDia = new Date(anio, mesNum, 1).getDay();
            const offset = (primerDia + 6) % 7;
            const totalCeldas = Math.ceil((offset + diasEnMes) / 7) * 7;
            const mapaTurnos = new Map();
            (turnos || []).forEach(t => {
                if (!t) return;
                const fecha = t.fecha instanceof Date ? t.fecha : (t.fecha ? new Date(t.fecha) : new Date(anio, mesNum, t.dia || 1));
                const dia = t.dia || fecha.getDate();
                mapaTurnos.set(dia, { ...t, fecha });
            });

            const celdas = [];
            for (let i = 0; i < totalCeldas; i++) {
                const dia = i - offset + 1;
                if (dia < 1 || dia > diasEnMes) {
                    celdas.push('<div style="aspect-ratio:1; border-radius:18px; background:rgba(15,23,42,0.35);"></div>');
                    continue;
                }
                const turnoDia = mapaTurnos.get(dia);
                const fechaRepr = new Date(anio, mesNum, dia);
                const esDomingo = fechaRepr.getDay() === 0;
                const esFestivo = typeof window.esFestivoLocal === 'function'
                    ? window.esFestivoLocal(fechaRepr, empleadoId)
                    : (typeof window.esFestivo === 'function' ? window.esFestivo(fechaRepr) : false);
                const turnoNormalizado = lowerCaseSafe(turnoDia?.turno);
                const esGuardia = esDomingo || esFestivo || turnoNormalizado.includes('guardia');
                const infoTurno = obtenerInfoTurnoVisualPDF(turnoDia?.turno, tiposTurnoData);
                
                // üîß MEJORADO: Priorizar datos del turno individual si est√°n disponibles
                const horario = turnoDia?.horario || infoTurno.horario || '';
                const horasDelTurno = turnoDia?.horas || infoTurno.horas || '';
                const horas = horasDelTurno ? `${horasDelTurno}h` : '';
                
                const badgeTextColor = turnoDia ? '#0f172a' : '#cbd5f5';
                const guardiaBadge = esGuardia ? '<span style="padding:4px 10px; border-radius:999px; background:rgba(248,113,113,0.2); color:#fecaca; font-size:11px; font-weight:600; text-transform:uppercase;">Guardia</span>' : '';
                const contexto = esFestivo ? 'Festivo' : (esDomingo ? 'Domingo' : '');
                const contextoHtml = contexto ? `<span style="font-size:11px; color:#94a3b8;">${contexto}</span>` : '';
                celdas.push(`
                    <div style="aspect-ratio:1; border-radius:20px; background:rgba(15,23,42,0.92); padding:16px; border:${esGuardia ? '2px solid rgba(248,113,113,0.9)' : '1px solid rgba(148,163,184,0.25)'}; box-shadow:${esGuardia ? '0 12px 25px rgba(248,113,113,0.25)' : 'inset 0 0 0 rgba(0,0,0,0)'}; display:flex; flex-direction:column; gap:10px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-size:26px; font-weight:700; color:#f8fafc;">${dia}</span>
                            ${guardiaBadge}
                        </div>
                        <div>
                            <span style="display:inline-block; padding:6px 14px; border-radius:999px; background:${infoTurno.color}; color:${badgeTextColor}; font-weight:600; font-size:13px;">${infoTurno.etiqueta}</span>
                            <div style="font-size:12px; color:#cbd5f5; margin-top:6px;">
                                ${horas ? `${horas}${horario ? ' ¬∑ ' : ''}` : ''}${horario}
                            </div>
                            ${contextoHtml}
                        </div>
                    </div>
                `);
            }

            return `
                <div style="margin-top:10px;">
                    <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:12px; margin-bottom:12px;">
                        ${diasSemana.map(d => `<div style="text-align:center; font-size:12px; letter-spacing:0.1em; text-transform:uppercase; color:#94a3b8;">${d}</div>`).join('')}
                    </div>
                    <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:12px;">
                        ${celdas.join('')}
                    </div>
                </div>
            `;
        }

        function crearTarjetaInfoPDF(titulo, valor, detalle, background) {
            return `
                <div style="border-radius:24px; padding:18px 20px; background:${background}; display:flex; flex-direction:column; gap:6px;">
                    <span style="font-size:12px; text-transform:uppercase; letter-spacing:0.12em; color:rgba(255,255,255,0.75);">${titulo}</span>
                    <span style="font-size:26px; font-weight:700; color:#fff;">${valor}</span>
                    ${detalle ? `<span style="font-size:13px; color:rgba(255,255,255,0.85);">${detalle}</span>` : ''}
                </div>
            `;
        }

        async function generarPDFCuadranteVisual(informe) {
            try {
                console.log('üîµ [generarPDFCuadranteVisual] Iniciando con informe:', informe);
                const { empleado, turnos, mes, anio, mesNum, totalHoras } = informe || {};
                if (!empleado) throw new Error('No hay empleado para generar el PDF');
                console.log('‚úÖ [generarPDFCuadranteVisual] Empleado:', empleado.nombre);
            const tiposTurnoData = JSON.parse(localStorage.getItem('tiposTurnoData') || '{}');
            const resumen = calcularResumenTurnosPDF(turnos || [], empleado.id);
            const horasContrato = parseFloat(empleado.horasContrato) || 0;
            const balance = (totalHoras || 0) - horasContrato;
            const cumplimiento = horasContrato > 0 ? Math.round(((totalHoras || 0) / horasContrato) * 100) : 0;

            const wrapper = document.createElement('div');
            wrapper.style.position = 'fixed';
            wrapper.style.left = '-9999px';
            wrapper.style.top = '0';
            wrapper.style.zIndex = '-1';

            const content = document.createElement('div');
            content.style.width = '1400px';
            content.style.padding = '48px';
            content.style.background = 'linear-gradient(135deg, #0b1220, #111827)';
            content.style.borderRadius = '32px';
            content.style.boxShadow = '0 40px 80px rgba(0,0,0,0.55)';
            content.style.fontFamily = "'Poppins','Segoe UI',sans-serif";
            content.style.color = '#f8fafc';

            const tarjetas = [
                crearTarjetaInfoPDF('Empleado', empleado.nombre, empleado.departamento || 'Sin depto', 'linear-gradient(135deg,#6366f1,#8b5cf6)'),
                crearTarjetaInfoPDF('Localidad', empleado.localidad || 'N/D', empleado.turnoPrincipal || 'Sin turno', 'linear-gradient(135deg,#0ea5e9,#38bdf8)'),
                crearTarjetaInfoPDF('Horas trabajadas', `${(totalHoras || 0).toFixed(2)}h`, `Contrato: ${horasContrato}h`, 'linear-gradient(135deg,#22c55e,#4ade80)'),
                crearTarjetaInfoPDF('Balance', `${balance >= 0 ? '+' : ''}${balance.toFixed(2)}h`, `Cumplimiento ${cumplimiento}%`, 'linear-gradient(135deg,#f97316,#fb923c)')
            ].join('');

            const calendarioHTML = construirCalendarioVisualPDF({
                turnos: turnos || [],
                mesNum,
                anio,
                empleadoId: empleado.id,
                tiposTurnoData
            });

            content.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:24px;">
                    <div>
                        <p style="margin:0; font-size:14px; letter-spacing:0.4em; color:#94a3b8; text-transform:uppercase;">Cuadrante mensual</p>
                        <h1 style="margin:6px 0 0 0; font-size:38px; background:linear-gradient(135deg, #1e3a8a, #3b82f6); padding:12px 20px; border-radius:8px; display:inline-block; color:#fff;">${mes} ${anio}</h1>
                        <p style="margin:8px 0 0 0; color:#cbd5f5;">${empleado.nombre} ¬∑ ${empleado.departamento || 'Sin departamento'}</p>
                    </div>
                    <div style="text-align:right;">
                        <span style="font-size:14px; color:#94a3b8;">Generado ${new Date().toLocaleDateString('es-ES')}</span>
                        <div style="font-size:32px; font-weight:700;">${resumen.trabajados} d√≠as activos</div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:18px; margin:32px 0;">
                    ${tarjetas}
                </div>
                <div style="background:rgba(15,23,42,0.8); border-radius:28px; padding:28px; border:1px solid rgba(148,163,184,0.25);">
                    ${calendarioHTML}
                </div>
                <div style="display:flex; flex-wrap:wrap; gap:16px; margin-top:28px;">
                    <div style="padding:14px 18px; border-radius:18px; background:rgba(34,197,94,0.12); border:1px solid rgba(34,197,94,0.4);">Descansos: <strong>${resumen.descansos}</strong></div>
                    <div style="padding:14px 18px; border-radius:18px; background:rgba(248,113,113,0.12); border:1px solid rgba(248,113,113,0.4);">Guardias: <strong>${resumen.guardias}</strong></div>
                    <div style="padding:14px 18px; border-radius:18px; background:rgba(59,130,246,0.12); border:1px solid rgba(59,130,246,0.4);">Noches: <strong>${resumen.noches}</strong></div>
                    <div style="padding:14px 18px; border-radius:18px; background:rgba(251,191,36,0.12); border:1px solid rgba(251,191,36,0.4);">Vacaciones/Bajas: <strong>${resumen.vacaciones}</strong></div>
                </div>
            `;

            wrapper.appendChild(content);
            document.body.appendChild(wrapper);

            // Clonar el contenido para remover el bot√≥n WhatsApp del PDF
            const contentForPDF = content.cloneNode(true);
            const btnWhatsAppEnPDF = contentForPDF.querySelector('.btn-whatsapp-modal');
            if (btnWhatsAppEnPDF) {
                btnWhatsAppEnPDF.remove();
            }

            // Crear un wrapper temporal solo para la captura del PDF
            const wrapperPDF = document.createElement('div');
            wrapperPDF.style.position = 'fixed';
            wrapperPDF.style.left = '-9999px';
            wrapperPDF.style.top = '0';
            wrapperPDF.style.zIndex = '-1';
            wrapperPDF.appendChild(contentForPDF);
            document.body.appendChild(wrapperPDF);

            const canvas = await html2canvas(contentForPDF, {
                backgroundColor: '#0b1220',
                scale: 2,
                useCORS: true,
                logging: false,
                windowHeight: contentForPDF.scrollHeight,
                windowWidth: contentForPDF.scrollWidth,
                allowTaint: true
            });
            console.log('‚úÖ [generarPDFCuadranteVisual] Canvas generado');

            document.body.removeChild(wrapper);
            document.body.removeChild(wrapperPDF);

            const jsPDFConstructor = window.jspdf?.jsPDF || window.jsPDF;
            if (!jsPDFConstructor) {
                throw new Error('La libreria jsPDF no est√° disponible');
            }
            console.log('‚úÖ [generarPDFCuadranteVisual] jsPDF disponible');
            const pdf = new jsPDFConstructor('landscape', 'pt', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            
            // Escalar para que todo quepa en una sola p√°gina
            const scale = Math.min(pageWidth / (canvas.width * 0.75), pageHeight / (canvas.height * 0.75));
            const imgWidth = (canvas.width * scale) * 0.75;
            const imgHeight = (canvas.height * scale) * 0.75;
            const startX = (pageWidth - imgWidth) / 2;
            const startY = (pageHeight - imgHeight) / 2;
            
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', startX, startY, imgWidth, imgHeight);

            const fileName = `Cuadrante_${empleado.nombre.replace(/\s+/g, '_')}_${mes}_${anio}.pdf`;
            const blob = pdf.output('blob');
            const file = new File([blob], fileName, { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            window.ultimoPdfCuadrante = { fileName, url, creado: Date.now() };
            console.log('‚úÖ [generarPDFCuadranteVisual] PDF completado:', fileName);
            return { blob, file, url, fileName };
            } catch (error) {
                console.error('‚ùå [generarPDFCuadranteVisual] Error:', error);
                throw error;
            }
        }

        function exportarEmpleado(empleadoId, mesNombre, anio, tipo) {
            try {
                // üîß GARANTIZAR QUE USAMOS LOS EMPLEADOS ACTUALES (desde localStorage)
                const empleadosActuales = JSON.parse(localStorage.getItem('empleadosData') || '[]');
                const empleado = empleadosActuales.find(e => e.id === empleadoId) || empleados.find(e => e.id === empleadoId);
                
                if (!empleado) {
                    console.error('‚ùå Empleado no encontrado:', empleadoId);
                    alert('Empleado no encontrado');
                    return;
                }
                
                // üîß DEBUG: Verificar que se carg√≥ el empleado correcto
                console.log('‚úÖ Empleado cargado:', {
                    id: empleado.id,
                    nombre: empleado.nombre,
                    horasContrato: empleado.horasContrato
                });
                
                const turnos = AppState.scheduleData.get(empleadoId) || [];
                
                // Calcular horas por d√≠a basadas en el contrato del empleado
                const diasTrabajadosEstimados = 20;
                const horasPorDia = empleado.horasContrato / diasTrabajadosEstimados;
                
                // Calcular total de horas din√°micamente desde los turnos guardados
                const totalHoras = Math.round(turnos.reduce((sum, t) => sum + (t.horas || 0), 0) * 100) / 100;
                
                // Convertir nombre del mes a n√∫mero (robusto contra valores no string)
                const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                                      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const normalizarMes = (valor) => (valor ?? '').toString().trim();
                const mesNormalizado = normalizarMes(mesNombre);
                const mesNum = mesNormalizado ? mesesNombres.findIndex(m => lowerCaseSafe(m) === lowerCaseSafe(mesNormalizado)) : -1;
                const mesActualNum = mesNum >= 0 ? mesNum : AppState.currentMonth;
                const anioActual = parseInt(anio) || AppState.currentYear;
                const mesActualNombre = mesesNombres[mesActualNum];
                
                // Guardar en variable global para las funciones de exportaci√≥n
                window.informeActual = { 
                    empleado, 
                    turnos, 
                    mes: mesActualNombre, 
                    anio: anioActual,
                    mesNum: mesActualNum
                };
                
                console.log('exportarEmpleado - Mes actual:', { mes: mesActualNombre, mesNum: mesActualNum, anio: anioActual });
                
                if (tipo === 'pdf') {
                    descargarInformeIndividualPDF();
                } else if (tipo === 'whatsapp') {
                    console.log('üîµ Llamando a enviarWhatsAppIndividual()...');
                    enviarWhatsAppIndividual().catch(error => {
                        console.error('‚ùå Error en enviarWhatsAppIndividual:', error);
                        alert('Error: ' + error.message);
                    });
                } else if (tipo === 'csv') {
                    descargarInformeIndividualCSV();
                } else if (tipo === 'copy') {
                    copiarAlPortapapelesInforme();
                }
            } catch (error) {
                console.error('Error exportando:', error);
                alert('Error: ' + error.message);
            }
        }

        // Descargar PDF del informe individual
        function descargarInformeIndividualPDF() {
            try {
                if (!window.informeActual) {
                    alert('No hay datos para exportar');
                    return;
                }

                const { empleado, turnos, mes, anio } = window.informeActual;
                const totalHoras = turnos.reduce((sum, dia) => sum + (dia.horas || 0), 0);
                const turnosNoche = turnos.filter(dia => dia.turno === 'noche').length;
                const ausencias = turnos.filter(dia => dia.turno === 'vacaciones' || dia.turno === 'baja').length;
                
                // Crear HTML para el PDF
                // üîß Convertir horasContrato a n√∫mero (por si est√° como string)
                const horasContratoNum = parseFloat(empleado.horasContrato) || 0;
                const totalHorasNum = parseFloat(totalHoras) || 0;
                
                const htmlContent = `
                    <h1 style="text-align: center; color: #2c3e50;">INFORME INDIVIDUAL MENSUAL</h1>
                    <h2 style="text-align: center; color: #7f8c8d;">${mes} ${anio}</h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h3 style="margin-top: 0; color: #2c3e50;">${empleado.nombre}</h3>
                        <p><strong>Departamento:</strong> ${empleado.departamento}</p>
                        <p><strong>Turno Principal:</strong> ${empleado.turnoPrincipal}</p>
                        <p><strong>Horas Contrato:</strong> ${horasContratoNum}h</p>
                        <p><strong>Estado:</strong> ${empleado.estado ? empleado.estado.toUpperCase() : 'N/A'}</p>
                    </div>
                    
                    <p><strong>Horas Trabajadas:</strong> ${totalHorasNum}h</p>
                    <p><strong>Balance:</strong> ${(totalHorasNum - horasContratoNum).toFixed(2)}h</p>
                    <p><strong>Cumplimiento:</strong> ${horasContratoNum > 0 ? Math.round((totalHorasNum / horasContratoNum) * 100) : 0}%</p>
                `;
                
                const ventana = window.open('', '_blank');
                ventana.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{font-family:Arial;}</style></head><body>${htmlContent}</body></html>`);
                ventana.document.close();
                ventana.print();
                
                if (typeof NotificationSystem !== 'undefined') {
                    NotificationSystem.show('Abriendo PDF para imprimir', 'info');
                }
            } catch (error) {
                console.error('Error PDF:', error);
                alert('Error: ' + error.message);
            }
        }

        // Descargar CSV del informe individual
        function descargarInformeIndividualCSV() {
            try {
                if (!window.informeActual) {
                    alert('No hay datos para exportar');
                    return;
                }
                const { empleado, turnos, mes, anio, mesNum } = window.informeActual;
                
                let csv = 'data:text/csv;charset=utf-8,';
                csv += `Empleado,${empleado.nombre}\n`;
                csv += `Departamento,${empleado.departamento}\n`;
                csv += `Turno Principal,${empleado.turnoPrincipal}\n`;
                csv += `Mes,${mes}\n`;
                csv += `A√±o,${anio}\n\n`;
                csv += `D√≠a,Turno,Horas,Fecha\n`;
                
                turnos.forEach(turno => {
                    const fecha = turno.fecha.toLocaleDateString('es-ES');
                    csv += `${turno.dia},${turno.turno},${turno.horas},${fecha}\n`;
                });
                
                const enlace = document.createElement('a');
                enlace.href = encodeURI(csv);
                enlace.download = `informe_${empleado.nombre}_${mesNum + 1}_${anio}.csv`;
                enlace.click();
                
                if (typeof NotificationSystem !== 'undefined') {
                    NotificationSystem.show('CSV descargado correctamente', 'success');
                }
            } catch (error) {
                console.error('Error CSV:', error);
                alert('Error: ' + error.message);
            }
        }

        // Enviar por WhatsApp (PDF + mensaje)
        async function enviarWhatsAppIndividual() {
            try {
                console.log('üîµ [enviarWhatsAppIndividual] Iniciando...');
                const cuadranteIndividual = document.getElementById('cuadranteIndividual');
                if (!cuadranteIndividual || cuadranteIndividual.style.display === 'none') {
                    alert('Error: El cuadrante individual no est√° abierto');
                    return;
                }
                console.log('‚úÖ [enviarWhatsAppIndividual] Cuadrante individual encontrado');

                const btnWhatsAppOriginal = cuadranteIndividual.querySelector('.btn-whatsapp-modal');
                const onclickAttr = btnWhatsAppOriginal?.getAttribute('onclick') || '';
                let matchParams = onclickAttr.match(/exportarEmpleado\((\d+)\s*,\s*['"]([^'"\)]+)['"]\s*,\s*(\d+)/);

                const titleEl = cuadranteIndividual.querySelector('h3');
                let mesNombre = '';
                let anio = 0;

                if (matchParams) {
                    mesNombre = matchParams[2];
                    anio = parseInt(matchParams[3]);
                } else {
                    const titulo = titleEl?.textContent || '';
                    const mesesNombresRaw = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
                    const encontrado = mesesNombresRaw.find(m => titulo.includes(m));
                    if (!encontrado) {
                        alert('Error: No se puede identificar el mes');
                        return;
                    }
                    mesNombre = encontrado;
                    const matchYear = titulo.match(/(20\d{2})/);
                    anio = matchYear ? parseInt(matchYear[1]) : AppState.currentYear;
                    const matchEmp = onclickAttr.match(/exportarEmpleado\((\d+)/);
                    if (matchEmp) {
                        matchParams = matchEmp;
                    }
                }

                if (!matchParams) {
                    alert('Error: No se pudo identificar el empleado');
                    return;
                }

                const empleadoId = parseInt(matchParams[1]);
                // Usar variable global sincronizada (no localStorage que puede estar corrupto)
                const empleado = empleados.find(e => e.id === empleadoId);
                if (!empleado) {
                    alert('Error: Empleado no encontrado');
                    return;
                }

                const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const normalizarMes = (valor) => (valor ?? '').toString().trim();
                mesNombre = normalizarMes(mesNombre);
                let mesNum = mesNombre ? mesesNombres.findIndex(m => lowerCaseSafe(m) === lowerCaseSafe(mesNombre)) : -1;
                let anioSeleccionado = anio || AppState.currentYear;
                const informeActual = (window.informeActual && window.informeActual.empleado) ? window.informeActual : null;

                if (mesNum === -1 && informeActual?.mes) {
                    const mesInf = normalizarMes(informeActual.mes);
                    const idx = mesInf ? mesesNombres.findIndex(m => lowerCaseSafe(m) === lowerCaseSafe(mesInf)) : -1;
                    if (idx !== -1) {
                        mesNum = idx;
                        mesNombre = mesInf;
                    }
                }

                if (Number.isFinite(informeActual?.anio)) {
                    anioSeleccionado = informeActual.anio;
                }

                if (mesNum === -1) {
                    alert('Error: No se puede identificar el mes del cuadrante');
                    return;
                }

                // üîß IMPORTANTE: Siempre obtener turnos frescos del AppState para evitar cache stale
                let turnosDelMes;
                const turnosDelAppState = AppState.scheduleData.get(empleadoId) || [];
                
                // Filtrar SIEMPRE desde AppState, nunca confiar en informeActual cacheado
                turnosDelMes = turnosDelAppState.filter(t => {
                    if (!t?.fecha) return false;
                    const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                    return fecha.getMonth() === mesNum && fecha.getFullYear() === anioSeleccionado;
                });
                
                // Calcular totalHoras SIEMPRE desde los turnos filtrados
                const totalHoras = Math.round(turnosDelMes.reduce((sum, t) => sum + (t?.horas || 0), 0) * 100) / 100;
                
                console.log(`üîµ [enviarWhatsAppIndividual] Turnos del empleado ${empleadoId}: ${turnosDelAppState.length} total, ${turnosDelMes.length} del mes ${mesNum + 1}/${anioSeleccionado}, Total horas: ${totalHoras}h`);

                const horasContrato = parseFloat(empleado.horasContrato) || 0;
                const balance = totalHoras - horasContrato;
                const cumplimiento = horasContrato > 0 ? Math.round((totalHoras / horasContrato) * 100) : 0;

                const pdfBundle = await generarPDFCuadranteVisual({
                    empleado,
                    turnos: turnosDelMes,
                    mes: mesNombre,
                    anio: anioSeleccionado,
                    mesNum,
                    totalHoras
                });

                let mensaje = `üìã *CUADRANTE MENSUAL*\n\n`;
                mensaje += `*${empleado.nombre}*\n`;
                mensaje += `\n*üìä Resumen ${mesNombre} ${anioSeleccionado}:*\n`;
                mensaje += `‚Ä¢ Horas Trabajadas: ${totalHoras}h\n`;
                mensaje += `‚Ä¢ Balance: ${balance >= 0 ? '+' : ''}${balance.toFixed(2)}h\n`;
                mensaje += `‚Ä¢ Cumplimiento: ${cumplimiento}%\n`;
                mensaje += `‚Ä¢ Contrato: ${horasContrato}h mensuales\n\n`;
                mensaje += `üìé Te adjunto el PDF con el calendario completo y todos los turnos.`;

                const numeroWhatsApp = empleado.telefono ? empleado.telefono.replace(/\D/g, '') : '';
                if (!numeroWhatsApp) {
                    URL.revokeObjectURL(pdfBundle.url);
                    alert('‚ùå El empleado no tiene n√∫mero de tel√©fono registrado');
                    return;
                }

                // üîÑ Estrategia simplificada: descargar PDF + abrir WhatsApp Web
                console.log('üì• Descargando PDF:', pdfBundle.fileName);
                const linkPdf = document.createElement('a');
                linkPdf.href = pdfBundle.url;
                linkPdf.download = pdfBundle.fileName;
                document.body.appendChild(linkPdf);
                linkPdf.click();
                document.body.removeChild(linkPdf);
                console.log('‚úÖ PDF descargado, abriendo WhatsApp en 1 segundo...');

                if (typeof NotificationSystem !== 'undefined') {
                    NotificationSystem.show('üì• PDF descargado ‚Ä¢ üì± Abriendo WhatsApp...', 'info', 5000);
                }

                // Esperar a que el PDF se descargue completamente antes de abrir WhatsApp
                setTimeout(() => {
                    console.log('üü¢ Abriendo WhatsApp App con mensaje...');
                    const urlWhatsApp = `whatsapp://send?phone=${numeroWhatsApp}&text=${encodeURIComponent(mensaje)}`;
                    console.log('üîó URL WhatsApp App:', urlWhatsApp.substring(0, 50) + '...');
                    window.location.href = urlWhatsApp;
                }, 1000);

                setTimeout(() => {
                    URL.revokeObjectURL(pdfBundle.url);
                }, 15000);

            } catch (error) {
                console.error('‚ùå [enviarWhatsAppIndividual] Error:', error);
                console.error('Stack:', error.stack);
                alert('Error en WhatsApp: ' + error.message);
            }
        }

        // Copiar al portapapeles
        function copiarAlPortapapelesInforme() {
            try {
                if (!window.informeActual) {
                    alert('No hay datos para exportar');
                    return;
                }
                const { empleado, turnos, mes, anio } = window.informeActual;
                
                let mensaje = `üìã Cuadrante de Turnos\n`;
                mensaje += `Empleado: ${empleado.nombre}\n`;
                mensaje += `Mes: ${mes} ${anio}\n`;
                mensaje += `Horas: ${turnos.reduce((sum, t) => sum + (t.horas || 0), 0)}h\n\n`;
                
                turnos.forEach(turno => {
                    const fecha = turno.fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                    mensaje += `${fecha}: ${turno.turno} (${turno.horas}h)\n`;
                });
                
                navigator.clipboard.writeText(mensaje);
                if (typeof NotificationSystem !== 'undefined') {
                    NotificationSystem.show('Copiado al portapapeles', 'success');
                }
            } catch (error) {
                console.error('Error portapapeles:', error);
                alert('Error: ' + error.message);
            }
        }

        // Funciones de exportaci√≥n removidas - El informe simplificado solo muestra filtros
        // Las opciones de exportaci√≥n se pueden gestionar desde el cuadrante general

    </script>

    <!-- SCRIPT FINAL DE INICIALIZACI√ìN -->
    <script>
        setTimeout(() => {
        }, 100);
    </script>

    <!-- Script de inicializaci√≥n final -->
    <script>
        // Sistema de detecci√≥n de conexi√≥n del servidor
        let tiempoIntento = 0;
        let intervaloDeteccion = null;
        
        window.verificarConexionServidor = async function() {
            return new Promise((resolve) => {
                const img = new Image();
                const timeout = setTimeout(() => {
                    resolve(false);
                }, 3000);
                
                img.onload = () => {
                    clearTimeout(timeout);
                    console.log('‚úÖ Servidor disponible');
                    resolve(true);
                };
                
                img.onerror = () => {
                    clearTimeout(timeout);
                    console.log('‚ùå Servidor no disponible');
                    resolve(false);
                };
                
                // Usar un recurso que siempre existe en el servidor
                img.src = 'http://localhost:8000/nuevo_cuadrante_mejorado.html?t=' + Date.now();
            });
        }
        
        // üåê CARGAR FESTIVOS DESDE INTERNET (API date.nager.at) CON FILTRO OFICIAL
        async function cargarFestivosDesdeInternet(a√±o) {
            try {
                console.log(`üì° Cargando festivos de Espa√±a para ${a√±o} desde date.nager.at...`);
                const response = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${a√±o}/ES`, {
                    timeout: 5000
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const festivos = await response.json();
                const festivosConvertidos = festivos
                    .map(f => ({
                        mes: new Date(f.date).getMonth(),
                        dia: new Date(f.date).getDate(),
                        nombre: f.localName || f.name,
                        tipo: f.type || 'Public'
                    }))
                    // üîç FILTRAR: Solo d√≠as que est√°n en la lista oficial de Espa√±a
                    .filter(f => {
                        const diasOficiales = FESTIVOS_NACIONALES_OFICIALES_ESPA√ëA[f.mes];
                        if (!diasOficiales) return false;
                        return diasOficiales.includes(f.dia);
                    });
                
                console.log(`‚úÖ ${festivosConvertidos.length} festivos cargados desde Internet (filtrados oficialmente)`);
                return festivosConvertidos;
            } catch (error) {
                console.warn(`‚ö†Ô∏è No se pudo cargar festivos de Internet: ${error.message}`);
                return null;
            }
        }
        
        // üîÑ INICIALIZAR FESTIVOS (siempre intenta Internet; cach√© solo como respaldo)
        async function inicializarFestivos() {
            const a√±o = new Date().getFullYear();
            const cacheKey = `festivos_cache_${a√±o}`;
            const timestampKey = `festivos_timestamp_${a√±o}`;

            const aplicarFestivos = (lista, origen = 'cache') => {
                if (!lista || !Array.isArray(lista)) return false;
                const festivosValidados = lista.filter(f => !(f.mes === 11 && f.dia === 26));
                CALENDARIO_FESTIVOS_2025.nacionales = festivosValidados;
                console.log(`‚úÖ Festivos cargados desde ${origen} (${festivosValidados.length})`);
                return true;
            };

            const cachedData = localStorage.getItem(cacheKey);
            if (cachedData && aplicarFestivos(JSON.parse(cachedData), 'cache')) {
                // Continuar para refrescar desde Internet, sin retornar
            }

            const festivosInternet = await cargarFestivosDesdeInternet(a√±o);
            if (festivosInternet && festivosInternet.length > 0) {
                aplicarFestivos(festivosInternet, 'internet');
                localStorage.setItem(cacheKey, JSON.stringify(festivosInternet));
                localStorage.setItem(timestampKey, Date.now().toString());
                console.log('üíæ Cach√© de festivos actualizado');
                return;
            }

            if (!cachedData) {
                console.warn('‚ùå No se pudieron cargar festivos desde Internet ni existe cach√©');
            }
        }
        
        // MODAL COMPLETAMENTE ELIMINADO
        // El servidor se verifica en el launcher (Python) ANTES de abrir el navegador
        // por lo que este modal ya no es necesario
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // ‚ö†Ô∏è VERIFICAR SI SE EST√Å USANDO file:// (sin servidor)
                if (window.location.protocol === 'file:') {
                    console.warn('‚ùå ADVERTENCIA: Abierto como archivo local. localhost NO funcionar√°. Usa http://localhost:8000');
                    // Si es file://, esperar a que el usuario abra en http://localhost
                    return;
                }
                
                // Si llegamos aqu√≠, estamos en http://localhost, el servidor DEFINITIVAMENTE est√° disponible
                
                console.log('üü¢ INIT: Iniciando carga de datos...');;
                
                // PASO 0: Cargar festivos desde Internet (o cach√© si no hay conexi√≥n)
                console.log('üìÖ Paso 0: Cargando festivos...');
                await inicializarFestivos();
                
                // PASO 1: Guardar tipos de turnos predeterminados en localStorage
                if (typeof TurnoTypeManager !== 'undefined' && typeof tiposTurno !== 'undefined') {
                    const tiposTurnoExistente = localStorage.getItem('tiposTurnoData');
                    if (!tiposTurnoExistente) {
                        TurnoTypeManager.guardarEnStorage();
                        console.log('‚úì Tipos de turnos iniciales guardados');
                    } else {
                        console.log('‚úì Tipos de turnos ya existen en localStorage');
                    }
                }
                
                // PASO 2: Cargar empleados desde storage
                if (typeof EmployeeManager !== 'undefined') {
                    EmployeeManager.cargarDelStorage();
                    console.log('‚úì Empleados cargados:', empleados.length);
                }
                
                // PASO 3: Cargar tipos de turnos desde storage
                if (typeof TurnoTypeManager !== 'undefined') {
                    TurnoTypeManager.cargarDelStorage();
                    console.log('‚úì Tipos de turnos cargados');
                }
                
                // PASO 4: Cargar estado anterior (AppState - solo turnos, NO mes/a√±o)
                if (typeof AppState !== 'undefined') {
                    AppState.loadFromStorage();
                    console.log('‚úì AppState cargado - Turnos guardados:', AppState.scheduleData.size);
                }
                
                // PASO 5: SIEMPRE usar el mes y a√±o ACTUAL (sin parpadeos)
                const ahora = new Date();
                const mesActual = ahora.getMonth();
                const anioActual = ahora.getFullYear();
                
                if (typeof AppState !== 'undefined') {
                    AppState.currentMonth = mesActual;
                    AppState.currentYear = anioActual;
                    console.log('‚úì Iniciando en mes ACTUAL:', mesActual, '/', anioActual);
                }
                
                // PASO 6: Inicializar datos (genera turnos solo si no existen)
                if (typeof TurnoManager !== 'undefined') {
                    TurnoManager.inicializarDatos();
                    console.log('‚úì Turnos inicializados/cargados');
                }
                
                // PASO 7: Actualizar selectores de mes y a√±o INMEDIATAMENTE (evita parpadeos)
                const selectYear = document.getElementById('selectYear');
                const selectMonth = document.getElementById('selectMonth');
                
                if (selectMonth) {
                    selectMonth.value = window.__initialMonth;
                }
                
                if (selectYear) {
                    selectYear.value = window.__initialYear;
                }
                
                // PASO 8: Generar cuadrante general
                if (typeof UI !== 'undefined') {
                    UI.generarCuadranteGeneral();
                    UI.actualizarTitulosMes();
                    console.log('‚úì Cuadrante general generado');
                }
                
                // Inicializar y llenar filtros del cuadrante general
                const filtroDepartamentoGeneral = document.getElementById('filtroDepartamentoGeneral');
                const filtroEstadoGeneral = document.getElementById('filtroEstadoGeneral');
                
                if (filtroDepartamentoGeneral) {
                    // Obtener departamentos √∫nicos
                    const departamentos = [...new Set(empleados.map(e => e.departamento))].sort();
                    departamentos.forEach(depto => {
                        const option = document.createElement('option');
                        option.value = depto;
                        option.textContent = depto;
                        filtroDepartamentoGeneral.appendChild(option);
                    });
                    
                    // Agregar event listener para filtrar
                    filtroDepartamentoGeneral.addEventListener('change', () => {
                        if (typeof UI !== 'undefined') {
                            UI.generarCuadranteGeneral();
                        }
                    });
                }
                
                if (filtroEstadoGeneral) {
                    // Obtener estados √∫nicos
                    const estados = [...new Set(empleados.map(e => e.estado))].sort();
                    estados.forEach(estado => {
                        const option = document.createElement('option');
                        option.value = estado;
                        option.textContent = estado.charAt(0).toUpperCase() + estado.slice(1);
                        filtroEstadoGeneral.appendChild(option);
                    });
                    
                    // Agregar event listener para filtrar
                    filtroEstadoGeneral.addEventListener('change', () => {
                        if (typeof UI !== 'undefined') {
                            UI.generarCuadranteGeneral();
                        }
                    });
                }
                
                // Llenar opciones de centros de trabajo en el filtro
                if (typeof llenarCentrosDeTrabajo !== 'undefined') {
                    llenarCentrosDeTrabajo();
                    
                    // Establecer mes y a√±o actual por defecto en informe individual
                    document.getElementById('selectMesIndividual').value = mesActual;
                    document.getElementById('selectAnioIndividual').value = anioActual;
                }
                
                // Llenar opciones de departamentos en el filtro
                const selectDepartamentoIndividual = document.getElementById('selectDepartamentoIndividual');
                if (selectDepartamentoIndividual && typeof DepartmentManager !== 'undefined') {
                    const departamentos = [...new Set(DepartmentManager.departamentos.map(d => d.nombre))].sort();
                    departamentos.forEach(depto => {
                        const option = document.createElement('option');
                        option.value = depto;
                        option.textContent = depto;
                        selectDepartamentoIndividual.appendChild(option);
                    });
                }
                
                // üîß Agregar event listeners para cambiar mes/a√±o desde los selectores
                if (selectYear) {
                    selectYear.addEventListener('change', () => {
                        const nuevoA√±o = parseInt(selectYear.value);
                        if (nuevoA√±o !== AppState.currentYear) {
                            AppState.setYear(nuevoA√±o);
                            TurnoManager.reiniciarDatos();
                            UI.generarCuadranteGeneral();
                            UI.actualizarTitulosMes();
                        }
                    });
                }
                
                if (selectMonth) {
                    selectMonth.addEventListener('change', () => {
                        const nuevoMes = parseInt(selectMonth.value);
                        if (nuevoMes !== AppState.currentMonth) {
                            AppState.setMonth(nuevoMes);
                            TurnoManager.reiniciarDatos();
                            UI.generarCuadranteGeneral();
                            UI.actualizarTitulosMes();
                        }
                    });
                }
                
                // Mostrar mensaje de bienvenida
                if (typeof NotificationSystem !== 'undefined') {
                    NotificationSystem.show('¬°Bienvenido! Aplicaci√≥n cargada correctamente', 'info', 3000);
                }
                
                // üîç MONITOR CONTINUO DE CONEXI√ìN
                // DESHABILITADO: Ya no es necesario con el launcher que verifica antes de abrir
                // Verifica cada 5 segundos si el servidor sigue disponible
                // Si cae, muestra el modal de reconexi√≥n autom√°ticamente
                // setInterval(async () => {
                //     try {
                //         const conectado = await verificarConexionServidor();
                //         if (!conectado && !document.getElementById('modalReconexion')) {
                //             console.warn('‚ö†Ô∏è CONEXI√ìN PERDIDA - Mostrando modal de reconexi√≥n autom√°tica');
                //             mostrarModalReconexion();
                //         }
                //     } catch (err) {
                //         console.error('Error verificando conexi√≥n:', err);
                //     }
                // }, 5000);
                
                console.log('‚úÖ Aplicaci√≥n cargada correctamente');
            } catch (error) {
                console.error('Error en inicializaci√≥n:', error);
            }
        });
    </script>

    <!-- Fallback INMEDIATO: Crear objetos base antes que todo para evitar undefined -->
    <script>
        // Esto se ejecuta ANTES que los m√≥dulos, proporciona fallbacks
        
        // üîß D√çAS FESTIVOS ESPA√ëOLES - Para detectar autom√°ticamente guardias
        // üîß CONFIGURACI√ìN FESTIVOS ESPA√ëA + MADRID + GETAFE
        // üìÖ CALENDARIO GENERAL - FESTIVOS DESDE INTERNET + CACH√â LOCAL
        // ‚ö†Ô∏è RANGO DE MESES: 0-11 (como JavaScript getMonth())
        // enero=0, febrero=1, ..., diciembre=11
        // Se carga desde API p√∫blica (date.nager.at) al iniciar
        
        // ‚úÖ LISTA OFICIAL DE FESTIVOS NACIONALES ESPA√ëA (validados)
        // Solo estos d√≠as son considerados festivos nacionales
        const FESTIVOS_NACIONALES_OFICIALES_ESPA√ëA = {
            0: [1, 6],           // Enero: A√±o Nuevo (1), Reyes (6)
            3: [1],              // Abril: Jueves Santo (aprox. 1)
            4: [1],              // Mayo: D√≠a del Trabajo (1)
            7: [15],             // Agosto: Asunci√≥n (15)
            9: [12],             // Octubre: Hispanidad (12)
            10: [1],             // Noviembre: Todos los Santos (1)
            11: [6, 8, 25]       // Diciembre: Constituci√≥n (6), Inmaculada (8), Navidad (25)
        };
        
        const CALENDARIO_FESTIVOS_2025 = {
            // FESTIVOS NACIONALES - Se cargan desde Internet al iniciar (default es fallback)
            nacionales: [
                { mes: 0, dia: 1, nombre: 'A√±o Nuevo' },
                { mes: 0, dia: 6, nombre: 'Reyes Magos' },
                { mes: 3, dia: 1, nombre: 'Jueves Santo' },  // Aproximado
                { mes: 4, dia: 1, nombre: 'D√≠a del Trabajo' },
                { mes: 7, dia: 15, nombre: 'Asunci√≥n' },
                { mes: 9, dia: 12, nombre: 'Hispanidad' },
                { mes: 10, dia: 1, nombre: 'Todos los Santos' },
                { mes: 11, dia: 6, nombre: 'Constituci√≥n' },
                { mes: 11, dia: 8, nombre: 'Inmaculada Concepci√≥n' },
                { mes: 11, dia: 25, nombre: 'Navidad' }
            ],
            
            // FESTIVOS LOCALES POR LOCALIDAD
            localidades: {
                'Getafe': [
                    { mes: 4, dia: 30, nombre: 'San Fernando (Patr√≥n de Getafe)' },
                    { mes: 6, dia: 25, nombre: 'Santiago Ap√≥stol' }
                ],
                'Madrid': [
                    { mes: 4, dia: 2, nombre: 'Fiesta de Madrid' }
                ],
                'Legan√©s': [
                    { mes: 10, dia: 12, nombre: 'San Froil√°n' }
                ],
                'Fuenlabrada': [
                    { mes: 9, dia: 7, nombre: 'Virgen del Rosario' }
                ],
                'M√≥stoles': [
                    { mes: 10, dia: 25, nombre: 'Cristo de la Vega' }
                ]
            }
        };
        
        // üîç FUNCI√ìN CENTRAL: Obtener todos los festivos para una localidad
        function obtenerFestivosLocalidad(localidad) {
            if (!localidad || !CALENDARIO_FESTIVOS_2025.localidades[localidad]) {
                return CALENDARIO_FESTIVOS_2025.nacionales;
            }
            return [
                ...CALENDARIO_FESTIVOS_2025.nacionales,
                ...CALENDARIO_FESTIVOS_2025.localidades[localidad]
            ];
        }
        
        // üîç FUNCI√ìN CENTRAL: Verificar si una fecha es festivo para una localidad
        function esFestivoBuscado(fecha, localidad) {
            if (!fecha) return false;
            const d = fecha instanceof Date ? fecha : new Date(fecha);
            const festivos = obtenerFestivosLocalidad(localidad);
            return festivos.some(f => f.mes === d.getMonth() && f.dia === d.getDate());
        }
        
        // Variable global para seleccionar localidad (por defecto: Getafe)
        if (!window.localidadFestivos) {
            window.localidadFestivos = 'Getafe';
        }
        
        // Combinar festivos seg√∫n localidad (para compatibilidad hacia atr√°s)
        const obtenerDiasFestivos = () => obtenerFestivosLocalidad(window.localidadFestivos);

        
        const DIAS_FESTIVOS_ES = obtenerDiasFestivos();
        
        // üîß FUNCI√ìN AUXILIAR: Detectar si una fecha es festiva
        function esFestivo(fecha) {
            if (!fecha) return false;
            const d = fecha instanceof Date ? fecha : new Date(fecha);
            const festivos = obtenerDiasFestivos();
            return festivos.some(f => f.mes === d.getMonth() && f.dia === d.getDate());
        }

        // üîß NUEVA FUNCI√ìN: Obtener festivos espec√≠ficos de un empleado por su localidad
        function obtenerFestivosEmpleado(empleadoId) {
            const empleado = empleados?.find(e => e.id === empleadoId);
            if (!empleado || !empleado.localidad) {
                return obtenerFestivosLocalidad('Getafe'); // Default a Getafe
            }
            return obtenerFestivosLocalidad(empleado.localidad);
        }

        // üîß NUEVA FUNCI√ìN: Detectar si una fecha es festiva para un empleado espec√≠fico
        function esFestivoLocal(fecha, empleadoId) {
            if (!fecha) return false;
            const d = fecha instanceof Date ? fecha : new Date(fecha);
            const festivos = obtenerFestivosEmpleado(empleadoId);
            return festivos.some(f => f.mes === d.getMonth() && f.dia === d.getDate());
        }
        
        // üîß ASIGNAR A WINDOW PARA ACCESO GLOBAL
        window.esFestivoLocal = esFestivoLocal;
        
        if (!window.AppState) {
            window.AppState = {
                currentYear: new Date().getFullYear(),
                currentMonth: new Date().getMonth(),
                scheduleData: new Map(),
                selectedEmployee: null,
                saveToStorage: () => {
                    try {
                        localStorage.setItem('turnosAppState', JSON.stringify({
                            scheduleData: Object.fromEntries(this.scheduleData),
                            selectedEmployee: this.selectedEmployee,
                            currentMonth: this.currentMonth,
                            currentYear: this.currentYear
                        }));
                    } catch (e) {
                        console.error('Error guardando estado:', e);
                    }
                },
                loadFromStorage: async function() {
                    try {
                        console.log('[AppState.loadFromStorage] Cargando desde localStorage...');
                        const data = localStorage.getItem('turnosAppState');
                        
                        if (data) {
                            const savedState = JSON.parse(data);
                            
                            // Cargar scheduleData (convertir a Map)
                            if (savedState.scheduleData) {
                                const scheduleMap = new Map();
                                for (const [empleadoId, turnos] of Object.entries(savedState.scheduleData)) {
                                    // Convertir fechas de string a Date objects
                                    const turnosConFechas = turnos.map(turno => ({
                                        ...turno,
                                        fecha: typeof turno.fecha === 'string' ? new Date(turno.fecha) : turno.fecha
                                    }));
                                    scheduleMap.set(parseInt(empleadoId), turnosConFechas);
                                }
                                this.scheduleData = scheduleMap;
                                console.log('[AppState.loadFromStorage] Datos cargados exitosamente. Empleados:', this.scheduleData.size);
                            }
                            
                            // Cargar empleado seleccionado
                            if (savedState.selectedEmployee) {
                                this.selectedEmployee = savedState.selectedEmployee;
                            }
                        } else {
                            console.log('[AppState.loadFromStorage] No hay datos guardados');
                        }
                    } catch (error) {
                        console.error('[AppState.loadFromStorage] Error:', error);
                    }
                },
                cambiosPendientes: []
            };
        }

        if (!window.EmployeeManager) {
            window.EmployeeManager = {
                abrirModal: () => {
                    const modal = document.getElementById('modalGestionEmpleados');
                    if (modal) modal.classList.add('active');
                },
                cerrarModal: () => {
                    const modal = document.getElementById('modalGestionEmpleados');
                    if (modal) modal.classList.remove('active');
                },
                mostrarFormularioNuevo: function() {
                    document.getElementById('formEmpleadosContenedor').style.display = 'block';
                    document.getElementById('listaEmpleados').style.display = 'none';
                    // Limpiar formulario (IDs nuevos del HTML)
                    document.getElementById('emple_nombre').value = '';
                    document.getElementById('emple_email').value = '';
                    document.getElementById('emple_telefono').value = '';
                    document.getElementById('emple_departamento').value = 'Limpieza';
                    document.getElementById('emple_localidad').value = 'Getafe';
                    document.getElementById('emple_horas').value = '169';
                    document.getElementById('emple_turno').value = 'Ma√±ana';
                    document.getElementById('emple_estado').value = 'activo';
                    // Llenar select de localidades
                    this.llenarSelectLocalidades();
                },
                llenarSelectLocalidades: function() {
                    const select = document.getElementById('emple_localidad');
                    if (!select) return;
                    
                    const localidades = ['Getafe', 'Madrid', 'Legan√©s', 'Fuenlabrada', 'M√≥stoles'];
                    const currentValue = select.value || 'Getafe';
                    
                    select.innerHTML = '';
                    localidades.forEach(localidad => {
                        const opt = document.createElement('option');
                        opt.value = localidad;
                        opt.textContent = localidad;
                        opt.selected = (localidad === currentValue);
                        select.appendChild(opt);
                    });
                },
                cancelarFormulario: function() {
                    document.getElementById('formEmpleadosContenedor').style.display = 'none';
                    document.getElementById('listaEmpleados').style.display = 'block';
                    this.refrescarLista();
                },
                guardarEmpleado: function() {
                    const nombre = document.getElementById('nombreEmpleadoForm')?.value.trim() || document.getElementById('emple_nombre')?.value.trim();
                    const email = document.getElementById('emailEmpleadoForm')?.value.trim() || document.getElementById('emple_email')?.value.trim();
                    const telefono = document.getElementById('telefonoEmpleadoForm')?.value.trim() || document.getElementById('emple_telefono')?.value.trim();
                    const departamento = document.getElementById('departamentoEmpleadoForm')?.value || document.getElementById('emple_departamento')?.value || 'Limpieza';
                    const localidad = document.getElementById('emple_localidad')?.value || 'Getafe';
                    const horasContrato = parseInt(document.getElementById('horasContratoForm')?.value || document.getElementById('emple_horas')?.value) || 169;
                    const turnoPrincipal = document.getElementById('turnoExoticForm')?.value || document.getElementById('emple_turno')?.value || 'ma√±ana';
                    const estado = document.getElementById('emple_estado')?.value || 'activo';

                    // Validaciones
                    if (!nombre || nombre.length < 3) {
                        NotificationSystem.show('‚ùå El nombre debe tener al menos 3 caracteres', 'error');
                        return;
                    }
                    if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                        NotificationSystem.show('‚ùå Email inv√°lido', 'error');
                        return;
                    }
                    if (telefono && telefono.length < 9) {
                        NotificationSystem.show('‚ùå El tel√©fono debe tener al menos 9 caracteres', 'error');
                        return;
                    }

                    // Crear o actualizar empleado (INCLUYE LOCALIDAD)
                    const nuevoId = Math.max(...empleados.map(e => e.id), 0) + 1;
                    const empleado = {
                        id: nuevoId,
                        nombre,
                        email,
                        telefono,
                        departamento,
                        localidad,
                        horasContrato,
                        turnoPrincipal,
                        estado,
                        foto: null
                    };

                    empleados.push(empleado);
                    
                    // Guardar en localStorage
                    localStorage.setItem('empleadosData', JSON.stringify(empleados));
                    AppState.saveToStorage();

                    NotificationSystem.show(`‚úÖ ${nombre} agregado en ${localidad} correctamente`, 'success');
                    
                    // Refrescar UI
                    document.getElementById('formEmpleadosContenedor').style.display = 'none';
                    document.getElementById('listaEmpleados').style.display = 'block';
                    this.refrescarLista();
                    this.llenarSelectLocalidades(); // Refrescar localidades
                    
                    // Refrescar cuadrante principal
                    if (typeof UI !== 'undefined' && typeof UI.generarCuadranteGeneral === 'function') {
                        UI.generarCuadranteGeneral();
                    }
                },
                refrescarLista: function() {
                    const listaDiv = document.getElementById('listaEmpleados');
                    let html = '<h3>üìã Empleados Registrados</h3>';
                    html += '<div style="display: grid; gap: 10px; max-height: 400px; overflow-y: auto;">';
                    
                    if (!empleados || empleados.length === 0) {
                        html += '<p style="color: #94a3b8;">No hay empleados registrados</p>';
                    } else {
                        empleados.forEach(emp => {
                            html += `
                                <div style="background: #1e293b; padding: 12px; border-radius: 8px; border-left: 4px solid #0ea5e9; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="color: #f1f5f9;">${emp.nombre}</strong><br>
                                        <small style="color: #94a3b8;">${emp.departamento} ‚Ä¢ ${emp.horasContrato}h/mes</small>
                                    </div>
                                    <button onclick="EmployeeManager.eliminarEmpleado(${emp.id})" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">üóëÔ∏è Eliminar</button>
                                </div>
                            `;
                        });
                    }
                    html += '</div>';
                    listaDiv.innerHTML = html;
                },
                eliminarEmpleado: function(empleadoId) {
                    if (confirm('¬øEliminar este empleado?')) {
                        empleados = empleados.filter(e => e.id !== empleadoId);
                        localStorage.setItem('empleadosData', JSON.stringify(empleados));
                        AppState.saveToStorage();
                        NotificationSystem.show('‚úÖ Empleado eliminado', 'success');
                        this.refrescarLista();
                        
                        // Refrescar cuadrante
                        if (typeof UI !== 'undefined' && typeof UI.generarCuadranteGeneral === 'function') {
                            UI.generarCuadranteGeneral();
                        }
                    }
                },
                cargarDelStorage: function() {
                    const stored = localStorage.getItem('empleadosData');
                    if (stored) {
                        try {
                            empleados = JSON.parse(stored);
                            console.log('[EmployeeManager] Cargados', empleados.length, 'empleados del storage');
                        } catch (e) {
                            console.error('[EmployeeManager] Error cargando empleados:', e);
                        }
                    }
                }
            };
        }

        if (!window.TurnoManager) {
            window.TurnoManager = {
                reiniciarDatos: () => {
                    console.log('Regenerando cuadrante...');
                },

                // FUNCI√ìN 1: Verificar si cuadrante est√° vac√≠o
                esCuadranteVacio: () => {
                    try {
                        if (!AppState || !AppState.scheduleData) return true;
                        
                        const mes = AppState.currentMonth;
                        const a√±o = AppState.currentYear;
                        
                        for (const [empId, turnos] of AppState.scheduleData.entries()) {
                            if (turnos && Array.isArray(turnos) && turnos.length > 0) {
                                const tienenMesA√±o = turnos.some(t => {
                                    if (!t || !t.fecha) return false;
                                    const fecha = new Date(t.fecha);
                                    return fecha.getMonth() === mes && fecha.getFullYear() === a√±o;
                                });
                                if (tienenMesA√±o) return false;
                            }
                        }
                        return true;
                    } catch (e) {
                        console.error('Error en esCuadranteVacio:', e);
                        return true;
                    }
                },

                // FUNCI√ìN 2: Mostrar modal de generaci√≥n
                mostrarModalGeneracion: () => {
                    try {
                        const modal = document.getElementById('modalGenerarTurnos');
                        if (!modal) {
                            console.error('Modal modalGenerarTurnos no encontrado');
                            return;
                        }
                        
                        const mes = AppState?.currentMonth ?? new Date().getMonth();
                        const a√±o = AppState?.currentYear ?? new Date().getFullYear();
                        const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                        const mesNombre = meses[mes];
                        
                        const totalEmpleados = window.empleados ? window.empleados.length : 0;
                        const totalTurnos = totalEmpleados * 30;
                        
                        document.getElementById('modalMesA√±o').textContent = `${mesNombre} ${a√±o}`;
                        document.getElementById('modalTotalTurnos').textContent = totalTurnos;
                        
                        modal.classList.add('active');
                        console.log('Modal de generaci√≥n abierto');
                    } catch (e) {
                        console.error('Error en mostrarModalGeneracion:', e);
                    }
                },

                // FUNCI√ìN 3: Cerrar modal
                cerrarModalGeneracion: () => {
                    try {
                        const modal = document.getElementById('modalGenerarTurnos');
                        if (modal) {
                            modal.classList.remove('active');
                        }
                    } catch (e) {
                        console.error('Error en cerrarModalGeneracion:', e);
                    }
                },

                // FUNCI√ìN 4: Generar turnos (async)
                generarTurnos: async () => {
                    try {
                        if (!window.TurnoManager.generarTurnos._generando) {
                            window.TurnoManager.generarTurnos._generando = true;
                            
                            console.log('Iniciando generaci√≥n de turnos...');
                            
                            // Llamar inicializarDatos si existe
                            if (typeof TurnoManager !== 'undefined' && TurnoManager.inicializarDatos) {
                                await TurnoManager.inicializarDatos();
                            }
                            
                            // Guardar en API
                            if (window.empleados && Array.isArray(window.empleados)) {
                                for (const empleado of window.empleados) {
                                    const turnos = AppState.scheduleData.get(empleado.id) || [];
                                    try {
                                        const response = await fetch(`/api/turnos/${empleado.id}`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({
                                                mes: AppState.currentMonth,
                                                anio: AppState.currentYear,
                                                turnos: turnos
                                            })
                                        });
                                        if (!response.ok) {
                                            console.warn(`Error guardando turnos para ${empleado.nombre}:`, response.statusText);
                                        }
                                    } catch (apiError) {
                                        console.error(`Error API para empleado ${empleado.id}:`, apiError);
                                    }
                                }
                            }
                            
                            // Actualizar UI
                            if (typeof UI !== 'undefined' && UI.generarCuadranteGeneral) {
                                UI.generarCuadranteGeneral();
                            }
                            
                            // Cerrar modal
                            window.TurnoManager.cerrarModalGeneracion();
                            
                            // Verificar bot√≥n
                            window.TurnoManager.verificarYMostrarBoton();
                            
                            console.log('‚úÖ Turnos generados correctamente');
                            
                            window.TurnoManager.generarTurnos._generando = false;
                        }
                    } catch (e) {
                        console.error('Error en generarTurnos:', e);
                        window.TurnoManager.generarTurnos._generando = false;
                    }
                },

                // FUNCI√ìN 5: Verificar y mostrar bot√≥n
                verificarYMostrarBoton: () => {
                    try {
                        const btn = document.getElementById('btnGenerarTurnos');
                        if (!btn) {
                            console.warn('Bot√≥n btnGenerarTurnos no encontrado');
                            return;
                        }
                        
                        const estaVacio = window.TurnoManager.esCuadranteVacio();
                        if (estaVacio) {
                            btn.style.display = 'block';
                            console.log('üü¢ Bot√≥n MOSTRADO (cuadrante vac√≠o)');
                        } else {
                            btn.style.display = 'none';
                            console.log('üî¥ Bot√≥n OCULTADO (cuadrante con datos)');
                        }
                    } catch (e) {
                        console.error('Error en verificarYMostrarBoton:', e);
                    }
                }
            };
        }

        // SISTEMA DE EDICI√ìN MASIVA MEJORADO
        window.EdicionMasiva = {
            abrirModal: function() {
                console.log('[EdicionMasiva] Abriendo modal, empleados globales:', window.empleados ? window.empleados.length : 'no encontrados');
                
                const modal = document.getElementById('modalEdicionMasiva');
                if (!modal) {
                    console.error('[EdicionMasiva] Modal no encontrado');
                    return;
                }
                
                // Mostrar el modal
                modal.classList.add('active');
                console.log('[EdicionMasiva] Modal visible');
                
                // Esperar un tick para asegurar que el DOM se haya actualizado
                requestAnimationFrame(() => {
                    this.llenarSelects();
                });
            },
            
            llenarSelects: function() {
                console.log('[EdicionMasiva.llenarSelects] Iniciando...');
                
                // Llenar empleados
                const selectEmpleado = document.getElementById('masiva_empleado');
                if (!selectEmpleado) {
                    console.error('[EdicionMasiva] Select masiva_empleado NO ENCONTRADO');
                    return;
                }
                
                console.log('[EdicionMasiva] Encontrado select masiva_empleado');
                console.log('[EdicionMasiva] Empleados global:', typeof empleados, Array.isArray(empleados) ? empleados.length : 'no es array');
                
                // Limpiar opciones previas excepto la primera
                selectEmpleado.innerHTML = '<option value="">-- Elige un empleado --</option>';
                
                if (typeof empleados !== 'undefined' && Array.isArray(empleados) && empleados.length > 0) {
                    console.log('[EdicionMasiva] Agregando empleados al select...');
                    empleados.forEach((emp, idx) => {
                        try {
                            const opt = document.createElement('option');
                            opt.value = emp.id || idx;
                            opt.textContent = `${emp.nombre || 'Sin nombre'} (${emp.estado || 'activo'})`;
                            selectEmpleado.appendChild(opt);
                            console.log(`[EdicionMasiva] ‚úì Empleado ${idx + 1}: ${emp.nombre}`);
                        } catch (e) {
                            console.error(`[EdicionMasiva] Error agregando empleado ${idx}:`, e);
                        }
                    });
                } else {
                    console.warn('[EdicionMasiva] empleados no est√° disponible o vac√≠o');
                }
                
                // Llenar d√≠as
                const selectDesde = document.getElementById('masiva_desde');
                const selectHasta = document.getElementById('masiva_hasta');
                
                if (selectDesde && selectHasta) {
                    console.log('[EdicionMasiva] Llenando d√≠as...');
                    selectDesde.innerHTML = '<option value="">-- D√≠a inicio --</option>';
                    selectHasta.innerHTML = '<option value="">-- D√≠a fin --</option>';
                    
                    for (let dia = 1; dia <= 31; dia++) {
                        const opt1 = document.createElement('option');
                        opt1.value = dia;
                        opt1.textContent = `D√≠a ${dia}`;
                        selectDesde.appendChild(opt1);
                        
                        const opt2 = document.createElement('option');
                        opt2.value = dia;
                        opt2.textContent = `D√≠a ${dia}`;
                        selectHasta.appendChild(opt2);
                    }
                    console.log('[EdicionMasiva] D√≠as agregados (1-31)');
                }
                
                // Llenar turnos
                const selectTurno = document.getElementById('masiva_turno');
                if (selectTurno) {
                    console.log('[EdicionMasiva] Llenando turnos...');
                    selectTurno.innerHTML = '<option value="">-- Selecciona turno --</option>';
                    
                    // Leer turnos de localStorage
                    const tiposTurnoData = JSON.parse(localStorage.getItem('tiposTurnoData') || '{}');
                    
                    // Si localStorage est√° vac√≠o, usar global tiposTurno
                    const tiposAUsar = Object.keys(tiposTurnoData).length > 0 ? tiposTurnoData : tiposTurno;
                    
                    Object.entries(tiposAUsar).forEach(([key, tipo]) => {
                        const opt = document.createElement('option');
                        opt.value = key;
                        opt.textContent = tipo.nombre || key;
                        selectTurno.appendChild(opt);
                    });
                    
                    console.log('[EdicionMasiva] Turnos agregados:', Object.keys(tiposAUsar).length);
                }
                
                // Configurar listeners
                this.configurarListeners();
                console.log('[EdicionMasiva] ‚úÖ Modal completamente llenado');
            },
            
            configurarListeners: function() {
                const self = this;  // Guardar referencia a EdicionMasiva
                const elem1 = document.getElementById('masiva_empleado');
                const elem2 = document.getElementById('masiva_desde');
                const elem3 = document.getElementById('masiva_hasta');
                const elem4 = document.getElementById('masiva_turno');
                
                // Remover listeners antiguos clonando
                if (elem1) {
                    const nuevo1 = elem1.cloneNode(true);
                    elem1.parentNode.replaceChild(nuevo1, elem1);
                    nuevo1.addEventListener('change', function() {
                        self.actualizarResumen();
                    });
                }
                if (elem2) {
                    const nuevo2 = elem2.cloneNode(true);
                    elem2.parentNode.replaceChild(nuevo2, elem2);
                    nuevo2.addEventListener('change', function() {
                        self.actualizarResumen();
                    });
                }
                if (elem3) {
                    const nuevo3 = elem3.cloneNode(true);
                    elem3.parentNode.replaceChild(nuevo3, elem3);
                    nuevo3.addEventListener('change', function() {
                        self.actualizarResumen();
                    });
                }
                if (elem4) {
                    const nuevo4 = elem4.cloneNode(true);
                    elem4.parentNode.replaceChild(nuevo4, elem4);
                    nuevo4.addEventListener('change', function() {
                        self.actualizarResumen();
                    });
                }
            },
            
            actualizarResumen: function() {
                const empleadoId = document.getElementById('masiva_empleado').value;
                const desde = parseInt(document.getElementById('masiva_desde').value);
                const hasta = parseInt(document.getElementById('masiva_hasta').value);
                const turno = document.getElementById('masiva_turno').value;
                
                const resumenDiv = document.getElementById('masiva_resumen');
                
                if (!empleadoId || !desde || !hasta || !turno) {
                    resumenDiv.innerHTML = '‚ö†Ô∏è Selecciona empleado, rango de fechas y turno';
                    resumenDiv.style.color = '#d97706';
                    return;
                }
                
                if (desde > hasta) {
                    resumenDiv.innerHTML = '‚ùå Error: El d√≠a inicio debe ser menor al d√≠a fin';
                    resumenDiv.style.color = '#dc2626';
                    return;
                }
                
                const empleado = empleados.find(e => e.id == empleadoId);
                if (!empleado) {
                    resumenDiv.innerHTML = '‚ùå Empleado no encontrado';
                    resumenDiv.style.color = '#dc2626';
                    return;
                }
                
                const diasAfectados = hasta - desde + 1;
                const tiposTurno = {
                    'ma√±ana': '‚òÄÔ∏è Ma√±ana',
                    'tarde': 'üå§Ô∏è Tarde',
                    'noche': 'üåô Noche',
                    'mixto': '‚ö° Mixto',
                    'descanso': 'üò¥ Descanso',
                    'vacaciones': 'üèñÔ∏è Vacaciones',
                    'baja': 'üè• Baja M√©dica',
                    'libre': '‚ú® Libre'
                };
                
                const html = `
                    <div style="line-height: 1.8;">
                        <p><strong>Empleado:</strong> ${empleado.nombre}</p>
                        <p><strong>Per√≠odo:</strong> D√≠as ${desde} al ${hasta}</p>
                        <p><strong>Cantidad de d√≠as:</strong> ${diasAfectados}</p>
                        <p><strong>Nuevo turno:</strong> ${tiposTurno[turno]}</p>
                        <hr style="margin: 10px 0; border: none; border-top: 1px solid #ccc;">
                        <p style="color: #059669; font-weight: bold;">‚úÖ Se asignar√°n ${diasAfectados} turnos</p>
                    </div>
                `;
                
                resumenDiv.innerHTML = html;
                resumenDiv.style.color = '#059669';
            },
            
            aplicarCambios: function() {
                const empleadoIdStr = document.getElementById('masiva_empleado').value;
                const empleadoId = parseInt(empleadoIdStr) || empleadoIdStr;  // Convertir a n√∫mero si es posible
                const desde = parseInt(document.getElementById('masiva_desde').value);
                const hasta = parseInt(document.getElementById('masiva_hasta').value);
                const turno = document.getElementById('masiva_turno').value;
                
                console.log('[EdicionMasiva.aplicarCambios] Datos:', {empleadoId, desde, hasta, turno});
                
                if (!empleadoId || !desde || !hasta || !turno) {
                    alert('‚ö†Ô∏è Debes seleccionar empleado, rango de fechas y turno');
                    return;
                }
                
                if (desde > hasta) {
                    alert('‚ùå Error: El d√≠a inicio debe ser menor al d√≠a fin');
                    return;
                }
                
                // Obtener los turnos del empleado
                let turnos = AppState.scheduleData.get(empleadoId);
                console.log('[EdicionMasiva.aplicarCambios] Turnos antes:', turnos?.length);
                
                if (!turnos || turnos.length === 0) {
                    alert('‚ùå Error: No hay turnos para este empleado');
                    return;
                }
                
                // Aplicar cambios a cada d√≠a
                let changesCount = 0;
                for (let dia = desde; dia <= hasta; dia++) {
                    if (turnos[dia - 1]) {
                        console.log(`[EdicionMasiva.aplicarCambios] D√≠a ${dia}: ${turnos[dia - 1].turno} ‚Üí ${turno}`);
                        turnos[dia - 1].turno = turno;
                        
                        // üîß NUEVO: Actualizar tambi√©n horario y horas del tipo de turno
                        const tiposTurnoData = JSON.parse(localStorage.getItem('tiposTurnoData') || '{}');
                        const tipoTurnoObj = Object.values(tiposTurnoData).find(t => 
                            t?.nombre && t.nombre.toLowerCase() === turno.toLowerCase()
                        );
                        
                        if (tipoTurnoObj) {
                            turnos[dia - 1].horario = tipoTurnoObj.horario || '';
                            turnos[dia - 1].horas = tipoTurnoObj.horas || 0;
                            console.log(`[EdicionMasiva.aplicarCambios] ‚úÖ Asignado horario: ${turnos[dia - 1].horario}, horas: ${turnos[dia - 1].horas}`);
                        }
                        
                        changesCount++;
                    }
                }
                
                console.log('[EdicionMasiva.aplicarCambios] Cambios aplicados:', changesCount);
                
                // Actualizar en AppState (aunque ya deber√≠a estar actualizado por referencia)
                AppState.scheduleData.set(empleadoId, turnos);
                
                // Guardar y regenerar
                AppState.saveToStorage();
                console.log('[EdicionMasiva.aplicarCambios] Guardado en localStorage');
                
                // Regenerar la tabla (verificar si UI existe)
                if (typeof UI !== 'undefined' && typeof UI.generarCuadranteGeneral === 'function') {
                    console.log('[EdicionMasiva.aplicarCambios] Llamando UI.generarCuadranteGeneral()');
                    UI.generarCuadranteGeneral();
                } else {
                    console.warn('[EdicionMasiva.aplicarCambios] UI.generarCuadranteGeneral no disponible, intentando location.reload()');
                    location.reload();
                }
                
                console.log('[EdicionMasiva.aplicarCambios] Cuadrante regenerado');
                
                alert(`‚úÖ Se asignaron ${changesCount} turnos exitosamente`);
                this.cerrarModal();
            },
            
            cerrarModal: function() {
                const modal = document.getElementById('modalEdicionMasiva');
                if (modal) {
                    modal.classList.remove('active');
                }
            }
        };
        
        // Mantener compatibilidad con TurnoEditor
        if (!window.TurnoEditor) {
            window.TurnoEditor = {};
        }
        
        // SIEMPRE asignar estas funciones
        window.TurnoEditor.mostrarModalEdicionMasiva = () => {
            console.log('[TurnoEditor] Llamando EdicionMasiva.abrirModal()');
            EdicionMasiva.abrirModal();
        };
        window.TurnoEditor.cerrarModal = () => EdicionMasiva.cerrarModal();
        window.TurnoEditor.aplicarEdicionMasiva = () => EdicionMasiva.aplicarCambios();
        if (!window.TurnoEditor.abrirEditorTurno) {
            window.TurnoEditor.abrirEditorTurno = () => console.log('Editor turno');
        }

        if (!window.ExportManager) {
            window.ExportManager = {
                exportarCuadranteGeneral: (formato) => console.log('Exportar:', formato)
            };
        }

        if (!window.DateUtils) {
            window.DateUtils = {
                cambiarMes: (direccion) => {
                    if (window.AppState) {
                        window.AppState.currentMonth += direccion;
                        if (window.AppState.currentMonth > 11) {
                            window.AppState.currentMonth = 0;
                            window.AppState.currentYear++;
                        }
                        if (window.AppState.currentMonth < 0) {
                            window.AppState.currentMonth = 11;
                            window.AppState.currentYear--;
                        }
                        
                        console.log(`[cambiarMes] Cambiando a mes ${window.AppState.currentMonth}/${window.AppState.currentYear}`);
                        
                        // Actualizar selectores inmediatamente
                        const selectMonth = document.getElementById('selectMonth');
                        const selectYear = document.getElementById('selectYear');
                        if (selectMonth) selectMonth.value = window.AppState.currentMonth;
                        if (selectYear) selectYear.value = window.AppState.currentYear;
                        
                        // Llamar reiniciarDatos de forma as√≠ncrona SIN BLOQUEAR
                        if (typeof TurnoManager !== 'undefined' && TurnoManager.reiniciarDatos) {
                            // Usar setTimeout para no bloquear el hilo principal
                            setTimeout(() => {
                                TurnoManager.reiniciarDatos().catch(err => {
                                    console.error('Error en reiniciarDatos:', err);
                                    NotificationSystem.show('‚ùå Error cargando mes', 'error');
                                });
                            }, 0);
                        }
                    }
                }
            };
        }

        console.log('‚úì Fallback objetos base cargados');
    </script>

    <!-- Fallback: Mejorado despu√©s del DOM cargado -->
    <script>
        // Este script se ejecuta DESPU√âS de que los m√≥dulos intenten cargar
        // Proporciona m√©todos adicionales si es necesario
        setTimeout(() => {
            if (!window.AppState || !window.AppState.currentYear) {
                window.AppState = {
                    currentYear: new Date().getFullYear(),
                    currentMonth: new Date().getMonth(),
                    scheduleData: new Map(),
                    selectedEmployee: null
                };
            }

            if (!window.EmployeeManager || !window.EmployeeManager.abrirModal) {
                window.EmployeeManager = window.EmployeeManager || {};
                window.EmployeeManager.abrirModal = () => {
                    const modal = document.getElementById('modalGestionEmpleados');
                    if (modal) modal.classList.add('active');
                };
            }

            if (!window.TurnoManager || !window.TurnoManager.reiniciarDatos) {
                window.TurnoManager = window.TurnoManager || {};
                window.TurnoManager.reiniciarDatos = () => console.log('Regenerando...');
            }

            console.log('‚úì Fallback mejorado completado');
        }, 500);
    </script>

    <!-- Tests autom√°ticos si se pasa ?test=true en URL -->
    <script>
        // Ejecutar inmediatamente al cargar
        (function() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('test') !== 'true') return;
            
            console.log('üß™ Modo TEST activado');
            
            // Ejecutar despu√©s de que el DOM est√© completamente listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', runTests);
            } else {
                setTimeout(runTests, 2000);
            }
        })();

        function runTests() {
            try {
                console.log('üî• Ejecutando tests...');
                
                let pass = 0, fail = 0;
                const results = [];

                function test(name, condition, message = '') {
                    if (condition) {
                        pass++;
                        results.push(`‚úì ${name}`);
                        console.log(`‚úì ${name}`);
                    } else {
                        fail++;
                        results.push(`‚úó ${name} ${message ? '- ' + message : ''}`);
                        console.log(`‚úó ${name}`, message);
                    }
                }

                // Tests
                test('Header existe', !!document.querySelector('header'));
                test('Top controls existe', !!document.querySelector('.top-controls'));
                const tabCount = document.querySelectorAll('.tab-btn').length;
                test('Tabs existen', tabCount >= 2, `(${tabCount} encontradas)`);
                test('AppState existe', typeof window.AppState !== 'undefined' && window.AppState !== null);
                test('EmployeeManager existe', typeof window.EmployeeManager !== 'undefined' && window.EmployeeManager !== null);
                test('TurnoManager existe', typeof window.TurnoManager !== 'undefined' && window.TurnoManager !== null);
                test('TurnoEditor existe', typeof window.TurnoEditor !== 'undefined' && window.TurnoEditor !== null);
                test('ExportManager existe', typeof window.ExportManager !== 'undefined' && window.ExportManager !== null);
                test('DateUtils existe', typeof window.DateUtils !== 'undefined' && window.DateUtils !== null);
                test('empleados array existe', Array.isArray(window.empleados), `(${window.empleados?.length || 0} empleados)`);
                test('EmployeeManager.abrirModal funci√≥n', typeof window.EmployeeManager?.abrirModal === 'function');
                test('TurnoManager.reiniciarDatos funci√≥n', typeof window.TurnoManager?.reiniciarDatos === 'function');
                test('TurnoEditor.mostrarModalEdicionMasiva funci√≥n', typeof window.TurnoEditor?.mostrarModalEdicionMasiva === 'function');
                test('ExportManager.exportarCuadranteGeneral funci√≥n', typeof window.ExportManager?.exportarCuadranteGeneral === 'function');
                test('DateUtils.cambiarMes funci√≥n', typeof window.DateUtils?.cambiarMes === 'function');

                const totalTests = pass + fail;
                const percentage = ((pass / totalTests) * 100).toFixed(1);
                
                console.log(`‚úì Tests completados: ${pass}/${totalTests} pasados (${percentage}%)`);

                // Crear modal de resultados
                const modalDiv = document.createElement('div');
                modalDiv.id = 'testResultsModal';
                modalDiv.innerHTML = `
                    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 99999; max-width: 600px; font-family: Arial, sans-serif;">
                        <h2 style="margin-bottom: 20px; color: #333;">üß™ Resultados de Tests</h2>
                        <div style="font-family: monospace; font-size: 13px; line-height: 1.8; background: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
                            ${results.map(r => `<div style="color: ${r.startsWith('‚úì') ? '#28a745' : '#dc3545'};">${r}</div>`).join('')}
                        </div>
                        <div style="background: ${percentage >= 80 ? '#d4edda' : '#f8d7da'}; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                            <strong style="font-size: 16px;">Pasados: ${pass}/${totalTests}</strong> (${percentage}%)
                            <div style="margin-top: 10px; color: #333;">
                                ${percentage >= 80 ? '‚úÖ APLICACI√ìN FUNCIONAL' : '‚ö†Ô∏è NECESITA REPARACIONES'}
                            </div>
                        </div>
                        <button onclick="document.getElementById('testResultsModal').remove()" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold;">Cerrar</button>
                    </div>
                `;
                document.body.appendChild(modalDiv);
                console.log('‚úì Modal de resultados mostrado');
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico en tests:', error);
                alert('Error en tests: ' + error.message + '\n\nMira la consola para m√°s detalles.');
            }
        }
    </script>

    

    <!-- Limpieza de inyectores de modo oscuro (extensiones/auto-dark) -->
    <script>
        (() => {
            const cleanDarkInjectors = () => {
                try {
                    const darkNodes = document.querySelectorAll('style[id^="darkreader"], link[id^="darkreader"]');
                    darkNodes.forEach(n => n.remove());
                    ['data-darkreader-mode', 'data-darkreader-scheme', 'data-theme'].forEach(attr => {
                        document.documentElement.removeAttribute(attr);
                        document.body.removeAttribute(attr);
                    });
                    document.documentElement.style.filter = '';
                    document.body.style.filter = '';
                    const darkBg = 'radial-gradient(circle at 15% 20%, #0f172a 0%, #0b1220 40%, #0a0f1c 80%)';
                    document.documentElement.style.background = darkBg;
                    document.body.style.background = darkBg;
                    document.documentElement.style.color = '#e5e7eb';
                    document.body.style.color = '#e5e7eb';
                } catch (e) {
                    console.warn('No se pudo limpiar inyectores de modo oscuro:', e);
                }
            };
            cleanDarkInjectors();
            setInterval(cleanDarkInjectors, 1500);
        })();
        
        // üîç FUNCI√ìN DE DIAGN√ìSTICO - Ejecuta en consola: diag()
        window.diag = function() {
            console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê DIAGN√ìSTICO DE PERSISTENCIA ‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #0ea5e9; font-weight: bold; font-size: 14px;');
            
            console.log('%c‚úì localStorage Disponible', 'color: #22c55e; font-weight: bold;');
            console.log('typeof localStorage:', typeof localStorage);
            
            try {
                localStorage.setItem('_test', '1');
                localStorage.removeItem('_test');
                console.log('localStorage funcionando: ‚úÖ SI');
            } catch(e) {
                console.log('localStorage funcionando: ‚ùå NO -', e.message);
            }
            
            console.log('%c‚úì Datos en localStorage', 'color: #22c55e; font-weight: bold;');
            const turnosAppState = localStorage.getItem('turnosAppState');
            const empleadosData = localStorage.getItem('empleadosData');
            const departamentosData = localStorage.getItem('departamentosData');
            
            console.log('turnosAppState:', turnosAppState ? '‚úÖ S√ç (' + turnosAppState.length + ' chars)' : '‚ùå NO');
            console.log('empleadosData:', empleadosData ? '‚úÖ S√ç (' + empleadosData.length + ' chars)' : '‚ùå NO');
            console.log('departamentosData:', departamentosData ? '‚úÖ S√ç (' + departamentosData.length + ' chars)' : '‚ùå NO');
            
            console.log('%c‚úì Estado en Memoria', 'color: #22c55e; font-weight: bold;');
            console.log('Empleados en memoria:', typeof empleados !== 'undefined' ? empleados.length : 0);
            console.log('AppState.scheduleData size:', typeof AppState !== 'undefined' ? AppState.scheduleData.size : 'N/A');
            
            console.log('%c‚úì Consola de Navegador', 'color: #22c55e; font-weight: bold;');
            console.log('URL actual:', window.location.href);
            console.log('¬øEs http://localhost?', window.location.href.includes('http://localhost') || window.location.href.includes('http://127.0.0.1') ? '‚úÖ SI' : '‚ùå NO (¬°localStorage NO funciona con file://)');
            
            console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #0ea5e9; font-weight: bold; font-size: 14px;');
            console.log('Para probar persistencia: 1) Abre DevTools (F12), 2) Application > LocalStorage, 3) Verifica http://localhost:8000');
        };
        
        console.log('%cüí° Tip: Escribe "diag()" en la consola para diagn√≥stico de persistencia', 'color: #f59e0b; font-weight: bold;');
    </script>

    <!-- SCRIPT: Estandarizaci√≥n Global de Iluminaci√≥n de Botones -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Selector de todos los botones interactivos
            const selectores = 'button:not(.notification-close)';
            
            // Extraer color RGB de una cadena
            function extraerRGB(cadena) {
                const match = cadena.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                if (match) {
                    return { r: parseInt(match[1]), g: parseInt(match[2]), b: parseInt(match[3]) };
                }
                return null;
            }
            
            // Convertir hex a RGB
            function hexARGB(hex) {
                if (!hex || typeof hex !== 'string') return null;
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            }
            
            // Obtener el color principal del bot√≥n - SIEMPRE devuelve un RGB v√°lido
            function obtenerColorPrincipal(elemento) {
                const style = window.getComputedStyle(elemento);
                let bg = style.background || style.backgroundColor;
                
                // Si est√° vac√≠o, usar color por defecto
                if (!bg || bg === 'rgba(0, 0, 0, 0)' || bg === 'transparent') {
                    // Intentar con color heredado o fallback
                    if (elemento.style.color) {
                        bg = elemento.style.color;
                    } else {
                        return { r: 14, g: 165, b: 233 }; // Cyan por defecto
                    }
                }
                
                // Si es un gradient, intentar extraer el primer color
                if (bg.includes('linear-gradient') || bg.includes('radial-gradient')) {
                    const match = bg.match(/#[0-9a-f]{6}|rgb\(\d+,\s*\d+,\s*\d+\)/gi);
                    if (match && match.length > 0) {
                        bg = match[0];
                    } else {
                        return { r: 14, g: 165, b: 233 }; // Cyan por defecto
                    }
                }
                
                // Convertir hex a RGB si es necesario
                if (bg.startsWith('#')) {
                    const rgb = hexARGB(bg);
                    return rgb || { r: 14, g: 165, b: 233 }; // Fallback a cyan
                }
                
                // Si es RGB, extraer
                if (bg.includes('rgb')) {
                    const rgb = extraerRGB(bg);
                    return rgb || { r: 14, g: 165, b: 233 }; // Fallback a cyan
                }
                
                // Color por defecto (cyan)
                return { r: 14, g: 165, b: 233 };
            }
            
            // Generar glow del mismo color del bot√≥n
            function generarGlowColor(rgb) {
                // Validaci√≥n: asegurarse de que rgb es v√°lido
                if (!rgb || typeof rgb !== 'object' || !('r' in rgb && 'g' in rgb && 'b' in rgb)) {
                    rgb = { r: 14, g: 165, b: 233 }; // Fallback a cyan
                }
                return `0 0 30px rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 1), 0 0 60px rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.8), 0 6px 20px rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.8)`;
            }
            
            // Generar sombra sutil del mismo color
            function generarSombraSutil(rgb) {
                // Validaci√≥n: asegurarse de que rgb es v√°lido
                if (!rgb || typeof rgb !== 'object' || !('r' in rgb && 'g' in rgb && 'b' in rgb)) {
                    rgb = { r: 14, g: 165, b: 233 }; // Fallback a cyan
                }
                return `0 2px 5px rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.2)`;
            }
            
            // Aplicar eventos a todos los botones (sin excepci√≥n)
            document.querySelectorAll(selectores).forEach(btn => {
                try {
                    const colorPrincipal = obtenerColorPrincipal(btn);
                    const glowIntensso = generarGlowColor(colorPrincipal);
                    const sombraSutil = generarSombraSutil(colorPrincipal);
                    
                    // Remover handlers existentes si los hay
                    btn.removeAttribute('onmouseover');
                    btn.removeAttribute('onmouseout');
                    
                    btn.addEventListener('mouseenter', function() {
                        this.style.boxShadow = glowIntensso;
                    });
                    
                    btn.addEventListener('mouseleave', function() {
                        this.style.boxShadow = sombraSutil;
                    });
                    
                    // Asegurarse de que inicia con sombra sutil
                    if (!btn.style.boxShadow || btn.style.boxShadow === '') {
                        btn.style.boxShadow = sombraSutil;
                    }
                } catch (e) {
                    console.warn('Error al aplicar glow a bot√≥n:', e);
                }
            });
            
            // Observer para botones din√°micos (agregados despu√©s)
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1 && node.tagName === 'BUTTON') {
                            try {
                                const colorPrincipal = obtenerColorPrincipal(node);
                                const glowIntensso = generarGlowColor(colorPrincipal);
                                const sombraSutil = generarSombraSutil(colorPrincipal);
                                
                                if (!node.hasAttribute('onmouseover')) {
                                    node.addEventListener('mouseenter', function() {
                                        this.style.boxShadow = glowIntensso;
                                    });
                                    
                                    node.addEventListener('mouseleave', function() {
                                        this.style.boxShadow = sombraSutil;
                                    });
                                    
                                    node.style.boxShadow = sombraSutil;
                                }
                            } catch (e) {
                                console.warn('Error con bot√≥n din√°mico:', e);
                            }
                        } else if (node.nodeType === 1) {
                            // Si es un contenedor, buscar botones dentro
                            node.querySelectorAll('button').forEach(btn => {
                                if (!btn.hasAttribute('onmouseover') && !btn._glowApplied) {
                                    try {
                                        btn._glowApplied = true;
                                        const colorPrincipal = obtenerColorPrincipal(btn);
                                        const glowIntensso = generarGlowColor(colorPrincipal);
                                        const sombraSutil = generarSombraSutil(colorPrincipal);
                                        
                                        btn.addEventListener('mouseenter', function() {
                                            this.style.boxShadow = glowIntensso;
                                        });
                                        
                                        btn.addEventListener('mouseleave', function() {
                                            this.style.boxShadow = sombraSutil;
                                        });
                                        
                                        btn.style.boxShadow = sombraSutil;
                                    } catch (e) {
                                        console.warn('Error con bot√≥n en contenedor:', e);
                                    }
                                }
                            });
                        }
                    });
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
    </script>
    
    <!-- Script para procesar res√∫menes inteligentes din√°micos -->
    <script>
        // Monitorear cambios en el DOM para detectar nuevos res√∫menes
        function inicializarObservadorResumenes() {
            if (typeof CalculadorHorasInteligente === 'undefined') {
                console.log('[ResumenObserver] Esperando CalculadorHorasInteligente...');
                setTimeout(inicializarObservadorResumenes, 100);
                return;
            }
            
            console.log('[ResumenObserver] CalculadorHorasInteligente listo, iniciando observer');
            
            // Observer para detectar nuevos divs resumen agregados
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(mutation => {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            // Buscar divs con data-emp-id dentro del nodo agregado
                            const divs = node.querySelectorAll ? node.querySelectorAll('[data-emp-id][data-mes][data-anio]') : [];
                            if (node.hasAttribute && node.hasAttribute('data-emp-id')) {
                                procesarDiv(node);
                            }
                            divs.forEach(procesarDiv);
                        }
                    });
                });
            });
            
            // Monitorear cambios en el body
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            console.log('[ResumenObserver] Observer iniciado');
        }
        
        function procesarDiv(div) {
            try {
                const empId = parseInt(div.getAttribute('data-emp-id'));
                const mes = parseInt(div.getAttribute('data-mes'));
                const anio = parseInt(div.getAttribute('data-anio'));
                
                console.log('[ResumenObserver] Procesando resumen para empleado', empId, 'mes', mes, 'a√±o', anio);
                
                if (typeof CalculadorHorasInteligente !== 'undefined') {
                    // üîß Cargar empleado desde localStorage, fallback a array global
                    const empleadosActuales = JSON.parse(localStorage.getItem('empleadosData') || '[]');
                    const empleadoActual = empleadosActuales.find(e => e.id === empId) || empleados.find(e => e.id === empId);
                    
                    if (empleadoActual) {
                        console.log('[ResumenObserver] Empleado encontrado:', empleadoActual.nombre, 'Contrato:', empleadoActual.horasContrato, 'h');
                    }
                    
                    const resumen = CalculadorHorasInteligente.calcularResumenMensual(empId, mes, anio);
                    if (resumen) {
                        console.log('[ResumenObserver] Resumen calculado - Contrato:', resumen.horasContrato, 'h | Trabajadas:', resumen.totalHorasTrabajadas.toFixed(2), 'h | Guardias:', resumen.diasGuardias);
                        // üîß Pasar empleadoActual para que use horasContrato directo del empleado
                        const htmlResumen = CalculadorHorasInteligente.generarResumenHTML(resumen, empleadoActual);
                        div.innerHTML = htmlResumen;
                        console.log('[ResumenObserver] Resumen procesado correctamente');
                    } else {
                        console.warn('[ResumenObserver] Resumen nulo para empleado', empId);
                    }
                }
            } catch(e) {
                console.warn('[ResumenObserver] Error procesando resumen:', e);
                console.error(e.stack);
            }
        }
        
        // Iniciar cuando todo est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarObservadorResumenes);
        } else {
            setTimeout(inicializarObservadorResumenes, 500);
        }
    </script>
    
    <!-- üîí PROTECCI√ìN v11.2: Garantizar TurnoManager + Protecci√≥n Auto-Gen -->
    <script>
        console.log('üîí [PROTECCI√ìN v11.2] Verificando TurnoManager y asegurando disponibilidad de funciones');
        
        // Crear TurnoManager si no existe
        if (!window.TurnoManager) {
            console.warn('‚ö†Ô∏è TurnoManager no existente, creando objeto');
            window.TurnoManager = {};
        }
        
        // Esperar a que las funciones est√©n disponibles
        let checkCount = 0;
        const maxChecks = 20;  // 2 segundos de espera
        
        const ensureTurnoManagerFunctions = () => {
            checkCount++;
            console.log(`[PROTECCI√ìN] Check ${checkCount}/${maxChecks}: Verificando funciones disponibles...`);
            
            // Verificar si las funciones clave existen
            const funcionesRequeridas = [
                'inicializarDatos',
                'reiniciarDatos',
                'generarTurnosEmpleado',
                'esCuadranteVacio',
                'mostrarModalGeneracion',
                'cerrarModalGeneracion',
                'generarTurnos',
                'verificarYMostrarBoton'
            ];
            
            const funcionesFaltantes = funcionesRequeridas.filter(f => 
                !window.TurnoManager[f] || typeof window.TurnoManager[f] !== 'function'
            );
            
            if (funcionesFaltantes.length === 0) {
                console.log('‚úÖ [PROTECCI√ìN] ¬°TODAS las funciones de TurnoManager est√°n disponibles!');
                console.log('   - inicializarDatos ‚úì');
                console.log('   - reiniciarDatos ‚úì');
                console.log('   - generarTurnosEmpleado ‚úì');
                console.log('   - esCuadranteVacio ‚úì');
                console.log('   - mostrarModalGeneracion ‚úì');
                console.log('   - cerrarModalGeneracion ‚úì');
                console.log('   - generarTurnos ‚úì');
                console.log('   - verificarYMostrarBoton ‚úì');
                instalarProtecciones();
            } else if (checkCount < maxChecks) {
                console.log(`‚è≥ [PROTECCI√ìN] Funciones faltantes: ${funcionesFaltantes.join(', ')} - Esperando...`);
                setTimeout(ensureTurnoManagerFunctions, 100);
            } else {
                console.error(`‚ùå [PROTECCI√ìN] TIMEOUT: Las siguientes funciones NO existen: ${funcionesFaltantes.join(', ')}`);
                console.error('[PROTECCI√ìN] Esto causar√° error al hacer clic en bot√≥n del modal');
            }
        };
        
        function instalarProtecciones() {
            console.log('üîí [PROTECCI√ìN] Instalando protecciones contra auto-generaci√≥n...');
            
            // Guardar las funciones originales
            const originalInitialize = window.TurnoManager.inicializarDatos;
            const originalGenerarTurnos = window.TurnoManager.generarTurnos;
            let autoGenerationEnabled = false;
            
            // Proteger inicializarDatos
            window.TurnoManager.inicializarDatos = function() {
                if (!autoGenerationEnabled) {
                    console.warn('‚ö†Ô∏è [PROTECCI√ìN] inicializarDatos() bloqueado - Use bot√≥n "Generar Turnos"');
                    return;
                }
                console.log('‚úÖ [PROTECCI√ìN] inicializarDatos() AUTORIZADO - ejecutando');
                return originalInitialize.call(this);
            };
            
            // Permitir generarTurnos para autorizar inicializarDatos
            window.TurnoManager.generarTurnos = async function() {
                console.log('üü¢ [PROTECCI√ìN] generarTurnos() invocado - AUTORIZANDO inicializarDatos()');
                autoGenerationEnabled = true;
                try {
                    const resultado = await originalGenerarTurnos.call(this);
                    console.log('‚úÖ [PROTECCI√ìN] generarTurnos() completado EXITOSAMENTE');
                    return resultado;
                } catch (err) {
                    console.error('‚ùå [PROTECCI√ìN] Error en generarTurnos():', err);
                    throw err;
                } finally {
                    autoGenerationEnabled = false;
                    console.log('üîí [PROTECCI√ìN] Reactivando bloqueo de inicializarDatos()');
                }
            };
            
            console.log('‚úÖ [PROTECCI√ìN] Protecciones instaladas correctamente');
            console.log('   - inicializarDatos() est√° BLOQUEADO a menos que se llame desde generarTurnos()');
            console.log('   - El modal podr√° generar turnos cuando el usuario haga clic');
        }
        
        // Iniciar verificaci√≥n
        ensureTurnoManagerFunctions();
    </script>

    <!-- Funciones Globales del Sidebar para compatibilidad -->
    <script>
        // Funciones globales para botones del sidebar
        
        if (typeof abrirValidacion === 'undefined') {
            window.abrirValidacion = function() {
                alert('‚è≥ Funci√≥n "Validaci√≥n" en desarrollo\n\nEsta funci√≥n validar√° la integridad de los datos de empleados y turnos.');
            };
        }

        if (typeof abrirAutoGuardado === 'undefined') {
            window.abrirAutoGuardado = function() {
                alert('‚è≥ Funci√≥n "Auto-guardado" en desarrollo\n\nEsta funci√≥n mostrar√° el estado del guardado autom√°tico.');
            };
        }

        if (typeof abrirMetricas === 'undefined') {
            window.abrirMetricas = function() {
                let html = 'üìä M√©tricas del Sistema\n\n';
                if (empleados && empleados.length > 0) {
                    let totalHoras = 0;
                    let totalTurnosNoche = 0;
                    let empleadosActivos = empleados.filter(e => e.estado === 'activo').length;
                    
                    empleados.forEach(emp => {
                        const turnos = AppState.scheduleData.get(emp.id) || [];
                        const mesActual = AppState.currentMonth;
                        const anioActual = AppState.currentYear;
                        
                        turnos.forEach(t => {
                            const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                            if (fecha.getMonth() === mesActual && fecha.getFullYear() === anioActual) {
                                totalHoras += (t.horas || 0);
                                if (t.turno === 'noche') totalTurnosNoche++;
                            }
                        });
                    });
                    
                    html += `‚úì Empleados Activos: ${empleadosActivos}\n`;
                    html += `‚úì Horas Totales: ${Math.round(totalHoras)}h\n`;
                    html += `‚úì Turnos Noche: ${totalTurnosNoche}\n`;
                } else {
                    html += 'No hay empleados registrados';
                }
                alert(html);
            };
        }

        if (typeof abrirCalendario === 'undefined') {
            window.abrirCalendario = function() {
                alert('‚è≥ Funci√≥n "Calendario" en desarrollo\n\nEsta funci√≥n permitir√° exportar iCalendar para cada empleado.');
            };
        }
    </script>
</body>
</html>
