<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Debug - Error Capture</title>
    <link rel="stylesheet" href="css/estilos.css">
    <style>
        body { margin: 0; padding: 20px; background: #1a1a1a; color: #fff; font-family: monospace; }
        #log { background: #2a2a2a; padding: 20px; border: 2px solid #00ff00; min-height: 400px; max-height: 600px; overflow-y: auto; }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .info { color: #74c0fc; }
        button { margin: 5px; padding: 8px 15px; background: #3498db; color: white; border: none; cursor: pointer; }
        button:hover { background: #2980b9; }
    </style>
</head>
<body>
    <h1>üîç Debug - Captura de Errores</h1>
    <button onclick="test1()">Test 1: Variables Globales</button>
    <button onclick="test2()">Test 2: Llamar M√©todo</button>
    <button onclick="test3()">Test 3: Inspeccionar Modal</button>
    <button onclick="clearLog()">Limpiar</button>
    
    <div id="log"></div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/modules.js"></script>
    <script src="js/balanceo-y-restricciones.js"></script>
    <script src="js/reportes-y-prediccion.js"></script>
    <script src="js/soporte-multilocal.js"></script>

    <script>
        const logDiv = document.getElementById('log');
        
        // Capture TODOS los errores
        window.addEventListener('error', (event) => {
            log(`[UNCAUGHT ERROR] ${event.message} en ${event.filename}:${event.lineno}`, 'error');
            log(`Stack: ${event.error?.stack}`, 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            log(`[UNHANDLED REJECTION] ${event.reason}`, 'error');
        });

        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const span = document.createElement('div');
            span.className = type;
            span.textContent = `[${time}] ${msg}`;
            logDiv.appendChild(span);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }

        function clearLog() {
            logDiv.innerHTML = '';
        }

        function test1() {
            log('=== TEST 1: VARIABLES GLOBALES ===', 'info');
            try {
                log(`window.GestorLocales: ${typeof window.GestorLocales}`, window.GestorLocales ? 'success' : 'error');
                log(`window.GestorDepartamentos: ${typeof window.GestorDepartamentos}`, window.GestorDepartamentos ? 'success' : 'error');
                log(`window.AppState: ${typeof window.AppState}`, window.AppState ? 'success' : 'error');
                log(`window.NotificationSystem: ${typeof window.NotificationSystem}`, window.NotificationSystem ? 'success' : 'error');
                
                if (typeof window.GestorLocales !== 'undefined') {
                    log(`GestorLocales.mostrarModalGesti√≥n: ${typeof GestorLocales.mostrarModalGesti√≥n}`, 'info');
                    log(`GestorLocales.locales: ${Array.isArray(GestorLocales.locales)}`, 'info');
                    log(`GestorLocales.localActualId: ${GestorLocales.localActualId}`, 'info');
                }
                
                if (typeof window.AppState !== 'undefined') {
                    log(`AppState.userRole: ${AppState.userRole}`, 'info');
                    log(`AppState.canEditShifts: ${typeof AppState.canEditShifts}`, 'info');
                    try {
                        const result = AppState.canEditShifts();
                        log(`AppState.canEditShifts() = ${result}`, result ? 'success' : 'error');
                    } catch (e) {
                        log(`Error al llamar canEditShifts: ${e.message}`, 'error');
                    }
                }
            } catch (e) {
                log(`ERROR en Test 1: ${e.message}`, 'error');
                log(`Stack: ${e.stack}`, 'error');
            }
        }

        function test2() {
            log('=== TEST 2: LLAMAR M√âTODO ===', 'info');
            try {
                if (typeof GestorLocales.mostrarModalGesti√≥n !== 'function') {
                    throw new Error('mostrarModalGesti√≥n no es una funci√≥n');
                }
                
                log('Llamando GestorLocales.mostrarModalGesti√≥n()...', 'info');
                GestorLocales.mostrarModalGesti√≥n();
                log('‚úì Funci√≥n ejecutada sin errores', 'success');
                
                setTimeout(test3, 500);
            } catch (e) {
                log(`ERROR: ${e.message}`, 'error');
                log(`Stack: ${e.stack}`, 'error');
            }
        }

        function test3() {
            log('=== TEST 3: INSPECCIONAR MODAL ===', 'info');
            try {
                const modal = document.getElementById('modalGestionLocales');
                if (modal) {
                    log('‚úì Modal encontrado en el DOM', 'success');
                    log(`  - tagName: ${modal.tagName}`, 'info');
                    log(`  - id: ${modal.id}`, 'info');
                    log(`  - className: ${modal.className}`, 'info');
                    
                    const computed = window.getComputedStyle(modal);
                    log(`  - display: ${computed.display}`, 'info');
                    log(`  - position: ${computed.position}`, 'info');
                    log(`  - zIndex: ${computed.zIndex}`, 'info');
                    log(`  - visibility: ${computed.visibility}`, 'info');
                    log(`  - offsetParent !== null: ${modal.offsetParent !== null}`, modal.offsetParent !== null ? 'success' : 'error');
                    
                    const rect = modal.getBoundingClientRect();
                    log(`  - left: ${rect.left}, top: ${rect.top}, width: ${rect.width}, height: ${rect.height}`, 'info');
                    
                } else {
                    log('‚úó Modal NO encontrado en el DOM', 'error');
                    const all = document.querySelectorAll('.modal');
                    log(`Modales en la p√°gina: ${all.length}`, 'error');
                }
            } catch (e) {
                log(`ERROR: ${e.message}`, 'error');
                log(`Stack: ${e.stack}`, 'error');
            }
        }

        // Auto-run test 1
        window.addEventListener('load', () => {
            log('P√ÅGINA LISTA', 'success');
            setTimeout(() => test1(), 100);
        });
    </script>
</body>
</html>
