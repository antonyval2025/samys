<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Detallado - Antony</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .output { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; white-space: pre-wrap; max-height: 600px; overflow-y: auto; border: 1px solid #dee2e6; font-size: 12px; line-height: 1.4; }
        button { padding: 12px 24px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; }
        button:hover { background: linear-gradient(135deg, #0056b3 0%, #004085 100%); }
        button.danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        button.danger:hover { background: linear-gradient(135deg, #c82333 0%, #a02622 100%); }
        .section { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
        h1 { color: #333; text-align: center; }
        h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .step { margin: 10px 0; padding: 10px; background: #e9ecef; border-radius: 3px; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Diagn√≥stico Detallado - Problema Antony</h1>
        <p>Este diagn√≥stico rastrea cada paso de la inicializaci√≥n para encontrar d√≥nde se pierde el cambio de turno.</p>

        <div class="section">
            <button onclick="ejecutarDiagnosticoCompleto()">üîç Diagn√≥stico Completo</button>
            <button onclick="simularCambioAntony()">üé≠ Simular Cambio Antony</button>
            <button onclick="verificarPersistencia()">üíæ Verificar Persistencia</button>
            <button class="danger" onclick="limpiarTodo()">üóëÔ∏è Limpiar Todo</button>
            <button onclick="abrirAplicacion()">üì± Abrir Aplicaci√≥n</button>
        </div>

        <h2>Resultado del Diagn√≥stico:</h2>
        <div class="output" id="output">Haz clic en "Diagn√≥stico Completo" para comenzar...</div>

        <div class="section">
            <h3>üìã Pasos del Diagn√≥stico:</h3>
            <div class="step">1. Verificar localStorage antes de inicializaci√≥n</div>
            <div class="step">2. Simular carga de AppState.loadFromStorage()</div>
            <div class="step">3. Simular TurnoManager.inicializarDatos()</div>
            <div class="step">4. Verificar estado despu√©s de inicializaci√≥n</div>
            <div class="step">5. Comparar con estado guardado</div>
        </div>
    </div>

    <script src="js/modules.js"></script>
    <script>
        // Inicializar empleados con la lista completa
        window.empleados = [
            { id: 1, nombre: "Empleado 1", localidad: "Madrid", horasContrato: 160 },
            { id: 2, nombre: "Empleado 2", localidad: "Madrid", horasContrato: 160 },
            { id: 3, nombre: "Empleado 3", localidad: "Madrid", horasContrato: 160 },
            { id: 4, nombre: "Empleado 4", localidad: "Madrid", horasContrato: 160 },
            { id: 5, nombre: "Empleado 5", localidad: "Madrid", horasContrato: 160 },
            { id: 6, nombre: "Empleado 6", localidad: "Madrid", horasContrato: 160 },
            { id: 7, nombre: "Empleado 7", localidad: "Madrid", horasContrato: 160 },
            { id: 8, nombre: "antony valencia", localidad: "Madrid", horasContrato: 154 }
        ];

        // Inicializar AppState
        AppState.currentYear = new Date().getFullYear();
        AppState.currentMonth = new Date().getMonth();

        let diagnosticoPaso = 0;

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const formattedMessage = `[${timestamp}] ${message}`;
            output.textContent += formattedMessage + '\n';
            console.log(formattedMessage);

            // Auto-scroll
            output.scrollTop = output.scrollHeight;
        }

        function ejecutarDiagnosticoCompleto() {
            document.getElementById('output').textContent = '';
            diagnosticoPaso = 0;

            log('üöÄ === INICIANDO DIAGN√ìSTICO COMPLETO ===');
            log(`üìÖ Fecha actual: ${new Date().toLocaleString()}`);
            log(`üåê Ejecut√°ndose desde: ${window.location.href}`);
            log(`üìä Mes/a√±o actual: ${AppState.currentMonth}/${AppState.currentYear}`);
            log('');

            // Paso 1: Verificar localStorage crudo
            paso1_verificarLocalStorageCrudo();

            // Paso 2: Simular loadFromStorage
            setTimeout(() => paso2_simularLoadFromStorage(), 500);

            // Paso 3: Simular inicializarDatos
            setTimeout(() => paso3_simularInicializarDatos(), 1000);

            // Paso 4: Verificar estado final
            setTimeout(() => paso4_verificarEstadoFinal(), 1500);

            // Paso 5: Comparar con localStorage
            setTimeout(() => paso5_compararConLocalStorage(), 2000);
        }

        function paso1_verificarLocalStorageCrudo() {
            log('üì¶ PASO 1: Verificando localStorage crudo...');

            try {
                const saved = localStorage.getItem('turnosAppState');
                if (saved) {
                    const state = JSON.parse(saved);
                    log('‚úÖ Datos encontrados en localStorage');
                    log(`üìä Empleados guardados: ${state.scheduleData ? state.scheduleData.length : 0}`);
                    log(`üìÖ Mes/a√±o guardado: ${state.month}/${state.year}`);

                    // Buscar Antony espec√≠ficamente
                    if (state.scheduleData) {
                        const antonyData = state.scheduleData.find(([id]) => id === 8);
                        if (antonyData) {
                            const [id, turnos] = antonyData;
                            log(`üë§ Antony (ID ${id}) encontrado con ${turnos.length} turnos`);

                            const turno30 = turnos.find(t => t.dia === 30);
                            if (turno30) {
                                log(`üìÖ D√≠a 30 de Antony: ${turno30.turno} (Fecha: ${turno30.fecha})`);
                            } else {
                                log('‚ùå D√≠a 30 de Antony NO encontrado');
                            }
                        } else {
                            log('‚ùå Antony NO encontrado en localStorage');
                        }
                    }
                } else {
                    log('‚ùå No hay datos en localStorage');
                }
            } catch (error) {
                log(`‚ùå Error en localStorage: ${error.message}`, 'error');
            }

            log('');
        }

        function paso2_simularLoadFromStorage() {
            log('üì• PASO 2: Simulando AppState.loadFromStorage()...');

            try {
                // Limpiar AppState primero
                AppState.scheduleData = new Map();

                // Ejecutar loadFromStorage
                AppState.loadFromStorage();

                log(`‚úÖ loadFromStorage completado`);
                log(`üìä Empleados en AppState: ${AppState.scheduleData.size}`);

                // Verificar Antony
                const turnosAntony = AppState.scheduleData.get(8);
                if (turnosAntony) {
                    log(`üë§ Antony tiene ${turnosAntony.length} turnos en AppState`);

                    const turno30 = turnosAntony.find(t => t.dia === 30);
                    if (turno30) {
                        log(`üìÖ D√≠a 30 de Antony en AppState: ${turno30.turno}`);
                        log(`üìÖ Fecha del turno: ${turno30.fecha} (mes: ${turno30.fecha.getMonth()}, a√±o: ${turno30.fecha.getFullYear()})`);
                    } else {
                        log('‚ùå D√≠a 30 de Antony NO encontrado en AppState');
                    }
                } else {
                    log('‚ùå Antony NO encontrado en AppState');
                }

            } catch (error) {
                log(`‚ùå Error en loadFromStorage: ${error.message}`, 'error');
            }

            log('');
        }

        function paso3_simularInicializarDatos() {
            log('üîÑ PASO 3: Simulando TurnoManager.inicializarDatos()...');

            try {
                // Verificar estado antes de inicializar
                const turnosAntonyAntes = AppState.scheduleData.get(8);
                if (turnosAntonyAntes) {
                    const turno30Antes = turnosAntonyAntes.find(t => t.dia === 30);
                    log(`üìÖ D√≠a 30 de Antony ANTES de inicializar: ${turno30Antes ? turno30Antes.turno : 'NO ENCONTRADO'}`);
                }

                // Ejecutar inicializarDatos
                TurnoManager.inicializarDatos();

                log(`‚úÖ inicializarDatos completado`);

                // Verificar estado despu√©s
                const turnosAntonyDespues = AppState.scheduleData.get(8);
                if (turnosAntonyDespues) {
                    const turno30Despues = turnosAntonyDespues.find(t => t.dia === 30);
                    log(`üìÖ D√≠a 30 de Antony DESPU√âS de inicializar: ${turno30Despues ? turno30Despues.turno : 'NO ENCONTRADO'}`);
                }

            } catch (error) {
                log(`‚ùå Error en inicializarDatos: ${error.message}`, 'error');
            }

            log('');
        }

        function paso4_verificarEstadoFinal() {
            log('üéØ PASO 4: Verificando estado final en AppState...');

            log(`üìä Total empleados en AppState: ${AppState.scheduleData.size}`);
            log(`üìÖ Mes/a√±o actual: ${AppState.currentMonth}/${AppState.currentYear}`);

            // Verificar todos los empleados
            AppState.scheduleData.forEach((turnos, id) => {
                const empleado = empleados.find(e => e.id === id);
                const nombre = empleado ? empleado.nombre : `ID ${id}`;

                const turno30 = turnos.find(t => t.dia === 30);
                if (turno30) {
                    log(`  ${nombre} (ID ${id}) - D√≠a 30: ${turno30.turno}`);
                }
            });

            log('');
        }

        function paso5_compararConLocalStorage() {
            log('üîç PASO 5: Comparando AppState con localStorage...');

            try {
                const saved = localStorage.getItem('turnosAppState');
                if (saved) {
                    const state = JSON.parse(saved);

                    if (state.scheduleData) {
                        log('Comparando cada empleado:');

                        // Comparar Antony espec√≠ficamente
                        const antonyAppState = AppState.scheduleData.get(8);
                        const antonyStorage = state.scheduleData.find(([id]) => id === 8);

                        if (antonyAppState && antonyStorage) {
                            const [id, turnosStorage] = antonyStorage;
                            const turno30AppState = antonyAppState.find(t => t.dia === 30);
                            const turno30Storage = turnosStorage.find(t => t.dia === 30);

                            log(`üë§ Antony - AppState d√≠a 30: ${turno30AppState ? turno30AppState.turno : 'NO ENCONTRADO'}`);
                            log(`üë§ Antony - Storage d√≠a 30: ${turno30Storage ? turno30Storage.turno : 'NO ENCONTRADO'}`);

                            if (turno30AppState && turno30Storage) {
                                if (turno30AppState.turno === turno30Storage.turno) {
                                    log('‚úÖ Turno de Antony coincide entre AppState y Storage', 'success');
                                } else {
                                    log(`‚ùå DISCREPANCIA: AppState=${turno30AppState.turno}, Storage=${turno30Storage.turno}`, 'error');
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                log(`‚ùå Error comparando: ${error.message}`, 'error');
            }

            log('');
            log('üèÅ === DIAGN√ìSTICO COMPLETADO ===');
        }

        function simularCambioAntony() {
            log('üé≠ SIMULANDO CAMBIO DE TURNOS...');

            try {
                // Buscar Antony
                const antony = empleados.find(e => e.nombre.toLowerCase().includes('antony'));
                if (!antony) {
                    log('‚ùå Antony no encontrado', 'error');
                    return;
                }

                log(`‚úÖ Antony encontrado: ${antony.nombre} (ID: ${antony.id})`);

                // Obtener turnos actuales
                const turnos = AppState.scheduleData.get(antony.id) || [];
                const turno30 = turnos.find(t => t.dia === 30);

                if (!turno30) {
                    log('‚ùå D√≠a 30 no encontrado para Antony', 'error');
                    return;
                }

                const turnoAnterior = turno30.turno;
                turno30.turno = 'asuntos_propios'; // Cambiar a asuntos propios

                // Guardar
                AppState.scheduleData.set(antony.id, turnos);
                AppState.saveToStorage();

                log(`‚úÖ Turno cambiado: ${turnoAnterior} ‚Üí ${turno30.turno}`, 'success');
                log('üíæ Cambios guardados en localStorage');

            } catch (error) {
                log(`‚ùå Error simulando cambio: ${error.message}`, 'error');
            }
        }

        function verificarPersistencia() {
            log('üíæ VERIFICANDO PERSISTENCIA...');

            try {
                // Recargar desde localStorage
                AppState.loadFromStorage();

                const turnosAntony = AppState.scheduleData.get(8);
                if (turnosAntony) {
                    const turno30 = turnosAntony.find(t => t.dia === 30);
                    if (turno30) {
                        log(`üìÖ D√≠a 30 de Antony despu√©s de recargar: ${turno30.turno}`);
                        if (turno30.turno === 'asuntos_propios') {
                            log('‚úÖ Cambio persisti√≥ correctamente', 'success');
                        } else {
                            log(`‚ùå Cambio NO persisti√≥. Esperado: asuntos_propios, Actual: ${turno30.turno}`, 'error');
                        }
                    } else {
                        log('‚ùå D√≠a 30 no encontrado despu√©s de recargar', 'error');
                    }
                } else {
                    log('‚ùå Antony no encontrado despu√©s de recargar', 'error');
                }

            } catch (error) {
                log(`‚ùå Error verificando persistencia: ${error.message}`, 'error');
            }
        }

        function limpiarTodo() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar todo localStorage y reiniciar AppState?')) {
                localStorage.clear();
                AppState.scheduleData = new Map();
                AppState.selectedEmployee = null;
                log('üóëÔ∏è Todo limpiado', 'warning');
            }
        }

        function abrirAplicacion() {
            window.open('nuevo_cuadrante_mejorado.html', '_blank');
        }

        // Auto-ejecutar diagn√≥stico b√°sico al cargar
        setTimeout(() => {
            if (document.getElementById('output').textContent.includes('Haz clic')) {
                ejecutarDiagnosticoCompleto();
            }
        }, 1000);
    </script>
</body>
</html>