<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>TEST - Sistema de Persistencia de Datos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #fff; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #10b981; margin-bottom: 20px; text-align: center; }
        .status-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .status-item { flex: 1; min-width: 200px; padding: 15px; border-radius: 8px; background: #2a2a2a; }
        .status-ok { border-left: 4px solid #10b981; }
        .status-error { border-left: 4px solid #ef4444; }
        .status-pending { border-left: 4px solid #f59e0b; }
        .status-label { font-weight: bold; margin-bottom: 5px; }
        .status-value { font-size: 0.9em; opacity: 0.8; }
        .section { margin-bottom: 30px; padding: 20px; background: #2a2a2a; border-radius: 8px; }
        .section h2 { color: #10b981; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #444; background: #1a1a1a; color: #fff; border-radius: 4px; font-family: inherit; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #10b981; }
        button { padding: 10px 20px; margin-right: 10px; margin-bottom: 10px; background: #10b981; color: #000; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: #059669; }
        button.danger { background: #ef4444; }
        button.danger:hover { background: #dc2626; }
        button.secondary { background: #6b7280; }
        button.secondary:hover { background: #4b5563; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #444; }
        th { background: #1a1a1a; font-weight: bold; color: #10b981; }
        tr:hover { background: #333; }
        .log-box { background: #1a1a1a; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 0.85em; max-height: 300px; overflow-y: auto; border: 1px solid #444; }
        .log-item { margin-bottom: 5px; padding: 5px; border-left: 3px solid #666; padding-left: 10px; }
        .log-success { border-left-color: #10b981; color: #10b981; }
        .log-error { border-left-color: #ef4444; color: #ef4444; }
        .log-info { border-left-color: #3b82f6; color: #3b82f6; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ TEST - PERSISTENCIA DE DATOS</h1>
        
        <!-- STATUS BAR -->
        <div class="status-bar">
            <div class="status-item status-pending" id="apiStatus">
                <div class="status-label">API Backend</div>
                <div class="status-value">Verificando...</div>
            </div>
            <div class="status-item status-pending" id="bdStatus">
                <div class="status-label">Base de Datos</div>
                <div class="status-value">Verificando...</div>
            </div>
            <div class="status-item status-pending" id="dataStatus">
                <div class="status-label">Datos Cargados</div>
                <div class="status-value">Verificando...</div>
            </div>
        </div>

        <!-- LOGS -->
        <div class="section">
            <h2>üìã LOGS DEL SISTEMA</h2>
            <div class="log-box" id="logBox"></div>
        </div>

        <div class="grid">
            <!-- PRUEBA 1: CREAR EMPLEADO -->
            <div class="section">
                <h2>üë§ PRUEBA 1: Crear Empleado</h2>
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="empNombre" placeholder="Juan P√©rez" value="TestUser_">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="empEmail" placeholder="email@example.com" value="test@example.com">
                </div>
                <div class="form-group">
                    <label>Tel√©fono</label>
                    <input type="text" id="empTelefono" placeholder="123456789" value="123456789">
                </div>
                <div class="form-group">
                    <label>Horas de Contrato</label>
                    <input type="number" id="empHoras" placeholder="160" value="160">
                </div>
                <button onclick="crearEmpleado()">‚úÖ Crear Empleado</button>
            </div>

            <!-- PRUEBA 2: CREAR TURNO -->
            <div class="section">
                <h2>üìÖ PRUEBA 2: Crear Turno</h2>
                <div class="form-group">
                    <label>Empleado ID</label>
                    <input type="number" id="turnoEmpleadoId" placeholder="1" value="1">
                </div>
                <div class="form-group">
                    <label>Tipo de Turno</label>
                    <select id="turnoTipo">
                        <option value="ma√±ana">Ma√±ana (08:00-16:00)</option>
                        <option value="tarde">Tarde (16:00-00:00)</option>
                        <option value="noche">Noche (00:00-08:00)</option>
                        <option value="descanso">Descanso</option>
                        <option value="vacaciones">Vacaciones</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>D√≠a (1-31)</label>
                    <input type="number" id="turnoDia" placeholder="5" value="5" min="1" max="31">
                </div>
                <div class="form-group">
                    <label>Horas</label>
                    <input type="number" id="turnoHoras" placeholder="8" value="8" step="0.5">
                </div>
                <button onclick="crearTurno()">‚úÖ Crear Turno</button>
            </div>
        </div>

        <!-- PRUEBA 3: VER DATOS ACTUALES -->
        <div class="section">
            <h2>üìä PRUEBA 3: Ver Datos Actuales</h2>
            <button onclick="cargarDatos()">üîÑ Recargar Datos</button>
            <button onclick="guardarEnBD()" class="secondary">üíæ Guardar Todo en BD</button>
            <button onclick="limpiarDatos()" class="danger">üóëÔ∏è Limpiar Datos</button>
            
            <div id="datosContainer"></div>
        </div>

        <!-- PRUEBA 4: TEST DE PERSISTENCIA -->
        <div class="section">
            <h2>üîÑ PRUEBA 4: Test de Persistencia</h2>
            <p style="margin-bottom: 15px; opacity: 0.8;">Haz cambios, luego recarga la p√°gina. Si los cambios persisten, el sistema funciona correctamente.</p>
            <button onclick="generarTestData()">üìù Generar Datos de Test</button>
            <button onclick="verificarPersistencia()" class="secondary">‚úì Verificar Persistencia</button>
            <div id="persistenceResult" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5001/api/turnos';
        const logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('es-ES');
            logs.unshift(`[${timestamp}] ${message}`);
            updateLogs();
            console.log(`[${type}] ${message}`);
        }

        function updateLogs() {
            const logBox = document.getElementById('logBox');
            logBox.innerHTML = logs.map((l, i) => {
                let type = 'info';
                if (l.includes('‚úÖ') || l.includes('OK')) type = 'success';
                if (l.includes('‚ùå') || l.includes('ERROR')) type = 'error';
                return `<div class="log-item log-${type}">${l}</div>`;
            }).join('');
        }

        async function checkApiStatus() {
            try {
                const res = await fetch(`${API_URL}/1`);
                if (res.ok) {
                    setStatus('apiStatus', 'ok', 'API Respondiendo ‚úÖ');
                    log('‚úÖ API est√° respondiendo correctamente');
                    return true;
                } else {
                    setStatus('apiStatus', 'error', `Error ${res.status}`);
                    log(`‚ùå API respondi√≥ con error ${res.status}`);
                    return false;
                }
            } catch (e) {
                setStatus('apiStatus', 'error', 'No conecta');
                log(`‚ùå No se puede conectar a API: ${e.message}`);
                return false;
            }
        }

        function setStatus(elementId, status, message) {
            const el = document.getElementById(elementId);
            el.className = `status-item status-${status}`;
            el.innerHTML = `<div class="status-label">${el.querySelector('.status-label').textContent}</div><div class="status-value">${message}</div>`;
        }

        async function cargarDatos() {
            log('üîÑ Cargando datos...');
            try {
                const empleados = JSON.parse(localStorage.getItem('empleadosData') || '[]');
                setStatus('bdStatus', 'ok', `${empleados.length} empleados`);
                log(`‚úÖ ${empleados.length} empleados cargados`);

                let html = '<h3>Empleados Registrados:</h3>';
                html += '<table><tr><th>ID</th><th>Nombre</th><th>Email</th><th>Tel√©fono</th><th>Horas</th><th>Acciones</th></tr>';
                
                empleados.forEach(emp => {
                    html += `<tr>
                        <td>${emp.id}</td>
                        <td>${emp.nombre}</td>
                        <td>${emp.email}</td>
                        <td>${emp.telefono}</td>
                        <td>${emp.horasContrato}</td>
                        <td><button onclick="eliminarEmpleado(${emp.id})" class="danger">Eliminar</button></td>
                    </tr>`;
                });
                html += '</table>';

                document.getElementById('datosContainer').innerHTML = html;
                setStatus('dataStatus', 'ok', `${empleados.length} empleados`);
            } catch (e) {
                log(`‚ùå Error cargando datos: ${e.message}`);
                setStatus('dataStatus', 'error', 'Error al cargar');
            }
        }

        async function crearEmpleado() {
            const nombre = document.getElementById('empNombre').value + Date.now();
            const email = document.getElementById('empEmail').value;
            const telefono = document.getElementById('empTelefono').value;
            const horas = parseInt(document.getElementById('empHoras').value);

            if (!nombre || !email || !telefono || !horas) {
                log('‚ùå Faltan datos del empleado');
                return;
            }

            try {
                const empleados = JSON.parse(localStorage.getItem('empleadosData') || '[]');
                const nuevoId = Math.max(...empleados.map(e => e.id || 0)) + 1;
                
                const empleado = { id: nuevoId, nombre, email, telefono, horasContrato: horas };
                empleados.push(empleado);
                
                localStorage.setItem('empleadosData', JSON.stringify(empleados));
                log(`‚úÖ Empleado "${nombre}" creado con ID ${nuevoId}`);
                
                await cargarDatos();
            } catch (e) {
                log(`‚ùå Error creando empleado: ${e.message}`);
            }
        }

        async function crearTurno() {
            const empleadoId = parseInt(document.getElementById('turnoEmpleadoId').value);
            const tipo = document.getElementById('turnoTipo').value;
            const dia = parseInt(document.getElementById('turnoDia').value);
            const horas = parseFloat(document.getElementById('turnoHoras').value);

            if (!empleadoId || !tipo || !dia) {
                log('‚ùå Faltan datos del turno');
                return;
            }

            try {
                const ahora = new Date();
                const fecha = new Date(ahora.getFullYear(), ahora.getMonth(), dia);
                
                const turno = {
                    dia,
                    turno: tipo,
                    horas,
                    horario: '08:00-16:00',
                    fecha: fecha.toISOString(),
                    esFinSemana: [0, 6].includes(fecha.getDay())
                };

                // Guardar en API
                const res = await fetch(`${API_URL}/${empleadoId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        empleadoId,
                        mes: ahora.getMonth(),
                        anio: ahora.getFullYear(),
                        turnos: [turno]
                    })
                });

                if (res.ok) {
                    log(`‚úÖ Turno ${tipo} creado para empleado ${empleadoId} (d√≠a ${dia})`);
                } else {
                    log(`‚ùå Error al crear turno: ${res.status}`);
                }
            } catch (e) {
                log(`‚ùå Error: ${e.message}`);
            }
        }

        async function guardarEnBD() {
            log('üíæ Guardando todos los datos en BD...');
            try {
                const empleados = JSON.parse(localStorage.getItem('empleadosData') || '[]');
                let guardados = 0;

                for (let emp of empleados) {
                    const res = await fetch(`${API_URL}/${emp.id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            empleadoId: emp.id,
                            mes: new Date().getMonth(),
                            anio: new Date().getFullYear(),
                            turnos: []
                        })
                    });
                    if (res.ok) guardados++;
                }

                log(`‚úÖ ${guardados}/${empleados.length} empleados guardados en BD`);
            } catch (e) {
                log(`‚ùå Error guardando: ${e.message}`);
            }
        }

        function eliminarEmpleado(id) {
            if (confirm(`¬øEliminar empleado ${id}?`)) {
                const empleados = JSON.parse(localStorage.getItem('empleadosData') || '[]');
                const filtrados = empleados.filter(e => e.id !== id);
                localStorage.setItem('empleadosData', JSON.stringify(filtrados));
                log(`‚úÖ Empleado ${id} eliminado`);
                cargarDatos();
            }
        }

        function limpiarDatos() {
            if (confirm('¬øEliminar TODOS los datos del localStorage?')) {
                localStorage.clear();
                log('‚úÖ Datos locales eliminados');
                cargarDatos();
            }
        }

        async function generarTestData() {
            log('üìù Generando datos de test...');
            const testEmpleados = [
                { id: 100, nombre: 'TEST_Juan', email: 'juan@test.com', telefono: '111111111', horasContrato: 160 },
                { id: 101, nombre: 'TEST_Mar√≠a', email: 'maria@test.com', telefono: '222222222', horasContrato: 160 }
            ];
            
            localStorage.setItem('empleadosData', JSON.stringify(testEmpleados));
            log(`‚úÖ ${testEmpleados.length} empleados de test creados`);
            await cargarDatos();
        }

        async function verificarPersistencia() {
            log('‚úì Verificando persistencia...');
            const empleados = JSON.parse(localStorage.getItem('empleadosData') || '[]');
            
            const result = document.getElementById('persistenceResult');
            if (empleados.length > 0) {
                result.innerHTML = `<div style="color: #10b981;"><strong>‚úÖ PERSISTENCIA OK</strong><br>Se encontraron ${empleados.length} empleados en la BD despu√©s de recarga.</div>`;
                log(`‚úÖ Persistencia verificada: ${empleados.length} empleados encontrados`);
            } else {
                result.innerHTML = `<div style="color: #ef4444;"><strong>‚ùå NO HAY DATOS</strong><br>No se encontraron empleados. Genera datos de test primero.</div>`;
                log(`‚ùå No hay datos persistentes`);
            }
        }

        // Inicializar
        async function init() {
            log('üöÄ Iniciando test de persistencia...');
            await checkApiStatus();
            await cargarDatos();
        }

        init();
    </script>
</body>
</html>
