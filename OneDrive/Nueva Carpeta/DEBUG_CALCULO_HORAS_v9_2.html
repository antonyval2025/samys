<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug C√°lculo de Horas v9.2</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e293b; color: #f1f5f9; }
        .section { margin: 20px 0; padding: 15px; background: #0f172a; border-radius: 8px; border-left: 4px solid #a78bfa; }
        h2 { color: #a78bfa; margin-top: 0; }
        .datos { background: #1e293b; padding: 10px; margin: 10px 0; border-radius: 4px; font-size: 12px; }
        .error { color: #ff6b6b; }
        .ok { color: #51cf66; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #475569; padding: 8px; text-align: left; }
        th { background: #334155; }
    </style>
</head>
<body>

<h1>üîç Debug C√°lculo de Horas v9.2</h1>

<div class="section">
    <h2>Paso 1: Leer datos del localStorage</h2>
    <button onclick="analizarDatos()">Analizar Datos</button>
    <div id="output"></div>
</div>

<script>
function analizarDatos() {
    const output = document.getElementById('output');
    output.innerHTML = '';
    
    try {
        // 1. Cargar AppState
        const appStateJSON = localStorage.getItem('turnosAppState');
        const appState = appStateJSON ? JSON.parse(appStateJSON) : {};
        
        // 2. Cargar empleados
        const empleadosJSON = localStorage.getItem('empleadosData');
        const empleados = empleadosJSON ? JSON.parse(empleadosJSON) : [];
        
        // 3. Cargar tipos de turno
        const tiposTurnoJSON = localStorage.getItem('tiposTurnoData');
        const tiposTurno = tiposTurnoJSON ? JSON.parse(tiposTurnoJSON) : {};
        
        output.innerHTML += `<div class="datos">
            <strong>‚úÖ AppState cargado</strong><br>
            currentMonth: ${appState.currentMonth}<br>
            currentYear: ${appState.currentYear}
        </div>`;
        
        output.innerHTML += `<div class="datos">
            <strong>‚úÖ Empleados cargados:</strong> ${empleados.length}<br>
            ${empleados.map(e => `${e.nombre} (ID: ${e.id}, Contrato: ${e.horasContrato}h)`).join('<br>')}
        </div>`;
        
        output.innerHTML += `<div class="datos">
            <strong>‚úÖ Tipos de Turno:</strong><br>
            ${JSON.stringify(tiposTurno, null, 2)}
        </div>`;
        
        // 4. Analizar turnos del primer empleado (Antony)
        const mapSchedule = appState.scheduleData ? new Map(appState.scheduleData) : new Map();
        
        output.innerHTML += `<h3>An√°lisis de Turnos por Empleado:</h3>`;
        
        empleados.forEach(emp => {
            const turnos = mapSchedule.get(emp.id) || [];
            const mes = appState.currentMonth || 11; // diciembre
            const anio = appState.currentYear || 2025;
            
            output.innerHTML += `<h4>${emp.nombre} (ID: ${emp.id}) - ${anio}/${mes + 1}</h4>`;
            
            // Filtrar turnos del mes
            const turnosDelMes = (turnos || []).filter(t => {
                if (!t?.fecha) return false;
                const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                return fecha.getMonth() === mes && fecha.getFullYear() === anio;
            });
            
            output.innerHTML += `<div class="datos">
                <strong>Total de turnos en AppState:</strong> ${turnos.length}<br>
                <strong>Turnos del mes ${mes + 1}/${anio}:</strong> ${turnosDelMes.length}
            </div>`;
            
            // Calcular total de horas
            const totalHoras = turnosDelMes.reduce((sum, t) => sum + (t.horas || 0), 0);
            const totalHorasRedondeado = Math.round(totalHoras * 100) / 100;
            
            output.innerHTML += `<div class="datos">
                <strong>Total horas ${mes + 1}/${anio}:</strong> ${totalHorasRedondeado}h
            </div>`;
            
            // Mostrar tabla de turnos
            output.innerHTML += `<table>
                <tr>
                    <th>D√≠a</th>
                    <th>Turno</th>
                    <th>Horas</th>
                    <th>Horario</th>
                    <th>Fecha Guardada</th>
                </tr>
                ${turnosDelMes.map((t, i) => {
                    const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                    return `<tr>
                        <td>${t.dia || fecha.getDate()}</td>
                        <td>${t.turno || 'N/A'}</td>
                        <td>${t.horas || 0}h</td>
                        <td>${t.horario || 'N/A'}</td>
                        <td>${fecha.toLocaleDateString('es-ES')}</td>
                    </tr>`;
                }).join('')}
            </table>`;
        });
        
        // 5. Simular el filtro de enviarWhatsAppIndividual
        output.innerHTML += `<h3>üîß Simulaci√≥n del Bug de Filtro:</h3>`;
        
        const empleadoTest = empleados.find(e => e.nombre.toLowerCase().includes('antony'));
        if (empleadoTest) {
            const turnosTest = mapSchedule.get(empleadoTest.id) || [];
            const mes = appState.currentMonth || 11;
            const anio = appState.currentYear || 2025;
            
            // C√ìDIGO BUGGY (el que est√° ahora)
            let turnosDelMesBuggy = turnosTest.filter(t => {
                if (!t?.fecha) return false; // Cambi√© a false aqu√≠
                const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                return fecha.getMonth() === mes && fecha.getFullYear() === anio;
            });
            
            const totalBuggy = turnosDelMesBuggy.reduce((sum, t) => sum + (t.horas || 0), 0);
            
            output.innerHTML += `<div class="datos">
                <strong>Turnos con filtro CORREGIDO (return false):</strong> ${turnosDelMesBuggy.length}<br>
                <strong>Total horas:</strong> ${totalBuggy}h
            </div>`;
            
            // Mostrar si hay turnos sin fecha
            const turnosSinFecha = turnosTest.filter(t => !t?.fecha);
            output.innerHTML += `<div class="datos">
                <strong>Turnos SIN fecha en toda la data:</strong> ${turnosSinFecha.length}<br>
                ${turnosSinFecha.length > 0 ? '<span class="error">‚ö†Ô∏è Hay turnos sin fecha que podr√≠an causar problemas</span>' : '<span class="ok">‚úÖ Todos los turnos tienen fecha</span>'}
            </div>`;
        }
        
    } catch (error) {
        output.innerHTML += `<div class="error">‚ùå Error: ${error.message}</div>`;
        console.error(error);
    }
}

// Auto-ejecutar
window.addEventListener('load', () => {
    setTimeout(analizarDatos, 500);
});
</script>

</body>
</html>
