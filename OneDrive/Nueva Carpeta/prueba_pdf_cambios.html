<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba: PDF Cambios</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0f172a;
            color: #f1f5f9;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #475569;
        }
        .test-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #a78bfa;
        }
        .test-result {
            background: #0f172a;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.6;
            overflow-x: auto;
            border-left: 4px solid #22c55e;
        }
        .test-result.error {
            border-left-color: #ff6b6b;
            color: #fecaca;
        }
        .calendario-preview {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
            margin-top: 15px;
            padding: 15px;
            background: #0f172a;
            border-radius: 6px;
        }
        .celda-preview {
            min-height: 100px;
            border-radius: 12px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            text-align: center;
            border: 2px solid transparent;
            font-size: 11px;
        }
        .celda-preview .numero {
            font-size: 16px;
            font-weight: 700;
            color: #0f172a;
        }
        .celda-preview .inicial {
            font-size: 24px;
            font-weight: 700;
            color: #0f172a;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Prueba: Cambios en PDF WhatsApp</h1>
        
        <div class="test-section">
            <div class="test-title">‚úÖ Test 1: Funci√≥n obtenerInfoTurnoVisualPDF()</div>
            <div id="test1-result" class="test-result">Probando...</div>
        </div>

        <div class="test-section">
            <div class="test-title">üì± Test 2: Vista Previa del Calendario (5 d√≠as de ejemplo)</div>
            <div id="test2-result" class="test-result">Cargando vista previa...</div>
            <div id="test2-preview" class="calendario-preview"></div>
        </div>

        <div class="test-section">
            <div class="test-title">üìã Test 3: Verificaci√≥n de datos tiposTurno</div>
            <div id="test3-result" class="test-result">Verificando...</div>
        </div>
    </div>

    <script src="js/modules.js"></script>
    <script>
        // Utilidades auxiliares (copiadas de nuevo_cuadrante_mejorado.html)
        function lowerCaseSafe(str) {
            return str ? String(str).toLowerCase().trim() : '';
        }

        function calcularHorasDelHorario(horario) {
            if (!horario || horario === '-') return '';
            const partes = horario.split('-');
            if (partes.length !== 2) return '';
            const [inicio, fin] = partes.map(p => {
                const [h, m] = p.trim().split(':').map(Number);
                return h + m / 60;
            });
            let diferencia = fin - inicio;
            if (diferencia < 0) diferencia += 24;
            return diferencia.toFixed(1);
        }

        // Funci√≥n a probar (copiada de nuevo_cuadrante_mejorado.html)
        function obtenerInfoTurnoVisualPDF(nombre, tiposTurnoData) {
            const paletaFallback = {
                'ma√±ana': '#86efac',
                'tarde': '#fcd34d',
                'noche': '#93c5fd',
                'mixto': '#fde68a',
                'descanso': '#cbd5f5',
                'vacaciones': '#fecdd3',
                'baja': '#fda4af',
                'libre': '#e0e7ff',
                'festivo': '#fef3c7'
            };
            if (!nombre) {
                return { etiqueta: 'Sin turno', inicial: '-', color: 'rgba(148,163,184,0.25)', horario: '', horas: '' };
            }
            const lower = lowerCaseSafe(nombre);
            const lista = Object.values(tiposTurnoData || {});
            const coincidencia = lista.find(t => lowerCaseSafe(t?.nombre) === lower || lowerCaseSafe(t?.id) === lower);
            
            let horas = coincidencia?.horas || '';
            if (!horas && coincidencia?.horario) {
                horas = calcularHorasDelHorario(coincidencia.horario);
            }
            
            const horario = coincidencia?.horario || '';
            
            return {
                etiqueta: coincidencia?.nombre || nombre,
                inicial: coincidencia?.inicial || nombre.substring(0, 1).toUpperCase(),
                color: coincidencia?.color || paletaFallback[lower] || 'rgba(148,163,184,0.25)',
                horario: horario,
                horas: horas
            };
        }

        // Test 1: obtenerInfoTurnoVisualPDF
        window.addEventListener('DOMContentLoaded', () => {
            try {
                const tiposTurnoData = JSON.parse(localStorage.getItem('tiposTurnoData')) || window.tiposTurno || {};
                
                const test1Results = [];
                const turnosPrueba = ['ma√±ana', 'tarde', 'noche', 'guardia', 'descanso', 'vacaciones'];
                
                turnosPrueba.forEach(turno => {
                    const info = obtenerInfoTurnoVisualPDF(turno, tiposTurnoData);
                    test1Results.push(`
                        <strong>${turno}:</strong>
                        - etiqueta: "${info.etiqueta}"
                        - inicial: "${info.inicial}" ‚úì
                        - color: "${info.color}"
                        - horas: "${info.horas}"
                    `);
                });
                
                document.getElementById('test1-result').innerHTML = `
                    <strong>‚úÖ Funci√≥n devuelve el campo 'inicial' correctamente:</strong><br><br>
                    ${test1Results.map(r => `<div style="margin-bottom: 10px;">${r}</div>`).join('')}
                `;
                document.getElementById('test1-result').classList.remove('error');

                // Test 2: Vista previa
                const turnosEjemplo = [
                    { dia: 1, turno: 'ma√±ana', horas: 8 },
                    { dia: 2, turno: 'tarde', horas: 6.5 },
                    { dia: 3, turno: 'noche', horas: 8 },
                    { dia: 4, turno: 'descanso', horas: 0 },
                    { dia: 5, turno: 'guardia', horas: 20 }
                ];

                let previewHtml = '';
                turnosEjemplo.forEach(t => {
                    const info = obtenerInfoTurnoVisualPDF(t.turno, tiposTurnoData);
                    previewHtml += `
                        <div class="celda-preview" style="background: ${info.color};">
                            <div class="numero">${t.dia}</div>
                            <div class="inicial">${info.inicial}</div>
                            <div style="font-size: 10px; color: #0f172a;">${t.horas}h</div>
                        </div>
                    `;
                });
                document.getElementById('test2-preview').innerHTML = previewHtml;
                document.getElementById('test2-result').innerHTML = `
                    ‚úÖ Previsualizaci√≥n de 5 celdas con iniciales y colores correctos
                `;
                document.getElementById('test2-result').classList.remove('error');

                // Test 3: Verificaci√≥n de datos tiposTurno
                const tiposDisponibles = Object.entries(tiposTurnoData).map(([key, val]) => {
                    return `<strong>${key}:</strong> inicial="${val.inicial}", nombre="${val.nombre}"`;
                }).join('<br>');

                document.getElementById('test3-result').innerHTML = `
                    ‚úÖ Tipos de turno disponibles en localStorage:<br><br>
                    ${tiposDisponibles}
                `;
                document.getElementById('test3-result').classList.remove('error');

            } catch (error) {
                console.error('‚ùå Error en pruebas:', error);
                document.getElementById('test1-result').innerHTML = `<strong>‚ùå Error:</strong> ${error.message}`;
                document.getElementById('test1-result').classList.add('error');
            }
        });
    </script>
</body>
</html>
