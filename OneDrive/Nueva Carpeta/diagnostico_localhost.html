<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Persistencia - Localhost</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .output { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; }
        button { padding: 12px 24px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; }
        button:hover { background: linear-gradient(135deg, #0056b3 0%, #004085 100%); }
        .section { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
        h1 { color: #333; text-align: center; }
        h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Persistencia - Localhost</h1>
        <p>Este diagn√≥stico se ejecuta desde localhost y comparte localStorage con la aplicaci√≥n principal.</p>

        <div class="section">
            <button onclick="ejecutarDiagnostico()">üîç Ejecutar Diagn√≥stico</button>
            <button onclick="limpiarLocalStorage()">üóëÔ∏è Limpiar localStorage</button>
            <button onclick="abrirAplicacion()">üì± Abrir Aplicaci√≥n Principal</button>
        </div>

        <h2>Resultado del Diagn√≥stico:</h2>
        <div class="output" id="output">Haz clic en "Ejecutar Diagn√≥stico" para comenzar...</div>

        <div class="section">
            <h3>üìã Instrucciones:</h3>
            <ol>
                <li>Ejecuta el diagn√≥stico para ver el estado actual</li>
                <li>Abre la aplicaci√≥n principal en otra pesta√±a</li>
                <li>Cambia el turno de Antony d√≠a 30</li>
                <li>Vuelve aqu√≠ y ejecuta el diagn√≥stico nuevamente</li>
                <li>Recarga la aplicaci√≥n principal y verifica si los cambios persisten</li>
            </ol>
        </div>
    </div>

    <script src="js/modules.js"></script>
    <script>
        // Inicializar empleados con la lista completa
        window.empleados = [
            { id: 1, nombre: "Empleado 1", localidad: "Madrid", horasContrato: 160 },
            { id: 2, nombre: "Empleado 2", localidad: "Madrid", horasContrato: 160 },
            { id: 3, nombre: "Empleado 3", localidad: "Madrid", horasContrato: 160 },
            { id: 4, nombre: "Empleado 4", localidad: "Madrid", horasContrato: 160 },
            { id: 5, nombre: "Empleado 5", localidad: "Madrid", horasContrato: 160 },
            { id: 6, nombre: "Empleado 6", localidad: "Madrid", horasContrato: 160 },
            { id: 7, nombre: "Empleado 7", localidad: "Madrid", horasContrato: 160 },
            { id: 8, nombre: "antony valencia", localidad: "Madrid", horasContrato: 154 }
        ];

        // Inicializar AppState
        AppState.currentYear = new Date().getFullYear();
        AppState.currentMonth = new Date().getMonth();

        function ejecutarDiagnostico() {
            const output = document.getElementById('output');
            output.textContent = 'Ejecutando diagn√≥stico...\n';

            try {
                diagnosticoPersistencia();
            } catch (error) {
                output.textContent += '\n‚ùå ERROR: ' + error.message;
            }
        }

        function limpiarLocalStorage() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar todo localStorage? Se perder√°n todos los datos guardados.')) {
                localStorage.clear();
                document.getElementById('output').textContent = 'üóëÔ∏è localStorage limpiado completamente';
            }
        }

        function abrirAplicacion() {
            window.open('nuevo_cuadrante_mejorado.html', '_blank');
        }

        function log(message) {
            const output = document.getElementById('output');
            output.textContent += message + '\n';
            console.log(message);
        }

        function diagnosticoPersistencia() {
            log('üß™ === DIAGN√ìSTICO DE PERSISTENCIA (LOCALHOST) ===');
            log('üìÖ Fecha actual: ' + new Date().toLocaleString());
            log('üåê Ejecut√°ndose desde: ' + window.location.href);
            log('');

            // 1. Verificar localStorage
            log('üì¶ LOCALSTORAGE:');
            try {
                const saved = localStorage.getItem('turnosAppState');
                if (saved) {
                    const state = JSON.parse(saved);
                    log('‚úÖ Datos encontrados en localStorage');
                    log('üìä Empleados con turnos: ' + (state.scheduleData ? state.scheduleData.length : 0));
                    log('üìÖ Mes/a√±o guardado: ' + state.month + '/' + state.year);

                    if (state.scheduleData) {
                        log('');
                        log('üë• LISTA DE EMPLEADOS EN LOCALSTORAGE:');
                        state.scheduleData.forEach(([id, turnos], index) => {
                            log(`  ${index + 1}. ID: ${id}, Turnos: ${turnos.length}`);
                        });

                        log('');
                        log('üîç BUSCANDO D√çA 30 EN TODOS LOS EMPLEADOS:');
                        state.scheduleData.forEach(([id, turnos]) => {
                            const turno30 = turnos.find(t => t.dia === 30);
                            if (turno30) {
                                log(`  ID ${id} - D√≠a 30: ${turno30.turno} (Fecha: ${turno30.fecha})`);
                            }
                        });
                    }
                } else {
                    log('‚ùå No hay datos en localStorage');
                }
            } catch (error) {
                log('‚ùå Error leyendo localStorage: ' + error);
            }

            log('');
            log('üè™ APPSTATE:');
            log('üìÖ Mes/a√±o actual: ' + AppState.currentMonth + '/' + AppState.currentYear);
            log('üìä Empleados en AppState: ' + AppState.scheduleData.size);

            if (AppState.scheduleData.size > 0) {
                log('');
                log('üë• EMPLEADOS EN APPSTATE:');
                AppState.scheduleData.forEach((turnos, id) => {
                    log(`  ID ${id}: ${turnos.length} turnos`);
                    const turno30 = turnos.find(t => t.dia === 30);
                    if (turno30) {
                        log(`     D√≠a 30: ${turno30.turno}`);
                    }
                });
            }

            log('');
            log('üë• EMPLEADOS DISPONIBLES EN EL SISTEMA:');
            if (window.empleados) {
                window.empleados.forEach(emp => {
                    log(`  ID ${emp.id}: ${emp.nombre}`);
                });
            }

            log('');
            log('üß™ === FIN DIAGN√ìSTICO ===');
        }

        // Ejecutar diagn√≥stico autom√°ticamente al cargar
        setTimeout(() => {
            ejecutarDiagnostico();
        }, 500);
    </script>
</body>
</html>