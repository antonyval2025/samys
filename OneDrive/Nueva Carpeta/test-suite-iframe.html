<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Suite - Sistema de Gesti√≥n de Turnos (Con iframe)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .test-item {
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #ddd;
        }
        .test-item.pass {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .test-item.fail {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .test-item.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .code {
            background: #f4f4f4;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .summary {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f0e4d9;
            color: #6b5b7d;
            font-weight: bold;
        }
        #mainIframe {
            display: none;
        }
        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test Suite - Sistema de Gesti√≥n de Turnos (Verificaci√≥n Completa)</h1>
        
        <!-- Cargar el HTML principal en un iframe oculto -->
        <iframe id="mainIframe" src="nuevo_cuadrante_mejorado.html"></iframe>
        
        <div class="test-section">
            <h2>‚è≥ Estado</h2>
            <div id="test-status">Cargando archivo principal...</div>
        </div>

        <div class="grid-layout">
            <div>
                <div class="test-section">
                    <h2>1Ô∏è‚É£ Validaci√≥n de Estructura HTML</h2>
                    <div id="test-html"></div>
                </div>

                <div class="test-section">
                    <h2>2Ô∏è‚É£ Validaci√≥n de Datos Iniciales</h2>
                    <div id="test-data"></div>
                </div>

                <div class="test-section">
                    <h2>3Ô∏è‚É£ Validaci√≥n de Funciones Principales</h2>
                    <div id="test-functions"></div>
                </div>
            </div>

            <div>
                <div class="test-section">
                    <h2>4Ô∏è‚É£ Validaci√≥n de Botones</h2>
                    <div id="test-buttons"></div>
                </div>

                <div class="test-section">
                    <h2>5Ô∏è‚É£ Validaci√≥n de Estilos CSS</h2>
                    <div id="test-styles"></div>
                </div>

                <div class="test-section">
                    <h2>üìä Resumen de Resultados</h2>
                    <div id="test-summary" class="summary"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let totalTests = 0;
        let passTests = 0;
        let failTests = 0;

        function addTest(sectionId, name, passed, message = '') {
            totalTests++;
            const section = document.getElementById(sectionId);
            if (!section) return;
            const div = document.createElement('div');
            const status = passed ? 'pass' : 'fail';
            
            if (passed) passTests++;
            else failTests++;
            
            div.className = `test-item ${status}`;
            div.innerHTML = `<strong>${passed ? '‚úì' : '‚úó'} ${name}</strong>${message ? '<br><small>' + message + '</small>' : ''}`;
            section.appendChild(div);
        }

        // Esperar a que el iframe cargue completamente (10 segundos para permitir scripts)
        setTimeout(function() {
            console.log('üîÑ Iniciando tests...');
            const statusEl = document.getElementById('test-status');
            
            try {
                const iframe = document.getElementById('mainIframe');
                if (!iframe) {
                    throw new Error('iframe no encontrado');
                }
                
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const iframeWindow = iframe.contentWindow;
                
                if (!iframeDoc) {
                    throw new Error('No se puede acceder al contenido del iframe');
                }
                
                console.log('‚úì iframe cargado correctamente');
                console.log('AppState:', iframeWindow.AppState);
                console.log('EmployeeManager:', iframeWindow.EmployeeManager);
                statusEl.innerHTML = '‚úì Archivo principal cargado - ejecutando tests...';

                // Test 1: Validaci√≥n de Estructura HTML
                const header = iframeDoc.querySelector('header');
                addTest('test-html', 'Header existe', !!header);

                const topControls = iframeDoc.querySelector('.top-controls');
                addTest('test-html', 'Top controls existe', !!topControls);

                const tabs = iframeDoc.querySelectorAll('.tab-btn');
                addTest('test-html', 'Tabs existen', tabs.length >= 2, `${tabs.length} tabs encontradas`);

                const tabGeneral = iframeDoc.getElementById('tab-general');
                addTest('test-html', 'Tab Cuadrante General existe', !!tabGeneral);

                const tabIndividual = iframeDoc.getElementById('tab-individual');
                addTest('test-html', 'Tab Informe Individual existe', !!tabIndividual);

                const modalEmpleados = iframeDoc.getElementById('modalGestionEmpleados');
                addTest('test-html', 'Modal Gesti√≥n Empleados existe', !!modalEmpleados);

                const cuadranteDiv = iframeDoc.getElementById('cuadranteGeneral');
                addTest('test-html', 'Div cuadranteGeneral existe', !!cuadranteDiv);

                // Test 2: Validaci√≥n de Datos
                const empleados = iframeWindow.empleados;
                addTest('test-data', 'Variable "empleados" existe', typeof empleados !== 'undefined');

                if (typeof empleados !== 'undefined' && Array.isArray(empleados)) {
                    addTest('test-data', 'Empleados es array', true, `${empleados.length} empleados`);
                    
                    if (empleados.length > 0) {
                        const firstEmp = empleados[0];
                        const hasFields = firstEmp.id && firstEmp.nombre && firstEmp.departamento;
                        addTest('test-data', 'Empleados tienen campos requeridos', hasFields, 
                            `ID: ${firstEmp.id}, Nombre: "${firstEmp.nombre}"`);
                    }
                }

                const appState = iframeWindow.AppState;
                const appStateExists = appState !== null && appState !== undefined;
                addTest('test-data', 'AppState existe', appStateExists);

                if (appStateExists) {
                    addTest('test-data', 'AppState.currentYear definido', appState.currentYear && appState.currentYear > 2000, 
                        `A√±o actual: ${appState.currentYear}`);
                    addTest('test-data', 'AppState.currentMonth definido', 
                        appState.currentMonth !== undefined && appState.currentMonth >= 0 && appState.currentMonth <= 11, `Mes actual: ${appState.currentMonth}`);
                    addTest('test-data', 'AppState.scheduleData es Map', appState.scheduleData && appState.scheduleData instanceof Map);
                }

                // Test 3: Validaci√≥n de Funciones
                const functions = [
                    { name: 'EmployeeManager', method: 'abrirModal' },
                    { name: 'TurnoManager', method: 'reiniciarDatos' },
                    { name: 'TurnoEditor', method: 'mostrarModalEdicionMasiva' },
                    { name: 'ExportManager', method: 'exportarCuadranteGeneral' },
                    { name: 'DateUtils', method: 'cambiarMes' }
                ];

                functions.forEach(func => {
                    const manager = iframeWindow[func.name];
                    const exists = manager !== null && manager !== undefined;
                    addTest('test-functions', `${func.name} existe`, exists);
                    
                    if (exists && typeof manager[func.method] === 'function') {
                        addTest('test-functions', `  ‚Üí ${func.name}.${func.method}() es funci√≥n`, true);
                    } else if (exists) {
                        addTest('test-functions', `  ‚Üí ${func.name}.${func.method}() es funci√≥n`, false, `(actual: ${typeof manager[func.method]})`);
                    }
                });

                // Test 4: Validaci√≥n de Botones
                const btnEmpleados = iframeDoc.querySelector('button[onclick*="EmployeeManager.abrirModal"]');
                addTest('test-buttons', 'üë• Bot√≥n Empleados tiene onclick', !!btnEmpleados);

                const btnGenerar = iframeDoc.querySelector('button[onclick*="TurnoManager.reiniciarDatos"]');
                addTest('test-buttons', 'üìã Bot√≥n Generar tiene onclick', !!btnGenerar);

                const btnInforme = iframeDoc.querySelector('button[onclick*="tab-individual"]');
                addTest('test-buttons', 'üìä Bot√≥n Informe tiene onclick', !!btnInforme);

                const btnExportar = iframeDoc.querySelector('button[onclick*="ExportManager"]');
                addTest('test-buttons', 'üìÑ Botones de exportaci√≥n existen', !!btnExportar);

                // Test 5: Validaci√≥n de Estilos
                const bodyStyles = iframeDoc.body.style.cssText;
                const hasBackgroundInline = bodyStyles && (bodyStyles.includes('background') || bodyStyles.includes('gradient'));
                const computedStyle = iframeWindow.getComputedStyle(iframeDoc.body);
                const bgColor = computedStyle.backgroundColor;
                const bgImage = computedStyle.backgroundImage;
                
                const isPastelBg = hasBackgroundInline || 
                                   bgColor.includes('240') || bgColor.includes('228') || bgColor.includes('217') ||
                                   bgImage.includes('gradient');
                
                addTest('test-styles', 'Body tiene background pastel', isPastelBg, 
                    `Inline: ${hasBackgroundInline ? 'S√≠' : 'No'} | Color: ${bgColor} | Image: ${bgImage.substring(0, 50)}`);

                const buttonsPastel = iframeDoc.querySelectorAll('[style*="background: #d4c5e2"]');
                addTest('test-styles', 'Botones con color pastel #d4c5e2 existen', buttonsPastel.length > 0, 
                    `${buttonsPastel.length} botones con ese color`);

                const navBtns = iframeDoc.querySelectorAll('.nav-btn');
                addTest('test-styles', 'Botones de navegaci√≥n existen', navBtns.length > 0, 
                    `${navBtns.length} botones nav encontrados`);

                // Verificar que CSS est√° cargado
                const cssLinks = iframeDoc.querySelectorAll('link[rel="stylesheet"]');
                const cssLoaded = cssLinks.length > 0;
                addTest('test-styles', 'Archivo CSS vinculado', cssLoaded, `${cssLinks.length} hojas de estilo`);

                // Resumen
                const summary = document.getElementById('test-summary');
                const successRate = totalTests > 0 ? ((passTests / totalTests) * 100).toFixed(1) : 0;
                
                summary.innerHTML = `
                    <h3>üìà Resultados Finales</h3>
                    <table>
                        <tr>
                            <th>M√©trica</th>
                            <th>Cantidad</th>
                            <th>Porcentaje</th>
                        </tr>
                        <tr style="background: #d4edda;">
                            <td>‚úì Tests Pasados</td>
                            <td><strong>${passTests}</strong></td>
                            <td>${totalTests > 0 ? ((passTests / totalTests) * 100).toFixed(1) : 0}%</td>
                        </tr>
                        <tr style="background: #f8d7da;">
                            <td>‚úó Tests Fallidos</td>
                            <td><strong>${failTests}</strong></td>
                            <td>${totalTests > 0 ? ((failTests / totalTests) * 100).toFixed(1) : 0}%</td>
                        </tr>
                        <tr style="background: #e7f3ff; font-weight: bold;">
                            <td>Total Tests</td>
                            <td><strong>${totalTests}</strong></td>
                            <td>${successRate}%</td>
                        </tr>
                    </table>
                    <p style="margin-top: 15px;"><strong>Estado General:</strong> 
                        ${successRate >= 80 ? '‚úì APLICACI√ìN FUNCIONAL' : failTests > 3 ? '‚úó PROBLEMAS CR√çTICOS' : '‚ö† NECESITA REVISI√ìN'}
                    </p>
                    ${failTests > 0 ? '<p style="color: #721c24;"><strong>Acci√≥n requerida:</strong> Revisar tests fallidos arriba.</p>' : '<p style="color: #155724;"><strong>¬°Excelente!</strong> Todos los tests pasaron.</p>'}
                `;

                document.getElementById('test-status').innerHTML = `‚úì Tests completados: ${passTests}/${totalTests} pasados`;
                
            } catch (error) {
                console.error('‚ùå ERROR en tests:', error);
                console.error('Stack:', error.stack);
                document.getElementById('test-status').innerHTML = `‚úó Error: ${error.message}`;
            }
        }, 10000);

                // Test 5: Validaci√≥n de Estilos
                const computedStyle = iframeWindow.getComputedStyle(iframeDoc.body);
                const bgColor = computedStyle.backgroundColor;
                addTest('test-styles', 'Body tiene background pastel', 
                    bgColor.includes('240') || bgColor.includes('228') || bgColor.includes('217'), 
                    `Color detectado: ${bgColor}`);

                const buttonsPastel = iframeDoc.querySelectorAll('[style*="background: #d4c5e2"]');
                addTest('test-styles', 'Botones con color pastel #d4c5e2 existen', buttonsPastel.length > 0, 
                    `${buttonsPastel.length} botones con ese color`);

                const navBtns = iframeDoc.querySelectorAll('.nav-btn');
                addTest('test-styles', 'Botones de navegaci√≥n existen', navBtns.length > 0, 
                    `${navBtns.length} botones nav encontrados`);

                // Verificar que CSS est√° cargado
                const cssLinks = iframeDoc.querySelectorAll('link[rel="stylesheet"]');
                const cssLoaded = cssLinks.length > 0;
                addTest('test-styles', 'Archivo CSS vinculado', cssLoaded, `${cssLinks.length} hojas de estilo`);

                // Resumen
                const summary = document.getElementById('test-summary');
                const successRate = totalTests > 0 ? ((passTests / totalTests) * 100).toFixed(1) : 0;
                
                summary.innerHTML = `
                    <h3>üìà Resultados Finales</h3>
                    <table>
                        <tr>
                            <th>M√©trica</th>
                            <th>Cantidad</th>
                            <th>Porcentaje</th>
                        </tr>
                        <tr style="background: #d4edda;">
                            <td>‚úì Tests Pasados</td>
                            <td><strong>${passTests}</strong></td>
                            <td>${totalTests > 0 ? ((passTests / totalTests) * 100).toFixed(1) : 0}%</td>
                        </tr>
                        <tr style="background: #f8d7da;">
                            <td>‚úó Tests Fallidos</td>
                            <td><strong>${failTests}</strong></td>
                            <td>${totalTests > 0 ? ((failTests / totalTests) * 100).toFixed(1) : 0}%</td>
                        </tr>
                        <tr style="background: #e7f3ff; font-weight: bold;">
                            <td>Total Tests</td>
                            <td><strong>${totalTests}</strong></td>
                            <td>${successRate}%</td>
                        </tr>
                    </table>
                    <p style="margin-top: 15px;"><strong>Estado General:</strong> 
                        ${successRate >= 80 ? '‚úì APLICACI√ìN FUNCIONAL' : failTests > 3 ? '‚úó PROBLEMAS CR√çTICOS' : '‚ö† NECESITA REVISI√ìN'}
                    </p>
                    ${failTests > 0 ? '<p style="color: #721c24;"><strong>Acci√≥n requerida:</strong> Revisar tests fallidos arriba.</p>' : '<p style="color: #155724;"><strong>¬°Excelente!</strong> Todos los tests pasaron.</p>'}
                `;

                document.getElementById('test-status').innerHTML = `‚úì Tests completados: ${passTests}/${totalTests} pasados`;
                
            } catch (error) {
                console.error('Error en tests:', error);
                document.getElementById('test-status').innerHTML = `‚úó Error: ${error.message}`;
            }
        };

        // Si el iframe falla a cargar
        iframe.onerror = function() {
            document.getElementById('test-status').innerHTML = '‚úó Error: No se pudo cargar nuevo_cuadrante_mejorado.html';
        };
    </script>
</body>
</html>
