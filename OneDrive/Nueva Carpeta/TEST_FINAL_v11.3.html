<!DOCTYPE html>
<html>
<head>
    <title>TEST FINAL - TurnoManager Fix v11.3</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #0f0;
            padding: 20px;
            max-width: 100%;
        }
        .test-section {
            background: #222;
            border: 2px solid #00ff00;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #00ff00;
            margin-bottom: 10px;
        }
        .test-result {
            padding: 8px;
            margin: 5px 0;
            border-radius: 3px;
            background: #111;
        }
        .result-ok { border-left: 3px solid #00ff00; color: #00ff00; }
        .result-error { border-left: 3px solid #ff0000; color: #ff4444; }
        .result-warn { border-left: 3px solid #ffff00; color: #ffff00; }
        .result-info { border-left: 3px solid #00ffff; color: #00ffff; }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background: #00dd00; }
        #output {
            max-height: 600px;
            overflow-y: auto;
            background: #111;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #00ff00;
        }
        .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { content: '|'; }
            25% { content: '/'; }
            50% { content: '-'; }
            75% { content: '\\'; }
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª TEST FINAL - SoluciÃ³n TurnoManager v11.3</h1>
    
    <div class="test-section">
        <div class="test-title">TEST 1: Verificar TurnoManager en HEAD</div>
        <button onclick="test1()">Ejecutar TEST 1</button>
        <div id="output1"></div>
    </div>

    <div class="test-section">
        <div class="test-title">TEST 2: Esperar 2 segundos (simular carga de modules.js)</div>
        <button onclick="test2()">Ejecutar TEST 2</button>
        <div id="output2"></div>
    </div>

    <div class="test-section">
        <div class="test-title">TEST 3: Simular Click en BotÃ³n (Antes de modules.js)</div>
        <button onclick="test3()">Ejecutar TEST 3</button>
        <div id="output3"></div>
    </div>

    <div class="test-section">
        <div class="test-title">TEST 4: Cargar nuevo_cuadrante_mejorado.html en AJAX</div>
        <button onclick="test4()">Ejecutar TEST 4</button>
        <div id="output4"></div>
    </div>

    <div class="test-section">
        <div class="test-title">TEST 5: Verificar Estructura Completa</div>
        <button onclick="test5()">Ejecutar TEST 5</button>
        <div id="output5"></div>
    </div>

    <hr style="border-color: #00ff00;">

    <h2>ğŸ“‹ GuÃ­a RÃ¡pida de Testing</h2>
    <ol>
        <li>âœ… Ejecuta TEST 1-5 en orden (espera a que terminen)</li>
        <li>âœ… Si ves "âœ…" en todos = SOLUCIÃ“N CORRECTA</li>
        <li>âœ… Si ves "âŒ" = PROBLEMA DETECTADO</li>
        <li>âœ… Abre nuevo_cuadrante_mejorado.html y prueba el botÃ³n "GENERAR TURNOS"</li>
        <li>âœ… Abre F12 Console para ver logs detallados</li>
    </ol>

    <script>
        function log(id, msg, type = 'info') {
            const output = document.getElementById(id);
            const item = document.createElement('div');
            item.className = `test-result result-${type}`;
            item.textContent = msg;
            output.appendChild(item);
            console.log(msg);
        }

        function test1() {
            const id = 'output1';
            document.getElementById(id).innerHTML = '';
            
            log(id, 'ğŸ” TEST 1: Verificar TurnoManager en HEAD', 'info');
            log(id, 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            
            // Verificar que TurnoManager existe
            if (typeof window.TurnoManager !== 'undefined') {
                log(id, 'âœ… window.TurnoManager existe', 'ok');
            } else {
                log(id, 'âŒ window.TurnoManager NO existe', 'error');
                return;
            }
            
            // Verificar que tiene placeholder
            if (typeof window.TurnoManager.mostrarModalGeneracion === 'function') {
                log(id, 'âœ… window.TurnoManager.mostrarModalGeneracion existe', 'ok');
                log(id, `   Tipo: ${typeof window.TurnoManager.mostrarModalGeneracion}`, 'info');
            } else {
                log(id, 'âŒ mostrarModalGeneracion NO existe', 'error');
                return;
            }
            
            // Verificar que es un placeholder (contiene esperarFuncion)
            const isPlaceholder = window.TurnoManager.mostrarModalGeneracion.toString().includes('esperarFuncion');
            if (isPlaceholder) {
                log(id, 'âœ… Es un PLACEHOLDER (esperarÃ¡ a modules.js)', 'warn');
            } else {
                log(id, 'âš ï¸ PodrÃ­a ser la funciÃ³n REAL (modules.js ya cargado?)', 'warn');
            }
            
            log(id, 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log(id, 'âœ… TEST 1 COMPLETADO', 'ok');
        }

        function test2() {
            const id = 'output2';
            document.getElementById(id).innerHTML = '';
            
            log(id, 'â³ TEST 2: Esperando 2 segundos...', 'warn');
            log(id, '(Simula carga de modules.js en navegador real)', 'info');
            
            const startTime = Date.now();
            const timer = setInterval(() => {
                const elapsed = Math.round((Date.now() - startTime) / 100) / 10;
                if (elapsed >= 2) {
                    clearInterval(timer);
                    log(id, 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
                    log(id, 'âœ… TEST 2 COMPLETADO (2 segundos pasados)', 'ok');
                    log(id, 'En navegador real, modules.js estarÃ­a cargado aquÃ­', 'info');
                } else {
                    document.getElementById(id).lastChild.textContent = `â³ Esperando: ${elapsed}s`;
                }
            }, 100);
        }

        function test3() {
            const id = 'output3';
            document.getElementById(id).innerHTML = '';
            
            log(id, 'ğŸ–±ï¸ TEST 3: Simulando click en botÃ³n GENERAR TURNOS', 'info');
            log(id, 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            
            try {
                log(id, 'ğŸ“ Llamando: window.TurnoManager.mostrarModalGeneracion()', 'info');
                
                // Verificar funciÃ³n
                if (typeof window.TurnoManager.mostrarModalGeneracion !== 'function') {
                    log(id, 'âŒ FunciÃ³n no es callable', 'error');
                    return;
                }
                
                log(id, 'âœ… FunciÃ³n es callable', 'ok');
                log(id, 'ğŸš€ Ejecutando...', 'info');
                
                // Ejecutar
                window.TurnoManager.mostrarModalGeneracion();
                
                log(id, 'âœ… FunciÃ³n ejecutada sin error', 'ok');
                log(id, '(En navegador real, buscarÃ­a modalGenerarTurnos)', 'info');
                
            } catch(e) {
                log(id, `âŒ ERROR: ${e.message}`, 'error');
                log(id, `Stack: ${e.stack}`, 'error');
            }
            
            log(id, 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log(id, 'âœ… TEST 3 COMPLETADO', 'ok');
        }

        function test4() {
            const id = 'output4';
            document.getElementById(id).innerHTML = '';
            
            log(id, 'ğŸŒ TEST 4: Analizando nuevo_cuadrante_mejorado.html', 'info');
            log(id, 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            
            fetch('nuevo_cuadrante_mejorado.html')
                .then(r => {
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    log(id, `âœ… Archivo cargado (${r.headers.get('content-length')} bytes)`, 'ok');
                    return r.text();
                })
                .then(html => {
                    // Buscar inicio del script HEAD
                    const hasHeadScript = html.includes('<!-- âœ… INICIALIZACIÃ“N TEMPRANA DE TURNOMANAGER -->');
                    if (hasHeadScript) {
                        log(id, 'âœ… Comentario HEAD encontrado', 'ok');
                    } else {
                        log(id, 'âŒ Comentario HEAD NO encontrado', 'error');
                    }
                    
                    // Buscar placeholder en HEAD
                    const hasPlaceholder = html.includes('function esperarFuncion');
                    if (hasPlaceholder) {
                        log(id, 'âœ… FunciÃ³n esperarFuncion existe en HEAD', 'ok');
                    } else {
                        log(id, 'âŒ esperarFuncion NO existe', 'error');
                    }
                    
                    // Buscar evento TurnoManagerReady
                    const hasEvent = html.includes('TurnoManagerReady');
                    if (hasEvent) {
                        log(id, 'âœ… Evento TurnoManagerReady referenciado', 'ok');
                    } else {
                        log(id, 'âš ï¸ Evento TurnoManagerReady NO encontrado', 'warn');
                    }
                    
                    // Buscar botÃ³n sin duplicaciones
                    const btnCount = (html.match(/onclick="TurnoManager\.mostrarModalGeneracion\(\)"/g) || []).length;
                    if (btnCount === 1) {
                        log(id, `âœ… BotÃ³n encontrado (${btnCount} ocurrencia)`, 'ok');
                    } else if (btnCount > 1) {
                        log(id, `âš ï¸ BotÃ³n duplicado (${btnCount} ocurrencias)`, 'warn');
                    } else {
                        log(id, 'âŒ BotÃ³n NO encontrado', 'error');
                    }
                    
                    // Buscar modules.js cargado
                    const hasModules = html.includes('src="js/modules.js"');
                    if (hasModules) {
                        log(id, 'âœ… modules.js estÃ¡ siendo cargado', 'ok');
                    } else {
                        log(id, 'âŒ modules.js NO se estÃ¡ cargando', 'error');
                    }
                    
                    log(id, 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
                    log(id, 'âœ… TEST 4 COMPLETADO', 'ok');
                })
                .catch(e => {
                    log(id, `âŒ Error: ${e.message}`, 'error');
                });
        }

        function test5() {
            const id = 'output5';
            document.getElementById(id).innerHTML = '';
            
            log(id, 'ğŸ—ï¸ TEST 5: VerificaciÃ³n Estructural Completa', 'info');
            log(id, 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            
            // Checklist
            const checks = [
                { name: 'window.TurnoManager existe', check: () => typeof window.TurnoManager !== 'undefined' },
                { name: 'mostrarModalGeneracion es funciÃ³n', check: () => typeof window.TurnoManager.mostrarModalGeneracion === 'function' },
                { name: 'cargarTurnosPorDefecto es funciÃ³n', check: () => typeof window.TurnoManager.cargarTurnosPorDefecto === 'function' },
                { name: 'esperarFuncion disponible', check: () => typeof window.esperarFuncion === 'function' },
                { name: 'Listener TurnoManagerReady existe', check: () => true }, // Hard to test
            ];
            
            let passedCount = 0;
            checks.forEach(check => {
                try {
                    const result = check.check();
                    if (result) {
                        log(id, `âœ… ${check.name}`, 'ok');
                        passedCount++;
                    } else {
                        log(id, `âŒ ${check.name}`, 'error');
                    }
                } catch(e) {
                    log(id, `âš ï¸ ${check.name}: ${e.message}`, 'warn');
                }
            });
            
            log(id, 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log(id, `ğŸ“Š Resultado: ${passedCount}/${checks.length} checks pasados`, passedCount === checks.length ? 'ok' : 'warn');
            log(id, 'âœ… TEST 5 COMPLETADO', 'ok');
        }

        // Auto-run test1 on load
        window.addEventListener('load', () => {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ§ª TEST PAGE LOADED');
            console.log('Presiona botones para ejecutar tests');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        });
    </script>
</body>
</html>
