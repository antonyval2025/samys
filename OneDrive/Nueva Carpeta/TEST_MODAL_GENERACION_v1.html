<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEST: Modal Generaci√≥n A+B</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f172a;
            color: #f1f5f9;
            padding: 20px;
            margin: 0;
        }
        
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            background: #1e293b;
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 30px;
        }
        
        h1 {
            color: #10b981;
            margin: 0 0 20px 0;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #0f172a;
            border-left: 4px solid #0ea5e9;
            border-radius: 8px;
        }
        
        .test-step {
            margin: 15px 0;
            padding: 12px;
            background: #475569;
            border-radius: 6px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
        }
        
        .test-result {
            margin: 15px 0;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
        }
        
        .pass {
            background: #065f46;
            color: #86efac;
            border-left: 4px solid #22c55e;
        }
        
        .fail {
            background: #5f1f1f;
            color: #fca5a5;
            border-left: 4px solid #ef4444;
        }
        
        .info {
            background: #1e3a5f;
            color: #93c5fd;
            border-left: 4px solid #3b82f6;
        }
        
        button {
            margin: 10px 5px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        button.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .console-output {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
        }
        
        .console-output span {
            display: block;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ TEST: Modal Generaci√≥n A+B</h1>
        
        <div class="test-section">
            <h2>üìã Checklist de Funcionalidades</h2>
            
            <div id="checklistContainer"></div>
            
            <h3>Acciones R√°pidas</h3>
            <button onclick="testAll()">‚ñ∂ Ejecutar Todos los Tests</button>
            <button onclick="clearConsole()" class="danger">üóëÔ∏è Limpiar Consola</button>
            <button onclick="resetStorage()" class="danger">‚ö†Ô∏è Reset localStorage</button>
        </div>
        
        <div class="test-section">
            <h2>üìä Consola de Prueba</h2>
            <div id="console" class="console-output"></div>
        </div>
    </div>

    <script>
        // ========== OBTENER REFERENCIA A LA APP PRINCIPAL ==========
        let mainWindow = null;
        let TurnoManager = null;
        let AppState = null;
        let empleados = null;
        let UI = null;
        let NotificationSystem = null;
        
        // Intentar obtener referencias desde la ventana principal o desde el contexto actual
        const initializeReferences = () => {
            try {
                // Si estamos en la misma ventana
                if (typeof window.TurnoManager !== 'undefined') {
                    TurnoManager = window.TurnoManager;
                    AppState = window.AppState;
                    empleados = window.empleados;
                    UI = window.UI;
                    NotificationSystem = window.NotificationSystem;
                    testLog('‚úì Referencias obtenidas del contexto actual', 'pass');
                    return true;
                }
            } catch (err) {
                testLog(`Error obteniendo referencias: ${err.message}`, 'fail');
                return false;
            }
        };
        
        // ========== UTILIDADES DE TESTING ==========
        const testLog = (message, type = 'info') => {
            const console_elem = document.getElementById('console');
            const span = document.createElement('span');
            const timestamp = new Date().toLocaleTimeString();
            span.innerHTML = `[${timestamp}] <strong>${type.toUpperCase()}:</strong> ${message}`;
            span.style.color = type === 'pass' ? '#86efac' : type === 'fail' ? '#fca5a5' : type === 'warn' ? '#fbbf24' : '#93c5fd';
            console_elem.appendChild(span);
            console_elem.scrollTop = console_elem.scrollHeight;
        };
        
        const clearConsole = () => {
            document.getElementById('console').innerHTML = '';
            testLog('Consola limpiada', 'info');
        };
        
        const addChecklist = (title, status) => {
            const container = document.getElementById('checklistContainer');
            const div = document.createElement('div');
            div.className = `test-result ${status === 'PASS' ? 'pass' : status === 'FAIL' ? 'fail' : 'info'}`;
            div.innerHTML = `${status === 'PASS' ? '‚úÖ' : status === 'FAIL' ? '‚ùå' : '‚è≥'} ${title}`;
            container.appendChild(div);
        };
        
        const resetStorage = () => {
            if (confirm('¬øBorrar todo localStorage?')) {
                localStorage.clear();
                testLog('localStorage limpiado', 'warn');
                testLog('Recarga la p√°gina para ver cambios', 'info');
            }
        };
        
        // ========== TESTS ==========
        
        const testEsCuadranteVacio = () => {
            testLog('TEST: esCuadranteVacio()', 'info');
            
            if (!initializeReferences()) {
                addChecklist('esCuadranteVacio() - Referencias no disponibles', 'FAIL');
                testLog('FATAL: No se puede acceder a TurnoManager desde el contexto actual', 'fail');
                testLog('üí° SOLUCI√ìN: Abre nuevo_cuadrante_mejorado.html PRIMERO, luego abre este test en otra pesta√±a', 'warn');
                return;
            }
            
            try {
                // Verificar que la funci√≥n existe
                if (typeof TurnoManager?.esCuadranteVacio !== 'function') {
                    addChecklist('esCuadranteVacio() funci√≥n existe', 'FAIL');
                    testLog('ERROR: Funci√≥n no encontrada', 'fail');
                    return;
                }
                
                const resultado = TurnoManager.esCuadranteVacio();
                addChecklist('esCuadranteVacio() = ' + resultado, 'PASS');
                testLog(`Resultado: ${resultado}`, 'pass');
            } catch (err) {
                addChecklist('esCuadranteVacio() ejecutable', 'FAIL');
                testLog(`ERROR: ${err.message}`, 'fail');
            }
        };
        
        const testMostrarModal = () => {
            testLog('TEST: mostrarModalGeneracion()', 'info');
            
            if (!initializeReferences()) return;
            
            try {
                if (typeof TurnoManager?.mostrarModalGeneracion !== 'function') {
                    addChecklist('mostrarModalGeneracion() funci√≥n existe', 'FAIL');
                    testLog('ERROR: Funci√≥n no encontrada', 'fail');
                    return;
                }
                
                TurnoManager.mostrarModalGeneracion();
                
                // Verificar que el modal se mostr√≥
                const modal = document.getElementById('modalGeneracionTurnos');
                if (modal && modal.classList.contains('active')) {
                    addChecklist('Modal se abre correctamente', 'PASS');
                    testLog('Modal abierto y activo', 'pass');
                } else {
                    addChecklist('Modal se abre correctamente', 'FAIL');
                    testLog('Modal no est√° activo', 'fail');
                }
                
                // Cerrar autom√°ticamente despu√©s de 2 segundos
                setTimeout(() => TurnoManager.cerrarModalGeneracion(), 2000);
            } catch (err) {
                addChecklist('mostrarModalGeneracion() ejecutable', 'FAIL');
                testLog(`ERROR: ${err.message}`, 'fail');
            }
        };
        
        const testVerificiarBoton = () => {
            testLog('TEST: verificarYMostrarBoton()', 'info');
            
            if (!initializeReferences()) return;
            
            try {
                if (typeof TurnoManager?.verificarYMostrarBoton !== 'function') {
                    addChecklist('verificarYMostrarBoton() funci√≥n existe', 'FAIL');
                    testLog('ERROR: Funci√≥n no encontrada', 'fail');
                    return;
                }
                
                TurnoManager.verificarYMostrarBoton();
                
                const btn = document.getElementById('btnGenerarTurnos');
                const isVisible = btn && btn.style.display !== 'none';
                addChecklist(`Bot√≥n visible: ${isVisible}`, 'PASS');
                testLog(`Estado bot√≥n: ${isVisible ? 'VISIBLE' : 'OCULTO'}`, 'pass');
            } catch (err) {
                addChecklist('verificarYMostrarBoton() ejecutable', 'FAIL');
                testLog(`ERROR: ${err.message}`, 'fail');
            }
        };
        
        const testModalFields = () => {
            testLog('TEST: Campos del modal se populan', 'info');
            
            if (!initializeReferences()) return;
            
            try {
                TurnoManager.mostrarModalGeneracion();
                
                const fields = {
                    'infoMesGeneracion': document.getElementById('infoMesGeneracion'),
                    'infoAnioGeneracion': document.getElementById('infoAnioGeneracion'),
                    'resumenEmpleados': document.getElementById('resumenEmpleados'),
                    'resumenTurnos': document.getElementById('resumenTurnos')
                };
                
                let allOk = true;
                for (const [name, elem] of Object.entries(fields)) {
                    if (!elem) {
                        testLog(`Campo ${name} NO ENCONTRADO`, 'fail');
                        allOk = false;
                    } else {
                        testLog(`${name}: "${elem.textContent}"`, 'pass');
                    }
                }
                
                addChecklist('Todos los campos del modal existen', allOk ? 'PASS' : 'FAIL');
                
                setTimeout(() => TurnoManager.cerrarModalGeneracion(), 2000);
            } catch (err) {
                addChecklist('Campos del modal se populan', 'FAIL');
                testLog(`ERROR: ${err.message}`, 'fail');
            }
        };
        
        const testGenerarTurnos = () => {
            testLog('TEST: generarTurnos()', 'info');
            
            if (!initializeReferences()) return;
            
            try {
                if (typeof TurnoManager?.generarTurnos !== 'function') {
                    addChecklist('generarTurnos() funci√≥n existe', 'FAIL');
                    testLog('ERROR: Funci√≥n no encontrada', 'fail');
                    return;
                }
                
                // Mostrar modal y generar
                TurnoManager.mostrarModalGeneracion();
                setTimeout(() => {
                    TurnoManager.generarTurnos();
                    addChecklist('generarTurnos() se ejecuta', 'PASS');
                    testLog('Generaci√≥n completada', 'pass');
                }, 500);
            } catch (err) {
                addChecklist('generarTurnos() ejecutable', 'FAIL');
                testLog(`ERROR: ${err.message}`, 'fail');
            }
        };
        
        // ========== ORQUESTACI√ìN ==========
        
        const testAll = async () => {
            testLog('üöÄ Iniciando suite de tests...', 'info');
            testLog(`Tiempo: ${new Date().toLocaleTimeString()}`, 'info');
            testLog('-----------------------------------', 'info');
            
            document.getElementById('checklistContainer').innerHTML = '';
            
            testEsCuadranteVacio();
            await new Promise(r => setTimeout(r, 500));
            
            testVerificiarBoton();
            await new Promise(r => setTimeout(r, 500));
            
            testModalFields();
            await new Promise(r => setTimeout(r, 3000));
            
            testMostrarModal();
            await new Promise(r => setTimeout(r, 3000));
            
            testGenerarTurnos();
            
            testLog('-----------------------------------', 'info');
            testLog('‚úÖ Suite de tests completada', 'pass');
        };
        
        // Iniciar autom√°ticamente
        window.addEventListener('load', () => {
            initializeReferences();
            testLog('üü¢ P√°gina cargada', 'pass');
            if (TurnoManager) {
                testLog('‚úì TurnoManager disponible en contexto actual', 'pass');
            } else {
                testLog('‚ö†Ô∏è TurnoManager NO disponible - Ver instrucciones arriba', 'warn');
            }
            testLog('Click "Ejecutar Tests" para comenzar', 'info');
        });
    </script>
</body>
</html>
