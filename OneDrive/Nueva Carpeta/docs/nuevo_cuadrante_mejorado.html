<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light">
    <meta name="supported-color-schemes" content="light">
    <title>Sistema de Gestión de Turnos - Cuadrantes Mensuales</title>
    <script>
        // ⭐ VERSIONADO DE APP - Forzar actualización si versión cambia
        const APP_VERSION = '2026.01.14.v2';
        const lastVersion = localStorage.getItem('appVersion');
        
        if (lastVersion !== APP_VERSION) {
            console.log(`🔄 Versión nueva detectada: ${APP_VERSION}. Limpiando datos obsoletos...`);
            // Limpiar localStorage solo para datos que pueden ser incompatibles
            localStorage.removeItem('turnosAppState');
            localStorage.removeItem('tiposTurnoData');
            localStorage.setItem('appVersion', APP_VERSION);
        }
        
        // Capturar errores antes que nada
        window.addEventListener('error', function(e) {
            console.error('ERROR UNCAUGHT:', e.message, 'en', e.filename, ':', e.lineno);
            document.body.innerHTML = `
                <div style="padding: 20px; background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; border-radius: 5px;">
                    <h2>❌ ERROR CRÍTICO EN JAVASCRIPT</h2>
                    <p><strong>Mensaje:</strong> ${e.message}</p>
                    <p><strong>Archivo:</strong> ${e.filename}</p>
                    <p><strong>Línea:</strong> ${e.lineno}</p>
                    <p><strong>Stack:</strong> <pre>${e.error?.stack || 'No disponible'}</pre></p>
                </div>
            `;
        });
        
        // ⭐ CONFIGURAR MES/AÑO ACTUAL INMEDIATAMENTE (sin parpadeos)
        window.__initialMonth = new Date().getMonth();
        window.__initialYear = new Date().getFullYear();
        
        // ⭐ INICIALIZAR VARIABLES GLOBALES
        if (!window.empleados) {
            window.empleados = [];
        }
        
        // ⭐ CREAR 12 EMPLEADOS POR DEFECTO SI NO EXISTEN EN LOCALSTORAGE
        try {
            // SIEMPRE recrear empleados para sincronizar con modules.js
            const empleadosPorDefecto = [
                { id: 1, nombre: 'María Rodríguez López', departamento: 'Operaciones', localidad: 'Madrid', horasContrato: 160, turnoPrincipal: 'Mañana', estado: 'activo', email: 'maria.rodriguez@empresa.com', telefono: '+34 600 111 222' },
                { id: 2, nombre: 'Carlos Martínez Gutiérrez', departamento: 'Ventas', localidad: 'Barcelona', horasContrato: 140, turnoPrincipal: 'Tarde', estado: 'activo', email: 'carlos.martinez@empresa.com', telefono: '+34 600 222 333' },
                { id: 3, nombre: 'Ana García Pérez', departamento: 'Administración', localidad: 'Valencia', horasContrato: 120, turnoPrincipal: 'Mañana', estado: 'vacaciones', email: 'ana.garcia@empresa.com', telefono: '+34 600 333 444' },
                { id: 4, nombre: 'Javier Sánchez Ruiz', departamento: 'Soporte Técnico', localidad: 'Madrid', horasContrato: 180, turnoPrincipal: 'Noche', estado: 'activo', email: 'javier.sanchez@empresa.com', telefono: '+34 600 444 555' },
                { id: 5, nombre: 'Laura Fernández Díaz', departamento: 'Operaciones', localidad: 'Bilbao', horasContrato: 160, turnoPrincipal: 'Mañana', estado: 'baja', email: 'laura.fernandez@empresa.com', telefono: '+34 600 555 666' },
                { id: 6, nombre: 'Pedro Gómez Martín', departamento: 'Ventas', localidad: 'Barcelona', horasContrato: 140, turnoPrincipal: 'Tarde', estado: 'activo', email: 'pedro.gomez@empresa.com', telefono: '+34 600 666 777' },
                { id: 7, nombre: 'Sofía López Martínez', departamento: 'Administración', localidad: 'Madrid', horasContrato: 120, turnoPrincipal: 'Mañana', estado: 'activo', email: 'sofia.lopez@empresa.com', telefono: '+34 600 777 888' },
                { id: 8, nombre: 'Antony García Rodríguez', departamento: 'Operaciones', localidad: 'Getafe', horasContrato: 160, turnoPrincipal: 'Mañana', estado: 'activo', email: 'antony.garcia@empresa.com', telefono: '+34 600 888 999' },
                { id: 9, nombre: 'Miguel Ángel Ruiz', departamento: 'Administración', localidad: 'Madrid', horasContrato: 160, turnoPrincipal: 'Mañana', estado: 'activo', email: 'miguel.ruiz@empresa.com', telefono: '+34 600 999 000' },
                { id: 10, nombre: 'Elena Beltrán Ocaña', departamento: 'Operaciones', localidad: 'Madrid', horasContrato: 160, turnoPrincipal: 'Tarde', estado: 'activo', email: 'elena.beltran@empresa.com', telefono: '+34 600 000 111' },
                { id: 11, nombre: 'Ricardo Torres Gil', departamento: 'Ventas', localidad: 'Barcelona', horasContrato: 140, turnoPrincipal: 'Mañana', estado: 'activo', email: 'ricardo.torres@empresa.com', telefono: '+34 600 111 222' },
                { id: 12, nombre: 'Isabel Castro León', departamento: 'Limpieza', localidad: 'Madrid', horasContrato: 169, turnoPrincipal: 'Mañana', estado: 'activo', email: 'isabel.castro@empresa.com', telefono: '+34 600 222 333' }
            ];
            
            localStorage.setItem('empleadosData', JSON.stringify(empleadosPorDefecto));
            window.empleados = empleadosPorDefecto;
            console.log('✅ 12 empleados SINCRONIZADOS con modules.js');
        } catch (err) {
            console.error('❌ Error inicializando empleados:', err);
        }
        
        // ⭐ VALIDAR DATOS EN LOCALSTORAGE - SOLO LIMPIAR SI ESTÁN CORRUPTOS
        try {
            const dataGuardada = localStorage.getItem('turnosAppState');
            if (dataGuardada) {
                try {
                    const savedState = JSON.parse(dataGuardada);
                    // Verificar integridad, NO limpiar solo por año
                    if (savedState && (savedState.scheduleData || savedState.currentMonth !== undefined)) {
                        console.log('✓ localStorage válido, datos restaurados');
                    }
                } catch (parseErr) {
                    // Si está corrupto (error JSON), limpiar
                    console.warn('⚠️ localStorage corrupto, limpiando...');
                    localStorage.clear();
                }
            }
        } catch (err) {
            console.error('❌ Error validando localStorage:', err);
        }
    </script>
    <!-- Librerías Externas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Script de monitoreo -->
    <script src="monitoreo_edicion.js"></script>

    <!-- Estilos -->
    <link rel="stylesheet" href="css/estilos_pastel4.css?v=20251214_corp1">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/modales.css">
    <!-- Mejoras visuales sutiles (NO rompe layout) -->
    <link rel="stylesheet" href="css/mejoras_visuales_v2_1.css">
        <style>
            /* Overrides pastel for cache-safe load y evitar temas oscuros cacheados */
            :root { color-scheme: light; }
            body { background: radial-gradient(circle at 15% 20%, #0f172a 0%, #0b1220 40%, #0a0f1c 80%) !important; color: #e5e7eb !important; }
            .container { background: transparent !important; }
            .monthly-schedule-container { background: linear-gradient(180deg, rgba(18,27,45,0.96) 0%, rgba(12,19,33,0.96) 100%) !important; }
            .main-content { background: linear-gradient(160deg, rgba(15,23,42,0.96), rgba(11,18,32,0.96)) !important; }
            header { background: linear-gradient(135deg, #111827 0%, #0b1220 100%) !important; color: #e5e7eb !important; }
            .monthly-header, .calendario-header { background: linear-gradient(135deg, #111827 0%, #0b1220 100%) !important; color: #e2e8f0 !important; }
            .tabs, .legend, .stat-card { background: #0b1220 !important; }
            .monthly-table { border-collapse: separate !important; border-spacing: 8px !important; background: transparent !important; }
            .monthly-table th, .monthly-table th:first-child { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%) !important; color: white !important; padding: 14px 12px !important; font-weight: 700 !important; text-align: center !important; border-radius: 8px !important; box-shadow: 0 0 20px rgba(249, 115, 22, 0.4) !important; }
            .monthly-table td { background: linear-gradient(135deg, rgba(14, 165, 233, 0.08) 0%, rgba(6, 182, 212, 0.06) 100%) !important; color: #0f172a !important; border: 2px solid rgba(14, 165, 233, 0.2) !important; border-radius: 10px !important; padding: 12px 10px !important; text-align: center !important; font-weight: 500 !important; transition: all 0.3s ease !important; }
            .monthly-table td:hover { background: linear-gradient(135deg, rgba(14, 165, 233, 0.15) 0%, rgba(6, 182, 212, 0.12) 100%) !important; border-color: rgba(14, 165, 233, 0.4) !important; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15) !important; transform: translateY(-2px) !important; }
            .monthly-table .employee-name-cell { background: linear-gradient(135deg, #0f172a 0%, #1a1f35 100%) !important; color: #e5e7eb !important; font-weight: 700 !important; border: 2px solid rgba(14, 165, 233, 0.15) !important; border-radius: 10px !important; }
            .monthly-table .employee-name-cell:hover { background: linear-gradient(135deg, #1a1f35 0%, #252d42 100%) !important; border-color: rgba(14, 165, 233, 0.3) !important; }
            header { transition: all 0.3s ease !important; }
            header:hover { box-shadow: 0 0 40px rgba(168, 85, 247, 1), 0 0 80px rgba(147, 51, 234, 0.8), 0 4px 30px rgba(168, 85, 247, 0.9) !important; }
            .tab-btn { color: white !important; border: 2px solid transparent !important; transition: all 0.3s ease !important; }
            .tab-btn.active { border-bottom: 3px solid #22c55e !important; }
            [data-tab="tab-general"] { background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%) !important; }
            [data-tab="tab-general"]:hover { box-shadow: 0 0 30px rgba(74, 222, 128, 1), 0 0 50px rgba(34, 197, 94, 0.9), 0 4px 20px rgba(74, 222, 128, 0.9) !important; }
            [data-tab="tab-individual"] { background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%) !important; }
            [data-tab="tab-individual"]:hover { box-shadow: 0 0 30px rgba(30, 64, 175, 1), 0 0 50px rgba(30, 58, 138, 0.9), 0 4px 20px rgba(30, 64, 175, 0.9) !important; }
            .nav-btn, .action-btn, .edit-btn, .modal-btn { font-size: 14px !important; }
            .edit-btn.save, .modal-btn.apply { background: #22c55e !important; color: #0b1220 !important; }
            .edit-btn.cancel, .modal-btn.cancel { background: #ef4444 !important; color: #0b1220 !important; }
            .notification { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%) !important; color: white !important; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8) !important; }
            .notification.success { background: #22c55e !important; color: #0b1220 !important; }
            .notification.error { background: #ef4444 !important; color: #0b1220 !important; }
            .notification.warning { background: #f59e0b !important; color: #0b1220 !important; }
            .notification.info { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%) !important; color: white !important; }
            .modal-select, .turno-selector { border-color: #ddd !important; background: white !important; color: #1a1a1a !important; }
            #masiva_empleado, #masiva_desde, #masiva_hasta, #masiva_turno { border-color: #ddd !important; background: white !important; color: #1a1a1a !important; }
            #masiva_empleado option, #masiva_desde option, #masiva_hasta option, #masiva_turno option { background: white !important; color: #1a1a1a !important; }
            .calendario-btn-vista { background: #f1f5f9 !important; color: #475569 !important; border: 2px solid #e2e8f0 !important; transition: all 0.3s ease !important; }
            .calendario-btn-vista:hover { background: #e2e8f0 !important; border-color: #cbd5e1 !important; }
            .calendario-btn-vista.active { background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%) !important; border: none !important; color: white !important; box-shadow: 0 0 20px rgba(139, 92, 246, 0.4) !important; }
            .dia-calendario { background: #0f172a !important; color: #e2e8f0 !important; }
            .dia-calendario.hoy { background: rgba(34,197,94,0.15) !important; border: 2px solid #22c55e !important; }
            .dia-calendario.conflicto { background: rgba(239,68,68,0.12) !important; border: 2px solid rgba(239,68,68,0.5) !important; box-shadow: 0 0 10px rgba(239,68,68,0.3) !important; }
            .carga-baja { background: rgba(34,197,94,0.15) !important; }
            .carga-media { background: rgba(245,158,11,0.18) !important; }
            .carga-alta { background: rgba(239,68,68,0.18) !important; }
            .turno.mañana { background: rgba(34,197,94,0.18) !important; color: #16a34a !important; }
            .turno.tarde { background: rgba(249, 115, 22, 0.18) !important; color: #f97316 !important; }
            .turno.noche { background: rgba(59,130,246,0.2) !important; color: #1d4ed8 !important; }
            .turno.mixto { background: rgba(249, 115, 22, 0.15) !important; color: #f97316 !important; }
            .turno.descanso { background: rgba(148,163,184,0.2) !important; color: #e2e8f0 !important; }
            .turno.vacaciones { background: rgba(249, 115, 22, 0.18) !important; color: #f97316 !important; }
            .turno.baja { background: rgba(239,68,68,0.18) !important; color: #ef4444 !important; }
            .turno.festivo { background: rgba(250,204,21,0.18) !important; color: #ca8a04 !important; }
            .turno.libre { background: rgba(148,163,184,0.15) !important; color: #e2e8f0 !important; }
            .employee-name-cell { background: #0f172a !important; color: #e5e7eb !important; }
            .monthly-header h2, .month-title { color: #e2e8f0 !important; }
            /* Botón Seleccionar Rango - efecto hover moderado */
            .edit-btn.bulk { box-shadow: 0 2px 8px rgba(37, 99, 235, 0.25) !important; transition: all 0.3s ease !important; }
            .edit-btn.bulk:hover { box-shadow: 0 4px 16px rgba(59, 130, 246, 0.45), 0 0 20px rgba(59, 130, 246, 0.3) !important; }
        </style>
    
    <!-- Fallback: estilos mínimos si CSS externo no carga -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0e4d9 0%, #e8d9f0 100%);
            min-height: 100vh;
            color: #5a5a5a;
        }
        
        /* Modal fijo: inicialmente no visible */
        .modal {
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s ease !important;
            background: rgba(0, 0, 0, 0) !important;
        }
        
        /* Modal visible cuando tiene clase 'active' */
        .modal.active {
            visibility: visible;
            opacity: 1;
            background: rgba(0, 0, 0, 0.5) !important;
        }
        
        /* ✨ ANIMACIONES PARA NOTIFICACIONES MEJORADAS */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        @keyframes progress {
            from {
                width: 100%;
            }
            to {
                width: 0%;
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .notificacion {
            transition: all 0.3s ease !important;
        }
        
        .notificacion:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4) !important;
        }
        
        /* Estilos cargados desde css/estilos.css - fallback mínimo aquí */
    </style>

    <!-- ✅ INICIALIZACIÓN TEMPRANA DE TURNOMANAGER Y NOTIFICATIONSYSTEM -->
    <script>
        console.log('🟢 [HEAD] Script de inicialización temprana ejecutándose...');
        
        // ✅ CREAR PLACEHOLDER PARA NOTIFICATIONSYSTEM (disponible inmediatamente)
        if (!window.NotificationSystem) {
            window.NotificationSystem = {
                historial: [],
                maxHistorial: 50,
                contadorID: 0,
                grupos: new Map(),
                posicion: 'top-right',
                sonidosActivados: true,
                
                show: function(msg, tipo, dur, opciones) {
                    console.log(`[Notif ${tipo}] ${msg}`);
                    // Agregar al historial
                    this.historial.unshift({
                        id: this.contadorID++,
                        mensaje: msg,
                        tipo: tipo,
                        timestamp: new Date().toLocaleTimeString('es-ES')
                    });
                    if (this.historial.length > this.maxHistorial) {
                        this.historial.pop();
                    }
                    
                    // Crear elemento visual si opciones está disponible
                    if (opciones && opciones.callback) {
                        setTimeout(() => opciones.callback('cerrar'), dur || 3000);
                    }
                },
                
                mostrarHistorial: function() {
                    console.table(this.historial);
                    return this.historial;
                },
                
                limpiarHistorial: function() {
                    this.historial = [];
                    console.log('✅ Historial limpiado');
                },
                
                cerrarNotificacion: function(elemento) {
                    if (elemento && elemento.remove) {
                        elemento.remove();
                    }
                },
                
                activarSonidos: function() {
                    this.sonidosActivados = true;
                    console.log('🔊 Sonidos activados');
                },
                
                desactivarSonidos: function() {
                    this.sonidosActivados = false;
                    console.log('🔇 Sonidos desactivados');
                },
                
                cambiarPosicion: function(pos) {
                    this.posicion = pos;
                    console.log(`🎯 Posición: ${pos}`);
                },
                
                reproducirSonido: function() {
                    // Placeholder - será reemplazado
                }
            };
            console.log('✅ [HEAD] Placeholder NotificationSystem completo creado');
        }
        
        // ✅ CREAR PLACEHOLDER PARA EVITAR ERRORES ANTES QUE SE CARGUE modules.js
        // Las funciones REALES están en js/modules.js como clase TurnoManager estática
        // Este es solo un placeholder que será sobrescrito cuando modules.js se cargue
        
        if (!window.TurnoManager) {
            window.TurnoManager = {};
            console.log('✅ [HEAD] Placeholder TurnoManager creado (será reemplazado por modules.js)');
        }
        
        // Helper para esperar a que la función real esté disponible
        function esperarFuncion(nombreFuncion, maxTiempoMs = 3000) {
            return new Promise((resolve) => {
                let tiempoIntentado = 0;
                const intervalo = setInterval(() => {
                    tiempoIntentado += 50;
                    if (typeof window.TurnoManager[nombreFuncion] === 'function' && 
                        window.TurnoManager[nombreFuncion].toString().indexOf('placeholder') === -1) {
                        clearInterval(intervalo);
                        resolve(true);
                    }
                    if (tiempoIntentado >= maxTiempoMs) {
                        clearInterval(intervalo);
                        console.error(`❌ Timeout esperando ${nombreFuncion}`);
                        resolve(false);
                    }
                }, 50);
            });
        }
        
        // Escuchar evento global de módulos listos
        window.addEventListener('TurnoManagerReady', function() {
            console.log('✅ [HEAD] Evento TurnoManagerReady recibido - módulos cargados');
        });
        
        // ✅ INICIALIZAR MODULE MANAGER TEMPRANO
        if (typeof window.ModuleManager === 'undefined') {
            window.ModuleManager = {
                modules: {},
                
                register: function(name, module) {
                    this.modules[name] = module;
                    console.log(`✅ Módulo registrado: ${name}`);
                    return this;
                },
                
                get: function(name) {
                    const module = this.modules[name];
                    if (!module) {
                        console.warn(`⚠️ Módulo "${name}" no encontrado`);
                        return null;
                    }
                    return module;
                },
                
                list: function() {
                    console.table(Object.keys(this.modules));
                },
                
                loadAll: function() {
                    console.log('📦 Módulos cargados:', Object.keys(this.modules).length);
                    return this.modules;
                },
                
                verificar: function(requiredModules = []) {
                    const missing = requiredModules.filter(name => !this.modules[name]);
                    if (missing.length > 0) {
                        console.warn(`⚠️ Módulos faltantes:`, missing);
                        return false;
                    }
                    console.log(`✅ Todos los módulos requeridos están cargados`);
                    return true;
                }
            };
            console.log('🎛️ ModuleManager inicializado en HEAD');
        }
        
        // ✅ CARGAR NOTIFICATIONSYSTEM COMPLETO INMEDIATAMENTE
        console.log('🔄 [HEAD] Inicializando NotificationSystem completo...');
        
        // Reemplazar el placeholder con la versión completa
        setTimeout(() => {
            if (window.NotificationSystem && !window.NotificationSystem.reproducirSonido) {
                console.log('⏳ Cargando versión completa de NotificationSystem...');
                
                // Se sobrescribirá cuando el script principal cargue
                // Por ahora, agregar método básico que funcione
                window.NotificationSystem.cerrarNotificacion = function(n) {
                    if (n && n.remove) n.remove();
                };
            }
        }, 100);
    </script>
    
    <!-- ✅ CARGAR NOTIFICATIONSYSTEM MEJORADO EN BACKGROUND -->
    <script async>
        // Este script cargará el NotificationSystem en cuanto esté disponible
        window.addEventListener('load', function() {
            console.log('✅ [LOAD EVENT] Página completamente cargada');
            console.log('✅ NotificationSystem disponible:', typeof window.NotificationSystem === 'object');
        });
        
        
        // Placeholder para mostrarModalGeneracion - será reemplazado por la clase en modules.js
        if (!window.TurnoManager.mostrarModalGeneracion) {
            window.TurnoManager.mostrarModalGeneracion = function() {
                console.warn('⚠️ [mostrarModalGeneracion] Placeholder ejecutado - esperando a que modules.js cargue la función real...');
                // Esperar a que modules.js defina la función real
                let intentos = 0;
                const intervalo = setInterval(() => {
                    intentos++;
                    // Verificar si la función real se ha cargado (debe ser una clase/method, no un placeholder)
                    if (typeof window.TurnoManager.mostrarModalGeneracion === 'function' && 
                        window.TurnoManager.mostrarModalGeneracion.constructor.name !== 'Function' ||
                        (window.TurnoManager.mostrarModalGeneracion.toString && 
                         window.TurnoManager.mostrarModalGeneracion.toString().includes('modalGenerarTurnos'))) {
                        clearInterval(intervalo);
                        console.log('✅ [mostrarModalGeneracion] Función real cargada, ejecutando...');
                        window.TurnoManager.mostrarModalGeneracion();
                        return;
                    }
                    // Timeout después de 60 intentos (3 segundos)
                    if (intentos > 60) {
                        clearInterval(intervalo);
                        console.error('❌ [mostrarModalGeneracion] Timeout - modules.js no cargó la función real');
                    }
                }, 50);
            };
        }
        
        // Placeholder para cargarTurnosPorDefecto
        if (!window.TurnoManager.cargarTurnosPorDefecto) {
            window.TurnoManager.cargarTurnosPorDefecto = function() {
                console.warn('⚠️ [cargarTurnosPorDefecto] Placeholder ejecutado - modules.js cargándose...');
                esperarFuncion('cargarTurnosPorDefecto').then(disponible => {
                    if (disponible && typeof window.TurnoManager.cargarTurnosPorDefecto === 'function') {
                        console.log('✅ [cargarTurnosPorDefecto] Función real ahora disponible, ejecutando...');
                        window.TurnoManager.cargarTurnosPorDefecto();
                    }
                });
            };
        }
    </script>

</head>
<body style="background: radial-gradient(circle at 15% 20%, #0f172a 0%, #0b1220 40%, #0a0f1c 80%);">
    <div id="save-indicator" style="position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px; font-size: 13px; display: flex; align-items: center; gap: 8px; z-index: 10000; transition: opacity 0.3s; opacity: 0; pointer-events: none; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
        <span style="color: #4ade80;">✔</span>
        <span>Cambios guardados en JSON local</span>
    </div>

    <style>
        #save-indicator.visible { opacity: 1; }
    </style>
    
    <!-- SIDEBAR CON CONTROLES SEMANA 1-2-3 -->
    <div id="sidebar-container" class="sidebar-container">
        <div class="sidebar-header">
            <h2 class="sidebar-title">🎛️ Control Panel</h2>
        </div>
        
        <!-- SEMANA 1: VALIDACIÓN Y SINCRONIZACIÓN -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">Validación</h3>
            <button class="sidebar-btn semana1" onclick="abrirValidacion()">
                <span class="sidebar-btn-icon">✅</span>
                <span class="sidebar-btn-text">Validar Datos</span>
            </button>
            <button class="sidebar-btn semana1" onclick="abrirAutoGuardado()">
                <span class="sidebar-btn-icon">💾</span>
                <span class="sidebar-btn-text">Auto-guardado</span>
            </button>
        </div>
        
        <!-- SINCRONIZACIÓN -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">Sincronización</h3>
            <button class="sidebar-btn semana1" onclick="abrirSincronizacion()">
                <span class="sidebar-btn-icon">🔄</span>
                <span class="sidebar-btn-text">Multi-Tab Sync</span>
            </button>
        </div>

        <!-- GENERACIÓN DE TURNOS -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">Generación</h3>
            <button class="sidebar-btn semana1" onclick="TurnoManager.generarTurnos()" title="Carga los turnos principales de cada empleado para el mes actual">
                <span class="sidebar-btn-icon">📋</span>
                <span class="sidebar-btn-text">Cargar Por Defecto</span>
            </button>
        </div>
        
        <!-- SEMANA 2: REPORTES E INTEGRACIÓN -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">Reportes</h3>
            <button class="sidebar-btn semana2" onclick="abrirReportes()">
                <span class="sidebar-btn-icon">📋</span>
                <span class="sidebar-btn-text">Generador</span>
            </button>
        </div>
        
        <!-- COMUNICACIÓN -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">Comunicación</h3>
            <button class="sidebar-btn semana2" onclick="abrirWhatsApp()">
                <span class="sidebar-btn-icon">💬</span>
                <span class="sidebar-btn-text">WhatsApp</span>
            </button>
        </div>
        
        <!-- SEMANA 3: ANALÍTICA Y OPTIMIZACIÓN -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">Análisis</h3>
            <button class="sidebar-btn semana3" onclick="ModuleManager.get('SidebarSemana3Module').abrirAnalisis()">
                <span class="sidebar-btn-icon">🚨</span>
                <span class="sidebar-btn-text">Conflictos</span>
            </button>
            <button class="sidebar-btn semana3" onclick="ModuleManager.get('SidebarSemana3Module').abrirMetricas()">
                <span class="sidebar-btn-icon">📊</span>
                <span class="sidebar-btn-text">Métricas</span>
            </button>
        </div>
        
        <!-- OPTIMIZACIÓN -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">Mejora</h3>
            <button class="sidebar-btn semana3" onclick="ModuleManager.get('SidebarSemana3Module').abrirOptimizacion()">
                <span class="sidebar-btn-icon">⚡</span>
                <span class="sidebar-btn-text">Sugerencias</span>
            </button>
        </div>

        <!-- CONFIGURACIÓN LOCAL (MODO PRIVADO) -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">Datos Locales</h3>
            <button class="sidebar-btn" onclick="BackupManager.exportarDatosJSON()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                <span class="sidebar-btn-icon">💾</span>
                <span class="sidebar-btn-text">Respaldar (JSON)</span>
            </button>
            <button class="sidebar-btn" onclick="BackupManager.importarDatosJSON()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <span class="sidebar-btn-icon">📂</span>
                <span class="sidebar-btn-text">Importar (JSON)</span>
            </button>
            <button class="sidebar-btn" onclick="limpiarTodosDatos()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                <span class="sidebar-btn-icon">🗑️</span>
                <span class="sidebar-btn-text">Borrar Todo</span>
            </button>
        </div>
    </div>
    
    <!-- MAIN CONTENT -->
    <div class="main-content">
    <div class="container">
        <header style="background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); padding: 30px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 0 30px rgba(168, 85, 247, 0.8), 0 0 60px rgba(147, 51, 234, 0.6), 0 4px 20px rgba(168, 85, 247, 0.7);">
            <h1>📊 Sistema de Gestión de Turnos - Cuadrantes Mensuales</h1>
            <p class="subtitle">Cuadrantes individuales y generales con edición en tiempo real</p>
            <div style="margin-top: 6px; font-size: 13px; color: #e9d5ff;">Build pastel override v20251214-2 (Serverless)</div>
        </header>

        <div class="top-controls">
            <div class="period-selector">
                <select id="selectYear" class="period-select">
                    <option value="2025">2025</option>
                    <option value="2026" selected>2026</option>
                    <option value="2027">2027</option>
                </select>
                <select id="selectMonth" class="period-select">
                    <option value="0">Enero</option>
                    <option value="1">Febrero</option>
                    <option value="2">Marzo</option>
                    <option value="3">Abril</option>
                    <option value="4">Mayo</option>
                    <option value="5">Junio</option>
                    <option value="6">Julio</option>
                    <option value="7">Agosto</option>
                    <option value="8">Septiembre</option>
                    <option value="9">Octubre</option>
                    <option value="10">Noviembre</option>
                    <option value="11">Diciembre</option>
                </select>
                <button class="nav-btn" id="btnMesAnterior" onclick="cambiarMesWrapper(-1)">◀</button>
                <button class="nav-btn" id="btnMesSiguiente" onclick="cambiarMesWrapper(1)">▶</button>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="action-btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); color: white; box-shadow: 0 2px 5px rgba(139, 92, 246, 0.2);" onclick="EmployeeManager.abrirModal()">👥 Empleados</button>
                <button class="action-btn" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; box-shadow: 0 2px 5px rgba(6, 182, 212, 0.2);" onclick="ConsolidadoDepartamentos.abrirModal()">🏢 Departamentos</button>
                <button class="action-btn" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white; box-shadow: 0 2px 5px rgba(236, 72, 153, 0.2);" onclick="ConsolidadoLocalidades.abrirModal()">📍 Localidades</button>
                <button class="action-btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; box-shadow: 0 2px 5px rgba(245, 158, 11, 0.2);" onclick="ConsolidadoTurnos.abrirModal()">⏰ Turnos</button>
                <button class="action-btn" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; box-shadow: 0 2px 5px rgba(99, 102, 241, 0.2);" onclick="ChatBot.abrirModal()">🤖 Chat</button>
                <button id="btnRecargarDatos" class="action-btn" style="background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); color: white; box-shadow: 0 2px 5px rgba(20, 184, 166, 0.3); transition: all 0.3s ease;" onclick="(function() { const btn = document.getElementById('btnRecargarDatos'); btn.style.opacity = '0.6'; btn.disabled = true; NotificationSystem.show('🔄 Recargando datos...', 'info'); AppState.loadFromStorage().then(() => { UI.generarCuadranteGeneral(); NotificationSystem.show('✅ Datos recargados', 'success'); btn.style.opacity = '1'; btn.disabled = false; }).catch(e => { NotificationSystem.show('❌ Error recargando', 'error'); btn.style.opacity = '1'; btn.disabled = false; }); })()">🔄 Recargar</button>
                <!-- Botón Generar Turnos - Solo visible cuando cuadrante está vacío -->
                <button id="btnGenerarTurnos" class="action-btn" style="display: block !important; z-index: 9999; position: relative; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); animation: pulse 2s infinite; padding: 12px 20px; font-weight: bold; font-size: 16px; border: 2px solid #047857;" onclick="(function() { if (typeof window.TurnoManager?.mostrarModalGeneracion === 'function') { window.TurnoManager.mostrarModalGeneracion(); } else { console.warn('⏳ Esperando a que TurnoManager cargue...'); let intentos = 0; const esperar = setInterval(() => { if (typeof window.TurnoManager?.mostrarModalGeneracion === 'function') { clearInterval(esperar); window.TurnoManager.mostrarModalGeneracion(); } else if (++intentos > 60) { clearInterval(esperar); console.error('❌ Timeout'); alert('Error: módulos no cargaron. Recarga la página'); } }, 100); } })()">📋 GENERAR TURNOS</button>
            </div>
        </div>

        <div class="tabs" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-bottom: 3px solid #f97316; padding: 0; display: flex; gap: 0; box-shadow: 0 2px 8px rgba(249, 115, 22, 0.15);">
            <button class="tab-btn active" data-tab="tab-general" style="border-radius: 0; margin: 0; flex: 1; background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); color: white; font-weight: bold; padding: 10px 16px; border: none; font-size: 13px; transition: all 0.3s ease; cursor: pointer;">📊 Cuadrante</button>
            <button class="tab-btn" data-tab="tab-individual" style="border-radius: 0; margin: 0; flex: 1; background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); color: white; padding: 10px 16px; border: none; font-size: 13px; transition: all 0.3s ease; cursor: pointer;">📈 Informe</button>
        </div>

        <!-- TAB 1: CUADRANTE GENERAL -->
        <div id="tab-general" class="tab-content active">
            <div class="monthly-schedule-container">
                <div class="monthly-header" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); padding: 12px 20px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 0 20px rgba(249, 115, 22, 0.5); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <div style="flex-shrink: 0;">
                        <h2 class="month-title" id="mesTituloGeneral" style="color: white; margin: 0; font-size: 16px; font-weight: 600;">📅 Cuadrante</h2>
                    </div>
                    <div class="month-nav" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="nav-btn" onclick="ExportManager.exportarCuadranteGeneral('pdf')" style="background: white; color: #0f172a; border: 1px solid #0ea5e9; padding: 6px 12px; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 12px; transition: all 0.2s ease;" title="Exportar a PDF">
                            📄 PDF
                        </button>
                        <button class="nav-btn" onclick="ExportManager.exportarCuadranteGeneral('print')" style="background: white; color: #0f172a; border: 1px solid #0ea5e9; padding: 6px 12px; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 12px; transition: all 0.2s ease;" title="Imprimir">
                            🖨️ Imprimir
                        </button>
                    </div>
                </div>
                
                <div class="filtros">
                    <select class="filtro-select" id="filtroDepartamentoGeneral">
                        <option value="">Todos los departamentos</option>
                    </select>
                    
                    <select class="filtro-select" id="filtroEstadoGeneral">
                        <option value="">Todos los estados</option>
                    </select>
                </div>
                
                <div class="edit-controls">
                    <button class="edit-btn bulk" onclick="EdicionMasiva.abrirModal();" style="transition: all 0.2s ease !important; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important; color: white !important; border: none !important; padding: 12px 24px !important; border-radius: 8px !important; font-weight: 600 !important; cursor: pointer !important; font-size: 15px !important; box-shadow: 0 1px 3px rgba(37, 99, 235, 0.15) !important;" onmouseover="this.style.boxShadow='0 2px 4px rgba(37, 99, 235, 0.2) !important'" onmouseout="this.style.boxShadow='0 1px 3px rgba(37, 99, 235, 0.15) !important'">
                        📅 Seleccionar Rango
                    </button>
                    <button class="edit-btn cancel" style="display: none;" onclick="document.getElementById('modalEdicionMasiva').classList.remove('active');">
                        ❌ Cancelar
                    </button>
                </div>
                
                <div id="cuadranteGeneral"></div>
                
                <!-- ╔══════════════════════════════════════════════════════════════════╗ -->
                <!-- ║    ANÁLISIS Y ESTADÍSTICAS - MISMO ANCHO Y ESTÉTICA CUADRANTE   ║ -->
                <!-- ╚══════════════════════════════════════════════════════════════════╝ -->

                <!-- 1️⃣ LEYENDA - Generada dinámicamente desde JavaScript -->
                <div id="leyendaTurnos" style="margin-top: 20px; padding: 20px 24px; background: linear-gradient(135deg, rgba(15, 23, 42, 0.7) 0%, rgba(11, 18, 32, 0.7) 100%); border-radius: 10px; border: 1px solid rgba(139, 92, 246, 0.2); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <!-- Se rellena con JavaScript -->
                </div>

                <!-- 2️⃣ KPIs ESTADÍSTICAS - A lo ancho completo con 4 columnas -->
                <div style="margin-top: 20px;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalEmpleadosGeneral" style="font-size: 32px; font-weight: 700;">0</div>
                            <div class="stat-label" style="font-size: 14px; margin-top: 8px;">Total Empleados</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalHorasGeneral" style="font-size: 32px; font-weight: 700;">0</div>
                            <div class="stat-label" style="font-size: 14px; margin-top: 8px;">Horas Totales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="turnosMañanaGeneral" style="font-size: 32px; font-weight: 700;">0</div>
                            <div class="stat-label" style="font-size: 14px; margin-top: 8px;">Turnos Mañana</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="turnosTardeGeneral" style="font-size: 32px; font-weight: 700;">0</div>
                            <div class="stat-label" style="font-size: 14px; margin-top: 8px;">Turnos Tarde</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="turnosNocheGeneral" style="font-size: 32px; font-weight: 700;">0</div>
                            <div class="stat-label" style="font-size: 14px; margin-top: 8px;">Turnos Noche</div>
                        </div>
                    </div>
                </div>

                <!-- 🔄 BOTÓN RECARGAR DATOS -->
                <div style="margin-top: 16px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="btnRecargarDatos" onclick="recargarDatos()" style="padding: 10px 20px; background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                        🔄 Recargar Datos
                    </button>
                </div>

                <!-- 3️⃣ ANÁLISIS VISUAL - A lo ancho completo -->
                <div style="margin-top: 20px; padding: 24px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%); border-radius: 10px; border: 1px solid rgba(139, 92, 246, 0.25); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.08);">
                    <div id="calendarioVisual" style="min-height: 220px;"></div>
                </div>

                <!-- 4️⃣ PANEL DE FILTROS Y ACCIONES - MÓDULO MODULAR -->
                <div id="panelFiltrosContainer" style="margin-top: 20px;"></div>

                <!-- Vista Previa del Empleado Seleccionado -->
                <div id="vistaPrevia" style="display: none; margin-top: 30px; padding: 36px; background: rgba(17, 24, 39, 0.9); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); border: 2px solid rgba(168, 85, 247, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                        <h3 style="color: #f1f5f9; margin: 0; font-size: 22px; background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 700;">📋 Cuadrante del Empleado</h3>
                        <button onclick="document.getElementById('vistaPrevia').style.display = 'none'; AppState.selectedEmployee = null;" style="background: linear-gradient(135deg, #f3d4d9 0%, #fce4ec 100%); color: #c2185b; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; font-size: 14px;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(193, 24, 91, 0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">✕ Cerrar</button>
                    </div>

                    <div class="vista-previa-grid">
                        <div class="empleado-info-card">
                            <div class="empleado-info-label">Empleado</div>
                            <div id="nombreEmpleado" class="empleado-info-value">-</div>
                        </div>
                        <div class="empleado-info-card">
                            <div class="empleado-info-label">Departamento</div>
                            <div id="deptoEmpleado" class="empleado-info-value">-</div>
                        </div>
                        <div class="empleado-info-card">
                            <div class="empleado-info-label">Horas Contrato</div>
                            <div id="horasEmpleado" class="empleado-info-value">-</div>
                        </div>
                        <div class="empleado-info-card">
                            <div class="empleado-info-label">Turno Principal</div>
                            <div id="turnoEmpleado" class="empleado-info-value">-</div>
                        </div>
                        <div class="empleado-info-card">
                            <div class="empleado-info-label">Días Trabajados</div>
                            <div id="diasEmpleado" class="empleado-info-value">-</div>
                        </div>
                    </div>

                    <!-- Cuadrante Individual (Modal) -->
                    <div id="cuadranteIndividual" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: none; z-index: 9999; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;"></div>

                    <!-- Estadísticas Individual -->
                    <div id="estadisticasIndividual" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>

        <!-- TAB 2: INFORME INDIVIDUAL -->
        <div id="tab-individual" class="tab-content">
            <div class="monthly-schedule-container">
                <div class="monthly-header" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); padding: 30px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 0 30px rgba(249, 115, 22, 0.8), 0 0 60px rgba(234, 88, 12, 0.6), 0 4px 20px rgba(249, 115, 22, 0.7);">
                    <h2 class="month-title" style="color: white; margin: 0; font-size: 28px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 32px;">📊</span>
                        Informe Individual por Centro de Trabajo
                    </h2>
                    <p style="color: rgba(255,255,255,0.9); margin: 12px 0 0 0; font-size: 14px;">Análisis detallado de turnos por localidad, departamento y período</p>
                </div>
                
                <div style="background: rgba(17, 24, 39, 0.9); padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); margin-bottom: 20px; border: 1px solid rgba(14, 165, 233, 0.3);">
                    <h3 style="color: #e2e8f0; margin-top: 0;">🔍 Filtros</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <!-- Localidad -->
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #f1f5f9;">Localidad</label>
                            <select id="selectCentroTrabajo" style="width: 100%; padding: 12px; border: 2px solid #f97316; border-radius: 8px; font-size: 14px; background: #0f172a; color: #f1f5f9; box-shadow: 0 0 10px rgba(249, 115, 22, 0.3);">
                                <option value="">-- Todas las localidades --</option>
                            </select>
                        </div>
                        
                        <!-- Departamento -->
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #f1f5f9;">Departamento</label>
                            <select id="selectDepartamentoIndividual" style="width: 100%; padding: 12px; border: 2px solid #f97316; border-radius: 8px; font-size: 14px; background: #0f172a; color: #f1f5f9; box-shadow: 0 0 10px rgba(249, 115, 22, 0.3);">
                                <option value="">-- Todos los departamentos --</option>
                            </select>
                        </div>
                        
                        <!-- Mes -->
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #f1f5f9;">Mes</label>
                            <select id="selectMesIndividual" style="width: 100%; padding: 12px; border: 2px solid #f97316; border-radius: 8px; font-size: 14px; background: #0f172a; color: #f1f5f9; box-shadow: 0 0 10px rgba(249, 115, 22, 0.3);">
                                <option value="0">Enero</option>
                                <option value="1">Febrero</option>
                                <option value="2">Marzo</option>
                                <option value="3">Abril</option>
                                <option value="4">Mayo</option>
                                <option value="5">Junio</option>
                                <option value="6">Julio</option>
                                <option value="7">Agosto</option>
                                <option value="8">Septiembre</option>
                                <option value="9">Octubre</option>
                                <option value="10">Noviembre</option>
                                <option value="11">Diciembre</option>
                            </select>
                        </div>
                        
                        <!-- Año -->
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #f1f5f9;">Año</label>
                            <select id="selectAnioIndividual" style="width: 100%; padding: 12px; border: 2px solid #f97316; border-radius: 8px; font-size: 14px; background: #0f172a; color: #f1f5f9; box-shadow: 0 0 10px rgba(249, 115, 22, 0.3);">
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                    </div>
                    
                    <button onclick="aplicarFiltrosInforme()" style="background: #0ea5e9; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; box-shadow: 0 2px 5px rgba(14, 165, 233, 0.2);" onmouseover="this.style.boxShadow='0 0 30px rgba(249, 115, 22, 1), 0 0 60px rgba(234, 88, 12, 0.8), 0 6px 20px rgba(249, 115, 22, 0.8)'" onmouseout="this.style.boxShadow='0 2px 5px rgba(14, 165, 233, 0.2)'">Aplicar Filtros</button>
                        🔎 Buscar
                    </button>
                </div>
                
                <div id="resultadosFiltro" style="background: rgba(17, 24, 39, 0.95); padding: 24px; border-radius: 14px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); border: 2px solid rgba(168, 85, 247, 0.3);">
                    <div id="tablaResultados"></div>
                </div>
            </div>
        </div>

        <!-- MODAL DE GESTIÓN DE EMPLEADOS -->
        <div id="modalGestionEmpleados" class="modal" onclick="if(event.target.id === 'modalGestionEmpleados') EmployeeManager.cerrarModal()">
            <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">👥</span>
                        Gestionar Empleados
                    </h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Agrega, edita y controla a todos tus empleados</p>
                </div>

                <!-- BOTONES DE ACCIÓN -->
                <div style="padding: 20px 30px; display: flex; gap: 12px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                    <button class="modal-btn apply" onclick="EmployeeManager.mostrarFormularioNuevo()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7);">
                        ➕ Nuevo Empleado
                    </button>
                    <button class="modal-btn cancel" onclick="EmployeeManager.cerrarModal()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                        ✖️ Cerrar
                    </button>
                </div>

                <!-- FORMULARIO EMPLEADO -->
                <div id="formularioEmpleado" style="display: none; padding: 30px; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, rgba(249, 115, 22, 0.05) 0%, rgba(234, 88, 12, 0.05) 100%);">
                    <h4 style="color: #1e293b; margin: 0 0 20px 0; font-size: 16px; font-weight: 700;">📝 Formulario de Empleado</h4>
                    
                    <input type="hidden" id="empleadoIdEdicion" value="">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Nombre Completo *</label>
                            <input type="text" id="emple_nombre" class="modal-select" placeholder="Ej: María Rodríguez López" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Departamento *</label>
                            <select id="emple_departamento" class="modal-select" onchange="EmployeeManager.actualizarHorasPorDepartamento()" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <option value="">Selecciona departamento</option>
                                <option value="Operaciones">Operaciones</option>
                                <option value="Ventas">Ventas</option>
                                <option value="Administración">Administración</option>
                                <option value="Soporte Técnico">Soporte Técnico</option>
                                <option value="Recursos Humanos">Recursos Humanos</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Localidad *</label>
                            <select id="emple_localidad" class="modal-select" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <option value="">Selecciona localidad</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Teléfono *</label>
                            <input type="tel" id="emple_telefono" class="modal-select" placeholder="Ej: +34 600 123 456" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Email *</label>
                            <input type="email" id="emple_email" class="modal-select" placeholder="Ej: maria@empresa.com" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Horas de Contrato *</label>
                            <input type="number" id="emple_horas" class="modal-select" placeholder="Ej: 160" min="0" max="240" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Turno Principal *</label>
                            <select id="emple_turno" class="modal-select" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <option value="">Selecciona turno</option>
                                <option value="Mañana">Mañana</option>
                                <option value="Tarde">Tarde</option>
                                <option value="Noche">Noche</option>
                                <option value="Mixto">Mixto</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Estado *</label>
                            <select id="emple_estado" class="modal-select" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <option value="activo">Activo</option>
                                <option value="vacaciones">Vacaciones</option>
                                <option value="baja">Baja Médica</option>
                                <option value="inactivo">Inactivo</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="modal-btn apply" onclick="EmployeeManager.guardarEmpleado()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 32px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                            💾 Guardar Empleado
                        </button>
                        <button class="modal-btn cancel" onclick="EmployeeManager.cancelarFormulario()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1;">
                            ❌ Cancelar
                        </button>
                    </div>
                </div>

                <!-- LISTA DE EMPLEADOS -->
                <div style="padding: 30px;">
                    <h4 style="color: #1e293b; margin: 0 0 16px 0; font-size: 16px; font-weight: 700;">📋 Empleados Registrados</h4>
                    <div id="listaEmpleados" style="max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px;">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE GESTIÓN DE DEPARTAMENTOS -->
        <div id="modalGestionDepartamentos" class="modal" onclick="if(event.target.id === 'modalGestionDepartamentos') DepartmentManager.cerrarModal()">
            <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">🏢</span>
                        Gestionar Departamentos
                    </h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Organiza y administra los departamentos de tu empresa</p>
                </div>

                <!-- BOTONES DE ACCIÓN -->
                <div style="padding: 20px 30px; display: flex; gap: 12px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                    <button class="modal-btn apply" onclick="ConsolidadoDepartamentos.mostrarFormularioNuevo()" style="background: linear-gradient(135deg, #f97316 0%, #d97706 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(217, 119, 6, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                        ➕ Nuevo Departamento
                    </button>
                    <button class="modal-btn cancel" onclick="ConsolidadoDepartamentos.cerrarModal()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                        ✖️ Cerrar
                    </button>
                </div>

                <!-- FORMULARIO DEPARTAMENTO -->
                <div id="formularioDepartamento" style="display: none; padding: 30px; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, rgba(249, 115, 22, 0.05) 0%, rgba(217, 119, 6, 0.05) 100%);">
                    <h4 style="color: #1e293b; margin: 0 0 20px 0; font-size: 16px; font-weight: 700;">📝 Formulario de Departamento</h4>
                    
                    <input type="hidden" id="departamentoIdEdicion" value="">
                    
                    <!-- Sección: Información Básica -->
                    <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e2e8f0;">
                        <h5 style="color: #1e293b; margin: 0 0 16px 0; font-size: 13px; font-weight: 700; text-transform: uppercase; color: #64748b;">📌 INFORMACIÓN BÁSICA</h5>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Nombre del Departamento *</label>
                            <input type="text" id="depto_nombre" class="modal-select" placeholder="Ej: Limpieza, Operaciones, Ventas..." style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Descripción</label>
                            <textarea id="depto_descripcion" class="modal-select" placeholder="Describe el propósito de este departamento (opcional)" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; min-height: 80px; resize: vertical; transition: all 0.3s ease;"></textarea>
                        </div>
                    </div>

                    <!-- Sección: Estándares de Trabajo -->
                    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(99, 102, 241, 0.05) 100%); padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #bfdbfe;">
                        <h5 style="color: #1e293b; margin: 0 0 16px 0; font-size: 13px; font-weight: 700; text-transform: uppercase; color: #64748b;">⏰ ESTÁNDARES DE TRABAJO</h5>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 13px;">Horas Semanales</label>
                                <input type="number" id="depto_horasSemanales" value="40" min="0" max="60" class="modal-select" placeholder="40" style="padding: 10px 12px; border: 2px solid #bfdbfe; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <small style="color: #64748b; font-size: 11px; margin-top: 4px; display: block;">Ej: 39 (Limpieza), 40 (General)</small>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 13px;">Días de Trabajo</label>
                                <input type="number" id="depto_diasTrabajo" value="5" min="4" max="7" class="modal-select" placeholder="5" style="padding: 10px 12px; border: 2px solid #bfdbfe; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <small style="color: #64748b; font-size: 11px; margin-top: 4px; display: block;">Ej: 6 (Limpieza), 5 (General)</small>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 13px;">Horas/Día</label>
                                <input type="number" id="depto_horasDiarias" value="8" min="4" max="12" step="0.5" class="modal-select" placeholder="8" style="padding: 10px 12px; border: 2px solid #bfdbfe; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <small style="color: #64748b; font-size: 11px; margin-top: 4px; display: block;">Ej: 6.5 (Limpieza), 8 (General)</small>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="modal-btn apply" onclick="ConsolidadoDepartamentos.guardarDepartamento()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 32px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                            💾 Guardar Departamento
                        </button>
                        <button class="modal-btn cancel" onclick="ConsolidadoDepartamentos.cancelarFormulario()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1;">
                            ❌ Cancelar
                        </button>
                    </div>
                </div>

                <!-- LISTA DE DEPARTAMENTOS -->
                <div style="padding: 30px;">
                    <h4 style="color: #1e293b; margin: 0 0 16px 0; font-size: 16px; font-weight: 700;">📋 Departamentos Registrados</h4>
                    <div id="listaDepartamentos" style="max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px;">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE GESTIÓN DE LOCALIDADES -->
        <div id="modalGestionLocalidades" class="modal" onclick="if(event.target.id === 'modalGestionLocalidades') ConsolidadoLocalidades.cerrarModal()">
            <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">📍</span>
                        Gestionar Localidades
                    </h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Organiza las ubicaciones o sucursales de tu empresa</p>
                </div>

                <!-- BOTONES DE ACCIÓN -->
                <div style="padding: 20px 30px; display: flex; gap: 12px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                    <button class="modal-btn apply" onclick="ConsolidadoLocalidades.mostrarFormularioNuevo()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                        ➕ Nueva Localidad
                    </button>
                    <button class="modal-btn cancel" onclick="ConsolidadoLocalidades.cerrarModal()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                        ✖️ Cerrar
                    </button>
                </div>

                <!-- FORMULARIO LOCALIDAD -->
                <div id="formularioLocalidad" style="display: none; padding: 30px; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, rgba(236, 72, 153, 0.05) 0%, rgba(219, 39, 119, 0.05) 100%);">
                    <h4 style="color: #1e293b; margin: 0 0 20px 0; font-size: 16px; font-weight: 700;">📝 Formulario de Localidad</h4>
                    
                    <input type="hidden" id="localidadIdEdicion" value="">
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Nombre de la Localidad *</label>
                        <input type="text" id="loc_nombre" class="modal-select" placeholder="Ej: Madrid, Barcelona, Valencia..." style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="modal-btn apply" onclick="ConsolidadoLocalidades.guardarLocalidad()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 32px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                            💾 Guardar Localidad
                        </button>
                        <button class="modal-btn cancel" onclick="ConsolidadoLocalidades.limpiarFormulario()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1;">
                            ❌ Cancelar
                        </button>
                    </div>
                </div>

                <!-- LISTA DE LOCALIDADES -->
                <div style="padding: 30px;">
                    <h4 style="color: #1e293b; margin: 0 0 16px 0; font-size: 16px; font-weight: 700;">📋 Localidades Registradas</h4>
                    <div id="listaLocalidades" style="max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px;">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE GESTIÓN DE TIPOS DE TURNOS -->
        <div id="modalGestionTurnos" class="modal" onclick="if(event.target.id === 'modalGestionTurnos') ConsolidadoTurnos.cerrarModal()">
            <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">⏰</span>
                        Gestionar Tipos de Turnos
                    </h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Define y personaliza los tipos de turnos de tu empresa</p>
                </div>

                <!-- BOTONES DE ACCIÓN -->
                <div style="padding: 20px 30px; display: flex; gap: 12px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                    <button class="modal-btn apply" onclick="ConsolidadoTurnos.mostrarFormularioNuevo()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                        ➕ Nuevo Tipo de Turno
                    </button>
                    <button class="modal-btn cancel" onclick="ConsolidadoTurnos.cerrarModal()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                        ✖️ Cerrar
                    </button>
                </div>

                <!-- FORMULARIO TURNO -->
                <div id="formularioTurno" style="display: none; padding: 30px; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, rgba(244, 63, 94, 0.05) 0%, rgba(225, 29, 72, 0.05) 100%);">
                    <h4 style="color: #1e293b; margin: 0 0 20px 0; font-size: 16px; font-weight: 700;">📝 Formulario de Tipo de Turno</h4>
                    
                    <input type="hidden" id="turnoIdEdicion" value="">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Nombre del Turno *</label>
                            <input type="text" id="turno_nombre" class="modal-select" placeholder="Ej: Mañana, Tarde, Noche..." style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Inicial *</label>
                            <input type="text" id="turno_inicial" class="modal-select" placeholder="Ej: M, T, N..." maxlength="2" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Horario</label>
                            <input type="text" id="turno_horario" class="modal-select" placeholder="Ej: 08:00-16:00" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Horas *</label>
                            <input type="number" id="turno_horas" class="modal-select" placeholder="Ej: 8.5" min="0" max="24" step="0.25" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">🎨 Color del Turno</label>
                        <div style="display: flex; gap: 12px; align-items: flex-end;">
                            <input type="color" id="turno_color" style="padding: 5px; border: 2px solid #e2e8f0; border-radius: 8px; width: 70px; height: 44px; cursor: pointer; transition: all 0.3s ease;">
                            <input type="text" id="turno_color_hex" class="modal-select" placeholder="#d4edda" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; flex: 1; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="modal-btn apply" onclick="ConsolidadoTurnos.guardarTurno()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 32px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                            💾 Guardar Tipo de Turno
                        </button>
                        <button class="modal-btn cancel" onclick="ConsolidadoTurnos.limpiarFormulario()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1;">
                            ❌ Cancelar
                        </button>
                    </div>
                </div>

                <!-- LISTA DE TURNOS -->
                <div style="padding: 30px;">
                    <h4 style="color: #1e293b; margin: 0 0 16px 0; font-size: 16px; font-weight: 700;">📋 Tipos de Turnos Registrados</h4>
                    <div id="listaTurnos" style="max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px;">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Script para sincronizar inputs de color del turno -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const colorPicker = document.getElementById('turno_color');
                const colorHex = document.getElementById('turno_color_hex');
                
                if (colorPicker && colorHex) {
                    // Sincronizar color picker → hex
                    colorPicker.addEventListener('change', (e) => {
                        colorHex.value = e.target.value;
                    });
                    
                    // Sincronizar hex → color picker
                    colorHex.addEventListener('change', (e) => {
                        if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                            colorPicker.value = e.target.value;
                        }
                    });
                    
                    // Sincronizar en tiempo real para el hex input
                    colorHex.addEventListener('input', (e) => {
                        if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                            colorPicker.value = e.target.value;
                        }
                    });
                }
            });
        </script>

        <!-- MODAL DE DESCRIPCIÓN Y EDICIÓN DE TURNO -->
        <div id="modalDescripcionTurno" class="modal" style="z-index: 10001;" onclick="if(event.target.id === 'modalDescripcionTurno') TurnoEditor.cerrarModalDescripcion()">
            <div class="modal-content" style="max-width: 650px; max-height: 90vh; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 id="tituloTurnoModal" style="margin: 0; font-size: 24px; font-weight: 700;">📋 Detalles del Turno</h3>
                </div>

                <!-- BOTONES STICKY -->
                <div style="padding: 20px 30px; display: flex; gap: 12px; border-bottom: 1px solid #e2e8f0; background: #f8fafc; position: sticky; top: 0; z-index: 10;">
                    <button class="modal-btn apply" onclick="TurnoEditor.guardarDescripcion()" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3); flex: 1;" title="Guardar el turno actual" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(34, 197, 94, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(34, 197, 94, 0.3)'">
                        ✅ Guardar Cambios
                    </button>
                    <button class="modal-btn cancel" onclick="TurnoEditor.cerrarModalDescripcion()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;" title="Cerrar sin guardar" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                        ❌ Cerrar
                    </button>
                </div>

                <!-- CONTENIDO CON SCROLL -->
                <div style="max-height: 70vh; overflow-y: auto;">
                    <!-- INFORMACIÓN GENERAL -->
                    <div style="padding: 30px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 28px;">
                            <div style="padding: 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(30, 64, 175, 0.08) 100%); border-radius: 10px; border-left: 3px solid #3b82f6;">
                                <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">Tipo de Turno</label>
                                <div id="tipoTurnoDesc" style="font-size: 18px; color: #1e293b; font-weight: bold;">-</div>
                            </div>
                            
                            <div style="padding: 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, rgba(22, 163, 74, 0.08) 100%); border-radius: 10px; border-left: 3px solid #22c55e;">
                                <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">Horario</label>
                                <div id="horarioTurnoDesc" style="font-size: 16px; color: #1e293b; font-weight: 600;">-</div>
                            </div>
                            
                            <div style="padding: 16px; background: linear-gradient(135deg, rgba(244, 63, 94, 0.08) 0%, rgba(225, 29, 72, 0.08) 100%); border-radius: 10px; border-left: 3px solid #f43f5e;">
                                <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">Horas Estándar</label>
                                <div id="horasEstandarDesc" style="font-size: 18px; color: #1e293b; font-weight: bold;">-</div>
                            </div>
                            
                            <div style="padding: 16px; background: linear-gradient(135deg, rgba(251, 146, 60, 0.08) 0%, rgba(234, 88, 12, 0.08) 100%); border-radius: 10px; border-left: 3px solid #f97316;">
                                <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">Empleado</label>
                                <div id="empleadoDesc" style="font-size: 15px; color: #1e293b;">-</div>
                            </div>
                            
                            <div style="padding: 16px; background: linear-gradient(135deg, rgba(168, 85, 247, 0.08) 0%, rgba(126, 34, 206, 0.08) 100%); border-radius: 10px; border-left: 3px solid #a855f7;">
                                <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">Día</label>
                                <div id="diaDesc" style="font-size: 15px; color: #1e293b;">-</div>
                            </div>
                            
                            <div style="padding: 16px; background: linear-gradient(135deg, rgba(236, 72, 153, 0.08) 0%, rgba(190, 24, 93, 0.08) 100%); border-radius: 10px; border-left: 3px solid #ec4899;">
                                <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">Fecha</label>
                                <div id="fechaDesc" style="font-size: 15px; color: #1e293b;">-</div>
                            </div>
                        </div>

                        <!-- EDITAR HORAS -->
                        <div style="padding: 20px; background: linear-gradient(135deg, #eff6ff 0%, #f0f9ff 100%); border: 2px solid #bfdbfe; border-radius: 12px; margin-bottom: 28px;">
                            <label style="display: block; font-weight: 700; color: #1e40af; margin-bottom: 12px; font-size: 15px;">⏱️ Editar Horas Trabajadas</label>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input type="number" id="horasEditarTurno" min="0" max="24" step="0.5" style="padding: 12px 14px; border: 2px solid #bfdbfe; border-radius: 8px; width: 120px; font-size: 15px; font-weight: 600; background: white; color: #1e40af; transition: all 0.3s ease;">
                                <span style="color: #1e40af; font-weight: 600;">horas</span>
                            </div>
                            <div style="font-size: 13px; color: #1e40af; margin-top: 10px; opacity: 0.8;">
                                💡 Ingresa las horas reales trabajadas en este día (0-24)
                            </div>
                        </div>

                        <!-- BOTONES RÁPIDOS -->
                        <div style="margin-bottom: 24px;">
                            <label style="display: block; font-weight: 700; color: #1e293b; margin-bottom: 12px; font-size: 15px;">🚀 Turnos Rápidos</label>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;" id="opcionesTurnosRapidas"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE CHAT INTELIGENTE -->
        <div id="modalChatBot" class="modal" onclick="if(event.target.id === 'modalChatBot') ChatBot.cerrarModal()">
            <div class="modal-content" style="max-width: 700px; max-height: 80vh; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">🤖</span>
                        Asistente Inteligente
                    </h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Pregúntame sobre empleados, turnos y la aplicación</p>
                </div>

                <!-- CONTENIDO DEL CHAT -->
                <div id="chatContainer" style="height: 400px; display: flex; flex-direction: column;">
                    <!-- MENSAJES -->
                    <div id="chatMessages" style="flex: 1; padding: 20px; overflow-y: auto; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                        <div style="text-align: center; color: #64748b; font-style: italic; margin-top: 20px;">
                            ¡Hola! Soy tu asistente inteligente. Pregúntame sobre empleados, turnos o la aplicación.
                            <br><br>
                            <strong>Ejemplos:</strong><br>
                            • "¿Cuántos empleados hay?"<br>
                            • "¿Turnos de María Rodríguez?"<br>
                            • "¿Estadísticas del mes?"<br>
                            • "ayuda"
                        </div>
                    </div>

                    <!-- INPUT -->
                    <div style="padding: 20px; background: white; border-top: 1px solid #e2e8f0;">
                        <div style="display: flex; gap: 12px;">
                            <input type="text" id="chatInput" placeholder="Escribe tu pregunta aquí..." style="flex: 1; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.3s ease;" onkeypress="if(event.key === 'Enter') ChatBot.enviarMensaje()">
                            <button onclick="ChatBot.enviarMensaje()" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);">
                                📤 Enviar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- BOTONES DE ACCIÓN -->
                <div style="padding: 20px 30px; border-top: 1px solid #e2e8f0; background: #f8fafc; display: flex; gap: 12px;">
                    <button onclick="ChatBot.limpiarChat()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                        🗑️ Limpiar Chat
                    </button>
                    <button onclick="ChatBot.cerrarModal()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1;">
                        ✖️ Cerrar
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL DE GENERACIÓN DE TURNOS POR DEFECTO -->
        <div id="modalGenerarTurnos" class="modal" onclick="if(event.target.id === 'modalGenerarTurnos') TurnoManager.cerrarModalGeneracion()">
            <div class="modal-content" style="max-width: 650px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">📋</span>
                        Generar Turnos Por Defecto
                    </h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Asigna los turnos principales a todos los días laborales</p>
                </div>

                <!-- CONTENIDO -->
                <div style="padding: 30px;">
                    <!-- Info del mes -->
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #10b981; margin-bottom: 24px;">
                        <h4 style="color: #047857; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">📆 Período a Generar</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div style="padding: 12px; background: white; border-radius: 8px; border: 2px solid #d1fae5;">
                                <span style="color: #6b7280; font-size: 12px; font-weight: 600;">MES</span>
                                <div style="color: #047857; font-size: 18px; font-weight: 700; margin-top: 4px;" id="infoMesGeneracion">Enero</div>
                            </div>
                            <div style="padding: 12px; background: white; border-radius: 8px; border: 2px solid #d1fae5;">
                                <span style="color: #6b7280; font-size: 12px; font-weight: 600;">AÑO</span>
                                <div style="color: #047857; font-size: 18px; font-weight: 700; margin-top: 4px;" id="infoAnioGeneracion">2026</div>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen -->
                    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #3b82f6; margin-bottom: 24px;">
                        <h4 style="color: #1e40af; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">📊 Resumen</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                            <div>
                                <span style="color: #6b7280;">Empleados:</span>
                                <span style="color: #1e40af; font-weight: 700;" id="resumenEmpleados">0</span>
                            </div>
                            <div>
                                <span style="color: #6b7280;">Turnos a generar:</span>
                                <span style="color: #1e40af; font-weight: 700;" id="resumenTurnos">~0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Aclaración -->
                    <div style="padding: 16px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #22c55e; margin-bottom: 24px;">
                        <p style="margin: 0; color: #166534; font-size: 14px; line-height: 1.6;">
                            <strong>✅ Se asignarán:</strong> Turno principal de cada empleado a todos los días laborales
                        </p>
                        <p style="margin: 12px 0 0 0; color: #166534; font-size: 14px; line-height: 1.6;">
                            <strong>⏸️ Se respetarán:</strong> Domingos, festivos, bajas y vacaciones (no se sobrescriben)
                        </p>
                    </div>

                    <!-- Advertencia -->
                    <div style="padding: 16px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 24px;">
                        <p style="margin: 0; color: #92400e; font-size: 13px; line-height: 1.6;">
                            <strong>⚠️ Nota:</strong> Esta acción solo afecta al mes actual. Si ya existen turnos asignados, no serán modificados.
                        </p>
                    </div>
                </div>

                <!-- BOTONES -->
                <div style="padding: 20px 30px; border-top: 1px solid #e2e8f0; background: #f8fafc; display: flex; gap: 12px; border-radius: 0 0 16px 16px;">
                    <button onclick="TurnoManager.cerrarModalGeneracion()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1;">
                        ❌ Cancelar
                    </button>
                    <button onclick="TurnoManager.generarTurnos()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                        ✅ Generar Turnos
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL DE EDICIÓN MASIVA MEJORADO -->
        <div id="modalEdicionMasiva" class="modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; z-index: 10000;">
            <div class="modal-content" style="max-width: 750px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO CON BOTONES -->
                <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); padding: 20px 30px; border-radius: 16px 16px 0 0; color: white; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100;">
                    <div>
                        <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 28px;">⚡</span>
                            Edición Masiva de Turnos
                        </h3>
                        <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Asigna turnos a múltiples empleados en un solo paso</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="modal-btn cancel" onclick="document.getElementById('modalEdicionMasiva').classList.remove('active');" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.5); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s ease; white-space: nowrap;">
                            ✖️ Cancelar
                        </button>
                        <button class="modal-btn apply" onclick="EdicionMasiva.aplicarCambios();" style="background: rgba(255,255,255,0.25); color: white; border: 2px solid rgba(255,255,255,0.8); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s ease; white-space: nowrap;">
                            ✅ Aplicar
                        </button>
                    </div>
                </div>

                <!-- CONTENIDO -->
                <div style="padding: 30px;">
                    <!-- PASO 1: EMPLEADO -->
                    <div style="margin-bottom: 28px; padding: 20px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%); border-radius: 12px; border-left: 4px solid #6366f1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span style="background: #6366f1; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;">1</span>
                            <label style="font-weight: 700; font-size: 15px; color: #1e293b; margin: 0;">👤 Seleccionar Empleado</label>
                        </div>
                        <select id="masiva_empleado" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease; cursor: pointer;">
                            <option value="">-- Elige un empleado --</option>
                        </select>
                    </div>

                    <!-- PASO 2: MES Y AÑO (NUEVO) -->
                    <div style="margin-bottom: 28px; padding: 20px; background: linear-gradient(135deg, rgba(168, 85, 247, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%); border-radius: 12px; border-left: 4px solid #a855f7;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span style="background: #a855f7; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;">2</span>
                            <label style="font-weight: 700; font-size: 15px; color: #1e293b; margin: 0;">📆 Mes y Año</label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                            <div>
                                <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px; font-weight: 600;">Mes:</label>
                                <select id="masiva_mes" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                    <option value="">-- Selecciona mes --</option>
                                    <option value="0">Enero</option>
                                    <option value="1">Febrero</option>
                                    <option value="2">Marzo</option>
                                    <option value="3">Abril</option>
                                    <option value="4">Mayo</option>
                                    <option value="5">Junio</option>
                                    <option value="6">Julio</option>
                                    <option value="7">Agosto</option>
                                    <option value="8">Septiembre</option>
                                    <option value="9">Octubre</option>
                                    <option value="10">Noviembre</option>
                                    <option value="11">Diciembre</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px; font-weight: 600;">Año:</label>
                                <select id="masiva_anio" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                    <option value="">-- Selecciona año --</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- PASO 3: FECHAS -->
                    <div style="margin-bottom: 28px; padding: 20px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, rgba(59, 130, 246, 0.08) 100%); border-radius: 12px; border-left: 4px solid #22c55e;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span style="background: #22c55e; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;">3</span>
                            <label style="font-weight: 700; font-size: 15px; color: #1e293b; margin: 0;">📅 Rango de Fechas</label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                            <div>
                                <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px; font-weight: 600;">Desde:</label>
                                <select id="masiva_desde" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                    <option value="">Día inicio</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px; font-weight: 600;">Hasta:</label>
                                <select id="masiva_hasta" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                    <option value="">Día fin</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- PASO 4: TURNO -->
                    <div style="margin-bottom: 28px; padding: 20px; background: linear-gradient(135deg, rgba(244, 63, 94, 0.08) 0%, rgba(249, 115, 22, 0.08) 100%); border-radius: 12px; border-left: 4px solid #f43f5e;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span style="background: #f43f5e; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;">4</span>
                            <label style="font-weight: 700; font-size: 15px; color: #1e293b; margin: 0;">🎯 Nuevo Turno/Estado</label>
                        </div>
                        <select id="masiva_turno" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                            <option value="">-- Selecciona turno --</option>
                            <option value="mañana">☀️ Mañana (08:00-16:00)</option>
                            <option value="tarde">🌤️ Tarde (16:00-00:00)</option>
                            <option value="noche">🌙 Noche (00:00-08:00)</option>
                            <option value="mixto">⚡ Mixto</option>
                            <option value="descanso">😴 Descanso</option>
                            <option value="vacaciones">🏖️ Vacaciones</option>
                            <option value="baja">🏥 Baja Médica</option>
                            <option value="libre">✨ Libre</option>
                        </select>
                    </div>

                    <!-- RESUMEN -->
                    <div style="padding: 20px; background: linear-gradient(135deg, #eff6ff 0%, #f0f9ff 100%); border: 2px solid #bfdbfe; border-radius: 12px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <span style="font-size: 20px;">📊</span>
                            <strong style="color: #1e40af; font-size: 15px;">Resumen de cambios</strong>
                        </div>
                        <div id="masiva_resumen" style="color: #1e40af; font-size: 14px; line-height: 1.6;">
                            Selecciona empleado, rango de fechas y turno para ver el resumen
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </div>
        </div>

        <!-- MODAL DE INFORME INDIVIDUAL -->
        <!-- MODAL DE INFORME INDIVIDUAL - ELIMINADO (Se usa la pestaña en su lugar) -->

        <!-- MODALES PARA CONTROLES SIDEBAR (Semana 1, 2, 3, 4) -->
        <div id="modalSemana1" class="modal" style="z-index: 9999;">
            <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e2e8f0;">
                    <h2 id="modalSemana1Title" style="margin: 0; color: #1e293b;">Modal Semana 1</h2>
                    <button onclick="document.getElementById('modalSemana1').classList.remove('active')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b;">✕</button>
                </div>
                <div id="modalSemana1Content" style="padding: 20px;"></div>
            </div>
        </div>

        <div id="modalSemana2" class="modal" style="z-index: 9999;">
            <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e2e8f0;">
                    <h2 id="modalSemana2Title" style="margin: 0; color: #1e293b;">Modal Semana 2</h2>
                    <button onclick="document.getElementById('modalSemana2').classList.remove('active')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b;">✕</button>
                </div>
                <div id="modalSemana2Content" style="padding: 20px;"></div>
            </div>
        </div>

        <div id="modalSemana3" class="modal" style="z-index: 9999;">
            <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e2e8f0;">
                    <h2 id="modalSemana3Title" style="margin: 0; color: #1e293b;">Modal Semana 3</h2>
                    <button onclick="document.getElementById('modalSemana3').classList.remove('active')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b;">✕</button>
                </div>
                <div id="modalSemana3Content" style="padding: 20px;"></div>
            </div>
        </div>

        <div id="modalSemana4" class="modal" style="z-index: 9999;">
            <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e2e8f0;">
                    <h2 id="modalSemana4Title" style="margin: 0; color: #1e293b;">Calendario iCalendar</h2>
                    <button onclick="document.getElementById('modalSemana4').classList.remove('active')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b;">✕</button>
                </div>
                <div id="modalSemana4Content" style="padding: 20px;"></div>
            </div>
        </div>

        <div class="footer">
            <p>Sistema de Gestión de Turnos v8.0 | Cuadrantes editables en tiempo real</p>
            <p>Haz clic en cualquier turno para editarlo</p>
        </div>
    </div>

    <!-- Módulos JavaScript - Orden de carga crítico -->
    
    <!-- ⏳ GUARDIAS GLOBALES - Carga PRIMERO para evitar errores de referencias indefinidas -->
    <script src="js/guardias-globales.js?v=2026.01.14.v2"></script>
    
    <!-- ✅ MÓDULOS PRINCIPALES -->
    <script src="js/modules.js?v=2026.01.14.v2"></script>

    <!-- 🚀 FASE 1: SidebarSemana3Module - Carga ANTES de otros módulos para evitar dependencias -->
    <script src="js/controles-sidebar-semana3.js"></script>

    <!-- 🏢 FASE 2: Gestión de Departamentos - Sistema extensible -->
    <script src="js/departamentos-manager.js"></script>

    <!-- 🏢 CONSOLIDADO: Sistema Unificado de Departamentos (Interface Modular) -->
    <script src="js/consolidado-departamentos.js"></script>

    <!-- � TIPO DE TURNOS: Gestión de Tipos de Turnos (mañana, tarde, noche, etc.) -->
    <script src="js/turnos-types-manager.js"></script>

    <!-- 📅 CONSOLIDADO: Sistema Unificado de Tipos de Turnos (Interface Modular) -->
    <script src="js/consolidado-turnos.js"></script>

    <!-- 📍 LOCALIDADES: Gestión de Localidades (Getafe, Leganés, Madrid, etc.) -->
    <script src="js/localidades-manager.js"></script>

    <!-- 📍 CONSOLIDADO: Sistema Unificado de Localidades (Interface Modular) -->
    <script src="js/consolidado-localidades.js"></script>

    <!-- �📋 FASE 2: Generador de Turnos por Departamento -->
    <script src="js/generador-turnos-departamentos.js"></script>

    <!-- ⚖️ FASE 2: Balanceador Automático de Turnos -->
    <script src="js/balanceador-turnos.js"></script>

    <!-- � SISTEMA REACTIVO: Propagación automática de cambios -->
    <script src="js/sistema-reactividad.js"></script>

    <!-- �🔗 FASE 2: Integración UI de Departamentos -->
    <script src="js/ui-integracion-departamentos.js"></script>
    
    <!-- Diagnóstico de carga de módulos -->
    <script>
        // Pequeña espera para asegurar que modules.js se ejecutó
        setTimeout(() => {
            console.log('🔍 [DIAGNÓSTICO] Estado después de modules.js:');
            console.log('   - window.TurnoManager:', typeof window.TurnoManager);
            console.log('   - window.TurnoManager.mostrarModalGeneracion:', typeof window.TurnoManager?.mostrarModalGeneracion);
            console.log('   - window.AppState:', typeof window.AppState);
            console.log('   - window.UI:', typeof window.UI);
            
            if (typeof window.TurnoManager?.mostrarModalGeneracion !== 'function') {
                console.error('❌ [DIAGNÓSTICO] TurnoManager.mostrarModalGeneracion NO CARGÓ correctamente');
            } else {
                console.log('✅ [DIAGNÓSTICO] TurnoManager.mostrarModalGeneracion está disponible');
            }
        }, 100);
    </script>

    <!-- DocumentAnalyzer - Análisis inteligente de documentación (sin API externa) -->
    <script src="js/documentAnalyzer.js"></script>

    <!-- OBSOLETO: Archivo antiguo de balanceo (reemplazado por FASE 2 - balanceador-turnos.js) -->
    <!-- <script src="js/balanceo-y-restricciones.js"></script> -->

    <!-- 3. Reportes avanzados y predicción de conflictos - DESHABILITADO TEMPORALMENTE -->
    <!-- <script src="js/reportes-y-prediccion.js"></script> -->

    <!-- 4. Soporte multi-local y multi-departamento - DESHABILITADO TEMPORALMENTE -->
    <!-- <script src="js/soporte-multilocal.js"></script> -->

    <!-- 5. Calendario visual interactivo -->
    <script src="js/calendario-visual.js"></script>

    <!-- 6. Análisis de Equidad y Carga de Trabajo - MÓDULO MODULAR -->
    <link rel="stylesheet" href="css/analisis-equidad.css">
    <script src="js/analisis-equidad.js"></script>

    <!-- 7. Panel de Filtros y Acciones - MÓDULO MODULAR -->
    <link rel="stylesheet" href="css/panel-filtros.css">
    <script src="js/panel-filtros.js"></script>

    <!-- ✅ SEMANA 1: NUEVOS MÓDULOS DE MEJORA -->
    <!-- 7. Validador centralizado de datos -->
    <script src="js/validador-datos.js"></script>

    <!-- 7. Autoguardado automático -->
    <script src="js/auto-save.js"></script>
    <!-- 7.1 UI del Autoguardado (Modular) -->
    <script src="js/auto-save-ui.js"></script>
    <!-- 7.2 Autoguardado con Persistencia BD (Modular) - DESHABILITADO POR MODO LOCAL -->
    <!-- <script src="js/auto-save-bd.js"></script> -->

    <!-- 8. Sincronización entre pestañas -->
    <script src="js/tab-sync.js"></script>

    <!-- ✅ VERIFICACIÓN AUTOMÁTICA DEL SISTEMA A+B -->
    <script src="js/verificacion-automatica.js"></script>

    <!-- ✅ SEMANA 2: NUEVOS MÓDULOS AVANZADOS -->
    <!-- 9. Generador de reportes -->
    <script src="js/generador-reportes.js"></script>

    <!-- 10. Integración con WhatsApp -->
    <script src="js/integracion-whatsapp.js"></script>

    <!-- 10.5. WhatsApp Sender (módulo independiente) -->
    <script src="js/whatsapp-sender.js"></script>

    <!-- 11. Sincronización de datos y backup -->
    <script src="js/sincronizacion-datos.js"></script>

    <!-- ✅ SEMANA 3: MÓDULOS ANALÍTICA Y OPTIMIZACIÓN -->
    <!-- 12. Analizador de conflictos -->
    <script src="js/analizador-conflictos.js"></script>

    <!-- 13. Dashboard con analítica -->
    <script src="js/dashboard-analytica.js"></script>

    <!-- 14. Optimizador inteligente de turnos -->
    <script src="js/optimizador-turnos.js"></script>

    <!-- 15. Controles UI para Semana 3 -->
    <script src="js/control-base.js"></script>

    <!-- 15. Controles UI para Semana 3 -->
    <script src="js/controles-semana-3.js"></script>

    <!-- 16. Controles UI para Semana 1 -->
    <script src="js/controles-semana-1.js"></script>

    <!-- 17. Controles UI para Semana 2 -->
    <script src="js/controles-semana-2.js"></script>

    <!-- 18. Gestor del Sidebar -->
    <script src="js/sidebar-manager.js"></script>

    <!-- 19. Debug Manager -->
    <script src="js/debug-manager.js"></script>

    <!-- Script para manejar las pestañas -->
    <script>
        setTimeout(() => {
            // Manejar el cambio de pestañas
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = e.target.dataset.tab;
                    
                    // Remover clase active de todos los botones y contenidos
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                    
                    // Agregar clase active al botón y contenido seleccionado
                    e.target.classList.add('active');
                    const selectedTab = document.getElementById(tabId);
                    if (selectedTab) {
                        selectedTab.classList.add('active');
                        console.log('✓ Tab cambiado a:', tabId);
                        
                        // Reinicializar filtros cuando se abre el Informe
                        if (tabId === 'tab-individual') {
                            console.log('🔄 Reinicializando filtros del Informe...');
                            if (typeof llenarCentrosDeTrabajo !== 'undefined') {
                                llenarCentrosDeTrabajo();
                            }
                            if (typeof llenarDepartamentosInforme !== 'undefined') {
                                llenarDepartamentosInforme();
                            }
                        }
                    }
                });
            });
            console.log('✓ Event listeners de tabs configurados');
        }, 100);
    </script>

    <!-- Script de inicialización principal - REMOVIDO: botones ahora usan onclick inline -->
    
    <!-- Script para inicializar controles del calendario -->
    <script>
        setTimeout(() => {
            // Llenar selector de empleados en filtro del calendario
            const selectEmpleado = document.getElementById('filtroEmpleadoCalendario');
            if (selectEmpleado && Array.isArray(empleados)) {
                empleados.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `👤 ${emp.nombre}`;
                    selectEmpleado.appendChild(option);
                });
            }

            // Llenar selector de empleados para informe individual
            const selectInforme = document.getElementById('selectEmpleado');
            if (selectInforme && Array.isArray(empleados)) {
                selectInforme.innerHTML = '<option value="">Selecciona un empleado</option>';
                empleados.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = emp.nombre;
                    selectInforme.appendChild(option);
                });

                // Agregar evento de cambio
                selectInforme.addEventListener('change', (e) => {
                    const empleadoId = parseInt(e.target.value);
                    if (empleadoId) {
                        const empleado = empleados.find(emp => emp.id === empleadoId);
                        if (empleado) {
                            AppState.selectedEmployee = empleado;
                            
                            // Mostrar vista previa
                            const vistaPrevia = document.getElementById('vistaPrevia');
                            const turnos = AppState.scheduleData.get(empleado.id) || [];
                            const diasTrabajados = turnos.filter(t => t.turno && t.turno !== 'descanso' && t.turno !== 'vacaciones' && t.turno !== 'baja').length;
                            
                            document.getElementById('nombreEmpleado').textContent = empleado.nombre;
                            document.getElementById('deptoEmpleado').textContent = empleado.departamento;
                            document.getElementById('horasEmpleado').textContent = empleado.horasContrato + 'h';
                            document.getElementById('turnoEmpleado').textContent = empleado.turnoPrincipal;
                            document.getElementById('diasEmpleado').textContent = diasTrabajados;
                            
                            vistaPrevia.style.display = 'block';
                            
                            // Actualizar cuadrante individual
                            mostrarCuadranteEmpleado(empleado.id);
                            actualizarEstadisticasIndividual();
                        }
                    } else {
                        AppState.selectedEmployee = null;
                        document.getElementById('vistaPrevia').style.display = 'none';
                        document.getElementById('cuadranteIndividual').innerHTML = '';
                    }
                });
            }
        }, 100);
    </script>

    <!-- Script de inicialización final - MÓDULOS PRINCIPALES -->
    <script>
        // ✅ CÓDIGO DE TURNOМАНAGER Y EDICION MASIVA
        // Variables para control de navegación del informe individual
        let mesIndividual = new Date().getMonth();
        let anioIndividual = new Date().getFullYear();

        // Cambiar mes en la pestaña de informe individual
        // Llenar opciones de localidades
        function llenarCentrosDeTrabajo() {
            const selectCentro = document.getElementById('selectCentroTrabajo');
            if (!selectCentro) return;
            
            // Limpiar opciones anteriores excepto la primera
            while (selectCentro.options.length > 1) {
                selectCentro.remove(1);
            }
            
            // Usar localidades del LocationManager si está disponible
            const localidades = (typeof LocationManager !== 'undefined' && LocationManager.localidades) 
                ? LocationManager.localidades.map(l => l.nombre).sort()
                : [...new Set(empleados.map(e => e.localidad || 'Sin especificar'))].sort();
            
            localidades.forEach(localidad => {
                const option = document.createElement('option');
                option.value = localidad;
                option.textContent = localidad;
                selectCentro.appendChild(option);
            });
        }

        function llenarDepartamentosInforme() {
            const selectDepartamento = document.getElementById('selectDepartamentoIndividual');
            if (!selectDepartamento) return;
            
            // Limpiar opciones anteriores excepto la primera
            while (selectDepartamento.options.length > 1) {
                selectDepartamento.remove(1);
            }
            
            // Obtener departamentos únicos de los empleados
            const departamentos = [...new Set(empleados.map(e => e.departamento).filter(d => d))].sort();
            
            departamentos.forEach(departamento => {
                const option = document.createElement('option');
                option.value = departamento;
                option.textContent = departamento;
                selectDepartamento.appendChild(option);
            });
        }

        // Función para mostrar el cuadrante de un empleado seleccionado
        function mostrarCuadranteEmpleado(empleadoId) {
            const cuadranteIndividual = document.getElementById('cuadranteIndividual');
            if (!cuadranteIndividual) return;

            // 🔧 GARANTIZAR QUE USAMOS LOS EMPLEADOS ACTUALES (desde localStorage)
            const empleadosActuales = JSON.parse(localStorage.getItem('empleadosData') || '[]');
            const empleado = empleadosActuales.find(e => e.id === empleadoId) || empleados.find(e => e.id === empleadoId);
            if (!empleado) return;

            const turnos = AppState.scheduleData.get(empleadoId) || [];
            const mes = AppState.currentMonth;
            const anio = AppState.currentYear;

            // Obtener el número de días en el mes
            const diasEnMes = new Date(anio, mes + 1, 0).getDate();
            const primerDia = new Date(anio, mes, 1).getDay();

            // Obtener los tipos de turno disponibles
            const tiposTurnoList = JSON.parse(localStorage.getItem('tiposTurnoData')) || {};
            // 🔧 CORRECCIÓN: Crear array con claves incluidas
            const tiposTurnoArray = Object.entries(tiposTurnoList).map(([key, value]) => ({
                key,
                ...value
            }));

            // 🔧 BUG FIX: Filtrar turnos del mes/año actual solamente
            const turnosDelMes = turnos.filter(t => {
                if (!t.fecha) return t.dia >= 1 && t.dia <= diasEnMes; // Fallback
                const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                return fecha.getMonth() === mes && fecha.getFullYear() === anio;
            });

            // Calcular estadísticas
            const mañanas = turnosDelMes.filter(t => t.turno === 'mañana').length;
            const tardes = turnosDelMes.filter(t => t.turno === 'tarde').length;
            const noches = turnosDelMes.filter(t => t.turno === 'noche').length;
            const vacaciones = turnosDelMes.filter(t => t.turno === 'vacaciones').length;
            const baja = turnosDelMes.filter(t => t.turno === 'baja').length;
            const descansos = turnosDelMes.filter(t => t.turno === 'descanso' || t.turno === 'libre').length;
            const diasTrabajados = turnosDelMes.filter(t => t.turno && !['descanso', 'libre', 'baja', 'vacaciones'].includes(t.turno)).length;
            
            // 🔧 BUG FIX: Contar guardias correctamente
            // Guardia = Domingo trabajado O festivo trabajado O turno específicamente marcado como guardia
            const guardias = turnosDelMes.filter(t => {
                if (!t.fecha) return false;
                const diaSemana = t.fecha.getDay ? t.fecha.getDay() : new Date(t.fecha).getDay();
                const esDomingo = diaSemana === 0;
                // 🔧 MEJORADO: Usar festivos locales del empleado en lugar de globales
                const esFestivoTrabajado = typeof window.esFestivoLocal === 'function' 
                    ? window.esFestivoLocal(t.fecha, empleadoId) 
                    : (typeof window.esFestivo === 'function' ? window.esFestivo(t.fecha) : false);
                const esGuardiaEspecífica = t.turno && (t.turno.includes('guardia') || t.turno.includes('domingo'));
                
                // Contar como guardia si:
                // 1. Es domingo Y tiene un turno trabajado (no descansa)
                // 2. Es festivo (local) Y tiene un turno trabajado
                // 3. El turno está específicamente marcado como guardia
                const turnoTrabajado = t.turno && !['descanso', 'libre', 'baja', 'vacaciones', 'festivo'].includes(t.turno);
                return (esDomingo && turnoTrabajado) || (esFestivoTrabajado && turnoTrabajado) || esGuardiaEspecífica;
            }).length;

            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            // Calcular total de horas directamente desde los turnos guardados
            const totalHoras = Math.round(turnosDelMes.reduce((sum, t) => sum + (t.horas || 0), 0) * 100) / 100;

            // Crear HTML del modal
            let html = `
                <div style="background: #0f172a; border-radius: 16px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.7); padding: 0;">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%); padding: 20px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10;">
                        <h2 style="margin: 0; color: white; font-size: 28px; font-weight: 700;">📅 Cuadrante del Empleado</h2>
                        <button class="btn-whatsapp-modal" onclick="exportarEmpleado(${empleadoId}, '${meses[mes] || 'Mes'}', ${anio}, 'whatsapp')" title="Enviar informe por WhatsApp" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(34, 197, 94, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(34, 197, 94, 0.3)'">
                            📱 WhatsApp
                        </button>
                        <button onclick="document.getElementById('cuadranteIndividual').style.display = 'none'; document.getElementById('cuadranteIndividual').innerHTML = '';" style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 16px;">✖ Cerrar</button>
                    </div>

                    <!-- Contenido -->
                    <div style="padding: 18px;">
                        <!-- Información del Empleado -->
                        <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #475569;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px;">
                                <div style="padding: 15px; background: linear-gradient(135deg, #a78bfa 0%, rgba(139, 92, 246, 0.2) 100%); border-radius: 8px; border-left: 4px solid #a78bfa;">
                                    <div style="color: #0f172a; font-size: 14px; font-weight: 600;">👤 EMPLEADO</div>
                                    <div style="color: #f1f5f9; font-size: 18px; font-weight: 700; margin-top: 6px;">${empleado.nombre}</div>
                                </div>
                                <div style="padding: 15px; background: linear-gradient(135deg, #60a5fa 0%, rgba(59, 130, 246, 0.2) 100%); border-radius: 8px; border-left: 4px solid #60a5fa;">
                                    <div style="color: #0f172a; font-size: 14px; font-weight: 600;">🏢 DEPARTAMENTO</div>
                                    <div style="color: #f1f5f9; font-size: 18px; font-weight: 700; margin-top: 6px;">${empleado.departamento || 'N/A'}</div>
                                </div>
                                <div style="padding: 15px; background: linear-gradient(135deg, #34d399 0%, rgba(16, 185, 129, 0.2) 100%); border-radius: 8px; border-left: 4px solid #34d399;">
                                    <div style="color: #0f172a; font-size: 14px; font-weight: 600;">⏱️ HORAS CONTRATO</div>
                                    <div style="color: #f1f5f9; font-size: 18px; font-weight: 700; margin-top: 6px;">${empleado.horasContrato}h</div>
                                </div>
                                <div style="padding: 15px; background: linear-gradient(135deg, #fbbf24 0%, rgba(245, 158, 11, 0.2) 100%); border-radius: 8px; border-left: 4px solid #fbbf24;">
                                    <div style="color: #0f172a; font-size: 14px; font-weight: 600;">🎯 TURNO PRINCIPAL</div>
                                    <div style="color: #f1f5f9; font-size: 18px; font-weight: 700; margin-top: 6px;">${empleado.turnoPrincipal || 'N/A'}</div>
                                </div>
                                <div style="padding: 15px; background: linear-gradient(135deg, #d8b4fe 0%, rgba(168, 85, 247, 0.2) 100%); border-radius: 8px; border-left: 4px solid #d8b4fe;">
                                    <div style="color: #0f172a; font-size: 14px; font-weight: 600;">📊 DÍAS TRABAJADOS</div>
                                    <div style="color: #f1f5f9; font-size: 18px; font-weight: 700; margin-top: 6px;">${diasTrabajados}</div>
                                </div>
                                <div style="padding: 15px; background: linear-gradient(135deg, #fca5a5 0%, rgba(239, 68, 68, 0.2) 100%); border-radius: 8px; border-left: 4px solid #fca5a5;">
                                    <div style="color: #0f172a; font-size: 14px; font-weight: 600;">🚨 GUARDIAS</div>
                                    <div style="color: #fca5a5; font-size: 18px; font-weight: 700; margin-top: 6px;">${guardias}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Calendario -->
                        <div style="margin-bottom: 12px;">
                            <h3 style="color: #f1f5f9; margin: 0 0 10px 0; font-size: 20px; font-weight: 700;">📆 ${meses[mes]} ${anio}</h3>
                            <div style="background: #1e293b; border-radius: 12px; padding: 10px; border: 1px solid #475569;">
                                <!-- Días de la semana -->
                                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px;">
                                    ${['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'].map(dia => 
                                        `<div style="text-align: center; color: #94a3b8; font-weight: 700; font-size: 13px; padding: 8px;">${dia}</div>`
                                    ).join('')}
                                </div>
                                <!-- Días del mes -->
                                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px;">
                                    ${Array(primerDia).fill(0).map(() => 
                                        `<div style="min-height: 45px; background: #0f172a; border-radius: 6px;"></div>`
                                    ).join('')}
                                    ${Array.from({length: diasEnMes}, (_, i) => {
                                        const dia = i + 1;
                                        const turno = turnosDelMes.find(t => t.dia === dia);
                                        // 🔧 CORRECCIÓN: Buscar tipoTurno por clave, no por nombre
                                        const tipoTurno = tiposTurnoArray.find(tt => tt.key === turno?.turno) ||
                                                         tiposTurnoArray.find(tt => lowerCaseSafe(tt.nombre) === lowerCaseSafe(turno?.turno));
                                        const color = tipoTurno?.color || '#e2e3e5';
                                        const inicial = tipoTurno?.inicial || turno?.turno || '-';
                                        
                                        // 🔧 MEJORADO: Detectar domingos y festivos locales del empleado
                                        const fecha = new Date(anio, mes, dia);
                                        const diaSemana = fecha.getDay();
                                        const esDomingo = diaSemana === 0;
                                        // 🔧 NUEVO: Usar festivos locales del empleado en lugar de globales
                                        const esFestivo = typeof window.esFestivoLocal === 'function' 
                                            ? window.esFestivoLocal(fecha, empleadoId)
                                            : (typeof window.esFestivo === 'function' ? window.esFestivo(fecha) : false);
                                        const esGuardiaPotencial = esDomingo || esFestivo;
                                        
                                        // 🔧 MEJORADO: Efecto 3D intenso con gradiente para cuadrante individual (hinchadas)
                                        const backgroundGradient = `linear-gradient(135deg, ${color}44 0%, ${color}ff 100%)`;  // Gradiente intenso (27% a 100%)
                                        const sombraGuardia = esGuardiaPotencial ? '0 0 12px rgba(255, 107, 107, 0.6), inset 0 0 8px rgba(255, 107, 107, 0.2)' : 'inset 0 4px 12px rgba(0, 0, 0, 0.18)';  // Sombra más profunda
                                        
                                        // Estilo especial para domingos/festivos
                                        const bordeGuardia = esGuardiaPotencial ? '3px solid #ff6b6b' : '2px solid transparent';
                                        const bgOpacity = esGuardiaPotencial ? '1' : '1';
                                        
                                        return `
                                            <div style="min-height: 45px; background: ${backgroundGradient}; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; border: ${bordeGuardia}; position: relative; box-shadow: ${sombraGuardia}; opacity: ${bgOpacity};" 
                                                 onmouseover="this.style.transform='scale(1.08)'; this.style.boxShadow='0 0 20px rgba(255,255,255,0.4), 0 4px 16px rgba(0,0,0,0.5)'; this.style.borderColor='#fff';" 
                                                 onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='${sombraGuardia}'; this.style.borderColor='${esGuardiaPotencial ? '#ff6b6b' : 'transparent'}';"
                                                 onclick="TurnoEditor.abrirEditorTurno(${empleadoId}, ${dia}, ${mes}, ${anio})"
                                                 title="Clic para editar - ${turno?.turno || 'Sin turno'} - ${turno?.horas || 0}h${esGuardiaPotencial ? ' 🚨 GUARDIA POTENCIAL' : ''}">
                                                <div style="text-align: center; z-index: 1;">
                                                    <div style="font-size: 13px; color: #fb923c; font-weight: 700;">${dia}</div>
                                                    <div style="font-size: 28px; color: #0f172a; font-weight: 900; margin-top: 1px;">${inicial}</div>
                                                    ${esGuardiaPotencial ? '<div style="font-size: 10px; color: #ff6b6b; font-weight: 700; margin-top: 2px;">🚨</div>' : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>

                        
                        <!-- 🔧 RESUMEN INTELIGENTE - Atributos data para JS externo -->
                        <div id="resumenInteligente_${empleadoId}" data-emp-id="${empleadoId}" data-mes="${mes}" data-anio="${anio}" style="background: linear-gradient(135deg, #34d399 0%, rgba(16, 185, 129, 0.2) 100%); padding: 20px; border-radius: 12px; border: 1px solid #475569; margin-bottom: 20px;">
                            <!-- Se llenará automáticamente por JS externo -->
                            <h3 style="color: #f1f5f9; margin: 0 0 15px 0; font-size: 16px; font-weight: 700;">📊 Resumen de Turnos</h3>
                            <div class="placeholder-summary">Cargando resumen...</div>
                        </div>

                    </div>
                </div>
            `;

            cuadranteIndividual.innerHTML = html;
            cuadranteIndividual.style.display = 'flex';
            
            // 🔧 GUARDAR HTML DEL CUADRANTE PARA LA EXPORTACIÓN
            window.htmlCuadranteActual = html;
            
            // 🔥 REGISTRAR OBSERVADOR PARA SINCRONIZACIÓN AUTOMÁTICA (solo una vez)
            if (typeof DataChangeManager !== 'undefined' && !window._cuadranteIndividualObserverRegistrado) {
                const observador = (cambio) => {
                    // Evitar bucles: no actualizar si estamos en medio de una actualización
                    if (window._cuadranteIndividualActualizando) {
                        console.log('[mostrarCuadranteEmpleado] ⏸️ Saltando actualización (ya en proceso)');
                        return;
                    }

                    // Solo actualizar si el cambio afecta a este empleado O es un cambio de mes
                    if (cambio.type === 'SHIFT_CHANGED' && cambio.data.empleadoId === empleadoId) {
                        console.log('[mostrarCuadranteEmpleado] 🔄 Detectado cambio de turno, actualizando vista...');
                        window._cuadranteIndividualActualizando = true;
                        mostrarCuadranteEmpleado(empleadoId);  // Volver a renderizar
                        window._cuadranteIndividualActualizando = false;
                    } else if (cambio.type === 'BULK_CHANGES') {
                        const afectaAEsteEmpleado = cambio.data.cambios?.some(c => c.empleadoId === empleadoId);
                        if (afectaAEsteEmpleado) {
                            console.log('[mostrarCuadranteEmpleado] 🔄 Detectados cambios en lote, actualizando vista...');
                            window._cuadranteIndividualActualizando = true;
                            mostrarCuadranteEmpleado(empleadoId);
                            window._cuadranteIndividualActualizando = false;
                        }
                    } else if (cambio.type === 'MONTH_CHANGED') {
                        // Actualizar cuando se cambia de mes
                        window._cuadranteIndividualActualizando = true;
                        mostrarCuadranteEmpleado(empleadoId);
                        window._cuadranteIndividualActualizando = false;
                    }
                };

                // Suscribirse al sistema de cambios
                DataChangeManager.subscribe(observador);
                console.log('[mostrarCuadranteEmpleado] ✅ Observador registrado para empleado:', empleadoId);

                // Marcar que ya se registró para este empleado
                window._cuadranteIndividualObserverRegistrado = true;
                window._cuadranteIndividualObserver = observador;
            }
        }

        // Cerrar modal al hacer clic fuera de la tabla
        document.addEventListener('DOMContentLoaded', function() {
            const cuadranteIndividual = document.getElementById('cuadranteIndividual');
            if (cuadranteIndividual) {
                cuadranteIndividual.addEventListener('click', function(e) {
                    if (e.target === this) {
                        cuadranteIndividual.style.display = 'none';
                        cuadranteIndividual.innerHTML = '';
                    }
                });
                // Cerrar con tecla ESC
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && cuadranteIndividual.style.display === 'flex') {
                        cuadranteIndividual.style.display = 'none';
                        cuadranteIndividual.innerHTML = '';
                    }
                });
            }
        });

        // Función para actualizar las estadísticas del empleado
        function actualizarEstadisticasIndividual() {
            const empleadoId = AppState.selectedEmployee?.id;
            if (!empleadoId) return;

            const turnos = AppState.scheduleData.get(empleadoId) || [];
            const tiposTurnoList = JSON.parse(localStorage.getItem('tiposTurnoData')) || {};
            // 🔧 CORRECCIÓN: Crear array con claves incluidas
            const tiposTurnoArray = Object.entries(tiposTurnoList).map(([key, value]) => ({
                key,
                ...value
            }));

            // 🔧 BUG FIX: Filtrar turnos del mes/año actual
            const mes = AppState.currentMonth;
            const anio = AppState.currentYear;
            const turnosDelMes = turnos.filter(t => {
                if (!t.fecha) return false;
                const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                return fecha.getMonth() === mes && fecha.getFullYear() === anio;
            });

            // Calcular estadísticas
            let totalHoras = 0;
            let turnosMañana = 0;
            let turnosTarde = 0;
            let turnosNoche = 0;
            let diasVacaciones = 0;
            let diasBaja = 0;
            let diasDescanso = 0;

            turnosDelMes.forEach(t => {
                totalHoras += t.horas || 0;
                
                // Comparar por nombre completo del turno, no por inicial
                if (t.turno === 'mañana') turnosMañana++;
                else if (t.turno === 'tarde') turnosTarde++;
                else if (t.turno === 'noche') turnosNoche++;
                else if (t.turno === 'vacaciones') diasVacaciones++;
                else if (t.turno === 'baja') diasBaja++;
                else if (t.turno === 'descanso') diasDescanso++;
            });

            // Crear HTML de estadísticas
            const estadisticasDiv = document.getElementById('estadisticasIndividual');
            if (estadisticasDiv) {
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">';
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Total Horas</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${totalHoras}h</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Mañanas</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${turnosMañana}</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Tardes</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${turnosTarde}</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Noches</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${turnosNoche}</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Vacaciones</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${diasVacaciones}</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Baja</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${diasBaja}</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Descansos</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${diasDescanso}</div></div>`;
                html += '</div>';
                estadisticasDiv.innerHTML = html;
            }
        }

        // Aplicar filtros y mostrar resultados
        function aplicarFiltrosInforme() {
            const localidad = document.getElementById('selectCentroTrabajo').value;
            const departamento = document.getElementById('selectDepartamentoIndividual').value;
            const mes = parseInt(document.getElementById('selectMesIndividual').value);
            const anio = parseInt(document.getElementById('selectAnioIndividual').value);
            
            // Filtrar empleados por localidad y departamento
            let empleadosFiltrados = empleados;
            if (localidad) {
                empleadosFiltrados = empleadosFiltrados.filter(e => (e.localidad || 'Sin especificar') === localidad);
            }
            if (departamento) {
                empleadosFiltrados = empleadosFiltrados.filter(e => e.departamento === departamento);
            }
            
            if (empleadosFiltrados.length === 0) {
                let msg = 'No hay empleados con los filtros seleccionados.';
                document.getElementById('tablaResultados').innerHTML = `<p style="text-align: center; color: #cbd5e1;">${msg}</p>`;
                return;
            }
            
            // Construir tabla
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            let titulo = '';
            if (localidad && departamento) {
                titulo = `📍 ${localidad} - 🏢 ${departamento}`;
            } else if (localidad) {
                titulo = `📍 ${localidad}`;
            } else if (departamento) {
                titulo = `🏢 ${departamento}`;
            } else {
                titulo = '📋 Todos los empleados';
            }
            
            let html = `
                <h3 style="color: #a855f7; margin-bottom: 20px; font-size: 26px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                    ${titulo} - ${meses[mes]} ${anio}
                </h3>
                <div style="overflow-x: auto; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.3);">
                    <table class="cuadrante-empleado-table">
                        <thead>
                            <tr>
                                <th>Empleado</th>
                                <th>Horas</th>
                                <th>Turnos Noche</th>
                                <th>Vacaciones</th>
                                <th>Balance</th>
                                <th>Cumplimiento</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Agregar filas para cada empleado
            empleadosFiltrados.forEach(empleado => {
                const turnos = AppState.scheduleData.get(empleado.id) || [];
                
                // Calcular total de horas directamente desde los turnos guardados
                const totalHoras = Math.round(turnos.reduce((sum, t) => sum + (t.horas || 0), 0) * 100) / 100;
                
                const turnosNoche = turnos.filter(t => t.turno === 'noche').length;
                const vacaciones = turnos.filter(t => t.turno === 'vacaciones' || t.turno === 'baja').length;
                const balance = totalHoras - empleado.horasContrato;
                const cumplimiento = Math.round((totalHoras / empleado.horasContrato) * 100);
                
                const balanceColor = balance >= 0 ? '#22c55e' : '#ef4444';
                const bgHover = empleadosFiltrados.indexOf(empleado) % 2 === 0 ? 'rgba(168, 85, 247, 0.05)' : 'rgba(236, 72, 153, 0.05)';
                
                html += `
                    <tr style="background: ${bgHover};">
                        <td style="font-weight: 700; color: #a855f7;">${empleado.nombre}</td>
                        <td>${totalHoras}h</td>
                        <td>${turnosNoche}</td>
                        <td>${vacaciones}</td>
                        <td style="background: ${balance >= 0 ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; color: ${balanceColor}; font-weight: 700;">${balance >= 0 ? '+' : ''}${balance}h</td>
                        <td style="font-weight: 700; color: ${cumplimiento >= 100 ? '#22c55e' : cumplimiento >= 80 ? '#f59e0b' : '#ef4444'};">${cumplimiento}%</td>
                        <td>
                            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                                <button onclick="exportarEmpleado(${empleado.id}, '${meses[mes]}', ${anio}, 'pdf')" title="PDF" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.3)'">📄</button>
                                <button onclick="exportarEmpleado(${empleado.id}, '${meses[mes]}', ${anio}, 'ical')" title="Calendario iCalendar" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(139, 92, 246, 0.3)'">🗓️</button>
                                <button onclick="exportarEmpleado(${empleado.id}, '${meses[mes]}', ${anio}, 'copy')" title="Copiar" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%); color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(100, 116, 139, 0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(100, 116, 139, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(100, 116, 139, 0.3)'">📋</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('tablaResultados').innerHTML = html;
        }

        // Obtener color del turno
        function getTurnoColor(turno) {
            const colores = {
                'mañana': '#d4edda',
                'tarde': '#fff3cd',
                'noche': '#f8d7da',
                'guardia': '#d8b4fe',
                'mixto': '#cce5ff',
                'asuntospropios': '#e0e7ff',
                'descanso': '#e2e3e5',
                'vacaciones': '#d0ebff',
                'baja': '#ffe3e3',
                'libre': '#f9f9f9',
                'festivo': '#fff9e6'
            };
            return colores[turno] || '#ffffff';
        }

        // Función para exportar datos de un empleado
        // =====================================================================================
        // 🔶 UTILIDADES DE EXPORTACIÓN VISUAL (PDF PARA WHATSAPP Y REPORTES INDIVIDUALES)
        // =====================================================================================
        const lowerCaseSafe = (valor) => (valor === undefined || valor === null) ? '' : String(valor).toLowerCase();

        function calcularHorasDelHorario(horario) {
            if (!horario || typeof horario !== 'string') return '';
            const match = horario.match(/(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/);
            if (!match) return '';
            const horaInicio = parseInt(match[1]);
            const minInicio = parseInt(match[2]);
            const horaFin = parseInt(match[3]);
            const minFin = parseInt(match[4]);
            
            let totalMinutos = (horaFin * 60 + minFin) - (horaInicio * 60 + minInicio);
            if (totalMinutos < 0) totalMinutos += 24 * 60; // Para turnos nocturnos que cruzan medianoche
            
            const horas = totalMinutos / 60;
            return horas % 1 === 0 ? `${Math.round(horas)}` : `${horas.toFixed(1)}`;
        }

        function obtenerInfoTurnoVisualPDF(nombre, tiposTurnoData) {
            const paletaFallback = {
                'mañana': '#86efac',
                'tarde': '#fcd34d',
                'noche': '#93c5fd',
                'mixto': '#fde68a',
                'descanso': '#cbd5f5',
                'vacaciones': '#fecdd3',
                'baja': '#fda4af',
                'libre': '#e0e7ff',
                'festivo': '#fef3c7'
            };
            if (!nombre) {
                return { etiqueta: 'Sin turno', inicial: '-', color: 'rgba(148,163,184,0.25)', horario: '', horas: '' };
            }
            const lower = lowerCaseSafe(nombre);
            
            // 🔧 MEJORADO: Buscar primero por clave directa, luego por nombre/id
            // Esto es importante para turnos personalizados como "tarde6" o "asuntospropios"
            let coincidencia = tiposTurnoData?.[nombre] || tiposTurnoData?.[lower];
            
            if (!coincidencia) {
                // Si no encuentra por clave, busca por nombre o id en los valores
                const lista = Object.values(tiposTurnoData || {});
                coincidencia = lista.find(t => lowerCaseSafe(t?.nombre) === lower || lowerCaseSafe(t?.id) === lower);
            }
            
            // Prioridad: obtener horas del tipo de turno
            let horas = coincidencia?.horas || '';
            if (!horas && coincidencia?.horario) {
                horas = calcularHorasDelHorario(coincidencia.horario);
            }
            
            // 🔧 CORRECCIÓN: Mostrar horario correctamente (no mezclar con horas)
            const horario = coincidencia?.horario || '';
            
            // 🔧 MEJORADO: Devolver el inicial completo (puede tener 1, 2 o más letras)
            // No truncar - el campo inicial ya contiene exactamente lo que se debe mostrar
            return {
                etiqueta: coincidencia?.nombre || nombre,
                inicial: coincidencia?.inicial || nombre.substring(0, 1).toUpperCase(),
                color: coincidencia?.color || paletaFallback[lower] || 'rgba(148,163,184,0.25)',
                horario: horario,
                horas: horas
            };
        }

        function calcularResumenTurnosPDF(turnos, empleadoId) {
            const limpio = Array.isArray(turnos) ? turnos : [];
            const trabajados = limpio.filter(t => t?.turno && !['descanso','libre','baja','vacaciones','festivo'].includes(t.turno)).length;
            const descansos = limpio.filter(t => t?.turno && ['descanso','libre'].includes(t.turno)).length;
            const vacaciones = limpio.filter(t => t?.turno === 'vacaciones').length;
            const noches = limpio.filter(t => t?.turno === 'noche').length;
            const guardias = limpio.filter(t => {
                if (!t?.fecha) return false;
                const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                const esDomingo = fecha.getDay() === 0;
                const esFestivoTrabajado = typeof window.esFestivoLocal === 'function'
                    ? window.esFestivoLocal(fecha, empleadoId)
                    : (typeof window.esFestivo === 'function' ? window.esFestivo(fecha) : false);
                const esGuardiaMarcada = lowerCaseSafe(t?.turno).includes('guardia');
                const turnoTrabajado = t.turno && !['descanso','libre','baja','vacaciones','festivo'].includes(t.turno);
                return (esDomingo && turnoTrabajado) || (esFestivoTrabajado && turnoTrabajado) || esGuardiaMarcada;
            }).length;
            return { trabajados, descansos, vacaciones, noches, guardias };
        }

        function construirCalendarioVisualPDF({ turnos, mesNum, anio, empleadoId, tiposTurnoData }) {
            const diasSemana = ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'];
            const diasEnMes = new Date(anio, mesNum + 1, 0).getDate();
            const primerDia = new Date(anio, mesNum, 1).getDay();
            const offset = (primerDia + 6) % 7; // Empezar en lunes
            const totalCeldas = Math.ceil((offset + diasEnMes) / 7) * 7;
            const mapaTurnos = new Map();
            (turnos || []).forEach(t => {
                if (!t) return;
                const fecha = t.fecha instanceof Date ? t.fecha : (t.fecha ? new Date(t.fecha) : new Date(anio, mesNum, t.dia || 1));
                const dia = t.dia || fecha.getDate();
                mapaTurnos.set(dia, { ...t, fecha });
            });

            const celdas = [];
            for (let i = 0; i < totalCeldas; i++) {
                const dia = i - offset + 1;
                if (dia < 1 || dia > diasEnMes) {
                    celdas.push('<div style="min-height:140px; border-radius:18px; background:rgba(15,23,42,0.35);"></div>');
                    continue;
                }
                const turnoDia = mapaTurnos.get(dia);
                const fechaRepr = new Date(anio, mesNum, dia);
                const esDomingo = fechaRepr.getDay() === 0;
                const esFestivo = typeof window.esFestivoLocal === 'function'
                    ? window.esFestivoLocal(fechaRepr, empleadoId)
                    : (typeof window.esFestivo === 'function' ? window.esFestivo(fechaRepr) : false);
                const turnoNormalizado = lowerCaseSafe(turnoDia?.turno);
                const esGuardia = esDomingo || esFestivo || turnoNormalizado.includes('guardia');
                const infoTurno = obtenerInfoTurnoVisualPDF(turnoDia?.turno, tiposTurnoData);
                
                // 🔧 MEJORADO: Priorizar datos del turno individual si están disponibles
                const horario = turnoDia?.horario || infoTurno.horario || '';
                const horasDelTurno = turnoDia?.horas || infoTurno.horas || '';
                const horas = horasDelTurno ? `${horasDelTurno}h` : '';
                
                const badgeTextColor = turnoDia ? '#0f172a' : '#cbd5f5';
                const guardiaBadge = esGuardia ? '<span style="padding:4px 10px; border-radius:999px; background:rgba(248,113,113,0.2); color:#fecaca; font-size:11px; font-weight:600; text-transform:uppercase;">Guardia</span>' : '';
                const contexto = esFestivo ? 'Festivo' : (esDomingo ? 'Domingo' : '');
                const contextoHtml = contexto ? `<span style="font-size:11px; color:#94a3b8;">${contexto}</span>` : '';
                
                // 🔧 MEJORADO: Efecto 3D con capas de color
                // Crear un color más claro (version clara del turno) para el fondo base
                const bgColor = infoTurno.color || 'rgba(15,23,42,0.35)';
                // Agregar gradiente suave del color original superpuesto para efecto 3D
                const backgroundGradient = `linear-gradient(135deg, ${bgColor}88 0%, ${bgColor}cc 100%)`;
                const borderColor = esGuardia ? '3px solid #ff6b6b' : '2px solid transparent';
                const boxShadow = esGuardia ? '0 0 12px rgba(255, 107, 107, 0.6), inset 0 0 8px rgba(255, 107, 107, 0.2)' : 'inset 0 2px 8px rgba(0, 0, 0, 0.1)';
                
                celdas.push(`
                    <div style="min-height:140px; border-radius:20px; background:${backgroundGradient}; padding:14px; border:${borderColor}; box-shadow:${boxShadow}; display:flex; flex-direction:column; justify-content:space-between; align-items:center; text-align:center; gap:8px; transition:all 0.3s ease;">
                        <div style="width:100%;">
                            <span style="font-size:28px; font-weight:700; color:#0f172a;">${dia}</span>
                        </div>
                        <div style="width:100%;">
                            <div style="display:inline-block; padding:6px 12px; border-radius:999px; background:transparent; color:#0f172a; font-weight:700; font-size:28px; line-height:1.4;">${infoTurno.inicial}</div>
                        </div>
                        ${horas ? `<div style="font-size:13px; font-weight:600; color:#0f172a; letter-spacing:0.5px;">${horas}</div>` : ''}
                        ${horario ? `<div style="font-size:11px; color:#0f172a;">${horario}</div>` : ''}
                        ${guardiaBadge}
                        ${contextoHtml}
                    </div>
                `);
            }

            return `
                <div style="margin-top:10px;">
                    <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:12px; margin-bottom:12px;">
                        ${diasSemana.map(d => `<div style="text-align:center; font-size:12px; letter-spacing:0.1em; text-transform:uppercase; color:#94a3b8;">${d}</div>`).join('')}
                    </div>
                    <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:12px;">
                        ${celdas.join('')}
                    </div>
                </div>
            `;
        }

        function crearTarjetaInfoPDF(titulo, valor, detalle, background, icono = '📊') {
            return `
                <div style="border-radius:24px; padding:24px; background:${background}; display:flex; flex-direction:column; gap:10px; box-shadow:0 8px 32px rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); backdrop-filter:blur(10px); transition:all 0.3s ease;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:20px;">${icono}</span>
                        <span style="font-size:11px; text-transform:uppercase; letter-spacing:0.15em; color:rgba(255,255,255,0.7); font-weight:600;">${titulo}</span>
                    </div>
                    <span style="font-size:32px; font-weight:800; color:#fff; line-height:1.2;">${valor}</span>
                    ${detalle ? `<span style="font-size:12px; color:rgba(255,255,255,0.8); line-height:1.4;">${detalle}</span>` : ''}
                </div>
            `;
        }

        // COMENTADA: Función PDF original - AHORA USAMOS IMAGEN EN SU LUGAR
        /*
        async function generarPDFCuadranteVisual(informe) {
            try {
                console.log('🔵 [generarPDFCuadranteVisual] Iniciando con informe:', informe);
                const { empleado, turnos, mes, anio, mesNum, totalHoras } = informe || {};
                if (!empleado) throw new Error('No hay empleado para generar el PDF');
                console.log('✅ [generarPDFCuadranteVisual] Empleado:', empleado.nombre);
            const tiposTurnoData = JSON.parse(localStorage.getItem('tiposTurnoData') || '{}');
            const resumen = calcularResumenTurnosPDF(turnos || [], empleado.id);
            const horasContrato = parseFloat(empleado.horasContrato) || 0;
            const balance = (totalHoras || 0) - horasContrato;
            const cumplimiento = horasContrato > 0 ? Math.round(((totalHoras || 0) / horasContrato) * 100) : 0;

            const wrapper = document.createElement('div');
            wrapper.style.position = 'fixed';
            wrapper.style.left = '-9999px';
            wrapper.style.top = '0';
            wrapper.style.zIndex = '-1';

            const content = document.createElement('div');
            content.style.width = '1400px';
            content.style.padding = '48px';
            content.style.background = 'linear-gradient(135deg, #0b1220, #111827)';
            content.style.borderRadius = '32px';
            content.style.boxShadow = '0 40px 80px rgba(0,0,0,0.55)';
            content.style.fontFamily = "'Poppins','Segoe UI',sans-serif";
            content.style.color = '#f8fafc';

            const tarjetas = [
                crearTarjetaInfoPDF('Empleado', empleado.nombre, empleado.departamento || 'Sin depto', 'linear-gradient(135deg,#6366f1,#8b5cf6)', '👤'),
                crearTarjetaInfoPDF('Localidad', empleado.localidad || 'N/D', empleado.turnoPrincipal || 'Sin turno', 'linear-gradient(135deg,#0ea5e9,#38bdf8)', '📍'),
                crearTarjetaInfoPDF('Horas trabajadas', `${(totalHoras || 0).toFixed(2)}h`, `Contrato: ${horasContrato}h`, 'linear-gradient(135deg,#22c55e,#4ade80)', '⏱️'),
                crearTarjetaInfoPDF('Balance', `${balance >= 0 ? '+' : ''}${balance.toFixed(2)}h`, `Cumplimiento ${cumplimiento}%`, 'linear-gradient(135deg,#f97316,#fb923c)', '📈')
            ].join('');

            const calendarioHTML = construirCalendarioVisualPDF({
                turnos: turnos || [],
                mesNum,
                anio,
                empleadoId: empleado.id,
                tiposTurnoData
            });

            content.innerHTML = `
                <div style="border-bottom:2px solid rgba(148,163,184,0.2); padding-bottom:24px; margin-bottom:32px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:24px;">
                        <div>
                            <p style="margin:0; font-size:13px; letter-spacing:0.5em; color:#94a3b8; text-transform:uppercase; font-weight:600;">📋 Cuadrante Mensual</p>
                            <h1 style="margin:12px 0 0 0; font-size:48px; font-weight:900; background:linear-gradient(135deg,#fff,#cbd5f5); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;">${mes} ${anio}</h1>
                            <p style="margin:12px 0 0 0; color:#cbd5f5; font-size:14px;">${empleado.nombre} · ${empleado.departamento || 'Sin departamento'}</p>
                        </div>
                        <div style="text-align:right; padding:16px; background:rgba(59,130,246,0.1); border-radius:16px; border:1px solid rgba(59,130,246,0.3);">
                            <div style="font-size:12px; color:#94a3b8; margin-bottom:6px;">📅 Generado</div>
                            <span style="font-size:12px; color:#cbd5f5;">${new Date().toLocaleDateString('es-ES')}</span>
                            <div style="font-size:36px; font-weight:800; margin-top:8px; color:#60a5fa;">${resumen.trabajados}</div>
                            <div style="font-size:11px; color:#cbd5f5; margin-top:4px;">días activos</div>
                        </div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:20px; margin-bottom:32px;">
                    ${tarjetas}
                </div>
                <div style="background:linear-gradient(135deg,rgba(15,23,42,0.95),rgba(15,23,42,0.8)); border-radius:32px; padding:32px; border:2px solid rgba(148,163,184,0.2); box-shadow:0 20px 60px rgba(0,0,0,0.4);">
                    <div style="margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(148,163,184,0.2);">
                        <h2 style="margin:0; font-size:18px; font-weight:700; color:#fff; letter-spacing:0.05em;">📅 Distribución de Turnos</h2>
                    </div>
                    ${calendarioHTML}
                </div>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:14px; margin-top:32px;">
                    <div style="padding:16px; border-radius:16px; background:linear-gradient(135deg,rgba(34,197,94,0.15),rgba(34,197,94,0.05)); border:1px solid rgba(34,197,94,0.4); box-shadow:0 4px 12px rgba(34,197,94,0.1);"><span style="font-size:11px; color:#86efac; text-transform:uppercase; font-weight:600;">✓ Descansos</span><div style="font-size:24px; font-weight:700; color:#4ade80; margin-top:6px;">${resumen.descansos}</div></div>
                    <div style="padding:16px; border-radius:16px; background:linear-gradient(135deg,rgba(248,113,113,0.15),rgba(248,113,113,0.05)); border:1px solid rgba(248,113,113,0.4); box-shadow:0 4px 12px rgba(248,113,113,0.1);"><span style="font-size:11px; color:#fca5a5; text-transform:uppercase; font-weight:600;">⚠️ Guardias</span><div style="font-size:24px; font-weight:700; color:#f87171; margin-top:6px;">${resumen.guardias}</div></div>
                    <div style="padding:16px; border-radius:16px; background:linear-gradient(135deg,rgba(59,130,246,0.15),rgba(59,130,246,0.05)); border:1px solid rgba(59,130,246,0.4); box-shadow:0 4px 12px rgba(59,130,246,0.1);"><span style="font-size:11px; color:#93c5fd; text-transform:uppercase; font-weight:600;">🌙 Noches</span><div style="font-size:24px; font-weight:700; color:#3b82f6; margin-top:6px;">${resumen.noches}</div></div>
                    <div style="padding:16px; border-radius:16px; background:linear-gradient(135deg,rgba(251,191,36,0.15),rgba(251,191,36,0.05)); border:1px solid rgba(251,191,36,0.4); box-shadow:0 4px 12px rgba(251,191,36,0.1);"><span style="font-size:11px; color:#fde047; text-transform:uppercase; font-weight:600;">📦 Vacaciones/Bajas</span><div style="font-size:24px; font-weight:700; color:#facc15; margin-top:6px;">${resumen.vacaciones}</div></div>
                </div>
                <div style="margin-top:32px; padding:16px; border-radius:16px; background:rgba(100,116,139,0.1); border:1px solid rgba(100,116,139,0.3); text-align:center;">
                    <p style="margin:0; font-size:11px; color:#94a3b8; letter-spacing:0.05em;">🔐 Documento generado automáticamente • Sistema de Gestión de Turnos</p>
                </div>
            `;

            wrapper.appendChild(content);
            document.body.appendChild(wrapper);

            // Clonar el contenido para remover el botón WhatsApp del PDF
            const contentForPDF = content.cloneNode(true);
            const btnWhatsAppEnPDF = contentForPDF.querySelector('.btn-whatsapp-modal');
            if (btnWhatsAppEnPDF) {
                btnWhatsAppEnPDF.remove();
            }

            // Crear un wrapper temporal solo para la captura del PDF
            const wrapperPDF = document.createElement('div');
            wrapperPDF.style.position = 'fixed';
            wrapperPDF.style.left = '-9999px';
            wrapperPDF.style.top = '0';
            wrapperPDF.style.zIndex = '-1';
            wrapperPDF.appendChild(contentForPDF);
            document.body.appendChild(wrapperPDF);

            const canvas = await html2canvas(contentForPDF, {
                backgroundColor: '#0b1220',
                scale: 2,
                useCORS: true,
                logging: false,
                windowHeight: contentForPDF.scrollHeight,
                windowWidth: contentForPDF.scrollWidth,
                allowTaint: true
            });
            console.log('✅ [generarPDFCuadranteVisual] Canvas generado');

            document.body.removeChild(wrapper);
            document.body.removeChild(wrapperPDF);

            const jsPDFConstructor = window.jspdf?.jsPDF || window.jsPDF;
            if (!jsPDFConstructor) {
                throw new Error('La libreria jsPDF no está disponible');
            }
            console.log('✅ [generarPDFCuadranteVisual] jsPDF disponible');
            const pdf = new jsPDFConstructor('landscape', 'pt', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            
            // Escalar para que todo quepa en una sola página
            const scale = Math.min(pageWidth / (canvas.width * 0.75), pageHeight / (canvas.height * 0.75));
            const imgWidth = (canvas.width * scale) * 0.75;
            const imgHeight = (canvas.height * scale) * 0.75;
            const startX = (pageWidth - imgWidth) / 2;
            const startY = (pageHeight - imgHeight) / 2;
            
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', startX, startY, imgWidth, imgHeight);

            const fileName = `Cuadrante_${empleado.nombre.replace(/\s+/g, '_')}_${mes}_${anio}.pdf`;
            const blob = pdf.output('blob');
            const file = new File([blob], fileName, { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            window.ultimoPdfCuadrante = { fileName, url, creado: Date.now() };
            console.log('✅ [generarPDFCuadranteVisual] PDF completado:', fileName);
            return { blob, file, url, fileName };
            } catch (error) {
                console.error('❌ [generarPDFCuadranteVisual] Error:', error);
                throw error;
            }
        }
        */

        // NUEVA FUNCIÓN: Capturar imagen del cuadrante individual visible
        async function generarImagenCuadranteVisual(informe) {
            try {
                console.log('🔵 [generarImagenCuadranteVisual] Capturando cuadrante individual visible');
                const { empleado } = informe || {};
                if (!empleado) throw new Error('No hay empleado');
                
                // Obtener el elemento visible del cuadrante individual
                const cuadranteIndividual = document.getElementById('cuadranteIndividual');
                if (!cuadranteIndividual || cuadranteIndividual.style.display === 'none') {
                    console.warn('⚠️ El cuadrante individual no está visible, generando PDF alternativo...');
                    // No lanzar error, retornar null para usar método alternativo
                    return null;
                }
                
                // Obtener el contenedor interno (el div con el contenido)
                const contentElement = cuadranteIndividual.querySelector('div[style*="background"]') || cuadranteIndividual.firstChild;
                if (!contentElement) {
                    console.warn('⚠️ No se encontró el contenido del cuadrante, usando método alternativo...');
                    return null;
                }
                
                console.log('✅ [generarImagenCuadranteVisual] Elemento encontrado, ocultando encabezado y botones...');
                
                // Clonar el elemento para no afectar la vista
                const elementoClonado = contentElement.cloneNode(true);
                
                // Ocultar SOLO el encabezado (título y botones superiores)
                const encabezado = elementoClonado.querySelector('div[style*="border-bottom"]');
                if (encabezado) {
                    encabezado.style.display = 'none';
                }
                
                // Crear un contenedor temporal en el DOM para captura
                const tempWrapper = document.createElement('div');
                tempWrapper.style.position = 'fixed';
                tempWrapper.style.left = '-9999px';
                tempWrapper.style.top = '0';
                tempWrapper.style.zIndex = '-1';
                tempWrapper.appendChild(elementoClonado);
                document.body.appendChild(tempWrapper);
                
                // Ajustar dimensiones para que quepa todo el contenido
                elementoClonado.style.width = '1200px';
                elementoClonado.style.maxHeight = 'none';
                elementoClonado.style.height = 'auto';
                
                // Forzar reflow para asegurar que se calcula el tamaño
                void elementoClonado.offsetHeight;
                
                console.log('✅ [generarImagenCuadranteVisual] Generando canvas con altura ajustada...');
                
                // Generar canvas del elemento sin encabezado pero CON pie de página
                const canvas = await html2canvas(elementoClonado, {
                    backgroundColor: '#0b1220',
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    windowHeight: elementoClonado.scrollHeight + 100,
                    windowWidth: 1200,
                    allowTaint: true
                });
                
                console.log('✅ [generarImagenCuadranteVisual] Canvas generado');
                
                // Remover el elemento temporal
                document.body.removeChild(tempWrapper);
                
                // Convertir canvas a blob de imagen
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png', 0.95));
                const fileName = `Cuadrante_${empleado.nombre.replace(/\s+/g, '_')}.png`;
                const file = new File([blob], fileName, { type: 'image/png' });
                const url = URL.createObjectURL(blob);
                const dataUrl = canvas.toDataURL('image/png');
                
                window.ultimoImagenCuadrante = { fileName, url, creado: Date.now(), dataUrl };
                console.log('✅ [generarImagenCuadranteVisual] Imagen completada:', fileName);
                return { blob, file, url, fileName, dataUrl };
            } catch (error) {
                console.error('❌ [generarImagenCuadranteVisual] Error:', error);
                throw error;
            }
        }

        function exportarEmpleado(empleadoId, mesNombre, anio, tipo) {
            try {
                // 🔧 GARANTIZAR QUE USAMOS LOS EMPLEADOS ACTUALES (desde localStorage)
                const empleadosActuales = JSON.parse(localStorage.getItem('empleadosData') || '[]');
                const empleado = empleadosActuales.find(e => e.id === empleadoId) || empleados.find(e => e.id === empleadoId);
                
                if (!empleado) {
                    console.error('❌ Empleado no encontrado:', empleadoId);
                    alert('Empleado no encontrado');
                    return;
                }
                
                // 🔧 DEBUG: Verificar que se cargó el empleado correcto
                console.log('✅ Empleado cargado:', {
                    id: empleado.id,
                    nombre: empleado.nombre,
                    horasContrato: empleado.horasContrato
                });
                
                const turnos = AppState.scheduleData.get(empleadoId) || [];
                
                // Convertir nombre del mes a número (robusto contra valores no string)
                const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                                      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const normalizarMes = (valor) => (valor ?? '').toString().trim();
                const mesNormalizado = normalizarMes(mesNombre);
                const mesNum = mesNormalizado ? mesesNombres.findIndex(m => lowerCaseSafe(m) === lowerCaseSafe(mesNormalizado)) : -1;
                const mesActualNum = mesNum >= 0 ? mesNum : AppState.currentMonth;
                const anioActual = parseInt(anio) || AppState.currentYear;
                
                // 🔧 BUG FIX: Filtrar turnos del mes/año actual
                const turnosDelMes = turnos.filter(t => {
                    if (!t.fecha) return false;
                    const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                    return fecha.getMonth() === mesActualNum && fecha.getFullYear() === anioActual;
                });
                
                // 🔧 BUG FIX: Calcular total de horas correctamente desde los turnos del mes
                const totalHoras = Math.round(turnosDelMes.reduce((sum, t) => sum + (t.horas || 0), 0) * 100) / 100;
                const mesActualNombre = mesesNombres[mesActualNum];
                
                // Guardar en variable global para las funciones de exportación
                window.informeActual = { 
                    empleado, 
                    turnos: turnosDelMes,  // 🔧 BUG FIX: Usar turnosDelMes
                    mes: mesActualNombre, 
                    anio: anioActual,
                    mesNum: mesActualNum,
                    totalHoras: totalHoras
                };
                
                console.log('exportarEmpleado - Mes actual:', { mes: mesActualNombre, mesNum: mesActualNum, anio: anioActual });
                
                if (tipo === 'pdf') {
                    descargarInformeIndividualPDF();
                } else if (tipo === 'whatsapp') {
                    console.log('🔵 Llamando a enviarWhatsAppIndividual()...');
                    enviarWhatsAppIndividual().catch(error => {
                        console.error('❌ Error en enviarWhatsAppIndividual:', error);
                        alert('Error: ' + error.message);
                    });
                } else if (tipo === 'copy') {
                    copiarAlPortapapelesInforme();
                } else if (tipo === 'ical') {
                    exportarAiCalendar(window.informeActual);
                }
            } catch (error) {
                console.error('Error exportando:', error);
                alert('Error: ' + error.message);
            }
        }

        // Descargar PDF del informe individual
        function descargarInformeIndividualPDF() {
            try {
                if (!window.informeActual) {
                    alert('No hay datos para exportar');
                    return;
                }

                const { empleado, turnos, mes, anio, totalHoras } = window.informeActual;
                
                // 🔧 DEBUG: Verificar qué empleado se está usando
                console.log('📄 PDF - Empleado:', {
                    nombre: empleado.nombre,
                    horasContrato: empleado.horasContrato,
                    tipo: typeof empleado.horasContrato
                });
                
                const turnosNoche = turnos.filter(dia => dia.turno === 'noche').length;
                const ausencias = turnos.filter(dia => dia.turno === 'vacaciones' || dia.turno === 'baja').length;
                
                // 🔧 Convertir horasContrato a número (por si está como string)
                const horasContratoNum = parseFloat(empleado.horasContrato) || 0;
                const totalHorasNum = parseFloat(totalHoras) || 0;
                
                // 🔧 DEBUG: Verificar valores después de conversión
                console.log('📄 PDF - Valores convertidos:', {
                    horasContratoNum,
                    totalHorasNum
                });
                
                // Crear HTML para el PDF
                const htmlContent = `
                    <h1 style="text-align: center; color: #2c3e50;">INFORME INDIVIDUAL MENSUAL</h1>
                    <h2 style="text-align: center; color: #7f8c8d;">${mes} ${anio}</h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h3 style="margin-top: 0; color: #2c3e50;">${empleado.nombre}</h3>
                        <p><strong>Departamento:</strong> ${empleado.departamento || 'N/A'}</p>
                        <p><strong>Turno Principal:</strong> ${empleado.turnoPrincipal || 'N/A'}</p>
                        <p><strong>Localidad:</strong> ${empleado.localidad || 'N/A'}</p>
                        <p><strong>Horas Contrato:</strong> ${horasContratoNum}h</p>
                        <p><strong>Estado:</strong> ${empleado.estado ? empleado.estado.toUpperCase() : 'N/A'}</p>
                    </div>
                    
                    <p><strong>Horas Trabajadas:</strong> ${totalHorasNum}h</p>
                    <p><strong>Balance:</strong> ${(totalHorasNum - horasContratoNum).toFixed(2)}h</p>
                    <p><strong>Cumplimiento:</strong> ${horasContratoNum > 0 ? Math.round((totalHorasNum / horasContratoNum) * 100) : 0}%</p>
                `;
                
                const ventana = window.open('', '_blank');
                ventana.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{font-family:Arial;}</style></head><body>${htmlContent}</body></html>`);
                ventana.document.close();
                ventana.print();
                
                if (typeof NotificationSystem !== 'undefined') {
                    NotificationSystem.show('Abriendo PDF para imprimir', 'info');
                }
            } catch (error) {
                console.error('Error PDF:', error);
                alert('Error: ' + error.message);
            }
        }

        // Descargar CSV del informe individual
        // 🗓️ EXPORTAR A ICALENDAR (.ics) PARA INTEGRACIÓN CON GOOGLE CALENDAR, OUTLOOK, ETC
        function generarContenidoiCalendar(informe) {
            try {
                if (!informe) return '';
                
                const { empleado, turnos, mes, anio } = informe;
                
                // Generar un UID único para el calendario
                const timestamp = new Date().toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
                
                // Encabezado del calendario iCalendar
                let ical = 'BEGIN:VCALENDAR\n';
                ical += 'VERSION:2.0\n';
                ical += 'PRODID:-//Sistema Gestión Turnos//NONSGML v1.0//ES\n';
                ical += 'CALSCALE:GREGORIAN\n';
                ical += `X-WR-CALNAME:Turnos ${empleado.nombre} - ${mes} ${anio}\n`;
                ical += `X-WR-CALDESC:Cuadrante de turnos de ${empleado.nombre}\n`;
                ical += `X-WR-TIMEZONE:Europe/Madrid\n`;
                ical += 'METHOD:PUBLISH\n';
                
                // Mapa de colores por tipo de turno para Outlook/Google Calendar
                const colorMapa = {
                    'mañana': '#85C1E9',
                    'tarde': '#F8C471',
                    'noche': '#BB8FCE',
                    'mixto': '#85C1E9',
                    'descanso': '#82E0AA',
                    'vacaciones': '#F5B041',
                    'baja': '#F1948A',
                    'festivo': '#AED6F1',
                    'libre': '#D5F4E6'
                };

                // Agregar cada turno como evento
                turnos.forEach((turno) => {
                    if (!turno.fecha) return;
                    
                    const fecha = turno.fecha instanceof Date ? turno.fecha : new Date(turno.fecha);
                    const fechaStr = fecha.toISOString().split('T')[0].replace(/-/g, '');
                    
                    // Información del turno
                    const infoTurno = tiposTurno[turno.turno] || {};
                    const horario = infoTurno.horario || turno.horario || '08:00-16:00';
                    const horas = turno.horas || infoTurno.horas || 8;
                    
                    // Parsear horario para calcular hora de inicio y fin
                    const [horaInicio, horaFin] = horario.split('-');
                    const inicioDateTime = `${fechaStr}T${horaInicio.replace(':', '')}00`;
                    const finDateTime = `${fechaStr}T${horaFin.replace(':', '')}00`;
                    
                    // UID único para cada evento
                    const eventoUid = `${empleado.id}-${turno.dia}-${anio}-${turno.turno}@turnosapp.local`;
                    
                    // Crear evento VEVENT
                    ical += 'BEGIN:VEVENT\n';
                    ical += `UID:${eventoUid}\n`;
                    ical += `DTSTAMP:${timestamp}Z\n`;
                    ical += `DTSTART:${inicioDateTime}Z\n`;
                    ical += `DTEND:${finDateTime}Z\n`;
                    ical += `SUMMARY:${turno.turno.charAt(0).toUpperCase() + turno.turno.slice(1)} (${horas}h)\n`;
                    ical += `DESCRIPTION:Turno: ${turno.turno}\\nEmpleado: ${empleado.nombre}\\nDepartamento: ${empleado.departamento || 'N/A'}\\nHoras: ${horas}h\\nHorario: ${horario}\n`;
                    ical += `LOCATION:${empleado.localidad || 'No especificado'}\n`;
                    ical += `CATEGORIES:${turno.turno.toUpperCase()},TURNO\n`;
                    
                    // Agregar color si el cliente lo soporta (Google Calendar, Outlook)
                    const color = colorMapa[turno.turno.toLowerCase()] || '#85C1E9';
                    ical += `COLOR:${color}\n`;
                    ical += `X-MICROSOFT-CDO-BUSYSTATUS:${turno.turno === 'descanso' ? 'FREE' : 'BUSY'}\n`;
                    ical += `X-MICROSOFT-CDO-INTENDEDSTATUS:${turno.turno === 'descanso' ? 'FREE' : 'BUSY'}\n`;
                    
                    // Alarmas (notificación 1 día antes si es turno importante)
                    if (turno.turno === 'noche' || turno.turno === 'mixto') {
                        ical += 'BEGIN:VALARM\n';
                        ical += 'ACTION:DISPLAY\n';
                        ical += `DESCRIPTION:Recordatorio: Turno ${turno.turno} mañana\n`;
                        ical += 'TRIGGER:-P1D\n';
                        ical += 'END:VALARM\n';
                    }
                    
                    ical += 'END:VEVENT\n';
                });
                
                // Cerrar calendario
                ical += 'END:VCALENDAR\n';
                
                return ical;
            } catch (error) {
                console.error('❌ Error en generarContenidoiCalendar:', error);
                return '';
            }
        }

        // 🗓️ EXPORTAR A ICALENDAR (.ics) PARA INTEGRACIÓN CON GOOGLE CALENDAR, OUTLOOK, ETC
        function exportarAiCalendar(informe) {
            try {
                console.log('🗓️ [exportarAiCalendar] Iniciando exportación iCalendar...');
                if (!informe) {
                    alert('No hay datos para exportar');
                    return;
                }

                const { empleado, mes, anio } = informe;
                
                // Generar contenido iCalendar usando función reutilizable
                const icalContent = generarContenidoiCalendar(informe);
                
                // Descargar archivo .ics
                const dataUri = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icalContent);
                const enlace = document.createElement('a');
                enlace.href = dataUri;
                enlace.download = `Turnos_${empleado.nombre.replace(/\s+/g, '_')}_${mes}_${anio}.ics`;
                document.body.appendChild(enlace);
                enlace.click();
                document.body.removeChild(enlace);
                
                console.log(`✅ [exportarAiCalendar] iCalendar exportado: ${enlace.download}`);
                
                if (typeof NotificationSystem !== 'undefined') {
                    NotificationSystem.show(`📅 Calendario iCalendar descargado • Importa en Google Calendar, Outlook, etc.`, 'success', 4000);
                }
            } catch (error) {
                console.error('❌ Error en exportarAiCalendar:', error);
                alert('Error: ' + error.message);
            }
        }

        // 📱 WHATSAPP MASIVO - Enviar cuadrante a todos los empleados filtrados por departamento
        window.abrirWhatsApp = function() {
            try {
                const filtroDepto = document.getElementById('filtroDepartamentoGeneral')?.value || 'TODOS';
                const empleadosFiltrados = (filtroDepto === 'TODOS' || filtroDepto === '') 
                    ? (window.empleados || []) 
                    : window.empleados.filter(e => e.departamento === filtroDepto);
                
                if (!empleadosFiltrados || empleadosFiltrados.length === 0) {
                    NotificationSystem.show('❌ No hay empleados con el filtro actual', 'error');
                    return;
                }

                const modal = document.getElementById('modalSemana1');
                const content = document.getElementById('modalSemana1Content');
                if(!modal || !content) {
                    alert(`Se enviarán mensajes a ${empleadosFiltrados.length} empleados.`);
                    const ids = empleadosFiltrados.map(e => e.id);
                    if (window.WhatsAppSenderModule) WhatsAppSenderModule.enviarMasivoEmpleados(ids);
                    return;
                }

                content.innerHTML = `
                    <div style="padding: 20px; color: #1e293b;">
                        <h3 style="margin-top: 0; color: #2563eb;">📱 Envío Masivo WhatsApp</h3>
                        <p>Se enviarán los cuadrantes a <b>${empleadosFiltrados.length}</b> empleados vía WhatsApp Web.</p>
                        <p>Filtro aplicado: <span style="background: #e2e8f0; padding: 2px 8px; border-radius: 4px;">${filtroDepto}</span></p>
                        
                        <div style="margin: 20px 0; padding: 15px; background: #fff7ed; border-radius: 8px; border-left: 4px solid #f97316;">
                            <p style="margin: 0; font-size: 13px; color: #9a3412;">
                                💡 <b>Importante:</b> Se abrirán pestañas en segundo plano. 
                                Permite los "Pop-ups" o ventanas emergentes en tu navegador para que funcione correctamente.
                            </p>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button id="btnIniciarWhatsApp" class="modal-btn" style="background: #22c55e; color: white; flex: 1; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold;">🚀 INICIAR ENVÍO</button>
                            <button onclick="document.getElementById('modalSemana1').classList.remove('active')" class="modal-btn" style="flex: 1; background: #e2e8f0; border: none; padding: 12px; border-radius: 6px; cursor: pointer;">CANCELAR</button>

                        </div>
                    </div>
                `;

                document.getElementById('btnIniciarWhatsApp').onclick = () => {
                    const ids = empleadosFiltrados.map(e => e.id);
                    if (window.WhatsAppSenderModule) {
                        WhatsAppSenderModule.enviarMasivoEmpleados(ids);
                    } else if (typeof WhatsAppSender !== 'undefined') {
                        WhatsAppSender.enviarMasivoEmpleados(ids);
                    } else {
                        alert('Error: Módulo de WhatsApp no encontrado');
                    }
                    modal.classList.remove('active');
                };

                document.getElementById('modalSemana1Title').textContent = '📱 Configuración de Envío';
                modal.classList.add('active');

            } catch (err) {
                console.error('Error abriendo panel WhatsApp:', err);
                if (window.NotificationSystem) NotificationSystem.show('Error al abrir panel de WhatsApp', 'error');
            }
        };

        // ✅ INICIALIZAR NOTIFICATIONSYSTEM COMPLETO AL CARGAR LA PÁGINA
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🟢 [DOMContentLoaded] Página cargada');
            
            if (window.NotificationSystem && window.NotificationSystem.reproducirSonido) {
                console.log('✅ NotificationSystem mejorado completamente cargado');
            } else {
                console.log('⏳ Esperando que NotificationSystem se cargue completamente...');
            }
        });
        
        // Verificar cuando está listo
        window.addEventListener('load', function() {
            setTimeout(() => {
                console.log('%c✅ NotificationSystem LISTO', 'background: #4CAF50; color: white; padding: 10px;');
                console.log('Métodos disponibles:', Object.keys(window.NotificationSystem).filter(k => typeof window.NotificationSystem[k] === 'function'));
            }, 500);
        });
    </script>

    <!-- Funciones Globales del Sidebar para compatibilidad -->
    <script>
        // Funciones globales que llaman a las funciones del sidebar

        // Si existe abrirValidacion en controles-semana-1.js, usar ese
        // Si no, crear un stub
        if (typeof abrirValidacion === 'undefined') {
            window.abrirValidacion = function() {
                console.log('🔍 abrirValidacion - no existe aún, cargando...');
                if (typeof window.abrirValidacion_loaded === 'function') {
                    window.abrirValidacion_loaded();
                }
            };
        }

        // Auto-guardado UI - Delegado a módulo modular
        // ✅ SIEMPRE definir/sobrescribir la función para asegurar que use el nuevo modal
        window.abrirAutoGuardado = function() {
            console.log('📋 Abriendo Auto-guardado...');
            
            // Limpiar cualquier elemento antiguo que pueda interferir
            const elementosAntiguos = document.querySelectorAll('[id*="autoguard" i]:not(#modalAutoGuardado), [id*="autosave" i]:not(#modalAutoGuardado), [id*="configuracion" i]');
            elementosAntiguos.forEach(el => {
                console.log('🗑️ Removiendo elemento antiguo:', el.id);
                el.remove();
            });
            
            // Esperar a que AutoSaveUIModule esté listo
            if (typeof AutoSaveUIModule === 'undefined') {
                console.warn('⏳ AutoSaveUIModule aún no se ha cargado. Esperando...');
                let intentos = 0;
                const esperar = setInterval(() => {
                    if (typeof AutoSaveUIModule !== 'undefined') {
                        clearInterval(esperar);
                        console.log('✅ AutoSaveUIModule cargado, abriendo modal');
                        AutoSaveUIModule.abrirModal();
                    } else if (++intentos > 50) {
                        clearInterval(esperar);
                        console.error('❌ Error: AutoSaveUIModule no cargó');
                        alert('⚠️ El módulo de auto-guardado no se cargó. Recarga la página (Ctrl+Shift+R).');
                    }
                }, 100);
            } else {
                console.log('✅ AutoSaveUIModule disponible, abriendo modal');
                AutoSaveUIModule.abrirModal();
            }
        };

        
        // ============================================================================
        // 📊 MÓDULO: Métricas y Dashboard
        // ============================================================================
        if (typeof window.MetricasModule === 'undefined') {
            window.MetricasModule = (function() {
                
                // ===== VARIABLES PRIVADAS =====
                const mesesNombre = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
                let ultimasMetricas = null;
                let cacheActivo = true;
                
                // ===== FUNCIONES PRIVADAS =====
                function calcularMetricas() {
                    try {
                        if (!empleados || empleados.length === 0) {
                            console.warn('⚠️ No hay empleados en el sistema');
                            return null;
                        }
                        
                        const mesActual = AppState.currentMonth;
                        const anioActual = AppState.currentYear;
                        
                        let totalHoras = 0;
                        let totalTurnosNoche = 0;
                        let totalTurnos = 0;
                        let empleadosActivos = empleados.filter(e => e.estado === 'activo').length;
                        let empleadosConTurnos = 0;
                        let distribucionTurnos = {
                            mañana: 0,
                            tarde: 0,
                            noche: 0,
                            mixto: 0,
                            descanso: 0,
                            vacaciones: 0,
                            baja: 0,
                            festivo: 0,
                            otros: 0
                        };
                        
                        // Detalles por empleado
                        const detallesPorEmpleado = [];
                        
                        empleados.forEach(emp => {
                            const turnos = AppState.scheduleData.get(emp.id) || [];
                            let horasEmpleado = 0;
                            let turnosEmpleado = 0;
                            
                            turnos.forEach(t => {
                                const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                                if (fecha.getMonth() === mesActual && fecha.getFullYear() === anioActual) {
                                    totalHoras += (t.horas || 0);
                                    horasEmpleado += (t.horas || 0);
                                    totalTurnos++;
                                    turnosEmpleado++;
                                    
                                    if (t.turno === 'noche') totalTurnosNoche++;
                                    
                                    // Contar distribución
                                    if (distribucionTurnos.hasOwnProperty(t.turno)) {
                                        distribucionTurnos[t.turno]++;
                                    } else {
                                        distribucionTurnos.otros++;
                                    }
                                }
                            });
                            
                            if (turnosEmpleado > 0) {
                                empleadosConTurnos++;
                                detallesPorEmpleado.push({
                                    nombre: emp.nombre,
                                    horas: horasEmpleado,
                                    turnos: turnosEmpleado
                                });
                            }
                        });
                        
                        return {
                            mes: mesActual,
                            año: anioActual,
                            empleadosActivos,
                            empleadosConTurnos,
                            totalEmpleados: empleados.length,
                            totalHoras: Math.round(totalHoras),
                            totalTurnos,
                            totalTurnosNoche,
                            distribucionTurnos,
                            detallesPorEmpleado,
                            timestamp: new Date().toLocaleString('es-ES')
                        };
                    } catch (error) {
                        console.error('❌ Error calculando métricas:', error);
                        return null;
                    }
                }
                
                function generarHTML(metricas) {
                    if (!metricas) {
                        return `
                            <div style="text-align: center; padding: 30px;">
                                <div style="font-size: 48px; margin-bottom: 10px;">⚠️</div>
                                <h3 style="color: #e74c3c;">Sin datos disponibles</h3>
                                <p style="color: #666;">No hay empleados en el sistema o no hay turnos generados para el mes seleccionado.</p>
                            </div>
                        `;
                    }
                    
                    const mesFecha = new Date(metricas.año, metricas.mes, 1);
                    const nombreMes = mesFecha.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
                    
                    let html = `
                        <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0d6efd;">
                            <h3 style="margin: 0; color: #0d6efd;">📊 Métricas de ${nombreMes.toUpperCase()}</h3>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 12px;">Actualizado: ${metricas.timestamp}</p>
                        </div>
                    `;
                    
                    // Cards principales
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">';
                    
                    html += `
                        <div style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #22c55e;">
                            <div style="font-size: 28px; font-weight: bold; color: #22c55e;">${metricas.empleadosActivos}</div>
                            <div style="color: #666; font-size: 12px; margin-top: 5px;">👥 Empleados Activos</div>
                            <div style="color: #999; font-size: 11px; margin-top: 3px;">(de ${metricas.totalEmpleados})</div>
                        </div>
                        
                        <div style="background: #cfe2ff; padding: 15px; border-radius: 8px; border-left: 4px solid #0d6efd;">
                            <div style="font-size: 28px; font-weight: bold; color: #0d6efd;">${metricas.totalTurnos}</div>
                            <div style="color: #666; font-size: 12px; margin-top: 5px;">📅 Total Turnos</div>
                            <div style="color: #999; font-size: 11px; margin-top: 3px;">${metricas.empleadosConTurnos} empleados</div>
                        </div>
                        
                        <div style="background: #cce5ff; padding: 15px; border-radius: 8px; border-left: 4px solid #0dcaf0;">
                            <div style="font-size: 28px; font-weight: bold; color: #0dcaf0;">${metricas.totalHoras}h</div>
                            <div style="color: #666; font-size: 12px; margin-top: 5px;">⏱️ Horas Totales</div>
                            <div style="color: #999; font-size: 11px; margin-top: 3px;">Promedio: ${metricas.totalTurnos > 0 ? (metricas.totalHoras / metricas.totalTurnos).toFixed(1) : '0'}h/turno</div>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <div style="font-size: 28px; font-weight: bold; color: #ffc107;">${metricas.totalTurnosNoche}</div>
                            <div style="color: #666; font-size: 12px; margin-top: 5px;">🌙 Turnos Noche</div>
                            <div style="color: #999; font-size: 11px; margin-top: 3px;">${metricas.totalTurnos > 0 ? ((metricas.totalTurnosNoche / metricas.totalTurnos * 100).toFixed(1)) : '0'}%</div>
                        </div>
                    `;
                    
                    html += '</div>';
                    
                    // Distribución de turnos
                    if (metricas.totalTurnos > 0) {
                        html += '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
                        html += '<h4 style="margin: 0 0 15px 0; color: #333;">📈 Distribución de Turnos</h4>';
                        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">';
                        
                        for (const [turno, cantidad] of Object.entries(metricas.distribucionTurnos)) {
                            if (cantidad > 0) {
                                const porcentaje = ((cantidad / metricas.totalTurnos) * 100).toFixed(1);
                                const colores = {
                                    mañana: '#d4edda',
                                    tarde: '#fff3cd',
                                    noche: '#f8d7da',
                                    mixto: '#cfe2ff',
                                    descanso: '#e2e3e5',
                                    vacaciones: '#d1ecf1',
                                    baja: '#f5c6cb',
                                    festivo: '#ffeaa7'
                                };
                                const color = colores[turno] || '#f8f9fa';
                                
                                html += `
                                    <div style="background: ${color}; padding: 12px; border-radius: 6px; text-align: center;">
                                        <div style="font-weight: bold; color: #333; font-size: 18px;">${cantidad}</div>
                                        <div style="color: #666; font-size: 11px; margin-top: 3px;">${turno}</div>
                                        <div style="color: #999; font-size: 10px; margin-top: 2px;">${porcentaje}%</div>
                                    </div>
                                `;
                            }
                        }
                        
                        html += '</div></div>';
                    }
                    
                    // Top empleados por horas (si hay datos)
                    if (metricas.detallesPorEmpleado && metricas.detallesPorEmpleado.length > 0) {
                        const top = metricas.detallesPorEmpleado.sort((a, b) => b.horas - a.horas).slice(0, 5);
                        
                        html += '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
                        html += '<h4 style="margin: 0 0 15px 0; color: #333;">🏆 Top Empleados por Horas</h4>';
                        html += '<div style="font-size: 13px;">';
                        
                        top.forEach((emp, idx) => {
                            const medalla = ['🥇', '🥈', '🥉', '4️⃣', '5️⃣'][idx];
                            html += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #ddd;">
                                    <div>
                                        <span>${medalla}</span>
                                        <strong>${emp.nombre}</strong>
                                        <span style="color: #999; font-size: 12px;">(${emp.turnos} turnos)</span>
                                    </div>
                                    <div style="font-weight: bold; color: #0d6efd;">${emp.horas}h</div>
                                </div>
                            `;
                        });
                        
                        html += '</div></div>';
                    }
                    
                    // Información sobre generación de turnos
                    if (metricas.totalTurnos === 0) {
                        html += `
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <strong>ℹ️ Información:</strong>
                                <p style="margin: 10px 0 0 0; color: #666; font-size: 13px;">
                                    No hay turnos generados para ${nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1)}.
                                </p>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">
                                    Debes generar los turnos para ver las métricas. Usa el botón "Generar Turnos" en la sección de empleados.
                                </p>
                            </div>
                        `;
                    }
                    
                    return html;
                }
                
                // ===== API PÚBLICA =====
                return {
                    abrirModal: function() {
                        try {
                            const modal = document.getElementById('modalSemana3');
                            const titulo = document.getElementById('modalSemana3Title');
                            const contenido = document.getElementById('modalSemana3Content');
                            
                            if (!modal) {
                                console.error('❌ Modal para métricas no encontrado');
                                NotificationSystem.show('Error: Modal de métricas no encontrado', 'error');
                                return;
                            }
                            
                            console.log('📊 Abriendo módulo de Métricas...');
                            
                            const metricas = this.calcularMetricas();
                            ultimasMetricas = metricas;
                            
                            const html = generarHTML(metricas);
                            
                            if (titulo) titulo.textContent = '📊 Métricas y Dashboard';
                            if (contenido) contenido.innerHTML = html;
                            
                            modal.classList.add('active');
                            console.log('✅ Modal de métricas abierto');
                            
                        } catch (error) {
                            console.error('❌ Error abriendo modal de métricas:', error);
                            NotificationSystem.show('Error al abrir métricas: ' + error.message, 'error');
                        }
                    },
                    
                    calcularMetricas: function() {
                        if (cacheActivo && ultimasMetricas) {
                            return ultimasMetricas;
                        }
                        return calcularMetricas();
                    },
                    
                    obtenerMetricas: function() {
                        return ultimasMetricas || calcularMetricas();
                    },
                    
                    actualizarCache: function() {
                        ultimasMetricas = calcularMetricas();
                        return ultimasMetricas;
                    },
                    
                    exportarJSON: function() {
                        const metricas = this.obtenerMetricas();
                        return JSON.stringify(metricas, null, 2);
                    },
                    
                    exportarCSV: function() {
                        const metricas = this.obtenerMetricas();
                        if (!metricas) return '';
                        
                        let csv = 'Métrica,Valor\n';
                        csv += `Empleados Activos,${metricas.empleadosActivos}\n`;
                        csv += `Horas Totales,${metricas.totalHoras}\n`;
                        csv += `Turnos Noche,${metricas.totalTurnosNoche}\n`;
                        
                        return csv;
                    },
                    
                    deshabilitarCache: function() {
                        cacheActivo = false;
                        console.log('⚙️ Cache de métricas deshabilitado');
                    },
                    
                    habilitarCache: function() {
                        cacheActivo = true;
                        console.log('⚙️ Cache de métricas habilitado');
                    }
                };
            })();
            
            // Registrar módulo
            ModuleManager.register('Metricas', MetricasModule);
            console.log('📊 MetricasModule inicializado');
        }

        // 🗑️ DEPRECATED: window.abrirMetricas() was redundant
        // PUNTO DE ENTRADA ÚNICO: js/controles-semana-3.js:133
        
        if (typeof abrirCalendario === 'undefined') {
            window.abrirCalendario = function() {
                const modal = document.getElementById('modalSemana4');
                if (!modal) {
                    console.error('❌ Modal para calendario no encontrado');
                    return;
                }
                
                const titulo = document.getElementById('modalSemana4Title');
                const contenido = document.getElementById('modalSemana4Content');
                
                if (titulo) titulo.textContent = '📅 Calendario iCalendar';
                
                let html = '<h3 style="margin-top: 0;">📅 Exportar Calendario iCalendar</h3>';
                html += '<div style="background: #f0f0f0; padding: 20px; border-radius: 8px;">';
                
                if (empleados && empleados.length > 0) {
                    html += '<div style="margin-bottom: 15px;">';
                    html += '<label style="display: block; margin-bottom: 8px; font-weight: bold;">Selecciona un empleado:</label>';
                    html += '<select id="selectEmpleadoICal" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">';
                    html += '<option value="">-- Selecciona --</option>';
                    empleados.forEach(emp => {
                        html += `<option value="${emp.id}">${emp.nombre}</option>`;
                    });
                    html += '</select>';
                    html += '</div>';
                    
                    html += '<div style="margin-bottom: 15px;">';
                    html += '<label style="display: block; margin-bottom: 8px; font-weight: bold;">Mes:</label>';
                    html += '<select id="selectMesICal" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">';
                    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                    meses.forEach((m, i) => {
                        const selected = i === AppState.currentMonth ? 'selected' : '';
                        html += `<option value="${i}" ${selected}>${m}</option>`;
                    });
                    html += '</select>';
                    html += '</div>';
                    
                    html += '<button onclick="descargarICalendarEmpleado()" style="width: 100%; padding: 12px; background: #8b5cf6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px;">';
                    html += '📥 Descargar iCalendar';
                    html += '</button>';
                    
                    html += '<div style="background: white; padding: 15px; border-radius: 4px; margin-top: 20px; border-left: 4px solid #3498db;">';
                    html += '<strong>ℹ️ Información:</strong>';
                    html += '<p style="margin: 10px 0 0 0; font-size: 13px; color: #666;">El archivo descargado puede ser importado en Google Calendar, Outlook, Apple Calendar o cualquier aplicación que soporte el formato iCalendar (.ics)</p>';
                    html += '</div>';
                } else {
                    html += '<div style="color: #999; padding: 20px; text-align: center;">No hay empleados registrados</div>';
                }
                
                html += '</div>';
                
                if (contenido) contenido.innerHTML = html;
                if (modal) modal.classList.add('active');
            };
        }

        // Función para descargar iCalendar
        window.descargarICalendarEmpleado = function() {
            const empleadoId = document.getElementById('selectEmpleadoICal')?.value;
            const mesNum = parseInt(document.getElementById('selectMesICal')?.value || AppState.currentMonth);
            
            if (!empleadoId) {
                alert('Por favor selecciona un empleado');
                return;
            }
            
            const empleado = empleados.find(e => e.id === parseInt(empleadoId));
            if (!empleado) {
                alert('Empleado no encontrado');
                return;
            }
            
            const turnos = AppState.scheduleData.get(parseInt(empleadoId)) || [];
            const anio = AppState.currentYear;
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const mesNombre = meses[mesNum];
            
            // Generar contenido iCalendar
            let ical = 'BEGIN:VCALENDAR\\n';
            ical += 'VERSION:2.0\\n';
            ical += 'PRODID:-//Sistema Turnos//Turnos//ES\\n';
            ical += `CALSCALE:GREGORIAN\\n`;
            ical += `X-WR-CALNAME:Turnos - ${empleado.nombre} - ${mesNombre} ${anio}\\n`;
            ical += `X-WR-TIMEZONE:Europe/Madrid\\n`;
            ical += `X-WR-CALDESC:Cuadrante de turnos de ${empleado.nombre}\\n`;
            
            let eventCount = 0;
            turnos.forEach(turno => {
                const fecha = turno.fecha instanceof Date ? turno.fecha : new Date(turno.fecha);
                if (fecha.getMonth() === mesNum && fecha.getFullYear() === anio) {
                    const year = fecha.getFullYear();
                    const month = String(fecha.getMonth() + 1).padStart(2, '0');
                    const day = String(fecha.getDate()).padStart(2, '0');
                    const dateStr = `${year}${month}${day}`;
                    
                    const tipoTurno = turno.turno || 'Sin turno';
                    const titulo = `${empleado.nombre} - ${tipoTurno.charAt(0).toUpperCase() + tipoTurno.slice(1)}`;
                    
                    ical += 'BEGIN:VEVENT\\n';
                    ical += `UID:turno-${empleado.id}-${dateStr}@sistematuros\\n`;
                    ical += `DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').replace(/\\.\\d{3}/, '')}Z\\n`;
                    ical += `DTSTART:${dateStr}T000000Z\\n`;
                    ical += `DTEND:${dateStr}T235959Z\\n`;
                    ical += `SUMMARY:${titulo}\\n`;
                    ical += `DESCRIPTION:Turno: ${tipoTurno} - Horas: ${turno.horas || 0}h\\n`;
                    ical += `LOCATION:Trabajo\\n`;
                    ical += `END:VEVENT\\n`;
                    eventCount++;
                }
            });
            
            ical += 'END:VCALENDAR';
            
            // Descargar
            const blob = new Blob([ical], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Turnos_${empleado.nombre.replace(/\\s+/g, '_')}_${mesNombre}_${anio}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            
            alert(`✅ Descargado: ${eventCount} eventos de turno`);
        };
        
        // ============================================================================
        // 🔊 REANUDAR AUDIOCONTEXT DESPUÉS DE USER GESTURE
        // ============================================================================
        function resumirAudioContext() {
            const audioContext = window.__appAudioContext;
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    console.log('✅ AudioContext reanudado');
                }).catch(err => {
                    console.warn('⚠️ No se pudo reanudar AudioContext:', err);
                });
            }
        }
        
        // Reanudar en el primer user gesture
        document.addEventListener('click', resumirAudioContext, { once: true });
        document.addEventListener('keydown', resumirAudioContext, { once: true });
        document.addEventListener('touchstart', resumirAudioContext, { once: true });

        /**
         * Actualiza los KPIs de la aplicación (Modo Local)
         */
        window.actualizarKPIs = function() {
            try {
                let totalHoras = 0;
                let turnosMañana = 0;
                let turnosTarde = 0;
                let turnosNoche = 0;
                let totalEmpleados = window.empleados ? window.empleados.length : 0;
                
                // Calcular desde el Map AppState.scheduleData
                if (window.AppState && AppState.scheduleData) {
                    AppState.scheduleData.forEach((turnos) => {
                        turnos.forEach(t => {
                            const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                            if (fecha.getMonth() === AppState.currentMonth && 
                                fecha.getFullYear() === AppState.currentYear) {
                                
                                totalHoras += (t.horas || 0);
                                const turno = (t.turno || '').toLowerCase();
                                if (turno.includes('mañana')) turnosMañana++;
                                else if (turno.includes('tarde')) turnosTarde++;
                                else if (turno.includes('noche')) turnosNoche++;
                            }
                        });
                    });
                }

                // Actualizar UI
                const elTotEmp = document.getElementById('totalEmpleadosGeneral');
                const elHoras = document.getElementById('totalHorasGeneral');
                const elMañana = document.getElementById('turnosMañanaGeneral');
                const elTarde = document.getElementById('turnosTardeGeneral');
                const elNoche = document.getElementById('turnosNocheGeneral');
                
                if (elTotEmp) elTotEmp.textContent = totalEmpleados;
                if (elHoras) elHoras.textContent = `${totalHoras.toFixed(1)}h`;
                if (elMañana) elMañana.textContent = turnosMañana;
                if (elTarde) elTarde.textContent = turnosTarde;
                if (elNoche) elNoche.textContent = turnosNoche;
                
                console.log('📊 KPIs locales actualizados');
            } catch (err) {
                console.error('Error actualizando KPIs:', err);
            }
        };

        /**
         * Refresca los datos del cuadrante
         */
        window.recargarDatos = function() {
            console.log('🔄 Refrescando cuadrante...');
            if (typeof UI !== 'undefined' && UI.generarCuadranteGeneral) {
                UI.generarCuadranteGeneral();
                actualizarKPIs();
                if (window.NotificationSystem) NotificationSystem.show('Datos actualizados', 'success');
            }
        };

        /**
         * Limpia todos los datos de la aplicación (Modo Local)
         */
        window.limpiarTodosDatos = function() {
            const modal = document.getElementById('modalSemana1');
            const content = document.getElementById('modalSemana1Content');
            if(!modal || !content) {
                // Si no hay modal, usar confirm básico
                if (confirm('⚠️ ¿Estás seguro de que quieres borrar TODOS los datos locales?')) {
                    ejecutarLimpiezaTotal();
                }
                return;
            }

            content.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 50px; margin-bottom: 20px;">⚠️</div>
                    <h3>¿ESTÁS SEGURO?</h3>
                    <p>Esta acción eliminará <b>TODOS</b> los empleados y sus turnos asociados de tu navegador.</p>
                    <p style="color: #e74c3c; font-weight: bold;">ESTA ACCIÓN NO SE PUEDE DESHACER.</p>
                    <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                        <button onclick="ejecutarLimpiezaTotal()" class="modal-btn" style="background: #e74c3c; color: white;">SÍ, BORRAR TODO</button>
                        <button onclick="document.getElementById('modalSemana1').classList.remove('active')" class="modal-btn">CANCELAR</button>
                    </div>
                </div>
            `;
            document.getElementById('modalSemana1Title').textContent = '⚠️ LIMPIEZA TOTAL';
            modal.classList.add('active');
        };

        window.ejecutarLimpiezaTotal = function() {
            console.log('🗑️ Ejecutando limpieza total...');
            
            // 1. Limpiar localStorage
            localStorage.clear();
            
            // 2. Reiniciar estados en memoria
            if (window.AppState && AppState.scheduleData) AppState.scheduleData.clear();
            window.empleados = [];
            
            // 3. Notificar y recargar
            const content = document.getElementById('modalSemana1Content');
            if (content) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <h2 style="color: #27ae60;">✅ DATOS BORRADOS</h2>
                        <p>La aplicación se ha reiniciado por completo.</p>
                        <p>Recargando en 2 segundos...</p>
                    </div>
                `;
            } else {
                alert('✅ Datos borrados. Recargando...');
            }
            
            setTimeout(() => {
                location.reload();
            }, 2000);
        };

        // ========== FUNCIONES DE SEMANA 2: REPORTES Y BACKUP ==========
        
        /**
         * Abrir modal de generador de reportes
         */
        window.abrirReportes = function() {
            console.log('📊 Abriendo Generador de Reportes...');
            
            if (typeof GeneradorReportes === 'undefined') {
                console.error('❌ GeneradorReportes no está cargado');
                alert('Error: El módulo de reportes no está disponible. Recarga la página.');
                return;
            }
            
            const modal = document.getElementById('modalSemana2');
            const content = document.getElementById('modalSemana2Content');
            
            if (!modal || !content) {
                console.error('❌ Modal no encontrado');
                return;
            }
            
            // Generar reporte
            const reporte = GeneradorReportes.generarReporteMensual();
            
            // Construir HTML del reporte
            let html = `
                <div style="padding: 20px;">
                    <h2 style="margin-top: 0; color: #1e293b; border-bottom: 2px solid #3b82f6; padding-bottom: 12px;">
                        📊 Reporte Mensual - ${reporte.periodo}
                    </h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 20px 0;">
                        <div style="padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                            <div style="color: #0284c7; font-size: 12px; font-weight: 600; text-transform: uppercase;">Total Empleados</div>
                            <div style="font-size: 28px; font-weight: 700; color: #075985;">${reporte.totalEmpleados}</div>
                        </div>
                        <div style="padding: 16px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
                            <div style="color: #059669; font-size: 12px; font-weight: 600; text-transform: uppercase;">Empleados Activos</div>
                            <div style="font-size: 28px; font-weight: 700; color: #047857;">${reporte.empleadosActivos}</div>
                        </div>
                        <div style="padding: 16px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="color: #b45309; font-size: 12px; font-weight: 600; text-transform: uppercase;">En Vacaciones</div>
                            <div style="font-size: 28px; font-weight: 700; color: #92400e;">${reporte.empleadosEnVacaciones}</div>
                        </div>
                        <div style="padding: 16px; background: #fee2e2; border-radius: 8px; border-left: 4px solid #ef4444;">
                            <div style="color: #dc2626; font-size: 12px; font-weight: 600; text-transform: uppercase;">En Baja</div>
                            <div style="font-size: 28px; font-weight: 700; color: #991b1b;">${reporte.empleadosEnBaja}</div>
                        </div>
                    </div>
                    
                    <h3 style="color: #1e293b; margin-top: 30px; border-bottom: 2px solid #8b5cf6; padding-bottom: 12px;">📈 Estadísticas del Período</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin: 16px 0;">
                        <div style="padding: 12px; background: #f3f4f6; border-radius: 6px;">
                            <div style="font-size: 12px; color: #6b7280; font-weight: 600;">Turnos Asignados</div>
                            <div style="font-size: 24px; font-weight: 700; color: #1f2937;">${reporte.estadisticas.turnosAsignados}</div>
                        </div>
                        <div style="padding: 12px; background: #f3f4f6; border-radius: 6px;">
                            <div style="font-size: 12px; color: #6b7280; font-weight: 600;">Horas Totales</div>
                            <div style="font-size: 24px; font-weight: 700; color: #1f2937;">${reporte.estadisticas.horasTotales}h</div>
                        </div>
                        <div style="padding: 12px; background: #f3f4f6; border-radius: 6px;">
                            <div style="font-size: 12px; color: #6b7280; font-weight: 600;">Turnos Nocturnos</div>
                            <div style="font-size: 24px; font-weight: 700; color: #1f2937;">${reporte.estadisticas.turnosNocturnos}</div>
                        </div>
                        <div style="padding: 12px; background: #f3f4f6; border-radius: 6px;">
                            <div style="font-size: 12px; color: #6b7280; font-weight: 600;">Descansos</div>
                            <div style="font-size: 24px; font-weight: 700; color: #1f2937;">${reporte.estadisticas.turnosDescanso}</div>
                        </div>
                    </div>
                    
                    <h3 style="color: #1e293b; margin-top: 30px; border-bottom: 2px solid #8b5cf6; padding-bottom: 12px;">👥 Detalle por Empleado</h3>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead style="background: #f3f4f6; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb; font-weight: 600;">Empleado</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e5e7eb; font-weight: 600;">Depto</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e5e7eb; font-weight: 600;">Horas</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e5e7eb; font-weight: 600;">Turnos</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reporte.empleados.map((emp, idx) => `
                                    <tr style="border-bottom: 1px solid #e5e7eb; ${idx % 2 === 0 ? 'background: #f9fafb;' : ''}">
                                        <td style="padding: 10px; font-weight: 600; color: #1f2937;">${emp.nombre}</td>
                                        <td style="padding: 10px; text-align: center; color: #6b7280;">${emp.departamento}</td>
                                        <td style="padding: 10px; text-align: center; font-weight: 600; color: #0284c7;">${emp.horasTrabajadas}h</td>
                                        <td style="padding: 10px; text-align: center; font-weight: 600; color: #059669;">${emp.turnosTotal}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 12px; background: #f0f9ff; border-radius: 8px; font-size: 12px; color: #0c4a6e;">
                        📅 Generado: ${reporte.fechaGeneracion}
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            document.getElementById('modalSemana2Title').textContent = '📊 Generador de Reportes';
            modal.classList.add('active');
        };
    </script>

    <!-- INICIALIZACIÓN: Panel de Filtros y Análisis de Equidad -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ⭐ INICIALIZADOR DE EMERGENCIA - FORZAR CARGA CORRECTA 2026
            console.log('🚀 [INICIALIZADOR EMERGENCIA] Verificando estado...');
            
            async function inicializarSistema() {
                // 1. Asegurarse de que AppState existe
                if (typeof AppState !== 'undefined') {
                    // Cargar primero para ver qué hay
                    await AppState.loadFromStorage();
                    console.log(`📅 AppState cargado: Año ${AppState.currentYear}, Mes ${AppState.currentMonth}`);
                    
                    // FORZAR 2026 si es antiguo
                    if (!AppState.currentYear || AppState.currentYear < 2026) {
                        console.warn('⚠️ Detectado año antiguo o nulo. Forzando Enero 2026.');
                        AppState.currentYear = 2026;
                        AppState.currentMonth = 0; 
                        
                        // Si es un año muy viejo (2024), quizás convenga limpiar datos corruptos
                        if (AppState.currentYear === 2024) {
                            console.warn('🧹 Limpiando localStorage de 2024...');
                            localStorage.removeItem('turnosAppState');
                        }
                        
                        AppState.saveToStorage();
                    }
                    
                    // 2. Asegurar que hay 12 empleados (Sincronización forzada)
                    if (window.empleados && window.empleados.length < 12) {
                        console.warn(`⚠️ Detectados solo ${window.empleados.length} empleados. Restaurando 12...`);
                        // El código al inicio del archivo ya los definió, pero por si acaso:
                        localStorage.setItem('empleadosData', JSON.stringify(window.empleados));
                    }
                    
                    // 3. Forzar regeneración si no hay datos
                    if (typeof TurnoManager !== 'undefined' && TurnoManager.reiniciarDatos) {
                        console.log('🛠️ Ejecutando TurnoManager.reiniciarDatos()...');
                        await TurnoManager.reiniciarDatos();
                    }
                    
                    // 4. Actualizar selectores
                    const selectYear = document.getElementById('selectYear');
                    const selectMonth = document.getElementById('selectMonth');
                    if (selectYear) selectYear.value = AppState.currentYear;
                    if (selectMonth) selectMonth.value = AppState.currentMonth;
                    
                    console.log('✅ Sistema inicializado en 2026 con 12 empleados');
                }
            }

            // Ejecutar con un pequeño delay para asegurar que los scripts se han parseado
            setTimeout(inicializarSistema, 500);

            // Resto de inicialización (Filtros)
            setTimeout(async () => {
                if (typeof PanelFiltros !== 'undefined') {
                    try {
                        const html = await PanelFiltros.renderizar();
                        const container = document.getElementById('panelFiltrosContainer');
                        if (container) {
                            container.innerHTML = html;
                            console.log('✓ Panel de Filtros inicializado');
                        }
                    } catch (e) {
                        console.error('⚠️ Error inicializando Panel de Filtros:', e);
                    }
                }
            }, 1000);
        });
    </script>

    <!-- ⭐ FUNCIÓN WHATSAPP INDIVIDUAL -->
    <script>
        // Función auxiliar para normalizar strings
        function lowerCaseSafe(str) {
            return (str ?? '').toString().toLowerCase().trim();
        }

        async function enviarWhatsAppIndividual() {
            try {
                console.log('🔵 [enviarWhatsAppIndividual] Iniciando...');
                const cuadranteIndividual = document.getElementById('cuadranteIndividual');
                if (!cuadranteIndividual || cuadranteIndividual.style.display === 'none') {
                    alert('Error: El cuadrante individual no está abierto');
                    return;
                }
                console.log('✅ [enviarWhatsAppIndividual] Cuadrante individual encontrado');

                const btnWhatsAppOriginal = cuadranteIndividual.querySelector('.btn-whatsapp-modal');
                const onclickAttr = btnWhatsAppOriginal?.getAttribute('onclick') || '';
                let matchParams = onclickAttr.match(/exportarEmpleado\((\d+)\s*,\s*['"]([^'"\)]+)['"]\s*,\s*(\d+)/);

                const titleEl = cuadranteIndividual.querySelector('h3');
                let mesNombre = '';
                let anio = 0;

                if (matchParams) {
                    mesNombre = matchParams[2];
                    anio = parseInt(matchParams[3]);
                } else {
                    const titulo = titleEl?.textContent || '';
                    const mesesNombresRaw = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
                    const encontrado = mesesNombresRaw.find(m => titulo.includes(m));
                    if (!encontrado) {
                        alert('Error: No se puede identificar el mes');
                        return;
                    }
                    mesNombre = encontrado;
                    const matchYear = titulo.match(/(20\d{2})/);
                    anio = matchYear ? parseInt(matchYear[1]) : AppState.currentYear;
                    const matchEmp = onclickAttr.match(/exportarEmpleado\((\d+)/);
                    if (matchEmp) {
                        matchParams = matchEmp;
                    }
                }

                if (!matchParams) {
                    alert('Error: No se pudo identificar el empleado');
                    return;
                }

                const empleadoId = parseInt(matchParams[1]);
                const empleado = empleados.find(e => e.id === empleadoId);
                if (!empleado) {
                    alert('Error: Empleado no encontrado');
                    return;
                }

                const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const normalizarMes = (valor) => (valor ?? '').toString().trim();
                mesNombre = normalizarMes(mesNombre);
                let mesNum = mesNombre ? mesesNombres.findIndex(m => lowerCaseSafe(m) === lowerCaseSafe(mesNombre)) : -1;
                let anioSeleccionado = anio || AppState.currentYear;

                if (mesNum === -1) {
                    alert('Error: No se puede identificar el mes del cuadrante');
                    return;
                }

                let turnosDelMes;
                const turnosDelAppState = AppState.scheduleData.get(empleadoId) || [];
                
                turnosDelMes = turnosDelAppState.filter(t => {
                    if (!t?.fecha) return false;
                    const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                    return fecha.getMonth() === mesNum && fecha.getFullYear() === anioSeleccionado;
                });
                
                const totalHoras = Math.round(turnosDelMes.reduce((sum, t) => sum + (t?.horas || 0), 0) * 100) / 100;
                
                console.log(`🔵 [enviarWhatsAppIndividual] Turnos del empleado ${empleadoId}: ${turnosDelAppState.length} total, ${turnosDelMes.length} del mes ${mesNum + 1}/${anioSeleccionado}, Total horas: ${totalHoras}h`);

                const horasContrato = parseFloat(empleado.horasContrato) || 0;
                const balance = totalHoras - horasContrato;
                const cumplimiento = horasContrato > 0 ? Math.round((totalHoras / horasContrato) * 100) : 0;

                let mensaje = `📋 *CUADRANTE MENSUAL*\n\n`;
                mensaje += `*${empleado.nombre}*\n`;
                mensaje += `\n*📊 Resumen ${mesNombre} ${anioSeleccionado}:*\n`;
                mensaje += `• Horas Trabajadas: ${totalHoras}h\n`;
                mensaje += `• Balance: ${balance >= 0 ? '+' : ''}${balance.toFixed(2)}h\n`;
                mensaje += `• Cumplimiento: ${cumplimiento}%\n`;
                mensaje += `• Contrato: ${horasContrato}h mensuales\n\n`;
                mensaje += `📎 Consulta el cuadrante completo en la aplicación.`;

                const numeroWhatsApp = empleado.telefono ? empleado.telefono.replace(/\D/g, '') : '';
                if (!numeroWhatsApp) {
                    alert('❌ El empleado no tiene número de teléfono registrado');
                    return;
                }

                console.log('🟢 Abriendo WhatsApp...');
                const urlWhatsApp = `whatsapp://send?phone=${numeroWhatsApp}&text=${encodeURIComponent(mensaje)}`;
                console.log('🔗 URL WhatsApp:', urlWhatsApp.substring(0, 50) + '...');
                window.location.href = urlWhatsApp;

                if (typeof NotificationSystem !== 'undefined') {
                    NotificationSystem.show('📱 Abriendo WhatsApp...', 'info', 3000);
                }

            } catch (error) {
                console.error('❌ [enviarWhatsAppIndividual] Error:', error);
                alert('Error en WhatsApp: ' + error.message);
            }
        }
    </script>

    <!-- ⭐ FAB FLOTANTE CON VALIDACIÓN DE CONTRASEÑA -->
    <script>
        // FAB flotante para borrar cuadrante con validación
        const fabHTML = `
            <button id="fabBorrar" style="
                position: fixed;
                bottom: 30px;
                right: 30px;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: linear-gradient(135deg, #ff4757 0%, #e74c3c 100%);
                color: white;
                border: none;
                font-size: 28px;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(255, 71, 87, 0.4);
                transition: all 0.3s ease;
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
            " title="Borrar cuadrante (requiere contraseña)">
                🗑️
            </button>
        `;
        
        document.body.insertAdjacentHTML('beforeend', fabHTML);
        
        const fabBtn = document.getElementById('fabBorrar');
        fabBtn.addEventListener('mouseover', function() {
            this.style.transform = 'scale(1.1)';
            this.style.boxShadow = '0 6px 16px rgba(255, 71, 87, 0.6)';
        });
        
        fabBtn.addEventListener('mouseout', function() {
            this.style.transform = 'scale(1)';
            this.style.boxShadow = '0 4px 12px rgba(255, 71, 87, 0.4)';
        });
        
        fabBtn.addEventListener('click', function() {
            const pwd = prompt('🔐 Ingresa la contraseña para borrar el cuadrante:\n(Contraseña: admin123)');
            if (pwd === 'admin123') {
                const confirmacion = confirm('⚠️ ¿Estás SEGURO de que quieres BORRAR todo el cuadrante?\n\nEsta acción NO se puede deshacer.');
                if (confirmacion) {
                    console.log('🗑️ Borrando todos los datos...');
                    localStorage.clear();
                    sessionStorage.clear();
                    if (window.AppState) {
                        AppState.scheduleData.clear();
                        AppState.cambiosPendientes = [];
                    }
                    window.empleados = [];
                    if (typeof NotificationSystem !== 'undefined') {
                        NotificationSystem.show('✅ Cuadrante borrado. Recargando...', 'success');
                    }
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }
            } else if (pwd !== null) {
                alert('❌ Contraseña incorrecta');
            }
        });

        // ⭐ FUNCIONES WRAPPER PARA ASYNC CAMBIAR MES
        window.cambiarMesWrapper = async function(direccion) {
            const btnMesAnterior = document.getElementById('btnMesAnterior');
            const btnMesSiguiente = document.getElementById('btnMesSiguiente');
            const botonesNav = [btnMesAnterior, btnMesSiguiente].filter(b => b);
            
            // Deshabilitar botones durante la transición
            botonesNav.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'wait';
            });
            
            try {
                await DateUtils.cambiarMes(direccion);
                console.log('✅ Cambio de mes completado');
            } catch (e) {
                console.error('❌ Error cambiando mes:', e);
                NotificationSystem.show('❌ Error al cambiar mes', 'error');
            } finally {
                // Re-habilitar botones
                botonesNav.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                });
            }
        };
    </script>
    
</div><!-- Cierre main-content -->
</body>
</html>
