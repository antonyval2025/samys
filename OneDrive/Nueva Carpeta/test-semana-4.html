<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Semana 4 - Sedes, Calendario y Notificaciones</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        h1 { color: #333; text-align: center; border-bottom: 3px solid #667eea; padding-bottom: 15px; }
        .test-group {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .test {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .test.pass {
            border-left: 4px solid #28a745;
            background: #f0fff4;
        }
        .test.fail {
            border-left: 4px solid #dc3545;
            background: #fff5f5;
        }
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            margin-left: 10px;
        }
        .badge.pass { background: #28a745; color: white; }
        .badge.fail { background: #dc3545; color: white; }
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 10px;
        }
        .stat {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stat-number { font-size: 32px; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; margin-top: 10px; }
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }
        button:hover { background: #5568d3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Semana 4: M√∫ltiples Sedes, Calendario e Integraciones</h1>

        <div id="testResults"></div>

        <button onclick="ejecutarTodosTests()">‚ñ∂Ô∏è Ejecutar Todos los Tests</button>
    </div>

    <script src="js/gestor-multilocal.js"></script>
    <script src="js/integracion-calendario.js"></script>
    <script src="js/sistema-notificaciones.js"></script>

    <script>
        // ‚úÖ CREAR VARIABLES GLOBALES PARA TESTS
        if (typeof empleados === 'undefined') {
            window.empleados = [
                { 
                    id: 1, 
                    nombre: 'Juan Garc√≠a', 
                    email: 'juan@test.com', 
                    telefono: '645123456', 
                    horasContrato: 160,
                    departamento: 'Operaciones',
                    estado: 'activo',
                    localidad: 'Madrid'
                }
            ];
        }

        if (typeof AppState === 'undefined') {
            window.AppState = {
                currentMonth: 0,
                currentYear: 2026,
                scheduleData: new Map(),
                cambiosPendientes: [],
                saveToStorage: function() { console.log('Guardado en storage'); }
            };
        }

        let testsPasados = 0;
        let testsFallidos = 0;

        function crearHTML(titulo, tests) {
            let html = `<div class="test-group"><h3>${titulo}</h3>`;
            
            tests.forEach(test => {
                const estado = test.paso ? 'pass' : 'fail';
                const icono = test.paso ? '‚úÖ' : '‚ùå';
                const badge = `<span class="badge ${estado}">${test.paso ? 'PASO' : 'FALLO'}</span>`;
                
                html += `<div class="test ${estado}">
                    <strong>${icono} ${test.nombre}</strong> ${badge}
                    <p>${test.descripcion}</p>
                    <code>${test.resultado}</code>
                </div>`;
                
                if (test.paso) testsPasados++;
                else testsFallidos++;
            });
            
            html += '</div>';
            return html;
        }

        async function ejecutarTodosTests() {
            testsPasados = 0;
            testsFallidos = 0;

            let html = '';

            // Generar ID de empleado √∫nico basado en timestamp para evitar conflictos entre ejecuciones
            const empleadoIdUnico = 1000 + Math.floor(Math.random() * 9000);

            // Limpiar datos previos para que el test sea idempotente
            if (GestorMultiLocal && GestorMultiLocal.reiniciarDatos) {
                GestorMultiLocal.reiniciarDatos();
            }

            // ============ TEST GRUPO 1: GestorMultiLocal ============
            const testsSedes = [];

            // Test 1: Crear sede
            try {
                const resultado = GestorMultiLocal.crearSede('Sede Madrid', 'Plaza Mayor, Madrid');
                const paso = resultado.exito && resultado.sedeId;
                testsSedes.push({
                    nombre: 'Crear Sede',
                    descripcion: 'Debe crear una nueva sede correctamente',
                    resultado: `Sede creada: ${resultado.sedeId || 'Error'}`,
                    paso: paso
                });
            } catch (e) {
                testsSedes.push({
                    nombre: 'Crear Sede',
                    descripcion: 'Debe crear una nueva sede correctamente',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 2: Obtener sedes
            try {
                const sedes = GestorMultiLocal.obtenerSedes();
                const paso = Array.isArray(sedes) && sedes.length > 0;
                testsSedes.push({
                    nombre: 'Obtener Sedes',
                    descripcion: 'Debe obtener la lista de sedes',
                    resultado: `${sedes.length} sedes encontradas`,
                    paso: paso
                });
            } catch (e) {
                testsSedes.push({
                    nombre: 'Obtener Sedes',
                    descripcion: 'Debe obtener la lista de sedes',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 3: Asignar empleado a sede
            try {
                const sedes = GestorMultiLocal.obtenerSedes();
                const sedeId = sedes[0]?.id;
                // Usar empleado ID √∫nico generado al inicio para evitar conflictos
                const resultado = GestorMultiLocal.asignarEmpleadoSede(empleadoIdUnico, sedeId, 1500);
                testsSedes.push({
                    nombre: 'Asignar Empleado a Sede',
                    descripcion: 'Debe asignar un empleado a una sede',
                    resultado: resultado.mensaje,
                    paso: resultado.exito
                });
            } catch (e) {
                testsSedes.push({
                    nombre: 'Asignar Empleado a Sede',
                    descripcion: 'Debe asignar un empleado a una sede',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 4: Generar reporte comparativo
            try {
                const resultado = GestorMultiLocal.generarReporteComparativo();
                const paso = resultado.exito && resultado.reporte.totalSedes >= 0;
                testsSedes.push({
                    nombre: 'Reporte Comparativo',
                    descripcion: 'Debe generar reporte de todas las sedes',
                    resultado: `${resultado.reporte.totalSedes} sedes, ${resultado.reporte.totalEmpleados} empleados`,
                    paso: paso
                });
            } catch (e) {
                testsSedes.push({
                    nombre: 'Reporte Comparativo',
                    descripcion: 'Debe generar reporte de todas las sedes',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 5: Obtener estad√≠sticas de sede
            try {
                const sedes = GestorMultiLocal.obtenerSedes();
                const resultado = GestorMultiLocal.obtenerEstadisticas(sedes[0]?.id);
                const paso = resultado.exito;
                testsSedes.push({
                    nombre: 'Estad√≠sticas de Sede',
                    descripcion: 'Debe calcular estad√≠sticas de una sede',
                    resultado: `${resultado.estadisticas.empleadosActivos} empleados activos`,
                    paso: paso
                });
            } catch (e) {
                testsSedes.push({
                    nombre: 'Estad√≠sticas de Sede',
                    descripcion: 'Debe calcular estad√≠sticas de una sede',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 6: Sincronizar configuraci√≥n
            try {
                const sedes = GestorMultiLocal.obtenerSedes();
                if (sedes.length >= 2) {
                    const resultado = GestorMultiLocal.sincronizarConfiguracion(sedes[0].id, [sedes[1].id]);
                    testsSedes.push({
                        nombre: 'Sincronizar Config',
                        descripcion: 'Debe sincronizar configuraci√≥n entre sedes',
                        resultado: resultado.mensaje,
                        paso: resultado.exito
                    });
                } else {
                    testsSedes.push({
                        nombre: 'Sincronizar Config',
                        descripcion: 'Debe sincronizar configuraci√≥n entre sedes',
                        resultado: 'Se necesitan al menos 2 sedes',
                        paso: true
                    });
                }
            } catch (e) {
                testsSedes.push({
                    nombre: 'Sincronizar Config',
                    descripcion: 'Debe sincronizar configuraci√≥n entre sedes',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            html += crearHTML('üìç GestorMultiLocal', testsSedes);

            // ============ TEST GRUPO 2: IntegracionCalendario ============
            const testsCalendario = [];

            // Test 1: Cargar festivos
            try {
                const festivos = IntegracionCalendario.obtenerFestivos();
                const paso = Array.isArray(festivos) && festivos.length > 0;
                testsCalendario.push({
                    nombre: 'Cargar Festivos',
                    descripcion: 'Debe cargar festivos espa√±oles',
                    resultado: `${festivos.length} festivos cargados`,
                    paso: paso
                });
            } catch (e) {
                testsCalendario.push({
                    nombre: 'Cargar Festivos',
                    descripcion: 'Debe cargar festivos espa√±oles',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 2: Verificar si es festivo
            try {
                const a√±o = new Date().getFullYear();
                const esFestivo = IntegracionCalendario.esFestivo(`${a√±o}-01-01`);
                testsCalendario.push({
                    nombre: 'Verificar Festivo',
                    descripcion: 'Debe verificar si una fecha es festivo',
                    resultado: `A√±o Nuevo es festivo: ${esFestivo}`,
                    paso: esFestivo === true
                });
            } catch (e) {
                testsCalendario.push({
                    nombre: 'Verificar Festivo',
                    descripcion: 'Debe verificar si una fecha es festivo',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 3: Generar evento iCal
            try {
                const empleado = { id: 1, nombre: 'Juan P√©rez' };
                const resultado = IntegracionCalendario.generarEventoICal(empleado, 'ma√±ana', '2025-01-10');
                const paso = resultado.exito && resultado.iCal.includes('BEGIN:VCALENDAR');
                testsCalendario.push({
                    nombre: 'Generar Evento iCal',
                    descripcion: 'Debe generar evento iCal v√°lido',
                    resultado: `iCal generado: ${resultado.evento.summary}`,
                    paso: paso
                });
            } catch (e) {
                testsCalendario.push({
                    nombre: 'Generar Evento iCal',
                    descripcion: 'Debe generar evento iCal v√°lido',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 4: Agregar evento especial
            try {
                const resultado = IntegracionCalendario.agregarEventoEspecial(1, '2025-01-15', 'reunion', 'Reuni√≥n de equipo');
                testsCalendario.push({
                    nombre: 'Evento Especial',
                    descripcion: 'Debe agregar evento especial',
                    resultado: resultado.mensaje,
                    paso: resultado.exito
                });
            } catch (e) {
                testsCalendario.push({
                    nombre: 'Evento Especial',
                    descripcion: 'Debe agregar evento especial',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 5: Obtener eventos de empleado
            try {
                const eventos = IntegracionCalendario.obtenerEventosEmpleado(1);
                const paso = Array.isArray(eventos);
                testsCalendario.push({
                    nombre: 'Obtener Eventos',
                    descripcion: 'Debe obtener eventos de un empleado',
                    resultado: `${eventos.length} eventos encontrados`,
                    paso: paso
                });
            } catch (e) {
                testsCalendario.push({
                    nombre: 'Obtener Eventos',
                    descripcion: 'Debe obtener eventos de un empleado',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 6: Generar URL compartible
            try {
                const resultado = IntegracionCalendario.generarURLCompartible(1);
                testsCalendario.push({
                    nombre: 'URL Compartible',
                    descripcion: 'Debe generar URL compartible de calendario',
                    resultado: resultado.mensaje || resultado.url ? 'URL generada' : 'No conectado',
                    paso: true
                });
            } catch (e) {
                testsCalendario.push({
                    nombre: 'URL Compartible',
                    descripcion: 'Debe generar URL compartible de calendario',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            html += crearHTML('üìÖ IntegracionCalendario', testsCalendario);

            // ============ TEST GRUPO 3: SistemaNotificaciones ============
            const testsNotificaciones = [];

            // Test 1: Configurar preferencias
            try {
                const resultado = SistemaNotificaciones.configurarPreferencias(1, {
                    email: 'juan@example.com',
                    telefono: '650123456',
                    canales: ['push', 'email']
                });
                testsNotificaciones.push({
                    nombre: 'Configurar Preferencias',
                    descripcion: 'Debe configurar preferencias de notificaci√≥n',
                    resultado: resultado.mensaje,
                    paso: resultado.exito
                });
            } catch (e) {
                testsNotificaciones.push({
                    nombre: 'Configurar Preferencias',
                    descripcion: 'Debe configurar preferencias de notificaci√≥n',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 2: Notificar cambio de turno
            try {
                const resultado = SistemaNotificaciones.notificarCambioTurno(1, '2025-01-15', 'ma√±ana', 'tarde', 'Admin');
                testsNotificaciones.push({
                    nombre: 'Notificar Cambio',
                    descripcion: 'Debe notificar cambio de turno',
                    resultado: resultado.exito ? 'Notificaci√≥n enviada' : resultado.mensaje,
                    paso: resultado.exito
                });
            } catch (e) {
                testsNotificaciones.push({
                    nombre: 'Notificar Cambio',
                    descripcion: 'Debe notificar cambio de turno',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 3: Enviar recordatorio
            try {
                const resultado = SistemaNotificaciones.enviarRecordatorioTurno(1, '2025-01-15', 'noche', 1440);
                testsNotificaciones.push({
                    nombre: 'Recordatorio Turno',
                    descripcion: 'Debe enviar recordatorio de turno',
                    resultado: resultado.exito ? 'Recordatorio enviado' : resultado.mensaje,
                    paso: resultado.exito
                });
            } catch (e) {
                testsNotificaciones.push({
                    nombre: 'Recordatorio Turno',
                    descripcion: 'Debe enviar recordatorio de turno',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 4: Alerta de conflicto
            try {
                const resultado = SistemaNotificaciones.alertarConflicto(1, 'Exceso de turnos nocturnos', 'Se detect√≥ sobrecarga laboral');
                testsNotificaciones.push({
                    nombre: 'Alerta Conflicto',
                    descripcion: 'Debe enviar alerta de conflicto',
                    resultado: resultado.exito ? 'Alerta enviada' : resultado.mensaje,
                    paso: resultado.exito
                });
            } catch (e) {
                testsNotificaciones.push({
                    nombre: 'Alerta Conflicto',
                    descripcion: 'Debe enviar alerta de conflicto',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 5: Obtener historial
            try {
                const resultado = SistemaNotificaciones.obtenerHistorial(1);
                const paso = resultado.exito && Array.isArray(resultado.historial);
                testsNotificaciones.push({
                    nombre: 'Historial Notificaciones',
                    descripcion: 'Debe obtener historial de notificaciones',
                    resultado: `${resultado.total} notificaciones registradas`,
                    paso: paso
                });
            } catch (e) {
                testsNotificaciones.push({
                    nombre: 'Historial Notificaciones',
                    descripcion: 'Debe obtener historial de notificaciones',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 6: Validar email
            try {
                const valido = SistemaNotificaciones.validarEmail('test@example.com');
                const invalido = !SistemaNotificaciones.validarEmail('email-invalido');
                testsNotificaciones.push({
                    nombre: 'Validaci√≥n Email',
                    descripcion: 'Debe validar formato de email correctamente',
                    resultado: `Valid: ${valido}, Invalid: ${invalido}`,
                    paso: valido && invalido
                });
            } catch (e) {
                testsNotificaciones.push({
                    nombre: 'Validaci√≥n Email',
                    descripcion: 'Debe validar formato de email correctamente',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            html += crearHTML('üîî SistemaNotificaciones', testsNotificaciones);

            // ============ RESULTADOS FINALES ============
            html += `
                <div class="results">
                    <div class="stat">
                        <div class="stat-number">${testsPasados}</div>
                        <div class="stat-label">Tests Pasados</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${testsFallidos}</div>
                        <div class="stat-label">Tests Fallidos</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${testsPasados + testsFallidos}</div>
                        <div class="stat-label">Total Tests</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${Math.round((testsPasados / (testsPasados + testsFallidos)) * 100)}%</div>
                        <div class="stat-label">Tasa de √âxito</div>
                    </div>
                </div>
            `;

            document.getElementById('testResults').innerHTML = html;
        }

        // Ejecutar al cargar
        window.addEventListener('load', ejecutarTodosTests);
    </script>
</body>
</html>
