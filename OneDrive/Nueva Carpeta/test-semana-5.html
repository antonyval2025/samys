<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Semana 5 - Dashboard, Auditor√≠a y Backups</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #9b59b6 0%, #e74c3c 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        h1 { color: #333; text-align: center; border-bottom: 3px solid #9b59b6; padding-bottom: 15px; }
        .test-group {
            background: #f8f9fa;
            border-left: 5px solid #9b59b6;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .test {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .test.pass {
            border-left: 4px solid #28a745;
            background: #f0fff4;
        }
        .test.fail {
            border-left: 4px solid #dc3545;
            background: #fff5f5;
        }
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            margin-left: 10px;
        }
        .badge.pass { background: #28a745; color: white; }
        .badge.fail { background: #dc3545; color: white; }
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 10px;
        }
        .stat {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stat-number { font-size: 32px; font-weight: bold; color: #9b59b6; }
        .stat-label { color: #666; margin-top: 10px; }
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        button {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }
        button:hover { background: #8e44ad; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Semana 5: Dashboard, Auditor√≠a y Backups</h1>

        <div id="testResults"></div>

        <button onclick="ejecutarTodosTests()">‚ñ∂Ô∏è Ejecutar Todos los Tests</button>
    </div>

    <script>
        // Mock AppState para tests
        window.AppState = {
            scheduleData: new Map([
                [1, [{dia: 1, turno: 'ma√±ana', horas: 8}, {dia: 2, turno: 'tarde', horas: 8}]],
                [2, [{dia: 1, turno: 'tarde', horas: 8}, {dia: 2, turno: 'noche', horas: 8}]]
            ]),
            currentYear: 2025,
            currentMonth: 1,
            saveToStorage: function() {}
        };

        window.empleados = [
            {id: 1, nombre: 'Juan', email: 'juan@test.com'},
            {id: 2, nombre: 'Mar√≠a', email: 'maria@test.com'}
        ];

        // Mock NotificationSystem
        window.NotificationSystem = {
            show: function(msg) { console.log(msg); }
        };

        // Mock SistemaAuditoriaAvanzado
        window.SistemaAuditoriaAvanzado = {
            registrarCambio: function() { return {exito: true}; }
        };

        // Actualizar AppState con datos de prueba adicionales
        AppState.saveToStorage = function() {
            localStorage.setItem('turnosAppState', JSON.stringify({
                currentYear: this.currentYear,
                currentMonth: this.currentMonth,
                scheduleData: Array.from(this.scheduleData.entries())
            }));
        };
    </script>

    <script src="js/dashboard-avanzado-s5.js"></script>
    <script src="js/sistema-auditoria-s5.js"></script>
    <script src="js/gestor-backups-s5.js"></script>

    <script>
        // ‚úÖ CREAR VARIABLES GLOBALES PARA TESTS
        if (typeof empleados === 'undefined') {
            window.empleados = [
                { 
                    id: 1, 
                    nombre: 'Juan Garc√≠a', 
                    email: 'juan@test.com', 
                    telefono: '645123456', 
                    horasContrato: 160,
                    departamento: 'Operaciones',
                    estado: 'activo',
                    localidad: 'Madrid'
                }
            ];
        }

        if (typeof AppState === 'undefined') {
            window.AppState = {
                currentMonth: 0,
                currentYear: 2026,
                scheduleData: new Map(),
                cambiosPendientes: [],
                saveToStorage: function() { console.log('Guardado en storage'); }
            };
        }

        let testsPasados = 0;
        let testsFallidos = 0;

        function crearHTML(titulo, tests) {
            let html = `<div class="test-group"><h3>${titulo}</h3>`;
            
            tests.forEach(test => {
                const estado = test.paso ? 'pass' : 'fail';
                const icono = test.paso ? '‚úÖ' : '‚ùå';
                const badge = `<span class="badge ${estado}">${test.paso ? 'PASO' : 'FALLO'}</span>`;
                
                html += `<div class="test ${estado}">
                    <strong>${icono} ${test.nombre}</strong> ${badge}
                    <p>${test.descripcion}</p>
                    <code>${test.resultado}</code>
                </div>`;
                
                if (test.paso) testsPasados++;
                else testsFallidos++;
            });
            
            html += '</div>';
            return html;
        }

        async function ejecutarTodosTests() {
            testsPasados = 0;
            testsFallidos = 0;

            let html = '';

            // ============ TEST GRUPO 1: DashboardAvanzado ============
            const testsDashboard = [];

            // Test 1: Calcular KPIs
            try {
                const resultado = DashboardAvanzado.calcularKPIs(1, 2025);
                const paso = resultado.exito && resultado.kpis.totalEmpleados > 0;
                testsDashboard.push({
                    nombre: 'Calcular KPIs',
                    descripcion: 'Debe calcular KPIs principales del mes',
                    resultado: `${resultado.kpis.totalEmpleados} empleados, ${resultado.kpis.totalTurnos} turnos`,
                    paso: paso
                });
            } catch (e) {
                testsDashboard.push({
                    nombre: 'Calcular KPIs',
                    descripcion: 'Debe calcular KPIs principales del mes',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 2: Generar gr√°fico
            try {
                const resultado = DashboardAvanzado.generarGraficoDistribucion(1, 2025);
                const paso = resultado.exito && resultado.grafico.datos.length > 0;
                testsDashboard.push({
                    nombre: 'Generar Gr√°fico',
                    descripcion: 'Debe generar datos para gr√°ficos',
                    resultado: `${resultado.grafico.labels.length} tipos de turno`,
                    paso: paso
                });
            } catch (e) {
                testsDashboard.push({
                    nombre: 'Generar Gr√°fico',
                    descripcion: 'Debe generar datos para gr√°ficos',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 3: Analizar empleado
            try {
                const resultado = DashboardAvanzado.analizarEmpleado(1, 1, 2025);
                const paso = resultado.exito && resultado.analisis.empleadoId === 1;
                testsDashboard.push({
                    nombre: 'Analizar Empleado',
                    descripcion: 'Debe analizar datos de un empleado',
                    resultado: `${resultado.analisis.totalTurnos} turnos, ${resultado.analisis.totalHoras} horas`,
                    paso: paso
                });
            } catch (e) {
                testsDashboard.push({
                    nombre: 'Analizar Empleado',
                    descripcion: 'Debe analizar datos de un empleado',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 4: Generar reporte ejecutivo
            try {
                const resultado = DashboardAvanzado.generarReporteEjecutivo(1, 2025);
                const paso = resultado.exito && resultado.html.includes('DOCTYPE');
                testsDashboard.push({
                    nombre: 'Reporte Ejecutivo',
                    descripcion: 'Debe generar reporte HTML ejecutivo',
                    resultado: `${resultado.nombreArchivo}`,
                    paso: paso
                });
            } catch (e) {
                testsDashboard.push({
                    nombre: 'Reporte Ejecutivo',
                    descripcion: 'Debe generar reporte HTML ejecutivo',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 5: Calcular √≠ndice equidad
            try {
                const turnos = DashboardAvanzado.obtenerTurnosMes(1, 2025);
                const indice = DashboardAvanzado.calcularIndiceEquidad(turnos, []);
                testsDashboard.push({
                    nombre: '√çndice Equidad',
                    descripcion: 'Debe calcular √≠ndice de equidad (Gini)',
                    resultado: `√çndice: ${indice}`,
                    paso: typeof indice === 'number'
                });
            } catch (e) {
                testsDashboard.push({
                    nombre: '√çndice Equidad',
                    descripcion: 'Debe calcular √≠ndice de equidad (Gini)',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 6: Estimar costo laboral
            try {
                const turnos = DashboardAvanzado.obtenerTurnosMes(1, 2025);
                const costo = DashboardAvanzado.estimarCostoLaboral(turnos);
                testsDashboard.push({
                    nombre: 'Costo Laboral',
                    descripcion: 'Debe estimar costo laboral mensual',
                    resultado: `‚Ç¨${costo.toLocaleString('es-ES')}`,
                    paso: costo >= 0
                });
            } catch (e) {
                testsDashboard.push({
                    nombre: 'Costo Laboral',
                    descripcion: 'Debe estimar costo laboral mensual',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            html += crearHTML('üìä DashboardAvanzado', testsDashboard);

            // ============ TEST GRUPO 2: SistemaAuditoriaAvanzado ============
            const testsAuditoria = [];

            // Test 1: Registrar cambio
            try {
                const resultado = SistemaAuditoriaAvanzado.registrarCambio('turno', 'editar', 
                    {turno: 'ma√±ana'}, {turno: 'tarde'}, 'admin', 'Cambio de turno');
                testsAuditoria.push({
                    nombre: 'Registrar Cambio',
                    descripcion: 'Debe registrar cambio en auditor√≠a',
                    resultado: `Registro ID: ${resultado.id}`,
                    paso: resultado.exito && resultado.id
                });
            } catch (e) {
                testsAuditoria.push({
                    nombre: 'Registrar Cambio',
                    descripcion: 'Debe registrar cambio en auditor√≠a',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 2: Obtener historial
            try {
                const resultado = SistemaAuditoriaAvanzado.obtenerHistorial();
                const paso = resultado.exito && Array.isArray(resultado.registros);
                testsAuditoria.push({
                    nombre: 'Obtener Historial',
                    descripcion: 'Debe obtener historial de auditor√≠a',
                    resultado: `${resultado.total} registros`,
                    paso: paso
                });
            } catch (e) {
                testsAuditoria.push({
                    nombre: 'Obtener Historial',
                    descripcion: 'Debe obtener historial de auditor√≠a',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 3: Analizar actividad usuario
            try {
                SistemaAuditoriaAvanzado.registrarCambio('test', 'crear', {}, {}, 'testuser');
                const resultado = SistemaAuditoriaAvanzado.analizarActividadUsuario('testuser');
                const paso = resultado.exito && resultado.estadisticas.totalOperaciones > 0;
                testsAuditoria.push({
                    nombre: 'Analizar Usuario',
                    descripcion: 'Debe analizar actividad por usuario',
                    resultado: `${resultado.estadisticas.totalOperaciones} operaciones`,
                    paso: paso
                });
            } catch (e) {
                testsAuditoria.push({
                    nombre: 'Analizar Usuario',
                    descripcion: 'Debe analizar actividad por usuario',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 4: Detectar actividades sospechosas
            try {
                const resultado = SistemaAuditoriaAvanzado.detectarActividadesSospechosas();
                const paso = resultado.exito;
                testsAuditoria.push({
                    nombre: 'Detectar Sospechosas',
                    descripcion: 'Debe detectar actividades sospechosas',
                    resultado: `${resultado.sospechosas.length} alertas`,
                    paso: paso
                });
            } catch (e) {
                testsAuditoria.push({
                    nombre: 'Detectar Sospechosas',
                    descripcion: 'Debe detectar actividades sospechosas',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 5: Generar reporte auditor√≠a
            try {
                const resultado = SistemaAuditoriaAvanzado.generarReporteAuditoria('2025-01-01', '2025-01-31');
                const paso = resultado.exito && resultado.html.includes('REPORTE');
                testsAuditoria.push({
                    nombre: 'Reporte Auditor√≠a',
                    descripcion: 'Debe generar reporte de auditor√≠a',
                    resultado: `${resultado.nombreArchivo}`,
                    paso: paso
                });
            } catch (e) {
                testsAuditoria.push({
                    nombre: 'Reporte Auditor√≠a',
                    descripcion: 'Debe generar reporte de auditor√≠a',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 6: Limpiar registros antiguos
            try {
                const resultado = SistemaAuditoriaAvanzado.limpiarRegistrosAntiguos(365);
                testsAuditoria.push({
                    nombre: 'Limpiar Antiguos',
                    descripcion: 'Debe limpiar registros antiguos',
                    resultado: resultado.mensaje,
                    paso: resultado.exito
                });
            } catch (e) {
                testsAuditoria.push({
                    nombre: 'Limpiar Antiguos',
                    descripcion: 'Debe limpiar registros antiguos',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            html += crearHTML('üîí SistemaAuditoriaAvanzado', testsAuditoria);

            // ============ TEST GRUPO 3: GestorBackups ============
            const testsBackups = [];

            // Test 1: Crear backup
            try {
                const resultado = GestorBackups.crearBackup('Test Backup', 'manual');
                testsBackups.push({
                    nombre: 'Crear Backup',
                    descripcion: 'Debe crear backup de datos',
                    resultado: `${resultado.backupId} - ${resultado.tama√±o}`,
                    paso: resultado.exito && resultado.backupId
                });
            } catch (e) {
                testsBackups.push({
                    nombre: 'Crear Backup',
                    descripcion: 'Debe crear backup de datos',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 2: Obtener backups
            try {
                const resultado = GestorBackups.obtenerBackups();
                const paso = resultado.exito && Array.isArray(resultado.backups);
                testsBackups.push({
                    nombre: 'Obtener Backups',
                    descripcion: 'Debe obtener lista de backups',
                    resultado: `${resultado.total} backups`,
                    paso: paso
                });
            } catch (e) {
                testsBackups.push({
                    nombre: 'Obtener Backups',
                    descripcion: 'Debe obtener lista de backups',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 3: Validar integridad
            try {
                const resultado = GestorBackups.validarIntegridad();
                const paso = resultado.exito;
                testsBackups.push({
                    nombre: 'Validar Integridad',
                    descripcion: 'Debe validar integridad de backups',
                    resultado: `${resultado.validos} v√°lidos, ${resultado.invalidos} inv√°lidos`,
                    paso: paso
                });
            } catch (e) {
                testsBackups.push({
                    nombre: 'Validar Integridad',
                    descripcion: 'Debe validar integridad de backups',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 4: Calcular checksum
            try {
                const datos = 'test data';
                const checksum = GestorBackups.calcularChecksum(datos);
                const paso = typeof checksum === 'string' && checksum.length > 0;
                testsBackups.push({
                    nombre: 'Checksum',
                    descripcion: 'Debe calcular checksum de datos',
                    resultado: `Checksum: ${checksum}`,
                    paso: paso
                });
            } catch (e) {
                testsBackups.push({
                    nombre: 'Checksum',
                    descripcion: 'Debe calcular checksum de datos',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 5: Comprimir/Descomprimir
            try {
                const datos = 'test backup data';
                const comprimido = GestorBackups.comprimirDatos(datos);
                const descomprimido = GestorBackups.descomprimirDatos(comprimido);
                const paso = descomprimido === datos;
                testsBackups.push({
                    nombre: 'Comprimir Datos',
                    descripcion: 'Debe comprimir y descomprimir datos',
                    resultado: `Original: ${datos.length}B, Comprimido: ${comprimido.length}B`,
                    paso: paso
                });
            } catch (e) {
                testsBackups.push({
                    nombre: 'Comprimir Datos',
                    descripcion: 'Debe comprimir y descomprimir datos',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            // Test 6: Limpiar antiguos
            try {
                const resultado = GestorBackups.limpiarAntiguos(30);
                testsBackups.push({
                    nombre: 'Limpiar Antiguos',
                    descripcion: 'Debe limpiar backups antiguos',
                    resultado: resultado.mensaje,
                    paso: resultado.exito
                });
            } catch (e) {
                testsBackups.push({
                    nombre: 'Limpiar Antiguos',
                    descripcion: 'Debe limpiar backups antiguos',
                    resultado: `Error: ${e.message}`,
                    paso: false
                });
            }

            html += crearHTML('üíæ GestorBackups', testsBackups);

            // ============ RESULTADOS FINALES ============
            html += `
                <div class="results">
                    <div class="stat">
                        <div class="stat-number">${testsPasados}</div>
                        <div class="stat-label">Tests Pasados</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${testsFallidos}</div>
                        <div class="stat-label">Tests Fallidos</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${testsPasados + testsFallidos}</div>
                        <div class="stat-label">Total Tests</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${Math.round((testsPasados / (testsPasados + testsFallidos)) * 100)}%</div>
                        <div class="stat-label">Tasa de √âxito</div>
                    </div>
                </div>
            `;

            document.getElementById('testResults').innerHTML = html;
        }

        // Ejecutar al cargar
        window.addEventListener('load', ejecutarTodosTests);
    </script>
</body>
</html>
