ex<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light">
    <meta name="supported-color-schemes" content="light">
    <title>Sistema de Gesti√≥n de Turnos - Cuadrantes Mensuales</title>
    <script>
        // Capturar errores antes que nada
        window.addEventListener('error', function(e) {
            console.error('ERROR UNCAUGHT:', e.message, 'en', e.filename, ':', e.lineno);
            document.body.innerHTML = `
                <div style="padding: 20px; background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; border-radius: 5px;">
                    <h2>‚ùå ERROR CR√çTICO EN JAVASCRIPT</h2>
                    <p><strong>Mensaje:</strong> ${e.message}</p>
                    <p><strong>Archivo:</strong> ${e.filename}</p>
                    <p><strong>L√≠nea:</strong> ${e.lineno}</p>
                    <p><strong>Stack:</strong> <pre>${e.error?.stack || 'No disponible'}</pre></p>
                </div>
            `;
        });
        
        // ‚≠ê CONFIGURAR MES/A√ëO ACTUAL INMEDIATAMENTE (sin parpadeos)
        window.__initialMonth = new Date().getMonth();
        window.__initialYear = new Date().getFullYear();
        
        // ‚≠ê VALIDAR DATOS EN LOCALSTORAGE - SOLO LIMPIAR SI EST√ÅN CORRUPTOS
        try {
            const dataGuardada = localStorage.getItem('turnosAppState');
            if (dataGuardada) {
                try {
                    const savedState = JSON.parse(dataGuardada);
                    // Verificar integridad, NO limpiar solo por a√±o
                    if (savedState && (savedState.scheduleData || savedState.currentMonth !== undefined)) {
                        console.log('‚úì localStorage v√°lido, datos restaurados');
                    }
                } catch (parseErr) {
                    // Si est√° corrupto (error JSON), limpiar
                    console.warn('‚ö†Ô∏è localStorage corrupto, limpiando...');
                    localStorage.clear();
                }
            }
        } catch (err) {
            console.error('‚ùå Error validando localStorage:', err);
        }
        
        // ‚≠ê INICIALIZAR VARIABLES GLOBALES
        if (!window.empleados) {
            window.empleados = [];
        }
    </script>
    <!-- Librer√≠as Externas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Script de monitoreo -->
    <script src="monitoreo_edicion.js"></script>

    <!-- Estilos -->
    <link rel="stylesheet" href="css/estilos_pastel4.css?v=20251214_corp1">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/modales.css">
    <!-- Mejoras visuales sutiles (NO rompe layout) -->
    <link rel="stylesheet" href="css/mejoras_visuales_v2_1.css">
        <style>
            /* Overrides pastel for cache-safe load y evitar temas oscuros cacheados */
            :root { color-scheme: light; }
            body { background: radial-gradient(circle at 15% 20%, #0f172a 0%, #0b1220 40%, #0a0f1c 80%) !important; color: #e5e7eb !important; }
            .container { background: transparent !important; }
            .monthly-schedule-container { background: linear-gradient(180deg, rgba(18,27,45,0.96) 0%, rgba(12,19,33,0.96) 100%) !important; }
            .main-content { background: linear-gradient(160deg, rgba(15,23,42,0.96), rgba(11,18,32,0.96)) !important; }
            header { background: linear-gradient(135deg, #111827 0%, #0b1220 100%) !important; color: #e5e7eb !important; }
            .monthly-header, .calendario-header { background: linear-gradient(135deg, #111827 0%, #0b1220 100%) !important; color: #e2e8f0 !important; }
            .tabs, .legend, .stat-card { background: #0b1220 !important; }
            .monthly-table { border-collapse: separate !important; border-spacing: 8px !important; background: transparent !important; }
            .monthly-table th, .monthly-table th:first-child { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%) !important; color: white !important; padding: 14px 12px !important; font-weight: 700 !important; text-align: center !important; border-radius: 8px !important; box-shadow: 0 0 20px rgba(249, 115, 22, 0.4) !important; }
            .monthly-table td { background: linear-gradient(135deg, rgba(14, 165, 233, 0.08) 0%, rgba(6, 182, 212, 0.06) 100%) !important; color: #0f172a !important; border: 2px solid rgba(14, 165, 233, 0.2) !important; border-radius: 10px !important; padding: 12px 10px !important; text-align: center !important; font-weight: 500 !important; transition: all 0.3s ease !important; }
            .monthly-table td:hover { background: linear-gradient(135deg, rgba(14, 165, 233, 0.15) 0%, rgba(6, 182, 212, 0.12) 100%) !important; border-color: rgba(14, 165, 233, 0.4) !important; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15) !important; transform: translateY(-2px) !important; }
            .monthly-table .employee-name-cell { background: linear-gradient(135deg, #0f172a 0%, #1a1f35 100%) !important; color: #e5e7eb !important; font-weight: 700 !important; border: 2px solid rgba(14, 165, 233, 0.15) !important; border-radius: 10px !important; }
            .monthly-table .employee-name-cell:hover { background: linear-gradient(135deg, #1a1f35 0%, #252d42 100%) !important; border-color: rgba(14, 165, 233, 0.3) !important; }
            header { transition: all 0.3s ease !important; }
            header:hover { box-shadow: 0 0 40px rgba(168, 85, 247, 1), 0 0 80px rgba(147, 51, 234, 0.8), 0 4px 30px rgba(168, 85, 247, 0.9) !important; }
            .tab-btn { color: white !important; border: 2px solid transparent !important; transition: all 0.3s ease !important; }
            .tab-btn.active { border-bottom: 3px solid #22c55e !important; }
            [data-tab="tab-general"] { background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%) !important; }
            [data-tab="tab-general"]:hover { box-shadow: 0 0 30px rgba(74, 222, 128, 1), 0 0 50px rgba(34, 197, 94, 0.9), 0 4px 20px rgba(74, 222, 128, 0.9) !important; }
            [data-tab="tab-individual"] { background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%) !important; }
            [data-tab="tab-individual"]:hover { box-shadow: 0 0 30px rgba(30, 64, 175, 1), 0 0 50px rgba(30, 58, 138, 0.9), 0 4px 20px rgba(30, 64, 175, 0.9) !important; }
            .nav-btn, .action-btn, .edit-btn, .modal-btn { font-size: 14px !important; }
            .edit-btn.save, .modal-btn.apply { background: #22c55e !important; color: #0b1220 !important; }
            .edit-btn.cancel, .modal-btn.cancel { background: #ef4444 !important; color: #0b1220 !important; }
            .notification { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%) !important; color: white !important; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8) !important; }
            .notification.success { background: #22c55e !important; color: #0b1220 !important; }
            .notification.error { background: #ef4444 !important; color: #0b1220 !important; }
            .notification.warning { background: #f59e0b !important; color: #0b1220 !important; }
            .notification.info { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%) !important; color: white !important; }
            .modal-select, .turno-selector { border-color: #ddd !important; background: white !important; color: #1a1a1a !important; }
            #masiva_empleado, #masiva_desde, #masiva_hasta, #masiva_turno { border-color: #ddd !important; background: white !important; color: #1a1a1a !important; }
            #masiva_empleado option, #masiva_desde option, #masiva_hasta option, #masiva_turno option { background: white !important; color: #1a1a1a !important; }
            .calendario-btn-vista { background: #f1f5f9 !important; color: #475569 !important; border: 2px solid #e2e8f0 !important; transition: all 0.3s ease !important; }
            .calendario-btn-vista:hover { background: #e2e8f0 !important; border-color: #cbd5e1 !important; }
            .calendario-btn-vista.active { background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%) !important; border: none !important; color: white !important; box-shadow: 0 0 20px rgba(139, 92, 246, 0.4) !important; }
            .dia-calendario { background: #0f172a !important; color: #e2e8f0 !important; }
            .dia-calendario.hoy { background: rgba(34,197,94,0.15) !important; border: 2px solid #22c55e !important; }
            .dia-calendario.conflicto { background: rgba(239,68,68,0.12) !important; border: 2px solid rgba(239,68,68,0.5) !important; box-shadow: 0 0 10px rgba(239,68,68,0.3) !important; }
            .carga-baja { background: rgba(34,197,94,0.15) !important; }
            .carga-media { background: rgba(245,158,11,0.18) !important; }
            .carga-alta { background: rgba(239,68,68,0.18) !important; }
            .turno.ma√±ana { background: rgba(34,197,94,0.18) !important; color: #16a34a !important; }
            .turno.tarde { background: rgba(249, 115, 22, 0.18) !important; color: #f97316 !important; }
            .turno.noche { background: rgba(59,130,246,0.2) !important; color: #1d4ed8 !important; }
            .turno.mixto { background: rgba(249, 115, 22, 0.15) !important; color: #f97316 !important; }
            .turno.descanso { background: rgba(148,163,184,0.2) !important; color: #e2e8f0 !important; }
            .turno.vacaciones { background: rgba(249, 115, 22, 0.18) !important; color: #f97316 !important; }
            .turno.baja { background: rgba(239,68,68,0.18) !important; color: #ef4444 !important; }
            .turno.festivo { background: rgba(250,204,21,0.18) !important; color: #ca8a04 !important; }
            .turno.libre { background: rgba(148,163,184,0.15) !important; color: #e2e8f0 !important; }
            .employee-name-cell { background: #0f172a !important; color: #e5e7eb !important; }
            .monthly-header h2, .month-title { color: #e2e8f0 !important; }
            /* Bot√≥n Seleccionar Rango - efecto hover moderado */
            .edit-btn.bulk { box-shadow: 0 2px 8px rgba(37, 99, 235, 0.25) !important; transition: all 0.3s ease !important; }
            .edit-btn.bulk:hover { box-shadow: 0 4px 16px rgba(59, 130, 246, 0.45), 0 0 20px rgba(59, 130, 246, 0.3) !important; }
        </style>
    
    <!-- Fallback: estilos m√≠nimos si CSS externo no carga -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0e4d9 0%, #e8d9f0 100%);
            min-height: 100vh;
            color: #5a5a5a;
        }
        
        /* Modal fijo: inicialmente no visible */
        .modal {
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s ease !important;
            background: rgba(0, 0, 0, 0) !important;
        }
        
        /* Modal visible cuando tiene clase 'active' */
        .modal.active {
            visibility: visible;
            opacity: 1;
            background: rgba(0, 0, 0, 0.5) !important;
        }
        
        /* ‚ú® ANIMACIONES PARA NOTIFICACIONES MEJORADAS */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        @keyframes progress {
            from {
                width: 100%;
            }
            to {
                width: 0%;
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .notificacion {
            transition: all 0.3s ease !important;
        }
        
        .notificacion:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4) !important;
        }
        
        /* Estilos cargados desde css/estilos.css - fallback m√≠nimo aqu√≠ */
    </style>

    <!-- ‚úÖ INICIALIZACI√ìN TEMPRANA DE TURNOMANAGER Y NOTIFICATIONSYSTEM -->
    <script>
        console.log('üü¢ [HEAD] Script de inicializaci√≥n temprana ejecut√°ndose...');
        
        // ‚úÖ CREAR PLACEHOLDER PARA NOTIFICATIONSYSTEM (disponible inmediatamente)
        if (!window.NotificationSystem) {
            window.NotificationSystem = {
                historial: [],
                maxHistorial: 50,
                contadorID: 0,
                grupos: new Map(),
                posicion: 'top-right',
                sonidosActivados: true,
                
                show: function(msg, tipo, dur, opciones) {
                    console.log(`[Notif ${tipo}] ${msg}`);
                    // Agregar al historial
                    this.historial.unshift({
                        id: this.contadorID++,
                        mensaje: msg,
                        tipo: tipo,
                        timestamp: new Date().toLocaleTimeString('es-ES')
                    });
                    if (this.historial.length > this.maxHistorial) {
                        this.historial.pop();
                    }
                    
                    // Crear elemento visual si opciones est√° disponible
                    if (opciones && opciones.callback) {
                        setTimeout(() => opciones.callback('cerrar'), dur || 3000);
                    }
                },
                
                mostrarHistorial: function() {
                    console.table(this.historial);
                    return this.historial;
                },
                
                limpiarHistorial: function() {
                    this.historial = [];
                    console.log('‚úÖ Historial limpiado');
                },
                
                cerrarNotificacion: function(elemento) {
                    if (elemento && elemento.remove) {
                        elemento.remove();
                    }
                },
                
                activarSonidos: function() {
                    this.sonidosActivados = true;
                    console.log('üîä Sonidos activados');
                },
                
                desactivarSonidos: function() {
                    this.sonidosActivados = false;
                    console.log('üîá Sonidos desactivados');
                },
                
                cambiarPosicion: function(pos) {
                    this.posicion = pos;
                    console.log(`üéØ Posici√≥n: ${pos}`);
                },
                
                reproducirSonido: function() {
                    // Placeholder - ser√° reemplazado
                }
            };
            console.log('‚úÖ [HEAD] Placeholder NotificationSystem completo creado');
        }
        
        // ‚úÖ CREAR PLACEHOLDER PARA EVITAR ERRORES ANTES QUE SE CARGUE modules.js
        // Las funciones REALES est√°n en js/modules.js como clase TurnoManager est√°tica
        // Este es solo un placeholder que ser√° sobrescrito cuando modules.js se cargue
        
        if (!window.TurnoManager) {
            window.TurnoManager = {};
            console.log('‚úÖ [HEAD] Placeholder TurnoManager creado (ser√° reemplazado por modules.js)');
        }
        
        // Helper para esperar a que la funci√≥n real est√© disponible
        function esperarFuncion(nombreFuncion, maxTiempoMs = 3000) {
            return new Promise((resolve) => {
                let tiempoIntentado = 0;
                const intervalo = setInterval(() => {
                    tiempoIntentado += 50;
                    if (typeof window.TurnoManager[nombreFuncion] === 'function' && 
                        window.TurnoManager[nombreFuncion].toString().indexOf('placeholder') === -1) {
                        clearInterval(intervalo);
                        resolve(true);
                    }
                    if (tiempoIntentado >= maxTiempoMs) {
                        clearInterval(intervalo);
                        console.error(`‚ùå Timeout esperando ${nombreFuncion}`);
                        resolve(false);
                    }
                }, 50);
            });
        }
        
        // Escuchar evento global de m√≥dulos listos
        window.addEventListener('TurnoManagerReady', function() {
            console.log('‚úÖ [HEAD] Evento TurnoManagerReady recibido - m√≥dulos cargados');
        });
        
        // ‚úÖ INICIALIZAR MODULE MANAGER TEMPRANO
        if (typeof window.ModuleManager === 'undefined') {
            window.ModuleManager = {
                modules: {},
                
                register: function(name, module) {
                    this.modules[name] = module;
                    console.log(`‚úÖ M√≥dulo registrado: ${name}`);
                    return this;
                },
                
                get: function(name) {
                    const module = this.modules[name];
                    if (!module) {
                        console.warn(`‚ö†Ô∏è M√≥dulo "${name}" no encontrado`);
                        return null;
                    }
                    return module;
                },
                
                list: function() {
                    console.table(Object.keys(this.modules));
                },
                
                loadAll: function() {
                    console.log('üì¶ M√≥dulos cargados:', Object.keys(this.modules).length);
                    return this.modules;
                },
                
                verificar: function(requiredModules = []) {
                    const missing = requiredModules.filter(name => !this.modules[name]);
                    if (missing.length > 0) {
                        console.warn(`‚ö†Ô∏è M√≥dulos faltantes:`, missing);
                        return false;
                    }
                    console.log(`‚úÖ Todos los m√≥dulos requeridos est√°n cargados`);
                    return true;
                }
            };
            console.log('üéõÔ∏è ModuleManager inicializado en HEAD');
        }
        
        // ‚úÖ CARGAR NOTIFICATIONSYSTEM COMPLETO INMEDIATAMENTE
        console.log('üîÑ [HEAD] Inicializando NotificationSystem completo...');
        
        // Reemplazar el placeholder con la versi√≥n completa
        setTimeout(() => {
            if (window.NotificationSystem && !window.NotificationSystem.reproducirSonido) {
                console.log('‚è≥ Cargando versi√≥n completa de NotificationSystem...');
                
                // Se sobrescribir√° cuando el script principal cargue
                // Por ahora, agregar m√©todo b√°sico que funcione
                window.NotificationSystem.cerrarNotificacion = function(n) {
                    if (n && n.remove) n.remove();
                };
            }
        }, 100);
    </script>
    
    <!-- ‚úÖ CARGAR NOTIFICATIONSYSTEM MEJORADO EN BACKGROUND -->
    <script async>
        // Este script cargar√° el NotificationSystem en cuanto est√© disponible
        window.addEventListener('load', function() {
            console.log('‚úÖ [LOAD EVENT] P√°gina completamente cargada');
            console.log('‚úÖ NotificationSystem disponible:', typeof window.NotificationSystem === 'object');
        });
        
        
        // Placeholder para mostrarModalGeneracion - ser√° reemplazado por la clase en modules.js
        if (!window.TurnoManager.mostrarModalGeneracion) {
            window.TurnoManager.mostrarModalGeneracion = function() {
                console.warn('‚ö†Ô∏è [mostrarModalGeneracion] Placeholder ejecutado - esperando a que modules.js cargue la funci√≥n real...');
                // Esperar a que modules.js defina la funci√≥n real
                let intentos = 0;
                const intervalo = setInterval(() => {
                    intentos++;
                    // Verificar si la funci√≥n real se ha cargado (debe ser una clase/method, no un placeholder)
                    if (typeof window.TurnoManager.mostrarModalGeneracion === 'function' && 
                        window.TurnoManager.mostrarModalGeneracion.constructor.name !== 'Function' ||
                        (window.TurnoManager.mostrarModalGeneracion.toString && 
                         window.TurnoManager.mostrarModalGeneracion.toString().includes('modalGenerarTurnos'))) {
                        clearInterval(intervalo);
                        console.log('‚úÖ [mostrarModalGeneracion] Funci√≥n real cargada, ejecutando...');
                        window.TurnoManager.mostrarModalGeneracion();
                        return;
                    }
                    // Timeout despu√©s de 60 intentos (3 segundos)
                    if (intentos > 60) {
                        clearInterval(intervalo);
                        console.error('‚ùå [mostrarModalGeneracion] Timeout - modules.js no carg√≥ la funci√≥n real');
                    }
                }, 50);
            };
        }
        
        // Placeholder para cargarTurnosPorDefecto
        if (!window.TurnoManager.cargarTurnosPorDefecto) {
            window.TurnoManager.cargarTurnosPorDefecto = function() {
                console.warn('‚ö†Ô∏è [cargarTurnosPorDefecto] Placeholder ejecutado - modules.js carg√°ndose...');
                esperarFuncion('cargarTurnosPorDefecto').then(disponible => {
                    if (disponible && typeof window.TurnoManager.cargarTurnosPorDefecto === 'function') {
                        console.log('‚úÖ [cargarTurnosPorDefecto] Funci√≥n real ahora disponible, ejecutando...');
                        window.TurnoManager.cargarTurnosPorDefecto();
                    }
                });
            };
        }
    </script>

</head>
<body style="background: radial-gradient(circle at 15% 20%, #0f172a 0%, #0b1220 40%, #0a0f1c 80%);">
    <!-- SIDEBAR CON CONTROLES SEMANA 1-2-3 -->
    <div id="sidebar-container" class="sidebar-container">
        <div class="sidebar-header">
            <h2 class="sidebar-title">üéõÔ∏è Control Panel</h2>
        </div>
        
        <!-- SEMANA 1: VALIDACI√ìN Y SINCRONIZACI√ìN -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">Validaci√≥n</h3>
            <button class="sidebar-btn semana1" onclick="abrirValidacion()">
                <span class="sidebar-btn-icon">‚úÖ</span>
                <span class="sidebar-btn-text">Validar Datos</span>
            </button>
            <button class="sidebar-btn semana1" onclick="abrirAutoGuardado()">
                <span class="sidebar-btn-icon">üíæ</span>
                <span class="sidebar-btn-text">Auto-guardado</span>
            </button>
        </div>
        
        <!-- SINCRONIZACI√ìN -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">Sincronizaci√≥n</h3>
            <button class="sidebar-btn semana1" onclick="abrirSincronizacion()">
                <span class="sidebar-btn-icon">üîÑ</span>
                <span class="sidebar-btn-text">Multi-Tab Sync</span>
            </button>
        </div>

        <!-- GENERACI√ìN DE TURNOS -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">Generaci√≥n</h3>
            <button class="sidebar-btn semana1" onclick="TurnoManager.generarTurnos()" title="Carga los turnos principales de cada empleado para el mes actual">
                <span class="sidebar-btn-icon">üìã</span>
                <span class="sidebar-btn-text">Cargar Por Defecto</span>
            </button>
        </div>
        
        <!-- SEMANA 2: REPORTES E INTEGRACI√ìN -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">Reportes</h3>
            <button class="sidebar-btn semana2" onclick="abrirReportes()">
                <span class="sidebar-btn-icon">üìã</span>
                <span class="sidebar-btn-text">Generador</span>
            </button>
            <button class="sidebar-btn semana2" onclick="abrirBackup()">
                <span class="sidebar-btn-icon">üíæ</span>
                <span class="sidebar-btn-text">Backup</span>
            </button>
        </div>
        
        <!-- COMUNICACI√ìN -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">Comunicaci√≥n</h3>
            <button class="sidebar-btn semana2" onclick="abrirWhatsApp()">
                <span class="sidebar-btn-icon">üí¨</span>
                <span class="sidebar-btn-text">WhatsApp</span>
            </button>
        </div>
        
        <!-- SEMANA 3: ANAL√çTICA Y OPTIMIZACI√ìN -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">An√°lisis</h3>
            <button class="sidebar-btn semana3" onclick="ModuleManager.get('SidebarSemana3Module').abrirAnalisis()">
                <span class="sidebar-btn-icon">üö®</span>
                <span class="sidebar-btn-text">Conflictos</span>
            </button>
            <button class="sidebar-btn semana3" onclick="ModuleManager.get('SidebarSemana3Module').abrirMetricas()">
                <span class="sidebar-btn-icon">üìä</span>
                <span class="sidebar-btn-text">M√©tricas</span>
            </button>
        </div>
        
        <!-- OPTIMIZACI√ìN -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">Mejora</h3>
            <button class="sidebar-btn semana3" onclick="ModuleManager.get('SidebarSemana3Module').abrirOptimizacion()">
                <span class="sidebar-btn-icon">‚ö°</span>
                <span class="sidebar-btn-text">Sugerencias</span>
            </button>
        </div>
    </div>
    
    <!-- MAIN CONTENT -->
    <div class="main-content">
    <div class="container">
        <header style="background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); padding: 30px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 0 30px rgba(168, 85, 247, 0.8), 0 0 60px rgba(147, 51, 234, 0.6), 0 4px 20px rgba(168, 85, 247, 0.7);">
            <h1>üìä Sistema de Gesti√≥n de Turnos - Cuadrantes Mensuales</h1>
            <p class="subtitle">Cuadrantes individuales y generales con edici√≥n en tiempo real</p>
            <div style="margin-top: 6px; font-size: 13px; color: #e9d5ff;">Build pastel override v20251214-2</div>
        </header>

        <div class="top-controls">
            <div class="period-selector">
                <select id="selectYear" class="period-select">
                    <option value="2023">2023</option>
                    <option value="2024" selected>2024</option>
                    <option value="2025">2025</option>
                </select>
                <select id="selectMonth" class="period-select">
                    <option value="0">Enero</option>
                    <option value="1">Febrero</option>
                    <option value="2">Marzo</option>
                    <option value="3">Abril</option>
                    <option value="4">Mayo</option>
                    <option value="5">Junio</option>
                    <option value="6">Julio</option>
                    <option value="7">Agosto</option>
                    <option value="8">Septiembre</option>
                    <option value="9">Octubre</option>
                    <option value="10">Noviembre</option>
                    <option value="11">Diciembre</option>
                </select>
                <button class="nav-btn" onclick="DateUtils.cambiarMes(-1)">‚óÄ</button>
                <button class="nav-btn" onclick="DateUtils.cambiarMes(1)">‚ñ∂</button>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="action-btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); color: white; box-shadow: 0 2px 5px rgba(139, 92, 246, 0.2);" onclick="EmployeeManager.abrirModal()">üë• Empleados</button>
                <button class="action-btn" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; box-shadow: 0 2px 5px rgba(6, 182, 212, 0.2);" onclick="ConsolidadoDepartamentos.abrirModal()">üè¢ Departamentos</button>
                <button class="action-btn" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white; box-shadow: 0 2px 5px rgba(236, 72, 153, 0.2);" onclick="ConsolidadoLocalidades.abrirModal()">üìç Localidades</button>
                <button class="action-btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; box-shadow: 0 2px 5px rgba(245, 158, 11, 0.2);" onclick="ConsolidadoTurnos.abrirModal()">‚è∞ Turnos</button>
                <button class="action-btn" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; box-shadow: 0 2px 5px rgba(99, 102, 241, 0.2);" onclick="ChatBot.abrirModal()">ü§ñ Chat</button>
                <!-- Bot√≥n Generar Turnos - Solo visible cuando cuadrante est√° vac√≠o -->
                <button id="btnGenerarTurnos" class="action-btn" style="display: block !important; z-index: 9999; position: relative; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); animation: pulse 2s infinite; padding: 12px 20px; font-weight: bold; font-size: 16px; border: 2px solid #047857;" onclick="(function() { if (typeof window.TurnoManager?.mostrarModalGeneracion === 'function') { window.TurnoManager.mostrarModalGeneracion(); } else { console.warn('‚è≥ Esperando a que TurnoManager cargue...'); let intentos = 0; const esperar = setInterval(() => { if (typeof window.TurnoManager?.mostrarModalGeneracion === 'function') { clearInterval(esperar); window.TurnoManager.mostrarModalGeneracion(); } else if (++intentos > 60) { clearInterval(esperar); console.error('‚ùå Timeout'); alert('Error: m√≥dulos no cargaron. Recarga la p√°gina'); } }, 100); } })()">üìã GENERAR TURNOS</button>
            </div>
        </div>

        <div class="tabs" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-bottom: 3px solid #f97316; padding: 0; display: flex; gap: 0; box-shadow: 0 2px 8px rgba(249, 115, 22, 0.15);">
            <button class="tab-btn active" data-tab="tab-general" style="border-radius: 0; margin: 0; flex: 1; background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); color: white; font-weight: bold; padding: 10px 16px; border: none; font-size: 13px; transition: all 0.3s ease; cursor: pointer;">üìä Cuadrante</button>
            <button class="tab-btn" data-tab="tab-individual" style="border-radius: 0; margin: 0; flex: 1; background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); color: white; padding: 10px 16px; border: none; font-size: 13px; transition: all 0.3s ease; cursor: pointer;">üìà Informe</button>
        </div>

        <!-- TAB 1: CUADRANTE GENERAL -->
        <div id="tab-general" class="tab-content active">
            <div class="monthly-schedule-container">
                <div class="monthly-header" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); padding: 12px 20px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 0 20px rgba(249, 115, 22, 0.5); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <div style="flex-shrink: 0;">
                        <h2 class="month-title" id="mesTituloGeneral" style="color: white; margin: 0; font-size: 16px; font-weight: 600;">üìÖ Cuadrante</h2>
                    </div>
                    <div class="month-nav" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="nav-btn" onclick="ExportManager.exportarCuadranteGeneral('pdf')" style="background: white; color: #0f172a; border: 1px solid #0ea5e9; padding: 6px 12px; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 12px; transition: all 0.2s ease;" title="Exportar a PDF">
                            üìÑ PDF
                        </button>
                        <button class="nav-btn" onclick="ExportManager.exportarCuadranteGeneral('print')" style="background: white; color: #0f172a; border: 1px solid #0ea5e9; padding: 6px 12px; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 12px; transition: all 0.2s ease;" title="Imprimir">
                            üñ®Ô∏è Imprimir
                        </button>
                    </div>
                </div>
                
                <div class="filtros">
                    <select class="filtro-select" id="filtroDepartamentoGeneral">
                        <option value="">Todos los departamentos</option>
                    </select>
                    
                    <select class="filtro-select" id="filtroEstadoGeneral">
                        <option value="">Todos los estados</option>
                    </select>
                </div>
                
                <div class="edit-controls">
                    <button class="edit-btn bulk" onclick="EdicionMasiva.abrirModal();" style="transition: all 0.2s ease !important; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important; color: white !important; border: none !important; padding: 12px 24px !important; border-radius: 8px !important; font-weight: 600 !important; cursor: pointer !important; font-size: 15px !important; box-shadow: 0 1px 3px rgba(37, 99, 235, 0.15) !important;" onmouseover="this.style.boxShadow='0 2px 4px rgba(37, 99, 235, 0.2) !important'" onmouseout="this.style.boxShadow='0 1px 3px rgba(37, 99, 235, 0.15) !important'">
                        üìÖ Seleccionar Rango
                    </button>
                    <button class="edit-btn cancel" style="display: none;" onclick="document.getElementById('modalEdicionMasiva').classList.remove('active');">
                        ‚ùå Cancelar
                    </button>
                </div>
                
                <div id="cuadranteGeneral"></div>
                
                <!-- ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó -->
                <!-- ‚ïë    AN√ÅLISIS Y ESTAD√çSTICAS - MISMO ANCHO Y EST√âTICA CUADRANTE   ‚ïë -->
                <!-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->

                <!-- 1Ô∏è‚É£ LEYENDA - Generada din√°micamente desde JavaScript -->
                <div id="leyendaTurnos" style="margin-top: 20px; padding: 20px 24px; background: linear-gradient(135deg, rgba(15, 23, 42, 0.7) 0%, rgba(11, 18, 32, 0.7) 100%); border-radius: 10px; border: 1px solid rgba(139, 92, 246, 0.2); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <!-- Se rellena con JavaScript -->
                </div>

                <!-- 2Ô∏è‚É£ KPIs ESTAD√çSTICAS - A lo ancho completo con 4 columnas -->
                <div style="margin-top: 20px;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalEmpleadosGeneral" style="font-size: 32px; font-weight: 700;">0</div>
                            <div class="stat-label" style="font-size: 14px; margin-top: 8px;">Total Empleados</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalHorasGeneral" style="font-size: 32px; font-weight: 700;">0</div>
                            <div class="stat-label" style="font-size: 14px; margin-top: 8px;">Horas Totales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="turnosMa√±anaGeneral" style="font-size: 32px; font-weight: 700;">0</div>
                            <div class="stat-label" style="font-size: 14px; margin-top: 8px;">Turnos Ma√±ana</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="turnosTardeGeneral" style="font-size: 32px; font-weight: 700;">0</div>
                            <div class="stat-label" style="font-size: 14px; margin-top: 8px;">Turnos Tarde</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="turnosNocheGeneral" style="font-size: 32px; font-weight: 700;">0</div>
                            <div class="stat-label" style="font-size: 14px; margin-top: 8px;">Turnos Noche</div>
                        </div>
                    </div>
                </div>

                <!-- 3Ô∏è‚É£ AN√ÅLISIS VISUAL - A lo ancho completo -->
                <div style="margin-top: 20px; padding: 24px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%); border-radius: 10px; border: 1px solid rgba(139, 92, 246, 0.25); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.08);">
                    <div id="calendarioVisual" style="min-height: 220px;"></div>
                </div>

                <!-- 4Ô∏è‚É£ FILTROS Y CONTROLES - A lo ancho completo en horizontal -->
                <div style="margin-top: 20px; padding: 20px 24px; background: linear-gradient(135deg, rgba(15, 23, 42, 0.7) 0%, rgba(11, 18, 32, 0.7) 100%); border-radius: 10px; border: 1px solid rgba(14, 165, 233, 0.2); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    
                    <!-- Grid de filtros en 4 columnas amplias -->
                    <div style="display: grid; grid-template-columns: 1fr 1.5fr 1.2fr 1fr; gap: 24px; margin-bottom: 16px;">
                        <!-- Filtro por Empleado -->
                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #cbd5e1; font-size: 13px;">üë§ Empleado</label>
                            <select id="filtroEmpleadoCalendario" style="width: 100%; padding: 10px 14px; border: 1px solid rgba(14, 165, 233, 0.3); border-radius: 8px; font-size: 14px; background: #0f172a; color: #e2e8f0; transition: all 0.3s ease;" onchange="if(this.value) FiltroCalendario.filtrarPorEmpleado(parseInt(this.value)); else FiltroCalendario.resetearFiltros();">
                                <option value="">üìå Todos los empleados</option>
                            </select>
                        </div>

                        <!-- Filtro por Carga -->
                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #cbd5e1; font-size: 13px;">‚öñÔ∏è Carga de Trabajo</label>
                            <div style="display: flex; gap: 14px; align-items: center; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 6px; color: #e2e8f0; cursor: pointer; font-weight: 500; font-size: 13px;"><input type="radio" name="filtro-carga" value="todos" checked onchange="if(this.checked) FiltroCalendario.resetearFiltros();" style="width: 16px; height: 16px; cursor: pointer;"> Todos</label>
                                <label style="display: flex; align-items: center; gap: 6px; color: #e2e8f0; cursor: pointer; font-weight: 500; font-size: 13px;"><input type="radio" name="filtro-carga" value="baja" onchange="if(this.checked) FiltroCalendario.filtrarPorCarga('baja');" style="width: 16px; height: 16px; cursor: pointer;"> üü¢ Baja</label>
                                <label style="display: flex; align-items: center; gap: 6px; color: #e2e8f0; cursor: pointer; font-weight: 500; font-size: 13px;"><input type="radio" name="filtro-carga" value="media" onchange="if(this.checked) FiltroCalendario.filtrarPorCarga('media');" style="width: 16px; height: 16px; cursor: pointer;"> üü° Media</label>
                                <label style="display: flex; align-items: center; gap: 6px; color: #e2e8f0; cursor: pointer; font-weight: 500; font-size: 13px;"><input type="radio" name="filtro-carga" value="alta" onchange="if(this.checked) FiltroCalendario.filtrarPorCarga('alta');" style="width: 16px; height: 16px; cursor: pointer;"> üî¥ Alta</label>
                            </div>
                        </div>

                        <!-- Mostrar Conflictos -->
                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #cbd5e1; font-size: 13px;">‚ö†Ô∏è Validaci√≥n</label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 500; color: #e2e8f0; padding: 9px 14px; background: rgba(14, 165, 233, 0.1); border-radius: 8px; border: 1px solid rgba(14, 165, 233, 0.2); transition: all 0.3s ease; height: fit-content;" onmouseover="this.style.background='rgba(14, 165, 233, 0.15)'; this.style.borderColor='rgba(14, 165, 233, 0.4)'" onmouseout="this.style.background='rgba(14, 165, 233, 0.1)'; this.style.borderColor='rgba(14, 165, 233, 0.2)'">
                                <input type="checkbox" id="mostrarConflictosCalendario" onchange="FiltroCalendario.toggleConflictos();" style="width: 16px; height: 16px; cursor: pointer;">
                                <span style="font-size: 13px;">Mostrar Conflictos</span>
                            </label>
                        </div>

                        <!-- Selector vac√≠o para balancear el grid -->
                        <div></div>
                    </div>

                    <!-- Botones de acci√≥n en una l√≠nea a lo ancho -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 0.8fr; gap: 16px;">
                        <button class="action-btn" onclick="ExportadorCalendario.exportarEstadisticas()" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: none; padding: 11px 18px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);" onmouseover="this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.2)'">
                            üìä Generar Estad√≠sticas
                        </button>
                        <button class="action-btn" onclick="ExportadorCalendario.exportarAPDF()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 11px 18px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);" onmouseover="this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.2)'">
                            üìÑ Exportar PDF
                        </button>
                        <button class="action-btn" onclick="FiltroCalendario.resetearFiltros()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 11px 18px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);" onmouseover="this.style.boxShadow='0 6px 20px rgba(245, 158, 11, 0.4)'" onmouseout="this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.2)'">
                            üîÑ Resetear Filtros
                        </button>
                    </div>
                </div>

                <!-- Vista Previa del Empleado Seleccionado -->
                <div id="vistaPrevia" style="display: none; margin-top: 30px; padding: 20px; background: rgba(17, 24, 39, 0.9); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); border: 2px solid rgba(168, 85, 247, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #f1f5f9; margin: 0; font-size: 24px; background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üìã Cuadrante del Empleado</h3>
                        <button onclick="document.getElementById('vistaPrevia').style.display = 'none'; AppState.selectedEmployee = null;" style="background: linear-gradient(135deg, #f3d4d9 0%, #fce4ec 100%); color: #c2185b; padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(193, 24, 91, 0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">‚úï Cerrar</button>
                    </div>

                    <div class="vista-previa-grid">
                        <div class="empleado-info-card">
                            <div class="empleado-info-label">Empleado</div>
                            <div id="nombreEmpleado" class="empleado-info-value">-</div>
                        </div>
                        <div class="empleado-info-card">
                            <div class="empleado-info-label">Departamento</div>
                            <div id="deptoEmpleado" class="empleado-info-value">-</div>
                        </div>
                        <div class="empleado-info-card">
                            <div class="empleado-info-label">Horas Contrato</div>
                            <div id="horasEmpleado" class="empleado-info-value">-</div>
                        </div>
                        <div class="empleado-info-card">
                            <div class="empleado-info-label">Turno Principal</div>
                            <div id="turnoEmpleado" class="empleado-info-value">-</div>
                        </div>
                        <div class="empleado-info-card">
                            <div class="empleado-info-label">D√≠as Trabajados</div>
                            <div id="diasEmpleado" class="empleado-info-value">-</div>
                        </div>
                    </div>

                    <!-- Cuadrante Individual (Modal) -->
                    <div id="cuadranteIndividual" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: none; z-index: 9999; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;"></div>

                    <!-- Estad√≠sticas Individual -->
                    <div id="estadisticasIndividual" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>

        <!-- TAB 2: INFORME INDIVIDUAL -->
        <div id="tab-individual" class="tab-content">
            <div class="monthly-schedule-container">
                <div class="monthly-header" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); padding: 30px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 0 30px rgba(249, 115, 22, 0.8), 0 0 60px rgba(234, 88, 12, 0.6), 0 4px 20px rgba(249, 115, 22, 0.7);">
                    <h2 class="month-title" style="color: white; margin: 0; font-size: 28px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 32px;">üìä</span>
                        Informe Individual por Centro de Trabajo
                    </h2>
                    <p style="color: rgba(255,255,255,0.9); margin: 12px 0 0 0; font-size: 14px;">An√°lisis detallado de turnos por localidad, departamento y per√≠odo</p>
                </div>
                
                <div style="background: rgba(17, 24, 39, 0.9); padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); margin-bottom: 20px; border: 1px solid rgba(14, 165, 233, 0.3);">
                    <h3 style="color: #e2e8f0; margin-top: 0;">üîç Filtros</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <!-- Localidad -->
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #f1f5f9;">Localidad</label>
                            <select id="selectCentroTrabajo" style="width: 100%; padding: 12px; border: 2px solid #f97316; border-radius: 8px; font-size: 14px; background: #0f172a; color: #f1f5f9; box-shadow: 0 0 10px rgba(249, 115, 22, 0.3);">
                                <option value="">-- Todas las localidades --</option>
                            </select>
                        </div>
                        
                        <!-- Departamento -->
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #f1f5f9;">Departamento</label>
                            <select id="selectDepartamentoIndividual" style="width: 100%; padding: 12px; border: 2px solid #f97316; border-radius: 8px; font-size: 14px; background: #0f172a; color: #f1f5f9; box-shadow: 0 0 10px rgba(249, 115, 22, 0.3);">
                                <option value="">-- Todos los departamentos --</option>
                            </select>
                        </div>
                        
                        <!-- Mes -->
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #f1f5f9;">Mes</label>
                            <select id="selectMesIndividual" style="width: 100%; padding: 12px; border: 2px solid #f97316; border-radius: 8px; font-size: 14px; background: #0f172a; color: #f1f5f9; box-shadow: 0 0 10px rgba(249, 115, 22, 0.3);">
                                <option value="0">Enero</option>
                                <option value="1">Febrero</option>
                                <option value="2">Marzo</option>
                                <option value="3">Abril</option>
                                <option value="4">Mayo</option>
                                <option value="5">Junio</option>
                                <option value="6">Julio</option>
                                <option value="7">Agosto</option>
                                <option value="8">Septiembre</option>
                                <option value="9">Octubre</option>
                                <option value="10">Noviembre</option>
                                <option value="11">Diciembre</option>
                            </select>
                        </div>
                        
                        <!-- A√±o -->
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #f1f5f9;">A√±o</label>
                            <select id="selectAnioIndividual" style="width: 100%; padding: 12px; border: 2px solid #f97316; border-radius: 8px; font-size: 14px; background: #0f172a; color: #f1f5f9; box-shadow: 0 0 10px rgba(249, 115, 22, 0.3);">
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                    </div>
                    
                    <button onclick="aplicarFiltrosInforme()" style="background: #0ea5e9; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; box-shadow: 0 2px 5px rgba(14, 165, 233, 0.2);" onmouseover="this.style.boxShadow='0 0 30px rgba(249, 115, 22, 1), 0 0 60px rgba(234, 88, 12, 0.8), 0 6px 20px rgba(249, 115, 22, 0.8)'" onmouseout="this.style.boxShadow='0 2px 5px rgba(14, 165, 233, 0.2)'">Aplicar Filtros</button>
                        üîé Buscar
                    </button>
                </div>
                
                <div id="resultadosFiltro" style="background: rgba(17, 24, 39, 0.95); padding: 24px; border-radius: 14px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); border: 2px solid rgba(168, 85, 247, 0.3);">
                    <div id="tablaResultados"></div>
                </div>
            </div>
        </div>

        <!-- MODAL DE GESTI√ìN DE EMPLEADOS -->
        <div id="modalGestionEmpleados" class="modal" onclick="if(event.target.id === 'modalGestionEmpleados') EmployeeManager.cerrarModal()">
            <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">üë•</span>
                        Gestionar Empleados
                    </h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Agrega, edita y controla a todos tus empleados</p>
                </div>

                <!-- BOTONES DE ACCI√ìN -->
                <div style="padding: 20px 30px; display: flex; gap: 12px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                    <button class="modal-btn apply" onclick="EmployeeManager.mostrarFormularioNuevo()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7);">
                        ‚ûï Nuevo Empleado
                    </button>
                    <button class="modal-btn cancel" onclick="EmployeeManager.cerrarModal()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                        ‚úñÔ∏è Cerrar
                    </button>
                </div>

                <!-- FORMULARIO EMPLEADO -->
                <div id="formularioEmpleado" style="display: none; padding: 30px; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, rgba(249, 115, 22, 0.05) 0%, rgba(234, 88, 12, 0.05) 100%);">
                    <h4 style="color: #1e293b; margin: 0 0 20px 0; font-size: 16px; font-weight: 700;">üìù Formulario de Empleado</h4>
                    
                    <input type="hidden" id="empleadoIdEdicion" value="">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Nombre Completo *</label>
                            <input type="text" id="emple_nombre" class="modal-select" placeholder="Ej: Mar√≠a Rodr√≠guez L√≥pez" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Departamento *</label>
                            <select id="emple_departamento" class="modal-select" onchange="EmployeeManager.actualizarHorasPorDepartamento()" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <option value="">Selecciona departamento</option>
                                <option value="Operaciones">Operaciones</option>
                                <option value="Ventas">Ventas</option>
                                <option value="Administraci√≥n">Administraci√≥n</option>
                                <option value="Soporte T√©cnico">Soporte T√©cnico</option>
                                <option value="Recursos Humanos">Recursos Humanos</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Localidad *</label>
                            <select id="emple_localidad" class="modal-select" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <option value="">Selecciona localidad</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Tel√©fono *</label>
                            <input type="tel" id="emple_telefono" class="modal-select" placeholder="Ej: +34 600 123 456" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Email *</label>
                            <input type="email" id="emple_email" class="modal-select" placeholder="Ej: maria@empresa.com" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Horas de Contrato *</label>
                            <input type="number" id="emple_horas" class="modal-select" placeholder="Ej: 160" min="0" max="240" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Turno Principal *</label>
                            <select id="emple_turno" class="modal-select" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <option value="">Selecciona turno</option>
                                <option value="Ma√±ana">Ma√±ana</option>
                                <option value="Tarde">Tarde</option>
                                <option value="Noche">Noche</option>
                                <option value="Mixto">Mixto</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Estado *</label>
                            <select id="emple_estado" class="modal-select" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <option value="activo">Activo</option>
                                <option value="vacaciones">Vacaciones</option>
                                <option value="baja">Baja M√©dica</option>
                                <option value="inactivo">Inactivo</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="modal-btn apply" onclick="EmployeeManager.guardarEmpleado()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 32px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                            üíæ Guardar Empleado
                        </button>
                        <button class="modal-btn cancel" onclick="EmployeeManager.cancelarFormulario()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1;">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>

                <!-- LISTA DE EMPLEADOS -->
                <div style="padding: 30px;">
                    <h4 style="color: #1e293b; margin: 0 0 16px 0; font-size: 16px; font-weight: 700;">üìã Empleados Registrados</h4>
                    <div id="listaEmpleados" style="max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px;">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE GESTI√ìN DE DEPARTAMENTOS -->
        <div id="modalGestionDepartamentos" class="modal" onclick="if(event.target.id === 'modalGestionDepartamentos') DepartmentManager.cerrarModal()">
            <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">üè¢</span>
                        Gestionar Departamentos
                    </h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Organiza y administra los departamentos de tu empresa</p>
                </div>

                <!-- BOTONES DE ACCI√ìN -->
                <div style="padding: 20px 30px; display: flex; gap: 12px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                    <button class="modal-btn apply" onclick="ConsolidadoDepartamentos.mostrarFormularioNuevo()" style="background: linear-gradient(135deg, #f97316 0%, #d97706 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(217, 119, 6, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                        ‚ûï Nuevo Departamento
                    </button>
                    <button class="modal-btn cancel" onclick="ConsolidadoDepartamentos.cerrarModal()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                        ‚úñÔ∏è Cerrar
                    </button>
                </div>

                <!-- FORMULARIO DEPARTAMENTO -->
                <div id="formularioDepartamento" style="display: none; padding: 30px; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, rgba(249, 115, 22, 0.05) 0%, rgba(217, 119, 6, 0.05) 100%);">
                    <h4 style="color: #1e293b; margin: 0 0 20px 0; font-size: 16px; font-weight: 700;">üìù Formulario de Departamento</h4>
                    
                    <input type="hidden" id="departamentoIdEdicion" value="">
                    
                    <!-- Secci√≥n: Informaci√≥n B√°sica -->
                    <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e2e8f0;">
                        <h5 style="color: #1e293b; margin: 0 0 16px 0; font-size: 13px; font-weight: 700; text-transform: uppercase; color: #64748b;">üìå INFORMACI√ìN B√ÅSICA</h5>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Nombre del Departamento *</label>
                            <input type="text" id="depto_nombre" class="modal-select" placeholder="Ej: Limpieza, Operaciones, Ventas..." style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Descripci√≥n</label>
                            <textarea id="depto_descripcion" class="modal-select" placeholder="Describe el prop√≥sito de este departamento (opcional)" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; min-height: 80px; resize: vertical; transition: all 0.3s ease;"></textarea>
                        </div>
                    </div>

                    <!-- Secci√≥n: Est√°ndares de Trabajo -->
                    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(99, 102, 241, 0.05) 100%); padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #bfdbfe;">
                        <h5 style="color: #1e293b; margin: 0 0 16px 0; font-size: 13px; font-weight: 700; text-transform: uppercase; color: #64748b;">‚è∞ EST√ÅNDARES DE TRABAJO</h5>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 13px;">Horas Semanales</label>
                                <input type="number" id="depto_horasSemanales" value="40" min="0" max="60" class="modal-select" placeholder="40" style="padding: 10px 12px; border: 2px solid #bfdbfe; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <small style="color: #64748b; font-size: 11px; margin-top: 4px; display: block;">Ej: 39 (Limpieza), 40 (General)</small>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 13px;">D√≠as de Trabajo</label>
                                <input type="number" id="depto_diasTrabajo" value="5" min="4" max="7" class="modal-select" placeholder="5" style="padding: 10px 12px; border: 2px solid #bfdbfe; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <small style="color: #64748b; font-size: 11px; margin-top: 4px; display: block;">Ej: 6 (Limpieza), 5 (General)</small>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 13px;">Horas/D√≠a</label>
                                <input type="number" id="depto_horasDiarias" value="8" min="4" max="12" step="0.5" class="modal-select" placeholder="8" style="padding: 10px 12px; border: 2px solid #bfdbfe; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                <small style="color: #64748b; font-size: 11px; margin-top: 4px; display: block;">Ej: 6.5 (Limpieza), 8 (General)</small>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="modal-btn apply" onclick="ConsolidadoDepartamentos.guardarDepartamento()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 32px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                            üíæ Guardar Departamento
                        </button>
                        <button class="modal-btn cancel" onclick="ConsolidadoDepartamentos.cancelarFormulario()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1;">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>

                <!-- LISTA DE DEPARTAMENTOS -->
                <div style="padding: 30px;">
                    <h4 style="color: #1e293b; margin: 0 0 16px 0; font-size: 16px; font-weight: 700;">üìã Departamentos Registrados</h4>
                    <div id="listaDepartamentos" style="max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px;">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE GESTI√ìN DE LOCALIDADES -->
        <div id="modalGestionLocalidades" class="modal" onclick="if(event.target.id === 'modalGestionLocalidades') ConsolidadoLocalidades.cerrarModal()">
            <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">üìç</span>
                        Gestionar Localidades
                    </h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Organiza las ubicaciones o sucursales de tu empresa</p>
                </div>

                <!-- BOTONES DE ACCI√ìN -->
                <div style="padding: 20px 30px; display: flex; gap: 12px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                    <button class="modal-btn apply" onclick="ConsolidadoLocalidades.mostrarFormularioNuevo()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                        ‚ûï Nueva Localidad
                    </button>
                    <button class="modal-btn cancel" onclick="ConsolidadoLocalidades.cerrarModal()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                        ‚úñÔ∏è Cerrar
                    </button>
                </div>

                <!-- FORMULARIO LOCALIDAD -->
                <div id="formularioLocalidad" style="display: none; padding: 30px; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, rgba(236, 72, 153, 0.05) 0%, rgba(219, 39, 119, 0.05) 100%);">
                    <h4 style="color: #1e293b; margin: 0 0 20px 0; font-size: 16px; font-weight: 700;">üìù Formulario de Localidad</h4>
                    
                    <input type="hidden" id="localidadIdEdicion" value="">
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Nombre de la Localidad *</label>
                        <input type="text" id="loc_nombre" class="modal-select" placeholder="Ej: Madrid, Barcelona, Valencia..." style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="modal-btn apply" onclick="ConsolidadoLocalidades.guardarLocalidad()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 32px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                            üíæ Guardar Localidad
                        </button>
                        <button class="modal-btn cancel" onclick="ConsolidadoLocalidades.limpiarFormulario()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1;">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>

                <!-- LISTA DE LOCALIDADES -->
                <div style="padding: 30px;">
                    <h4 style="color: #1e293b; margin: 0 0 16px 0; font-size: 16px; font-weight: 700;">üìã Localidades Registradas</h4>
                    <div id="listaLocalidades" style="max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px;">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE GESTI√ìN DE TIPOS DE TURNOS -->
        <div id="modalGestionTurnos" class="modal" onclick="if(event.target.id === 'modalGestionTurnos') ConsolidadoTurnos.cerrarModal()">
            <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">‚è∞</span>
                        Gestionar Tipos de Turnos
                    </h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Define y personaliza los tipos de turnos de tu empresa</p>
                </div>

                <!-- BOTONES DE ACCI√ìN -->
                <div style="padding: 20px 30px; display: flex; gap: 12px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                    <button class="modal-btn apply" onclick="ConsolidadoTurnos.mostrarFormularioNuevo()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                        ‚ûï Nuevo Tipo de Turno
                    </button>
                    <button class="modal-btn cancel" onclick="ConsolidadoTurnos.cerrarModal()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                        ‚úñÔ∏è Cerrar
                    </button>
                </div>

                <!-- FORMULARIO TURNO -->
                <div id="formularioTurno" style="display: none; padding: 30px; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, rgba(244, 63, 94, 0.05) 0%, rgba(225, 29, 72, 0.05) 100%);">
                    <h4 style="color: #1e293b; margin: 0 0 20px 0; font-size: 16px; font-weight: 700;">üìù Formulario de Tipo de Turno</h4>
                    
                    <input type="hidden" id="turnoIdEdicion" value="">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Nombre del Turno *</label>
                            <input type="text" id="turno_nombre" class="modal-select" placeholder="Ej: Ma√±ana, Tarde, Noche..." style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Inicial *</label>
                            <input type="text" id="turno_inicial" class="modal-select" placeholder="Ej: M, T, N..." maxlength="2" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Horario</label>
                            <input type="text" id="turno_horario" class="modal-select" placeholder="Ej: 08:00-16:00" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">Horas *</label>
                            <input type="number" id="turno_horas" class="modal-select" placeholder="Ej: 8.5" min="0" max="24" step="0.25" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">üé® Color del Turno</label>
                        <div style="display: flex; gap: 12px; align-items: flex-end;">
                            <input type="color" id="turno_color" style="padding: 5px; border: 2px solid #e2e8f0; border-radius: 8px; width: 70px; height: 44px; cursor: pointer; transition: all 0.3s ease;">
                            <input type="text" id="turno_color_hex" class="modal-select" placeholder="#d4edda" style="padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; flex: 1; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="modal-btn apply" onclick="ConsolidadoTurnos.guardarTurno()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 12px 32px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(249, 115, 22, 0.8), 0 0 40px rgba(234, 88, 12, 0.6), 0 4px 15px rgba(249, 115, 22, 0.7); flex: 1;">
                            üíæ Guardar Tipo de Turno
                        </button>
                        <button class="modal-btn cancel" onclick="ConsolidadoTurnos.limpiarFormulario()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1;">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>

                <!-- LISTA DE TURNOS -->
                <div style="padding: 30px;">
                    <h4 style="color: #1e293b; margin: 0 0 16px 0; font-size: 16px; font-weight: 700;">üìã Tipos de Turnos Registrados</h4>
                    <div id="listaTurnos" style="max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px;">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Script para sincronizar inputs de color del turno -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const colorPicker = document.getElementById('turno_color');
                const colorHex = document.getElementById('turno_color_hex');
                
                if (colorPicker && colorHex) {
                    // Sincronizar color picker ‚Üí hex
                    colorPicker.addEventListener('change', (e) => {
                        colorHex.value = e.target.value;
                    });
                    
                    // Sincronizar hex ‚Üí color picker
                    colorHex.addEventListener('change', (e) => {
                        if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                            colorPicker.value = e.target.value;
                        }
                    });
                    
                    // Sincronizar en tiempo real para el hex input
                    colorHex.addEventListener('input', (e) => {
                        if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                            colorPicker.value = e.target.value;
                        }
                    });
                }
            });
        </script>

        <!-- MODAL DE DESCRIPCI√ìN Y EDICI√ìN DE TURNO -->
        <div id="modalDescripcionTurno" class="modal" style="z-index: 10001;" onclick="if(event.target.id === 'modalDescripcionTurno') TurnoEditor.cerrarModalDescripcion()">
            <div class="modal-content" style="max-width: 650px; max-height: 90vh; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 id="tituloTurnoModal" style="margin: 0; font-size: 24px; font-weight: 700;">üìã Detalles del Turno</h3>
                </div>

                <!-- BOTONES STICKY -->
                <div style="padding: 20px 30px; display: flex; gap: 12px; border-bottom: 1px solid #e2e8f0; background: #f8fafc; position: sticky; top: 0; z-index: 10;">
                    <button class="modal-btn apply" onclick="TurnoEditor.guardarDescripcion()" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3); flex: 1;" title="Guardar el turno actual" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(34, 197, 94, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(34, 197, 94, 0.3)'">
                        ‚úÖ Guardar Cambios
                    </button>
                    <button class="modal-btn cancel" onclick="TurnoEditor.cerrarModalDescripcion()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;" title="Cerrar sin guardar" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                        ‚ùå Cerrar
                    </button>
                </div>

                <!-- CONTENIDO CON SCROLL -->
                <div style="max-height: 70vh; overflow-y: auto;">
                    <!-- INFORMACI√ìN GENERAL -->
                    <div style="padding: 30px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 28px;">
                            <div style="padding: 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(30, 64, 175, 0.08) 100%); border-radius: 10px; border-left: 3px solid #3b82f6;">
                                <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">Tipo de Turno</label>
                                <div id="tipoTurnoDesc" style="font-size: 18px; color: #1e293b; font-weight: bold;">-</div>
                            </div>
                            
                            <div style="padding: 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, rgba(22, 163, 74, 0.08) 100%); border-radius: 10px; border-left: 3px solid #22c55e;">
                                <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">Horario</label>
                                <div id="horarioTurnoDesc" style="font-size: 16px; color: #1e293b; font-weight: 600;">-</div>
                            </div>
                            
                            <div style="padding: 16px; background: linear-gradient(135deg, rgba(244, 63, 94, 0.08) 0%, rgba(225, 29, 72, 0.08) 100%); border-radius: 10px; border-left: 3px solid #f43f5e;">
                                <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">Horas Est√°ndar</label>
                                <div id="horasEstandarDesc" style="font-size: 18px; color: #1e293b; font-weight: bold;">-</div>
                            </div>
                            
                            <div style="padding: 16px; background: linear-gradient(135deg, rgba(251, 146, 60, 0.08) 0%, rgba(234, 88, 12, 0.08) 100%); border-radius: 10px; border-left: 3px solid #f97316;">
                                <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">Empleado</label>
                                <div id="empleadoDesc" style="font-size: 15px; color: #1e293b;">-</div>
                            </div>
                            
                            <div style="padding: 16px; background: linear-gradient(135deg, rgba(168, 85, 247, 0.08) 0%, rgba(126, 34, 206, 0.08) 100%); border-radius: 10px; border-left: 3px solid #a855f7;">
                                <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">D√≠a</label>
                                <div id="diaDesc" style="font-size: 15px; color: #1e293b;">-</div>
                            </div>
                            
                            <div style="padding: 16px; background: linear-gradient(135deg, rgba(236, 72, 153, 0.08) 0%, rgba(190, 24, 93, 0.08) 100%); border-radius: 10px; border-left: 3px solid #ec4899;">
                                <label style="display: block; font-weight: 600; color: #64748b; font-size: 12px; margin-bottom: 6px;">Fecha</label>
                                <div id="fechaDesc" style="font-size: 15px; color: #1e293b;">-</div>
                            </div>
                        </div>

                        <!-- EDITAR HORAS -->
                        <div style="padding: 20px; background: linear-gradient(135deg, #eff6ff 0%, #f0f9ff 100%); border: 2px solid #bfdbfe; border-radius: 12px; margin-bottom: 28px;">
                            <label style="display: block; font-weight: 700; color: #1e40af; margin-bottom: 12px; font-size: 15px;">‚è±Ô∏è Editar Horas Trabajadas</label>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input type="number" id="horasEditarTurno" min="0" max="24" step="0.5" style="padding: 12px 14px; border: 2px solid #bfdbfe; border-radius: 8px; width: 120px; font-size: 15px; font-weight: 600; background: white; color: #1e40af; transition: all 0.3s ease;">
                                <span style="color: #1e40af; font-weight: 600;">horas</span>
                            </div>
                            <div style="font-size: 13px; color: #1e40af; margin-top: 10px; opacity: 0.8;">
                                üí° Ingresa las horas reales trabajadas en este d√≠a (0-24)
                            </div>
                        </div>

                        <!-- BOTONES R√ÅPIDOS -->
                        <div style="margin-bottom: 24px;">
                            <label style="display: block; font-weight: 700; color: #1e293b; margin-bottom: 12px; font-size: 15px;">üöÄ Turnos R√°pidos</label>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;" id="opcionesTurnosRapidas"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE CHAT INTELIGENTE -->
        <div id="modalChatBot" class="modal" onclick="if(event.target.id === 'modalChatBot') ChatBot.cerrarModal()">
            <div class="modal-content" style="max-width: 700px; max-height: 80vh; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">ü§ñ</span>
                        Asistente Inteligente
                    </h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Preg√∫ntame sobre empleados, turnos y la aplicaci√≥n</p>
                </div>

                <!-- CONTENIDO DEL CHAT -->
                <div id="chatContainer" style="height: 400px; display: flex; flex-direction: column;">
                    <!-- MENSAJES -->
                    <div id="chatMessages" style="flex: 1; padding: 20px; overflow-y: auto; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                        <div style="text-align: center; color: #64748b; font-style: italic; margin-top: 20px;">
                            ¬°Hola! Soy tu asistente inteligente. Preg√∫ntame sobre empleados, turnos o la aplicaci√≥n.
                            <br><br>
                            <strong>Ejemplos:</strong><br>
                            ‚Ä¢ "¬øCu√°ntos empleados hay?"<br>
                            ‚Ä¢ "¬øTurnos de Mar√≠a Rodr√≠guez?"<br>
                            ‚Ä¢ "¬øEstad√≠sticas del mes?"<br>
                            ‚Ä¢ "ayuda"
                        </div>
                    </div>

                    <!-- INPUT -->
                    <div style="padding: 20px; background: white; border-top: 1px solid #e2e8f0;">
                        <div style="display: flex; gap: 12px;">
                            <input type="text" id="chatInput" placeholder="Escribe tu pregunta aqu√≠..." style="flex: 1; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.3s ease;" onkeypress="if(event.key === 'Enter') ChatBot.enviarMensaje()">
                            <button onclick="ChatBot.enviarMensaje()" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);">
                                üì§ Enviar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- BOTONES DE ACCI√ìN -->
                <div style="padding: 20px 30px; border-top: 1px solid #e2e8f0; background: #f8fafc; display: flex; gap: 12px;">
                    <button onclick="ChatBot.limpiarChat()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                        üóëÔ∏è Limpiar Chat
                    </button>
                    <button onclick="ChatBot.cerrarModal()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1;">
                        ‚úñÔ∏è Cerrar
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL DE GENERACI√ìN DE TURNOS POR DEFECTO -->
        <div id="modalGenerarTurnos" class="modal" onclick="if(event.target.id === 'modalGenerarTurnos') TurnoManager.cerrarModalGeneracion()">
            <div class="modal-content" style="max-width: 650px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO -->
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 16px 16px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">üìã</span>
                        Generar Turnos Por Defecto
                    </h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Asigna los turnos principales a todos los d√≠as laborales</p>
                </div>

                <!-- CONTENIDO -->
                <div style="padding: 30px;">
                    <!-- Info del mes -->
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #10b981; margin-bottom: 24px;">
                        <h4 style="color: #047857; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">üìÜ Per√≠odo a Generar</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div style="padding: 12px; background: white; border-radius: 8px; border: 2px solid #d1fae5;">
                                <span style="color: #6b7280; font-size: 12px; font-weight: 600;">MES</span>
                                <div style="color: #047857; font-size: 18px; font-weight: 700; margin-top: 4px;" id="infoMesGeneracion">Enero</div>
                            </div>
                            <div style="padding: 12px; background: white; border-radius: 8px; border: 2px solid #d1fae5;">
                                <span style="color: #6b7280; font-size: 12px; font-weight: 600;">A√ëO</span>
                                <div style="color: #047857; font-size: 18px; font-weight: 700; margin-top: 4px;" id="infoAnioGeneracion">2026</div>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen -->
                    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #3b82f6; margin-bottom: 24px;">
                        <h4 style="color: #1e40af; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">üìä Resumen</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                            <div>
                                <span style="color: #6b7280;">Empleados:</span>
                                <span style="color: #1e40af; font-weight: 700;" id="resumenEmpleados">0</span>
                            </div>
                            <div>
                                <span style="color: #6b7280;">Turnos a generar:</span>
                                <span style="color: #1e40af; font-weight: 700;" id="resumenTurnos">~0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Aclaraci√≥n -->
                    <div style="padding: 16px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #22c55e; margin-bottom: 24px;">
                        <p style="margin: 0; color: #166534; font-size: 14px; line-height: 1.6;">
                            <strong>‚úÖ Se asignar√°n:</strong> Turno principal de cada empleado a todos los d√≠as laborales
                        </p>
                        <p style="margin: 12px 0 0 0; color: #166534; font-size: 14px; line-height: 1.6;">
                            <strong>‚è∏Ô∏è Se respetar√°n:</strong> Domingos, festivos, bajas y vacaciones (no se sobrescriben)
                        </p>
                    </div>

                    <!-- Advertencia -->
                    <div style="padding: 16px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 24px;">
                        <p style="margin: 0; color: #92400e; font-size: 13px; line-height: 1.6;">
                            <strong>‚ö†Ô∏è Nota:</strong> Esta acci√≥n solo afecta al mes actual. Si ya existen turnos asignados, no ser√°n modificados.
                        </p>
                    </div>
                </div>

                <!-- BOTONES -->
                <div style="padding: 20px 30px; border-top: 1px solid #e2e8f0; background: #f8fafc; display: flex; gap: 12px; border-radius: 0 0 16px 16px;">
                    <button onclick="TurnoManager.cerrarModalGeneracion()" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1;">
                        ‚ùå Cancelar
                    </button>
                    <button onclick="TurnoManager.generarTurnos()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; flex: 1; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                        ‚úÖ Generar Turnos
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL DE EDICI√ìN MASIVA MEJORADO -->
        <div id="modalEdicionMasiva" class="modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; z-index: 10000;">
            <div class="modal-content" style="max-width: 750px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                <!-- ENCABEZADO CON BOTONES -->
                <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); padding: 20px 30px; border-radius: 16px 16px 0 0; color: white; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100;">
                    <div>
                        <h3 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 28px;">‚ö°</span>
                            Edici√≥n Masiva de Turnos
                        </h3>
                        <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Asigna turnos a m√∫ltiples empleados en un solo paso</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="modal-btn cancel" onclick="document.getElementById('modalEdicionMasiva').classList.remove('active');" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.5); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s ease; white-space: nowrap;">
                            ‚úñÔ∏è Cancelar
                        </button>
                        <button class="modal-btn apply" onclick="EdicionMasiva.aplicarCambios();" style="background: rgba(255,255,255,0.25); color: white; border: 2px solid rgba(255,255,255,0.8); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s ease; white-space: nowrap;">
                            ‚úÖ Aplicar
                        </button>
                    </div>
                </div>

                <!-- CONTENIDO -->
                <div style="padding: 30px;">
                    <!-- PASO 1: EMPLEADO -->
                    <div style="margin-bottom: 28px; padding: 20px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%); border-radius: 12px; border-left: 4px solid #6366f1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span style="background: #6366f1; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;">1</span>
                            <label style="font-weight: 700; font-size: 15px; color: #1e293b; margin: 0;">üë§ Seleccionar Empleado</label>
                        </div>
                        <select id="masiva_empleado" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease; cursor: pointer;">
                            <option value="">-- Elige un empleado --</option>
                        </select>
                    </div>

                    <!-- PASO 2: MES Y A√ëO (NUEVO) -->
                    <div style="margin-bottom: 28px; padding: 20px; background: linear-gradient(135deg, rgba(168, 85, 247, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%); border-radius: 12px; border-left: 4px solid #a855f7;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span style="background: #a855f7; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;">2</span>
                            <label style="font-weight: 700; font-size: 15px; color: #1e293b; margin: 0;">üìÜ Mes y A√±o</label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                            <div>
                                <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px; font-weight: 600;">Mes:</label>
                                <select id="masiva_mes" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                    <option value="">-- Selecciona mes --</option>
                                    <option value="0">Enero</option>
                                    <option value="1">Febrero</option>
                                    <option value="2">Marzo</option>
                                    <option value="3">Abril</option>
                                    <option value="4">Mayo</option>
                                    <option value="5">Junio</option>
                                    <option value="6">Julio</option>
                                    <option value="7">Agosto</option>
                                    <option value="8">Septiembre</option>
                                    <option value="9">Octubre</option>
                                    <option value="10">Noviembre</option>
                                    <option value="11">Diciembre</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px; font-weight: 600;">A√±o:</label>
                                <select id="masiva_anio" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                    <option value="">-- Selecciona a√±o --</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- PASO 3: FECHAS -->
                    <div style="margin-bottom: 28px; padding: 20px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, rgba(59, 130, 246, 0.08) 100%); border-radius: 12px; border-left: 4px solid #22c55e;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span style="background: #22c55e; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;">3</span>
                            <label style="font-weight: 700; font-size: 15px; color: #1e293b; margin: 0;">üìÖ Rango de Fechas</label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                            <div>
                                <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px; font-weight: 600;">Desde:</label>
                                <select id="masiva_desde" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                    <option value="">D√≠a inicio</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px; font-weight: 600;">Hasta:</label>
                                <select id="masiva_hasta" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                                    <option value="">D√≠a fin</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- PASO 4: TURNO -->
                    <div style="margin-bottom: 28px; padding: 20px; background: linear-gradient(135deg, rgba(244, 63, 94, 0.08) 0%, rgba(249, 115, 22, 0.08) 100%); border-radius: 12px; border-left: 4px solid #f43f5e;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span style="background: #f43f5e; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;">4</span>
                            <label style="font-weight: 700; font-size: 15px; color: #1e293b; margin: 0;">üéØ Nuevo Turno/Estado</label>
                        </div>
                        <select id="masiva_turno" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; transition: all 0.3s ease;">
                            <option value="">-- Selecciona turno --</option>
                            <option value="ma√±ana">‚òÄÔ∏è Ma√±ana (08:00-16:00)</option>
                            <option value="tarde">üå§Ô∏è Tarde (16:00-00:00)</option>
                            <option value="noche">üåô Noche (00:00-08:00)</option>
                            <option value="mixto">‚ö° Mixto</option>
                            <option value="descanso">üò¥ Descanso</option>
                            <option value="vacaciones">üèñÔ∏è Vacaciones</option>
                            <option value="baja">üè• Baja M√©dica</option>
                            <option value="libre">‚ú® Libre</option>
                        </select>
                    </div>

                    <!-- RESUMEN -->
                    <div style="padding: 20px; background: linear-gradient(135deg, #eff6ff 0%, #f0f9ff 100%); border: 2px solid #bfdbfe; border-radius: 12px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <span style="font-size: 20px;">üìä</span>
                            <strong style="color: #1e40af; font-size: 15px;">Resumen de cambios</strong>
                        </div>
                        <div id="masiva_resumen" style="color: #1e40af; font-size: 14px; line-height: 1.6;">
                            Selecciona empleado, rango de fechas y turno para ver el resumen
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </div>
        </div>

        <!-- MODAL DE INFORME INDIVIDUAL -->
        <!-- MODAL DE INFORME INDIVIDUAL - ELIMINADO (Se usa la pesta√±a en su lugar) -->

        <!-- MODALES PARA CONTROLES SIDEBAR (Semana 1, 2, 3, 4) -->
        <div id="modalSemana1" class="modal" style="z-index: 9999;">
            <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e2e8f0;">
                    <h2 id="modalSemana1Title" style="margin: 0; color: #1e293b;">Modal Semana 1</h2>
                    <button onclick="document.getElementById('modalSemana1').classList.remove('active')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b;">‚úï</button>
                </div>
                <div id="modalSemana1Content" style="padding: 20px;"></div>
            </div>
        </div>

        <div id="modalSemana2" class="modal" style="z-index: 9999;">
            <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e2e8f0;">
                    <h2 id="modalSemana2Title" style="margin: 0; color: #1e293b;">Modal Semana 2</h2>
                    <button onclick="document.getElementById('modalSemana2').classList.remove('active')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b;">‚úï</button>
                </div>
                <div id="modalSemana2Content" style="padding: 20px;"></div>
            </div>
        </div>

        <div id="modalSemana3" class="modal" style="z-index: 9999;">
            <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e2e8f0;">
                    <h2 id="modalSemana3Title" style="margin: 0; color: #1e293b;">Modal Semana 3</h2>
                    <button onclick="document.getElementById('modalSemana3').classList.remove('active')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b;">‚úï</button>
                </div>
                <div id="modalSemana3Content" style="padding: 20px;"></div>
            </div>
        </div>

        <div id="modalSemana4" class="modal" style="z-index: 9999;">
            <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e2e8f0;">
                    <h2 id="modalSemana4Title" style="margin: 0; color: #1e293b;">Calendario iCalendar</h2>
                    <button onclick="document.getElementById('modalSemana4').classList.remove('active')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b;">‚úï</button>
                </div>
                <div id="modalSemana4Content" style="padding: 20px;"></div>
            </div>
        </div>

        <div class="footer">
            <p>Sistema de Gesti√≥n de Turnos v8.0 | Cuadrantes editables en tiempo real</p>
            <p>Haz clic en cualquier turno para editarlo</p>
        </div>
    </div>

    <!-- M√≥dulos JavaScript - Orden de carga cr√≠tico -->
    
    <!-- ‚è≥ GUARDIAS GLOBALES - Carga PRIMERO para evitar errores de referencias indefinidas -->
    <script src="js/guardias-globales.js"></script>
    
    <!-- ‚úÖ M√ìDULOS PRINCIPALES -->
    <script src="js/modules.js"></script>

    <!-- üöÄ FASE 1: SidebarSemana3Module - Carga ANTES de otros m√≥dulos para evitar dependencias -->
    <script src="js/controles-sidebar-semana3.js"></script>

    <!-- üè¢ FASE 2: Gesti√≥n de Departamentos - Sistema extensible -->
    <script src="js/departamentos-manager.js"></script>

    <!-- üè¢ CONSOLIDADO: Sistema Unificado de Departamentos (Interface Modular) -->
    <script src="js/consolidado-departamentos.js"></script>

    <!-- ÔøΩ TIPO DE TURNOS: Gesti√≥n de Tipos de Turnos (ma√±ana, tarde, noche, etc.) -->
    <script src="js/turnos-types-manager.js"></script>

    <!-- üìÖ CONSOLIDADO: Sistema Unificado de Tipos de Turnos (Interface Modular) -->
    <script src="js/consolidado-turnos.js"></script>

    <!-- üìç LOCALIDADES: Gesti√≥n de Localidades (Getafe, Legan√©s, Madrid, etc.) -->
    <script src="js/localidades-manager.js"></script>

    <!-- üìç CONSOLIDADO: Sistema Unificado de Localidades (Interface Modular) -->
    <script src="js/consolidado-localidades.js"></script>

    <!-- ÔøΩüìã FASE 2: Generador de Turnos por Departamento -->
    <script src="js/generador-turnos-departamentos.js"></script>

    <!-- ‚öñÔ∏è FASE 2: Balanceador Autom√°tico de Turnos -->
    <script src="js/balanceador-turnos.js"></script>

    <!-- ÔøΩ SISTEMA REACTIVO: Propagaci√≥n autom√°tica de cambios -->
    <script src="js/sistema-reactividad.js"></script>

    <!-- ÔøΩüîó FASE 2: Integraci√≥n UI de Departamentos -->
    <script src="js/ui-integracion-departamentos.js"></script>
    
    <!-- Diagn√≥stico de carga de m√≥dulos -->
    <script>
        // Peque√±a espera para asegurar que modules.js se ejecut√≥
        setTimeout(() => {
            console.log('üîç [DIAGN√ìSTICO] Estado despu√©s de modules.js:');
            console.log('   - window.TurnoManager:', typeof window.TurnoManager);
            console.log('   - window.TurnoManager.mostrarModalGeneracion:', typeof window.TurnoManager?.mostrarModalGeneracion);
            console.log('   - window.AppState:', typeof window.AppState);
            console.log('   - window.UI:', typeof window.UI);
            
            if (typeof window.TurnoManager?.mostrarModalGeneracion !== 'function') {
                console.error('‚ùå [DIAGN√ìSTICO] TurnoManager.mostrarModalGeneracion NO CARG√ì correctamente');
            } else {
                console.log('‚úÖ [DIAGN√ìSTICO] TurnoManager.mostrarModalGeneracion est√° disponible');
            }
        }, 100);
    </script>

    <!-- DocumentAnalyzer - An√°lisis inteligente de documentaci√≥n (sin API externa) -->
    <script src="js/documentAnalyzer.js"></script>

    <!-- OBSOLETO: Archivo antiguo de balanceo (reemplazado por FASE 2 - balanceador-turnos.js) -->
    <!-- <script src="js/balanceo-y-restricciones.js"></script> -->

    <!-- 3. Reportes avanzados y predicci√≥n de conflictos - DESHABILITADO TEMPORALMENTE -->
    <!-- <script src="js/reportes-y-prediccion.js"></script> -->

    <!-- 4. Soporte multi-local y multi-departamento - DESHABILITADO TEMPORALMENTE -->
    <!-- <script src="js/soporte-multilocal.js"></script> -->

    <!-- 5. Calendario visual interactivo -->
    <script src="js/calendario-visual.js"></script>

    <!-- ‚úÖ SEMANA 1: NUEVOS M√ìDULOS DE MEJORA -->
    <!-- 6. Validador centralizado de datos -->
    <script src="js/validador-datos.js"></script>

    <!-- 7. Autoguardado autom√°tico -->
    <script src="js/auto-save.js"></script>
    <!-- 7.1 UI del Autoguardado (Modular) -->
    <script src="js/auto-save-ui.js"></script>
    <!-- 7.2 Autoguardado con Persistencia BD (Modular) -->
    <script src="js/auto-save-bd.js"></script>

    <!-- 8. Sincronizaci√≥n entre pesta√±as -->
    <script src="js/tab-sync.js"></script>

    <!-- ‚úÖ VERIFICACI√ìN AUTOM√ÅTICA DEL SISTEMA A+B -->
    <script src="js/verificacion-automatica.js"></script>

    <!-- ‚úÖ SEMANA 2: NUEVOS M√ìDULOS AVANZADOS -->
    <!-- 9. Generador de reportes -->
    <script src="js/generador-reportes.js"></script>

    <!-- 10. Integraci√≥n con WhatsApp -->
    <script src="js/integracion-whatsapp.js"></script>

    <!-- 10.5. WhatsApp Sender (m√≥dulo independiente) -->
    <script src="js/whatsapp-sender.js"></script>

    <!-- 11. Sincronizaci√≥n de datos y backup -->
    <script src="js/sincronizacion-datos.js"></script>

    <!-- 11.5. Backup Manager (m√≥dulo independiente) -->
    <script src="js/backup-manager.js"></script>

    <!-- ‚úÖ SEMANA 3: M√ìDULOS ANAL√çTICA Y OPTIMIZACI√ìN -->
    <!-- 12. Analizador de conflictos -->
    <script src="js/analizador-conflictos.js"></script>

    <!-- 13. Dashboard con anal√≠tica -->
    <script src="js/dashboard-analytica.js"></script>

    <!-- 14. Optimizador inteligente de turnos -->
    <script src="js/optimizador-turnos.js"></script>

    <!-- 15. Controles UI para Semana 3 -->
    <script src="js/control-base.js"></script>

    <!-- 15. Controles UI para Semana 3 -->
    <script src="js/controles-semana-3.js"></script>

    <!-- 16. Controles UI para Semana 1 -->
    <script src="js/controles-semana-1.js"></script>

    <!-- 17. Controles UI para Semana 2 -->
    <script src="js/controles-semana-2.js"></script>

    <!-- 18. Gestor del Sidebar -->
    <script src="js/sidebar-manager.js"></script>

    <!-- 19. Debug Manager -->
    <script src="js/debug-manager.js"></script>

    <!-- Script para manejar las pesta√±as -->
    <script>
        setTimeout(() => {
            // Manejar el cambio de pesta√±as
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = e.target.dataset.tab;
                    
                    // Remover clase active de todos los botones y contenidos
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                    
                    // Agregar clase active al bot√≥n y contenido seleccionado
                    e.target.classList.add('active');
                    const selectedTab = document.getElementById(tabId);
                    if (selectedTab) {
                        selectedTab.classList.add('active');
                        console.log('‚úì Tab cambiado a:', tabId);
                    }
                });
            });
            console.log('‚úì Event listeners de tabs configurados');
        }, 100);
    </script>

    <!-- Script de inicializaci√≥n principal - REMOVIDO: botones ahora usan onclick inline -->
    
    <!-- Script para inicializar controles del calendario -->
    <script>
        setTimeout(() => {
            // Llenar selector de empleados en filtro del calendario
            const selectEmpleado = document.getElementById('filtroEmpleadoCalendario');
            if (selectEmpleado && Array.isArray(empleados)) {
                empleados.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `üë§ ${emp.nombre}`;
                    selectEmpleado.appendChild(option);
                });
            }

            // Llenar selector de empleados para informe individual
            const selectInforme = document.getElementById('selectEmpleado');
            if (selectInforme && Array.isArray(empleados)) {
                selectInforme.innerHTML = '<option value="">Selecciona un empleado</option>';
                empleados.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = emp.nombre;
                    selectInforme.appendChild(option);
                });

                // Agregar evento de cambio
                selectInforme.addEventListener('change', (e) => {
                    const empleadoId = parseInt(e.target.value);
                    if (empleadoId) {
                        const empleado = empleados.find(emp => emp.id === empleadoId);
                        if (empleado) {
                            AppState.selectedEmployee = empleado;
                            
                            // Mostrar vista previa
                            const vistaPrevia = document.getElementById('vistaPrevia');
                            const turnos = AppState.scheduleData.get(empleado.id) || [];
                            const diasTrabajados = turnos.filter(t => t.turno && t.turno !== 'descanso' && t.turno !== 'vacaciones' && t.turno !== 'baja').length;
                            
                            document.getElementById('nombreEmpleado').textContent = empleado.nombre;
                            document.getElementById('deptoEmpleado').textContent = empleado.departamento;
                            document.getElementById('horasEmpleado').textContent = empleado.horasContrato + 'h';
                            document.getElementById('turnoEmpleado').textContent = empleado.turnoPrincipal;
                            document.getElementById('diasEmpleado').textContent = diasTrabajados;
                            
                            vistaPrevia.style.display = 'block';
                            
                            // Actualizar cuadrante individual
                            mostrarCuadranteEmpleado(empleado.id);
                            actualizarEstadisticasIndividual();
                        }
                    } else {
                        AppState.selectedEmployee = null;
                        document.getElementById('vistaPrevia').style.display = 'none';
                        document.getElementById('cuadranteIndividual').innerHTML = '';
                    }
                });
            }
        }, 100);
    </script>

    <!-- Script de inicializaci√≥n final - M√ìDULOS PRINCIPALES -->
    <script>
        // ‚úÖ C√ìDIGO DE TURNO–ú–ê–ùAGER Y EDICION MASIVA
        // Variables para control de navegaci√≥n del informe individual
        let mesIndividual = new Date().getMonth();
        let anioIndividual = new Date().getFullYear();

        // Cambiar mes en la pesta√±a de informe individual
        // Llenar opciones de localidades
        function llenarCentrosDeTrabajo() {
            const selectCentro = document.getElementById('selectCentroTrabajo');
            if (!selectCentro) return;
            
            // Usar localidades del LocationManager si est√° disponible
            const localidades = (typeof LocationManager !== 'undefined' && LocationManager.localidades) 
                ? LocationManager.localidades.map(l => l.nombre).sort()
                : [...new Set(empleados.map(e => e.localidad || 'Sin especificar'))].sort();
            
            localidades.forEach(localidad => {
                const option = document.createElement('option');
                option.value = localidad;
                option.textContent = localidad;
                selectCentro.appendChild(option);
            });
        }

        // Funci√≥n para mostrar el cuadrante de un empleado seleccionado
        function mostrarCuadranteEmpleado(empleadoId) {
            const cuadranteIndividual = document.getElementById('cuadranteIndividual');
            if (!cuadranteIndividual) return;

            // üîß GARANTIZAR QUE USAMOS LOS EMPLEADOS ACTUALES (desde localStorage)
            const empleadosActuales = JSON.parse(localStorage.getItem('empleadosData') || '[]');
            const empleado = empleadosActuales.find(e => e.id === empleadoId) || empleados.find(e => e.id === empleadoId);
            if (!empleado) return;

            const turnos = AppState.scheduleData.get(empleadoId) || [];
            const mes = AppState.currentMonth;
            const anio = AppState.currentYear;

            // Obtener el n√∫mero de d√≠as en el mes
            const diasEnMes = new Date(anio, mes + 1, 0).getDate();
            const primerDia = new Date(anio, mes, 1).getDay();

            // Obtener los tipos de turno disponibles
            const tiposTurnoList = JSON.parse(localStorage.getItem('tiposTurnoData')) || {};
            // üîß CORRECCI√ìN: Crear array con claves incluidas
            const tiposTurnoArray = Object.entries(tiposTurnoList).map(([key, value]) => ({
                key,
                ...value
            }));

            // üîß BUG FIX: Filtrar turnos del mes/a√±o actual solamente
            const turnosDelMes = turnos.filter(t => {
                if (!t.fecha) return t.dia >= 1 && t.dia <= diasEnMes; // Fallback
                const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                return fecha.getMonth() === mes && fecha.getFullYear() === anio;
            });

            // Calcular estad√≠sticas
            const ma√±anas = turnosDelMes.filter(t => t.turno === 'ma√±ana').length;
            const tardes = turnosDelMes.filter(t => t.turno === 'tarde').length;
            const noches = turnosDelMes.filter(t => t.turno === 'noche').length;
            const vacaciones = turnosDelMes.filter(t => t.turno === 'vacaciones').length;
            const baja = turnosDelMes.filter(t => t.turno === 'baja').length;
            const descansos = turnosDelMes.filter(t => t.turno === 'descanso' || t.turno === 'libre').length;
            const diasTrabajados = turnosDelMes.filter(t => t.turno && !['descanso', 'libre', 'baja', 'vacaciones'].includes(t.turno)).length;
            
            // üîß BUG FIX: Contar guardias correctamente
            // Guardia = Domingo trabajado O festivo trabajado O turno espec√≠ficamente marcado como guardia
            const guardias = turnosDelMes.filter(t => {
                if (!t.fecha) return false;
                const diaSemana = t.fecha.getDay ? t.fecha.getDay() : new Date(t.fecha).getDay();
                const esDomingo = diaSemana === 0;
                // üîß MEJORADO: Usar festivos locales del empleado en lugar de globales
                const esFestivoTrabajado = typeof esFestivoLocal === 'function' 
                    ? esFestivoLocal(t.fecha, empleadoId) 
                    : esFestivo(t.fecha);
                const esGuardiaEspec√≠fica = t.turno && (t.turno.includes('guardia') || t.turno.includes('domingo'));
                
                // Contar como guardia si:
                // 1. Es domingo Y tiene un turno trabajado (no descansa)
                // 2. Es festivo (local) Y tiene un turno trabajado
                // 3. El turno est√° espec√≠ficamente marcado como guardia
                const turnoTrabajado = t.turno && !['descanso', 'libre', 'baja', 'vacaciones', 'festivo'].includes(t.turno);
                return (esDomingo && turnoTrabajado) || (esFestivoTrabajado && turnoTrabajado) || esGuardiaEspec√≠fica;
            }).length;

            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            // Calcular total de horas directamente desde los turnos guardados
            const totalHoras = Math.round(turnosDelMes.reduce((sum, t) => sum + (t.horas || 0), 0) * 100) / 100;

            // Crear HTML del modal
            let html = `
                <div style="background: #0f172a; border-radius: 16px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.7); padding: 0;">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%); padding: 20px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10;">
                        <h2 style="margin: 0; color: white; font-size: 28px; font-weight: 700;">üìÖ Cuadrante del Empleado</h2>
                        <button class="btn-whatsapp-modal" onclick="exportarEmpleado(${empleadoId}, '${meses[mes] || 'Mes'}', ${anio}, 'whatsapp')" title="Enviar informe por WhatsApp" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(34, 197, 94, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(34, 197, 94, 0.3)'">
                            üì± WhatsApp
                        </button>
                        <button onclick="document.getElementById('cuadranteIndividual').style.display = 'none'; document.getElementById('cuadranteIndividual').innerHTML = '';" style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 16px;">‚úñ Cerrar</button>
                    </div>

                    <!-- Contenido -->
                    <div style="padding: 18px;">
                        <!-- Informaci√≥n del Empleado -->
                        <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #475569;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px;">
                                <div style="padding: 15px; background: linear-gradient(135deg, #a78bfa 0%, rgba(139, 92, 246, 0.2) 100%); border-radius: 8px; border-left: 4px solid #a78bfa;">
                                    <div style="color: #0f172a; font-size: 14px; font-weight: 600;">üë§ EMPLEADO</div>
                                    <div style="color: #f1f5f9; font-size: 18px; font-weight: 700; margin-top: 6px;">${empleado.nombre}</div>
                                </div>
                                <div style="padding: 15px; background: linear-gradient(135deg, #60a5fa 0%, rgba(59, 130, 246, 0.2) 100%); border-radius: 8px; border-left: 4px solid #60a5fa;">
                                    <div style="color: #0f172a; font-size: 14px; font-weight: 600;">üè¢ DEPARTAMENTO</div>
                                    <div style="color: #f1f5f9; font-size: 18px; font-weight: 700; margin-top: 6px;">${empleado.departamento || 'N/A'}</div>
                                </div>
                                <div style="padding: 15px; background: linear-gradient(135deg, #34d399 0%, rgba(16, 185, 129, 0.2) 100%); border-radius: 8px; border-left: 4px solid #34d399;">
                                    <div style="color: #0f172a; font-size: 14px; font-weight: 600;">‚è±Ô∏è HORAS CONTRATO</div>
                                    <div style="color: #f1f5f9; font-size: 18px; font-weight: 700; margin-top: 6px;">${empleado.horasContrato}h</div>
                                </div>
                                <div style="padding: 15px; background: linear-gradient(135deg, #fbbf24 0%, rgba(245, 158, 11, 0.2) 100%); border-radius: 8px; border-left: 4px solid #fbbf24;">
                                    <div style="color: #0f172a; font-size: 14px; font-weight: 600;">üéØ TURNO PRINCIPAL</div>
                                    <div style="color: #f1f5f9; font-size: 18px; font-weight: 700; margin-top: 6px;">${empleado.turnoPrincipal || 'N/A'}</div>
                                </div>
                                <div style="padding: 15px; background: linear-gradient(135deg, #d8b4fe 0%, rgba(168, 85, 247, 0.2) 100%); border-radius: 8px; border-left: 4px solid #d8b4fe;">
                                    <div style="color: #0f172a; font-size: 14px; font-weight: 600;">üìä D√çAS TRABAJADOS</div>
                                    <div style="color: #f1f5f9; font-size: 18px; font-weight: 700; margin-top: 6px;">${diasTrabajados}</div>
                                </div>
                                <div style="padding: 15px; background: linear-gradient(135deg, #fca5a5 0%, rgba(239, 68, 68, 0.2) 100%); border-radius: 8px; border-left: 4px solid #fca5a5;">
                                    <div style="color: #0f172a; font-size: 14px; font-weight: 600;">üö® GUARDIAS</div>
                                    <div style="color: #fca5a5; font-size: 18px; font-weight: 700; margin-top: 6px;">${guardias}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Calendario -->
                        <div style="margin-bottom: 12px;">
                            <h3 style="color: #f1f5f9; margin: 0 0 10px 0; font-size: 20px; font-weight: 700;">üìÜ ${meses[mes]} ${anio}</h3>
                            <div style="background: #1e293b; border-radius: 12px; padding: 10px; border: 1px solid #475569;">
                                <!-- D√≠as de la semana -->
                                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px;">
                                    ${['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'].map(dia => 
                                        `<div style="text-align: center; color: #94a3b8; font-weight: 700; font-size: 13px; padding: 8px;">${dia}</div>`
                                    ).join('')}
                                </div>
                                <!-- D√≠as del mes -->
                                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px;">
                                    ${Array(primerDia).fill(0).map(() => 
                                        `<div style="min-height: 45px; background: #0f172a; border-radius: 6px;"></div>`
                                    ).join('')}
                                    ${Array.from({length: diasEnMes}, (_, i) => {
                                        const dia = i + 1;
                                        const turno = turnosDelMes.find(t => t.dia === dia);
                                        // üîß CORRECCI√ìN: Buscar tipoTurno por clave, no por nombre
                                        const tipoTurno = tiposTurnoArray.find(tt => tt.key === turno?.turno) ||
                                                         tiposTurnoArray.find(tt => lowerCaseSafe(tt.nombre) === lowerCaseSafe(turno?.turno));
                                        const color = tipoTurno?.color || '#e2e3e5';
                                        const inicial = tipoTurno?.inicial || turno?.turno || '-';
                                        
                                        // üîß MEJORADO: Detectar domingos y festivos locales del empleado
                                        const fecha = new Date(anio, mes, dia);
                                        const diaSemana = fecha.getDay();
                                        const esDomingo = diaSemana === 0;
                                        // üîß NUEVO: Usar festivos locales del empleado en lugar de globales
                                        const esFestivo = typeof window.esFestivoLocal === 'function' 
                                            ? window.esFestivoLocal(fecha, empleadoId)
                                            : (typeof window.esFestivo === 'function' ? window.esFestivo(fecha) : false);
                                        const esGuardiaPotencial = esDomingo || esFestivo;
                                        
                                        // üîß MEJORADO: Efecto 3D intenso con gradiente para cuadrante individual (hinchadas)
                                        const backgroundGradient = `linear-gradient(135deg, ${color}44 0%, ${color}ff 100%)`;  // Gradiente intenso (27% a 100%)
                                        const sombraGuardia = esGuardiaPotencial ? '0 0 12px rgba(255, 107, 107, 0.6), inset 0 0 8px rgba(255, 107, 107, 0.2)' : 'inset 0 4px 12px rgba(0, 0, 0, 0.18)';  // Sombra m√°s profunda
                                        
                                        // Estilo especial para domingos/festivos
                                        const bordeGuardia = esGuardiaPotencial ? '3px solid #ff6b6b' : '2px solid transparent';
                                        const bgOpacity = esGuardiaPotencial ? '1' : '1';
                                        
                                        return `
                                            <div style="min-height: 45px; background: ${backgroundGradient}; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; border: ${bordeGuardia}; position: relative; box-shadow: ${sombraGuardia}; opacity: ${bgOpacity};" 
                                                 onmouseover="this.style.transform='scale(1.08)'; this.style.boxShadow='0 0 20px rgba(255,255,255,0.4), 0 4px 16px rgba(0,0,0,0.5)'; this.style.borderColor='#fff';" 
                                                 onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='${sombraGuardia}'; this.style.borderColor='${esGuardiaPotencial ? '#ff6b6b' : 'transparent'}';"
                                                 onclick="TurnoEditor.abrirEditorTurno(${empleadoId}, ${dia}, ${mes}, ${anio})"
                                                 title="Clic para editar - ${turno?.turno || 'Sin turno'} - ${turno?.horas || 0}h${esGuardiaPotencial ? ' üö® GUARDIA POTENCIAL' : ''}">
                                                <div style="text-align: center; z-index: 1;">
                                                    <div style="font-size: 13px; color: #fb923c; font-weight: 700;">${dia}</div>
                                                    <div style="font-size: 28px; color: #0f172a; font-weight: 900; margin-top: 1px;">${inicial}</div>
                                                    ${esGuardiaPotencial ? '<div style="font-size: 10px; color: #ff6b6b; font-weight: 700; margin-top: 2px;">üö®</div>' : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>

                        
                        <!-- üîß RESUMEN INTELIGENTE - Atributos data para JS externo -->
                        <div id="resumenInteligente_${empleadoId}" data-emp-id="${empleadoId}" data-mes="${mes}" data-anio="${anio}" style="background: linear-gradient(135deg, #34d399 0%, rgba(16, 185, 129, 0.2) 100%); padding: 20px; border-radius: 12px; border: 1px solid #475569; margin-bottom: 20px;">
                            <!-- Se llenar√° autom√°ticamente por JS externo -->
                            <h3 style="color: #f1f5f9; margin: 0 0 15px 0; font-size: 16px; font-weight: 700;">üìä Resumen de Turnos</h3>
                            <div class="placeholder-summary">Cargando resumen...</div>
                        </div>

                    </div>
                </div>
            `;

            cuadranteIndividual.innerHTML = html;
            cuadranteIndividual.style.display = 'flex';
            
            // üîß GUARDAR HTML DEL CUADRANTE PARA LA EXPORTACI√ìN
            window.htmlCuadranteActual = html;
            
            // üî• REGISTRAR OBSERVADOR PARA SINCRONIZACI√ìN AUTOM√ÅTICA (solo una vez)
            if (typeof DataChangeManager !== 'undefined' && !window._cuadranteIndividualObserverRegistrado) {
                const observador = (cambio) => {
                    // Evitar bucles: no actualizar si estamos en medio de una actualizaci√≥n
                    if (window._cuadranteIndividualActualizando) {
                        console.log('[mostrarCuadranteEmpleado] ‚è∏Ô∏è Saltando actualizaci√≥n (ya en proceso)');
                        return;
                    }

                    // Solo actualizar si el cambio afecta a este empleado O es un cambio de mes
                    if (cambio.type === 'SHIFT_CHANGED' && cambio.data.empleadoId === empleadoId) {
                        console.log('[mostrarCuadranteEmpleado] üîÑ Detectado cambio de turno, actualizando vista...');
                        window._cuadranteIndividualActualizando = true;
                        mostrarCuadranteEmpleado(empleadoId);  // Volver a renderizar
                        window._cuadranteIndividualActualizando = false;
                    } else if (cambio.type === 'BULK_CHANGES') {
                        const afectaAEsteEmpleado = cambio.data.cambios?.some(c => c.empleadoId === empleadoId);
                        if (afectaAEsteEmpleado) {
                            console.log('[mostrarCuadranteEmpleado] üîÑ Detectados cambios en lote, actualizando vista...');
                            window._cuadranteIndividualActualizando = true;
                            mostrarCuadranteEmpleado(empleadoId);
                            window._cuadranteIndividualActualizando = false;
                        }
                    } else if (cambio.type === 'MONTH_CHANGED') {
                        // Actualizar cuando se cambia de mes
                        window._cuadranteIndividualActualizando = true;
                        mostrarCuadranteEmpleado(empleadoId);
                        window._cuadranteIndividualActualizando = false;
                    }
                };

                // Suscribirse al sistema de cambios
                DataChangeManager.subscribe(observador);
                console.log('[mostrarCuadranteEmpleado] ‚úÖ Observador registrado para empleado:', empleadoId);

                // Marcar que ya se registr√≥ para este empleado
                window._cuadranteIndividualObserverRegistrado = true;
                window._cuadranteIndividualObserver = observador;
            }
        }

        // Cerrar modal al hacer clic fuera de la tabla
        document.addEventListener('DOMContentLoaded', function() {
            const cuadranteIndividual = document.getElementById('cuadranteIndividual');
            if (cuadranteIndividual) {
                cuadranteIndividual.addEventListener('click', function(e) {
                    if (e.target === this) {
                        cuadranteIndividual.style.display = 'none';
                        cuadranteIndividual.innerHTML = '';
                    }
                });
                // Cerrar con tecla ESC
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && cuadranteIndividual.style.display === 'flex') {
                        cuadranteIndividual.style.display = 'none';
                        cuadranteIndividual.innerHTML = '';
                    }
                });
            }
        });

        // Funci√≥n para actualizar las estad√≠sticas del empleado
        function actualizarEstadisticasIndividual() {
            const empleadoId = AppState.selectedEmployee?.id;
            if (!empleadoId) return;

            const turnos = AppState.scheduleData.get(empleadoId) || [];
            const tiposTurnoList = JSON.parse(localStorage.getItem('tiposTurnoData')) || {};
            // üîß CORRECCI√ìN: Crear array con claves incluidas
            const tiposTurnoArray = Object.entries(tiposTurnoList).map(([key, value]) => ({
                key,
                ...value
            }));

            // üîß BUG FIX: Filtrar turnos del mes/a√±o actual
            const mes = AppState.currentMonth;
            const anio = AppState.currentYear;
            const turnosDelMes = turnos.filter(t => {
                if (!t.fecha) return false;
                const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                return fecha.getMonth() === mes && fecha.getFullYear() === anio;
            });

            // Calcular estad√≠sticas
            let totalHoras = 0;
            let turnosMa√±ana = 0;
            let turnosTarde = 0;
            let turnosNoche = 0;
            let diasVacaciones = 0;
            let diasBaja = 0;
            let diasDescanso = 0;

            turnosDelMes.forEach(t => {
                totalHoras += t.horas || 0;
                
                // Comparar por nombre completo del turno, no por inicial
                if (t.turno === 'ma√±ana') turnosMa√±ana++;
                else if (t.turno === 'tarde') turnosTarde++;
                else if (t.turno === 'noche') turnosNoche++;
                else if (t.turno === 'vacaciones') diasVacaciones++;
                else if (t.turno === 'baja') diasBaja++;
                else if (t.turno === 'descanso') diasDescanso++;
            });

            // Crear HTML de estad√≠sticas
            const estadisticasDiv = document.getElementById('estadisticasIndividual');
            if (estadisticasDiv) {
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">';
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Total Horas</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${totalHoras}h</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Ma√±anas</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${turnosMa√±ana}</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Tardes</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${turnosTarde}</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Noches</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${turnosNoche}</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Vacaciones</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${diasVacaciones}</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Baja</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${diasBaja}</div></div>`;
                html += `<div style="background: rgba(14, 165, 233, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;"><div style="color: #94a3b8; font-size: 12px;">Descansos</div><div style="color: #f1f5f9; font-size: 20px; font-weight: bold;">${diasDescanso}</div></div>`;
                html += '</div>';
                estadisticasDiv.innerHTML = html;
            }
        }

        // Aplicar filtros y mostrar resultados
        function aplicarFiltrosInforme() {
            const localidad = document.getElementById('selectCentroTrabajo').value;
            const departamento = document.getElementById('selectDepartamentoIndividual').value;
            const mes = parseInt(document.getElementById('selectMesIndividual').value);
            const anio = parseInt(document.getElementById('selectAnioIndividual').value);
            
            // Filtrar empleados por localidad y departamento
            let empleadosFiltrados = empleados;
            if (localidad) {
                empleadosFiltrados = empleadosFiltrados.filter(e => (e.localidad || 'Sin especificar') === localidad);
            }
            if (departamento) {
                empleadosFiltrados = empleadosFiltrados.filter(e => e.departamento === departamento);
            }
            
            if (empleadosFiltrados.length === 0) {
                let msg = 'No hay empleados con los filtros seleccionados.';
                document.getElementById('tablaResultados').innerHTML = `<p style="text-align: center; color: #cbd5e1;">${msg}</p>`;
                return;
            }
            
            // Construir tabla
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            let titulo = '';
            if (localidad && departamento) {
                titulo = `üìç ${localidad} - üè¢ ${departamento}`;
            } else if (localidad) {
                titulo = `üìç ${localidad}`;
            } else if (departamento) {
                titulo = `üè¢ ${departamento}`;
            } else {
                titulo = 'üìã Todos los empleados';
            }
            
            let html = `
                <h3 style="color: #a855f7; margin-bottom: 20px; font-size: 26px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                    ${titulo} - ${meses[mes]} ${anio}
                </h3>
                <div style="overflow-x: auto; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.3);">
                    <table class="cuadrante-empleado-table">
                        <thead>
                            <tr>
                                <th>Empleado</th>
                                <th>Horas</th>
                                <th>Turnos Noche</th>
                                <th>Vacaciones</th>
                                <th>Balance</th>
                                <th>Cumplimiento</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Agregar filas para cada empleado
            empleadosFiltrados.forEach(empleado => {
                const turnos = AppState.scheduleData.get(empleado.id) || [];
                
                // Calcular total de horas directamente desde los turnos guardados
                const totalHoras = Math.round(turnos.reduce((sum, t) => sum + (t.horas || 0), 0) * 100) / 100;
                
                const turnosNoche = turnos.filter(t => t.turno === 'noche').length;
                const vacaciones = turnos.filter(t => t.turno === 'vacaciones' || t.turno === 'baja').length;
                const balance = totalHoras - empleado.horasContrato;
                const cumplimiento = Math.round((totalHoras / empleado.horasContrato) * 100);
                
                const balanceColor = balance >= 0 ? '#22c55e' : '#ef4444';
                const bgHover = empleadosFiltrados.indexOf(empleado) % 2 === 0 ? 'rgba(168, 85, 247, 0.05)' : 'rgba(236, 72, 153, 0.05)';
                
                html += `
                    <tr style="background: ${bgHover};">
                        <td style="font-weight: 700; color: #a855f7;">${empleado.nombre}</td>
                        <td>${totalHoras}h</td>
                        <td>${turnosNoche}</td>
                        <td>${vacaciones}</td>
                        <td style="background: ${balance >= 0 ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; color: ${balanceColor}; font-weight: 700;">${balance >= 0 ? '+' : ''}${balance}h</td>
                        <td style="font-weight: 700; color: ${cumplimiento >= 100 ? '#22c55e' : cumplimiento >= 80 ? '#f59e0b' : '#ef4444'};">${cumplimiento}%</td>
                        <td>
                            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                                <button onclick="exportarEmpleado(${empleado.id}, '${meses[mes]}', ${anio}, 'pdf')" title="PDF" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.3)'">üìÑ</button>
                                <button onclick="enviarWhatsAppEmpleadoDirecto(${empleado.id}, '${meses[mes]}', ${anio})" title="WhatsApp" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(34, 197, 94, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(34, 197, 94, 0.3)'">üì§</button>
                                <button onclick="exportarEmpleado(${empleado.id}, '${meses[mes]}', ${anio}, 'csv')" title="Excel" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(14, 165, 233, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(14, 165, 233, 0.3)'">üìä</button>
                                <button onclick="exportarEmpleado(${empleado.id}, '${meses[mes]}', ${anio}, 'ical')" title="Calendario iCalendar" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(139, 92, 246, 0.3)'">üóìÔ∏è</button>
                                <button onclick="exportarEmpleado(${empleado.id}, '${meses[mes]}', ${anio}, 'copy')" title="Copiar" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%); color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(100, 116, 139, 0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(100, 116, 139, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(100, 116, 139, 0.3)'">üìã</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('tablaResultados').innerHTML = html;
        }

        // Obtener color del turno
        function getTurnoColor(turno) {
            const colores = {
                'ma√±ana': '#d4edda',
                'tarde': '#fff3cd',
                'noche': '#f8d7da',
                'guardia': '#d8b4fe',
                'mixto': '#cce5ff',
                'asuntospropios': '#e0e7ff',
                'descanso': '#e2e3e5',
                'vacaciones': '#d0ebff',
                'baja': '#ffe3e3',
                'libre': '#f9f9f9',
                'festivo': '#fff9e6'
            };
            return colores[turno] || '#ffffff';
        }

        // Funci√≥n para exportar datos de un empleado
        // =====================================================================================
        // üî∂ UTILIDADES DE EXPORTACI√ìN VISUAL (PDF PARA WHATSAPP Y REPORTES INDIVIDUALES)
        // =====================================================================================
        const lowerCaseSafe = (valor) => (valor === undefined || valor === null) ? '' : String(valor).toLowerCase();

        function calcularHorasDelHorario(horario) {
            if (!horario || typeof horario !== 'string') return '';
            const match = horario.match(/(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/);
            if (!match) return '';
            const horaInicio = parseInt(match[1]);
            const minInicio = parseInt(match[2]);
            const horaFin = parseInt(match[3]);
            const minFin = parseInt(match[4]);
            
            let totalMinutos = (horaFin * 60 + minFin) - (horaInicio * 60 + minInicio);
            if (totalMinutos < 0) totalMinutos += 24 * 60; // Para turnos nocturnos que cruzan medianoche
            
            const horas = totalMinutos / 60;
            return horas % 1 === 0 ? `${Math.round(horas)}` : `${horas.toFixed(1)}`;
        }

        function obtenerInfoTurnoVisualPDF(nombre, tiposTurnoData) {
            const paletaFallback = {
                'ma√±ana': '#86efac',
                'tarde': '#fcd34d',
                'noche': '#93c5fd',
                'mixto': '#fde68a',
                'descanso': '#cbd5f5',
                'vacaciones': '#fecdd3',
                'baja': '#fda4af',
                'libre': '#e0e7ff',
                'festivo': '#fef3c7'
            };
            if (!nombre) {
                return { etiqueta: 'Sin turno', inicial: '-', color: 'rgba(148,163,184,0.25)', horario: '', horas: '' };
            }
            const lower = lowerCaseSafe(nombre);
            
            // üîß MEJORADO: Buscar primero por clave directa, luego por nombre/id
            // Esto es importante para turnos personalizados como "tarde6" o "asuntospropios"
            let coincidencia = tiposTurnoData?.[nombre] || tiposTurnoData?.[lower];
            
            if (!coincidencia) {
                // Si no encuentra por clave, busca por nombre o id en los valores
                const lista = Object.values(tiposTurnoData || {});
                coincidencia = lista.find(t => lowerCaseSafe(t?.nombre) === lower || lowerCaseSafe(t?.id) === lower);
            }
            
            // Prioridad: obtener horas del tipo de turno
            let horas = coincidencia?.horas || '';
            if (!horas && coincidencia?.horario) {
                horas = calcularHorasDelHorario(coincidencia.horario);
            }
            
            // üîß CORRECCI√ìN: Mostrar horario correctamente (no mezclar con horas)
            const horario = coincidencia?.horario || '';
            
            // üîß MEJORADO: Devolver el inicial completo (puede tener 1, 2 o m√°s letras)
            // No truncar - el campo inicial ya contiene exactamente lo que se debe mostrar
            return {
                etiqueta: coincidencia?.nombre || nombre,
                inicial: coincidencia?.inicial || nombre.substring(0, 1).toUpperCase(),
                color: coincidencia?.color || paletaFallback[lower] || 'rgba(148,163,184,0.25)',
                horario: horario,
                horas: horas
            };
        }

        function calcularResumenTurnosPDF(turnos, empleadoId) {
            const limpio = Array.isArray(turnos) ? turnos : [];
            const trabajados = limpio.filter(t => t?.turno && !['descanso','libre','baja','vacaciones','festivo'].includes(t.turno)).length;
            const descansos = limpio.filter(t => t?.turno && ['descanso','libre'].includes(t.turno)).length;
            const vacaciones = limpio.filter(t => t?.turno === 'vacaciones').length;
            const noches = limpio.filter(t => t?.turno === 'noche').length;
            const guardias = limpio.filter(t => {
                if (!t?.fecha) return false;
                const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                const esDomingo = fecha.getDay() === 0;
                const esFestivoTrabajado = typeof window.esFestivoLocal === 'function'
                    ? window.esFestivoLocal(fecha, empleadoId)
                    : (typeof window.esFestivo === 'function' ? window.esFestivo(fecha) : false);
                const esGuardiaMarcada = lowerCaseSafe(t?.turno).includes('guardia');
                const turnoTrabajado = t.turno && !['descanso','libre','baja','vacaciones','festivo'].includes(t.turno);
                return (esDomingo && turnoTrabajado) || (esFestivoTrabajado && turnoTrabajado) || esGuardiaMarcada;
            }).length;
            return { trabajados, descansos, vacaciones, noches, guardias };
        }

        function construirCalendarioVisualPDF({ turnos, mesNum, anio, empleadoId, tiposTurnoData }) {
            const diasSemana = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];
            const diasEnMes = new Date(anio, mesNum + 1, 0).getDate();
            const primerDia = new Date(anio, mesNum, 1).getDay();
            const offset = (primerDia + 6) % 7; // Empezar en lunes
            const totalCeldas = Math.ceil((offset + diasEnMes) / 7) * 7;
            const mapaTurnos = new Map();
            (turnos || []).forEach(t => {
                if (!t) return;
                const fecha = t.fecha instanceof Date ? t.fecha : (t.fecha ? new Date(t.fecha) : new Date(anio, mesNum, t.dia || 1));
                const dia = t.dia || fecha.getDate();
                mapaTurnos.set(dia, { ...t, fecha });
            });

            const celdas = [];
            for (let i = 0; i < totalCeldas; i++) {
                const dia = i - offset + 1;
                if (dia < 1 || dia > diasEnMes) {
                    celdas.push('<div style="min-height:140px; border-radius:18px; background:rgba(15,23,42,0.35);"></div>');
                    continue;
                }
                const turnoDia = mapaTurnos.get(dia);
                const fechaRepr = new Date(anio, mesNum, dia);
                const esDomingo = fechaRepr.getDay() === 0;
                const esFestivo = typeof window.esFestivoLocal === 'function'
                    ? window.esFestivoLocal(fechaRepr, empleadoId)
                    : (typeof window.esFestivo === 'function' ? window.esFestivo(fechaRepr) : false);
                const turnoNormalizado = lowerCaseSafe(turnoDia?.turno);
                const esGuardia = esDomingo || esFestivo || turnoNormalizado.includes('guardia');
                const infoTurno = obtenerInfoTurnoVisualPDF(turnoDia?.turno, tiposTurnoData);
                
                // üîß MEJORADO: Priorizar datos del turno individual si est√°n disponibles
                const horario = turnoDia?.horario || infoTurno.horario || '';
                const horasDelTurno = turnoDia?.horas || infoTurno.horas || '';
                const horas = horasDelTurno ? `${horasDelTurno}h` : '';
                
                const badgeTextColor = turnoDia ? '#0f172a' : '#cbd5f5';
                const guardiaBadge = esGuardia ? '<span style="padding:4px 10px; border-radius:999px; background:rgba(248,113,113,0.2); color:#fecaca; font-size:11px; font-weight:600; text-transform:uppercase;">Guardia</span>' : '';
                const contexto = esFestivo ? 'Festivo' : (esDomingo ? 'Domingo' : '');
                const contextoHtml = contexto ? `<span style="font-size:11px; color:#94a3b8;">${contexto}</span>` : '';
                
                // üîß MEJORADO: Efecto 3D con capas de color
                // Crear un color m√°s claro (version clara del turno) para el fondo base
                const bgColor = infoTurno.color || 'rgba(15,23,42,0.35)';
                // Agregar gradiente suave del color original superpuesto para efecto 3D
                const backgroundGradient = `linear-gradient(135deg, ${bgColor}88 0%, ${bgColor}cc 100%)`;
                const borderColor = esGuardia ? '3px solid #ff6b6b' : '2px solid transparent';
                const boxShadow = esGuardia ? '0 0 12px rgba(255, 107, 107, 0.6), inset 0 0 8px rgba(255, 107, 107, 0.2)' : 'inset 0 2px 8px rgba(0, 0, 0, 0.1)';
                
                celdas.push(`
                    <div style="min-height:140px; border-radius:20px; background:${backgroundGradient}; padding:14px; border:${borderColor}; box-shadow:${boxShadow}; display:flex; flex-direction:column; justify-content:space-between; align-items:center; text-align:center; gap:8px; transition:all 0.3s ease;">
                        <div style="width:100%;">
                            <span style="font-size:28px; font-weight:700; color:#0f172a;">${dia}</span>
                        </div>
                        <div style="width:100%;">
                            <div style="display:inline-block; padding:6px 12px; border-radius:999px; background:transparent; color:#0f172a; font-weight:700; font-size:28px; line-height:1.4;">${infoTurno.inicial}</div>
                        </div>
                        ${horas ? `<div style="font-size:13px; font-weight:600; color:#0f172a; letter-spacing:0.5px;">${horas}</div>` : ''}
                        ${horario ? `<div style="font-size:11px; color:#0f172a;">${horario}</div>` : ''}
                        ${guardiaBadge}
                        ${contextoHtml}
                    </div>
                `);
            }

            return `
                <div style="margin-top:10px;">
                    <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:12px; margin-bottom:12px;">
                        ${diasSemana.map(d => `<div style="text-align:center; font-size:12px; letter-spacing:0.1em; text-transform:uppercase; color:#94a3b8;">${d}</div>`).join('')}
                    </div>
                    <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:12px;">
                        ${celdas.join('')}
                    </div>
                </div>
            `;
        }

        function crearTarjetaInfoPDF(titulo, valor, detalle, background, icono = 'üìä') {
            return `
                <div style="border-radius:24px; padding:24px; background:${background}; display:flex; flex-direction:column; gap:10px; box-shadow:0 8px 32px rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); backdrop-filter:blur(10px); transition:all 0.3s ease;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:20px;">${icono}</span>
                        <span style="font-size:11px; text-transform:uppercase; letter-spacing:0.15em; color:rgba(255,255,255,0.7); font-weight:600;">${titulo}</span>
                    </div>
                    <span style="font-size:32px; font-weight:800; color:#fff; line-height:1.2;">${valor}</span>
                    ${detalle ? `<span style="font-size:12px; color:rgba(255,255,255,0.8); line-height:1.4;">${detalle}</span>` : ''}
                </div>
            `;
        }

        // COMENTADA: Funci√≥n PDF original - AHORA USAMOS IMAGEN EN SU LUGAR
        /*
        async function generarPDFCuadranteVisual(informe) {
            try {
                console.log('üîµ [generarPDFCuadranteVisual] Iniciando con informe:', informe);
                const { empleado, turnos, mes, anio, mesNum, totalHoras } = informe || {};
                if (!empleado) throw new Error('No hay empleado para generar el PDF');
                console.log('‚úÖ [generarPDFCuadranteVisual] Empleado:', empleado.nombre);
            const tiposTurnoData = JSON.parse(localStorage.getItem('tiposTurnoData') || '{}');
            const resumen = calcularResumenTurnosPDF(turnos || [], empleado.id);
            const horasContrato = parseFloat(empleado.horasContrato) || 0;
            const balance = (totalHoras || 0) - horasContrato;
            const cumplimiento = horasContrato > 0 ? Math.round(((totalHoras || 0) / horasContrato) * 100) : 0;

            const wrapper = document.createElement('div');
            wrapper.style.position = 'fixed';
            wrapper.style.left = '-9999px';
            wrapper.style.top = '0';
            wrapper.style.zIndex = '-1';

            const content = document.createElement('div');
            content.style.width = '1400px';
            content.style.padding = '48px';
            content.style.background = 'linear-gradient(135deg, #0b1220, #111827)';
            content.style.borderRadius = '32px';
            content.style.boxShadow = '0 40px 80px rgba(0,0,0,0.55)';
            content.style.fontFamily = "'Poppins','Segoe UI',sans-serif";
            content.style.color = '#f8fafc';

            const tarjetas = [
                crearTarjetaInfoPDF('Empleado', empleado.nombre, empleado.departamento || 'Sin depto', 'linear-gradient(135deg,#6366f1,#8b5cf6)', 'üë§'),
                crearTarjetaInfoPDF('Localidad', empleado.localidad || 'N/D', empleado.turnoPrincipal || 'Sin turno', 'linear-gradient(135deg,#0ea5e9,#38bdf8)', 'üìç'),
                crearTarjetaInfoPDF('Horas trabajadas', `${(totalHoras || 0).toFixed(2)}h`, `Contrato: ${horasContrato}h`, 'linear-gradient(135deg,#22c55e,#4ade80)', '‚è±Ô∏è'),
                crearTarjetaInfoPDF('Balance', `${balance >= 0 ? '+' : ''}${balance.toFixed(2)}h`, `Cumplimiento ${cumplimiento}%`, 'linear-gradient(135deg,#f97316,#fb923c)', 'üìà')
            ].join('');

            const calendarioHTML = construirCalendarioVisualPDF({
                turnos: turnos || [],
                mesNum,
                anio,
                empleadoId: empleado.id,
                tiposTurnoData
            });

            content.innerHTML = `
                <div style="border-bottom:2px solid rgba(148,163,184,0.2); padding-bottom:24px; margin-bottom:32px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:24px;">
                        <div>
                            <p style="margin:0; font-size:13px; letter-spacing:0.5em; color:#94a3b8; text-transform:uppercase; font-weight:600;">üìã Cuadrante Mensual</p>
                            <h1 style="margin:12px 0 0 0; font-size:48px; font-weight:900; background:linear-gradient(135deg,#fff,#cbd5f5); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;">${mes} ${anio}</h1>
                            <p style="margin:12px 0 0 0; color:#cbd5f5; font-size:14px;">${empleado.nombre} ¬∑ ${empleado.departamento || 'Sin departamento'}</p>
                        </div>
                        <div style="text-align:right; padding:16px; background:rgba(59,130,246,0.1); border-radius:16px; border:1px solid rgba(59,130,246,0.3);">
                            <div style="font-size:12px; color:#94a3b8; margin-bottom:6px;">üìÖ Generado</div>
                            <span style="font-size:12px; color:#cbd5f5;">${new Date().toLocaleDateString('es-ES')}</span>
                            <div style="font-size:36px; font-weight:800; margin-top:8px; color:#60a5fa;">${resumen.trabajados}</div>
                            <div style="font-size:11px; color:#cbd5f5; margin-top:4px;">d√≠as activos</div>
                        </div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:20px; margin-bottom:32px;">
                    ${tarjetas}
                </div>
                <div style="background:linear-gradient(135deg,rgba(15,23,42,0.95),rgba(15,23,42,0.8)); border-radius:32px; padding:32px; border:2px solid rgba(148,163,184,0.2); box-shadow:0 20px 60px rgba(0,0,0,0.4);">
                    <div style="margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(148,163,184,0.2);">
                        <h2 style="margin:0; font-size:18px; font-weight:700; color:#fff; letter-spacing:0.05em;">üìÖ Distribuci√≥n de Turnos</h2>
                    </div>
                    ${calendarioHTML}
                </div>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:14px; margin-top:32px;">
                    <div style="padding:16px; border-radius:16px; background:linear-gradient(135deg,rgba(34,197,94,0.15),rgba(34,197,94,0.05)); border:1px solid rgba(34,197,94,0.4); box-shadow:0 4px 12px rgba(34,197,94,0.1);"><span style="font-size:11px; color:#86efac; text-transform:uppercase; font-weight:600;">‚úì Descansos</span><div style="font-size:24px; font-weight:700; color:#4ade80; margin-top:6px;">${resumen.descansos}</div></div>
                    <div style="padding:16px; border-radius:16px; background:linear-gradient(135deg,rgba(248,113,113,0.15),rgba(248,113,113,0.05)); border:1px solid rgba(248,113,113,0.4); box-shadow:0 4px 12px rgba(248,113,113,0.1);"><span style="font-size:11px; color:#fca5a5; text-transform:uppercase; font-weight:600;">‚ö†Ô∏è Guardias</span><div style="font-size:24px; font-weight:700; color:#f87171; margin-top:6px;">${resumen.guardias}</div></div>
                    <div style="padding:16px; border-radius:16px; background:linear-gradient(135deg,rgba(59,130,246,0.15),rgba(59,130,246,0.05)); border:1px solid rgba(59,130,246,0.4); box-shadow:0 4px 12px rgba(59,130,246,0.1);"><span style="font-size:11px; color:#93c5fd; text-transform:uppercase; font-weight:600;">üåô Noches</span><div style="font-size:24px; font-weight:700; color:#3b82f6; margin-top:6px;">${resumen.noches}</div></div>
                    <div style="padding:16px; border-radius:16px; background:linear-gradient(135deg,rgba(251,191,36,0.15),rgba(251,191,36,0.05)); border:1px solid rgba(251,191,36,0.4); box-shadow:0 4px 12px rgba(251,191,36,0.1);"><span style="font-size:11px; color:#fde047; text-transform:uppercase; font-weight:600;">üì¶ Vacaciones/Bajas</span><div style="font-size:24px; font-weight:700; color:#facc15; margin-top:6px;">${resumen.vacaciones}</div></div>
                </div>
                <div style="margin-top:32px; padding:16px; border-radius:16px; background:rgba(100,116,139,0.1); border:1px solid rgba(100,116,139,0.3); text-align:center;">
                    <p style="margin:0; font-size:11px; color:#94a3b8; letter-spacing:0.05em;">üîê Documento generado autom√°ticamente ‚Ä¢ Sistema de Gesti√≥n de Turnos</p>
                </div>
            `;

            wrapper.appendChild(content);
            document.body.appendChild(wrapper);

            // Clonar el contenido para remover el bot√≥n WhatsApp del PDF
            const contentForPDF = content.cloneNode(true);
            const btnWhatsAppEnPDF = contentForPDF.querySelector('.btn-whatsapp-modal');
            if (btnWhatsAppEnPDF) {
                btnWhatsAppEnPDF.remove();
            }

            // Crear un wrapper temporal solo para la captura del PDF
            const wrapperPDF = document.createElement('div');
            wrapperPDF.style.position = 'fixed';
            wrapperPDF.style.left = '-9999px';
            wrapperPDF.style.top = '0';
            wrapperPDF.style.zIndex = '-1';
            wrapperPDF.appendChild(contentForPDF);
            document.body.appendChild(wrapperPDF);

            const canvas = await html2canvas(contentForPDF, {
                backgroundColor: '#0b1220',
                scale: 2,
                useCORS: true,
                logging: false,
                windowHeight: contentForPDF.scrollHeight,
                windowWidth: contentForPDF.scrollWidth,
                allowTaint: true
            });
            console.log('‚úÖ [generarPDFCuadranteVisual] Canvas generado');

            document.body.removeChild(wrapper);
            document.body.removeChild(wrapperPDF);

            const jsPDFConstructor = window.jspdf?.jsPDF || window.jsPDF;
            if (!jsPDFConstructor) {
                throw new Error('La libreria jsPDF no est√° disponible');
            }
            console.log('‚úÖ [generarPDFCuadranteVisual] jsPDF disponible');
            const pdf = new jsPDFConstructor('landscape', 'pt', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            
            // Escalar para que todo quepa en una sola p√°gina
            const scale = Math.min(pageWidth / (canvas.width * 0.75), pageHeight / (canvas.height * 0.75));
            const imgWidth = (canvas.width * scale) * 0.75;
            const imgHeight = (canvas.height * scale) * 0.75;
            const startX = (pageWidth - imgWidth) / 2;
            const startY = (pageHeight - imgHeight) / 2;
            
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', startX, startY, imgWidth, imgHeight);

            const fileName = `Cuadrante_${empleado.nombre.replace(/\s+/g, '_')}_${mes}_${anio}.pdf`;
            const blob = pdf.output('blob');
            const file = new File([blob], fileName, { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            window.ultimoPdfCuadrante = { fileName, url, creado: Date.now() };
            console.log('‚úÖ [generarPDFCuadranteVisual] PDF completado:', fileName);
            return { blob, file, url, fileName };
            } catch (error) {
                console.error('‚ùå [generarPDFCuadranteVisual] Error:', error);
                throw error;
            }
        }
        */

        // NUEVA FUNCI√ìN: Capturar imagen del cuadrante individual visible
        async function generarImagenCuadranteVisual(informe) {
            try {
                console.log('üîµ [generarImagenCuadranteVisual] Capturando cuadrante individual visible');
                const { empleado } = informe || {};
                if (!empleado) throw new Error('No hay empleado');
                
                // Obtener el elemento visible del cuadrante individual
                const cuadranteIndividual = document.getElementById('cuadranteIndividual');
                if (!cuadranteIndividual || cuadranteIndividual.style.display === 'none') {
                    throw new Error('El cuadrante individual no est√° visible');
                }
                
                // Obtener el contenedor interno (el div con el contenido)
                const contentElement = cuadranteIndividual.querySelector('div[style*="background"]') || cuadranteIndividual.firstChild;
                if (!contentElement) {
                    throw new Error('No se encontr√≥ el contenido del cuadrante');
                }
                
                console.log('‚úÖ [generarImagenCuadranteVisual] Elemento encontrado, ocultando encabezado y botones...');
                
                // Clonar el elemento para no afectar la vista
                const elementoClonado = contentElement.cloneNode(true);
                
                // Ocultar SOLO el encabezado (t√≠tulo y botones superiores)
                const encabezado = elementoClonado.querySelector('div[style*="border-bottom"]');
                if (encabezado) {
                    encabezado.style.display = 'none';
                }
                
                // Crear un contenedor temporal en el DOM para captura
                const tempWrapper = document.createElement('div');
                tempWrapper.style.position = 'fixed';
                tempWrapper.style.left = '-9999px';
                tempWrapper.style.top = '0';
                tempWrapper.style.zIndex = '-1';
                tempWrapper.appendChild(elementoClonado);
                document.body.appendChild(tempWrapper);
                
                // Ajustar dimensiones para que quepa todo el contenido
                elementoClonado.style.width = '1200px';
                elementoClonado.style.maxHeight = 'none';
                elementoClonado.style.height = 'auto';
                
                // Forzar reflow para asegurar que se calcula el tama√±o
                void elementoClonado.offsetHeight;
                
                console.log('‚úÖ [generarImagenCuadranteVisual] Generando canvas con altura ajustada...');
                
                // Generar canvas del elemento sin encabezado pero CON pie de p√°gina
                const canvas = await html2canvas(elementoClonado, {
                    backgroundColor: '#0b1220',
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    windowHeight: elementoClonado.scrollHeight + 100,
                    windowWidth: 1200,
                    allowTaint: true
                });
                
                console.log('‚úÖ [generarImagenCuadranteVisual] Canvas generado');
                
                // Remover el elemento temporal
                document.body.removeChild(tempWrapper);
                
                // Convertir canvas a blob de imagen
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png', 0.95));
                const fileName = `Cuadrante_${empleado.nombre.replace(/\s+/g, '_')}.png`;
                const file = new File([blob], fileName, { type: 'image/png' });
                const url = URL.createObjectURL(blob);
                const dataUrl = canvas.toDataURL('image/png');
                
                window.ultimoImagenCuadrante = { fileName, url, creado: Date.now(), dataUrl };
                console.log('‚úÖ [generarImagenCuadranteVisual] Imagen completada:', fileName);
                return { blob, file, url, fileName, dataUrl };
            } catch (error) {
                console.error('‚ùå [generarImagenCuadranteVisual] Error:', error);
                throw error;
            }
        }

        function exportarEmpleado(empleadoId, mesNombre, anio, tipo) {
            try {
                // üîß GARANTIZAR QUE USAMOS LOS EMPLEADOS ACTUALES (desde localStorage)
                const empleadosActuales = JSON.parse(localStorage.getItem('empleadosData') || '[]');
                const empleado = empleadosActuales.find(e => e.id === empleadoId) || empleados.find(e => e.id === empleadoId);
                
                if (!empleado) {
                    console.error('‚ùå Empleado no encontrado:', empleadoId);
                    alert('Empleado no encontrado');
                    return;
                }
                
                // üîß DEBUG: Verificar que se carg√≥ el empleado correcto
                console.log('‚úÖ Empleado cargado:', {
                    id: empleado.id,
                    nombre: empleado.nombre,
                    horasContrato: empleado.horasContrato
                });
                
                const turnos = AppState.scheduleData.get(empleadoId) || [];
                
                // Convertir nombre del mes a n√∫mero (robusto contra valores no string)
                const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                                      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const normalizarMes = (valor) => (valor ?? '').toString().trim();
                const mesNormalizado = normalizarMes(mesNombre);
                const mesNum = mesNormalizado ? mesesNombres.findIndex(m => lowerCaseSafe(m) === lowerCaseSafe(mesNormalizado)) : -1;
                const mesActualNum = mesNum >= 0 ? mesNum : AppState.currentMonth;
                const anioActual = parseInt(anio) || AppState.currentYear;
                
                // üîß BUG FIX: Filtrar turnos del mes/a√±o actual
                const turnosDelMes = turnos.filter(t => {
                    if (!t.fecha) return false;
                    const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                    return fecha.getMonth() === mesActualNum && fecha.getFullYear() === anioActual;
                });
                
                // üîß BUG FIX: Calcular total de horas correctamente desde los turnos del mes
                const totalHoras = Math.round(turnosDelMes.reduce((sum, t) => sum + (t.horas || 0), 0) * 100) / 100;
                const mesActualNombre = mesesNombres[mesActualNum];
                
                // Guardar en variable global para las funciones de exportaci√≥n
                window.informeActual = { 
                    empleado, 
                    turnos: turnosDelMes,  // üîß BUG FIX: Usar turnosDelMes
                    mes: mesActualNombre, 
                    anio: anioActual,
                    mesNum: mesActualNum,
                    totalHoras: totalHoras
                };
                
                console.log('exportarEmpleado - Mes actual:', { mes: mesActualNombre, mesNum: mesActualNum, anio: anioActual });
                
                if (tipo === 'pdf') {
                    descargarInformeIndividualPDF();
                } else if (tipo === 'whatsapp') {
                    console.log('üîµ Llamando a enviarWhatsAppIndividual()...');
                    enviarWhatsAppIndividual().catch(error => {
                        console.error('‚ùå Error en enviarWhatsAppIndividual:', error);
                        alert('Error: ' + error.message);
                    });
                } else if (tipo === 'csv') {
                    descargarInformeIndividualCSV();
                } else if (tipo === 'copy') {
                    copiarAlPortapapelesInforme();
                } else if (tipo === 'ical') {
                    exportarAiCalendar(window.informeActual);
                }
            } catch (error) {
                console.error('Error exportando:', error);
                alert('Error: ' + error.message);
            }
        }

        // Descargar PDF del informe individual
        function descargarInformeIndividualPDF() {
            try {
                if (!window.informeActual) {
                    alert('No hay datos para exportar');
                    return;
                }

                const { empleado, turnos, mes, anio, totalHoras } = window.informeActual;
                
                // üîß DEBUG: Verificar qu√© empleado se est√° usando
                console.log('üìÑ PDF - Empleado:', {
                    nombre: empleado.nombre,
                    horasContrato: empleado.horasContrato,
                    tipo: typeof empleado.horasContrato
                });
                
                const turnosNoche = turnos.filter(dia => dia.turno === 'noche').length;
                const ausencias = turnos.filter(dia => dia.turno === 'vacaciones' || dia.turno === 'baja').length;
                
                // üîß Convertir horasContrato a n√∫mero (por si est√° como string)
                const horasContratoNum = parseFloat(empleado.horasContrato) || 0;
                const totalHorasNum = parseFloat(totalHoras) || 0;
                
                // üîß DEBUG: Verificar valores despu√©s de conversi√≥n
                console.log('üìÑ PDF - Valores convertidos:', {
                    horasContratoNum,
                    totalHorasNum
                });
                
                // Crear HTML para el PDF
                const htmlContent = `
                    <h1 style="text-align: center; color: #2c3e50;">INFORME INDIVIDUAL MENSUAL</h1>
                    <h2 style="text-align: center; color: #7f8c8d;">${mes} ${anio}</h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h3 style="margin-top: 0; color: #2c3e50;">${empleado.nombre}</h3>
                        <p><strong>Departamento:</strong> ${empleado.departamento || 'N/A'}</p>
                        <p><strong>Turno Principal:</strong> ${empleado.turnoPrincipal || 'N/A'}</p>
                        <p><strong>Localidad:</strong> ${empleado.localidad || 'N/A'}</p>
                        <p><strong>Horas Contrato:</strong> ${horasContratoNum}h</p>
                        <p><strong>Estado:</strong> ${empleado.estado ? empleado.estado.toUpperCase() : 'N/A'}</p>
                    </div>
                    
                    <p><strong>Horas Trabajadas:</strong> ${totalHorasNum}h</p>
                    <p><strong>Balance:</strong> ${(totalHorasNum - horasContratoNum).toFixed(2)}h</p>
                    <p><strong>Cumplimiento:</strong> ${horasContratoNum > 0 ? Math.round((totalHorasNum / horasContratoNum) * 100) : 0}%</p>
                `;
                
                const ventana = window.open('', '_blank');
                ventana.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{font-family:Arial;}</style></head><body>${htmlContent}</body></html>`);
                ventana.document.close();
                ventana.print();
                
                if (typeof NotificationSystem !== 'undefined') {
                    NotificationSystem.show('Abriendo PDF para imprimir', 'info');
                }
            } catch (error) {
                console.error('Error PDF:', error);
                alert('Error: ' + error.message);
            }
        }

        // Descargar CSV del informe individual
        function descargarInformeIndividualCSV() {
            try {
                if (!window.informeActual) {
                    alert('No hay datos para exportar');
                    return;
                }
                const { empleado, turnos, mes, anio, mesNum, totalHoras } = window.informeActual;
                
                let csv = 'data:text/csv;charset=utf-8,';
                csv += `Empleado,${empleado.nombre}\n`;
                csv += `Departamento,${empleado.departamento}\n`;
                csv += `Turno Principal,${empleado.turnoPrincipal}\n`;
                csv += `Mes,${mes}\n`;
                csv += `A√±o,${anio}\n`;
                csv += `Total Horas,${totalHoras}\n\n`;
                csv += `D√≠a,Turno,Horas,Fecha\n`;
                
                turnos.forEach(turno => {
                    const fecha = turno.fecha.toLocaleDateString('es-ES');
                    csv += `${turno.dia},${turno.turno},${turno.horas},${fecha}\n`;
                });
                
                const enlace = document.createElement('a');
                enlace.href = encodeURI(csv);
                enlace.download = `informe_${empleado.nombre}_${mesNum + 1}_${anio}.csv`;
                enlace.click();
                
                if (typeof NotificationSystem !== 'undefined') {
                    NotificationSystem.show('CSV descargado correctamente', 'success');
                }
            } catch (error) {
                console.error('Error CSV:', error);
                alert('Error: ' + error.message);
            }
        }

        // üóìÔ∏è EXPORTAR A ICALENDAR (.ics) PARA INTEGRACI√ìN CON GOOGLE CALENDAR, OUTLOOK, ETC
        function generarContenidoiCalendar(informe) {
            try {
                if (!informe) return '';
                
                const { empleado, turnos, mes, anio } = informe;
                
                // Generar un UID √∫nico para el calendario
                const timestamp = new Date().toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
                
                // Encabezado del calendario iCalendar
                let ical = 'BEGIN:VCALENDAR\n';
                ical += 'VERSION:2.0\n';
                ical += 'PRODID:-//Sistema Gesti√≥n Turnos//NONSGML v1.0//ES\n';
                ical += 'CALSCALE:GREGORIAN\n';
                ical += `X-WR-CALNAME:Turnos ${empleado.nombre} - ${mes} ${anio}\n`;
                ical += `X-WR-CALDESC:Cuadrante de turnos de ${empleado.nombre}\n`;
                ical += `X-WR-TIMEZONE:Europe/Madrid\n`;
                ical += 'METHOD:PUBLISH\n';
                
                // Mapa de colores por tipo de turno para Outlook/Google Calendar
                const colorMapa = {
                    'ma√±ana': '#85C1E9',
                    'tarde': '#F8C471',
                    'noche': '#BB8FCE',
                    'mixto': '#85C1E9',
                    'descanso': '#82E0AA',
                    'vacaciones': '#F5B041',
                    'baja': '#F1948A',
                    'festivo': '#AED6F1',
                    'libre': '#D5F4E6'
                };

                // Agregar cada turno como evento
                turnos.forEach((turno) => {
                    if (!turno.fecha) return;
                    
                    const fecha = turno.fecha instanceof Date ? turno.fecha : new Date(turno.fecha);
                    const fechaStr = fecha.toISOString().split('T')[0].replace(/-/g, '');
                    
                    // Informaci√≥n del turno
                    const infoTurno = tiposTurno[turno.turno] || {};
                    const horario = infoTurno.horario || turno.horario || '08:00-16:00';
                    const horas = turno.horas || infoTurno.horas || 8;
                    
                    // Parsear horario para calcular hora de inicio y fin
                    const [horaInicio, horaFin] = horario.split('-');
                    const inicioDateTime = `${fechaStr}T${horaInicio.replace(':', '')}00`;
                    const finDateTime = `${fechaStr}T${horaFin.replace(':', '')}00`;
                    
                    // UID √∫nico para cada evento
                    const eventoUid = `${empleado.id}-${turno.dia}-${anio}-${turno.turno}@turnosapp.local`;
                    
                    // Crear evento VEVENT
                    ical += 'BEGIN:VEVENT\n';
                    ical += `UID:${eventoUid}\n`;
                    ical += `DTSTAMP:${timestamp}Z\n`;
                    ical += `DTSTART:${inicioDateTime}Z\n`;
                    ical += `DTEND:${finDateTime}Z\n`;
                    ical += `SUMMARY:${turno.turno.charAt(0).toUpperCase() + turno.turno.slice(1)} (${horas}h)\n`;
                    ical += `DESCRIPTION:Turno: ${turno.turno}\\nEmpleado: ${empleado.nombre}\\nDepartamento: ${empleado.departamento || 'N/A'}\\nHoras: ${horas}h\\nHorario: ${horario}\n`;
                    ical += `LOCATION:${empleado.localidad || 'No especificado'}\n`;
                    ical += `CATEGORIES:${turno.turno.toUpperCase()},TURNO\n`;
                    
                    // Agregar color si el cliente lo soporta (Google Calendar, Outlook)
                    const color = colorMapa[turno.turno.toLowerCase()] || '#85C1E9';
                    ical += `COLOR:${color}\n`;
                    ical += `X-MICROSOFT-CDO-BUSYSTATUS:${turno.turno === 'descanso' ? 'FREE' : 'BUSY'}\n`;
                    ical += `X-MICROSOFT-CDO-INTENDEDSTATUS:${turno.turno === 'descanso' ? 'FREE' : 'BUSY'}\n`;
                    
                    // Alarmas (notificaci√≥n 1 d√≠a antes si es turno importante)
                    if (turno.turno === 'noche' || turno.turno === 'mixto') {
                        ical += 'BEGIN:VALARM\n';
                        ical += 'ACTION:DISPLAY\n';
                        ical += `DESCRIPTION:Recordatorio: Turno ${turno.turno} ma√±ana\n`;
                        ical += 'TRIGGER:-P1D\n';
                        ical += 'END:VALARM\n';
                    }
                    
                    ical += 'END:VEVENT\n';
                });
                
                // Cerrar calendario
                ical += 'END:VCALENDAR\n';
                
                return ical;
            } catch (error) {
                console.error('‚ùå Error en generarContenidoiCalendar:', error);
                return '';
            }
        }

        // üóìÔ∏è EXPORTAR A ICALENDAR (.ics) PARA INTEGRACI√ìN CON GOOGLE CALENDAR, OUTLOOK, ETC
        function exportarAiCalendar(informe) {
            try {
                console.log('üóìÔ∏è [exportarAiCalendar] Iniciando exportaci√≥n iCalendar...');
                if (!informe) {
                    alert('No hay datos para exportar');
                    return;
                }

                const { empleado, mes, anio } = informe;
                
                // Generar contenido iCalendar usando funci√≥n reutilizable
                const icalContent = generarContenidoiCalendar(informe);
                
                // Descargar archivo .ics
                const dataUri = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icalContent);
                const enlace = document.createElement('a');
                enlace.href = dataUri;
                enlace.download = `Turnos_${empleado.nombre.replace(/\s+/g, '_')}_${mes}_${anio}.ics`;
                document.body.appendChild(enlace);
                enlace.click();
                document.body.removeChild(enlace);
                
                console.log(`‚úÖ [exportarAiCalendar] iCalendar exportado: ${enlace.download}`);
                
                if (typeof NotificationSystem !== 'undefined') {
                    NotificationSystem.show(`üìÖ Calendario iCalendar descargado ‚Ä¢ Importa en Google Calendar, Outlook, etc.`, 'success', 4000);
                }
            } catch (error) {
                console.error('‚ùå Error en exportarAiCalendar:', error);
                alert('Error: ' + error.message);
            }
        }

        // üì± WHATSAPP MASIVO - Enviar cuadrante a todos los empleados filtrados por departamento
        async function abrirWhatsApp() {
            try {
                console.log('üü¢ [abrirWhatsApp] Iniciando panel de WhatsApp masivo...');
                
                // Obtener filtro de departamento actual
                const filtroDepartamento = document.getElementById('filtroDepartamentoGeneral')?.value || '';
                const filtroEstado = document.getElementById('filtroEstadoGeneral')?.value || '';
                
                // Filtrar empleados seg√∫n criterios
                let empleadosFiltrados = empleados;
                
                if (filtroDepartamento) {
                    empleadosFiltrados = empleadosFiltrados.filter(e => e.departamento === filtroDepartamento);
                }
                if (filtroEstado) {
                    empleadosFiltrados = empleadosFiltrados.filter(e => e.estado === filtroEstado);
                }
                
                console.log(`üìä Empleados filtrados: ${empleadosFiltrados.length} / ${empleados.length}`);
                
                if (empleadosFiltrados.length === 0) {
                    NotificationSystem.show('‚ùå No hay empleados que cumplan los criterios de filtro', 'error');
                    return;
                }
                
                // Crear modal para confirmar env√≠o masivo
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.id = 'modalWhatsAppMasivo';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                
                const mesesNombre = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const mesActual = mesesNombre[AppState.currentMonth];
                const anioActual = AppState.currentYear;
                
                modal.innerHTML = `
                    <div style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%); border-radius: 20px; padding: 32px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.8); border: 2px solid rgba(59, 130, 246, 0.3);">
                        <h2 style="margin: 0 0 24px 0; color: #fff; font-size: 24px; font-weight: 700;">üì± Env√≠o Masivo por WhatsApp</h2>
                        
                        <div style="background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                            <p style="margin: 0; color: #93c5fd; font-size: 14px;"><strong>Mes:</strong> ${mesActual} ${anioActual}</p>
                            <p style="margin: 8px 0 0 0; color: #93c5fd; font-size: 14px;"><strong>Filtro:</strong> ${filtroDepartamento ? `Departamento: ${filtroDepartamento}` : 'Todos los departamentos'} ${filtroEstado ? ` + Estado: ${filtroEstado}` : ''}</p>
                        </div>
                        
                        <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); padding: 16px; border-radius: 12px; margin-bottom: 24px;">
                            <h3 style="margin: 0 0 12px 0; color: #86efac; font-size: 16px;">‚úì Empleados a notificar:</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto;">
                                ${empleadosFiltrados.map(emp => `
                                    <div style="background: rgba(51, 65, 85, 0.5); padding: 8px 12px; border-radius: 6px; color: #cbd5f5; font-size: 13px; border-left: 3px solid ${emp.telefono ? '#22c55e' : '#f87171'};">
                                        <strong>${emp.nombre}</strong>
                                        <div style="font-size: 11px; color: rgba(203, 213, 245, 0.7); margin-top: 2px;">
                                            ${emp.departamento} ‚Ä¢ ${emp.telefono ? '‚úì Tel√©fono' : '‚ùå Sin tel√©fono'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <p style="margin: 12px 0 0 0; color: #86efac; font-size: 13px;"><strong>${empleadosFiltrados.filter(e => e.telefono).length} de ${empleadosFiltrados.length}</strong> empleados tienen tel√©fono registrado</p>
                        </div>
                        
                        <div style="background: rgba(248, 113, 113, 0.1); border: 1px solid rgba(248, 113, 113, 0.3); padding: 12px; border-radius: 8px; margin-bottom: 24px;">
                            <p style="margin: 0; color: #fca5a5; font-size: 12px;">‚ö†Ô∏è Se enviar√°n PDF + iCalendar a cada empleado. Aseg√∫rate de que los n√∫meros sean correctos.</p>
                        </div>
                        
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="document.getElementById('modalWhatsAppMasivo').remove()" style="background: rgba(100, 116, 139, 0.2); color: #cbd5f5; border: 1px solid rgba(100, 116, 139, 0.4); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(100, 116, 139, 0.4)'" onmouseout="this.style.background='rgba(100, 116, 139, 0.2)'">Cancelar</button>
                            <button onclick="enviarWhatsAppMasivo()" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(34, 197, 94, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(34, 197, 94, 0.3)'">üì± Enviar a Todos (${empleadosFiltrados.filter(e => e.telefono).length})</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Guardar empleados filtrados en variable global para enviarlos
                window.empleadosFiltradosWhatsApp = empleadosFiltrados;
                
            } catch (error) {
                console.error('‚ùå Error en abrirWhatsApp:', error);
                NotificationSystem.show('Error: ' + error.message, 'error');
            }
        }

        // üì§ Enviar WhatsApp a todos los empleados filtrados
        async function enviarWhatsAppMasivo() {
            try {
                console.log('üü¢ [enviarWhatsAppMasivo] Iniciando env√≠o masivo...');
                
                const empleadosFiltrados = window.empleadosFiltradosWhatsApp || [];
                const empleadosSinTelefono = empleadosFiltrados.filter(e => !e.telefono);
                const empleadosConTelefono = empleadosFiltrados.filter(e => e.telefono);
                
                if (empleadosConTelefono.length === 0) {
                    NotificationSystem.show('‚ùå Ning√∫n empleado tiene tel√©fono registrado', 'error');
                    return;
                }
                
                const modal = document.getElementById('modalWhatsAppMasivo');
                if (modal) modal.remove();
                
                // Crear modal de progreso mejorado con instrucciones
                const modalProgreso = document.createElement('div');
                modalProgreso.id = 'modalProgresoWhatsApp';
                modalProgreso.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';
                
                modalProgreso.innerHTML = `
                    <div style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%); border-radius: 20px; padding: 32px; max-width: 500px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.8); text-align: center; max-height: 90vh; overflow-y: auto;">
                        <h2 style="margin: 0 0 24px 0; color: #fff; font-size: 20px; font-weight: 700;">üì§ Enviando cuadrantes...</h2>
                        
                        <div id="barraProgreso" style="width: 100%; height: 8px; background: rgba(59, 130, 246, 0.2); border-radius: 10px; overflow: hidden; margin-bottom: 16px;">
                            <div id="barraLlena" style="width: 0%; height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa); transition: width 0.3s ease;"></div>
                        </div>
                        <p id="textoProgreso" style="margin: 0 0 24px 0; color: #cbd5f5; font-size: 14px;">Preparando env√≠os...</p>
                        
                        <div id="seccionInstrucciones" style="display: none; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; padding: 16px; border-radius: 8px; text-align: left; margin-top: 24px;">
                            <h3 style="margin: 0 0 12px 0; color: #60a5fa; font-size: 14px; font-weight: 600;">üìå Instrucciones para adjuntar archivos:</h3>
                            <ol style="margin: 0; padding-left: 20px; color: #cbd5f5; font-size: 13px; line-height: 1.6;">
                                <li>Se descargar√°n 2 archivos por cada empleado en tu carpeta <strong>Descargas</strong></li>
                                <li>Abre tu aplicaci√≥n WhatsApp (App de Escritorio)</li>
                                <li>Selecciona el chat del empleado</li>
                                <li>Adjunta el PDF (<strong>.pdf</strong>) y el calendario (<strong>.ics</strong>)</li>
                                <li>¬°Listo! Los archivos se enviar√°n autom√°ticamente</li>
                            </ol>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modalProgreso);
                
                const mesesNombre = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const mesActual = mesesNombre[AppState.currentMonth];
                const anioActual = AppState.currentYear;
                
                let enviados = 0;
                let errores = 0;
                const downloadPath = `C:\\Users\\${this.getUsername?.() || 'Usuario'}\\Downloads`;
                
                // Mostrar instrucci√≥n inicial
                NotificationSystem.show('üì• Los archivos se descargar√°n en tu carpeta Descargas. Ten tu WhatsApp App abierto.', 'info', 4000);
                
                // Enviar a cada empleado con delay para no sobrecargar
                for (let i = 0; i < empleadosConTelefono.length; i++) {
                    const empleado = empleadosConTelefono[i];
                    const porcentaje = Math.round((i / empleadosConTelefono.length) * 100);
                    
                    document.getElementById('barraLlena').style.width = porcentaje + '%';
                    document.getElementById('textoProgreso').textContent = `${empleado.nombre} (${i + 1}/${empleadosConTelefono.length})`;
                    
                    try {
                        // Usar la funci√≥n existente de env√≠o individual
                        await enviarWhatsAppEmpleadoDirecto(empleado.id, mesActual, anioActual);
                        enviados++;
                        
                        // Delay entre env√≠os para no sobrecargar
                        await new Promise(resolve => setTimeout(resolve, 1500));
                    } catch (error) {
                        console.error(`‚ùå Error enviando a ${empleado.nombre}:`, error);
                        errores++;
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                // Completar barra y mostrar instrucciones
                document.getElementById('barraLlena').style.width = '100%';
                document.getElementById('textoProgreso').textContent = `‚úì Completado: ${enviados} enviados`;
                document.getElementById('seccionInstrucciones').style.display = 'block';
                
                // Intentar abrir explorador de descargas
                setTimeout(() => {
                    abrirCarpetaDescargas();
                }, 500);
                
                setTimeout(() => {
                    if (modalProgreso) modalProgreso.remove();
                    
                    let mensajeCompletacion = `‚úÖ Se procesaron ${enviados}/${empleadosConTelefono.length} cuadrantes.\n\n`;
                    mensajeCompletacion += 'üì• Archivos descargados en Descargas\n';
                    mensajeCompletacion += 'üì± Abre tu WhatsApp App\n';
                    mensajeCompletacion += 'üìé Adjunta PDF + iCalendar';
                    
                    NotificationSystem.show(mensajeCompletacion, 'success', 6000);
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Error en enviarWhatsAppMasivo:', error);
                const modalProgreso = document.getElementById('modalProgresoWhatsApp');
                if (modalProgreso) modalProgreso.remove();
                NotificationSystem.show('Error: ' + error.message, 'error');
            }
        }

        // Abrir carpeta de descargas - Mejora de UX
        function abrirCarpetaDescargas() {
            try {
                // Intento 1: Crear un elemento para abrir explorador en descargas
                // Nota: Limitaci√≥n de seguridad de navegadores impide esto directamente
                // en JavaScript puro, pero lo intentamos con fallbacks
                
                const explorador = new ActiveXObject('Shell.Application');
                if (explorador) {
                    // Obtener ruta de descargas del usuario
                    const userShell = explorador.CreateShortcut(WScript.ScriptFullName).TargetPath;
                    const downloadsPath = `${userShell.split('\\').slice(0, 3).join('\\')}\\Downloads`;
                    explorador.Open(downloadsPath);
                    console.log('‚úÖ Carpeta Descargas abierta en explorador');
                    return;
                }
            } catch (e1) {
                try {
                    // Intento 2: Usar URI de archivo directo (Windows 10+)
                    const dowloadDir = 'C:\\Users\\' + (navigator.userAgentData?.platform || 'Usuario') + '\\Downloads';
                    window.location.href = 'file:///' + dowloadDir.replace(/\\/g, '/');
                    return;
                } catch (e2) {
                    // Intento 3: Instrucciones en notificaci√≥n
                    console.log('‚ö†Ô∏è No se puede abrir explorador autom√°ticamente (limitaci√≥n de seguridad del navegador)');
                    console.log('üìÅ Por favor abre: C:\\Users\\[TuUsuario]\\Downloads');
                    
                    // Mostrar instrucci√≥n clara
                    const notif = document.createElement('div');
                    notif.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
                        color: white;
                        padding: 16px 24px;
                        border-radius: 12px;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                        z-index: 9999;
                        font-size: 13px;
                        max-width: 300px;
                        cursor: pointer;
                        animation: slideIn 0.3s ease;
                    `;
                    notif.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 8px;">üìÇ Archivos descargados</div>
                        <div style="font-size: 12px; opacity: 0.95; line-height: 1.5;">
                            Presiona <strong>Win + E</strong> para abrir el explorador<br>
                            Navega a: <strong>Descargas</strong>
                        </div>
                    `;
                    
                    // Cerrar con clic
                    notif.onclick = () => notif.remove();
                    document.body.appendChild(notif);
                    
                    // Auto-cerrar despu√©s de 5s
                    setTimeout(() => {
                        if (notif.parentNode) notif.remove();
                    }, 5000);
                }
            }
        }

        // Enviar por WhatsApp (PDF + mensaje)
        async function enviarWhatsAppEmpleadoDirecto(empleadoId, mesNombre, anio) {
            try {
                console.log('üîµ [enviarWhatsAppEmpleadoDirecto] Iniciando para empleado:', empleadoId, mesNombre, anio);
                
                // Usar variable global sincronizada (no localStorage que puede estar corrupto)
                const empId = typeof empleadoId === 'string' ? parseInt(empleadoId) : empleadoId;
                const empleado = empleados.find(e => e.id === empId);
                if (!empleado) {
                    alert('Error: Empleado no encontrado');
                    return;
                }

                const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const normalizarMes = (valor) => (valor ?? '').toString().trim();
                mesNombre = normalizarMes(mesNombre);
                let mesNum = mesNombre ? mesesNombres.findIndex(m => lowerCaseSafe(m) === lowerCaseSafe(mesNombre)) : -1;
                let anioSeleccionado = anio || AppState.currentYear;

                if (mesNum === -1) {
                    alert('Error: No se puede identificar el mes');
                    return;
                }

                // Obtener turnos del AppState
                const turnosDelAppState = AppState.scheduleData.get(parseInt(empleadoId)) || [];
                const turnosDelMes = turnosDelAppState.filter(t => {
                    if (!t?.fecha) return false;
                    const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                    return fecha.getMonth() === mesNum && fecha.getFullYear() === anioSeleccionado;
                });
                
                const totalHoras = Math.round(turnosDelMes.reduce((sum, t) => sum + (t?.horas || 0), 0) * 100) / 100;
                
                console.log(`üîµ [enviarWhatsAppEmpleadoDirecto] Turnos del empleado ${empleadoId}: ${turnosDelAppState.length} total, ${turnosDelMes.length} del mes ${mesNum + 1}/${anioSeleccionado}, Total horas: ${totalHoras}h`);

                const horasContrato = parseFloat(empleado.horasContrato) || 0;
                const balance = totalHoras - horasContrato;
                const cumplimiento = horasContrato > 0 ? Math.round((totalHoras / horasContrato) * 100) : 0;

                // ÔøΩ Generar Imagen en lugar de PDF
                const pdfBundle = await generarImagenCuadranteVisual({
                    empleado,
                    turnos: turnosDelMes,
                    mes: mesNombre,
                    anio: anioSeleccionado,
                    mesNum,
                    totalHoras
                });
                console.log('‚úÖ [enviarWhatsAppEmpleadoDirecto] PDF generado correctamente:', pdfBundle.fileName);

                // üóìÔ∏è Generar iCalendar
                const informe = {
                    empleado,
                    turnos: turnosDelMes,
                    mes: mesNombre,
                    anio: anioSeleccionado,
                    mesNum,
                    totalHoras
                };
                const icalContent = generarContenidoiCalendar(informe);
                const icalFileName = `Turnos_${empleado.nombre.replace(/\s+/g, '_')}_${mesNombre}_${anioSeleccionado}.ics`;
                console.log('‚úÖ [enviarWhatsAppEmpleadoDirecto] iCalendar generado:', icalFileName);

                let mensaje = `üìã *CUADRANTE MENSUAL*\n\n`;
                mensaje += `*${empleado.nombre}*\n`;
                mensaje += `\n*üìä Resumen ${mesNombre} ${anioSeleccionado}:*\n`;
                mensaje += `‚Ä¢ Horas Trabajadas: ${totalHoras}h\n`;
                mensaje += `‚Ä¢ Balance: ${balance >= 0 ? '+' : ''}${balance.toFixed(2)}h\n`;
                mensaje += `‚Ä¢ Cumplimiento: ${cumplimiento}%\n`;
                mensaje += `‚Ä¢ Contrato: ${horasContrato}h mensuales\n\n`;
                mensaje += `üìé Te adjunto:\n‚Ä¢ PDF con el calendario detallado\n‚Ä¢ Archivo iCalendar para importar a tu calendario (Google, Outlook, etc)`;

                const numeroWhatsApp = empleado.telefono ? empleado.telefono.replace(/\D/g, '') : '';
                if (!numeroWhatsApp) {
                    URL.revokeObjectURL(pdfBundle.url);
                    alert('‚ùå El empleado no tiene n√∫mero de tel√©fono registrado');
                    return;
                }

                console.log('üì• Descargando archivos...');
                
                // Obtener la carpeta de descargas
                const userDownloadsPath = 'Carpeta Descargas de Windows';
                
                // Descargar PDF
                const linkPdf = document.createElement('a');
                linkPdf.href = pdfBundle.url;
                linkPdf.download = pdfBundle.fileName;
                document.body.appendChild(linkPdf);
                linkPdf.click();
                document.body.removeChild(linkPdf);
                console.log('‚úÖ PDF descargado:', pdfBundle.fileName);

                // Descargar iCalendar (con delay para evitar conflictos)
                setTimeout(() => {
                    const dataUri = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icalContent);
                    const linkIcal = document.createElement('a');
                    linkIcal.href = dataUri;
                    linkIcal.download = icalFileName;
                    document.body.appendChild(linkIcal);
                    linkIcal.click();
                    document.body.removeChild(linkIcal);
                    console.log('‚úÖ iCalendar descargado:', icalFileName);
                }, 300);

                if (typeof NotificationSystem !== 'undefined') {
                    let notifMasivo = document.getElementById('modalProgresoWhatsApp');
                    if (!notifMasivo) {
                        // Solo mostrar notificaci√≥n si no estamos en modo masivo
                        NotificationSystem.show('üì• Descargados:\n' + pdfBundle.fileName + '\n' + icalFileName, 'info', 4000);
                    }
                }

                setTimeout(() => {
                    console.log('üü¢ Intentando abrir WhatsApp App con mensaje...');
                    
                    // URL para WhatsApp App (Escritorio)
                    const urlWhatsAppApp = `whatsapp://send?phone=${numeroWhatsApp}&text=${encodeURIComponent(mensaje)}`;
                    
                    // URL alternativa para WhatsApp Web (fallback)
                    const urlWhatsAppWeb = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensaje)}`;
                    
                    console.log('üîó URL WhatsApp App:', urlWhatsAppApp.substring(0, 50) + '...');
                    
                    // Intentar abrir WhatsApp App primero
                    const linkWhatsApp = document.createElement('a');
                    linkWhatsApp.href = urlWhatsAppApp;
                    linkWhatsApp.target = '_blank';
                    document.body.appendChild(linkWhatsApp);
                    linkWhatsApp.click();
                    document.body.removeChild(linkWhatsApp);
                    
                    // Si WhatsApp App no abre despu√©s de 2 segundos, intentar WhatsApp Web como fallback
                    setTimeout(() => {
                        if (!document.hidden) {
                            console.log('‚ö†Ô∏è WhatsApp App no respondi√≥, intentando WhatsApp Web como fallback...');
                            const linkFallback = document.createElement('a');
                            linkFallback.href = urlWhatsAppWeb;
                            linkFallback.target = '_blank';
                            document.body.appendChild(linkFallback);
                            linkFallback.click();
                            document.body.removeChild(linkFallback);
                        }
                    }, 2000);
                    
                    console.log('‚úÖ WhatsApp abierto (App o Web), PDF e iCalendar descargados');
                    if (typeof NotificationSystem !== 'undefined') {
                        NotificationSystem.show('‚úÖ WhatsApp abierto ‚Ä¢ üìÑ PDF + üóìÔ∏è iCalendar descargados', 'success', 3000);
                    }
                }, 1300);

                // Limpiar URL del blob despu√©s de un tiempo
                setTimeout(() => {
                    URL.revokeObjectURL(pdfBundle.url);
                    console.log('üßπ URLs limpiadas');
                }, 30000);

            } catch (error) {
                console.error('‚ùå Error en enviarWhatsAppEmpleadoDirecto:', error);
                alert('Error al enviar por WhatsApp: ' + error.message);
            }
        }

        // Enviar por WhatsApp desde modal individual
        async function enviarWhatsAppIndividual() {
            try {
                console.log('üîµ [enviarWhatsAppIndividual] Iniciando...');
                const cuadranteIndividual = document.getElementById('cuadranteIndividual');
                if (!cuadranteIndividual || cuadranteIndividual.style.display === 'none') {
                    alert('Error: El cuadrante individual no est√° abierto');
                    return;
                }
                console.log('‚úÖ [enviarWhatsAppIndividual] Cuadrante individual encontrado');

                const btnWhatsAppOriginal = cuadranteIndividual.querySelector('.btn-whatsapp-modal');
                const onclickAttr = btnWhatsAppOriginal?.getAttribute('onclick') || '';
                let matchParams = onclickAttr.match(/exportarEmpleado\((\d+)\s*,\s*['"]([^'"\)]+)['"]\s*,\s*(\d+)/);

                const titleEl = cuadranteIndividual.querySelector('h3');
                let mesNombre = '';
                let anio = 0;

                if (matchParams) {
                    mesNombre = matchParams[2];
                    anio = parseInt(matchParams[3]);
                } else {
                    const titulo = titleEl?.textContent || '';
                    const mesesNombresRaw = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
                    const encontrado = mesesNombresRaw.find(m => titulo.includes(m));
                    if (!encontrado) {
                        alert('Error: No se puede identificar el mes');
                        return;
                    }
                    mesNombre = encontrado;
                    const matchYear = titulo.match(/(20\d{2})/);
                    anio = matchYear ? parseInt(matchYear[1]) : AppState.currentYear;
                    const matchEmp = onclickAttr.match(/exportarEmpleado\((\d+)/);
                    if (matchEmp) {
                        matchParams = matchEmp;
                    }
                }

                if (!matchParams) {
                    alert('Error: No se pudo identificar el empleado');
                    return;
                }

                const empleadoId = parseInt(matchParams[1]);
                // Usar variable global sincronizada (no localStorage que puede estar corrupto)
                const empleado = empleados.find(e => e.id === empleadoId);
                if (!empleado) {
                    alert('Error: Empleado no encontrado');
                    return;
                }

                const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const normalizarMes = (valor) => (valor ?? '').toString().trim();
                mesNombre = normalizarMes(mesNombre);
                let mesNum = mesNombre ? mesesNombres.findIndex(m => lowerCaseSafe(m) === lowerCaseSafe(mesNombre)) : -1;
                let anioSeleccionado = anio || AppState.currentYear;
                const informeActual = (window.informeActual && window.informeActual.empleado) ? window.informeActual : null;

                if (mesNum === -1 && informeActual?.mes) {
                    const mesInf = normalizarMes(informeActual.mes);
                    const idx = mesInf ? mesesNombres.findIndex(m => lowerCaseSafe(m) === lowerCaseSafe(mesInf)) : -1;
                    if (idx !== -1) {
                        mesNum = idx;
                        mesNombre = mesInf;
                    }
                }

                if (Number.isFinite(informeActual?.anio)) {
                    anioSeleccionado = informeActual.anio;
                }

                if (mesNum === -1) {
                    alert('Error: No se puede identificar el mes del cuadrante');
                    return;
                }

                // üîß IMPORTANTE: Siempre obtener turnos frescos del AppState para evitar cache stale
                let turnosDelMes;
                const turnosDelAppState = AppState.scheduleData.get(empleadoId) || [];
                
                // Filtrar SIEMPRE desde AppState, nunca confiar en informeActual cacheado
                turnosDelMes = turnosDelAppState.filter(t => {
                    if (!t?.fecha) return false;
                    const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                    return fecha.getMonth() === mesNum && fecha.getFullYear() === anioSeleccionado;
                });
                
                // Calcular totalHoras SIEMPRE desde los turnos filtrados
                const totalHoras = Math.round(turnosDelMes.reduce((sum, t) => sum + (t?.horas || 0), 0) * 100) / 100;
                
                console.log(`üîµ [enviarWhatsAppIndividual] Turnos del empleado ${empleadoId}: ${turnosDelAppState.length} total, ${turnosDelMes.length} del mes ${mesNum + 1}/${anioSeleccionado}, Total horas: ${totalHoras}h`);

                const horasContrato = parseFloat(empleado.horasContrato) || 0;
                const balance = totalHoras - horasContrato;
                const cumplimiento = horasContrato > 0 ? Math.round((totalHoras / horasContrato) * 100) : 0;

                const pdfBundle = await generarImagenCuadranteVisual({
                    empleado,
                    turnos: turnosDelMes,
                    mes: mesNombre,
                    anio: anioSeleccionado,
                    mesNum,
                    totalHoras
                });
                console.log('‚úÖ [enviarWhatsAppIndividual] PDF generado correctamente:', pdfBundle.fileName);

                let mensaje = `üìã *CUADRANTE MENSUAL*\n\n`;
                mensaje += `*${empleado.nombre}*\n`;
                mensaje += `\n*üìä Resumen ${mesNombre} ${anioSeleccionado}:*\n`;
                mensaje += `‚Ä¢ Horas Trabajadas: ${totalHoras}h\n`;
                mensaje += `‚Ä¢ Balance: ${balance >= 0 ? '+' : ''}${balance.toFixed(2)}h\n`;
                mensaje += `‚Ä¢ Cumplimiento: ${cumplimiento}%\n`;
                mensaje += `‚Ä¢ Contrato: ${horasContrato}h mensuales\n\n`;
                mensaje += `üìé Te adjunto el PDF con el calendario completo y todos los turnos.`;

                const numeroWhatsApp = empleado.telefono ? empleado.telefono.replace(/\D/g, '') : '';
                if (!numeroWhatsApp) {
                    URL.revokeObjectURL(pdfBundle.url);
                    alert('‚ùå El empleado no tiene n√∫mero de tel√©fono registrado');
                    return;
                }

                // üîÑ Estrategia simplificada: descargar PDF + abrir WhatsApp Web
                console.log('üì• Descargando PDF:', pdfBundle.fileName);
                const linkPdf = document.createElement('a');
                linkPdf.href = pdfBundle.url;
                linkPdf.download = pdfBundle.fileName;
                document.body.appendChild(linkPdf);
                linkPdf.click();
                document.body.removeChild(linkPdf);
                console.log('‚úÖ PDF descargado, abriendo WhatsApp en 1 segundo...');

                if (typeof NotificationSystem !== 'undefined') {
                    NotificationSystem.show('üì• PDF descargado ‚Ä¢ üì± Abriendo WhatsApp...', 'info', 5000);
                }

                // Esperar a que el PDF se descargue completamente antes de abrir WhatsApp
                setTimeout(() => {
                    console.log('üü¢ Abriendo WhatsApp App con mensaje...');
                    const urlWhatsApp = `whatsapp://send?phone=${numeroWhatsApp}&text=${encodeURIComponent(mensaje)}`;
                    console.log('üîó URL WhatsApp App:', urlWhatsApp.substring(0, 50) + '...');
                    window.location.href = urlWhatsApp;
                }, 1000);

                setTimeout(() => {
                    URL.revokeObjectURL(pdfBundle.url);
                }, 15000);

            } catch (error) {
                console.error('‚ùå [enviarWhatsAppIndividual] Error:', error);
                console.error('Stack:', error.stack);
                alert('Error en WhatsApp: ' + error.message);
            }
        }

        // Copiar al portapapeles
        function copiarAlPortapapelesInforme() {
            try {
                if (!window.informeActual) {
                    alert('No hay datos para exportar');
                    return;
                }
                const { empleado, turnos, mes, anio, totalHoras } = window.informeActual;
                
                let mensaje = `üìã Cuadrante de Turnos\n`;
                mensaje += `Empleado: ${empleado.nombre}\n`;
                mensaje += `Mes: ${mes} ${anio}\n`;
                mensaje += `Horas: ${totalHoras}h\n\n`;
                
                turnos.forEach(turno => {
                    const fecha = turno.fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                    mensaje += `${fecha}: ${turno.turno} (${turno.horas}h)\n`;
                });
                
                navigator.clipboard.writeText(mensaje);
                if (typeof NotificationSystem !== 'undefined') {
                    NotificationSystem.show('Copiado al portapapeles', 'success');
                }
            } catch (error) {
                console.error('Error portapapeles:', error);
                alert('Error: ' + error.message);
            }
        }

        // Funciones de exportaci√≥n removidas - El informe simplificado solo muestra filtros
        // Las opciones de exportaci√≥n se pueden gestionar desde el cuadrante general

    </script>

    <!-- SCRIPT FINAL DE INICIALIZACI√ìN -->
    <script>
        setTimeout(() => {
        }, 100);
    </script>

    <!-- Script de inicializaci√≥n final -->
    <script>
        // Sistema de detecci√≥n de conexi√≥n del servidor
        let tiempoIntento = 0;
        let intervaloDeteccion = null;
        
        window.verificarConexionServidor = async function() {
            return new Promise((resolve) => {
                const img = new Image();
                const timeout = setTimeout(() => {
                    resolve(false);
                }, 3000);
                
                img.onload = () => {
                    clearTimeout(timeout);
                    console.log('‚úÖ Servidor disponible');
                    resolve(true);
                };
                
                img.onerror = () => {
                    clearTimeout(timeout);
                    console.log('‚ùå Servidor no disponible');
                    resolve(false);
                };
                
                // Usar un recurso que siempre existe en el servidor
                img.src = 'http://localhost:8000/nuevo_cuadrante_mejorado.html?t=' + Date.now();
            });
        }
        
        // üåê CARGAR FESTIVOS DESDE INTERNET (API date.nager.at) CON FILTRO OFICIAL
        async function cargarFestivosDesdeInternet(a√±o) {
            try {
                console.log(`üì° Cargando festivos de Espa√±a para ${a√±o} desde date.nager.at...`);
                const response = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${a√±o}/ES`, {
                    timeout: 5000
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const festivos = await response.json();
                const festivosConvertidos = festivos
                    .map(f => ({
                        mes: new Date(f.date).getMonth(),
                        dia: new Date(f.date).getDate(),
                        nombre: f.localName || f.name,
                        tipo: f.type || 'Public'
                    }))
                    // üîç FILTRAR: Solo d√≠as que est√°n en la lista oficial de Espa√±a
                    .filter(f => {
                        const diasOficiales = FESTIVOS_NACIONALES_OFICIALES_ESPA√ëA[f.mes];
                        if (!diasOficiales) return false;
                        return diasOficiales.includes(f.dia);
                    });
                
                console.log(`‚úÖ ${festivosConvertidos.length} festivos cargados desde Internet (filtrados oficialmente)`);
                return festivosConvertidos;
            } catch (error) {
                console.warn(`‚ö†Ô∏è No se pudo cargar festivos de Internet: ${error.message}`);
                return null;
            }
        }
        
        // üîÑ INICIALIZAR FESTIVOS (siempre intenta Internet; cach√© solo como respaldo)
        async function inicializarFestivos() {
            const a√±o = new Date().getFullYear();
            const cacheKey = `festivos_cache_${a√±o}`;
            const timestampKey = `festivos_timestamp_${a√±o}`;

            const aplicarFestivos = (lista, origen = 'cache') => {
                if (!lista || !Array.isArray(lista)) return false;
                const festivosValidados = lista.filter(f => !(f.mes === 11 && f.dia === 26));
                CALENDARIO_FESTIVOS_2025.nacionales = festivosValidados;
                console.log(`‚úÖ Festivos cargados desde ${origen} (${festivosValidados.length})`);
                return true;
            };

            const cachedData = localStorage.getItem(cacheKey);
            if (cachedData && aplicarFestivos(JSON.parse(cachedData), 'cache')) {
                // Continuar para refrescar desde Internet, sin retornar
            }

            const festivosInternet = await cargarFestivosDesdeInternet(a√±o);
            if (festivosInternet && festivosInternet.length > 0) {
                aplicarFestivos(festivosInternet, 'internet');
                localStorage.setItem(cacheKey, JSON.stringify(festivosInternet));
                localStorage.setItem(timestampKey, Date.now().toString());
                console.log('üíæ Cach√© de festivos actualizado');
                return;
            }

            if (!cachedData) {
                console.warn('‚ùå No se pudieron cargar festivos desde Internet ni existe cach√©');
            }
        }
        
        // üé® GENERAR LEYENDA DIN√ÅMICAMENTE DESDE TIPOS DE TURNOS
        function generarLeyendaDinamica() {
            const contenedor = document.getElementById('leyendaTurnos');
            if (!contenedor) return;
            
            // Primero, crear un objeto con los colores predeterminados
            let tiposTurnoConfig = {};
            
            // Si existe tiposTurno global, usarlo como base (incluye todos los campos)
            if (typeof tiposTurno !== 'undefined' && tiposTurno) {
                for (const [clave, datos] of Object.entries(tiposTurno)) {
                    tiposTurnoConfig[clave] = {
                        color: datos.color || '#d4edda',
                        nombre: datos.nombre || clave.charAt(0).toUpperCase() + clave.slice(1)
                    };
                }
            } else {
                // Fallback: colores predeterminados si tiposTurno no existe
                tiposTurnoConfig = {
                    ma√±ana: { color: '#d4edda', nombre: 'Ma√±ana' },
                    tarde: { color: '#fff3cd', nombre: 'Tarde' },
                    noche: { color: '#f8d7da', nombre: 'Noche' },
                    mixto: { color: '#cce5ff', nombre: 'Mixto' },
                    descanso: { color: '#e2e3e5', nombre: 'Descanso' },
                    vacaciones: { color: '#d0ebff', nombre: 'Vacaciones' },
                    baja: { color: '#ffe3e3', nombre: 'Baja' },
                    libre: { color: '#e0e0e0', nombre: 'Libre' },
                    festivo: { color: '#fff9e6', nombre: 'Festivo' }
                };
            }
            
            // Si existen tipos de turnos guardados en localStorage, actualizar los colores
            try {
                const tiposTurnoGuardados = localStorage.getItem('tiposTurnoData');
                if (tiposTurnoGuardados) {
                    const tipos = JSON.parse(tiposTurnoGuardados);
                    for (const [clave, datos] of Object.entries(tipos)) {
                        if (tiposTurnoConfig[clave] && datos.color) {
                            tiposTurnoConfig[clave].color = datos.color;
                        }
                        // Si el turno no existe a√∫n en config pero existe en storage, agregarlo
                        if (!tiposTurnoConfig[clave]) {
                            tiposTurnoConfig[clave] = {
                                color: datos.color || '#d4edda',
                                nombre: datos.nombre || clave
                            };
                        }
                    }
                }
            } catch (e) {
                console.warn('No se pudieron cargar colores desde localStorage:', e);
            }
            
            // Generar HTML de la leyenda en UNA SOLA FILA horizontal
            let html = '<div style="display: flex; flex-wrap: nowrap; gap: 24px; align-items: center; overflow-x: auto; padding: 5px 0;">';
            
            for (const [clave, config] of Object.entries(tiposTurnoConfig)) {
                html += `
                    <div class="legend-item" style="display: flex; align-items: center; gap: 12px; flex-shrink: 0;">
                        <div style="background: ${config.color}; width: 24px; height: 24px; border-radius: 4px; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1);"></div>
                        <span style="font-size: 15px; color: #e2e8f0; font-weight: 600; white-space: nowrap;">${config.nombre}</span>
                    </div>
                `;
            }
            
            html += '</div>';
            contenedor.innerHTML = html;
        }
        
        // MODAL COMPLETAMENTE ELIMINADO
        // El servidor se verifica en el launcher (Python) ANTES de abrir el navegador
        // por lo que este modal ya no es necesario
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // ‚ö†Ô∏è VERIFICAR SI SE EST√Å USANDO file:// (sin servidor)
                if (window.location.protocol === 'file:') {
                    console.warn('‚ùå ADVERTENCIA: Abierto como archivo local. localhost NO funcionar√°. Usa http://localhost:8000');
                    // Si es file://, esperar a que el usuario abra en http://localhost
                    return;
                }
                
                // Si llegamos aqu√≠, estamos en http://localhost, el servidor DEFINITIVAMENTE est√° disponible
                
                console.log('üü¢ INIT: Iniciando carga de datos...');;
                
                // PASO 0: Cargar festivos desde Internet (o cach√© si no hay conexi√≥n)
                console.log('üìÖ Paso 0: Cargando festivos...');
                await inicializarFestivos();
                
                // PASO 1: Guardar tipos de turnos predeterminados en localStorage
                if (typeof TurnoTypeManager !== 'undefined' && typeof tiposTurno !== 'undefined') {
                    const tiposTurnoExistente = localStorage.getItem('tiposTurnoData');
                    if (!tiposTurnoExistente) {
                        TurnoTypeManager.guardarEnStorage();
                        console.log('‚úì Tipos de turnos iniciales guardados');
                    } else {
                        console.log('‚úì Tipos de turnos ya existen en localStorage');
                    }
                    // Generar leyenda din√°mica con colores actualizados
                    if (typeof generarLeyendaDinamica === 'function') {
                        generarLeyendaDinamica();
                        console.log('‚úì Leyenda din√°mica generada');
                    }
                }
                
                // PASO 2: Cargar empleados desde API
                if (typeof EmployeeManager !== 'undefined') {
                    EmployeeManager.cargarDelStorage();
                    console.log('‚úì Empleados cargados:', empleados.length);
                    
                    // Si no hay empleados, guardar los por defecto
                    if (empleados.length === 0) {
                        console.warn('‚ö†Ô∏è No hab√≠a empleados en localStorage, usando empleados por defecto');
                        EmployeeManager.guardarEnStorage();
                        console.log('‚úì Empleados por defecto guardados');
                    }
                }
                
                // PASO 3: Cargar tipos de turnos desde storage
                if (typeof TurnoTypeManager !== 'undefined') {
                    TurnoTypeManager.cargarDelStorage();
                    console.log('‚úì Tipos de turnos cargados');
                }
                
                // PASO 4: Cargar estado anterior (AppState - solo turnos, NO mes/a√±o)
                if (typeof AppState !== 'undefined') {
                    await AppState.loadFromStorage();
                    console.log('‚úì AppState cargado - Turnos guardados:', AppState.scheduleData.size);
                }
                
                // üåê PASO 4B: INICIALIZAR SEMANA 4 - ESCALABILIDAD (GestorMultiLocal, IntegracionCalendario, SistemaNotificaciones)
                try {
                    if (typeof GestorMultiLocal !== 'undefined') {
                        GestorMultiLocal.init();
                        console.log('‚úì GestorMultiLocal inicializado');
                    }
                    if (typeof IntegracionCalendario !== 'undefined') {
                        IntegracionCalendario.init();
                        console.log('‚úì IntegracionCalendario inicializado');
                    }
                    if (typeof SistemaNotificaciones !== 'undefined') {
                        SistemaNotificaciones.init();
                        console.log('‚úì SistemaNotificaciones inicializado');
                    }
                    if (typeof ControlesSemana4 !== 'undefined') {
                        ControlesSemana4.init();
                        console.log('‚úì ControlesSemana4 (UI Sidebar) inicializado');
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Error al inicializar Semana 4:', e.message);
                }
                
                // üîÑ INICIALIZAR SISTEMA REACTIVO
                if (typeof SistemaReactividad !== 'undefined') {
                    SistemaReactividad.inicializar();
                    console.log('‚úì Sistema de Reactividad inicializado');
                }
                
                // PASO 5: SIEMPRE usar el mes y a√±o ACTUAL (sin parpadeos)
                const ahora = new Date();
                const mesActual = ahora.getMonth();
                const anioActual = ahora.getFullYear();
                
                if (typeof AppState !== 'undefined') {
                    AppState.currentMonth = mesActual;
                    AppState.currentYear = anioActual;
                    console.log('‚úì Iniciando en mes ACTUAL:', mesActual, '/', anioActual);
                }
                
                // PASO 6: Mostrar bot√≥n si est√° vac√≠o (NO auto-generar)
                // ‚ö†Ô∏è Ejecutar con delay LARGO para asegurar que modules.js est√° cargado
                setTimeout(() => {
                    try {
                        if (typeof TurnoManager !== 'undefined' && typeof TurnoManager.verificarYMostrarBoton === 'function') {
                            console.log('[INIT] üîò Verificando si mostrar bot√≥n generar turnos...');
                            TurnoManager.verificarYMostrarBoton();
                            console.log('[INIT] ‚úÖ Bot√≥n verificado');
                            const btnState = document.getElementById('btnGenerarTurnos')?.style?.display;
                            console.log('[INIT] Estado bot√≥n:', btnState);
                        } else {
                            console.log('[INIT] ‚ùå TurnoManager.verificarYMostrarBoton no disponible a√∫n');
                        }
                    } catch (e) {
                        console.error('[INIT] Error al verificar bot√≥n:', e.message);
                    }
                }, 2000);  // 2 segundos para asegurar que modules.js est√° cargado
                
                // PASO 7: Actualizar selectores de mes y a√±o INMEDIATAMENTE (evita parpadeos)
                const selectYear = document.getElementById('selectYear');
                const selectMonth = document.getElementById('selectMonth');
                
                if (selectMonth) {
                    selectMonth.value = window.__initialMonth;
                }
                
                if (selectYear) {
                    selectYear.value = window.__initialYear;
                }
                
                // PASO 8: Generar cuadrante general
                if (typeof UI !== 'undefined') {
                    UI.generarCuadranteGeneral();
                    UI.actualizarTitulosMes();
                    // Actualizar KPIs con reintento si no est√° disponible
                    if (typeof UI.actualizarKPIsGeneral === 'function') {
                        UI.actualizarKPIsGeneral();
                        console.log('‚úì KPIs actualizados');
                    } else {
                        console.warn('‚ö†Ô∏è UI.actualizarKPIsGeneral no disponible a√∫n, se ejecutar√° despu√©s');
                        setTimeout(() => {
                            // Funci√≥n inline para actualizar KPIs directamente
                            try {
                                if (!window.AppState || !window.AppState.scheduleData) {
                                    console.warn('‚ö†Ô∏è AppState no est√° inicializado');
                                    return;
                                }
                                
                                let totalEmpleados = window.empleados ? window.empleados.length : 0;
                                let totalHoras = 0;
                                let turnosMa√±ana = 0;
                                let turnosTarde = 0;
                                let turnosNoche = 0;
                                
                                // Iterar sobre todos los empleados y TODOS los turnos
                                // Filtrar solo por el mes ACTUAL
                                const mesActual = AppState.currentMonth;
                                const anioActual = AppState.currentYear;
                                console.log(`üîÑ KPIs: Filtrando turnos para mes ${mesActual}/${anioActual} (Map size: ${AppState.scheduleData.size})`);
                                
                                if (window.empleados && window.empleados.length > 0) {
                                    window.empleados.forEach(empleado => {
                                        const turnos = window.AppState.scheduleData.get(empleado.id) || [];
                                        
                                        // Filtrar solo turnos del mes actual
                                        const turnosDelMes = turnos.filter(t => {
                                            const fecha = new Date(t.fecha);
                                            return fecha.getMonth() === mesActual && fecha.getFullYear() === anioActual;
                                        });
                                        
                                        // Contar turnos del mes actual
                                        turnosDelMes.forEach((turno, idx) => {
                                            if (turno) {
                                                const horas = turno.horas || 0;
                                                totalHoras += horas;
                                                if (turno.turno === 'ma√±ana') turnosMa√±ana++;
                                                if (turno.turno === 'tarde') turnosTarde++;
                                                if (turno.turno === 'noche') turnosNoche++;
                                            }
                                        });
                                    });
                                }
                                
                                // Inyectar valores en HTML
                                const totalEmpleadosEl = document.getElementById('totalEmpleadosGeneral');
                                const totalHorasEl = document.getElementById('totalHorasGeneral');
                                const turnosMa√±anaEl = document.getElementById('turnosMa√±anaGeneral');
                                const turnosTardeEl = document.getElementById('turnosTardeGeneral');
                                const turnosNocheEl = document.getElementById('turnosNocheGeneral');
                                
                                if (totalEmpleadosEl) totalEmpleadosEl.textContent = totalEmpleados;
                                if (totalHorasEl) totalHorasEl.textContent = totalHoras.toFixed(1);
                                if (turnosMa√±anaEl) turnosMa√±anaEl.textContent = turnosMa√±ana;
                                if (turnosTardeEl) turnosTardeEl.textContent = turnosTarde;
                                if (turnosNocheEl) turnosNocheEl.textContent = turnosNoche;
                                
                                console.log(`‚úì KPIs actualizados (inline): Empleados=${totalEmpleados}, Horas=${totalHoras.toFixed(1)}, Ma√±ana=${turnosMa√±ana}, Tarde=${turnosTarde}, Noche=${turnosNoche}`);
                            } catch (e) {
                                console.error('‚ùå Error actualizando KPIs:', e.message);
                            }
                        }, 3500);
                    }
                    console.log('‚úì Cuadrante general generado');
                }

                // ‚úÖ DESHABILITADO: Verificar y mostrar bot√≥n (causa loop sincronizaci√≥n)
                // if (typeof TurnoManager !== 'undefined' && typeof TurnoManager.verificarYMostrarBoton === 'function') {
                //     setTimeout(() => {
                //         TurnoManager.verificarYMostrarBoton();
                //         console.log('‚úì Bot√≥n de generaci√≥n verificado');
                //     }, 300);
                // }
                
                // Inicializar y llenar filtros del cuadrante general
                const filtroDepartamentoGeneral = document.getElementById('filtroDepartamentoGeneral');
                const filtroEstadoGeneral = document.getElementById('filtroEstadoGeneral');
                
                if (filtroDepartamentoGeneral) {
                    // Obtener departamentos √∫nicos
                    const departamentos = [...new Set(empleados.map(e => e.departamento))].sort();
                    departamentos.forEach(depto => {
                        const option = document.createElement('option');
                        option.value = depto;
                        option.textContent = depto;
                        filtroDepartamentoGeneral.appendChild(option);
                    });
                    
                    // Agregar event listener para filtrar
                    filtroDepartamentoGeneral.addEventListener('change', () => {
                        if (typeof UI !== 'undefined') {
                            UI.generarCuadranteGeneral();
                        }
                    });
                }
                
                if (filtroEstadoGeneral) {
                    // Obtener estados √∫nicos
                    const estados = [...new Set(empleados.map(e => e.estado))].sort();
                    estados.forEach(estado => {
                        const option = document.createElement('option');
                        option.value = estado;
                        option.textContent = estado.charAt(0).toUpperCase() + estado.slice(1);
                        filtroEstadoGeneral.appendChild(option);
                    });
                    
                    // Agregar event listener para filtrar
                    filtroEstadoGeneral.addEventListener('change', () => {
                        if (typeof UI !== 'undefined') {
                            UI.generarCuadranteGeneral();
                        }
                    });
                }
                
                // Llenar opciones de centros de trabajo en el filtro
                if (typeof llenarCentrosDeTrabajo !== 'undefined') {
                    llenarCentrosDeTrabajo();
                    
                    // Establecer mes y a√±o actual por defecto en informe individual
                    document.getElementById('selectMesIndividual').value = mesActual;
                    document.getElementById('selectAnioIndividual').value = anioActual;
                }
                
                // Llenar opciones de departamentos en el filtro
                const selectDepartamentoIndividual = document.getElementById('selectDepartamentoIndividual');
                if (selectDepartamentoIndividual && typeof DepartmentManager !== 'undefined') {
                    try {
                        let departamentosArray = [];
                        
                        // Manejar caso donde DepartmentManager.departamentos puede ser array u objeto
                        if (Array.isArray(DepartmentManager.departamentos)) {
                            departamentosArray = DepartmentManager.departamentos;
                        } else if (typeof DepartmentManager.departamentos === 'object' && DepartmentManager.departamentos !== null) {
                            // Si es un objeto (Map o diccionario), convertir a array
                            departamentosArray = Object.values(DepartmentManager.departamentos);
                        }
                        
                        const departamentos = [...new Set(departamentosArray
                            .map(d => typeof d === 'string' ? d : d.nombre)
                            .filter(Boolean)
                        )].sort();
                        
                        departamentos.forEach(depto => {
                            const option = document.createElement('option');
                            option.value = depto;
                            option.textContent = depto;
                            selectDepartamentoIndividual.appendChild(option);
                        });
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Error llenando departamentos:', e.message);
                    }
                }
                
                // üîß Agregar event listeners para cambiar mes/a√±o desde los selectores
                if (selectYear) {
                    selectYear.addEventListener('change', async () => {
                        const nuevoA√±o = parseInt(selectYear.value);
                        if (nuevoA√±o !== AppState.currentYear) {
                            AppState.setYear(nuevoA√±o);
                            await TurnoManager.reiniciarDatos();
                            UI.generarCuadranteGeneral();
                            UI.actualizarTitulosMes();
                        }
                    });
                }
                
                if (selectMonth) {
                    selectMonth.addEventListener('change', async () => {
                        const nuevoMes = parseInt(selectMonth.value);
                        if (nuevoMes !== AppState.currentMonth) {
                            AppState.setMonth(nuevoMes);
                            await TurnoManager.reiniciarDatos();
                            UI.generarCuadranteGeneral();
                            UI.actualizarTitulosMes();
                        }
                    });
                }
                
                // ‚úÖ SEMANA 1: INICIALIZAR NUEVOS M√ìDULOS DE MEJORA
                console.log('üöÄ Inicializando m√≥dulos de Semana 1...');
                
                // Inicializar TabSyncManager PRIMERO (escucha eventos)
                if (typeof TabSyncManager !== 'undefined') {
                    TabSyncManager.init();
                    console.log('‚úÖ TabSyncManager inicializado');
                }
                
                // Inicializar AutoSaveManager SEGUNDO (guarda autom√°ticamente)
                if (typeof AutoSaveManager !== 'undefined') {
                    AutoSaveManager.init();
                    console.log('‚úÖ AutoSaveManager inicializado');
                }
                
                // Inicializar UI del AutoSaveManager (m√≥dulo modular)
                if (typeof AutoSaveUIModule !== 'undefined') {
                    AutoSaveUIModule.init();
                    console.log('‚úÖ AutoSaveUIModule inicializado');
                }
                
                // Inicializar AutoSave con Persistencia BD (m√≥dulo modular)
                if (typeof AutoSaveBDModule !== 'undefined') {
                    AutoSaveBDModule.init();
                    console.log('‚úÖ AutoSaveBDModule inicializado (persistencia BD)');
                }

                // Inicializar SincronizacionDatos (backup autom√°tico)
                if (typeof SincronizacionDatos !== 'undefined') {
                    SincronizacionDatos.init();
                    console.log('‚úÖ SincronizacionDatos inicializado (backup autom√°tico cada 5 min)');
                }
                
                // Validar integridad de datos
                if (typeof ValidadorDatos !== 'undefined') {
                    const reporte = ValidadorDatos.generarReporte();
                    console.log('üìã Reporte de validaci√≥n de datos:');
                    console.table(reporte.validaciones);
                    if (reporte.validaciones.integridad.integro) {
                        console.log('‚úÖ Integridad de datos verificada');
                    } else {
                        console.warn('‚ö†Ô∏è Problemas en integridad:', reporte.validaciones.integridad.problemas);
                    }
                }
                
                // Mostrar mensaje de bienvenida
                if (typeof NotificationSystem !== 'undefined') {
                    NotificationSystem.show('¬°Bienvenido! Aplicaci√≥n cargada correctamente', 'info', 3000);
                }
                
                // ‚úÖ AGREGAR LISTENER AL BOT√ìN DE AUTO-GUARDADO (para asegurar que SIEMPRE funcione)
                setTimeout(() => {
                    const btnAutoGuardado = document.querySelector('button[onclick="abrirAutoGuardado()"]');
                    if (btnAutoGuardado) {
                        btnAutoGuardado.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('üîê Click detectado en bot√≥n Auto-guardado');
                            window.abrirAutoGuardado();
                        });
                        console.log('‚úÖ Listener agregado al bot√≥n Auto-guardado');
                    } else {
                        console.warn('‚ö†Ô∏è Bot√≥n Auto-guardado no encontrado');
                    }
                }, 100);
                
                // ‚úÖ GUARDAR DATOS AL CERRAR LA P√ÅGINA O PESTA√ëA
                window.addEventListener('beforeunload', () => {
                    if (typeof AppState !== 'undefined') {
                        AppState.saveToStorage();
                        console.log('‚úì Datos guardados al cerrar p√°gina');
                    }
                });
                
                // üîç MONITOR CONTINUO DE CONEXI√ìN
                // DESHABILITADO: Ya no es necesario con el launcher que verifica antes de abrir
                // Verifica cada 5 segundos si el servidor sigue disponible
                // Si cae, muestra el modal de reconexi√≥n autom√°ticamente
                // setInterval(async () => {
                //     try {
                //         const conectado = await verificarConexionServidor();
                //         if (!conectado && !document.getElementById('modalReconexion')) {
                //             console.warn('‚ö†Ô∏è CONEXI√ìN PERDIDA - Mostrando modal de reconexi√≥n autom√°tica');
                //             mostrarModalReconexion();
                //         }
                //     } catch (err) {
                //         console.error('Error verificando conexi√≥n:', err);
                //     }
                // }, 5000);
                
                console.log('‚úÖ Aplicaci√≥n cargada correctamente');
            } catch (error) {
                console.error('Error en inicializaci√≥n:', error);
            }
        });
    </script>

    <!-- Fallback INMEDIATO: Crear objetos base antes que todo para evitar undefined -->
    <script>
        // Esto se ejecuta ANTES que los m√≥dulos, proporciona fallbacks
        
        // üîß D√çAS FESTIVOS ESPA√ëOLES - Para detectar autom√°ticamente guardias
        // üîß CONFIGURACI√ìN FESTIVOS ESPA√ëA + MADRID + GETAFE
        // üìÖ CALENDARIO GENERAL - FESTIVOS DESDE INTERNET + CACH√â LOCAL
        // ‚ö†Ô∏è RANGO DE MESES: 0-11 (como JavaScript getMonth())
        // enero=0, febrero=1, ..., diciembre=11
        // Se carga desde API p√∫blica (date.nager.at) al iniciar
        
        // ‚úÖ LISTA OFICIAL DE FESTIVOS NACIONALES ESPA√ëA (validados)
        // Solo estos d√≠as son considerados festivos nacionales
        const FESTIVOS_NACIONALES_OFICIALES_ESPA√ëA = {
            0: [1, 6],           // Enero: A√±o Nuevo (1), Reyes (6)
            3: [1],              // Abril: Jueves Santo (aprox. 1)
            4: [1],              // Mayo: D√≠a del Trabajo (1)
            7: [15],             // Agosto: Asunci√≥n (15)
            9: [12],             // Octubre: Hispanidad (12)
            10: [1],             // Noviembre: Todos los Santos (1)
            11: [6, 8, 25]       // Diciembre: Constituci√≥n (6), Inmaculada (8), Navidad (25)
        };
        
        const CALENDARIO_FESTIVOS_2025 = {
            // FESTIVOS NACIONALES - Se cargan desde Internet al iniciar (default es fallback)
            nacionales: [
                { mes: 0, dia: 1, nombre: 'A√±o Nuevo' },
                { mes: 0, dia: 6, nombre: 'Reyes Magos' },
                { mes: 3, dia: 1, nombre: 'Jueves Santo' },  // Aproximado
                { mes: 4, dia: 1, nombre: 'D√≠a del Trabajo' },
                { mes: 7, dia: 15, nombre: 'Asunci√≥n' },
                { mes: 9, dia: 12, nombre: 'Hispanidad' },
                { mes: 10, dia: 1, nombre: 'Todos los Santos' },
                { mes: 11, dia: 6, nombre: 'Constituci√≥n' },
                { mes: 11, dia: 8, nombre: 'Inmaculada Concepci√≥n' },
                { mes: 11, dia: 25, nombre: 'Navidad' }
            ],
            
            // FESTIVOS LOCALES POR LOCALIDAD
            localidades: {
                'Getafe': [
                    { mes: 4, dia: 30, nombre: 'San Fernando (Patr√≥n de Getafe)' },
                    { mes: 6, dia: 25, nombre: 'Santiago Ap√≥stol' }
                ],
                'Madrid': [
                    { mes: 4, dia: 2, nombre: 'Fiesta de Madrid' }
                ],
                'Legan√©s': [
                    { mes: 10, dia: 12, nombre: 'San Froil√°n' }
                ],
                'Fuenlabrada': [
                    { mes: 9, dia: 7, nombre: 'Virgen del Rosario' }
                ],
                'M√≥stoles': [
                    { mes: 10, dia: 25, nombre: 'Cristo de la Vega' }
                ]
            }
        };
        
        // üîç FUNCI√ìN CENTRAL: Obtener todos los festivos para una localidad
        function obtenerFestivosLocalidad(localidad) {
            if (!localidad || !CALENDARIO_FESTIVOS_2025.localidades[localidad]) {
                return CALENDARIO_FESTIVOS_2025.nacionales;
            }
            return [
                ...CALENDARIO_FESTIVOS_2025.nacionales,
                ...CALENDARIO_FESTIVOS_2025.localidades[localidad]
            ];
        }
        
        // üîç FUNCI√ìN CENTRAL: Verificar si una fecha es festivo para una localidad
        function esFestivoBuscado(fecha, localidad) {
            if (!fecha) return false;
            const d = fecha instanceof Date ? fecha : new Date(fecha);
            const festivos = obtenerFestivosLocalidad(localidad);
            return festivos.some(f => f.mes === d.getMonth() && f.dia === d.getDate());
        }
        
        // Variable global para seleccionar localidad (por defecto: Getafe)
        if (!window.localidadFestivos) {
            window.localidadFestivos = 'Getafe';
        }
        
        // Combinar festivos seg√∫n localidad (para compatibilidad hacia atr√°s)
        const obtenerDiasFestivos = () => obtenerFestivosLocalidad(window.localidadFestivos);

        
        const DIAS_FESTIVOS_ES = obtenerDiasFestivos();
        
        // üîß FUNCI√ìN AUXILIAR: Detectar si una fecha es festiva
        function esFestivo(fecha) {
            if (!fecha) return false;
            const d = fecha instanceof Date ? fecha : new Date(fecha);
            const festivos = obtenerDiasFestivos();
            return festivos.some(f => f.mes === d.getMonth() && f.dia === d.getDate());
        }

        // üîß NUEVA FUNCI√ìN: Obtener festivos espec√≠ficos de un empleado por su localidad
        function obtenerFestivosEmpleado(empleadoId) {
            const empleado = empleados?.find(e => e.id === empleadoId);
            if (!empleado || !empleado.localidad) {
                return obtenerFestivosLocalidad('Getafe'); // Default a Getafe
            }
            return obtenerFestivosLocalidad(empleado.localidad);
        }

        // üîß NUEVA FUNCI√ìN: Detectar si una fecha es festiva para un empleado espec√≠fico
        function esFestivoLocal(fecha, empleadoId) {
            if (!fecha) return false;
            const d = fecha instanceof Date ? fecha : new Date(fecha);
            const festivos = obtenerFestivosEmpleado(empleadoId);
            return festivos.some(f => f.mes === d.getMonth() && f.dia === d.getDate());
        }
        
        // üîß ASIGNAR A WINDOW PARA ACCESO GLOBAL
        window.esFestivoLocal = esFestivoLocal;
        
        if (!window.AppState) {
            window.AppState = {
                currentYear: new Date().getFullYear(),
                currentMonth: new Date().getMonth(),
                scheduleData: new Map(),
                selectedEmployee: null,
                cambiosPendientes: [],
                setMonth: function(mes) {
                    this.currentMonth = mes;
                    console.log(`‚úì Mes establecido a: ${mes}`);
                },
                setYear: function(a√±o) {
                    this.currentYear = a√±o;
                    console.log(`‚úì A√±o establecido a: ${a√±o}`);
                },
                saveToStorage: function() {
                    try {
                        const dataToSave = {
                            scheduleData: Object.fromEntries(this.scheduleData),
                            selectedEmployee: this.selectedEmployee,
                            currentMonth: this.currentMonth,
                            currentYear: this.currentYear
                        };
                        
                        console.log(`[AppState.saveToStorage] üíæ Guardando ${this.scheduleData.size} empleados...`);
                        const jsonStr = JSON.stringify(dataToSave);
                        console.log(`[AppState.saveToStorage] Tama√±o JSON: ${jsonStr.length} bytes`);
                        
                        localStorage.setItem('turnosAppState', jsonStr);
                        
                        // Verificar que se guard√≥
                        const verificacion = localStorage.getItem('turnosAppState');
                        if (verificacion) {
                            console.log(`‚úÖ [AppState.saveToStorage] GUARDADO EXITOSO (${verificacion.length} bytes)`);
                        } else {
                            console.error('‚ùå [AppState.saveToStorage] NO SE GUARD√ì EN localStorage!');
                        }
                    } catch (error) {
                        console.error('[AppState.saveToStorage] ‚ùå ERROR:', error);
                    }
                },
                loadFromStorage: function() {
                    try {
                        console.log('[AppState.loadFromStorage] üîç Intentando cargar desde API...');
                        
                        // Guardar 'this' para usarlo en la funci√≥n interna
                        const self = this;
                        let cargadosDesdeAPI = false;
                        
                        // Intentar cargar desde API primero
                        if (window.empleados && window.empleados.length > 0) {
                            for (let i = 0; i < window.empleados.length; i++) {
                                const empleado = window.empleados[i];
                                try {
                                    const xhr = new XMLHttpRequest();
                                    xhr.open('GET', `http://localhost:5001/api/turnos/${empleado.id}`, false); // S√≠ncrono
                                    xhr.send();
                                    
                                    if (xhr.status === 200) {
                                        const datos = JSON.parse(xhr.responseText);
                                        
                                        // Estructura API: { empleadoId: 1, turnos: { "2026-1": { mes: 1, anio: 2026, turnos: [...] } } }
                                        if (datos.turnos && typeof datos.turnos === 'object') {
                                            const turnosArray = [];
                                            
                                            // Iterar sobre meses (ej: "2026-1", "2026-2")
                                            for (const [key, mesData] of Object.entries(datos.turnos)) {
                                                if (mesData && Array.isArray(mesData.turnos)) {
                                                    // mesData.turnos es array: [{ dia, turno, horas, fecha, esFinSemana }, ...]
                                                    mesData.turnos.forEach(turno => {
                                                        turnosArray.push({
                                                            dia: turno.dia,
                                                            turno: turno.turno || 'descanso',
                                                            horas: turno.horas || 0,
                                                            horario: turno.horario || '-',
                                                            fecha: new Date(turno.fecha), // API ya env√≠a ISO string
                                                            esFinSemana: turno.esFinSemana || false
                                                        });
                                                    });
                                                }
                                            }
                                            
                                            if (turnosArray.length > 0) {
                                                self.scheduleData.set(empleado.id, turnosArray);
                                                cargadosDesdeAPI = true;
                                                console.log(`  ‚úì Empleado ${empleado.id} (${empleado.nombre}): ${turnosArray.length} turnos desde API`);
                                            }
                                        }
                                    }
                                } catch (e) {
                                    console.warn(`[AppState] Error cargando empleado ${empleado.id} desde API:`, e.message);
                                }
                            }
                        }
                        
                        if (cargadosDesdeAPI && self.scheduleData.size > 0) {
                            console.log(`‚úÖ [AppState.loadFromStorage] ${self.scheduleData.size} empleados cargados desde API`);
                            return;
                        }
                        
                        // Fallback: cargar desde localStorage si API no tiene datos
                        console.log('[AppState.loadFromStorage] Intentando cargar desde localStorage...');
                        const data = localStorage.getItem('turnosAppState');
                        
                        if (data) {
                            try {
                                const savedState = JSON.parse(data);
                                
                                // Cargar scheduleData (convertir a Map)
                                if (savedState.scheduleData && typeof savedState.scheduleData === 'object' && Object.keys(savedState.scheduleData).length > 0) {
                                    const scheduleMap = new Map();
                                    let totalTurnos = 0;
                                    
                                    for (const [empleadoId, turnos] of Object.entries(savedState.scheduleData)) {
                                        // Convertir fechas de string a Date objects
                                        const turnosConFechas = turnos.map(turno => ({
                                            ...turno,
                                            fecha: typeof turno.fecha === 'string' ? new Date(turno.fecha) : turno.fecha
                                        }));
                                        scheduleMap.set(parseInt(empleadoId), turnosConFechas);
                                        totalTurnos += turnosConFechas.length;
                                    }
                                    
                                    self.scheduleData = scheduleMap;
                                    console.log(`‚úÖ [AppState.loadFromStorage] ${scheduleMap.size} empleados, ${totalTurnos} turnos desde localStorage`);
                                } else {
                                    console.warn('[AppState.loadFromStorage] ‚ö†Ô∏è No hay scheduleData en localStorage');
                                }
                                
                                // Cargar empleado seleccionado
                                if (savedState.selectedEmployee) {
                                    this.selectedEmployee = savedState.selectedEmployee;
                                }
                            } catch (parseError) {
                                console.error('[AppState.loadFromStorage] ‚ùå Error parseando localStorage:', parseError.message);
                            }
                        } else {
                            console.log('[AppState.loadFromStorage] ‚ÑπÔ∏è No hay datos en localStorage');
                        }
                    } catch (error) {
                        console.error('[AppState.loadFromStorage] ‚ùå Error general:', error);
                    }
                }
            };
        }

        if (!window.EmployeeManager) {
            window.EmployeeManager = {
                abrirModal: () => {
                    const modal = document.getElementById('modalGestionEmpleados');
                    if (modal) modal.classList.add('active');
                },
                cerrarModal: () => {
                    const modal = document.getElementById('modalGestionEmpleados');
                    if (modal) modal.classList.remove('active');
                },
                mostrarFormularioNuevo: function() {
                    document.getElementById('formEmpleadosContenedor').style.display = 'block';
                    document.getElementById('listaEmpleados').style.display = 'none';
                    // Limpiar formulario (IDs nuevos del HTML)
                    document.getElementById('emple_nombre').value = '';
                    document.getElementById('emple_email').value = '';
                    document.getElementById('emple_telefono').value = '';
                    document.getElementById('emple_departamento').value = 'Limpieza';
                    document.getElementById('emple_localidad').value = 'Getafe';
                    document.getElementById('emple_horas').value = '169';
                    document.getElementById('emple_turno').value = 'Ma√±ana';
                    document.getElementById('emple_estado').value = 'activo';
                    // Llenar select de localidades
                    this.llenarSelectLocalidades();
                },
                cambiarEstadoPorMes: function(empleadoId, nuevoEstado) {
                    // ‚úÖ NUEVO: Cambiar estado del empleado SOLO para el mes actual
                    const estadoMensual = JSON.parse(localStorage.getItem('estadosPorMes') || '{}');
                    const keyEstado = `${empleadoId}_${AppState.currentYear}_${AppState.currentMonth}`;
                    estadoMensual[keyEstado] = nuevoEstado;
                    localStorage.setItem('estadosPorMes', JSON.stringify(estadoMensual));
                    
                    console.log(`‚úì Estado de empleado ${empleadoId} cambiado a "${nuevoEstado}" para ${AppState.currentMonth}/${AppState.currentYear}`);
                    
                    // Regenerar turnos del mes actual
                    TurnoManager.reiniciarDatos();
                    window._debouncedRender();
                    
                    NotificationSystem.show(`‚úì Estado actualizado para este mes`, 'success');
                },
                llenarSelectLocalidades: function() {
                    const select = document.getElementById('emple_localidad');
                    if (!select) return;
                    
                    const localidades = ['Getafe', 'Madrid', 'Legan√©s', 'Fuenlabrada', 'M√≥stoles'];
                    const currentValue = select.value || 'Getafe';
                    
                    select.innerHTML = '';
                    localidades.forEach(localidad => {
                        const opt = document.createElement('option');
                        opt.value = localidad;
                        opt.textContent = localidad;
                        opt.selected = (localidad === currentValue);
                        select.appendChild(opt);
                    });
                },
                cancelarFormulario: function() {
                    document.getElementById('formEmpleadosContenedor').style.display = 'none';
                    document.getElementById('listaEmpleados').style.display = 'block';
                    this.refrescarLista();
                },
                guardarEmpleado: async function() {
                    const nombre = document.getElementById('nombreEmpleadoForm')?.value.trim() || document.getElementById('emple_nombre')?.value.trim();
                    const email = document.getElementById('emailEmpleadoForm')?.value.trim() || document.getElementById('emple_email')?.value.trim();
                    const telefono = document.getElementById('telefonoEmpleadoForm')?.value.trim() || document.getElementById('emple_telefono')?.value.trim();
                    const departamento = document.getElementById('departamentoEmpleadoForm')?.value || document.getElementById('emple_departamento')?.value || 'Limpieza';
                    const localidad = document.getElementById('emple_localidad')?.value || 'Getafe';
                    const horasContrato = parseInt(document.getElementById('horasContratoForm')?.value || document.getElementById('emple_horas')?.value) || 169;
                    const turnoPrincipal = document.getElementById('turnoExoticForm')?.value || document.getElementById('emple_turno')?.value || 'ma√±ana';
                    const estado = document.getElementById('emple_estado')?.value || 'activo';
                    const empleadoIdEdicion = document.getElementById('empleadoIdEdicion')?.value; // Si est√° editando

                    // Validaciones
                    if (!nombre || nombre.length < 3) {
                        NotificationSystem.show('‚ùå El nombre debe tener al menos 3 caracteres', 'error', 0, {
                            acciones: ['editar', 'cerrar'],
                            callback: (accion) => {
                                if (accion === 'editar') {
                                    document.getElementById('nombreEmpleadoForm')?.focus() || document.getElementById('emple_nombre')?.focus();
                                }
                            }
                        });
                        return;
                    }
                    if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                        NotificationSystem.show('‚ùå Email inv√°lido (formato: usuario@dominio.com)', 'error', 0, {
                            acciones: ['editar', 'cerrar'],
                            callback: (accion) => {
                                if (accion === 'editar') {
                                    document.getElementById('emailEmpleadoForm')?.focus() || document.getElementById('emple_email')?.focus();
                                }
                            }
                        });
                        return;
                    }
                    if (telefono && telefono.length < 9) {
                        NotificationSystem.show('‚ùå El tel√©fono debe tener al menos 9 caracteres', 'error', 0, {
                            acciones: ['editar', 'cerrar'],
                            callback: (accion) => {
                                if (accion === 'editar') {
                                    document.getElementById('telefonoEmpleadoForm')?.focus() || document.getElementById('emple_telefono')?.focus();
                                }
                            }
                        });
                        return;
                    }

                    // ‚úÖ SI ES EDICI√ìN: Guardar estado SOLO para el mes actual
                    if (empleadoIdEdicion) {
                        const estadoMensual = JSON.parse(localStorage.getItem('estadosPorMes') || '{}');
                        const keyEstado = `${empleadoIdEdicion}_${AppState.currentYear}_${AppState.currentMonth}`;
                        estadoMensual[keyEstado] = estado;
                        localStorage.setItem('estadosPorMes', JSON.stringify(estadoMensual));
                        console.log(`‚úì Estado de empleado ${empleadoIdEdicion} cambiado a "${estado}" SOLO para ${AppState.currentMonth}/${AppState.currentYear}`);
                    }

                    try {
                        const response = await fetch('/api/empleados', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                nombre,
                                email,
                                telefono,
                                departamento,
                                localidad,
                                horasContrato,
                                turnoPrincipal,
                                estado,
                                foto: null
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            NotificationSystem.show(`‚úÖ ${nombre} agregado en ${localidad} correctamente`, 'success');

                            // Recargar empleados desde API
                            await this.cargarDelStorage();
                        } else {
                            throw new Error('API error');
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è API no disponible, guardando en localStorage:', error.message);
                        // Si API falla, guardar directamente en localStorage
                        const nuevoEmpleado = {
                            id: (Math.max(...empleados.map(e => e.id || 0), 0) + 1),
                            nombre, email, telefono, departamento, localidad, horasContrato, turnoPrincipal, estado
                        };
                        empleados.push(nuevoEmpleado);
                        localStorage.setItem('empleadosData', JSON.stringify(empleados));
                        NotificationSystem.show(`‚úÖ ${nombre} guardado localmente`, 'success');
                    }
                    
                    // En ambos casos, refrescar UI
                    try {
                        document.getElementById('formEmpleadosContenedor').style.display = 'none';
                        document.getElementById('listaEmpleados').style.display = 'block';
                        this.refrescarLista();
                        this.llenarSelectLocalidades();

                        // Refrescar cuadrante principal
                        if (typeof UI !== 'undefined' && typeof UI.generarCuadranteGeneral === 'function') {
                            UI.generarCuadranteGeneral();
                        }
                    } catch (err) {
                        console.error('Error refrescando UI:', err);
                    }
                },
                refrescarLista: function() {
                    const listaDiv = document.getElementById('listaEmpleados');
                    let html = '<h3>üìã Empleados Registrados</h3>';
                    html += '<div style="display: grid; gap: 10px; max-height: 400px; overflow-y: auto;">';
                    
                    if (!empleados || empleados.length === 0) {
                        html += '<p style="color: #94a3b8;">No hay empleados registrados</p>';
                    } else {
                        empleados.forEach(emp => {
                            const estadoMensual = JSON.parse(localStorage.getItem('estadosPorMes') || '{}');
                            const keyEstado = `${emp.id}_${AppState.currentYear}_${AppState.currentMonth}`;
                            const estadoActual = estadoMensual[keyEstado] || emp.estado;
                            
                            html += `
                                <div style="background: #1e293b; padding: 12px; border-radius: 8px; border-left: 4px solid #0ea5e9; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="color: #f1f5f9;">${emp.nombre}</strong><br>
                                        <small style="color: #94a3b8;">${emp.departamento} ‚Ä¢ ${emp.horasContrato}h/mes ‚Ä¢ Estado: <span style="color: ${estadoActual === 'activo' ? '#22c55e' : '#ef4444'};">${estadoActual}</span></small>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="EmployeeManager.abrirMenuEstado(${emp.id}, '${emp.nombre}')" style="background: #8b5cf6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">üìù Estado</button>
                                        <button onclick="EmployeeManager.eliminarEmpleado(${emp.id})" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">üóëÔ∏è Eliminar</button>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    html += '</div>';
                    listaDiv.innerHTML = html;
                },
                abrirMenuEstado: function(empleadoId, nombreEmpleado) {
                    // ‚úÖ Muestra men√∫ r√°pido para cambiar estado (solo del mes actual)
                    const estados = ['activo', 'vacaciones', 'baja', 'baja medica', 'excedencia'];
                    const estadoMensual = JSON.parse(localStorage.getItem('estadosPorMes') || '{}');
                    const keyEstado = `${empleadoId}_${AppState.currentYear}_${AppState.currentMonth}`;
                    const estadoActual = estadoMensual[keyEstado] || empleados.find(e => e.id === empleadoId)?.estado || 'activo';
                    
                    let html = `<h4 style="color: #f1f5f9; margin-bottom: 12px;">Estado de ${nombreEmpleado}</h4>`;
                    html += '<p style="color: #94a3b8; font-size: 12px; margin-bottom: 12px;">Esta opci√≥n SOLO afecta a este mes (${AppState.currentMonth}/${AppState.currentYear})</p>';
                    html += '<div style="display: grid; gap: 8px;">';
                    
                    estados.forEach(estado => {
                        const isSelected = estadoActual === estado;
                        html += `<button onclick="EmployeeManager.cambiarEstadoPorMes(${empleadoId}, '${estado}'); EmployeeManager.cerrarModalEstado();" style="background: ${isSelected ? '#22c55e' : '#475569'}; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: ${isSelected ? 'bold' : 'normal'};">
                            ${isSelected ? '‚úì' : '‚Ä¢'} ${estado.toUpperCase()}
                        </button>`;
                    });
                    html += '</div>';
                    html += '<button onclick="EmployeeManager.cerrarModalEstado()" style="background: #ef4444; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; margin-top: 12px; width: 100%;">Cerrar</button>';
                    
                    const modal = document.createElement('div');
                    modal.id = 'modalEstado';
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                        background: rgba(0,0,0,0.7); display: flex; align-items: center;
                        justify-content: center; z-index: 10000;
                    `;
                    modal.innerHTML = `<div style="background: #0f172a; padding: 20px; border-radius: 8px; max-width: 400px; border: 2px solid #0ea5e9;">${html}</div>`;
                    document.body.appendChild(modal);
                },
                cerrarModalEstado: function() {
                    const modal = document.getElementById('modalEstado');
                    if (modal) modal.remove();
                },
                eliminarEmpleado: async function(empleadoId) {
                    if (confirm('¬øEliminar este empleado?')) {
                        try {
                            const response = await fetch(`/api/empleados/${empleadoId}`, {
                                method: 'DELETE'
                            });

                            if (response.ok) {
                                NotificationSystem.show('‚úÖ Empleado eliminado', 'success');
                                await this.cargarDelStorage();
                                this.refrescarLista();

                                // Refrescar cuadrante
                                if (typeof UI !== 'undefined' && typeof UI.generarCuadranteGeneral === 'function') {
                                    UI.generarCuadranteGeneral();
                                }
                            } else {
                                throw new Error('Error al eliminar empleado');
                            }
                        } catch (error) {
                            console.error('Error eliminando empleado:', error);
                            NotificationSystem.show('‚ùå Error al eliminar empleado', 'error');
                        }
                    }
                },
                cargarDelStorage: async function() {
                    try {
                        // Intentar cargar desde localStorage primero
                        const datosGuardados = localStorage.getItem('empleadosData');
                        if (datosGuardados) {
                            empleados = JSON.parse(datosGuardados);
                            console.log('[EmployeeManager] Cargados', empleados.length, 'empleados de localStorage');
                            return;
                        }
                        
                        // Intentar cargar desde API
                        try {
                            const response = await fetch('/api/empleados');
                            if (response.ok) {
                                empleados = await response.json();
                                console.log('[EmployeeManager] Cargados', empleados.length, 'empleados de la API');
                                localStorage.setItem('empleadosData', JSON.stringify(empleados));
                                return;
                            }
                        } catch (error) {
                            console.warn('[EmployeeManager] API no disponible, usando empleados por defecto');
                        }
                        
                        // Usar empleados por defecto
                        empleados = [
                            { id: 1, nombre: 'Juan Garc√≠a', email: 'juan@mail.com', telefono: '612345678', departamento: 'Limpieza', localidad: 'Getafe', horasContrato: 169, turnoPrincipal: 'ma√±ana', estado: 'activo' },
                            { id: 2, nombre: 'Mar√≠a L√≥pez', email: 'maria@mail.com', telefono: '612345679', departamento: 'Limpieza', localidad: 'Madrid', horasContrato: 169, turnoPrincipal: 'tarde', estado: 'activo' },
                            { id: 3, nombre: 'Carlos Mart√≠nez', email: 'carlos@mail.com', telefono: '612345680', departamento: 'Mantenimiento', localidad: 'Getafe', horasContrato: 169, turnoPrincipal: 'noche', estado: 'activo' },
                            { id: 4, nombre: 'Ana Rodr√≠guez', email: 'ana@mail.com', telefono: '612345681', departamento: 'Limpieza', localidad: 'Legan√©s', horasContrato: 169, turnoPrincipal: 'ma√±ana', estado: 'activo' },
                            { id: 5, nombre: 'Pedro S√°nchez', email: 'pedro@mail.com', telefono: '612345682', departamento: 'Seguridad', localidad: 'Getafe', horasContrato: 169, turnoPrincipal: 'noche', estado: 'activo' }
                        ];
                        
                        console.log('[EmployeeManager] Usando', empleados.length, 'empleados por defecto');
                        localStorage.setItem('empleadosData', JSON.stringify(empleados));
                    } catch (error) {
                        console.error('[EmployeeManager] Error:', error);
                        // Asegurar que siempre hay al menos un empleado
                        if (!empleados || empleados.length === 0) {
                            empleados = [
                                { id: 1, nombre: 'Empleado Demo', email: 'demo@mail.com', telefono: '612345678', departamento: 'Limpieza', localidad: 'Getafe', horasContrato: 169, turnoPrincipal: 'ma√±ana', estado: 'activo' }
                            ];
                        }
                    }
                }
            };
        }

        // üßπ FUNCI√ìN DE LIMPIEZA COMPLETA
        window.limpiarTodosDatos = function() {
            const keysAEliminar = [
                'turnosAppState',
                'empleadosData',
                'estadosPorMes',
                'tiposTurnoData',
                '_test'
            ];
            
            // Eliminar keys espec√≠ficas
            keysAEliminar.forEach(key => {
                localStorage.removeItem(key);
                console.log(`üóëÔ∏è Eliminado: ${key}`);
            });
            
            // Eliminar tambi√©n cualquier key de festividades cacheadas
            Object.keys(localStorage).forEach(key => {
                if (key.includes('festividades') || key.includes('festivoCache')) {
                    localStorage.removeItem(key);
                    console.log(`üóëÔ∏è Eliminado cache: ${key}`);
                }
            });
            
            console.log('‚úÖ Datos limpiados. Recargando p√°gina...');
            setTimeout(() => location.reload(), 500);
        };

        // SISTEMA DE EDICI√ìN MASIVA MEJORADO
        window.EdicionMasiva = {
            abrirModal: function() {
                console.log('[EdicionMasiva] Abriendo modal, empleados globales:', window.empleados ? window.empleados.length : 'no encontrados');
                
                const modal = document.getElementById('modalEdicionMasiva');
                if (!modal) {
                    console.error('[EdicionMasiva] Modal no encontrado');
                    return;
                }
                
                // Mostrar el modal
                modal.classList.add('active');
                console.log('[EdicionMasiva] Modal visible');
                
                // Esperar un tick para asegurar que el DOM se haya actualizado
                requestAnimationFrame(() => {
                    this.llenarSelects();
                    
                    // PRE-SELECCIONAR el empleado actualmente visualizado
                    const selectedEmployeeId = window.AppState?.selectedEmployee?.id;
                    console.log('[EdicionMasiva] selectedEmployee:', selectedEmployeeId);
                    
                    if (selectedEmployeeId) {
                        const selectEmpleado = document.getElementById('masiva_empleado');
                        if (selectEmpleado) {
                            selectEmpleado.value = selectedEmployeeId;
                            console.log('[EdicionMasiva] Pre-seleccionado empleado:', selectedEmployeeId);
                            // Disparar cambio para actualizar resumen
                            selectEmpleado.dispatchEvent(new Event('change'));
                        }
                    }
                    
                    // PRE-SELECCIONAR MES Y A√ëO ACTUAL
                    const mesActual = window.AppState?.currentMonth || new Date().getMonth();
                    const anioActual = window.AppState?.currentYear || new Date().getFullYear();
                    
                    const selectMes = document.getElementById('masiva_mes');
                    const selectAnio = document.getElementById('masiva_anio');
                    
                    if (selectMes) {
                        selectMes.value = mesActual;
                        console.log('[EdicionMasiva] Pre-seleccionado mes:', mesActual);
                        selectMes.dispatchEvent(new Event('change'));
                    }
                    
                    if (selectAnio) {
                        selectAnio.value = anioActual;
                        console.log('[EdicionMasiva] Pre-seleccionado a√±o:', anioActual);
                        selectAnio.dispatchEvent(new Event('change'));
                    }
                });
            },
            
            llenarSelects: function() {
                console.log('[EdicionMasiva.llenarSelects] Iniciando...');
                
                // Llenar empleados
                const selectEmpleado = document.getElementById('masiva_empleado');
                if (!selectEmpleado) {
                    console.error('[EdicionMasiva] Select masiva_empleado NO ENCONTRADO');
                    return;
                }
                
                console.log('[EdicionMasiva] Encontrado select masiva_empleado');
                console.log('[EdicionMasiva] Empleados global:', typeof empleados, Array.isArray(empleados) ? empleados.length : 'no es array');
                
                // Limpiar opciones previas excepto la primera
                selectEmpleado.innerHTML = '<option value="">-- Elige un empleado --</option>';
                
                if (typeof empleados !== 'undefined' && Array.isArray(empleados) && empleados.length > 0) {
                    console.log('[EdicionMasiva] Agregando empleados al select...');
                    empleados.forEach((emp, idx) => {
                        try {
                            const opt = document.createElement('option');
                            opt.value = emp.id || idx;
                            opt.textContent = `${emp.nombre || 'Sin nombre'} (${emp.estado || 'activo'})`;
                            selectEmpleado.appendChild(opt);
                            console.log(`[EdicionMasiva] ‚úì Empleado ${idx + 1}: ${emp.nombre}`);
                        } catch (e) {
                            console.error(`[EdicionMasiva] Error agregando empleado ${idx}:`, e);
                        }
                    });
                } else {
                    console.warn('[EdicionMasiva] empleados no est√° disponible o vac√≠o');
                }
                
                // Llenar d√≠as
                const selectDesde = document.getElementById('masiva_desde');
                const selectHasta = document.getElementById('masiva_hasta');
                
                if (selectDesde && selectHasta) {
                    console.log('[EdicionMasiva] Llenando d√≠as...');
                    selectDesde.innerHTML = '<option value="">-- D√≠a inicio --</option>';
                    selectHasta.innerHTML = '<option value="">-- D√≠a fin --</option>';
                    
                    for (let dia = 1; dia <= 31; dia++) {
                        const opt1 = document.createElement('option');
                        opt1.value = dia;
                        opt1.textContent = `D√≠a ${dia}`;
                        selectDesde.appendChild(opt1);
                        
                        const opt2 = document.createElement('option');
                        opt2.value = dia;
                        opt2.textContent = `D√≠a ${dia}`;
                        selectHasta.appendChild(opt2);
                    }
                    console.log('[EdicionMasiva] D√≠as agregados (1-31)');
                }
                
                // Llenar turnos
                const selectTurno = document.getElementById('masiva_turno');
                if (selectTurno) {
                    console.log('[EdicionMasiva] Llenando turnos...');
                    selectTurno.innerHTML = '<option value="">-- Selecciona turno --</option>';
                    
                    // Leer turnos de localStorage
                    const tiposTurnoData = JSON.parse(localStorage.getItem('tiposTurnoData') || '{}');
                    
                    // Si localStorage est√° vac√≠o, usar global tiposTurno
                    const tiposAUsar = Object.keys(tiposTurnoData).length > 0 ? tiposTurnoData : tiposTurno;
                    
                    Object.entries(tiposAUsar).forEach(([key, tipo]) => {
                        const opt = document.createElement('option');
                        opt.value = key;
                        opt.textContent = tipo.nombre || key;
                        selectTurno.appendChild(opt);
                    });
                    
                    console.log('[EdicionMasiva] Turnos agregados:', Object.keys(tiposAUsar).length);
                }
                
                // Configurar listeners
                this.configurarListeners();
                console.log('[EdicionMasiva] ‚úÖ Modal completamente llenado');
            },
            
            configurarListeners: function() {
                const self = this;  // Guardar referencia a EdicionMasiva
                const elem1 = document.getElementById('masiva_empleado');
                const elem2 = document.getElementById('masiva_mes');
                const elem3 = document.getElementById('masiva_anio');
                const elem4 = document.getElementById('masiva_desde');
                const elem5 = document.getElementById('masiva_hasta');
                const elem6 = document.getElementById('masiva_turno');
                
                // Remover listeners antiguos clonando
                if (elem1) {
                    const nuevo1 = elem1.cloneNode(true);
                    elem1.parentNode.replaceChild(nuevo1, elem1);
                    nuevo1.addEventListener('change', function() {
                        self.actualizarResumen();
                    });
                }
                if (elem2) {
                    const nuevo2 = elem2.cloneNode(true);
                    elem2.parentNode.replaceChild(nuevo2, elem2);
                    nuevo2.addEventListener('change', function() {
                        self.actualizarResumen();
                    });
                }
                if (elem3) {
                    const nuevo3 = elem3.cloneNode(true);
                    elem3.parentNode.replaceChild(nuevo3, elem3);
                    nuevo3.addEventListener('change', function() {
                        self.actualizarResumen();
                    });
                }
                if (elem4) {
                    const nuevo4 = elem4.cloneNode(true);
                    elem4.parentNode.replaceChild(nuevo4, elem4);
                    nuevo4.addEventListener('change', function() {
                        self.actualizarResumen();
                    });
                }
                if (elem5) {
                    const nuevo5 = elem5.cloneNode(true);
                    elem5.parentNode.replaceChild(nuevo5, elem5);
                    nuevo5.addEventListener('change', function() {
                        self.actualizarResumen();
                    });
                }
                if (elem6) {
                    const nuevo6 = elem6.cloneNode(true);
                    elem6.parentNode.replaceChild(nuevo6, elem6);
                    nuevo6.addEventListener('change', function() {
                        self.actualizarResumen();
                    });
                }
            },
            
            actualizarResumen: function() {
                const empleadoId = document.getElementById('masiva_empleado').value;
                const desde = parseInt(document.getElementById('masiva_desde').value);
                const hasta = parseInt(document.getElementById('masiva_hasta').value);
                const turno = document.getElementById('masiva_turno').value;
                const mes = parseInt(document.getElementById('masiva_mes').value);
                const anio = parseInt(document.getElementById('masiva_anio').value);
                
                const resumenDiv = document.getElementById('masiva_resumen');
                
                const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                
                if (!empleadoId || !desde || !hasta || !turno || isNaN(mes) || isNaN(anio)) {
                    resumenDiv.innerHTML = '‚ö†Ô∏è Selecciona empleado, mes, a√±o, rango de fechas y turno';
                    resumenDiv.style.color = '#d97706';
                    return;
                }
                
                if (desde > hasta) {
                    resumenDiv.innerHTML = '‚ùå Error: El d√≠a inicio debe ser menor al d√≠a fin';
                    resumenDiv.style.color = '#dc2626';
                    return;
                }
                
                const empleado = empleados.find(e => e.id == empleadoId);
                if (!empleado) {
                    resumenDiv.innerHTML = '‚ùå Empleado no encontrado';
                    resumenDiv.style.color = '#dc2626';
                    return;
                }
                
                const diasAfectados = hasta - desde + 1;
                const tiposTurno = {
                    'ma√±ana': '‚òÄÔ∏è Ma√±ana',
                    'tarde': 'üå§Ô∏è Tarde',
                    'noche': 'üåô Noche',
                    'mixto': '‚ö° Mixto',
                    'descanso': 'üò¥ Descanso',
                    'vacaciones': 'üèñÔ∏è Vacaciones',
                    'baja': 'üè• Baja M√©dica',
                    'libre': '‚ú® Libre'
                };
                
                const html = `
                    <div style="line-height: 1.8;">
                        <p><strong>Empleado:</strong> ${empleado.nombre}</p>
                        <p><strong>Mes y A√±o:</strong> ${meses[mes]} de ${anio}</p>
                        <p><strong>Per√≠odo:</strong> D√≠as ${desde} al ${hasta}</p>
                        <p><strong>Cantidad de d√≠as:</strong> ${diasAfectados}</p>
                        <p><strong>Nuevo turno:</strong> ${tiposTurno[turno]}</p>
                        <hr style="margin: 10px 0; border: none; border-top: 1px solid #ccc;">
                        <p style="color: #059669; font-weight: bold;">‚úÖ Se asignar√°n ${diasAfectados} turnos en ${meses[mes]} ${anio}</p>
                    </div>
                `;
                
                resumenDiv.innerHTML = html;
                resumenDiv.style.color = '#059669';
            },
            
            aplicarCambios: function() {
                const empleadoIdStr = document.getElementById('masiva_empleado').value;
                const empleadoId = parseInt(empleadoIdStr) || empleadoIdStr;
                const desde = parseInt(document.getElementById('masiva_desde').value);
                const hasta = parseInt(document.getElementById('masiva_hasta').value);
                const turno = document.getElementById('masiva_turno').value;
                const mesSeleccionado = parseInt(document.getElementById('masiva_mes').value);
                const anioSeleccionado = parseInt(document.getElementById('masiva_anio').value);
                
                console.log('[EdicionMasiva.aplicarCambios] ===== INICIANDO =====');
                console.log('[EdicionMasiva.aplicarCambios] Datos:', {empleadoId, desde, hasta, turno, mesSeleccionado, anioSeleccionado});
                
                if (!empleadoId || !desde || !hasta || !turno) {
                    alert('‚ö†Ô∏è Debes seleccionar empleado, rango de fechas y turno');
                    return;
                }
                
                if (isNaN(mesSeleccionado) || isNaN(anioSeleccionado)) {
                    alert('‚ö†Ô∏è Debes seleccionar mes y a√±o');
                    return;
                }
                
                if (desde > hasta) {
                    alert('‚ùå Error: El d√≠a inicio debe ser menor al d√≠a fin');
                    return;
                }
                
                // Obtener los turnos del empleado
                let turnos = AppState.scheduleData.get(empleadoId);
                console.log('[EdicionMasiva.aplicarCambios] Total de turnos:', turnos?.length);
                
                if (!turnos || turnos.length === 0) {
                    alert('‚ùå Error: No hay turnos para este empleado');
                    return;
                }
                
                // DEBUG: Mostrar todos los turnos
                console.log('[EdicionMasiva.aplicarCambios] Mostrando TODOS los turnos:');
                turnos.forEach((t, idx) => {
                    const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                    console.log(`  [${idx}] dia=${t.dia}, fecha=${fecha?.toLocaleDateString()}, mes=${fecha?.getMonth()}, a√±o=${fecha?.getFullYear()}, turno=${t.turno}`);
                });
                
                // Aplicar cambios SOLO a los turnos del mes/a√±o SELECCIONADOS
                let changesCount = 0;
                for (let dia = desde; dia <= hasta; dia++) {
                    const turnoObj = turnos.find(t => {
                        if (t.dia !== dia) return false;
                        if (!t.fecha) {
                            console.warn(`[EdicionMasiva.aplicarCambios] ‚ö†Ô∏è Turno d√≠a ${dia} NO TIENE FECHA`);
                            return true;
                        }
                        
                        const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                        const turnoMes = fecha.getMonth();
                        const turnoAnio = fecha.getFullYear();
                        
                        const match = turnoMes === mesSeleccionado && turnoAnio === anioSeleccionado;
                        console.log(`[EdicionMasiva.aplicarCambios] D√≠a ${dia}: mes ${turnoMes} vs ${mesSeleccionado}, a√±o ${turnoAnio} vs ${anioSeleccionado} = ${match}`);
                        return match;
                    });
                    
                    if (turnoObj) {
                        console.log(`[EdicionMasiva.aplicarCambios] ‚úÖ Cambiando d√≠a ${dia}: ${turnoObj.turno} ‚Üí ${turno}`);
                        turnoObj.turno = turno;
                        
                        // üîß NUEVO: Actualizar tambi√©n horario y horas del tipo de turno
                        const tiposTurnoData = JSON.parse(localStorage.getItem('tiposTurnoData') || '{}');
                        const tipoTurnoObj = Object.values(tiposTurnoData).find(t => 
                            t?.nombre && t.nombre.toLowerCase() === turno.toLowerCase()
                        );
                        
                        if (tipoTurnoObj) {
                            turnoObj.horario = tipoTurnoObj.horario || '';
                            turnoObj.horas = tipoTurnoObj.horas || 0;
                            console.log(`[EdicionMasiva.aplicarCambios] ‚úÖ Asignado horario: ${turnoObj.horario}, horas: ${turnoObj.horas}`);
                        }
                        
                        changesCount++;
                    } else {
                        console.log(`[EdicionMasiva.aplicarCambios] ‚ùå No encontrado turno d√≠a ${dia} para mes ${mesSeleccionado}/a√±o ${anioSeleccionado}`);
                    }
                }
                
                console.log('[EdicionMasiva.aplicarCambios] TOTAL DE CAMBIOS:', changesCount);
                
                if (changesCount === 0) {
                    alert('‚ö†Ô∏è No se encontraron turnos en el mes/a√±o seleccionado para cambiar');
                    return;
                }
                
                // Actualizar en AppState
                AppState.scheduleData.set(empleadoId, turnos);
                AppState.saveToStorage();
                
                this.cerrarModal();
                
                // üîß IMPORTANTE: Regenerar tabla usando el MES/A√ëO SELECCIONADO EN EL MODAL
                // Guardar el estado ORIGINAL para restaurarlo despu√©s
                const mesOriginal = AppState.currentMonth;
                const anioOriginal = AppState.currentYear;
                
                // Cambiar temporalmente al mes/a√±o del modal SOLO para regenerar la tabla
                AppState.currentMonth = mesSeleccionado;
                AppState.currentYear = anioSeleccionado;
                
                if (typeof UI !== 'undefined' && typeof UI.generarCuadranteGeneral === 'function') {
                    UI.generarCuadranteGeneral();
                    if (AppState.selectedEmployee?.id === empleadoId) {
                        UI.generarCuadranteIndividual(empleadoId);
                    }
                } else {
                    location.reload();
                }
                
                // üîß RESTAURAR el mes/a√±o original (SIN GUARDAR)
                AppState.currentMonth = mesOriginal;
                AppState.currentYear = anioOriginal;
                
                alert(`‚úÖ Se asignaron ${changesCount} turnos`);
            },
            
            cerrarModal: function() {
                const modal = document.getElementById('modalEdicionMasiva');
                if (modal) {
                    modal.classList.remove('active');
                }
            }
        };
        
        // Mantener compatibilidad con TurnoEditor
        if (!window.TurnoEditor) {
            window.TurnoEditor = {};
        }
        
        // SIEMPRE asignar estas funciones
        window.TurnoEditor.mostrarModalEdicionMasiva = () => {
            console.log('[TurnoEditor] Llamando EdicionMasiva.abrirModal()');
            EdicionMasiva.abrirModal();
        };
        window.TurnoEditor.cerrarModal = () => EdicionMasiva.cerrarModal();
        window.TurnoEditor.aplicarEdicionMasiva = () => EdicionMasiva.aplicarCambios();
        
        // Funci√≥n de edici√≥n de turno individual
        window.TurnoEditor.abrirEditorTurno = function(empleadoId, dia) {
            console.log(`üîµ [TurnoEditor.abrirEditorTurno] Abriendo editor para empleado ${empleadoId}, d√≠a ${dia}`);
            
            const empleado = empleados.find(e => e.id === empleadoId);
            if (!empleado) {
                NotificationSystem.show('‚ùå Empleado no encontrado', 'error');
                return;
            }
            
            const turnos = AppState.scheduleData.get(empleadoId) || [];
            const turnoDelDia = turnos.find(t => t.dia === dia);
            
            if (!turnoDelDia) {
                NotificationSystem.show('‚ùå No hay turno para ese d√≠a', 'error');
                return;
            }
            
            // Guardar datos para la modal
            window.turnoEditandoActual = {
                empleadoId,
                dia,
                turnoAnterior: turnoDelDia.turno,
                horasAnteriores: turnoDelDia.horas
            };
            
            // Mostrar alerta simple con opciones
            const tiposTurno = ['ma√±ana', 'tarde', 'noche', 'mixto', 'descanso', 'vacaciones', 'baja', 'libre'];
            let mensaje = `Cambiar turno de ${empleado.nombre} - D√≠a ${dia}\n\n`;
            mensaje += `Turno actual: ${turnoDelDia.turno}\n\n`;
            mensaje += 'Opciones:\n';
            tiposTurno.forEach((t, idx) => {
                mensaje += `${idx + 1}. ${t}\n`;
            });
            
            const opcion = prompt(mensaje, '1');
            if (opcion === null) return; // Cancelado
            
            const indice = parseInt(opcion) - 1;
            if (indice < 0 || indice >= tiposTurno.length) {
                NotificationSystem.show('‚ùå Opci√≥n inv√°lida', 'error');
                return;
            }
            
            const nuevoTurno = tiposTurno[indice];
            
            // Actualizar turno
            turnoDelDia.turno = nuevoTurno;
            const tiposTurnoData = JSON.parse(localStorage.getItem('tiposTurnoData') || '{}');
            turnoDelDia.horas = tiposTurnoData[nuevoTurno]?.horas || 8;
            
            console.log(`üìù [abrirEditorTurno] D√≠a ${dia} cambiado a "${nuevoTurno}" (${turnoDelDia.horas}h)`);
            console.log(`üìù [abrirEditorTurno] Guardar en localStorage...`);
            
            AppState.saveToStorage();
            
            console.log(`‚úÖ [abrirEditorTurno] GUARDADO en localStorage y memoria`);
            
            UI.generarCuadranteGeneral();
            NotificationSystem.show(`‚úì Turno actualizado a ${nuevoTurno}`, 'success');
        };
        
        window.TurnoEditor.cerrarModalDescripcion = function() {
            console.log('[TurnoEditor.cerrarModalDescripcion] Cerrando modal');
        };
        
        window.TurnoEditor.guardarDescripcion = function() {
            console.log('[TurnoEditor.guardarDescripcion] Guardando cambios');
            AppState.saveToStorage();
            // Mostrar notificaci√≥n con sonido, duraci√≥n y callback
            NotificationSystem.show('‚úì Cambios guardados correctamente', 'success', 3000, {
                callback: (accion) => {
                    console.log('Notificaci√≥n cerrada:', accion);
                }
            });
            // Cerrar modal despu√©s de guardar
            setTimeout(() => {
                TurnoEditor.cerrarModal();
            }, 500);
        };


        // CREAR TURNO TYPE MANAGER SI NO EXISTE
        if (!window.TurnoTypeManager) {
            window.TurnoTypeManager = {
                guardarEnStorage: function() {
                    const tiposTurno = {
                        'ma√±ana': { nombre: 'Ma√±ana', horario: '08:00-16:00', horas: 8, color: '#86efac' },
                        'tarde': { nombre: 'Tarde', horario: '16:00-00:00', horas: 8, color: '#fcd34d' },
                        'noche': { nombre: 'Noche', horario: '00:00-08:00', horas: 8, color: '#93c5fd' },
                        'mixto': { nombre: 'Mixto', horario: '08:00-20:00', horas: 12, color: '#fde68a' },
                        'descanso': { nombre: 'Descanso', horario: '-', horas: 0, color: '#cbd5f5' },
                        'vacaciones': { nombre: 'Vacaciones', horario: '-', horas: 0, color: '#fecdd3' },
                        'baja': { nombre: 'Baja M√©dica', horario: '-', horas: 0, color: '#fda4af' },
                        'libre': { nombre: 'Libre', horario: '-', horas: 0, color: '#e0e7ff' },
                        'festivo': { nombre: 'Festivo', horario: '-', horas: 0, color: '#fef3c7' }
                    };
                    localStorage.setItem('tiposTurnoData', JSON.stringify(tiposTurno));
                    console.log('[TurnoTypeManager] Tipos de turno guardados');
                },
                cargarDelStorage: function() {
                    let tiposTurno = JSON.parse(localStorage.getItem('tiposTurnoData') || '{}');
                    if (!Object.keys(tiposTurno).length) {
                        this.guardarEnStorage();
                        tiposTurno = JSON.parse(localStorage.getItem('tiposTurnoData') || '{}');
                    }
                    console.log('[TurnoTypeManager] Tipos de turno cargados:', Object.keys(tiposTurno).length);
                    return tiposTurno;
                }
            };
        }
        
        if (!window.DepartmentManager) {
            window.DepartmentManager = {
                departamentos: [
                    { id: 1, nombre: 'Limpieza' },
                    { id: 2, nombre: 'Mantenimiento' },
                    { id: 3, nombre: 'Seguridad' },
                    { id: 4, nombre: 'Administraci√≥n' }
                ]
            };
        }


        if (!window.DateUtils) {
            // ‚≠ê DEBOUNCE para evitar renderizaciones m√∫ltiples
            window._renderTimeout = null;
            window._debouncedRender = function() {
                clearTimeout(window._renderTimeout);
                window._renderTimeout = setTimeout(() => {
                    if (typeof UI !== 'undefined' && typeof UI.generarCuadranteGeneral === 'function') {
                        UI.generarCuadranteGeneral();
                    }
                }, 100);
            };

            window.DateUtils = {
                cambiarMes: (direccion) => {
                    const mesesNombre = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
                    const mesActual = mesesNombre[window.AppState.currentMonth];
                    const mesAnterior = mesActual + ' ' + window.AppState.currentYear;
                    
                    console.log(`\n‚è∞ [DateUtils.cambiarMes] CAMBIO DE MES`);
                    console.log(`   De: ${mesAnterior}`);
                    
                    const inicio = performance.now();
                    
                    if (!window.AppState) return;
                    
                    // Actualizar mes/a√±o
                    window.AppState.currentMonth += direccion;
                    if (window.AppState.currentMonth > 11) {
                        window.AppState.currentMonth = 0;
                        window.AppState.currentYear++;
                    }
                    if (window.AppState.currentMonth < 0) {
                        window.AppState.currentMonth = 11;
                        window.AppState.currentYear--;
                    }
                    
                    console.log(`   Hacia: ${mesesNombre[window.AppState.currentMonth]} ${window.AppState.currentYear}`);
                    console.log(`   Turnos en memoria ANTES: ${AppState.scheduleData.size} empleados`);
                    
                    // Actualizar selectores
                    const selectMonth = document.getElementById('selectMonth');
                    const selectYear = document.getElementById('selectYear');
                    if (selectMonth) selectMonth.value = window.AppState.currentMonth;
                    if (selectYear) selectYear.value = window.AppState.currentYear;
                    
                    // ‚úÖ OPTIMIZADO: Hacer todas las actualizaciones en batch
                    try {
                        if (typeof TurnoManager !== 'undefined' && TurnoManager.reiniciarDatos) {
                            TurnoManager.reiniciarDatos();
                        }
                        
                        console.log(`   Turnos en memoria DESPU√âS: ${AppState.scheduleData.size} empleados`);
                        
                        // ‚úÖ Usar debounce para evitar m√∫ltiples renders
                        window._debouncedRender();
                        
                        // DESHABILITADO: Evitar loop de sincronizaci√≥n
                        // if (typeof TurnoManager !== 'undefined' && typeof TurnoManager.verificarYMostrarBoton === 'function') {
                        //     setTimeout(() => TurnoManager.verificarYMostrarBoton(), 200);
                        // }
                        
                        NotificationSystem.show(`‚úì ${mesesNombre[window.AppState.currentMonth]} ${window.AppState.currentYear}`, 'success', 1500);
                    } catch (err) {
                        console.error('[cambiarMes] Error:', err);
                    }
                    
                    const tiempo = (performance.now() - inicio).toFixed(1);
                    console.log(`‚úì [DateUtils.cambiarMes] COMPLETADO en ${tiempo}ms\n`);
                }
            };
        }

        if (!window.DepartmentManager) {
            window.DepartmentManager = {
                departamentos: [
                    { id: 1, nombre: 'Limpieza' },
                    { id: 2, nombre: 'Mantenimiento' },
                    { id: 3, nombre: 'Seguridad' },
                    { id: 4, nombre: 'Administraci√≥n' }
                ]
            };
        }

        console.log('‚úì Fallback objetos base cargados');
    </script>

    <!-- Fallback: Mejorado despu√©s del DOM cargado -->
    <script>
        // Este script se ejecuta DESPU√âS de que los m√≥dulos intenten cargar
        // Proporciona m√©todos adicionales si es necesario
        setTimeout(() => {
            // ‚úÖ ARREGLADO: NO sobrescribir AppState si ya est√° completamente definido
            if (!window.AppState) {
                console.warn('‚ö†Ô∏è AppState no est√° definido, creando versi√≥n m√≠nima');
                window.AppState = {
                    currentYear: new Date().getFullYear(),
                    currentMonth: new Date().getMonth(),
                    scheduleData: new Map(),
                    selectedEmployee: null
                };
            } else if (typeof window.AppState.setMonth !== 'function') {
                // Si existe pero le faltan m√©todos, agregarlos SOLO
                console.log('üìù Completando m√©todos faltantes de AppState...');
                window.AppState.setMonth = window.AppState.setMonth || function(mes) { this.currentMonth = mes; };
                window.AppState.setYear = window.AppState.setYear || function(a√±o) { this.currentYear = a√±o; };
            }

            if (!window.EmployeeManager || !window.EmployeeManager.abrirModal) {
                window.EmployeeManager = window.EmployeeManager || {};
                window.EmployeeManager.abrirModal = () => {
                    const modal = document.getElementById('modalGestionEmpleados');
                    if (modal) modal.classList.add('active');
                };
            }

            if (!window.TurnoManager || !window.TurnoManager.reiniciarDatos) {
                // ‚úÖ IMPORTANTE: No sobrescribir si TurnoManager ya tiene funciones
                if (!window.TurnoManager) {
                    window.TurnoManager = {};
                }
                
                // Solo agregar fallback si NO existe reiniciarDatos
                if (!window.TurnoManager.reiniciarDatos) {
                    window.TurnoManager.reiniciarDatos = () => {
                        console.log('üîµ Fallback: reiniciarDatos');
                        if (typeof UI !== 'undefined' && UI.generarCuadranteGeneral) {
                            UI.generarCuadranteGeneral();
                        }
                    };
                }
            }
            
            // CREAR UI SI NO EXISTE
            if (!window.UI) {
                window.UI = {
                    generarCuadranteGeneral: function() {
                        console.log('üîµ [UI.generarCuadranteGeneral] Generando cuadrante...');
                        const inicio = performance.now();
                        
                        const container = document.getElementById('cuadranteGeneral');
                        if (!container) {
                            console.error('‚ùå Elemento cuadranteGeneral no encontrado');
                            return;
                        }
                        
                        const mes = AppState.currentMonth;
                        const a√±o = AppState.currentYear;
                        const mesesNombre = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
                        const coloresTurno = {
                            'ma√±ana': '#86efac', 'tarde': '#fcd34d', 'noche': '#93c5fd',
                            'mixto': '#fde68a', 'descanso': '#cbd5f5', 'vacaciones': '#fecdd3',
                            'baja': '#fda4af', 'libre': '#e0e7ff', 'festivo': '#fef3c7'
                        };
                        
                        // üîç FILTRADO: Obtener valores de filtros
                        const filtroDepartamento = document.getElementById('filtroDepartamentoGeneral')?.value || '';
                        const filtroEstado = document.getElementById('filtroEstadoGeneral')?.value || '';
                        
                        // Filtrar empleados seg√∫n criterios
                        let empleadosFiltrados = empleados;
                        if (filtroDepartamento) {
                            empleadosFiltrados = empleadosFiltrados.filter(e => e.departamento === filtroDepartamento);
                        }
                        if (filtroEstado) {
                            empleadosFiltrados = empleadosFiltrados.filter(e => e.estado === filtroEstado);
                        }
                        
                        console.log(`üîç Empleados mostrados: ${empleadosFiltrados.length} de ${empleados.length}`);
                        
                        // ‚úÖ OPTIMIZADO: Usar array en lugar de string concatenation
                        const html = [];
                        html.push('<div style="overflow-x: auto;"><table class="monthly-table" style="width: 100%; border-collapse: collapse;">');
                        html.push('<thead><tr><th style="width: 150px;">Empleado</th>');
                        
                        const diasEnMes = new Date(a√±o, mes + 1, 0).getDate();
                        for (let dia = 1; dia <= diasEnMes; dia++) {
                            html.push(`<th style="width: 50px; padding: 10px; background: #f97316; color: white;">${dia}</th>`);
                        }
                        html.push('</tr></thead><tbody>');
                        
                        if (empleadosFiltrados.length === 0) {
                            html.push(`<tr><td colspan="${diasEnMes + 1}" style="padding: 20px; text-align: center; color: #94a3b8;">No hay empleados que cumplan los criterios de filtro</td></tr>`);
                        } else {
                            empleadosFiltrados.forEach(empleado => {
                                html.push(`<tr><td style="padding: 10px; background: #1a1f35; color: white; font-weight: bold;">${empleado.nombre}</td>`);
                                
                                const turnos = AppState.scheduleData.get(empleado.id) || [];
                                for (let dia = 1; dia <= diasEnMes; dia++) {
                                    const turno = turnos.find(t => t.dia === dia);
                                    const turnoNombre = turno?.turno || 'descanso';
                                    const color = coloresTurno[turnoNombre] || '#e2e8f0';
                                    html.push(`<td style="padding: 8px; text-align: center; background: ${color}; cursor: pointer; color: #0f172a; font-weight: 500;" onclick="TurnoEditor.abrirEditorTurno(${empleado.id}, ${dia})">${turnoNombre.substring(0, 3)}</td>`);
                                }
                                html.push('</tr>');
                            });
                        }
                        
                        html.push('</tbody></table></div>');
                        
                        // ‚úÖ OPTIMIZADO: Un solo innerHTML con array.join
                        container.innerHTML = html.join('');
                        const tiempo = (performance.now() - inicio).toFixed(1);
                        console.log(`‚úì Cuadrante generado en ${tiempo}ms (${empleadosFiltrados.length} empleados)`);
                        
                        // üìä Actualizar KPIs despu√©s de generar el cuadrante
                        if (typeof UI !== 'undefined' && typeof UI.actualizarKPIsGeneral === 'function') {
                            UI.actualizarKPIsGeneral();
                        }
                    },
                    
                    actualizarTitulosMes: function() {
                        const mes = AppState.currentMonth;
                        const a√±o = AppState.currentYear;
                        const mesesNombre = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
                        
                        const titulo = document.querySelector('.monthly-header h2') || document.querySelector('h2');
                        if (titulo) {
                            titulo.textContent = `${mesesNombre[mes]} ${a√±o}`;
                        }
                    },
                    
                    actualizarKPIsGeneral: function() {
                        // Calcular KPIs del cuadrante general
                        if (!window.AppState || !window.AppState.scheduleData) {
                            console.warn('‚ö†Ô∏è AppState no est√° inicializado');
                            return;
                        }
                        
                        const mes = window.AppState.currentMonth;
                        const a√±o = window.AppState.currentYear;
                        
                        let totalEmpleados = window.empleados ? window.empleados.length : 0;
                        let totalHoras = 0;
                        let turnosMa√±ana = 0;
                        let turnosTarde = 0;
                        let turnosNoche = 0;
                        
                        // Iterar sobre todos los empleados
                        if (window.empleados && window.empleados.length > 0) {
                            window.empleados.forEach(empleado => {
                                const turnos = window.AppState.scheduleData.get(empleado.id) || [];
                                
                                // Filtrar turnos del mes actual solo
                                turnos.forEach(turno => {
                                    // Verificar que sea del mes/a√±o actual
                                    if (turno && turno.fecha) {
                                        const fecha = turno.fecha instanceof Date ? turno.fecha : new Date(turno.fecha);
                                        if (fecha.getMonth() === mes && fecha.getFullYear() === a√±o) {
                                            totalHoras += (turno.horas || 0);
                                            if (turno.turno === 'ma√±ana') turnosMa√±ana++;
                                            if (turno.turno === 'tarde') turnosTarde++;
                                            if (turno.turno === 'noche') turnosNoche++;
                                        }
                                    }
                                });
                            });
                        }
                        
                        // Inyectar valores en HTML
                        const totalEmpleadosEl = document.getElementById('totalEmpleadosGeneral');
                        const totalHorasEl = document.getElementById('totalHorasGeneral');
                        const turnosMa√±anaEl = document.getElementById('turnosMa√±anaGeneral');
                        const turnosTardeEl = document.getElementById('turnosTardeGeneral');
                        const turnosNocheEl = document.getElementById('turnosNocheGeneral');
                        
                        if (totalEmpleadosEl) totalEmpleadosEl.textContent = totalEmpleados;
                        if (totalHorasEl) totalHorasEl.textContent = totalHoras.toFixed(1);
                        if (turnosMa√±anaEl) turnosMa√±anaEl.textContent = turnosMa√±ana;
                        if (turnosTardeEl) turnosTardeEl.textContent = turnosTarde;
                        if (turnosNocheEl) turnosNocheEl.textContent = turnosNoche;
                        
                        console.log(`üìä KPIs: Empleados=${totalEmpleados}, Horas=${totalHoras.toFixed(1)}, Ma√±ana=${turnosMa√±ana}, Tarde=${turnosTarde}, Noche=${turnosNoche}`);
                        
                        console.log(`üìä KPIs actualizados: Empleados=${totalEmpleados}, Horas=${totalHoras.toFixed(1)}, Ma√±ana=${turnosMa√±ana}, Noche=${turnosNoche}`);
                    }
                };
            }
            
            // CREAR/REEMPLAZAR NOTIFICATION SYSTEM CON VERSI√ìN COMPLETA
            console.log('üîÑ Cargando NotificationSystem mejorado v13.0...');
            window.NotificationSystem = {
                    // üìã Historial de notificaciones
                    historial: [],
                    maxHistorial: 50,
                    
                    // üîî Contador y agrupaci√≥n
                    contadorID: 0,
                    grupos: new Map(),
                    
                    // üéØ Posici√≥n por defecto
                    posicion: 'top-right', // top-right, top-center, bottom-right, bottom-left
                    
                    // üîä Sonidos activados por defecto
                    sonidosActivados: true,
                    
                    // üîó Acciones disponibles por tipo
                    accionesDefault: {
                        'success': ['cerrar'],
                        'error': ['reintentar', 'cerrar'],
                        'warning': ['aceptar', 'cerrar'],
                        'info': ['cerrar']
                    },
                    
                    // Crear sonido simple con Web Audio API
                    reproducirSonido: function(tipo) {
                        if (!this.sonidosActivados) return;
                        if (typeof window.AudioContext === 'undefined' && typeof window.webkitAudioContext === 'undefined') return;
                        
                        try {
                            let audioContext = window.__appAudioContext;
                            
                            if (!audioContext) {
                                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                                window.__appAudioContext = audioContext;
                            }
                            
                            // Si est√° suspendido, no reproducir silenciosamente
                            if (audioContext.state === 'suspended') {
                                return;
                            }
                            
                            const oscilador = audioContext.createOscillator();
                            const ganancia = audioContext.createGain();
                            
                            oscilador.connect(ganancia);
                            ganancia.connect(audioContext.destination);
                            
                            const frecuencias = {
                                'success': 600,
                                'error': 300,
                                'warning': 450,
                                'info': 500
                            };
                            
                            oscilador.frequency.value = frecuencias[tipo] || 500;
                            ganancia.gain.setValueAtTime(0.3, audioContext.currentTime);
                            ganancia.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                            
                            oscilador.start(audioContext.currentTime);
                            oscilador.stop(audioContext.currentTime + 0.1);
                        } catch (e) {
                            // Silenciar errores de audio
                        }
                    },
                    
                    // Mostrar notificaci√≥n mejorada
                    show: function(mensaje, tipo = 'info', duracion = 3000, opciones = {}) {
                        console.log(`[Notificaci√≥n ${tipo}] ${mensaje}`);
                        
                        // üéØ Crear/obtener contenedor seg√∫n posici√≥n
                        const posicion = opciones.posicion || this.posicion;
                        let container = document.getElementById(`notificationContainer-${posicion}`);
                        if (!container) {
                            container = document.createElement('div');
                            container.id = `notificationContainer-${posicion}`;
                            container.style.cssText = `
                                position: fixed;
                                z-index: 9999;
                                max-width: 450px;
                                pointer-events: none;
                                ${this.getEstilosPosicion(posicion)}
                            `;
                            document.body.appendChild(container);
                        }
                        
                        const colores = {
                            'success': '#22c55e',
                            'error': '#ef4444',
                            'warning': '#f59e0b',
                            'info': '#f97316'
                        };
                        
                        const iconos = {
                            'success': '‚úÖ',
                            'error': '‚ùå',
                            'warning': '‚ö†Ô∏è',
                            'info': '‚ÑπÔ∏è'
                        };
                        
                        // üîî Agrupar notificaciones similares
                        const grupoKey = `${tipo}-${mensaje.substring(0, 30)}`;
                        let notificacionExistente = this.grupos.get(grupoKey);
                        
                        if (notificacionExistente && opciones.agrupar !== false) {
                            // Incrementar contador en notificaci√≥n existente
                            const contador = notificacionExistente.querySelector('.notif-contador');
                            if (contador) {
                                let count = parseInt(contador.textContent) + 1;
                                contador.textContent = count;
                            }
                            // Resetear duraci√≥n
                            clearTimeout(notificacionExistente.timerID);
                            if (duracion > 0) {
                                notificacionExistente.timerID = setTimeout(() => this.cerrarNotificacion(notificacionExistente, opciones), duracion);
                            }
                            return;
                        }
                        
                        // üì¨ Agregar al historial
                        const notifID = this.contadorID++;
                        const timestampNotif = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                        this.historial.unshift({
                            id: notifID,
                            mensaje,
                            tipo,
                            timestamp: timestampNotif,
                            grupo: grupoKey
                        });
                        if (this.historial.length > this.maxHistorial) {
                            this.historial.pop();
                        }
                        
                        // üîä Reproducir sonido
                        this.reproducirSonido(tipo);
                        
                        // Crear elemento notificaci√≥n
                        const notificacion = document.createElement('div');
                        notificacion.id = `notif-${notifID}`;
                        notificacion.className = `notificacion ${tipo}`;
                        notificacion.style.cssText = `
                            background: ${colores[tipo] || colores.info};
                            color: white;
                            padding: 15px 20px;
                            border-radius: 8px;
                            margin-bottom: 10px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            animation: slideIn 0.3s ease;
                            pointer-events: auto;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                            position: relative;
                        `;
                        
                        // üìù Contenido principal
                        const contenido = document.createElement('div');
                        contenido.style.cssText = 'flex: 1;';
                        
                        const textoMain = document.createElement('div');
                        textoMain.style.cssText = 'display: flex; align-items: center; gap: 8px; font-weight: 500;';
                        textoMain.innerHTML = `<span>${iconos[tipo]}</span><span>${mensaje}</span>`;
                        contenido.appendChild(textoMain);
                        
                        // ‚è±Ô∏è Barra de progreso (si tiene duraci√≥n)
                        if (duracion > 0) {
                            const barraProgreso = document.createElement('div');
                            barraProgreso.style.cssText = `
                                height: 2px;
                                background: rgba(255,255,255,0.3);
                                border-radius: 1px;
                                margin-top: 8px;
                                overflow: hidden;
                            `;
                            const llenoProgreso = document.createElement('div');
                            llenoProgreso.style.cssText = `
                                height: 100%;
                                background: rgba(255,255,255,0.8);
                                animation: progress ${duracion}ms linear forwards;
                            `;
                            barraProgreso.appendChild(llenoProgreso);
                            contenido.appendChild(barraProgreso);
                        }
                        
                        notificacion.appendChild(contenido);
                        
                        // üîó Agregar acciones/botones
                        const acciones = opciones.acciones || this.accionesDefault[tipo] || ['cerrar'];
                        if (acciones.length > 0) {
                            const grupoAcciones = document.createElement('div');
                            grupoAcciones.style.cssText = 'display: flex; gap: 5px; margin-left: 10px; flex-shrink: 0;';
                            
                            acciones.forEach(accion => {
                                const btn = document.createElement('button');
                                btn.style.cssText = `
                                    background: rgba(255,255,255,0.2);
                                    border: 1px solid rgba(255,255,255,0.4);
                                    color: white;
                                    padding: 4px 10px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 11px;
                                    transition: all 0.2s ease;
                                `;
                                btn.onmouseover = () => btn.style.background = 'rgba(255,255,255,0.3)';
                                btn.onmouseout = () => btn.style.background = 'rgba(255,255,255,0.2)';
                                
                                const etiquetasAcciones = {
                                    'cerrar': '‚úï',
                                    'reintentar': 'üîÑ',
                                    'aceptar': '‚úì',
                                    'ver': 'üëÅÔ∏è'
                                };
                                
                                btn.textContent = etiquetasAcciones[accion] || accion;
                                btn.title = accion;
                                
                                btn.onclick = (e) => {
                                    e.stopPropagation();
                                    if (opciones.callback && typeof opciones.callback === 'function') {
                                        opciones.callback(accion, notificacion);
                                    }
                                    if (accion === 'cerrar') {
                                        this.cerrarNotificacion(notificacion, opciones);
                                    }
                                };
                                
                                grupoAcciones.appendChild(btn);
                            });
                            
                            notificacion.appendChild(grupoAcciones);
                        }
                        
                        // üìã Contador de agrupaci√≥n
                        if (opciones.agrupar !== false) {
                            const contadorSpan = document.createElement('span');
                            contadorSpan.className = 'notif-contador';
                            contadorSpan.style.cssText = `
                                background: rgba(0,0,0,0.3);
                                padding: 2px 6px;
                                border-radius: 3px;
                                font-size: 11px;
                                margin-left: 5px;
                            `;
                            contadorSpan.textContent = '1';
                            textoMain.appendChild(contadorSpan);
                        }
                        
                        container.appendChild(notificacion);
                        this.grupos.set(grupoKey, notificacion);
                        
                        // Duraci√≥n y auto-cierre
                        if (duracion > 0) {
                            notificacion.timerID = setTimeout(() => {
                                this.cerrarNotificacion(notificacion, opciones);
                            }, duracion);
                        }
                    },
                    
                    // Cerrar notificaci√≥n con animaci√≥n
                    cerrarNotificacion: function(notificacion, opciones) {
                        notificacion.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            // Ejecutar callback si existe
                            if (opciones && opciones.callback && typeof opciones.callback === 'function') {
                                opciones.callback('cerrar', notificacion);
                            }
                            notificacion.remove();
                            // Limpiar de grupos
                            for (let [key, notif] of this.grupos) {
                                if (notif === notificacion) {
                                    this.grupos.delete(key);
                                    break;
                                }
                            }
                        }, 300);
                    },
                    
                    // üéØ Estilos para diferentes posiciones
                    getEstilosPosicion: function(posicion) {
                        const estilos = {
                            'top-right': 'top: 20px; right: 20px;',
                            'top-center': 'top: 20px; left: 50%; transform: translateX(-50%);',
                            'bottom-right': 'bottom: 20px; right: 20px;',
                            'bottom-left': 'bottom: 20px; left: 20px;'
                        };
                        return estilos[posicion] || estilos['top-right'];
                    },
                    
                    // üìã Ver historial de notificaciones
                    mostrarHistorial: function() {
                        console.table(this.historial);
                        return this.historial;
                    },
                    
                    // Limpiar historial
                    limpiarHistorial: function() {
                        this.historial = [];
                        console.log('‚úÖ Historial limpiado');
                    },
                    
                    // Controlar sonidos
                    activarSonidos: function() {
                        this.sonidosActivados = true;
                        console.log('üîä Sonidos activados');
                    },
                    
                    desactivarSonidos: function() {
                        this.sonidosActivados = false;
                        console.log('üîá Sonidos desactivados');
                    },
                    
                    // Cambiar posici√≥n por defecto
                    cambiarPosicion: function(nuevaPosicion) {
                        this.posicion = nuevaPosicion;
                        console.log(`üéØ Posici√≥n cambiada a: ${nuevaPosicion}`);
                    }
                };
            
            console.log('‚úì NotificationSystem mejorado v13.0 cargado correctamente');
        }, 500);
    </script>

    <!-- Tests autom√°ticos si se pasa ?test=true en URL -->
    <script>
        // Ejecutar inmediatamente al cargar
        (function() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('test') !== 'true') return;
            
            console.log('üß™ Modo TEST activado');
            
            // Ejecutar despu√©s de que el DOM est√© completamente listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', runTests);
            } else {
                setTimeout(runTests, 2000);
            }
        })();

        function runTests() {
            try {
                console.log('üî• Ejecutando tests...');
                
                let pass = 0, fail = 0;
                const results = [];

                function test(name, condition, message = '') {
                    if (condition) {
                        pass++;
                        results.push(`‚úì ${name}`);
                        console.log(`‚úì ${name}`);
                    } else {
                        fail++;
                        results.push(`‚úó ${name} ${message ? '- ' + message : ''}`);
                        console.log(`‚úó ${name}`, message);
                    }
                }

                // Tests
                test('Header existe', !!document.querySelector('header'));
                test('Top controls existe', !!document.querySelector('.top-controls'));
                const tabCount = document.querySelectorAll('.tab-btn').length;
                test('Tabs existen', tabCount >= 2, `(${tabCount} encontradas)`);
                test('AppState existe', typeof window.AppState !== 'undefined' && window.AppState !== null);
                test('EmployeeManager existe', typeof window.EmployeeManager !== 'undefined' && window.EmployeeManager !== null);
                test('TurnoManager existe', typeof window.TurnoManager !== 'undefined' && window.TurnoManager !== null);
                test('TurnoEditor existe', typeof window.TurnoEditor !== 'undefined' && window.TurnoEditor !== null);
                test('ExportManager existe', typeof window.ExportManager !== 'undefined' && window.ExportManager !== null);
                test('DateUtils existe', typeof window.DateUtils !== 'undefined' && window.DateUtils !== null);
                test('empleados array existe', Array.isArray(window.empleados), `(${window.empleados?.length || 0} empleados)`);
                test('EmployeeManager.abrirModal funci√≥n', typeof window.EmployeeManager?.abrirModal === 'function');
                test('TurnoManager.reiniciarDatos funci√≥n', typeof window.TurnoManager?.reiniciarDatos === 'function');
                test('TurnoEditor.mostrarModalEdicionMasiva funci√≥n', typeof window.TurnoEditor?.mostrarModalEdicionMasiva === 'function');
                test('ExportManager.exportarCuadranteGeneral funci√≥n', typeof window.ExportManager?.exportarCuadranteGeneral === 'function');
                test('DateUtils.cambiarMes funci√≥n', typeof window.DateUtils?.cambiarMes === 'function');

                const totalTests = pass + fail;
                const percentage = ((pass / totalTests) * 100).toFixed(1);
                
                console.log(`‚úì Tests completados: ${pass}/${totalTests} pasados (${percentage}%)`);

                // Crear modal de resultados
                const modalDiv = document.createElement('div');
                modalDiv.id = 'testResultsModal';
                modalDiv.innerHTML = `
                    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 99999; max-width: 600px; font-family: Arial, sans-serif;">
                        <h2 style="margin-bottom: 20px; color: #333;">üß™ Resultados de Tests</h2>
                        <div style="font-family: monospace; font-size: 13px; line-height: 1.8; background: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
                            ${results.map(r => `<div style="color: ${r.startsWith('‚úì') ? '#28a745' : '#dc3545'};">${r}</div>`).join('')}
                        </div>
                        <div style="background: ${percentage >= 80 ? '#d4edda' : '#f8d7da'}; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                            <strong style="font-size: 16px;">Pasados: ${pass}/${totalTests}</strong> (${percentage}%)
                            <div style="margin-top: 10px; color: #333;">
                                ${percentage >= 80 ? '‚úÖ APLICACI√ìN FUNCIONAL' : '‚ö†Ô∏è NECESITA REPARACIONES'}
                            </div>
                        </div>
                        <button onclick="document.getElementById('testResultsModal').remove()" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold;">Cerrar</button>
                    </div>
                `;
                document.body.appendChild(modalDiv);
                console.log('‚úì Modal de resultados mostrado');
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico en tests:', error);
                alert('Error en tests: ' + error.message + '\n\nMira la consola para m√°s detalles.');
            }
        }
    </script>

    

    <!-- Limpieza de inyectores de modo oscuro (extensiones/auto-dark) -->
    <script>
        (() => {
            const cleanDarkInjectors = () => {
                try {
                    const darkNodes = document.querySelectorAll('style[id^="darkreader"], link[id^="darkreader"]');
                    darkNodes.forEach(n => n.remove());
                    ['data-darkreader-mode', 'data-darkreader-scheme', 'data-theme'].forEach(attr => {
                        document.documentElement.removeAttribute(attr);
                        document.body.removeAttribute(attr);
                    });
                    document.documentElement.style.filter = '';
                    document.body.style.filter = '';
                    const darkBg = 'radial-gradient(circle at 15% 20%, #0f172a 0%, #0b1220 40%, #0a0f1c 80%)';
                    document.documentElement.style.background = darkBg;
                    document.body.style.background = darkBg;
                    document.documentElement.style.color = '#e5e7eb';
                    document.body.style.color = '#e5e7eb';
                } catch (e) {
                    console.warn('No se pudo limpiar inyectores de modo oscuro:', e);
                }
            };
            cleanDarkInjectors();
            setInterval(cleanDarkInjectors, 1500);
        })();
        
        // üîç FUNCI√ìN DE DIAGN√ìSTICO - Ejecuta en consola: diag()
        window.diag = function() {
            console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê DIAGN√ìSTICO DE PERSISTENCIA ‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #0ea5e9; font-weight: bold; font-size: 14px;');
            
            console.log('%c‚úì localStorage Disponible', 'color: #22c55e; font-weight: bold;');
            console.log('typeof localStorage:', typeof localStorage);
            
            try {
                localStorage.setItem('_test', '1');
                localStorage.removeItem('_test');
                console.log('localStorage funcionando: ‚úÖ SI');
            } catch(e) {
                console.log('localStorage funcionando: ‚ùå NO -', e.message);
            }
            
            console.log('%c‚úì Datos en localStorage', 'color: #22c55e; font-weight: bold;');
            const turnosAppState = localStorage.getItem('turnosAppState');
            const empleadosData = localStorage.getItem('empleadosData');
            const departamentosData = localStorage.getItem('departamentosData');
            
            console.log('turnosAppState:', turnosAppState ? '‚úÖ S√ç (' + turnosAppState.length + ' chars)' : '‚ùå NO');
            console.log('empleadosData:', empleadosData ? '‚úÖ S√ç (' + empleadosData.length + ' chars)' : '‚ùå NO');
            console.log('departamentosData:', departamentosData ? '‚úÖ S√ç (' + departamentosData.length + ' chars)' : '‚ùå NO');
            
            console.log('%c‚úì Estado en Memoria', 'color: #22c55e; font-weight: bold;');
            console.log('Empleados en memoria:', typeof empleados !== 'undefined' ? empleados.length : 0);
            console.log('AppState.scheduleData size:', typeof AppState !== 'undefined' ? AppState.scheduleData.size : 'N/A');
            
            console.log('%c‚úì Consola de Navegador', 'color: #22c55e; font-weight: bold;');
            console.log('URL actual:', window.location.href);
            console.log('¬øEs http://localhost?', window.location.href.includes('http://localhost') || window.location.href.includes('http://127.0.0.1') ? '‚úÖ SI' : '‚ùå NO (¬°localStorage NO funciona con file://)');
            
            console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #0ea5e9; font-weight: bold; font-size: 14px;');
            console.log('Para probar persistencia: 1) Abre DevTools (F12), 2) Application > LocalStorage, 3) Verifica http://localhost:8000');
        };
        
        console.log('%cüí° Tip: Escribe "diag()" en la consola para diagn√≥stico de persistencia', 'color: #f59e0b; font-weight: bold;');
    </script>

    <!-- SCRIPT: Estandarizaci√≥n Global de Iluminaci√≥n de Botones -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Selector de todos los botones interactivos
            const selectores = 'button:not(.notification-close)';
            
            // Extraer color RGB de una cadena
            function extraerRGB(cadena) {
                const match = cadena.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                if (match) {
                    return { r: parseInt(match[1]), g: parseInt(match[2]), b: parseInt(match[3]) };
                }
                return null;
            }
            
            // Convertir hex a RGB
            function hexARGB(hex) {
                if (!hex || typeof hex !== 'string') return null;
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            }
            
            // Obtener el color principal del bot√≥n - SIEMPRE devuelve un RGB v√°lido
            function obtenerColorPrincipal(elemento) {
                const style = window.getComputedStyle(elemento);
                let bg = style.background || style.backgroundColor;
                
                // Si est√° vac√≠o, usar color por defecto
                if (!bg || bg === 'rgba(0, 0, 0, 0)' || bg === 'transparent') {
                    // Intentar con color heredado o fallback
                    if (elemento.style.color) {
                        bg = elemento.style.color;
                    } else {
                        return { r: 14, g: 165, b: 233 }; // Cyan por defecto
                    }
                }
                
                // Si es un gradient, intentar extraer el primer color
                if (bg.includes('linear-gradient') || bg.includes('radial-gradient')) {
                    const match = bg.match(/#[0-9a-f]{6}|rgb\(\d+,\s*\d+,\s*\d+\)/gi);
                    if (match && match.length > 0) {
                        bg = match[0];
                    } else {
                        return { r: 14, g: 165, b: 233 }; // Cyan por defecto
                    }
                }
                
                // Convertir hex a RGB si es necesario
                if (bg.startsWith('#')) {
                    const rgb = hexARGB(bg);
                    return rgb || { r: 14, g: 165, b: 233 }; // Fallback a cyan
                }
                
                // Si es RGB, extraer
                if (bg.includes('rgb')) {
                    const rgb = extraerRGB(bg);
                    return rgb || { r: 14, g: 165, b: 233 }; // Fallback a cyan
                }
                
                // Color por defecto (cyan)
                return { r: 14, g: 165, b: 233 };
            }
            
            // Generar glow del mismo color del bot√≥n
            function generarGlowColor(rgb) {
                // Validaci√≥n: asegurarse de que rgb es v√°lido
                if (!rgb || typeof rgb !== 'object' || !('r' in rgb && 'g' in rgb && 'b' in rgb)) {
                    rgb = { r: 14, g: 165, b: 233 }; // Fallback a cyan
                }
                return `0 0 30px rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 1), 0 0 60px rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.8), 0 6px 20px rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.8)`;
            }
            
            // Generar sombra sutil del mismo color
            function generarSombraSutil(rgb) {
                // Validaci√≥n: asegurarse de que rgb es v√°lido
                if (!rgb || typeof rgb !== 'object' || !('r' in rgb && 'g' in rgb && 'b' in rgb)) {
                    rgb = { r: 14, g: 165, b: 233 }; // Fallback a cyan
                }
                return `0 2px 5px rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.2)`;
            }
            
            // Aplicar eventos a todos los botones (sin excepci√≥n)
            document.querySelectorAll(selectores).forEach(btn => {
                try {
                    const colorPrincipal = obtenerColorPrincipal(btn);
                    const glowIntensso = generarGlowColor(colorPrincipal);
                    const sombraSutil = generarSombraSutil(colorPrincipal);
                    
                    // Remover handlers existentes si los hay
                    btn.removeAttribute('onmouseover');
                    btn.removeAttribute('onmouseout');
                    
                    btn.addEventListener('mouseenter', function() {
                        this.style.boxShadow = glowIntensso;
                    });
                    
                    btn.addEventListener('mouseleave', function() {
                        this.style.boxShadow = sombraSutil;
                    });
                    
                    // Asegurarse de que inicia con sombra sutil
                    if (!btn.style.boxShadow || btn.style.boxShadow === '') {
                        btn.style.boxShadow = sombraSutil;
                    }
                } catch (e) {
                    console.warn('Error al aplicar glow a bot√≥n:', e);
                }
            });
            
            // Observer para botones din√°micos (agregados despu√©s)
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1 && node.tagName === 'BUTTON') {
                            try {
                                const colorPrincipal = obtenerColorPrincipal(node);
                                const glowIntensso = generarGlowColor(colorPrincipal);
                                const sombraSutil = generarSombraSutil(colorPrincipal);
                                
                                if (!node.hasAttribute('onmouseover')) {
                                    node.addEventListener('mouseenter', function() {
                                        this.style.boxShadow = glowIntensso;
                                    });
                                    
                                    node.addEventListener('mouseleave', function() {
                                        this.style.boxShadow = sombraSutil;
                                    });
                                    
                                    node.style.boxShadow = sombraSutil;
                                }
                            } catch (e) {
                                console.warn('Error con bot√≥n din√°mico:', e);
                            }
                        } else if (node.nodeType === 1) {
                            // Si es un contenedor, buscar botones dentro
                            node.querySelectorAll('button').forEach(btn => {
                                if (!btn.hasAttribute('onmouseover') && !btn._glowApplied) {
                                    try {
                                        btn._glowApplied = true;
                                        const colorPrincipal = obtenerColorPrincipal(btn);
                                        const glowIntensso = generarGlowColor(colorPrincipal);
                                        const sombraSutil = generarSombraSutil(colorPrincipal);
                                        
                                        btn.addEventListener('mouseenter', function() {
                                            this.style.boxShadow = glowIntensso;
                                        });
                                        
                                        btn.addEventListener('mouseleave', function() {
                                            this.style.boxShadow = sombraSutil;
                                        });
                                        
                                        btn.style.boxShadow = sombraSutil;
                                    } catch (e) {
                                        console.warn('Error con bot√≥n en contenedor:', e);
                                    }
                                }
                            });
                        }
                    });
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
    </script>
    
    <!-- Clase para calcular horas inteligentemente (res√∫menes mensuales) -->
    <script>
        window.CalculadorHorasInteligente = {
            // Calcular resumen mensual de horas para un empleado
            calcularResumenMensual(empId, mes, anio) {
                try {
                    // Obtener turnos del empleado
                    const turnos = AppState?.scheduleData?.get(empId) || [];
                    
                    if (!turnos || turnos.length === 0) {
                        return {
                            empId,
                            mes,
                            anio,
                            horasContrato: 160,
                            totalHorasTrabajadas: 0,
                            diasTrabajados: 0,
                            diasDescanso: 0,
                            diasVacaciones: 0,
                            diasBaja: 0,
                            diasGuardias: 0,
                            diasFestivos: 0,
                            diferencia: -160
                        };
                    }
                    
                    // Filtrar turnos del mes actual
                    const turnosDelMes = turnos.filter(t => {
                        if (!t.fecha) return false;
                        const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                        return fecha.getMonth() === mes && fecha.getFullYear() === anio;
                    });
                    
                    // Obtener horas de contrato del empleado
                    const empleadosData = JSON.parse(localStorage.getItem('empleadosData') || '[]');
                    const empleado = empleadosData.find(e => e.id === empId) || empleados?.find(e => e.id === empId);
                    const horasContrato = empleado?.horasContrato || 160;
                    
                    // Calcular horas trabajadas
                    let totalHorasTrabajadas = 0;
                    let diasTrabajados = 0;
                    let diasDescanso = 0;
                    let diasVacaciones = 0;
                    let diasBaja = 0;
                    let diasGuardias = 0;
                    let diasFestivos = 0;
                    
                    turnosDelMes.forEach(turno => {
                        const tipo = turno.turno?.toLowerCase() || '';
                        const horas = turno.horas || 0;
                        
                        if (tipo === 'descanso') {
                            diasDescanso++;
                        } else if (tipo === 'vacaciones') {
                            diasVacaciones++;
                        } else if (tipo === 'baja') {
                            diasBaja++;
                        } else if (tipo === 'guardia') {
                            diasGuardias++;
                            totalHorasTrabajadas += horas;
                            diasTrabajados++;
                        } else if (tipo === 'festivo') {
                            diasFestivos++;
                        } else if (tipo === '') {
                            // Sin asignar
                        } else {
                            // Otros tipos (ma√±ana, tarde, noche, mixto, etc.)
                            totalHorasTrabajadas += horas;
                            diasTrabajados++;
                        }
                    });
                    
                    const diferencia = totalHorasTrabajadas - horasContrato;
                    
                    return {
                        empId,
                        mes,
                        anio,
                        horasContrato,
                        totalHorasTrabajadas,
                        diasTrabajados,
                        diasDescanso,
                        diasVacaciones,
                        diasBaja,
                        diasGuardias,
                        diasFestivos,
                        diferencia
                    };
                } catch (e) {
                    console.error('[CalculadorHorasInteligente] Error:', e);
                    return null;
                }
            },
            
            // Generar HTML del resumen
            generarResumenHTML(resumen, empleadoActual) {
                if (!resumen) return '<div>Error calculando resumen</div>';
                
                const {
                    horasContrato,
                    totalHorasTrabajadas,
                    diasTrabajados,
                    diasDescanso,
                    diasVacaciones,
                    diasBaja,
                    diasGuardias,
                    diferencia
                } = resumen;
                
                // Color seg√∫n diferencia
                let colorDiferencia = '#666';
                if (diferencia > 0) colorDiferencia = '#22c55e'; // Verde (excedente)
                else if (diferencia < -8) colorDiferencia = '#ef4444'; // Rojo (insuficiente)
                else colorDiferencia = '#f59e0b'; // Amarillo (poco)
                
                return `
                    <div style="padding: 12px; background: #f5f5f5; border-radius: 6px; font-size: 12px; font-family: Arial;">
                        <div style="margin-bottom: 10px; font-weight: bold; color: #333;">üìä Resumen de Horas</div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                            <div>
                                <span style="color: #666;">Contrato:</span>
                                <div style="font-weight: bold; color: #0a0a0a;">${horasContrato.toFixed(0)}h</div>
                            </div>
                            <div>
                                <span style="color: #666;">Trabajadas:</span>
                                <div style="font-weight: bold; color: #0a0a0a;">${totalHorasTrabajadas.toFixed(1)}h</div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 6px; border-radius: 4px; margin-bottom: 8px; text-align: center;">
                            <span style="color: #666;">Diferencia:</span>
                            <div style="font-weight: bold; font-size: 14px; color: ${colorDiferencia};">
                                ${diferencia > 0 ? '+' : ''}${diferencia.toFixed(1)}h
                            </div>
                        </div>
                        
                        <div style="font-size: 11px; color: #999; line-height: 1.4;">
                            ${diasTrabajados} d√≠as trabajados
                            ${diasDescanso > 0 ? ` ‚Ä¢ ${diasDescanso} descanso` : ''}
                            ${diasVacaciones > 0 ? ` ‚Ä¢ ${diasVacaciones} vacaciones` : ''}
                            ${diasBaja > 0 ? ` ‚Ä¢ ${diasBaja} baja` : ''}
                            ${diasGuardias > 0 ? ` ‚Ä¢ ${diasGuardias} guardias` : ''}
                        </div>
                    </div>
                `;
            }
        };
        
        // Confirmar que est√° disponible
        console.log('‚úÖ CalculadorHorasInteligente cargado y disponible globalmente');
        
        // Monitorear cambios en el DOM para detectar nuevos res√∫menes
        function inicializarObservadorResumenes() {
            // Guard: Esperar a que CalculadorHorasInteligente est√© disponible
            if (typeof window.CalculadorHorasInteligente === 'undefined' || !window.CalculadorHorasInteligente.calcularResumenMensual) {
                console.log('[ResumenObserver] Esperando CalculadorHorasInteligente...');
                setTimeout(inicializarObservadorResumenes, 100);
                return;
            }
            
            console.log('[ResumenObserver] CalculadorHorasInteligente listo, iniciando observer');
            
            // Observer para detectar nuevos divs resumen agregados
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(mutation => {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            // Buscar divs con data-emp-id dentro del nodo agregado
                            const divs = node.querySelectorAll ? node.querySelectorAll('[data-emp-id][data-mes][data-anio]') : [];
                            if (node.hasAttribute && node.hasAttribute('data-emp-id')) {
                                procesarDiv(node);
                            }
                            divs.forEach(procesarDiv);
                        }
                    });
                });
            });
            
            // Monitorear cambios en el body
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            console.log('[ResumenObserver] Observer iniciado');
        }
        
        function procesarDiv(div) {
            try {
                const empId = parseInt(div.getAttribute('data-emp-id'));
                // IMPORTANTE: USAR AppState.currentMonth/Year, no los data attributes (pueden estar desactualizados)
                const mes = typeof AppState !== 'undefined' && AppState.currentMonth !== undefined ? AppState.currentMonth : parseInt(div.getAttribute('data-mes'));
                const anio = typeof AppState !== 'undefined' && AppState.currentYear ? AppState.currentYear : parseInt(div.getAttribute('data-anio'));
                
                console.log('[ResumenObserver] Procesando resumen para empleado', empId, 'mes', mes, 'a√±o', anio);
                
                if (typeof window.CalculadorHorasInteligente !== 'undefined') {
                    // üîß Cargar empleado desde localStorage, fallback a array global
                    const empleadosActuales = JSON.parse(localStorage.getItem('empleadosData') || '[]');
                    const empleadoActual = empleadosActuales.find(e => e.id === empId) || empleados.find(e => e.id === empId);
                    
                    if (empleadoActual) {
                        console.log('[ResumenObserver] Empleado encontrado:', empleadoActual.nombre, 'Contrato:', empleadoActual.horasContrato, 'h');
                    }
                    
                    const resumen = window.CalculadorHorasInteligente.calcularResumenMensual(empId, mes, anio);
                    if (resumen) {
                        console.log('[ResumenObserver] Resumen calculado - Contrato:', resumen.horasContrato, 'h | Trabajadas:', resumen.totalHorasTrabajadas.toFixed(2), 'h | Guardias:', resumen.diasGuardias);
                        // üîß Pasar empleadoActual para que use horasContrato directo del empleado
                        const htmlResumen = window.CalculadorHorasInteligente.generarResumenHTML(resumen, empleadoActual);
                        div.innerHTML = htmlResumen;
                        console.log('[ResumenObserver] Resumen procesado correctamente');
                    } else {
                        console.warn('[ResumenObserver] Resumen nulo para empleado', empId);
                    }
                }
            } catch(e) {
                console.warn('[ResumenObserver] Error procesando resumen:', e);
                console.error(e.stack);
            }
        }
        
        // Iniciar cuando todo est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarObservadorResumenes);
        } else {
            setTimeout(inicializarObservadorResumenes, 500);
        }
    </script>
    
    <!-- Script para llenar selects del modal de edici√≥n masiva -->
    <script>
        function llenarSelectesModalEdicion() {
            console.log('[Modal Edici√≥n Masiva] Llenando selects...');
            
            // 1Ô∏è‚É£ LLENAR SELECT DE EMPLEADOS
            const selectEmpleado = document.getElementById('masiva_empleado');
            if (selectEmpleado) {
                // Limpiar opciones previas (excepto la de "Elige un empleado")
                while (selectEmpleado.options.length > 1) {
                    selectEmpleado.remove(1);
                }
                
                // Agregar empleados
                empleados.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `${emp.nombre}`;
                    selectEmpleado.appendChild(option);
                });
                console.log(`‚úÖ ${empleados.length} empleados cargados`);
            }
            
            // 2Ô∏è‚É£ LLENAR SELECTS DE FECHAS (Desde y Hasta)
            const diasEnMes = new Date(AppState.currentYear, AppState.currentMonth + 1, 0).getDate();
            const selectDesde = document.getElementById('masiva_desde');
            const selectHasta = document.getElementById('masiva_hasta');
            
            if (selectDesde) {
                // Limpiar opciones previas
                while (selectDesde.options.length > 1) {
                    selectDesde.remove(1);
                }
                
                // Agregar d√≠as
                for (let dia = 1; dia <= diasEnMes; dia++) {
                    const option = document.createElement('option');
                    option.value = dia;
                    option.textContent = `${dia}`;
                    selectDesde.appendChild(option);
                }
                console.log(`‚úÖ ${diasEnMes} d√≠as cargados en "Desde"`);
            }
            
            if (selectHasta) {
                // Limpiar opciones previas
                while (selectHasta.options.length > 1) {
                    selectHasta.remove(1);
                }
                
                // Agregar d√≠as
                for (let dia = 1; dia <= diasEnMes; dia++) {
                    const option = document.createElement('option');
                    option.value = dia;
                    option.textContent = `${dia}`;
                    selectHasta.appendChild(option);
                }
                console.log(`‚úÖ ${diasEnMes} d√≠as cargados en "Hasta"`);
            }
            
            // 3Ô∏è‚É£ LLENAR SELECT DE TURNOS
            const selectTurno = document.getElementById('masiva_turno');
            if (selectTurno && typeof tiposTurno !== 'undefined') {
                // Limpiar opciones previas
                while (selectTurno.options.length > 1) {
                    selectTurno.remove(1);
                }
                
                // Agregar turnos
                Object.keys(tiposTurno).forEach(turnoKey => {
                    const option = document.createElement('option');
                    option.value = turnoKey;
                    option.textContent = tiposTurno[turnoKey].nombre || turnoKey;
                    selectTurno.appendChild(option);
                });
                console.log(`‚úÖ Turnos cargados`);
            }
        }
        
        // Ejecutar al cargar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(llenarSelectesModalEdicion, 500);
            });
        } else {
            setTimeout(llenarSelectesModalEdicion, 500);
        }
    </script>
    
    <!-- SEMANA 4 SCRIPTS -->
    <script src="js/gestor-multilocal.js"></script>
    <script src="js/integracion-calendario.js"></script>
    <script src="js/sistema-notificaciones.js"></script>
    <script src="js/controles-semana-4.js"></script>
    
    <!-- SEMANA 5 SCRIPTS -->
    <script src="js/dashboard-avanzado-s5.js"></script>
    <script src="js/sistema-auditoria-s5.js"></script>
    <script src="js/gestor-backups-s5.js"></script>
    <script src="js/controles-semana-5.js"></script>
    
    <!-- üîí PROTECCI√ìN v11.2: Garantizar TurnoManager + Protecci√≥n Auto-Gen -->
    <script>
        console.log('üîí [PROTECCI√ìN v11.2] Verificando TurnoManager y asegurando disponibilidad de funciones');
        
        // Crear TurnoManager si no existe
        if (!window.TurnoManager) {
            console.warn('‚ö†Ô∏è TurnoManager no existente, creando objeto');
            window.TurnoManager = {};
        }
        
        // Esperar a que las funciones est√©n disponibles
        let checkCount = 0;
        const maxChecks = 20;  // 2 segundos de espera
        
        const ensureTurnoManagerFunctions = () => {
            checkCount++;
            console.log(`[PROTECCI√ìN] Check ${checkCount}/${maxChecks}: Verificando funciones disponibles...`);
            
            // Verificar si las funciones clave existen
            const funcionesRequeridas = [
                'inicializarDatos',
                'reiniciarDatos',
                'generarTurnosEmpleado',
                'esCuadranteVacio',
                'mostrarModalGeneracion',
                'cerrarModalGeneracion',
                'generarTurnos',
                'verificarYMostrarBoton'
            ];
            
            const funcionesFaltantes = funcionesRequeridas.filter(f => 
                !window.TurnoManager[f] || typeof window.TurnoManager[f] !== 'function'
            );
            
            if (funcionesFaltantes.length === 0) {
                console.log('‚úÖ [PROTECCI√ìN] ¬°TODAS las funciones de TurnoManager est√°n disponibles!');
                console.log('   -  inicializarDatos ‚úì');
                console.log('   - reiniciarDatos ‚úì');
                console.log('   - generarTurnosEmpleado ‚úì');
                console.log('   - esCuadranteVacio ‚úì');
                console.log('   - mostrarModalGeneracion ‚úì');
                console.log('   - cerrarModalGeneracion ‚úì');
                console.log('   - generarTurnos ‚úì');
                console.log('   - verificarYMostrarBoton ‚úì');
                instalarProtecciones();
            } else if (checkCount < maxChecks) {
                console.log(`‚è≥ [PROTECCI√ìN] Funciones faltantes: ${funcionesFaltantes.join(', ')} - Esperando...`);
                setTimeout(ensureTurnoManagerFunctions, 100);
            } else {
                console.error(`‚ùå [PROTECCI√ìN] TIMEOUT: Las siguientes funciones NO existen: ${funcionesFaltantes.join(', ')}`);
                console.error('[PROTECCI√ìN] Esto causar√° error al hacer clic en bot√≥n del modal');
            }
        };
        
        function instalarProtecciones() {
            console.log('üîí [PROTECCI√ìN] Instalando protecciones contra auto-generaci√≥n...');
            
            // Guardar las funciones originales
            const originalInitialize = window.TurnoManager.inicializarDatos;
            const originalGenerarTurnos = window.TurnoManager.generarTurnos;
            let autoGenerationEnabled = false;
            
            // Proteger inicializarDatos
            window.TurnoManager.inicializarDatos = function() {
                if (!autoGenerationEnabled) {
                    console.warn('‚ö†Ô∏è [PROTECCI√ìN] inicializarDatos() bloqueado - Use bot√≥n "Generar Turnos"');
                    return;
                }
                console.log('‚úÖ [PROTECCI√ìN] inicializarDatos() AUTORIZADO - ejecutando');
                return originalInitialize.call(this);
            };
            
            // Permitir generarTurnos para autorizar inicializarDatos
            window.TurnoManager.generarTurnos = async function() {
                console.log('üü¢ [PROTECCI√ìN] generarTurnos() invocado - AUTORIZANDO inicializarDatos()');
                autoGenerationEnabled = true;
                try {
                    const resultado = await originalGenerarTurnos.call(this);
                    console.log('‚úÖ [PROTECCI√ìN] generarTurnos() completado EXITOSAMENTE');
                    return resultado;
                } catch (err) {
                    console.error('‚ùå [PROTECCI√ìN] Error en generarTurnos():', err);
                    throw err;
                } finally {
                    autoGenerationEnabled = false;
                    console.log('üîí [PROTECCI√ìN] Reactivando bloqueo de inicializarDatos()');
                }
            };
            
            console.log('‚úÖ [PROTECCI√ìN] Protecciones instaladas correctamente');
            console.log('   - inicializarDatos() est√° BLOQUEADO a menos que se llame desde generarTurnos()');
            console.log('   - El modal podr√° generar turnos cuando el usuario haga clic');
        }
        
        // Iniciar verificaci√≥n
        ensureTurnoManagerFunctions();
    </script>

    <!-- üîê OPCI√ìN SEGURA PARA LIMPIAR DATOS -->
    <script>
        // Funci√≥n GLOBAL para mostrar modal de limpieza
        window.mostrarModalLimpieza = async function() {
            console.log('üîê Abriendo modal de limpieza...');
            
            // Obtener mes y a√±o actual
            const mesesNombre = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            const mesActual = mesesNombre[AppState.currentMonth] || 'Desconocido';
            const anioActual = AppState.currentYear;
            
            // Crear overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            // Crear modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 40px;
                max-width: 400px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                text-align: center;
            `;

            modal.innerHTML = `
                <h2 style="color: #e74c3c; margin-top: 0;">‚ö†Ô∏è LIMPIAR CUADRANTE DE TURNOS</h2>
                <p style="color: #666; margin: 20px 0;">Esta acci√≥n borrar√° todos los turnos de <strong>${mesActual} ${anioActual}</strong> del navegador y base de datos.</p>
                <p style="color: #27ae60; font-weight: bold; margin: 10px 0;">‚úÖ Los empleados, localidades y tipos de turno se preservar√°n.</p>
                <p style="color: #e74c3c; font-weight: bold; margin: 20px 0;">‚ö†Ô∏è ¬°NO SE PUEDE DESHACER!</p>
                <p style="color: #999; font-size: 12px; margin: 20px 0;">Ingresa la contrase√±a para continuar:</p>
                <input type="password" id="inputClave" placeholder="Contrase√±a" style="
                    width: 100%;
                    padding: 10px;
                    border: 2px solid #ddd;
                    border-radius: 4px;
                    font-size: 14px;
                    box-sizing: border-box;
                    margin: 10px 0;
                ">
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="btnCancelar" style="
                        flex: 1;
                        padding: 10px;
                        background: #95a5a6;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        font-weight: bold;
                    ">Cancelar</button>
                    <button id="btnConfirmar" style="
                        flex: 1;
                        padding: 10px;
                        background: #e74c3c;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        font-weight: bold;
                    ">Eliminar</button>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            const inputClave = document.getElementById('inputClave');
            const btnConfirmar = document.getElementById('btnConfirmar');
            const btnCancelar = document.getElementById('btnCancelar');

            inputClave.focus();

            btnCancelar.onclick = () => {
                console.log('‚ùå Limpieza cancelada');
                overlay.remove();
            };

            btnConfirmar.onclick = async () => {
                const clave = inputClave.value;
                const claveCorrecta = 'admin123';

                if (clave === claveCorrecta) {
                    console.log('‚úÖ Contrase√±a correcta, iniciando limpieza...');
                    modal.innerHTML = `
                        <h2 style="color: #f39c12; margin-top: 0;">‚è≥ ELIMINANDO DATOS...</h2>
                        <p style="color: #555; margin: 20px 0;">Por favor espera...</p>
                    `;
                    
                    try {
                        // PASO 1: Limpiar localStorage (SOLO turnos, NO empleados)
                        console.log('üì¶ Paso 1: Limpiando turnos de localStorage...');
                        
                        // Guardar empleados antes de limpiar
                        const empleadosBackup = localStorage.getItem('empleadosData');
                        const tiposTurnoBackup = localStorage.getItem('tiposTurnoData');
                        
                        const keysAEliminar = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            // NO eliminar empleados, tipos de turno, ni localidades
                            if (key !== 'empleadosData' && 
                                key !== 'tiposTurnoData' && 
                                key !== 'localidadesData' &&
                                !key.startsWith('festivos_')) {
                                keysAEliminar.push(key);
                            }
                        }
                        keysAEliminar.forEach(key => {
                            console.log(`  üóëÔ∏è Eliminando: ${key}`);
                            localStorage.removeItem(key);
                        });
                        console.log(`‚úÖ Turnos eliminados (${keysAEliminar.length} keys). Empleados preservados`);
                        
                        // PASO 2: Limpiar sessionStorage
                        console.log('üì¶ Paso 2: Limpiando sessionStorage...');
                        sessionStorage.clear();
                        console.log('‚úÖ sessionStorage limpio');
                        
                        // PASO 3: BORRAR DE LA API/BD
                        console.log('üóëÔ∏è Paso 3: Obteniendo lista de empleados...');
                        
                        // Obtener empleados desde window.empleados o desde localStorage
                        let listaEmpleados = window.empleados || [];
                        if (!listaEmpleados || listaEmpleados.length === 0) {
                            // Intentar cargar desde localStorage
                            try {
                                const empleadosJSON = localStorage.getItem('empleadosData');
                                if (empleadosJSON) {
                                    listaEmpleados = JSON.parse(empleadosJSON);
                                    console.log(`üì¶ Empleados cargados desde localStorage: ${listaEmpleados.length}`);
                                }
                            } catch (e) {
                                console.warn('‚ö†Ô∏è No se pudo cargar empleados de localStorage:', e);
                            }
                        }
                        
                        if (!listaEmpleados || listaEmpleados.length === 0) {
                            console.warn('‚ö†Ô∏è No hay empleados para eliminar');
                            listaEmpleados = [];
                        }
                        
                        console.log(`üóëÔ∏è Iniciando DELETE para ${listaEmpleados.length} empleados...`);
                        let eliminadosExito = 0;
                        let eliminadosFallo = 0;
                        
                        for (const empleado of listaEmpleados) {
                            try {
                                const empleadoId = empleado.id || empleado.ID;
                                console.log(`  üóëÔ∏è DELETE empleado ${empleadoId}... (mes=${AppState.currentMonth}, anio=${AppState.currentYear})`);
                                const response = await fetch(`http://localhost:5001/api/turnos/${empleadoId}`, {
                                    method: 'DELETE',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        mes: AppState.currentMonth,  // Mes actual visualizado
                                        anio: AppState.currentYear   // A√±o actual visualizado
                                    })
                                });
                                
                                // üîß Verificar que la respuesta sea exitosa
                                if (!response.ok) {
                                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                                }
                                
                                const resultado = await response.json();
                                
                                // üîß Verificar que el servidor report√≥ √©xito
                                if (!resultado.success) {
                                    throw new Error(`Servidor rechaz√≥: ${resultado.message}`);
                                }
                                
                                console.log(`    ‚úÖ Respuesta: ${resultado.message}`);
                                eliminadosExito++;
                            } catch (error) {
                                console.error(`    ‚ùå Error: ${error.message}`);
                                eliminadosFallo++;
                                // No continuar si hay error
                                throw new Error(`Fallo eliminando empleado ${empleadoId}: ${error.message}`);
                            }
                        }
                        console.log(`‚úÖ BD: ${eliminadosExito} empleados OK, ${eliminadosFallo} con error`);
                        
                        // üî• LIMPIAR MEMORIA TAMBI√âN - Esto es cr√≠tico
                        console.log('üóëÔ∏è Limpiando datos de ESTE MES en memoria (AppState.scheduleData)...');
                        if (typeof AppState !== 'undefined' && AppState.scheduleData) {
                            // üîß S√ìLO limpiar turnos del mes/a√±o actual, NO borrar TODO
                            AppState.scheduleData.forEach((turnos, empleadoId) => {
                                const turnosDelMes = turnos.filter(t => {
                                    if (!t.fecha) return false;
                                    const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                                    return fecha.getMonth() !== AppState.currentMonth || fecha.getFullYear() !== AppState.currentYear;
                                });
                                if (turnosDelMes.length > 0) {
                                    AppState.scheduleData.set(empleadoId, turnosDelMes);
                                    console.log(`  ‚úÖ Empleado ${empleadoId}: ${turnosDelMes.length} turnos restantes`);
                                } else {
                                    AppState.scheduleData.delete(empleadoId);
                                    console.log(`  ‚úÖ Empleado ${empleadoId}: Todos los turnos eliminados para este mes`);
                                }
                            });
                            AppState.saveToStorage();
                            console.log('‚úÖ AppState.scheduleData actualizado (SOLO mes/a√±o actual limpiado)');
                        }
                        
                        // Mostrar confirmaci√≥n
                        const mesesNombre = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
                        const mesActual = mesesNombre[AppState.currentMonth] || 'Desconocido';
                        
                        modal.innerHTML = `
                            <h2 style="color: #27ae60; margin-top: 0;">‚úÖ CUADRANTE LIMPIADO</h2>
                            <p style="color: #555; margin: 20px 0;">Todos los turnos de ${mesActual} han sido eliminados:</p>
                            <p style="color: #27ae60; font-weight: bold;">‚úÖ localStorage: Turnos eliminados</p>
                            <p style="color: #27ae60; font-weight: bold;">‚úÖ Memoria: Datos de turnos limpios</p>
                            <p style="color: #27ae60; font-weight: bold;">‚úÖ BD: ${eliminadosExito}/${listaEmpleados.length} empleados procesados</p>
                            <p style="color: #f39c12; font-weight: bold;">‚úÖ Empleados, localidades y tipos de turno: PRESERVADOS</p>
                            <p style="color: #999; font-size: 12px;">Puedes ver los logs en la consola (F12).</p>
                            <button onclick="location.reload()" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px; font-weight: bold;">Recargar p√°gina</button>
                        `;

                        
                    } catch (error) {
                        console.error('‚ùå Error general durante limpieza:', error);
                        modal.innerHTML = `
                            <h2 style="color: #e74c3c; margin-top: 0;">‚ùå ERROR</h2>
                            <p style="color: #555; margin: 20px 0;">Hubo un error: ${error.message}</p>
                            <button onclick="location.reload()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Recargar p√°gina</button>
                        `;
                    }
                } else {
                    console.log('‚ùå Contrase√±a incorrecta');
                    inputClave.style.borderColor = '#e74c3c';
                    inputClave.style.background = '#fadbd8';
                    inputClave.value = '';
                    inputClave.placeholder = '‚ùå Contrase√±a incorrecta';
                    inputClave.focus();
                }
            };

            // Enter para confirmar
            inputClave.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    btnConfirmar.click();
                }
            };
        };

        // Crear bot√≥n flotante de limpieza en la esquina inferior derecha
        const botonLimpieza = document.createElement('button');
        botonLimpieza.innerHTML = 'üóëÔ∏è';
        botonLimpieza.title = 'Limpiar datos (requiere contrase√±a)';
        botonLimpieza.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
            transition: all 0.3s ease;
            z-index: 5000;
        `;
        
        botonLimpieza.onmouseover = () => {
            botonLimpieza.style.transform = 'scale(1.1)';
            botonLimpieza.style.boxShadow = '0 6px 20px rgba(231, 76, 60, 0.6)';
        };
        
        botonLimpieza.onmouseout = () => {
            botonLimpieza.style.transform = 'scale(1)';
            botonLimpieza.style.boxShadow = '0 4px 12px rgba(231, 76, 60, 0.4)';
        };
        
        botonLimpieza.onclick = () => {
            console.log('üóëÔ∏è Bot√≥n limpieza clickeado');
            window.mostrarModalLimpieza();
        };
        
        // Esperar a que DOM est√© listo
        if (document.body) {
            document.body.appendChild(botonLimpieza);
            console.log('‚úÖ Bot√≥n limpieza agregado al DOM');
        } else {
            document.addEventListener('DOMContentLoaded', () => {
                document.body.appendChild(botonLimpieza);
                console.log('‚úÖ Bot√≥n limpieza agregado al DOM (DOMContentLoaded)');
            });
        }
        
        // ‚úÖ INICIALIZAR NOTIFICATIONSYSTEM COMPLETO AL CARGAR LA P√ÅGINA
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üü¢ [DOMContentLoaded] P√°gina cargada');
            console.log('‚úÖ NotificationSystem.reproducirSonido existe:', typeof window.NotificationSystem.reproducirSonido === 'function');
            
            if (window.NotificationSystem && window.NotificationSystem.reproducirSonido) {
                console.log('‚úÖ NotificationSystem mejorado completamente cargado');
            } else {
                console.log('‚è≥ Esperando que NotificationSystem se cargue completamente...');
            }
        });
        
        // Verificar cuando est√° listo
        window.addEventListener('load', function() {
            setTimeout(() => {
                console.log('%c‚úÖ NotificationSystem LISTO', 'background: #4CAF50; color: white; padding: 10px;');
                console.log('M√©todos disponibles:', Object.keys(window.NotificationSystem).filter(k => typeof window.NotificationSystem[k] === 'function'));
            }, 500);
        });
    </script>

    <!-- Funciones Globales del Sidebar para compatibilidad -->
    <script>
        // Funciones globales que llaman a las funciones del sidebar

        // Si existe abrirValidacion en controles-semana-1.js, usar ese
        // Si no, crear un stub
        if (typeof abrirValidacion === 'undefined') {
            window.abrirValidacion = function() {
                console.log('üîç abrirValidacion - no existe a√∫n, cargando...');
                if (typeof window.abrirValidacion_loaded === 'function') {
                    window.abrirValidacion_loaded();
                }
            };
        }

        // Auto-guardado UI - Delegado a m√≥dulo modular
        // ‚úÖ SIEMPRE definir/sobrescribir la funci√≥n para asegurar que use el nuevo modal
        window.abrirAutoGuardado = function() {
            console.log('üìã Abriendo Auto-guardado...');
            
            // Limpiar cualquier elemento antiguo que pueda interferir
            const elementosAntiguos = document.querySelectorAll('[id*="autoguard" i]:not(#modalAutoGuardado), [id*="autosave" i]:not(#modalAutoGuardado), [id*="configuracion" i]');
            elementosAntiguos.forEach(el => {
                console.log('üóëÔ∏è Removiendo elemento antiguo:', el.id);
                el.remove();
            });
            
            // Esperar a que AutoSaveUIModule est√© listo
            if (typeof AutoSaveUIModule === 'undefined') {
                console.warn('‚è≥ AutoSaveUIModule a√∫n no se ha cargado. Esperando...');
                let intentos = 0;
                const esperar = setInterval(() => {
                    if (typeof AutoSaveUIModule !== 'undefined') {
                        clearInterval(esperar);
                        console.log('‚úÖ AutoSaveUIModule cargado, abriendo modal');
                        AutoSaveUIModule.abrirModal();
                    } else if (++intentos > 50) {
                        clearInterval(esperar);
                        console.error('‚ùå Error: AutoSaveUIModule no carg√≥');
                        alert('‚ö†Ô∏è El m√≥dulo de auto-guardado no se carg√≥. Recarga la p√°gina (Ctrl+Shift+R).');
                    }
                }, 100);
            } else {
                console.log('‚úÖ AutoSaveUIModule disponible, abriendo modal');
                AutoSaveUIModule.abrirModal();
            }
        };

        
        // ============================================================================
        // üìä M√ìDULO: M√©tricas y Dashboard
        // ============================================================================
        if (typeof window.MetricasModule === 'undefined') {
            window.MetricasModule = (function() {
                
                // ===== VARIABLES PRIVADAS =====
                const mesesNombre = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
                let ultimasMetricas = null;
                let cacheActivo = true;
                
                // ===== FUNCIONES PRIVADAS =====
                function calcularMetricas() {
                    try {
                        if (!empleados || empleados.length === 0) {
                            console.warn('‚ö†Ô∏è No hay empleados en el sistema');
                            return null;
                        }
                        
                        const mesActual = AppState.currentMonth;
                        const anioActual = AppState.currentYear;
                        
                        let totalHoras = 0;
                        let totalTurnosNoche = 0;
                        let totalTurnos = 0;
                        let empleadosActivos = empleados.filter(e => e.estado === 'activo').length;
                        let empleadosConTurnos = 0;
                        let distribucionTurnos = {
                            ma√±ana: 0,
                            tarde: 0,
                            noche: 0,
                            mixto: 0,
                            descanso: 0,
                            vacaciones: 0,
                            baja: 0,
                            festivo: 0,
                            otros: 0
                        };
                        
                        // Detalles por empleado
                        const detallesPorEmpleado = [];
                        
                        empleados.forEach(emp => {
                            const turnos = AppState.scheduleData.get(emp.id) || [];
                            let horasEmpleado = 0;
                            let turnosEmpleado = 0;
                            
                            turnos.forEach(t => {
                                const fecha = t.fecha instanceof Date ? t.fecha : new Date(t.fecha);
                                if (fecha.getMonth() === mesActual && fecha.getFullYear() === anioActual) {
                                    totalHoras += (t.horas || 0);
                                    horasEmpleado += (t.horas || 0);
                                    totalTurnos++;
                                    turnosEmpleado++;
                                    
                                    if (t.turno === 'noche') totalTurnosNoche++;
                                    
                                    // Contar distribuci√≥n
                                    if (distribucionTurnos.hasOwnProperty(t.turno)) {
                                        distribucionTurnos[t.turno]++;
                                    } else {
                                        distribucionTurnos.otros++;
                                    }
                                }
                            });
                            
                            if (turnosEmpleado > 0) {
                                empleadosConTurnos++;
                                detallesPorEmpleado.push({
                                    nombre: emp.nombre,
                                    horas: horasEmpleado,
                                    turnos: turnosEmpleado
                                });
                            }
                        });
                        
                        return {
                            mes: mesActual,
                            a√±o: anioActual,
                            empleadosActivos,
                            empleadosConTurnos,
                            totalEmpleados: empleados.length,
                            totalHoras: Math.round(totalHoras),
                            totalTurnos,
                            totalTurnosNoche,
                            distribucionTurnos,
                            detallesPorEmpleado,
                            timestamp: new Date().toLocaleString('es-ES')
                        };
                    } catch (error) {
                        console.error('‚ùå Error calculando m√©tricas:', error);
                        return null;
                    }
                }
                
                function generarHTML(metricas) {
                    if (!metricas) {
                        return `
                            <div style="text-align: center; padding: 30px;">
                                <div style="font-size: 48px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                                <h3 style="color: #e74c3c;">Sin datos disponibles</h3>
                                <p style="color: #666;">No hay empleados en el sistema o no hay turnos generados para el mes seleccionado.</p>
                            </div>
                        `;
                    }
                    
                    const mesFecha = new Date(metricas.a√±o, metricas.mes, 1);
                    const nombreMes = mesFecha.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
                    
                    let html = `
                        <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0d6efd;">
                            <h3 style="margin: 0; color: #0d6efd;">üìä M√©tricas de ${nombreMes.toUpperCase()}</h3>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 12px;">Actualizado: ${metricas.timestamp}</p>
                        </div>
                    `;
                    
                    // Cards principales
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">';
                    
                    html += `
                        <div style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #22c55e;">
                            <div style="font-size: 28px; font-weight: bold; color: #22c55e;">${metricas.empleadosActivos}</div>
                            <div style="color: #666; font-size: 12px; margin-top: 5px;">üë• Empleados Activos</div>
                            <div style="color: #999; font-size: 11px; margin-top: 3px;">(de ${metricas.totalEmpleados})</div>
                        </div>
                        
                        <div style="background: #cfe2ff; padding: 15px; border-radius: 8px; border-left: 4px solid #0d6efd;">
                            <div style="font-size: 28px; font-weight: bold; color: #0d6efd;">${metricas.totalTurnos}</div>
                            <div style="color: #666; font-size: 12px; margin-top: 5px;">üìÖ Total Turnos</div>
                            <div style="color: #999; font-size: 11px; margin-top: 3px;">${metricas.empleadosConTurnos} empleados</div>
                        </div>
                        
                        <div style="background: #cce5ff; padding: 15px; border-radius: 8px; border-left: 4px solid #0dcaf0;">
                            <div style="font-size: 28px; font-weight: bold; color: #0dcaf0;">${metricas.totalHoras}h</div>
                            <div style="color: #666; font-size: 12px; margin-top: 5px;">‚è±Ô∏è Horas Totales</div>
                            <div style="color: #999; font-size: 11px; margin-top: 3px;">Promedio: ${metricas.totalTurnos > 0 ? (metricas.totalHoras / metricas.totalTurnos).toFixed(1) : '0'}h/turno</div>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <div style="font-size: 28px; font-weight: bold; color: #ffc107;">${metricas.totalTurnosNoche}</div>
                            <div style="color: #666; font-size: 12px; margin-top: 5px;">üåô Turnos Noche</div>
                            <div style="color: #999; font-size: 11px; margin-top: 3px;">${metricas.totalTurnos > 0 ? ((metricas.totalTurnosNoche / metricas.totalTurnos * 100).toFixed(1)) : '0'}%</div>
                        </div>
                    `;
                    
                    html += '</div>';
                    
                    // Distribuci√≥n de turnos
                    if (metricas.totalTurnos > 0) {
                        html += '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
                        html += '<h4 style="margin: 0 0 15px 0; color: #333;">üìà Distribuci√≥n de Turnos</h4>';
                        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">';
                        
                        for (const [turno, cantidad] of Object.entries(metricas.distribucionTurnos)) {
                            if (cantidad > 0) {
                                const porcentaje = ((cantidad / metricas.totalTurnos) * 100).toFixed(1);
                                const colores = {
                                    ma√±ana: '#d4edda',
                                    tarde: '#fff3cd',
                                    noche: '#f8d7da',
                                    mixto: '#cfe2ff',
                                    descanso: '#e2e3e5',
                                    vacaciones: '#d1ecf1',
                                    baja: '#f5c6cb',
                                    festivo: '#ffeaa7'
                                };
                                const color = colores[turno] || '#f8f9fa';
                                
                                html += `
                                    <div style="background: ${color}; padding: 12px; border-radius: 6px; text-align: center;">
                                        <div style="font-weight: bold; color: #333; font-size: 18px;">${cantidad}</div>
                                        <div style="color: #666; font-size: 11px; margin-top: 3px;">${turno}</div>
                                        <div style="color: #999; font-size: 10px; margin-top: 2px;">${porcentaje}%</div>
                                    </div>
                                `;
                            }
                        }
                        
                        html += '</div></div>';
                    }
                    
                    // Top empleados por horas (si hay datos)
                    if (metricas.detallesPorEmpleado && metricas.detallesPorEmpleado.length > 0) {
                        const top = metricas.detallesPorEmpleado.sort((a, b) => b.horas - a.horas).slice(0, 5);
                        
                        html += '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
                        html += '<h4 style="margin: 0 0 15px 0; color: #333;">üèÜ Top Empleados por Horas</h4>';
                        html += '<div style="font-size: 13px;">';
                        
                        top.forEach((emp, idx) => {
                            const medalla = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'][idx];
                            html += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #ddd;">
                                    <div>
                                        <span>${medalla}</span>
                                        <strong>${emp.nombre}</strong>
                                        <span style="color: #999; font-size: 12px;">(${emp.turnos} turnos)</span>
                                    </div>
                                    <div style="font-weight: bold; color: #0d6efd;">${emp.horas}h</div>
                                </div>
                            `;
                        });
                        
                        html += '</div></div>';
                    }
                    
                    // Informaci√≥n sobre generaci√≥n de turnos
                    if (metricas.totalTurnos === 0) {
                        html += `
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <strong>‚ÑπÔ∏è Informaci√≥n:</strong>
                                <p style="margin: 10px 0 0 0; color: #666; font-size: 13px;">
                                    No hay turnos generados para ${nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1)}.
                                </p>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">
                                    Debes generar los turnos para ver las m√©tricas. Usa el bot√≥n "Generar Turnos" en la secci√≥n de empleados.
                                </p>
                            </div>
                        `;
                    }
                    
                    return html;
                }
                
                // ===== API P√öBLICA =====
                return {
                    abrirModal: function() {
                        try {
                            const modal = document.getElementById('modalSemana3');
                            const titulo = document.getElementById('modalSemana3Title');
                            const contenido = document.getElementById('modalSemana3Content');
                            
                            if (!modal) {
                                console.error('‚ùå Modal para m√©tricas no encontrado');
                                NotificationSystem.show('Error: Modal de m√©tricas no encontrado', 'error');
                                return;
                            }
                            
                            console.log('üìä Abriendo m√≥dulo de M√©tricas...');
                            
                            const metricas = this.calcularMetricas();
                            ultimasMetricas = metricas;
                            
                            const html = generarHTML(metricas);
                            
                            if (titulo) titulo.textContent = 'üìä M√©tricas y Dashboard';
                            if (contenido) contenido.innerHTML = html;
                            
                            modal.classList.add('active');
                            console.log('‚úÖ Modal de m√©tricas abierto');
                            
                        } catch (error) {
                            console.error('‚ùå Error abriendo modal de m√©tricas:', error);
                            NotificationSystem.show('Error al abrir m√©tricas: ' + error.message, 'error');
                        }
                    },
                    
                    calcularMetricas: function() {
                        if (cacheActivo && ultimasMetricas) {
                            return ultimasMetricas;
                        }
                        return calcularMetricas();
                    },
                    
                    obtenerMetricas: function() {
                        return ultimasMetricas || calcularMetricas();
                    },
                    
                    actualizarCache: function() {
                        ultimasMetricas = calcularMetricas();
                        return ultimasMetricas;
                    },
                    
                    exportarJSON: function() {
                        const metricas = this.obtenerMetricas();
                        return JSON.stringify(metricas, null, 2);
                    },
                    
                    exportarCSV: function() {
                        const metricas = this.obtenerMetricas();
                        if (!metricas) return '';
                        
                        let csv = 'M√©trica,Valor\n';
                        csv += `Empleados Activos,${metricas.empleadosActivos}\n`;
                        csv += `Horas Totales,${metricas.totalHoras}\n`;
                        csv += `Turnos Noche,${metricas.totalTurnosNoche}\n`;
                        
                        return csv;
                    },
                    
                    deshabilitarCache: function() {
                        cacheActivo = false;
                        console.log('‚öôÔ∏è Cache de m√©tricas deshabilitado');
                    },
                    
                    habilitarCache: function() {
                        cacheActivo = true;
                        console.log('‚öôÔ∏è Cache de m√©tricas habilitado');
                    }
                };
            })();
            
            // Registrar m√≥dulo
            ModuleManager.register('Metricas', MetricasModule);
            console.log('üìä MetricasModule inicializado');
        }

        // üóëÔ∏è DEPRECATED: window.abrirMetricas() was redundant
        // PUNTO DE ENTRADA √öNICO: js/controles-semana-3.js:133
        
        if (typeof abrirCalendario === 'undefined') {
            window.abrirCalendario = function() {
                const modal = document.getElementById('modalSemana4');
                if (!modal) {
                    console.error('‚ùå Modal para calendario no encontrado');
                    return;
                }
                
                const titulo = document.getElementById('modalSemana4Title');
                const contenido = document.getElementById('modalSemana4Content');
                
                if (titulo) titulo.textContent = 'üìÖ Calendario iCalendar';
                
                let html = '<h3 style="margin-top: 0;">üìÖ Exportar Calendario iCalendar</h3>';
                html += '<div style="background: #f0f0f0; padding: 20px; border-radius: 8px;">';
                
                if (empleados && empleados.length > 0) {
                    html += '<div style="margin-bottom: 15px;">';
                    html += '<label style="display: block; margin-bottom: 8px; font-weight: bold;">Selecciona un empleado:</label>';
                    html += '<select id="selectEmpleadoICal" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">';
                    html += '<option value="">-- Selecciona --</option>';
                    empleados.forEach(emp => {
                        html += `<option value="${emp.id}">${emp.nombre}</option>`;
                    });
                    html += '</select>';
                    html += '</div>';
                    
                    html += '<div style="margin-bottom: 15px;">';
                    html += '<label style="display: block; margin-bottom: 8px; font-weight: bold;">Mes:</label>';
                    html += '<select id="selectMesICal" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">';
                    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                    meses.forEach((m, i) => {
                        const selected = i === AppState.currentMonth ? 'selected' : '';
                        html += `<option value="${i}" ${selected}>${m}</option>`;
                    });
                    html += '</select>';
                    html += '</div>';
                    
                    html += '<button onclick="descargarICalendarEmpleado()" style="width: 100%; padding: 12px; background: #8b5cf6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px;">';
                    html += 'üì• Descargar iCalendar';
                    html += '</button>';
                    
                    html += '<div style="background: white; padding: 15px; border-radius: 4px; margin-top: 20px; border-left: 4px solid #3498db;">';
                    html += '<strong>‚ÑπÔ∏è Informaci√≥n:</strong>';
                    html += '<p style="margin: 10px 0 0 0; font-size: 13px; color: #666;">El archivo descargado puede ser importado en Google Calendar, Outlook, Apple Calendar o cualquier aplicaci√≥n que soporte el formato iCalendar (.ics)</p>';
                    html += '</div>';
                } else {
                    html += '<div style="color: #999; padding: 20px; text-align: center;">No hay empleados registrados</div>';
                }
                
                html += '</div>';
                
                if (contenido) contenido.innerHTML = html;
                if (modal) modal.classList.add('active');
            };
        }

        // Funci√≥n para descargar iCalendar
        window.descargarICalendarEmpleado = function() {
            const empleadoId = document.getElementById('selectEmpleadoICal')?.value;
            const mesNum = parseInt(document.getElementById('selectMesICal')?.value || AppState.currentMonth);
            
            if (!empleadoId) {
                alert('Por favor selecciona un empleado');
                return;
            }
            
            const empleado = empleados.find(e => e.id === parseInt(empleadoId));
            if (!empleado) {
                alert('Empleado no encontrado');
                return;
            }
            
            const turnos = AppState.scheduleData.get(parseInt(empleadoId)) || [];
            const anio = AppState.currentYear;
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const mesNombre = meses[mesNum];
            
            // Generar contenido iCalendar
            let ical = 'BEGIN:VCALENDAR\\n';
            ical += 'VERSION:2.0\\n';
            ical += 'PRODID:-//Sistema Turnos//Turnos//ES\\n';
            ical += `CALSCALE:GREGORIAN\\n`;
            ical += `X-WR-CALNAME:Turnos - ${empleado.nombre} - ${mesNombre} ${anio}\\n`;
            ical += `X-WR-TIMEZONE:Europe/Madrid\\n`;
            ical += `X-WR-CALDESC:Cuadrante de turnos de ${empleado.nombre}\\n`;
            
            let eventCount = 0;
            turnos.forEach(turno => {
                const fecha = turno.fecha instanceof Date ? turno.fecha : new Date(turno.fecha);
                if (fecha.getMonth() === mesNum && fecha.getFullYear() === anio) {
                    const year = fecha.getFullYear();
                    const month = String(fecha.getMonth() + 1).padStart(2, '0');
                    const day = String(fecha.getDate()).padStart(2, '0');
                    const dateStr = `${year}${month}${day}`;
                    
                    const tipoTurno = turno.turno || 'Sin turno';
                    const titulo = `${empleado.nombre} - ${tipoTurno.charAt(0).toUpperCase() + tipoTurno.slice(1)}`;
                    
                    ical += 'BEGIN:VEVENT\\n';
                    ical += `UID:turno-${empleado.id}-${dateStr}@sistematuros\\n`;
                    ical += `DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').replace(/\\.\\d{3}/, '')}Z\\n`;
                    ical += `DTSTART:${dateStr}T000000Z\\n`;
                    ical += `DTEND:${dateStr}T235959Z\\n`;
                    ical += `SUMMARY:${titulo}\\n`;
                    ical += `DESCRIPTION:Turno: ${tipoTurno} - Horas: ${turno.horas || 0}h\\n`;
                    ical += `LOCATION:Trabajo\\n`;
                    ical += `END:VEVENT\\n`;
                    eventCount++;
                }
            });
            
            ical += 'END:VCALENDAR';
            
            // Descargar
            const blob = new Blob([ical], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Turnos_${empleado.nombre.replace(/\\s+/g, '_')}_${mesNombre}_${anio}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            
            alert(`‚úÖ Descargado: ${eventCount} eventos de turno`);
        };
        
        // ============================================================================
        // üîä REANUDAR AUDIOCONTEXT DESPU√âS DE USER GESTURE
        // ============================================================================
        function resumirAudioContext() {
            const audioContext = window.__appAudioContext;
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    console.log('‚úÖ AudioContext reanudado');
                }).catch(err => {
                    console.warn('‚ö†Ô∏è No se pudo reanudar AudioContext:', err);
                });
            }
        }
        
        // Reanudar en el primer user gesture
        document.addEventListener('click', resumirAudioContext, { once: true });
        document.addEventListener('keydown', resumirAudioContext, { once: true });
        document.addEventListener('touchstart', resumirAudioContext, { once: true });

        // ========== FUNCIONES DE SEMANA 2: REPORTES Y BACKUP ==========
        
        /**
         * Abrir modal de generador de reportes
         */
        window.abrirReportes = function() {
            console.log('üìä Abriendo Generador de Reportes...');
            
            if (typeof GeneradorReportes === 'undefined') {
                console.error('‚ùå GeneradorReportes no est√° cargado');
                alert('Error: El m√≥dulo de reportes no est√° disponible. Recarga la p√°gina.');
                return;
            }
            
            const modal = document.getElementById('modalSemana2');
            const content = document.getElementById('modalSemana2Content');
            
            if (!modal || !content) {
                console.error('‚ùå Modal no encontrado');
                return;
            }
            
            // Generar reporte
            const reporte = GeneradorReportes.generarReporteMensual();
            
            // Construir HTML del reporte
            let html = `
                <div style="padding: 20px;">
                    <h2 style="margin-top: 0; color: #1e293b; border-bottom: 2px solid #3b82f6; padding-bottom: 12px;">
                        üìä Reporte Mensual - ${reporte.periodo}
                    </h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 20px 0;">
                        <div style="padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                            <div style="color: #0284c7; font-size: 12px; font-weight: 600; text-transform: uppercase;">Total Empleados</div>
                            <div style="font-size: 28px; font-weight: 700; color: #075985;">${reporte.totalEmpleados}</div>
                        </div>
                        <div style="padding: 16px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
                            <div style="color: #059669; font-size: 12px; font-weight: 600; text-transform: uppercase;">Empleados Activos</div>
                            <div style="font-size: 28px; font-weight: 700; color: #047857;">${reporte.empleadosActivos}</div>
                        </div>
                        <div style="padding: 16px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="color: #b45309; font-size: 12px; font-weight: 600; text-transform: uppercase;">En Vacaciones</div>
                            <div style="font-size: 28px; font-weight: 700; color: #92400e;">${reporte.empleadosEnVacaciones}</div>
                        </div>
                        <div style="padding: 16px; background: #fee2e2; border-radius: 8px; border-left: 4px solid #ef4444;">
                            <div style="color: #dc2626; font-size: 12px; font-weight: 600; text-transform: uppercase;">En Baja</div>
                            <div style="font-size: 28px; font-weight: 700; color: #991b1b;">${reporte.empleadosEnBaja}</div>
                        </div>
                    </div>
                    
                    <h3 style="color: #1e293b; margin-top: 30px; border-bottom: 2px solid #8b5cf6; padding-bottom: 12px;">üìà Estad√≠sticas del Per√≠odo</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin: 16px 0;">
                        <div style="padding: 12px; background: #f3f4f6; border-radius: 6px;">
                            <div style="font-size: 12px; color: #6b7280; font-weight: 600;">Turnos Asignados</div>
                            <div style="font-size: 24px; font-weight: 700; color: #1f2937;">${reporte.estadisticas.turnosAsignados}</div>
                        </div>
                        <div style="padding: 12px; background: #f3f4f6; border-radius: 6px;">
                            <div style="font-size: 12px; color: #6b7280; font-weight: 600;">Horas Totales</div>
                            <div style="font-size: 24px; font-weight: 700; color: #1f2937;">${reporte.estadisticas.horasTotales}h</div>
                        </div>
                        <div style="padding: 12px; background: #f3f4f6; border-radius: 6px;">
                            <div style="font-size: 12px; color: #6b7280; font-weight: 600;">Turnos Nocturnos</div>
                            <div style="font-size: 24px; font-weight: 700; color: #1f2937;">${reporte.estadisticas.turnosNocturnos}</div>
                        </div>
                        <div style="padding: 12px; background: #f3f4f6; border-radius: 6px;">
                            <div style="font-size: 12px; color: #6b7280; font-weight: 600;">Descansos</div>
                            <div style="font-size: 24px; font-weight: 700; color: #1f2937;">${reporte.estadisticas.turnosDescanso}</div>
                        </div>
                    </div>
                    
                    <h3 style="color: #1e293b; margin-top: 30px; border-bottom: 2px solid #8b5cf6; padding-bottom: 12px;">üë• Detalle por Empleado</h3>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead style="background: #f3f4f6; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb; font-weight: 600;">Empleado</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e5e7eb; font-weight: 600;">Depto</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e5e7eb; font-weight: 600;">Horas</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e5e7eb; font-weight: 600;">Turnos</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reporte.empleados.map((emp, idx) => `
                                    <tr style="border-bottom: 1px solid #e5e7eb; ${idx % 2 === 0 ? 'background: #f9fafb;' : ''}">
                                        <td style="padding: 10px; font-weight: 600; color: #1f2937;">${emp.nombre}</td>
                                        <td style="padding: 10px; text-align: center; color: #6b7280;">${emp.departamento}</td>
                                        <td style="padding: 10px; text-align: center; font-weight: 600; color: #0284c7;">${emp.horasTrabajadas}h</td>
                                        <td style="padding: 10px; text-align: center; font-weight: 600; color: #059669;">${emp.turnosTotal}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 12px; background: #f0f9ff; border-radius: 8px; font-size: 12px; color: #0c4a6e;">
                        üìÖ Generado: ${reporte.fechaGeneracion}
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            document.getElementById('modalSemana2Title').textContent = 'üìä Generador de Reportes';
            modal.classList.add('active');
        };
        
        /**
         * Abrir modal de backup y restauraci√≥n
         */
        window.abrirBackup = function() {
            console.log('üíæ Abriendo Backup y Restauraci√≥n...');
            
            const modal = document.getElementById('modalSemana2');
            const content = document.getElementById('modalSemana2Content');
            
            if (!modal || !content) {
                console.error('‚ùå Modal no encontrado');
                return;
            }
            
            // Construir HTML del backup
            let html = `
                <div style="padding: 20px;">
                    <h2 style="margin-top: 0; color: #1e293b; border-bottom: 2px solid #10b981; padding-bottom: 12px;">
                        üíæ Backup y Restauraci√≥n
                    </h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <!-- SECCI√ìN DESCARGAR BACKUP -->
                        <div style="padding: 20px; background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 12px; border: 2px solid #10b981;">
                            <h3 style="margin-top: 0; color: #047857;">üì• Descargar Backup</h3>
                            <p style="color: #6b7280; font-size: 14px;">Guarda una copia completa de todos tus datos (empleados, turnos, configuraci√≥n)</p>
                            <button onclick="descargarBackupCompleto()" style="width: 100%; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s;">
                                ‚¨áÔ∏è Descargar Backup
                            </button>
                            <div style="margin-top: 12px; padding: 12px; background: white; border-radius: 6px; font-size: 12px; color: #6b7280;">
                                <strong>Incluye:</strong>
                                <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                                    <li>‚úì Empleados</li>
                                    <li>‚úì Turnos del mes</li>
                                    <li>‚úì Departamentos</li>
                                    <li>‚úì Localidades</li>
                                    <li>‚úì Tipos de turno</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- SECCI√ìN RESTAURAR BACKUP -->
                        <div style="padding: 20px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; border: 2px solid #f59e0b;">
                            <h3 style="margin-top: 0; color: #b45309;">üì§ Restaurar Backup</h3>
                            <p style="color: #6b7280; font-size: 14px;">Carga un archivo de backup anterior para recuperar datos</p>
                            <input type="file" id="inputBackupFile" accept=".json" style="width: 100%; padding: 8px; border: 2px dashed #f59e0b; border-radius: 6px; margin-bottom: 12px;">
                            <button onclick="restaurarBackupCompleto()" style="width: 100%; padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s;">
                                ‚¨ÜÔ∏è Restaurar Backup
                            </button>
                            <div style="margin-top: 12px; padding: 12px; background: white; border-radius: 6px; font-size: 11px; color: #92400e;">
                                <strong>‚ö†Ô∏è Advertencia:</strong> Esto sobrescribir√° los datos actuales. No se puede deshacer.
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0284c7;">
                        <strong style="color: #0c4a6e;">üí° Consejo:</strong> Haz un backup regularmente para no perder tus datos. Recomendamos hacerlo semanalmente.
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            document.getElementById('modalSemana2Title').textContent = 'üíæ Backup y Restauraci√≥n';
            modal.classList.add('active');
        };
        
        /**
         * Descargar backup completo
         */
        window.descargarBackupCompleto = function() {
            console.log('üì• Iniciando descarga de backup...');
            
            try {
                // Recopilar todos los datos
                const backup = {
                    fecha: new Date().toISOString(),
                    version: '1.0',
                    datos: {
                        empleados: JSON.parse(localStorage.getItem('empleadosData') || '[]'),
                        appState: JSON.parse(localStorage.getItem('turnosAppState') || '{}'),
                        tiposTurno: JSON.parse(localStorage.getItem('tiposTurnoData') || '{}'),
                        departamentos: JSON.parse(localStorage.getItem('departamentosData') || '{}'),
                        localidades: JSON.parse(localStorage.getItem('localidadesData') || '{}')
                    }
                };
                
                // Crear blob y descargar
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                NotificationSystem.show('‚úÖ Backup descargado correctamente', 'success');
            } catch (error) {
                console.error('‚ùå Error al descargar backup:', error);
                NotificationSystem.show('Error al descargar backup', 'error');
            }
        };
        
        /**
         * Restaurar backup completo
         */
        window.restaurarBackupCompleto = function() {
            console.log('üì§ Iniciando restauraci√≥n de backup...');
            
            const input = document.getElementById('inputBackupFile');
            if (!input.files[0]) {
                alert('Por favor, selecciona un archivo de backup');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    // Validar estructura
                    if (!backup.datos) {
                        throw new Error('Archivo de backup inv√°lido');
                    }
                    
                    // Confirmar antes de restaurar
                    if (!confirm('‚ö†Ô∏è Esto sobrescribir√° todos tus datos. ¬øEst√°s seguro?')) {
                        return;
                    }
                    
                    // Restaurar datos
                    localStorage.setItem('empleadosData', JSON.stringify(backup.datos.empleados || []));
                    localStorage.setItem('turnosAppState', JSON.stringify(backup.datos.appState || {}));
                    localStorage.setItem('tiposTurnoData', JSON.stringify(backup.datos.tiposTurno || {}));
                    localStorage.setItem('departamentosData', JSON.stringify(backup.datos.departamentos || {}));
                    localStorage.setItem('localidadesData', JSON.stringify(backup.datos.localidades || {}));
                    
                    NotificationSystem.show('‚úÖ Backup restaurado correctamente. Recargando...', 'success');
                    
                    // Recargar la p√°gina despu√©s de 1.5 segundos
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } catch (error) {
                    console.error('‚ùå Error al restaurar backup:', error);
                    NotificationSystem.show('Error: archivo de backup inv√°lido', 'error');
                }
            };
            reader.readAsText(input.files[0]);
        };
    </script>
    
</div><!-- Cierre main-content -->
</body>
</html>
