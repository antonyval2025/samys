<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico: Horas de Turnos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }
        
        h2 {
            color: #667eea;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
        }
        
        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        table tr:hover {
            background: #f5f5f5;
        }
        
        .status-ok {
            color: #27ae60;
            font-weight: bold;
        }
        
        .status-error {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .status-warning {
            color: #f39c12;
            font-weight: bold;
        }
        
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin: 10px 0;
        }
        
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: background 0.3s;
        }
        
        .button:hover {
            background: #764ba2;
        }
        
        .button.danger {
            background: #e74c3c;
        }
        
        .button.danger:hover {
            background: #c0392b;
        }
        
        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Horas de Turnos</h1>
        
        <div class="section">
            <h2>üìã Turnos por Defecto (tiposTurno)</h2>
            <table id="tablaTurnosPorDefecto"></table>
        </div>
        
        <div class="section">
            <h2>üìã Turnos Personalizados (localStorage)</h2>
            <table id="tablaTurnosPersonalizados"></table>
        </div>
        
        <div class="section">
            <h2>üë• An√°lisis de Empleados y sus Turnos Asignados</h2>
            <table id="tablaEmpleados"></table>
        </div>
        
        <div class="section">
            <h2>‚ö†Ô∏è Problemas Detectados</h2>
            <div id="problemasDetectados"></div>
        </div>
        
        <div class="section">
            <h2>üîß Acciones</h2>
            <button class="button" onclick="guardarDiagnostico()">üíæ Descargar Diagn√≥stico</button>
            <button class="button" onclick="limpiarLocalStorage()">üóëÔ∏è Limpiar localStorage</button>
            <button class="button danger" onclick="resetearTodo()">üîÑ Resetear Todo</button>
        </div>
    </div>
    
    <script>
        // Copiar la definici√≥n de tiposTurno (igual que en nuevo_cuadrante_mejorado.html)
        const tiposTurno = {
            ma√±ana: { horario: "08:00-16:00", color: "#d4edda", horas: 8, inicial: "M" },
            tarde: { horario: "16:00-00:00", color: "#fff3cd", horas: 6.5, inicial: "T" },
            noche: { horario: "00:00-08:00", color: "#f8d7da", horas: 8, inicial: "N" },
            mixto: { horario: "08:00-00:00", color: "#e2e3e5", horas: 16, inicial: "X" },
            descanso: { horario: "-", color: "#cce5ff", horas: 0, inicial: "D" },
            vacaciones: { horario: "-", color: "#a8edea", horas: 0, inicial: "V" },
            baja: { horario: "-", color: "#fed7aa", horas: 0, inicial: "B" },
            festivo: { horario: "-", color: "#fecaca", horas: 0, inicial: "F" },
            libre: { horario: "-", color: "#d1d5db", horas: 0, inicial: "L" }
        };
        
        function inicializar() {
            mostrarTurnosPorDefecto();
            mostrarTurnosPersonalizados();
            mostrarAnalisisEmpleados();
            detectarProblemas();
        }
        
        function mostrarTurnosPorDefecto() {
            const tabla = document.getElementById('tablaTurnosPorDefecto');
            let html = `
                <tr>
                    <th>Nombre</th>
                    <th>Horario</th>
                    <th>Horas</th>
                    <th>Color</th>
                    <th>Inicial</th>
                </tr>
            `;
            
            Object.entries(tiposTurno).forEach(([nombre, datos]) => {
                html += `
                    <tr>
                        <td><strong>${nombre}</strong></td>
                        <td>${datos.horario}</td>
                        <td class="status-ok">${datos.horas}h</td>
                        <td><div style="width: 30px; height: 30px; background: ${datos.color}; border: 1px solid #ccc; border-radius: 3px;"></div></td>
                        <td>${datos.inicial}</td>
                    </tr>
                `;
            });
            
            tabla.innerHTML = html;
        }
        
        function mostrarTurnosPersonalizados() {
            const tabla = document.getElementById('tablaTurnosPersonalizados');
            const tiposTurnoData = JSON.parse(localStorage.getItem('tiposTurnoData') || '{}');
            
            if (Object.keys(tiposTurnoData).length === 0) {
                tabla.innerHTML = '<tr><td colspan="5">‚ùå No hay turnos personalizados en localStorage</td></tr>';
                return;
            }
            
            let html = `
                <tr>
                    <th>Nombre</th>
                    <th>Horario</th>
                    <th>Horas</th>
                    <th>Color</th>
                    <th>Inicial</th>
                </tr>
            `;
            
            Object.entries(tiposTurnoData).forEach(([nombre, datos]) => {
                html += `
                    <tr>
                        <td><strong>${nombre}</strong></td>
                        <td>${datos.horario}</td>
                        <td class="status-ok">${datos.horas}h</td>
                        <td><div style="width: 30px; height: 30px; background: ${datos.color}; border: 1px solid #ccc; border-radius: 3px;"></div></td>
                        <td>${datos.inicial}</td>
                    </tr>
                `;
            });
            
            tabla.innerHTML = html;
        }
        
        function mostrarAnalisisEmpleados() {
            const tabla = document.getElementById('tablaEmpleados');
            const empleadosData = JSON.parse(localStorage.getItem('empleadosData') || '[]');
            const tiposTurnoData = JSON.parse(localStorage.getItem('tiposTurnoData') || '{}');
            const turnosAppState = JSON.parse(localStorage.getItem('turnosAppState') || '{}');
            
            let html = `
                <tr>
                    <th>Empleado</th>
                    <th>Turno Configurado</th>
                    <th>Estado</th>
                    <th>Turnos en Diciembre 2025</th>
                    <th>Horas Asignadas</th>
                    <th>Diagn√≥stico</th>
                </tr>
            `;
            
            empleadosData.forEach(empleado => {
                // Obtener el turno principal
                const turnoConfigutado = empleado.turnoPrincipal || 'No configurado';
                
                // Obtener los turnos del mes actual
                const scheduleData = turnosAppState.scheduleData || {};
                const turnosEmpleado = scheduleData[empleado.id] || [];
                
                // Contar turnos por tipo
                const contadores = {};
                let horasTotal = 0;
                
                turnosEmpleado.forEach(t => {
                    contadores[t.turno] = (contadores[t.turno] || 0) + 1;
                    horasTotal += t.horas || 0;
                });
                
                // Buscar el turno m√°s frecuente
                const turnoMasFrecuente = Object.keys(contadores).reduce((a, b) => 
                    (contadores[a] || 0) > (contadores[b] || 0) ? a : b, 'desconocido');
                
                // Verificar si hay error
                let diagnostico = '‚úÖ OK';
                let clase = 'status-ok';
                
                const turnoConfigEnMerged = tiposTurno[turnoConfigutado] || tiposTurnoData[turnoConfigutado];
                const turnoAsignadoEnMerged = tiposTurno[turnoMasFrecuente] || tiposTurnoData[turnoMasFrecuente];
                
                if (turnoConfigutado !== turnoMasFrecuente && turnoMasFrecuente !== 'descanso' && turnoMasFrecuente !== 'libre') {
                    diagnostico = `‚ö†Ô∏è Turno incorrecto (configurado: ${turnoConfigutado}, asignado: ${turnoMasFrecuente})`;
                    clase = 'status-warning';
                }
                
                if (turnoConfigEnMerged && turnoAsignadoEnMerged && 
                    turnoConfigEnMerged.horas !== turnoAsignadoEnMerged.horas) {
                    diagnostico = `‚ùå Error de horas (esperado: ${turnoConfigEnMerged.horas}h, asignado: ${turnoAsignadoEnMerged.horas}h)`;
                    clase = 'status-error';
                }
                
                const turnosResumen = Object.entries(contadores)
                    .map(([turno, count]) => `${turno} (${count})`)
                    .join(', ');
                
                html += `
                    <tr>
                        <td><strong>${empleado.nombre}</strong></td>
                        <td>${turnoConfigutado}</td>
                        <td>${empleado.estado}</td>
                        <td>${turnosResumen || 'Sin turnos'}</td>
                        <td class="status-ok">${horasTotal}h</td>
                        <td class="${clase}">${diagnostico}</td>
                    </tr>
                `;
            });
            
            tabla.innerHTML = html;
        }
        
        function detectarProblemas() {
            const div = document.getElementById('problemasDetectados');
            const problemas = [];
            
            const empleadosData = JSON.parse(localStorage.getItem('empleadosData') || '[]');
            const tiposTurnoData = JSON.parse(localStorage.getItem('tiposTurnoData') || '{}');
            const turnosAppState = JSON.parse(localStorage.getItem('turnosAppState') || '{}');
            
            // Problema 1: Turnos personalizados sobrescribiendo defaults
            Object.keys(tiposTurnoData).forEach(nombre => {
                if (tiposTurno[nombre]) {
                    const custom = tiposTurnoData[nombre];
                    const default_ = tiposTurno[nombre];
                    if (custom.horas !== default_.horas) {
                        problemas.push({
                            tipo: 'error',
                            mensaje: `Turno "${nombre}" personalizado (${custom.horas}h) sobrescribe default (${default_.horas}h)`
                        });
                    }
                }
            });
            
            // Problema 2: Empleados sin turnos generados
            const scheduleData = turnosAppState.scheduleData || {};
            empleadosData.forEach(empleado => {
                if (!scheduleData[empleado.id] || scheduleData[empleado.id].length === 0) {
                    problemas.push({
                        tipo: 'warning',
                        mensaje: `Empleado "${empleado.nombre}" no tiene turnos generados`
                    });
                }
            });
            
            // Problema 3: Turnos con horas inconsistentes
            Object.entries(scheduleData).forEach(([empId, turnos]) => {
                const empleado = empleadosData.find(e => e.id == empId);
                if (empleado && turnos.length > 0) {
                    const turnoConfig = tiposTurno[empleado.turnoPrincipal] || tiposTurnoData[empleado.turnoPrincipal];
                    if (turnoConfig) {
                        const horasEsperadas = turnoConfig.horas;
                        const turnosIncorrectos = turnos.filter(t => 
                            (t.turno === empleado.turnoPrincipal || t.turno.toLowerCase() === empleado.turnoPrincipal.toLowerCase()) &&
                            t.horas !== horasEsperadas
                        );
                        
                        if (turnosIncorrectos.length > 0) {
                            problemas.push({
                                tipo: 'error',
                                mensaje: `Empleado "${empleado.nombre}": ${turnosIncorrectos.length} turnos de "${empleado.turnoPrincipal}" con horas incorrectas`
                            });
                        }
                    }
                }
            });
            
            if (problemas.length === 0) {
                div.innerHTML = '<div class="info-box">‚úÖ No se detectaron problemas</div>';
            } else {
                let html = '';
                problemas.forEach(p => {
                    const icono = p.tipo === 'error' ? '‚ùå' : '‚ö†Ô∏è';
                    const clase = p.tipo === 'error' ? 'status-error' : 'status-warning';
                    html += `<div style="margin: 10px 0; padding: 10px; background: #fff5f5; border-left: 4px solid ${p.tipo === 'error' ? '#e74c3c' : '#f39c12'}; border-radius: 3px;">
                        <span class="${clase}">${icono} ${p.mensaje}</span>
                    </div>`;
                });
                div.innerHTML = html;
            }
        }
        
        function guardarDiagnostico() {
            const empleadosData = JSON.parse(localStorage.getItem('empleadosData') || '[]');
            const tiposTurnoData = JSON.parse(localStorage.getItem('tiposTurnoData') || '{}');
            const turnosAppState = JSON.parse(localStorage.getItem('turnosAppState') || '{}');
            
            const diagnostico = {
                timestamp: new Date().toLocaleString('es-ES'),
                tiposTurnoPorDefecto: tiposTurno,
                tiposTurnoPersonalizados: tiposTurnoData,
                empleados: empleadosData,
                scheduleData: turnosAppState.scheduleData || {}
            };
            
            const blob = new Blob([JSON.stringify(diagnostico, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diagnostico-${new Date().toISOString()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function limpiarLocalStorage() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres limpiar todo localStorage?')) {
                localStorage.clear();
                location.reload();
            }
        }
        
        function resetearTodo() {
            if (confirm('üî¥ PELIGRO: ¬øEst√°s seguro de que quieres resetear TODO? Esta acci√≥n no se puede deshacer.')) {
                localStorage.clear();
                alert('‚úÖ localStorage limpiado. Por favor, cierra este navegador y vuelve a abrir la aplicaci√≥n principal.');
            }
        }
        
        // Inicializar cuando cargue la p√°gina
        window.addEventListener('DOMContentLoaded', inicializar);
    </script>
</body>
</html>
