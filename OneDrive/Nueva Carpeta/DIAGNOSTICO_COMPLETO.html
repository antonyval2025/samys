<!DOCTYPE html>
<html>
<head>
    <title>DIAGN√ìSTICO COMPLETO - TurnoManager</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: #222;
            border: 2px solid #00ff00;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .status-ok { color: #00ff00; }
        .status-error { color: #ff0000; }
        .status-warn { color: #ffff00; }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover { background: #00dd00; }
        #results {
            max-height: 500px;
            overflow-y: auto;
            background: #111;
            padding: 10px;
            margin-top: 10px;
        }
        .log-item {
            padding: 5px;
            margin: 3px 0;
            border-left: 3px solid;
        }
        .log-ok { border-left-color: #00ff00; }
        .log-error { border-left-color: #ff0000; }
        .log-warn { border-left-color: #ffff00; }
    </style>
</head>
<body>
    <h1>üî¨ DIAGN√ìSTICO COMPLETO - TurnoManager</h1>
    
    <div class="section">
        <h2>Prueba 1: Verificar Script del Head</h2>
        <button onclick="testHeadScript()">Ejecutar</button>
        <div id="results"></div>
    </div>

    <div class="section">
        <h2>Prueba 2: Crear TurnoManager Temporal y Probar</h2>
        <button onclick="testTurnoManager()">Ejecutar</button>
        <div id="results2"></div>
    </div>

    <div class="section">
        <h2>Prueba 3: Cargar archivo HTML original en AJAX</h2>
        <button onclick="testAjaxLoad()">Ejecutar</button>
        <div id="results3"></div>
    </div>

    <div class="section">
        <h2>Prueba 4: Verificar todas las librer√≠as cargadas</h2>
        <button onclick="testLibraries()">Ejecutar</button>
        <div id="results4"></div>
    </div>

    <script>
        function log(id, msg, type = 'ok') {
            const results = document.getElementById(id);
            const item = document.createElement('div');
            item.className = `log-item log-${type}`;
            item.textContent = msg;
            results.appendChild(item);
            console.log(msg);
        }

        function testHeadScript() {
            const id = 'results';
            document.getElementById(id).innerHTML = '';
            
            log(id, '‚úÖ Este script est√° ejecutando', 'ok');
            
            if (typeof window.TurnoManager === 'undefined') {
                log(id, '‚ùå TurnoManager NO existe', 'error');
                return;
            }
            log(id, '‚úÖ window.TurnoManager existe', 'ok');
            
            const keys = Object.keys(window.TurnoManager);
            log(id, `üìä Total de propiedades: ${keys.length}`, 'ok');
            
            keys.forEach(k => {
                const type = typeof window.TurnoManager[k];
                if (type === 'function') {
                    log(id, `   ‚úÖ ${k}: function`, 'ok');
                } else {
                    log(id, `   ‚ö†Ô∏è ${k}: ${type}`, 'warn');
                }
            });
            
            if (typeof window.TurnoManager.mostrarModalGeneracion === 'function') {
                log(id, 'üü¢ mostrarModalGeneracion est√° LISTA para usar', 'ok');
                
                // Intentar ejecutarla
                try {
                    // No vamos a ejecutarla realmente, solo verificaremos
                    log(id, '‚úÖ Funci√≥n es callable', 'ok');
                } catch(e) {
                    log(id, `‚ùå Error al llamar: ${e.message}`, 'error');
                }
            } else {
                log(id, 'üî¥ mostrarModalGeneracion NO est√° disponible', 'error');
            }
        }

        function testTurnoManager() {
            const id = 'results2';
            document.getElementById(id).innerHTML = '';
            
            try {
                // Simular lo que hace el HTML original
                if (!window.TestTurnoManager) {
                    window.TestTurnoManager = {};
                }
                
                window.TestTurnoManager.mostrarModalGeneracion = function() {
                    return 'Funci√≥n ejecutada correctamente';
                };
                
                log(id, '‚úÖ TestTurnoManager creado', 'ok');
                log(id, '‚úÖ mostrarModalGeneracion definida', 'ok');
                
                const result = window.TestTurnoManager.mostrarModalGeneracion();
                log(id, `‚úÖ Resultado: ${result}`, 'ok');
                
                log(id, 'üü¢ CONCLUSI√ìN: El patr√≥n de definici√≥n de funciones FUNCIONA', 'ok');
            } catch(e) {
                log(id, `‚ùå Error: ${e.message}`, 'error');
            }
        }

        function testAjaxLoad() {
            const id = 'results3';
            document.getElementById(id).innerHTML = '';
            
            log(id, '‚è≥ Cargando nuevo_cuadrante_mejorado.html...', 'warn');
            
            fetch('nuevo_cuadrante_mejorado.html')
                .then(r => {
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    log(id, `‚úÖ Archivo cargado correctamente (${r.headers.get('content-length')} bytes)`, 'ok');
                    return r.text();
                })
                .then(html => {
                    // Buscar definiciones
                    const matches = html.match(/window\.TurnoManager\.\w+\s*=/g);
                    log(id, `üìä Definiciones encontradas: ${matches ? matches.length : 0}`, 'ok');
                    
                    if (matches) {
                        const unique = [...new Set(matches)];
                        log(id, `üìä Definiciones √∫nicas: ${unique.length}`, 'ok');
                    }
                    
                    // Buscar espec√≠ficamente mostrarModalGeneracion
                    if (html.includes('window.TurnoManager.mostrarModalGeneracion = function')) {
                        log(id, '‚úÖ mostrarModalGeneracion DEFINIDA en HTML', 'ok');
                    } else {
                        log(id, '‚ùå mostrarModalGeneracion NO encontrada', 'error');
                    }
                    
                    // Buscar el bot√≥n
                    if (html.includes('onclick="TurnoManager.mostrarModalGeneracion()"')) {
                        log(id, '‚úÖ Bot√≥n con onclick correcto encontrado', 'ok');
                    } else {
                        log(id, '‚ùå Bot√≥n onclick incorrecto', 'error');
                    }
                    
                    // Contar scripts
                    const scriptCount = (html.match(/<script/g) || []).length;
                    log(id, `üìä Total de bloques <script>: ${scriptCount}`, 'ok');
                    
                    // Verificar s√≠ntaxis b√°sica
                    const openBraces = (html.match(/{/g) || []).length;
                    const closeBraces = (html.match(/}/g) || []).length;
                    log(id, `üìä Braces: { = ${openBraces}, } = ${closeBraces}`, openBraces === closeBraces ? 'ok' : 'error');
                })
                .catch(e => {
                    log(id, `‚ùå Error: ${e.message}`, 'error');
                });
        }

        function testLibraries() {
            const id = 'results4';
            document.getElementById(id).innerHTML = '';
            
            const libs = [
                { name: 'html2canvas', check: () => typeof html2canvas !== 'undefined' },
                { name: 'jsPDF', check: () => typeof jsPDF !== 'undefined' },
                { name: 'AppState', check: () => typeof AppState !== 'undefined' },
                { name: 'empleados (global)', check: () => typeof empleados !== 'undefined' },
                { name: 'UI', check: () => typeof UI !== 'undefined' },
                { name: 'TurnoManager', check: () => typeof TurnoManager !== 'undefined' }
            ];
            
            libs.forEach(lib => {
                try {
                    const exists = lib.check();
                    log(id, `${exists ? '‚úÖ' : '‚ùå'} ${lib.name}: ${exists ? 'Cargada' : 'No cargada'}`, exists ? 'ok' : 'error');
                } catch(e) {
                    log(id, `‚ö†Ô∏è ${lib.name}: Error al verificar (${e.message})`, 'warn');
                }
            });
        }

        // Ejecutar la primera prueba autom√°ticamente
        window.addEventListener('load', () => {
            log('results', 'Ejecutando diagn√≥stico inicial...', 'ok');
            setTimeout(testHeadScript, 500);
        });
    </script>
</body>
</html>
